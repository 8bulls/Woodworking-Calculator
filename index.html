.calc-btn.operation.active {
            background: #654321;
            transform: scale(0.95);
        }        function clearAll() {
            // This function is no longer used but kept for compatibility
            clearCalculator();
        }<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Woodworking Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            font-family: Arial, sans-serif;
            background: #8B4513;
            color: #2F1B14;
            padding: 0;
            margin: 0;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        body {
            padding: 10px;
            background: linear-gradient(135deg, #8B4513, #DEB887);
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        h1 {
            text-align: center;
            color: #8B4513;
            margin-bottom: 20px;
            font-size: 24px;
            font-weight: bold;
        }
        
        .tab-buttons {
            display: flex;
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px;
            background: #D2B48C;
            color: #8B4513;
            border: none;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .tab-btn.active {
            background: #8B4513;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .settings-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .settings-row label {
            font-weight: bold;
            min-width: 80px;
        }
        
        select, input {
            padding: 10px;
            border: 2px solid #D2B48C;
            border-radius: 8px;
            font-size: 16px;
            background: white;
        }
        
        .wide-input {
            width: 80px !important;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .input-mode-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .input-group {
            display: flex;
            gap: 5px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .input-group input {
            width: 80px;
            text-align: center;
        }
        
        .input-group select {
            width: 100px;
        }
        
        .input-group label {
            font-weight: bold;
            margin-right: 5px;
        }
        
        .current-value {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            border: 2px solid #8B4513;
        }
        
        /* Calculator display styles */
        .calc-display {
            background: #2F1B14;
            color: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .calc-equation {
            font-size: 16px;
            color: #D2B48C;
            min-height: 24px;
            margin-bottom: 5px;
        }
        
        .calc-result {
            font-size: 28px;
            font-weight: bold;
            text-align: right;
            min-height: 40px;
            word-break: break-all;
        }
        
        .calc-result.has-value {
            color: #4CAF50;
        }
        
        .calc-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .calc-btn {
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            background: #D2B48C;
            color: #2F1B14;
        }
        
        .calc-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .calc-btn:active {
            transform: translateY(0);
        }
        
        .calc-btn.operation {
            background: #8B4513;
            color: white;
        }
        
        .calc-btn.equals {
            background: #4CAF50;
            color: white;
            grid-column: span 2;
        }
        
        .calc-btn.save {
            background: #2196F3;
            color: white;
        }
        
        .calc-btn.clear {
            background: #f44336;
            color: white;
        }
        
        .calc-btn.memory {
            background: #607D8B;
            color: white;
            font-size: 14px;
        }
        
        .memory-display {
            position: absolute;
            top: 5px;
            right: 10px;
            font-size: 12px;
            color: #D2B48C;
        }
        
        .conversion-section {
            margin-bottom: 20px;
        }
        
        .conversion-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .conversion-preview {
            background: #f8f9fa;
            border: 1px solid #D2B48C;
            border-radius: 5px;
            padding: 8px 12px;
            margin-bottom: 10px;
            font-size: 14px;
            color: #666;
        }
        
        #conversionValue {
            font-weight: bold;
            color: #8B4513;
        }
        
        /* Woodworking Calculators Styles */
        .woodworking-calcs-section {
            margin-bottom: 20px;
        }
        
        .calc-card {
            border: 2px solid #D2B48C;
            border-radius: 8px;
            margin-bottom: 10px;
            background: white;
            overflow: visible;
        }
        
        .calc-card-header {
            background: linear-gradient(135deg, #D2B48C, #F5DEB3);
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            user-select: none;
            transition: background 0.3s;
        }
        
        .calc-card-header:hover {
            background: linear-gradient(135deg, #C8A882, #F0D0A0);
        }
        
        .calc-icon {
            font-size: 18px;
        }
        
        .calc-title {
            flex: 1;
            font-weight: bold;
            color: #8B4513;
        }
        
        .calc-arrow {
            transition: transform 0.3s;
            color: #8B4513;
        }
        
        .calc-card.expanded .calc-arrow {
            transform: rotate(180deg);
        }
        
        .calc-card-content {
            display: none;
            padding: 20px;
            background: #fefefe;
        }
        
        .calc-card.expanded .calc-card-content {
            display: block;
        }
        
        .calc-description {
            color: #666;
            margin-bottom: 15px;
            font-style: italic;
        }
        
        .calc-visual {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            overflow: visible;
        }
        
        .calc-inputs {
            margin-bottom: 20px;
        }
        
        .input-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }
        
        .input-row label {
            min-width: 120px;
            font-weight: bold;
            color: #8B4513;
        }
        
        .input-row input {
            flex: 1;
            max-width: 150px;
            padding: 8px;
            border: 2px solid #D2B48C;
            border-radius: 4px;
        }
        
        .input-row .unit {
            font-size: 12px;
            color: #666;
            min-width: 50px;
        }
        
        .calc-result {
            background: #f8f9fa;
            border: 1px solid #D2B48C;
            border-radius: 5px;
            padding: 15px;
            text-align: center;
        }
        
        .result-display {
            font-size: 16px;
            font-weight: bold;
            color: #8B4513;
            margin-bottom: 10px;
        }
        
        /* Board Foot Calculator Visuals */
        .lumber-diagram {
            width: 200px;
            height: 120px;
            position: relative;
            background: #f0f0f0;
            border: 2px solid #8B4513;
            border-radius: 4px;
        }
        
        .lumber-piece {
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #DEB887, #D2B48C);
            position: relative;
            overflow: hidden;
        }
        
        .lumber-piece::before {
            content: '';
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            border: 1px dashed #8B4513;
            border-radius: 2px;
        }
        
        .dimension-label {
            position: absolute;
            background: rgba(255,255,255,0.9);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            color: #8B4513;
        }
        
        .dimension-label.top {
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .dimension-label.left {
            left: -35px;
            top: 50%;
            transform: translateY(-50%) rotate(-90deg);
        }
        
        .dimension-label.right {
            right: -35px;
            top: 50%;
            transform: translateY(-50%) rotate(90deg);
        }
        
        /* Lumber Cart Styles */
        .cart-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
        }
        
        .cart-section {
            margin-top: 20px;
            border-top: 2px solid #D2B48C;
            padding-top: 15px;
        }
        
        .cart-display {
            background: #f8f9fa;
            border: 1px solid #D2B48C;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #D2B48C;
        }
        
        .cart-header h4 {
            margin: 0;
            color: #8B4513;
        }
        
        .cart-items {
            margin-bottom: 15px;
        }
        
        .cart-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .cart-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .cart-item-header strong {
            color: #8B4513;
            font-size: 16px;
        }
        
        .btn-remove {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        
        .btn-remove:hover {
            background: #c82333;
        }
        
        .cart-item-details {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .cart-item-pricing {
            font-size: 14px;
            color: #495057;
        }
        
        .cart-summary {
            background: #e9f7ef;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            padding: 10px;
        }
        
        .cart-bottom-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .cart-bottom-actions button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        /* Shopping History Styles */
        .shopping-history-section {
            margin-top: 15px;
            border-top: 1px solid #D2B48C;
            padding-top: 15px;
        }
        
        .shopping-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .shopping-history-header h4 {
            margin: 0;
            color: #8B4513;
        }
        
        .shopping-history-display {
            background: #f8f9fa;
            border: 1px solid #D2B48C;
            border-radius: 6px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .shopping-history-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .shopping-history-item:last-child {
            margin-bottom: 0;
        }
        
        .shopping-history-header-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .shopping-history-date {
            font-weight: bold;
            color: #8B4513;
        }
        
        .shopping-history-summary {
            font-size: 14px;
            color: #6c757d;
        }
        
        .shopping-history-actions {
            display: flex;
            gap: 5px;
        }
        
        .btn-xs {
            padding: 2px 6px;
            font-size: 12px;
        }
        
        .shopping-history-details {
            background: #f8f9fa;
            border-radius: 4px;
            padding: 8px;
            margin-top: 8px;
            font-size: 13px;
            font-family: monospace;
            white-space: pre-line;
            display: none;
        }
        
        .shopping-history-details.expanded {
            display: block;
        }
        
        /* Frame Builder Cut List Styles */
        .cut-list {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border: 1px solid #D2B48C;
            border-radius: 4px;
        }
        
        .cut-list h4 {
            margin: 0 0 8px 0;
            color: #8B4513;
            font-size: 14px;
        }
        
        .cut-item {
            padding: 4px 0;
            color: #2F1B14;
            font-weight: bold;
            border-bottom: 1px solid #e9ecef;
        }
        
        .cut-item:last-child {
            border-bottom: none;
        }
        
        .cut-item small {
            color: #6c757d;
            font-weight: normal;
            font-size: 12px;
        }
        
        /* Golden Ratio Calculator Visuals */
        .golden-diagram {
            width: 200px;
            height: 120px;
        }
        
        .golden-rectangle {
            width: 100%;
            height: 100%;
            border: 2px solid #8B4513;
            border-radius: 4px;
            display: flex;
            position: relative;
        }
        
        .golden-small {
            flex: 1;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border-right: 1px solid #8B4513;
        }
        
        .golden-large {
            flex: 1.618;
            background: linear-gradient(135deg, #F0E68C, #DDD700);
        }
        
        .ratio-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: bold;
            color: #8B4513;
            font-size: 14px;
        }
        
        .calc-mode-selector {
            display: flex;
            margin-bottom: 15px;
            border-radius: 6px;
            overflow: hidden;
            border: 2px solid #D2B48C;
        }
        
        .mode-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: #f8f9fa;
            color: #8B4513;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .mode-btn.active {
            background: #8B4513;
            color: white;
        }
        
        /* Spacing Calculator Visuals */
        .spacing-diagram {
            width: 100%;
            height: 240px;
            position: relative;
            overflow-y: auto;
            overflow-x: auto;
        }
        
        .spacing-line {
            width: 100%;
            height: 20px;
            background: #DEB887;
            border: 2px solid #8B4513;
            border-radius: 4px;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
        }
        
        .spacing-marker {
            width: 3px;
            height: 40px;
            background: #8B4513;
            border-radius: 1px;
            position: relative;
        }
        
        .spacing-marker::after {
            content: '';
            position: absolute;
            top: -5px;
            left: -2px;
            width: 7px;
            height: 10px;
            background: #654321;
            border-radius: 2px;
        }
        
        /* Angle Calculator Visuals */
        .angle-diagram {
            width: 120px;
            height: 120px;
        }
        
        .polygon-shape {
            width: 100%;
            height: 100%;
            position: relative;
            border: 2px solid #8B4513;
            border-radius: 4px;
            background: linear-gradient(45deg, #F5DEB3, #D2B48C);
        }
        
        .angle-line {
            position: absolute;
            width: 2px;
            height: 40px;
            background: #8B4513;
            transform-origin: bottom center;
        }
        
        .preset-buttons {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .preset-btn {
            padding: 6px 12px;
            border: 1px solid #D2B48C;
            background: #f8f9fa;
            color: #8B4513;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .preset-btn:hover {
            background: #8B4513;
            color: white;
        }
        
        .preset-section {
            background: #f9f9f9;
            border: 2px solid #D2B48C;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .preset-section h4 {
            color: #8B4513;
            margin-bottom: 10px;
        }
        
        .preset-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }
        
        .history-clickable {
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .history-clickable:hover {
            background: #e8f5e8;
        }
        
        .history-timestamp {
            font-size: 10px;
            color: #999;
            float: right;
        }
        
        .history-result {
            background: #e8f5e8;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #4CAF50;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .history-conversion {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #2196F3;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .history-preset {
            background: #fff3e0;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #ff9800;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .history-equation {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: bold;
            color: #2F1B14;
        }
        
        .history-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        
        /* Modal for calculations */
        .calc-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .calc-modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .calc-modal h3 {
            margin-bottom: 15px;
            color: #8B4513;
        }
        
        .calc-modal .input-group {
            margin-bottom: 15px;
        }
        
        .calc-modal .btn {
            margin-right: 10px;
        }
        
        .button-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .quick-cuts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .quick-cuts .btn {
            padding: 12px 8px;
            font-size: 14px;
        }
        
        .btn {
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #8B4513;
            color: white;
        }
        
        .btn-primary:hover {
            background: #A0522D;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #D2B48C;
            color: #8B4513;
        }
        
        .btn-secondary:hover {
            background: #DEB887;
            transform: translateY(-2px);
        }
        
        .btn-operation {
            background: #D2B48C;
            color: #8B4513;
        }
        
        .btn-operation.active {
            background: #8B4513;
            color: white;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #1e7e34;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #d39e00;
        }
        
        /* Removed old project management bar styles - now using cleaner status indicators */
        
        /* Enhanced Spacing Calculator Results */
        .result-summary {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 3px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .summary-row:last-child {
            border-bottom: none;
        }
        
        .summary-label {
            font-weight: bold;
            color: #495057;
            font-size: 12px;
        }
        
        .summary-value {
            color: #212529;
            font-family: monospace;
            font-size: 13px;
        }
        
        .divider-marks {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }
        
        .marks-header {
            font-weight: bold;
            color: #856404;
            font-size: 13px;
            margin-bottom: 8px;
            text-align: center;
        }
        
        .divider-mark-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid rgba(133, 100, 4, 0.2);
        }
        
        .divider-mark-row:last-child {
            border-bottom: none;
        }
        
        .divider-label {
            font-weight: bold;
            color: #856404;
            font-size: 12px;
            flex: 1;
        }
        
        .mark-left, .mark-right {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #856404;
            border-radius: 3px;
            padding: 2px 6px;
            font-family: monospace;
            font-size: 11px;
            font-weight: bold;
            margin: 0 2px;
        }
        
        .mark-left {
            color: #d73502;
        }
        
        .mark-right {
            color: #0f5132;
        }
        
        .mark-center {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #6c757d;
            border-radius: 3px;
            padding: 2px 6px;
            font-family: monospace;
            font-size: 11px;
            font-weight: bold;
            color: #495057;
            margin: 0 2px;
        }
        
        /* Force scrollbar visibility */
        .spacing-diagram-container {
            scrollbar-width: auto !important;
            scrollbar-color: #007bff #f8f9fa !important;
        }
        
        .spacing-diagram-container::-webkit-scrollbar {
            height: 12px !important;
        }
        
        .spacing-diagram-container::-webkit-scrollbar-track {
            background: #f8f9fa !important;
            border-radius: 6px !important;
        }
        
        .spacing-diagram-container::-webkit-scrollbar-thumb {
            background: #007bff !important;
            border-radius: 6px !important;
        }
        
        .spacing-diagram-container::-webkit-scrollbar-thumb:hover {
            background: #0056b3 !important;
        }
        
        /* Visual Layout Styles */
        .board-visualization {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border: 2px solid #D2B48C;
            border-radius: 8px;
            overflow-x: auto;
        }
        
        .visual-board {
            margin-bottom: 20px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
            position: relative;
        }
        
        .board-header {
            font-weight: bold;
            margin-bottom: 10px;
            color: #8B4513;
        }
        
        .board-visual {
            height: 40px;
            background: linear-gradient(45deg, #D2B48C, #F5DEB3);
            border: 2px solid #8B4513;
            border-radius: 4px;
            position: relative;
            margin-bottom: 5px;
            overflow: hidden;
        }
        
        .cut-segment {
            position: absolute;
            height: 100%;
            border-right: 2px solid #8B4513;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            color: #654321;
            text-shadow: 1px 1px 1px rgba(255,255,255,0.7);
        }
        
        .cut-segment.used {
            background: rgba(40, 167, 69, 0.3);
        }
        
        .cut-segment.waste {
            background: rgba(220, 53, 69, 0.3);
        }
        
        .cut-segment.kerf {
            background: rgba(0, 0, 0, 0.2);
            width: 2px !important;
            border-right: none;
        }
        
        .board-stats {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .visual-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .efficiency-summary {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
        }
        
        .efficiency-good {
            background: #d4edda;
            border-color: #c3e6cb;
        }
        
        .efficiency-poor {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        
        /* Projects Tab Styles */
        .projects-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .projects-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .current-project-section {
            margin-bottom: 30px;
        }
        
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .project-card {
            background: white;
            border: 2px solid #D2B48C;
            border-radius: 10px;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        
        .project-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .project-card.current-project {
            border-color: #28a745;
            background: linear-gradient(145deg, #f8fff9, #ffffff);
        }
        
        .project-card-content {
            padding: 15px;
        }
        
        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .project-header h4 {
            margin: 0;
            color: #8B4513;
            font-size: 16px;
        }
        
        .project-actions {
            display: flex;
            gap: 5px;
        }
        
        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
            min-width: auto;
        }
        
        .project-stats {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .stat {
            font-size: 12px;
            color: #666;
            background: #f8f9fa;
            padding: 3px 6px;
            border-radius: 3px;
        }
        
        .project-preview {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            min-height: 60px;
        }
        
        .preview-message {
            color: #999;
            font-style: italic;
            text-align: center;
            padding: 15px;
        }
        
        .project-preview-boards {
            display: flex;
            gap: 5px;
            margin-bottom: 5px;
            flex-wrap: wrap;
        }
        
        .preview-board {
            background: linear-gradient(45deg, #D2B48C, #F5DEB3);
            border: 1px solid #8B4513;
            border-radius: 2px;
            padding: 2px 4px;
            font-size: 10px;
            color: #654321;
        }
        
        .project-notes-preview {
            font-size: 11px;
            color: #666;
            max-height: 30px;
            overflow: hidden;
            margin-top: 5px;
            line-height: 1.3;
        }
        
        .project-date {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }
        
        .no-projects {
            grid-column: 1/-1;
        }
        
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .template-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .template-card:hover {
            border-color: #8B4513;
            background: #fff;
        }
        
        .template-card h4 {
            margin: 0 0 8px 0;
            color: #8B4513;
        }
        
        .template-card p {
            margin: 0 0 10px 0;
            font-size: 13px;
            color: #666;
        }
        
        .template-stats {
            display: flex;
            gap: 10px;
            font-size: 11px;
            color: #999;
        }
        
        /* Project Status Bar */
        .project-status-bar {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 1px solid #D2B48C;
            border-radius: 6px;
            padding: 8px 12px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }
        
        .project-status-bar.active {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border-color: #28a745;
        }
        
        .project-status-bar .status-text {
            font-weight: 500;
            color: #666;
        }
        
        .project-status-bar.active .status-text {
            color: #155724;
        }
        
        @media (max-width: 600px) {
            .visual-controls {
                justify-content: center;
            }
            
            .board-visual {
                height: 50px;
            }
            
            .cut-segment {
                font-size: 10px;
            }
            
            .projects-header {
                flex-direction: column;
                text-align: center;
            }
            
            .projects-actions {
                justify-content: center;
            }
            
            .projects-grid {
                grid-template-columns: 1fr;
            }
            
            .project-stats {
                justify-content: center;
            }
            
            .project-status-bar {
                padding: 6px 10px;
                font-size: 12px;
            }
        }
        
        .manual-calc {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .history {
            max-height: 200px;
            overflow-y: auto;
            background: #f9f9f9;
            border: 2px solid #D2B48C;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
        }
        
        .history-item {
            padding: 8px;
            border-bottom: 1px solid #ddd;
            font-family: monospace;
            font-size: 14px;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .waste-section {
            margin-bottom: 20px;
        }
        
        .waste-section h3 {
            margin-bottom: 10px;
            color: #8B4513;
        }
        
        .board-input, .cut-input {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .results {
            background: #e8f5e8;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .cut-plan {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-family: monospace;
        }
        
        /* Visual diagram styles */
        .kerf-diagram {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 15px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .board-diagram {
            position: relative;
            width: 300px;
            height: 60px;
            background: linear-gradient(180deg, #D2691E 0%, #8B4513 100%);
            border: 2px solid #654321;
            border-radius: 2px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .mark-line {
            position: absolute;
            top: -10px;
            width: 2px;
            height: 80px;
            background: #ff0000;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .mark-label {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            font-weight: bold;
            color: #ff0000;
            white-space: nowrap;
        }
        
        .kerf-area {
            position: absolute;
            top: 0;
            height: 100%;
            background: rgba(0,0,0,0.5);
            border: 1px dashed #fff;
        }
        
        .kerf-area.right {
            left: 50%;
            width: 10px;
        }
        
        .kerf-area.left {
            right: 50%;
            width: 10px;
        }
        
        .diagram-label {
            position: absolute;
            bottom: -20px;
            font-size: 11px;
            white-space: nowrap;
        }
        
        .left-piece {
            left: 10px;
        }
        
        .right-piece {
            right: 10px;
        }
        
        /* Cut result styles */
        .cut-results {
            background: #f5f5f5;
            border: 2px solid #8B4513;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .cut-results h4 {
            color: #8B4513;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .mark-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .mark-item {
            background: white;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #8B4513;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .mark-item .mark-number {
            font-weight: bold;
            color: #8B4513;
        }
        
        .mark-item .mark-value {
            font-family: monospace;
            font-size: 16px;
            font-weight: bold;
        }
        
        .piece-info {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            color: #2e7d32;
        }
        
        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #f44336;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 3000;
            opacity: 0;
            transition: opacity 0.3s;
            max-width: 80%;
            text-align: center;
            font-weight: bold;
        }
        
        .notification.show {
            opacity: 1;
        }
        
        .notification.success {
            background: #4CAF50;
        }
        
        .notification.warning {
            background: #ff9800;
        }
        
        /* Edit modal styles */
        .edit-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .edit-modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .edit-modal h3 {
            margin-bottom: 15px;
            color: #8B4513;
        }
        
        .edit-modal .input-group {
            margin-bottom: 15px;
        }
        
        .edit-modal .btn {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Woodworking Calculator</h1>
        
        <div class="tab-buttons">
            <button class="tab-btn active" onclick="switchTab('calculator')">Calculator</button>
            <button class="tab-btn" onclick="switchTab('cutCalculator')">Cut Calculator</button>
            <button class="tab-btn" onclick="switchTab('optimizer')">Waste Optimizer</button>
            <button class="tab-btn" onclick="switchTab('projects')">📁 Projects</button>
        </div>
        
        <!-- Global Help Button -->
        <div style="text-align: right; margin-bottom: 15px;">
            <button class="btn btn-secondary" onclick="showHelp()" style="padding: 8px 12px; font-size: 14px;">❓ Help</button>
        </div>

        <!-- Calculator Tab -->
        <div id="calculator" class="tab-content active">
            <!-- Project Status Indicator -->
            <div class="project-status-bar" id="calcProjectStatus">
                <span class="status-text">No active project</span>
                <button class="btn btn-sm btn-secondary" onclick="switchTab('projects')" title="Manage Projects">📁</button>
            </div>
            
            <div class="settings-row">
                <label>Precision:</label>
                <select id="precision" onchange="updatePrecision('calculator')">
                    <option value="32">1/32"</option>
                    <option value="16" selected>1/16"</option>
                    <option value="8">1/8"</option>
                    <option value="4">1/4"</option>
                    <option value="2">1/2"</option>
                    <option value="1">1"</option>
                </select>
            </div>
            
            <div class="calc-display">
                <div class="memory-display" id="memoryIndicator"></div>
                <div class="calc-equation" id="calcEquation">&nbsp;</div>
                <div class="calc-result" id="calcResult">0"</div>
            </div>
            
            <div class="input-group">
                <label>Input 1:</label>
                <input type="number" id="feet1" placeholder="0" min="0" class="wide-input" onchange="updateCalculation()">
                <span>ft</span>
                <input type="number" id="inches1" placeholder="0" min="0" max="11" class="wide-input" onchange="updateCalculation()">
                <span>in</span>
                <select id="fraction1" style="width: 120px;" onchange="updateCalculation()">
                    <option value="0">0</option>
                </select>
            </div>
            
            <div class="calc-grid">
                <button class="calc-btn operation" onclick="setOperation('+')" id="addBtn">+</button>
                <button class="calc-btn operation" onclick="setOperation('-')" id="subBtn">−</button>
                <button class="calc-btn operation" onclick="setOperation('*')" id="mulBtn">×</button>
                <button class="calc-btn operation" onclick="setOperation('/')" id="divBtn">÷</button>
            </div>
            
            <!-- Input 2 for Addition/Subtraction (feet/inches) -->
            <div class="input-group" id="input2GroupFeetInches" style="display: none;">
                <label>Input 2:</label>
                <input type="number" id="feet2" placeholder="0" min="0" class="wide-input" onchange="updateCalculation()">
                <span>ft</span>
                <input type="number" id="inches2" placeholder="0" min="0" max="11" class="wide-input" onchange="updateCalculation()">
                <span>in</span>
                <select id="fraction2" style="width: 120px;" onchange="updateCalculation()">
                    <option value="0">0</option>
                </select>
            </div>
            
            <!-- Input 2 for Multiplication/Division (simple number) -->
            <div class="input-group" id="input2GroupNumber" style="display: none;">
                <label>Factor:</label>
                <input type="number" id="factor" placeholder="2" min="0" step="0.1" class="wide-input" onchange="updateCalculation()" style="width: 150px;">
                <span style="color: #666; font-size: 12px; margin-left: 5px;">(multiply/divide by this number)</span>
            </div>
            
            <div class="calc-grid" style="margin-top: 15px;">
                <button class="calc-btn memory" onclick="memoryOperation('MC')">MC</button>
                <button class="calc-btn memory" onclick="memoryOperation('MR')">MR</button>
                <button class="calc-btn memory" onclick="memoryOperation('M+')">M+</button>
                <button class="calc-btn memory" onclick="memoryOperation('M-')">M−</button>
                <button class="calc-btn clear" onclick="clearCalculator()">Clear</button>
                <button class="calc-btn save" onclick="saveToHistory()">Save</button>
            </div>
            
            <div class="conversion-section">
                <h4 style="color: #8B4513; margin-bottom: 10px;">Quick Conversions</h4>
                <div id="conversionPreview" class="conversion-preview">
                    Convert: <span id="conversionValue">Enter a value or calculate</span>
                </div>
                <div class="conversion-grid">
                    <button class="btn btn-secondary" onclick="convertToDecimal()">→ Decimal</button>
                    <button class="btn btn-secondary" onclick="convertToFraction()">→ Fraction</button>
                    <button class="btn btn-secondary" onclick="convertToFeet()">→ Decimal Feet</button>
                    <button class="btn btn-secondary" onclick="convertToInches()">→ Total Inches</button>
                </div>
            </div>
            
            <div class="woodworking-calcs-section">
                <h4 style="color: #8B4513; margin-bottom: 15px;">🔨 Woodworking Calculators</h4>
                
                <!-- Board Foot Calculator -->
                <div class="calc-card" id="boardFootCard">
                    <div class="calc-card-header" onclick="toggleCalcCard('boardFoot')">
                        <span class="calc-icon">📏</span>
                        <span class="calc-title">Lumber Shopping Cart</span>
                        <span class="calc-arrow">▼</span>
                    </div>
                    <div class="calc-card-content" id="boardFootContent">
                        <div class="calc-description">Calculate lumber costs by species and build a shopping cart</div>
                        <div class="calc-visual">
                            <div class="lumber-diagram" id="boardDiagram">
                                <div class="lumber-piece">
                                    <span class="dimension-label top">Length</span>
                                    <span class="dimension-label left">Width</span>
                                    <span class="dimension-label right">Thickness</span>
                                </div>
                            </div>
                        </div>
                        <div class="calc-inputs">
                            <div class="input-row">
                                <label>Wood Species:</label>
                                <select id="bfSpecies" onchange="handleSpeciesChange()">
                                    <option value="">Select species...</option>
                                    <option value="White Oak">White Oak</option>
                                    <option value="Red Oak">Red Oak</option>
                                    <option value="Maple">Maple</option>
                                    <option value="Cherry">Cherry</option>
                                    <option value="Walnut">Walnut</option>
                                    <option value="Poplar">Poplar</option>
                                    <option value="Pine">Pine</option>
                                    <option value="Cedar">Cedar</option>
                                    <option value="Mahogany">Mahogany</option>
                                    <option value="Ash">Ash</option>
                                    <option value="Birch">Birch</option>
                                    <option value="Custom">Custom Species</option>
                                </select>
                            </div>
                            <div class="input-row" id="customSpeciesRow" style="display: none;">
                                <label>Custom Species:</label>
                                <input type="text" id="bfCustomSpecies" placeholder="Enter species name" oninput="calculateBoardFeet()">
                            </div>
                            <div class="input-row">
                                <label>Price per Board Foot:</label>
                                <input type="number" id="bfPrice" step="0.01" min="0" placeholder="8.99" oninput="calculateBoardFeet()">
                                <span class="unit">$/BF</span>
                            </div>
                            <div class="input-row">
                                <label>Thickness:</label>
                                <input type="number" id="bfThickness" step="0.25" min="0.1" placeholder="1" oninput="calculateBoardFeet()">
                                <span class="unit">inches</span>
                            </div>
                            <div class="input-row">
                                <label>Width:</label>
                                <input type="number" id="bfWidth" step="0.25" min="0.1" placeholder="6" oninput="calculateBoardFeet()">
                                <span class="unit">inches</span>
                            </div>
                            <div class="input-row">
                                <label>Length:</label>
                                <input type="number" id="bfLength" step="1" min="0.1" placeholder="96" oninput="calculateBoardFeet()">
                                <span class="unit">inches</span>
                            </div>
                            <div class="input-row">
                                <label>Quantity:</label>
                                <input type="number" id="bfQuantity" min="1" placeholder="1" value="1" oninput="calculateBoardFeet()">
                                <span class="unit">pieces</span>
                            </div>
                        </div>
                        <div class="calc-result">
                            <div class="result-display" id="boardFootResult">Enter item details above</div>
                            <div class="cart-actions">
                                <button class="btn btn-primary btn-sm" onclick="addToLumberCart()">Add to Cart</button>
                                <button class="btn btn-secondary btn-sm" onclick="clearBoardFootForm()">Clear Form</button>
                            </div>
                        </div>
                        
                        <!-- Cart Display Section -->
                        <div class="cart-section">
                            <div id="lumberCartDisplay" class="cart-display">
                                <div class="result-placeholder">No items in cart</div>
                            </div>
                            <div class="cart-bottom-actions">
                                <button class="btn btn-success btn-sm" onclick="saveLumberCartToHistory()" id="saveCartBtn" disabled>Save Cart to History</button>
                                <button class="btn btn-secondary btn-sm" onclick="toggleShoppingHistory()" id="toggleHistoryBtn">Show Shopping History</button>
                            </div>
                        </div>
                        
                        <!-- Shopping History Section -->
                        <div class="shopping-history-section" id="shoppingHistorySection" style="display: none;">
                            <div class="shopping-history-header">
                                <h4>Shopping History</h4>
                                <button class="btn btn-secondary btn-sm" onclick="clearShoppingHistory()">Clear History</button>
                            </div>
                            <div id="shoppingHistoryDisplay" class="shopping-history-display">
                                <div class="result-placeholder">No shopping history</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Golden Ratio Calculator -->
                <div class="calc-card" id="goldenRatioCard">
                    <div class="calc-card-header" onclick="toggleCalcCard('goldenRatio')">
                        <span class="calc-icon">✨</span>
                        <span class="calc-title">Golden Ratio Calculator</span>
                        <span class="calc-arrow">▼</span>
                    </div>
                    <div class="calc-card-content" id="goldenRatioContent">
                        <div class="calc-description">Find proportional dimensions using the golden ratio (1.618)</div>
                        <div class="calc-visual">
                            <div class="golden-diagram">
                                <div class="golden-rectangle">
                                    <div class="golden-small"></div>
                                    <div class="golden-large"></div>
                                    <span class="ratio-label">1 : 1.618</span>
                                </div>
                            </div>
                        </div>
                        <div class="calc-inputs">
                            <div class="calc-mode-selector">
                                <button class="mode-btn active" onclick="setGoldenMode('short')" id="goldenModeShort">Short → Long</button>
                                <button class="mode-btn" onclick="setGoldenMode('long')" id="goldenModeLong">Long → Short</button>
                            </div>
                            <div class="input-row">
                                <label id="goldenInputLabel">Known dimension:</label>
                                <input type="number" id="grFeet" placeholder="0" min="0" class="wide-input" onchange="calculateGoldenRatioNew()">
                                <span>ft</span>
                                <input type="number" id="grInches" placeholder="0" min="0" max="11" class="wide-input" onchange="calculateGoldenRatioNew()">
                                <span>in</span>
                                <select id="grFraction" style="width: 120px;" onchange="calculateGoldenRatioNew()">
                                    <option value="0">0</option>
                                    <option value="0.0625">1/16"</option>
                                    <option value="0.125">1/8"</option>
                                    <option value="0.1875">3/16"</option>
                                    <option value="0.25">1/4"</option>
                                    <option value="0.3125">5/16"</option>
                                    <option value="0.375">3/8"</option>
                                    <option value="0.4375">7/16"</option>
                                    <option value="0.5">1/2"</option>
                                    <option value="0.5625">9/16"</option>
                                    <option value="0.625">5/8"</option>
                                    <option value="0.6875">11/16"</option>
                                    <option value="0.75">3/4"</option>
                                    <option value="0.8125">13/16"</option>
                                    <option value="0.875">7/8"</option>
                                    <option value="0.9375">15/16"</option>
                                </select>
                            </div>
                        </div>
                        <div class="calc-result">
                            <div class="result-display" id="grResult">Enter a dimension to calculate</div>
                            <button class="btn btn-primary btn-sm" onclick="saveGoldenRatioToHistory()">Save to History</button>
                        </div>
                    </div>
                </div>

                <!-- Shelf & Division Calculator -->
                <div class="calc-card" id="spacingCard">
                    <div class="calc-card-header" onclick="toggleCalcCard('spacing')">
                        <span class="calc-icon">📐</span>
                        <span class="calc-title">Shelf & Division Calculator</span>
                        <span class="calc-arrow">▼</span>
                    </div>
                    <div class="calc-card-content" id="spacingContent">
                        <div class="calc-description">Calculate shelf spacing and divisions for woodworking projects</div>
                        <div class="calc-inputs">
                            <div class="input-row">
                                <label>Total Length:</label>
                                <input type="number" id="spTotalLength" step="0.25" placeholder="48" oninput="calculateSpacing()">
                                <span class="unit">inches</span>
                            </div>
                            <div class="input-row">
                                <label>Number of Spaces:</label>
                                <input type="number" id="spNumSpaces" min="2" placeholder="5" oninput="calculateSpacing()">
                                <span class="unit">spaces</span>
                            </div>
                            <div class="input-row">
                                <label>Material Thickness:</label>
                                <input type="number" id="spacingThickness" step="0.25" placeholder="0.75" oninput="calculateSpacing()">
                                <span class="unit">inches</span>
                            </div>
                        </div>
                        <div class="calc-result">
                            <div class="result-display" id="spResult">Enter dimensions to calculate</div>
                            <button class="btn btn-primary btn-sm" onclick="saveSpacingToHistory()">Save to History</button>
                        </div>
                        <div class="calc-visual">
                            <div class="spacing-diagram" id="spacingDiagram">
                                <div style="text-align: center; color: #666; padding: 20px;">Enter dimensions to see spacing diagram</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Miter Angle Calculator -->
                <div class="calc-card" id="angleCard">
                    <div class="calc-card-header" onclick="toggleCalcCard('angle')">
                        <span class="calc-icon">📐</span>
                        <span class="calc-title">Miter Angle Calculator</span>
                        <span class="calc-arrow">▼</span>
                    </div>
                    <div class="calc-card-content" id="angleContent">
                        <div class="calc-description">Calculate miter angles for polygons and frames</div>
                        <div class="calc-visual">
                            <div class="angle-diagram" id="angleDiagram">
                                <div class="polygon-shape" id="polygonShape">
                                    <div class="angle-line"></div>
                                    <div class="angle-line"></div>
                                    <div class="angle-line"></div>
                                    <div class="angle-line"></div>
                                </div>
                            </div>
                        </div>
                        <div class="calc-inputs">
                            <div class="calc-mode-selector">
                                <button class="mode-btn active" onclick="setMiterMode('polygon')" id="miterModePolygon">Polygon</button>
                                <button class="mode-btn" onclick="setMiterMode('frame')" id="miterModeFrame">Frame Builder</button>
                                <button class="mode-btn" onclick="setMiterMode('single')" id="miterModeSingle">Single Cut</button>
                            </div>
                            
                            <div id="polygonMiterInputs">
                                <div class="input-row">
                                    <label>Number of Sides:</label>
                                    <input type="number" id="maSides" min="3" max="20" placeholder="4" value="4" oninput="calculateMiterAngle()">
                                    <span class="unit">sides</span>
                                </div>
                                <div class="preset-buttons">
                                    <button class="preset-btn" onclick="setAngleSides(3)">Triangle</button>
                                    <button class="preset-btn" onclick="setAngleSides(4)">Square</button>
                                    <button class="preset-btn" onclick="setAngleSides(6)">Hexagon</button>
                                    <button class="preset-btn" onclick="setAngleSides(8)">Octagon</button>
                                </div>
                            </div>
                            
                            <div id="singleMiterInputs" style="display: none;">
                                <div class="input-row">
                                    <label>Miter Angle:</label>
                                    <input type="number" id="singleMiterAngle" step="0.5" placeholder="45" oninput="calculateSingleMiter()">
                                    <span class="unit">degrees</span>
                                </div>
                                <div class="input-row">
                                    <label>Board Width:</label>
                                    <input type="number" id="singleBoardWidthFeet" placeholder="0" min="0" class="wide-input" onchange="calculateSingleMiter()">
                                    <span>ft</span>
                                    <input type="number" id="singleBoardWidthInches" placeholder="3" min="0" max="11" class="wide-input" onchange="calculateSingleMiter()">
                                    <span>in</span>
                                    <select id="singleBoardWidthFraction" style="width: 120px;" onchange="calculateSingleMiter()">
                                        <option value="0">0</option>
                                        <option value="0.0625">1/16"</option>
                                        <option value="0.125">1/8"</option>
                                        <option value="0.1875">3/16"</option>
                                        <option value="0.25">1/4"</option>
                                        <option value="0.3125">5/16"</option>
                                        <option value="0.375">3/8"</option>
                                        <option value="0.4375">7/16"</option>
                                        <option value="0.5" selected>1/2"</option>
                                        <option value="0.5625">9/16"</option>
                                        <option value="0.625">5/8"</option>
                                        <option value="0.6875">11/16"</option>
                                        <option value="0.75">3/4"</option>
                                        <option value="0.8125">13/16"</option>
                                        <option value="0.875">7/8"</option>
                                        <option value="0.9375">15/16"</option>
                                    </select>
                                </div>
                                <div class="input-row">
                                    <label>Known Side:</label>
                                    <select id="singleKnownSide" onchange="calculateSingleMiter()">
                                        <option value="long">Long side (back)</option>
                                        <option value="short">Short side (front)</option>
                                    </select>
                                </div>
                                <div class="input-row">
                                    <label id="singleInputLabel">Long side length:</label>
                                    <input type="number" id="singleInputLengthFeet" placeholder="1" min="0" class="wide-input" onchange="calculateSingleMiter()">
                                    <span>ft</span>
                                    <input type="number" id="singleInputLengthInches" placeholder="0" min="0" max="11" class="wide-input" onchange="calculateSingleMiter()">
                                    <span>in</span>
                                    <select id="singleInputLengthFraction" style="width: 120px;" onchange="calculateSingleMiter()">
                                        <option value="0" selected>0</option>
                                        <option value="0.0625">1/16"</option>
                                        <option value="0.125">1/8"</option>
                                        <option value="0.1875">3/16"</option>
                                        <option value="0.25">1/4"</option>
                                        <option value="0.3125">5/16"</option>
                                        <option value="0.375">3/8"</option>
                                        <option value="0.4375">7/16"</option>
                                        <option value="0.5">1/2"</option>
                                        <option value="0.5625">9/16"</option>
                                        <option value="0.625">5/8"</option>
                                        <option value="0.6875">11/16"</option>
                                        <option value="0.75">3/4"</option>
                                        <option value="0.8125">13/16"</option>
                                        <option value="0.875">7/8"</option>
                                        <option value="0.9375">15/16"</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Frame Builder Inputs -->
                            <div id="frameMiterInputs" style="display: none;">
                                <div class="input-row">
                                    <label>Frame Shape:</label>
                                    <select id="frameShapeSides" onchange="updateFrameDimensionLabels(); calculateFrameBuilder()">
                                        <option value="4" selected>Rectangle/Square</option>
                                        <option value="3">Triangle</option>
                                        <option value="6">Hexagon</option>
                                        <option value="8">Octagon</option>
                                        <option value="5">Pentagon</option>
                                        <option value="7">Heptagon</option>
                                    </select>
                                </div>
                                
                                <div class="input-row">
                                    <label>Material Width:</label>
                                    <input type="number" id="frameMaterialWidthFeet" placeholder="0" min="0" class="wide-input" onchange="calculateFrameBuilder()">
                                    <span>ft</span>
                                    <input type="number" id="frameMaterialWidthInches" placeholder="2" min="0" max="11" class="wide-input" onchange="calculateFrameBuilder()">
                                    <span>in</span>
                                    <select id="frameMaterialWidthFraction" style="width: 120px;" onchange="calculateFrameBuilder()">
                                        <option value="0">0</option>
                                        <option value="0.0625">1/16"</option>
                                        <option value="0.125">1/8"</option>
                                        <option value="0.1875">3/16"</option>
                                        <option value="0.25" selected>1/4"</option>
                                        <option value="0.3125">5/16"</option>
                                        <option value="0.375">3/8"</option>
                                        <option value="0.4375">7/16"</option>
                                        <option value="0.5">1/2"</option>
                                        <option value="0.5625">9/16"</option>
                                        <option value="0.625">5/8"</option>
                                        <option value="0.6875">11/16"</option>
                                        <option value="0.75">3/4"</option>
                                        <option value="0.8125">13/16"</option>
                                        <option value="0.875">7/8"</option>
                                        <option value="0.9375">15/16"</option>
                                    </select>
                                </div>
                                
                                <div class="input-row">
                                    <label>Target Dimensions:</label>
                                    <select id="frameDimensionType" onchange="updateFrameDimensionLabels(); calculateFrameBuilder()">
                                        <option value="inside" selected>Inside Dimensions (opening size)</option>
                                        <option value="outside">Outside Dimensions (frame outer edge)</option>
                                    </select>
                                </div>
                                
                                <!-- Rectangle/Square Dimensions -->
                                <div id="frameRectangleDimensions">
                                    <div class="input-row">
                                        <label id="frameWidthLabel">Inside Width:</label>
                                        <input type="number" id="frameWidthFeet" placeholder="0" min="0" class="wide-input" onchange="calculateFrameBuilder()">
                                        <span>ft</span>
                                        <input type="number" id="frameWidthInches" placeholder="8" min="0" max="11" class="wide-input" onchange="calculateFrameBuilder()">
                                        <span>in</span>
                                        <select id="frameWidthFraction" style="width: 120px;" onchange="calculateFrameBuilder()">
                                            <option value="0" selected>0</option>
                                            <option value="0.0625">1/16"</option>
                                            <option value="0.125">1/8"</option>
                                            <option value="0.1875">3/16"</option>
                                            <option value="0.25">1/4"</option>
                                            <option value="0.3125">5/16"</option>
                                            <option value="0.375">3/8"</option>
                                            <option value="0.4375">7/16"</option>
                                            <option value="0.5">1/2"</option>
                                            <option value="0.5625">9/16"</option>
                                            <option value="0.625">5/8"</option>
                                            <option value="0.6875">11/16"</option>
                                            <option value="0.75">3/4"</option>
                                            <option value="0.8125">13/16"</option>
                                            <option value="0.875">7/8"</option>
                                            <option value="0.9375">15/16"</option>
                                        </select>
                                    </div>
                                    <div class="input-row">
                                        <label id="frameHeightLabel">Inside Height:</label>
                                        <input type="number" id="frameHeightFeet" placeholder="0" min="0" class="wide-input" onchange="calculateFrameBuilder()">
                                        <span>ft</span>
                                        <input type="number" id="frameHeightInches" placeholder="10" min="0" max="11" class="wide-input" onchange="calculateFrameBuilder()">
                                        <span>in</span>
                                        <select id="frameHeightFraction" style="width: 120px;" onchange="calculateFrameBuilder()">
                                            <option value="0" selected>0</option>
                                            <option value="0.0625">1/16"</option>
                                            <option value="0.125">1/8"</option>
                                            <option value="0.1875">3/16"</option>
                                            <option value="0.25">1/4"</option>
                                            <option value="0.3125">5/16"</option>
                                            <option value="0.375">3/8"</option>
                                            <option value="0.4375">7/16"</option>
                                            <option value="0.5">1/2"</option>
                                            <option value="0.5625">9/16"</option>
                                            <option value="0.625">5/8"</option>
                                            <option value="0.6875">11/16"</option>
                                            <option value="0.75">3/4"</option>
                                            <option value="0.8125">13/16"</option>
                                            <option value="0.875">7/8"</option>
                                            <option value="0.9375">15/16"</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Regular Polygon Dimensions (for non-rectangles) -->
                                <div id="framePolygonDimensions" style="display: none;">
                                    <div class="input-row">
                                        <label id="framePolygonLabel">Inside Side Length:</label>
                                        <input type="number" id="framePolygonFeet" placeholder="0" min="0" class="wide-input" onchange="calculateFrameBuilder()">
                                        <span>ft</span>
                                        <input type="number" id="framePolygonInches" placeholder="12" min="0" max="11" class="wide-input" onchange="calculateFrameBuilder()">
                                        <span>in</span>
                                        <select id="framePolygonFraction" style="width: 120px;" onchange="calculateFrameBuilder()">
                                            <option value="0" selected>0</option>
                                            <option value="0.0625">1/16"</option>
                                            <option value="0.125">1/8"</option>
                                            <option value="0.1875">3/16"</option>
                                            <option value="0.25">1/4"</option>
                                            <option value="0.3125">5/16"</option>
                                            <option value="0.375">3/8"</option>
                                            <option value="0.4375">7/16"</option>
                                            <option value="0.5">1/2"</option>
                                            <option value="0.5625">9/16"</option>
                                            <option value="0.625">5/8"</option>
                                            <option value="0.6875">11/16"</option>
                                            <option value="0.75">3/4"</option>
                                            <option value="0.8125">13/16"</option>
                                            <option value="0.875">7/8"</option>
                                            <option value="0.9375">15/16"</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="calc-result">
                            <div class="result-display" id="maResult">Miter angle: 45°</div>
                            <button class="btn btn-primary btn-sm" onclick="saveAngleToHistory()">Save to History</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="history" id="history">
                <!-- History will appear here -->
            </div>
        </div>
        
        <!-- Cut Calculator Tab -->
        <div id="cutCalculator" class="tab-content">
            <!-- Project Status Indicator -->
            <div class="project-status-bar" id="cutProjectStatus">
                <span class="status-text">No active project</span>
                <button class="btn btn-sm btn-secondary" onclick="switchTab('projects')" title="Manage Projects">📁</button>
            </div>
            
            <div class="settings-row">
                <label>Precision:</label>
                <select id="cutPrecision" onchange="updatePrecision('cut')">
                    <option value="32">1/32"</option>
                    <option value="16" selected>1/16"</option>
                    <option value="8">1/8"</option>
                    <option value="4">1/4"</option>
                    <option value="2">1/2"</option>
                    <option value="1">1"</option>
                </select>
            </div>
            
            <div class="settings-row">
                <label>
                    <input type="checkbox" id="cutKerfEnabled" checked onchange="toggleKerfDisplay()"> 
                    Kerf Compensation
                </label>
            </div>
            
            <div class="settings-row" id="cutKerfRow">
                <label>Kerf:</label>
                <select id="cutKerf">
                    <option value="0.0625">1/16"</option>
                    <option value="0.09375">3/32"</option>
                    <option value="0.125" selected>1/8"</option>
                    <option value="0.1875">3/16"</option>
                </select>
            </div>
            
            <div class="settings-row">
                <label>Cut Side of Mark:</label>
                <select id="cutSide" onchange="updateKerfDiagram()">
                    <option value="left">Left Side</option>
                    <option value="right">Right Side</option>
                </select>
            </div>
            
            <div class="kerf-diagram" id="kerfDiagram" style="display: none;">
                <div class="board-diagram">
                    <div class="mark-line"></div>
                    <div class="mark-label">Mark</div>
                    <div class="kerf-area" id="kerfArea"></div>
                    <div class="diagram-label left-piece">Left piece</div>
                    <div class="diagram-label right-piece">Right piece</div>
                </div>
            </div>
            
            <div class="input-group">
                <label>Input:</label>
                <input type="number" id="cutFeet" placeholder="0" min="0" class="wide-input">
                <span>ft</span>
                <input type="number" id="cutInches" placeholder="0" min="0" max="11" class="wide-input">
                <span>in</span>
                <select id="cutFraction" style="width: 120px;">
                    <option value="0">0</option>
                </select>
                <button class="btn btn-secondary" onclick="setCutValue()">Set</button>
            </div>
            
            <div class="current-value" id="cutCurrentValue">
                Enter measurement above
            </div>
            
            <div class="quick-cuts">
                <button class="btn btn-primary" onclick="quickCut(2)">Half</button>
                <button class="btn btn-primary" onclick="quickCut(3)">Thirds</button>
                <button class="btn btn-primary" onclick="quickCut(4)">Fourths</button>
                <button class="btn btn-primary" onclick="quickCut(5)">Fifths</button>
                <button class="btn btn-primary" onclick="quickCut(6)">Sixths</button>
                <button class="btn btn-primary" onclick="quickCut(8)">Eighths</button>
            </div>
            
            <div class="input-group" style="margin-bottom: 15px;">
                <label>Custom:</label>
                <input type="number" id="customPieces" placeholder="# pieces" min="2" max="20" class="wide-input">
                <button class="btn btn-primary" onclick="customCut()">Cut</button>
                <button class="btn btn-secondary" onclick="clearCut()">Clear</button>
            </div>
            
            <div class="history" id="cutHistory">
                <!-- Results will appear here -->
            </div>
        </div>

        <!-- Waste Optimizer Tab -->
        <div id="optimizer" class="tab-content">
            <!-- Project Status Indicator -->
            <div class="project-status-bar" id="optProjectStatus">
                <span class="status-text">No active project</span>
                <button class="btn btn-sm btn-secondary" onclick="switchTab('projects')" title="Manage Projects">📁</button>
            </div>
            
            <div class="settings-row">
                <label>Precision:</label>
                <select id="optPrecision" onchange="updatePrecision('optimizer')">
                    <option value="32">1/32"</option>
                    <option value="16" selected>1/16"</option>
                    <option value="8">1/8"</option>
                    <option value="4">1/4"</option>
                    <option value="2">1/2"</option>
                    <option value="1">1"</option>
                </select>
            </div>
            
            <div class="settings-row">
                <label>
                    <input type="checkbox" id="optKerfEnabled" checked onchange="toggleKerfDisplay()"> 
                    Kerf Compensation
                </label>
            </div>
            
            <div class="settings-row" id="optKerfRow">
                <label>Kerf:</label>
                <select id="optKerf">
                    <option value="0.0625">1/16"</option>
                    <option value="0.09375">3/32"</option>
                    <option value="0.125" selected>1/8"</option>
                    <option value="0.1875">3/16"</option>
                </select>
            </div>
            
            <div class="waste-section">
                <h3>Available Boards</h3>
                <div class="board-input">
                    <input type="number" id="boardFeet" placeholder="0" min="0" class="wide-input">
                    <span>ft</span>
                    <input type="number" id="boardInches" placeholder="0" min="0" max="11" class="wide-input">
                    <span>in</span>
                    <select id="boardFraction" style="width: 120px;">
                        <option value="0">0</option>
                    </select>
                    <input type="number" id="boardQuantity" placeholder="1" min="1" class="wide-input">
                    <span>qty</span>
                    <button class="btn btn-secondary" onclick="addBoard()">Add</button>
                </div>
                <div id="boardsList"></div>
            </div>
            
            <div class="waste-section">
                <h3>Needed Cuts</h3>
                <div class="cut-input">
                    <input type="number" id="optCutFeet" placeholder="0" min="0" class="wide-input">
                    <span>ft</span>
                    <input type="number" id="optCutInches" placeholder="0" min="0" max="11" class="wide-input">
                    <span>in</span>
                    <select id="optCutFraction" style="width: 120px;">
                        <option value="0">0</option>
                    </select>
                    <input type="number" id="cutQuantity" placeholder="1" min="1" class="wide-input">
                    <span>qty</span>
                    <button class="btn btn-secondary" onclick="addCut()">Add</button>
                </div>
                <div id="cutsList"></div>
            </div>
            
            <button class="btn btn-primary" onclick="optimizeCuts()" style="width: 100%; margin-bottom: 15px;">Optimize Cuts</button>
            
            <div id="optimizationResults"></div>
            
            <!-- Visual Cut Layout -->
            <div id="visualLayout" style="display: none;">
                <h3>Visual Cut Layout</h3>
                <div class="visual-controls">
                    <button class="btn btn-secondary" onclick="toggleVisualLayout()">Hide Visual</button>
                    <button class="btn btn-secondary" onclick="exportCutList()">Export Cut List</button>
                </div>
                <div id="boardVisualization" class="board-visualization"></div>
            </div>
        </div>
        
        <!-- Projects Tab -->
        <div id="projects" class="tab-content">
            <div class="projects-header">
                <h2>📁 Project Manager</h2>
                <div class="projects-actions">
                    <button class="btn btn-primary" onclick="createNewProject()">+ New Project</button>
                    <button class="btn btn-secondary" onclick="showProjectTemplates()">📋 Templates</button>
                    <button class="btn btn-secondary" onclick="importProjects()">📥 Import</button>
                    <button class="btn btn-secondary" onclick="exportAllProjects()">📤 Export All</button>
                </div>
            </div>
            
            <div class="current-project-section" id="currentProjectSection">
                <h3>Current Project</h3>
                <div id="currentProjectCard" class="project-card current-project">
                    <div class="project-card-content">
                        <div class="project-header">
                            <h4>No Active Project</h4>
                            <div class="project-actions">
                                <button class="btn btn-sm btn-secondary" onclick="showProjectNotes()" title="Edit Notes">📝</button>
                                <button class="btn btn-sm btn-success" onclick="saveCurrentProject()" title="Save Project">💾</button>
                            </div>
                        </div>
                        <div class="project-stats">
                            <span class="stat">📏 0 boards</span>
                            <span class="stat">✂️ 0 cuts</span>
                            <span class="stat">🧮 0 calculations</span>
                        </div>
                        <div class="project-preview">
                            <div class="preview-message">Select or create a project to get started</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="all-projects-section">
                <h3>All Projects</h3>
                <div id="projectsGrid" class="projects-grid">
                    <!-- Project cards will be dynamically generated here -->
                </div>
                <div id="noProjectsMessage" class="no-projects" style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 48px; margin-bottom: 20px;">📁</div>
                    <h3>No Projects Yet</h3>
                    <p>Create your first project or choose from a template to get started!</p>
                    <button class="btn btn-primary" onclick="createNewProject()" style="margin-right: 10px;">Create Project</button>
                    <button class="btn btn-secondary" onclick="showProjectTemplates()">Browse Templates</button>
                </div>
            </div>
        </div>
        
        <!-- Project Notes Modal -->
        <div id="notesModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeProjectNotes()">&times;</span>
                <h2>📝 Project Notes</h2>
                <div id="notesContent">
                    <p><strong>Project:</strong> <span id="notesProjectName">No project selected</span></p>
                    <textarea id="projectNotesText" placeholder="Add notes about your project - materials needed, measurements, design thoughts, etc." 
                              style="width: 100%; height: 200px; margin: 10px 0; padding: 10px; border: 2px solid #D2B48C; border-radius: 5px; font-family: Arial, sans-serif; resize: vertical;"></textarea>
                    <div style="text-align: right; margin-top: 10px;">
                        <button class="btn btn-secondary" onclick="closeProjectNotes()" style="margin-right: 10px;">Cancel</button>
                        <button class="btn btn-success" onclick="saveProjectNotes()">Save Notes</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Help Modal -->
        <div id="helpModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeHelp()">&times;</span>
                <h2>🪵 Woodworking Calculator Help</h2>
                
                <h3>Calculator Tab</h3>
                <p>Pure math calculations without kerf compensation. Perfect for:</p>
                <ul>
                    <li>Adding multiple board lengths</li>
                    <li>Calculating total project dimensions</li>
                    <li>General measurement conversions</li>
                </ul>
                <p><strong>Input modes:</strong> Toggle between fraction mode (feet/inches/fractions) and decimal mode (decimal inches).</p>
                
                <h3>Cut Calculator Tab</h3>
                <p>Cutting operations with automatic kerf compensation. Features:</p>
                <ul>
                    <li><strong>Quick Cuts:</strong> Cut boards in half, thirds, or fourths with automatic kerf compensation</li>
                    <li><strong>Cut Side of Mark:</strong> Choose if you cut on the left or right side of your pencil mark</li>
                    <li><strong>Kerf Settings:</strong> Select your blade width (1/16" to 3/16")</li>
                </ul>
                <p>The app calculates exactly where to mark your cuts so you get identical pieces after accounting for blade kerf.</p>
                
                <h3>Waste Optimizer Tab</h3>
                <p>Minimize lumber waste by optimizing how you cut multiple pieces:</p>
                <ul>
                    <li>Add all your available board lengths</li>
                    <li>Add all the pieces you need to cut (with quantities)</li>
                    <li>Get an optimized cutting plan showing which cuts to make on each board</li>
                    <li>Includes kerf compensation in the optimization</li>
                </ul>
                
                <h3>Precision Settings</h3>
                <p>Set your measuring precision (1/32" to 1") - all inputs and outputs will match your tape measure markings.</p>
                
                <h3>Tips</h3>
                <ul>
                    <li>Results automatically convert to feet and inches when appropriate</li>
                    <li>History tracks all your calculations for reference</li>
                    <li>All tabs work offline once loaded</li>
                    <li>Designed for use with work gloves in dusty shop conditions</li>
                </ul>
            </div>
        </div>
        
        <!-- Edit Modal -->
        <div id="editModal" class="edit-modal">
            <div class="edit-modal-content">
                <h3 id="editTitle">Edit Item</h3>
                <div id="editInputs">
                    <!-- Dynamic content will be inserted here -->
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="saveEdit()">Save</button>
                    <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                    <button class="btn btn-secondary" onclick="deleteEdit()" style="background: #cd5c5c; color: white; float: right;">Delete</button>
                </div>
            </div>
        </div>
        
        <!-- Calculation Modal -->
        <div id="calcModal" class="calc-modal">
            <div class="calc-modal-content">
                <span class="close" onclick="closeCalcModal()">&times;</span>
                <h3 id="calcModalTitle">Calculation</h3>
                <div id="calcModalInputs">
                    <!-- Dynamic content will be inserted here -->
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="executeModalCalc()">Calculate</button>
                    <button class="btn btn-secondary" onclick="closeCalcModal()">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Notification element -->
        <div id="notification" class="notification"></div>
    </div>

    <script>
        let currentValueInches = 0;
        let cutValueInches = 0;
        let currentOperation = null;
        let operationValue = 0;
        let history = [];
        let cutHistory = [];
        let boards = []; // Array of {length: number, quantity: number} objects
        let cuts = []; // Array of {length: number, id: unique_id}
        let inputMode = 'fraction';
        let editingItem = null; // Track what we're editing
        let cutIdCounter = 0; // For unique cut IDs
        let memoryValue = 0; // Calculator memory
        let value1 = 0; // First calculator value
        let value2 = 0; // Second calculator value
        let projects = []; // Array to store saved projects
        let currentProject = null; // Currently active project
        let lumberCart = []; // Array to store lumber shopping cart items
        let speciesPrices = {}; // Object to remember prices for each species
        let shoppingHistory = []; // Array to store lumber shopping history
        
        // Data persistence functions
        function saveToLocalStorage() {
            const data = {
                projects: projects,
                currentProject: currentProject,
                history: history,
                cutHistory: cutHistory,
                memoryValue: memoryValue,
                speciesPrices: speciesPrices,
                shoppingHistory: shoppingHistory,
                settings: {
                    precision: document.getElementById('precision')?.value || 16,
                    cutPrecision: document.getElementById('cutPrecision')?.value || 16,
                    optPrecision: document.getElementById('optPrecision')?.value || 16
                }
            };
            localStorage.setItem('woodworkingCalculator', JSON.stringify(data));
        }
        
        function loadFromLocalStorage() {
            try {
                const data = JSON.parse(localStorage.getItem('woodworkingCalculator'));
                if (data) {
                    projects = data.projects || [];
                    currentProject = data.currentProject || null;
                    history = data.history || [];
                    cutHistory = data.cutHistory || [];
                    memoryValue = data.memoryValue || 0;
                    speciesPrices = data.speciesPrices || {};
                    shoppingHistory = data.shoppingHistory || [];
                    
                    // Restore settings
                    if (data.settings) {
                        if (document.getElementById('precision')) document.getElementById('precision').value = data.settings.precision;
                        if (document.getElementById('cutPrecision')) document.getElementById('cutPrecision').value = data.settings.cutPrecision;
                        if (document.getElementById('optPrecision')) document.getElementById('optPrecision').value = data.settings.optPrecision;
                    }
                    
                    updateDisplays();
                    showNotification('Data loaded successfully!', 'success');
                }
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('Error loading saved data', 'error');
            }
        }
        
        function updateDisplays() {
            updateHistory();
            updateCutHistory();
            updateMemoryIndicator();
            if (currentProject) {
                showNotification(`Project "${currentProject.name}" loaded`, 'success');
            }
        }
        
        function updateCalculatorDisplay() {
            // Update calculator display with current values
            const calcResult = document.getElementById('calcResult');
            const calcEquation = document.getElementById('calcEquation');
            
            if (calcResult) {
                calcResult.textContent = inchesToDisplay(currentValueInches, 'calculator');
            }
            
            if (calcEquation && currentOperation) {
                const val1Display = inchesToDisplay(value1, 'calculator');
                calcEquation.textContent = `${val1Display} ${currentOperation}`;
            } else if (calcEquation) {
                calcEquation.innerHTML = '&nbsp;';
            }
            
            // Update input fields
            const feet1 = document.getElementById('feet1');
            const inches1 = document.getElementById('inches1');
            if (feet1 && inches1) {
                const { feet, inches, fraction } = inchesToFeetInches(currentValueInches);
                feet1.value = feet;
                inches1.value = inches;
                
                const fraction1 = document.getElementById('fraction1');
                if (fraction1) {
                    fraction1.value = fraction;
                }
            }
        }
        
        // Project management functions
        function createNewProject() {
            const name = prompt('Enter project name:');
            if (name && name.trim()) {
                const project = {
                    id: Date.now(),
                    name: name.trim(),
                    created: new Date().toISOString(),
                    boards: [...boards],
                    cuts: [...cuts],
                    history: [...history],
                    cutHistory: [...cutHistory],
                    calculatorData: {
                        currentValueInches: currentValueInches,
                        cutValueInches: cutValueInches,
                        currentOperation: currentOperation,
                        operationValue: operationValue,
                        memoryValue: memoryValue,
                        value1: value1,
                        value2: value2,
                        inputMode: inputMode
                    },
                    notes: '',
                    tags: []
                };
                projects.push(project);
                currentProject = project;
                saveToLocalStorage();
                showNotification(`Project "${name}" created!`, 'success');
                updateProjectSelector();
                renderProjectsTab();
            }
        }
        
        function saveCurrentProject() {
            if (!currentProject) {
                createNewProject();
                return;
            }
            
            currentProject.boards = [...boards];
            currentProject.cuts = [...cuts];
            currentProject.history = [...history];
            currentProject.cutHistory = [...cutHistory];
            currentProject.calculatorData = {
                currentValueInches: currentValueInches,
                cutValueInches: cutValueInches,
                currentOperation: currentOperation,
                operationValue: operationValue,
                memoryValue: memoryValue,
                value1: value1,
                value2: value2,
                inputMode: inputMode
            };
            currentProject.lastModified = new Date().toISOString();
            
            // Update in projects array
            const index = projects.findIndex(p => p.id === currentProject.id);
            if (index !== -1) {
                projects[index] = currentProject;
            }
            
            saveToLocalStorage();
            showNotification(`Project "${currentProject.name}" saved!`, 'success');
            renderProjectsTab();
        }
        
        function loadProject(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (project) {
                currentProject = project;
                boards = [...project.boards];
                cuts = [...project.cuts];
                history = [...project.history];
                cutHistory = [...project.cutHistory];
                
                // Restore calculator data if available
                if (project.calculatorData) {
                    currentValueInches = project.calculatorData.currentValueInches || 0;
                    cutValueInches = project.calculatorData.cutValueInches || 0;
                    currentOperation = project.calculatorData.currentOperation || null;
                    operationValue = project.calculatorData.operationValue || 0;
                    memoryValue = project.calculatorData.memoryValue || 0;
                    value1 = project.calculatorData.value1 || 0;
                    value2 = project.calculatorData.value2 || 0;
                    inputMode = project.calculatorData.inputMode || 'fraction';
                }
                
                updateDisplays();
                updateBoardDisplay();
                updateCutDisplay();
                updateCalculatorDisplay();
                showNotification(`Project "${project.name}" loaded!`, 'success');
            }
        }
        
        function deleteProject(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (project && confirm(`Delete project "${project.name}"?`)) {
                projects = projects.filter(p => p.id !== projectId);
                if (currentProject && currentProject.id === projectId) {
                    currentProject = null;
                }
                saveToLocalStorage();
                updateProjectSelector();
                renderProjectsTab();
                showNotification('Project deleted', 'success');
            }
        }
        
        function updateProjectSelector() {
            // This function now just updates the visual displays since we removed the global selector
            renderProjectsTab();
            updateProjectStatusBars();
        }
        
        function showProjectManager() {
            if (projects.length === 0) {
                showNotification('No projects to manage. Create a project first!', 'warning');
                return;
            }
            
            let projectList = 'Project Overview:\n';
            projectList += '='.repeat(50) + '\n\n';
            
            projects.forEach((project, index) => {
                const created = new Date(project.created).toLocaleDateString();
                const modified = project.lastModified ? new Date(project.lastModified).toLocaleDateString() : 'Never';
                const hasNotes = project.notes && project.notes.trim().length > 0;
                const notePreview = hasNotes ? project.notes.substring(0, 50) + (project.notes.length > 50 ? '...' : '') : 'No notes';
                
                projectList += `${index + 1}. ${project.name}\n`;
                projectList += `   📅 Created: ${created}\n`;
                projectList += `   🔄 Modified: ${modified}\n`;
                projectList += `   📏 Data: ${project.boards.length} boards, ${project.cuts.length} cuts, ${project.history.length} calculations\n`;
                projectList += `   📝 Notes: ${notePreview}\n\n`;
            });
            
            projectList += 'Commands:\n';
            projectList += '• Enter project number (1-' + projects.length + ') to load\n';
            projectList += '• "delete X" to delete project X\n';
            projectList += '• "export X" to export project X data\n';
            
            const action = prompt(projectList);
            
            if (action) {
                if (action.toLowerCase().startsWith('delete ')) {
                    const projectNum = parseInt(action.split(' ')[1]) - 1;
                    if (projectNum >= 0 && projectNum < projects.length) {
                        deleteProject(projects[projectNum].id);
                    }
                } else if (action.toLowerCase().startsWith('export ')) {
                    const projectNum = parseInt(action.split(' ')[1]) - 1;
                    if (projectNum >= 0 && projectNum < projects.length) {
                        exportProjectData(projects[projectNum]);
                    }
                } else {
                    const projectNum = parseInt(action) - 1;
                    if (projectNum >= 0 && projectNum < projects.length) {
                        loadProject(projects[projectNum].id);
                        updateProjectSelector();
                    }
                }
            }
        }
        
        function exportProjectData(project) {
            const date = new Date().toLocaleDateString();
            
            let exportText = `${project.name} - Complete Project Data\n`;
            exportText += `Exported: ${date}\n`;
            exportText += `Created: ${new Date(project.created).toLocaleDateString()}\n`;
            exportText += `Last Modified: ${project.lastModified ? new Date(project.lastModified).toLocaleDateString() : 'Never'}\n\n`;
            
            // Project Notes
            if (project.notes && project.notes.trim()) {
                exportText += 'PROJECT NOTES:\n';
                exportText += '='.repeat(30) + '\n';
                exportText += project.notes + '\n\n';
            }
            
            // Boards Data
            if (project.boards && project.boards.length > 0) {
                exportText += 'AVAILABLE BOARDS:\n';
                exportText += '='.repeat(30) + '\n';
                project.boards.forEach((board, index) => {
                    exportText += `${index + 1}. Length: ${inchesToDisplay(board.length, 'opt')}, Quantity: ${board.quantity}\n`;
                });
                exportText += '\n';
            }
            
            // Cuts Data
            if (project.cuts && project.cuts.length > 0) {
                exportText += 'NEEDED CUTS:\n';
                exportText += '='.repeat(30) + '\n';
                project.cuts.forEach((cut, index) => {
                    exportText += `${index + 1}. Length: ${inchesToDisplay(cut.length, 'opt')}\n`;
                });
                exportText += '\n';
            }
            
            // Calculator History
            if (project.history && project.history.length > 0) {
                exportText += 'CALCULATOR HISTORY:\n';
                exportText += '='.repeat(30) + '\n';
                project.history.forEach((entry, index) => {
                    exportText += `${index + 1}. ${entry}\n`;
                });
                exportText += '\n';
            }
            
            // Cut Calculator History
            if (project.cutHistory && project.cutHistory.length > 0) {
                exportText += 'CUT CALCULATOR HISTORY:\n';
                exportText += '='.repeat(30) + '\n';
                project.cutHistory.forEach((entry, index) => {
                    exportText += `${index + 1}. ${entry}\n`;
                });
                exportText += '\n';
            }
            
            // Calculator State
            if (project.calculatorData) {
                exportText += 'CALCULATOR STATE:\n';
                exportText += '='.repeat(30) + '\n';
                exportText += `Current Value: ${inchesToDisplay(project.calculatorData.currentValueInches || 0, 'calculator')}\n`;
                exportText += `Memory Value: ${inchesToDisplay(project.calculatorData.memoryValue || 0, 'calculator')}\n`;
                exportText += `Input Mode: ${project.calculatorData.inputMode || 'fraction'}\n\n`;
            }
            
            // Create downloadable file
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${project.name.replace(/[^a-zA-Z0-9]/g, '_')}_complete_data.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification(`Project "${project.name}" data exported!`, 'success');
        }
        
        function showProjectNotes() {
            if (!currentProject) {
                showNotification('Please create or select a project first', 'warning');
                return;
            }
            
            const modal = document.getElementById('notesModal');
            const projectName = document.getElementById('notesProjectName');
            const notesText = document.getElementById('projectNotesText');
            
            if (modal && projectName && notesText) {
                projectName.textContent = currentProject.name;
                notesText.value = currentProject.notes || '';
                modal.style.display = 'block';
                notesText.focus();
            }
        }
        
        function closeProjectNotes() {
            const modal = document.getElementById('notesModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        function saveProjectNotes() {
            if (!currentProject) {
                showNotification('No active project to save notes to', 'error');
                return;
            }
            
            const notesText = document.getElementById('projectNotesText');
            if (notesText) {
                currentProject.notes = notesText.value;
                saveCurrentProject();
                closeProjectNotes();
                showNotification('Project notes saved!', 'success');
            }
        }
        
        function showProjectTemplates() {
            const templates = getProjectTemplates();
            
            let templateList = 'Project Templates:\n';
            templateList += '='.repeat(40) + '\n\n';
            
            templates.forEach((template, index) => {
                templateList += `${index + 1}. ${template.name}\n`;
                templateList += `   📏 ${template.boards.length} boards, ${template.cuts.length} cuts\n`;
                templateList += `   📝 ${template.description}\n\n`;
            });
            
            const choice = prompt(templateList + 'Enter template number to create project:');
            
            if (choice) {
                const templateIndex = parseInt(choice) - 1;
                if (templateIndex >= 0 && templateIndex < templates.length) {
                    createProjectFromTemplate(templates[templateIndex]);
                }
            }
        }
        
        function getProjectTemplates() {
            return [
                {
                    name: "Basic Bookshelf",
                    description: "5-shelf bookshelf using 1x8 boards",
                    boards: [
                        { length: 96, quantity: 3 },  // 8ft 1x8 boards
                        { length: 48, quantity: 2 }   // 4ft 1x8 boards
                    ],
                    cuts: [
                        { length: 30, id: 1 }, { length: 30, id: 2 }, { length: 30, id: 3 }, 
                        { length: 30, id: 4 }, { length: 30, id: 5 }, // 5 shelves
                        { length: 36, id: 6 }, { length: 36, id: 7 }  // 2 sides
                    ],
                    notes: "Basic 5-shelf bookshelf:\n- Shelves: 30\" wide\n- Height: 36\"\n- Use 1x8 pine boards\n- Consider adding back panel\n- Sand all pieces before assembly"
                },
                {
                    name: "Coffee Table",
                    description: "Simple coffee table with lower shelf",
                    boards: [
                        { length: 96, quantity: 2 },  // 8ft boards
                        { length: 48, quantity: 1 }   // 4ft board
                    ],
                    cuts: [
                        { length: 48, id: 1 }, { length: 24, id: 2 }, // Top and shelf
                        { length: 16, id: 3 }, { length: 16, id: 4 }, 
                        { length: 16, id: 5 }, { length: 16, id: 6 }  // 4 legs
                    ],
                    notes: "Coffee table project:\n- Top: 48\" x 24\"\n- Height: 16\"\n- Add lower shelf for storage\n- Use 2x4 for legs, 1x6 for top\n- Consider staining or painting"
                },
                {
                    name: "Garden Planter Box",
                    description: "Raised garden bed planter",
                    boards: [
                        { length: 96, quantity: 2 },  // 8ft cedar boards
                        { length: 48, quantity: 2 }   // 4ft cedar boards
                    ],
                    cuts: [
                        { length: 48, id: 1 }, { length: 48, id: 2 }, // Long sides
                        { length: 24, id: 3 }, { length: 24, id: 4 }, // Short sides
                        { length: 22.5, id: 5 }, { length: 22.5, id: 6 }, 
                        { length: 22.5, id: 7 }, { length: 22.5, id: 8 } // Bottom slats
                    ],
                    notes: "Garden planter box:\n- Size: 48\" x 24\" x 8\" deep\n- Use cedar for weather resistance\n- Drill drainage holes in bottom\n- Use galvanized screws\n- No treatment needed for cedar"
                },
                {
                    name: "Simple Workbench",
                    description: "Basic workbench with storage shelf",
                    boards: [
                        { length: 96, quantity: 4 },  // 8ft 2x4s
                        { length: 96, quantity: 2 }   // 8ft 2x8s for top
                    ],
                    cuts: [
                        { length: 60, id: 1 }, { length: 60, id: 2 }, // Top pieces
                        { length: 30, id: 3 }, { length: 30, id: 4 }, 
                        { length: 30, id: 5 }, { length: 30, id: 6 }, // 4 legs
                        { length: 54, id: 7 }, { length: 54, id: 8 }, // Long supports
                        { length: 18, id: 9 }, { length: 18, id: 10 } // Short supports
                    ],
                    notes: "Workbench project:\n- Top: 60\" x 16\"\n- Height: 30\"\n- Laminated 2x8 top for strength\n- Add shelf between legs\n- Use pocket screws for assembly\n- Consider adding vise mount"
                }
            ];
        }
        
        function createProjectFromTemplate(template) {
            const name = prompt(`Create project from "${template.name}" template:\nEnter project name:`, template.name);
            
            if (name && name.trim()) {
                // Clear existing data
                boards = [...template.boards];
                cuts = [...template.cuts];
                history = [];
                cutHistory = [];
                currentValueInches = 0;
                cutValueInches = 0;
                currentOperation = null;
                operationValue = 0;
                memoryValue = 0;
                value1 = 0;
                value2 = 0;
                
                const project = {
                    id: Date.now(),
                    name: name.trim(),
                    created: new Date().toISOString(),
                    boards: [...boards],
                    cuts: [...cuts],
                    history: [...history],
                    cutHistory: [...cutHistory],
                    calculatorData: {
                        currentValueInches: 0,
                        cutValueInches: 0,
                        currentOperation: null,
                        operationValue: 0,
                        memoryValue: 0,
                        value1: 0,
                        value2: 0,
                        inputMode: 'fraction'
                    },
                    notes: template.notes,
                    tags: ['template']
                };
                
                projects.push(project);
                currentProject = project;
                saveToLocalStorage();
                
                // Update displays
                updateProjectSelector();
                updateBoardDisplay();
                updateCutDisplay();
                
                showNotification(`Project "${name}" created from template!`, 'success');
            }
        }
        
        // Projects Tab Functions
        function renderProjectsTab() {
            renderCurrentProjectCard();
            renderProjectsGrid();
        }
        
        function renderCurrentProjectCard() {
            const card = document.getElementById('currentProjectCard');
            if (!card) return;
            
            if (!currentProject) {
                card.innerHTML = `
                    <div class="project-card-content">
                        <div class="project-header">
                            <h4>No Active Project</h4>
                            <div class="project-actions">
                                <button class="btn btn-sm btn-secondary" onclick="showProjectNotes()" title="Edit Notes" disabled>📝</button>
                                <button class="btn btn-sm btn-success" onclick="saveCurrentProject()" title="Save Project" disabled>💾</button>
                            </div>
                        </div>
                        <div class="project-stats">
                            <span class="stat">📏 0 boards</span>
                            <span class="stat">✂️ 0 cuts</span>
                            <span class="stat">🧮 0 calculations</span>
                        </div>
                        <div class="project-preview">
                            <div class="preview-message">Select or create a project to get started</div>
                        </div>
                    </div>
                `;
                return;
            }
            
            const boardCount = currentProject.boards ? currentProject.boards.length : 0;
            const cutCount = currentProject.cuts ? currentProject.cuts.length : 0;
            const calcCount = currentProject.history ? currentProject.history.length : 0;
            const hasNotes = currentProject.notes && currentProject.notes.trim().length > 0;
            
            let previewHtml = '';
            if (boardCount > 0) {
                previewHtml = '<div class="project-preview-boards">';
                currentProject.boards.slice(0, 5).forEach(board => {
                    previewHtml += `<div class="preview-board">${inchesToDisplay(board.length, 'opt')} x${board.quantity}</div>`;
                });
                if (boardCount > 5) previewHtml += `<div class="preview-board">+${boardCount - 5} more</div>`;
                previewHtml += '</div>';
            }
            
            if (hasNotes) {
                previewHtml += `<div class="project-notes-preview">${currentProject.notes.substring(0, 100)}${currentProject.notes.length > 100 ? '...' : ''}</div>`;
            }
            
            if (!previewHtml) {
                previewHtml = '<div class="preview-message">Add boards and cuts to see preview</div>';
            }
            
            card.innerHTML = `
                <div class="project-card-content">
                    <div class="project-header">
                        <h4>${currentProject.name}</h4>
                        <div class="project-actions">
                            <button class="btn btn-sm btn-secondary" onclick="showProjectNotes()" title="Edit Notes">📝</button>
                            <button class="btn btn-sm btn-success" onclick="saveCurrentProject()" title="Save Project">💾</button>
                        </div>
                    </div>
                    <div class="project-stats">
                        <span class="stat">📏 ${boardCount} boards</span>
                        <span class="stat">✂️ ${cutCount} cuts</span>
                        <span class="stat">🧮 ${calcCount} calculations</span>
                        ${hasNotes ? '<span class="stat">📝 Has notes</span>' : ''}
                    </div>
                    <div class="project-preview">
                        ${previewHtml}
                    </div>
                    <div class="project-date">
                        Last modified: ${currentProject.lastModified ? new Date(currentProject.lastModified).toLocaleDateString() : 'Never'}
                    </div>
                </div>
            `;
        }
        
        function renderProjectsGrid() {
            const grid = document.getElementById('projectsGrid');
            const noProjectsMsg = document.getElementById('noProjectsMessage');
            
            if (!grid || !noProjectsMsg) return;
            
            if (projects.length === 0) {
                grid.style.display = 'none';
                noProjectsMsg.style.display = 'block';
                return;
            }
            
            grid.style.display = 'grid';
            noProjectsMsg.style.display = 'none';
            
            grid.innerHTML = projects.map(project => {
                const boardCount = project.boards ? project.boards.length : 0;
                const cutCount = project.cuts ? project.cuts.length : 0;
                const calcCount = project.history ? project.history.length : 0;
                const hasNotes = project.notes && project.notes.trim().length > 0;
                const isActive = currentProject && currentProject.id === project.id;
                const created = new Date(project.created).toLocaleDateString();
                const modified = project.lastModified ? new Date(project.lastModified).toLocaleDateString() : 'Never';
                
                let previewHtml = '';
                if (boardCount > 0) {
                    previewHtml = '<div class="project-preview-boards">';
                    project.boards.slice(0, 4).forEach(board => {
                        previewHtml += `<div class="preview-board">${inchesToDisplay(board.length, 'opt')} x${board.quantity}</div>`;
                    });
                    if (boardCount > 4) previewHtml += `<div class="preview-board">+${boardCount - 4}</div>`;
                    previewHtml += '</div>';
                }
                
                if (hasNotes) {
                    previewHtml += `<div class="project-notes-preview">${project.notes.substring(0, 80)}${project.notes.length > 80 ? '...' : ''}</div>`;
                }
                
                if (!previewHtml) {
                    previewHtml = '<div class="preview-message">Empty project</div>';
                }
                
                return `
                    <div class="project-card ${isActive ? 'current-project' : ''}" onclick="loadProjectFromCard(${project.id})">
                        <div class="project-card-content">
                            <div class="project-header">
                                <h4>${project.name} ${isActive ? '(Active)' : ''}</h4>
                                <div class="project-actions" onclick="event.stopPropagation()">
                                    <button class="btn btn-sm btn-secondary" onclick="duplicateProject(${project.id})" title="Duplicate">📋</button>
                                    <button class="btn btn-sm btn-secondary" onclick="exportProjectData(projects.find(p => p.id === ${project.id}))" title="Export">📤</button>
                                    <button class="btn btn-sm btn-warning" onclick="deleteProject(${project.id})" title="Delete">🗑️</button>
                                </div>
                            </div>
                            <div class="project-stats">
                                <span class="stat">📏 ${boardCount} boards</span>
                                <span class="stat">✂️ ${cutCount} cuts</span>
                                <span class="stat">🧮 ${calcCount} calcs</span>
                                ${hasNotes ? '<span class="stat">📝 Notes</span>' : ''}
                            </div>
                            <div class="project-preview">
                                ${previewHtml}
                            </div>
                            <div class="project-date">
                                Created: ${created} | Modified: ${modified}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function loadProjectFromCard(projectId) {
            loadProject(projectId);
            updateProjectSelector();
            renderProjectsTab();
            
            // Switch to a useful tab for continuing work
            if (currentProject && (currentProject.boards.length > 0 || currentProject.cuts.length > 0)) {
                switchTab('optimizer');
            } else {
                switchTab('calculator');
            }
        }
        
        function duplicateProject(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            const newName = prompt(`Duplicate "${project.name}":\nEnter new project name:`, `${project.name} (Copy)`);
            if (!newName || !newName.trim()) return;
            
            const newProject = {
                ...project,
                id: Date.now(),
                name: newName.trim(),
                created: new Date().toISOString(),
                lastModified: null
            };
            
            projects.push(newProject);
            saveToLocalStorage();
            renderProjectsTab();
            updateProjectSelector();
            
            showNotification(`Project "${newName}" created!`, 'success');
        }
        
        function exportAllProjects() {
            if (projects.length === 0) {
                showNotification('No projects to export', 'warning');
                return;
            }
            
            const exportData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                projects: projects
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `woodworking_projects_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification(`${projects.length} projects exported!`, 'success');
        }
        
        function importProjects() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importData = JSON.parse(e.target.result);
                        
                        if (!importData.projects || !Array.isArray(importData.projects)) {
                            showNotification('Invalid project file format', 'error');
                            return;
                        }
                        
                        let importedCount = 0;
                        importData.projects.forEach(project => {
                            // Assign new ID to avoid conflicts
                            project.id = Date.now() + importedCount;
                            project.name = `${project.name} (Imported)`;
                            projects.push(project);
                            importedCount++;
                        });
                        
                        saveToLocalStorage();
                        renderProjectsTab();
                        updateProjectSelector();
                        
                        showNotification(`${importedCount} projects imported!`, 'success');
                    } catch (error) {
                        showNotification('Error reading project file', 'error');
                        console.error('Import error:', error);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        // Update project status bars across all tabs
        function updateProjectStatusBars() {
            const statusBars = [
                { id: 'calcProjectStatus', name: 'Calculator' },
                { id: 'cutProjectStatus', name: 'Cut Calculator' },
                { id: 'optProjectStatus', name: 'Waste Optimizer' }
            ];
            
            statusBars.forEach(bar => {
                const element = document.getElementById(bar.id);
                if (!element) return;
                
                const statusText = element.querySelector('.status-text');
                if (!statusText) return;
                
                if (currentProject) {
                    statusText.textContent = `📁 ${currentProject.name}`;
                    element.classList.add('active');
                } else {
                    statusText.textContent = `No active project`;
                    element.classList.remove('active');
                }
            });
        }
        
        // Auto-save functionality
        function autoSave() {
            if (currentProject) {
                saveCurrentProject();
            } else {
                saveToLocalStorage();
            }
        }
        
        // Set up auto-save every 30 seconds
        setInterval(autoSave, 30000);
        
        // Notification system to replace alerts
        function showNotification(message, type = 'error') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification show';
            if (type === 'success') notification.classList.add('success');
            else if (type === 'warning') notification.classList.add('warning');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Initialize fraction selectors with proper fraction display
        function updatePrecision(tabName = null) {
            let precision = 16;
            let fractionSelects = [];
            
            if (tabName === 'calculator' || !tabName) {
                precision = parseInt(document.getElementById('precision')?.value || 16);
                fractionSelects = ['fraction1', 'fraction2'];
            } else if (tabName === 'cut') {
                precision = parseInt(document.getElementById('cutPrecision')?.value || 16);
                fractionSelects = ['cutFraction'];
            } else if (tabName === 'optimizer') {
                precision = parseInt(document.getElementById('optPrecision')?.value || 16);
                fractionSelects = ['boardFraction', 'optCutFraction'];
            } else if (tabName === 'edit') {
                // Special case for edit modal - use optimizer precision
                precision = parseInt(document.getElementById('optPrecision')?.value || 16);
                fractionSelects = ['editFraction'];
            }
            
            fractionSelects.forEach(id => {
                const select = document.getElementById(id);
                if (!select) return;
                
                const currentValue = select.value; // Store current value
                select.innerHTML = '<option value="0">0</option>';
                
                for (let i = 1; i < precision; i++) {
                    const decimal = i / precision;
                    let displayText;
                    
                    const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
                    const divisor = gcd(i, precision);
                    const simplifiedNumerator = i / divisor;
                    const simplifiedDenominator = precision / divisor;
                    
                    if (simplifiedDenominator === precision) {
                        displayText = `${i}/${precision}`;
                    } else {
                        displayText = `${simplifiedNumerator}/${simplifiedDenominator} (${i}/${precision})`;
                    }
                    
                    select.innerHTML += `<option value="${decimal}">${displayText}</option>`;
                }
                
                // Restore value if it still exists
                if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
                    select.value = currentValue;
                }
            });
            
            // Update calculator second input if it exists
            if (tabName === 'calculator') {
                const fraction2 = document.getElementById('fraction2');
                if (fraction2) {
                    const currentValue = fraction2.value;
                    fraction2.innerHTML = '<option value="0">0</option>';
                    for (let i = 1; i < precision; i++) {
                        const decimal = i / precision;
                        const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
                        const divisor = gcd(i, precision);
                        const simplifiedNumerator = i / divisor;
                        const simplifiedDenominator = precision / divisor;
                        
                        let displayText;
                        if (simplifiedDenominator === precision) {
                            displayText = `${i}/${precision}`;
                        } else {
                            displayText = `${simplifiedNumerator}/${simplifiedDenominator} (${i}/${precision})`;
                        }
                        
                        fraction2.innerHTML += `<option value="${decimal}">${displayText}</option>`;
                    }
                    if (currentValue && Array.from(fraction2.options).some(opt => opt.value === currentValue)) {
                        fraction2.value = currentValue;
                    }
                }
            }
        }
        
        // Convert inches to feet/inches/fraction display
        function inchesToDisplay(totalInches, useTab = 'calculator') {
            let precision = 16;
            if (useTab === 'cut') {
                precision = parseInt(document.getElementById('cutPrecision')?.value || 16);
            } else if (useTab === 'opt') {
                precision = parseInt(document.getElementById('optPrecision')?.value || 16);
            } else {
                precision = parseInt(document.getElementById('precision')?.value || 16);
            }
            
            const roundedInches = Math.round(totalInches * precision) / precision;
            const feet = Math.floor(roundedInches / 12);
            const remainingInches = roundedInches - (feet * 12);
            const wholeInches = Math.floor(remainingInches);
            const fractionDecimal = remainingInches - wholeInches;
            
            let display = '';
            if (feet > 0) {
                display += feet + "'";
                if (wholeInches > 0 || fractionDecimal > 0) {
                    display += ' ';
                } else {
                    // Clean foot measurement - add 0"
                    display += ' 0"';
                    return display;
                }
            }
            
            if (wholeInches > 0 || (feet === 0 && fractionDecimal === 0)) {
                display += wholeInches;
                if (fractionDecimal > 0) {
                    display += ' ';
                }
            }
            
            if (fractionDecimal > 0) {
                const numerator = Math.round(fractionDecimal * precision);
                const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
                const divisor = gcd(numerator, precision);
                display += (numerator / divisor) + '/' + (precision / divisor);
            }
            
            if (display === '') display = '0';
            display += '"';
            
            return display;
        }
        
        // Convert inches to feet, inches, and fraction parts
        function inchesToParts(totalInches) {
            const feet = Math.floor(totalInches / 12);
            const remainingInches = totalInches - (feet * 12);
            const wholeInches = Math.floor(remainingInches);
            const fractionDecimal = remainingInches - wholeInches;
            
            return {
                feet: feet,
                inches: wholeInches,
                fraction: fractionDecimal
            };
        }
        
        // Get total inches from inputs
        function getInputInches(feetId, inchesId, fractionId) {
            const feet = parseFloat(document.getElementById(feetId)?.value) || 0;
            const inches = parseFloat(document.getElementById(inchesId)?.value) || 0;
            const fraction = parseFloat(document.getElementById(fractionId)?.value) || 0;
            return (feet * 12) + inches + fraction;
        }
        
        function setCurrentValue() {
            currentValueInches = getInputInches('feet', 'inches', 'fraction');
            document.getElementById('currentValue').textContent = inchesToDisplay(currentValueInches);
        }
        
        // New calculator functions
        function setOperation(op) {
            currentOperation = op;
            
            // Hide both input groups first
            document.getElementById('input2GroupFeetInches').style.display = 'none';
            document.getElementById('input2GroupNumber').style.display = 'none';
            
            // Show appropriate input group based on operation
            if (op === '+' || op === '-') {
                // Addition and subtraction use feet/inches input
                document.getElementById('input2GroupFeetInches').style.display = 'flex';
            } else if (op === '*' || op === '/') {
                // Multiplication and division use simple number input
                document.getElementById('input2GroupNumber').style.display = 'flex';
                // Set default factor if empty
                const factorInput = document.getElementById('factor');
                if (!factorInput.value) {
                    factorInput.value = op === '*' ? '2' : '2';
                }
            }
            
            // Update button highlighting
            document.querySelectorAll('.calc-btn.operation').forEach(btn => btn.classList.remove('active'));
            const btnMap = {'+': 'addBtn', '-': 'subBtn', '*': 'mulBtn', '/': 'divBtn'};
            const activeBtn = document.getElementById(btnMap[op]);
            if (activeBtn) activeBtn.classList.add('active');
            
            updateCalculation();
        }
        
        function updateCalculation() {
            value1 = getInputInches('feet1', 'inches1', 'fraction1');
            
            // Get value2 based on operation type
            if (currentOperation === '+' || currentOperation === '-') {
                // For addition/subtraction, use feet/inches input
                value2 = getInputInches('feet2', 'inches2', 'fraction2');
            } else if (currentOperation === '*' || currentOperation === '/') {
                // For multiplication/division, use simple number factor
                const factorInput = document.getElementById('factor');
                value2 = parseFloat(factorInput.value) || 0;
            }
            
            const equation = document.getElementById('calcEquation');
            const result = document.getElementById('calcResult');
            
            if (value1 > 0) {
                let equationText = inchesToDisplay(value1);
                
                if (currentOperation) {
                    equationText += ` ${currentOperation} `;
                    if (value2 > 0) {
                        // Show appropriate format for equation
                        if (currentOperation === '+' || currentOperation === '-') {
                            equationText += inchesToDisplay(value2);
                        } else {
                            equationText += value2.toString();
                        }
                        
                        // Auto-calculate if we have both values
                        let calcResult = 0;
                        switch (currentOperation) {
                            case '+': calcResult = value1 + value2; break;
                            case '-': calcResult = value1 - value2; break;
                            case '*': calcResult = value1 * value2; break;
                            case '/': calcResult = value2 !== 0 ? value1 / value2 : 0; break;
                        }
                        
                        if (calcResult !== 0) {
                            result.textContent = inchesToDisplay(calcResult);
                            result.classList.add('has-value');
                            currentValueInches = calcResult; // Update current value
                        }
                    }
                }
                equation.textContent = equationText;
            } else {
                equation.innerHTML = '&nbsp;';
                result.textContent = '0"';
                result.classList.remove('has-value');
            }
            
            // Update conversion preview
            updateConversionPreview();
        }
        
        function calculateResult() {
            // No longer needed - replaced by saveToHistory
        }
        
        function saveToHistory() {
            if (!currentOperation || value1 === 0) {
                if (value1 > 0) {
                    // Just save the current value
                    addToCalcHistory({
                        equation: inchesToDisplay(value1),
                        result: value1,
                        timestamp: new Date().toLocaleTimeString(),
                        type: 'value'
                    });
                }
                return;
            }
            
            let result = 0;
            switch (currentOperation) {
                case '+': result = value1 + value2; break;
                case '-': result = value1 - value2; break;
                case '*': result = value1 * value2; break;
                case '/': 
                    if (value2 === 0) {
                        showNotification('Cannot divide by zero');
                        return;
                    }
                    result = value1 / value2;
                    break;
            }
            
            const timestamp = new Date().toLocaleTimeString();
            const historyEntry = {
                equation: `${inchesToDisplay(value1)} ${currentOperation} ${inchesToDisplay(value2)} = ${inchesToDisplay(result)}`,
                result: result,
                timestamp: timestamp,
                type: 'calculation'
            };
            
            addToCalcHistory(historyEntry);
            
            // Set result as new value1 for chaining calculations
            const parts = inchesToParts(result);
            document.getElementById('feet1').value = parts.feet || '';
            document.getElementById('inches1').value = parts.inches || '';
            document.getElementById('fraction1').value = parts.fraction || 0;
            
            // Clear second input
            clearInput2();
            currentOperation = null;
            document.getElementById('input2Group').style.display = 'none';
            document.querySelectorAll('.calc-btn.operation').forEach(btn => btn.classList.remove('active'));
            
            updateCalculation();
        }
        
        function clearCalculator() {
            document.getElementById('feet1').value = '';
            document.getElementById('inches1').value = '';
            document.getElementById('fraction1').value = '0';
            clearInput2();
            currentOperation = null;
            value1 = 0;
            value2 = 0;
            // Hide both input groups
            document.getElementById('input2GroupFeetInches').style.display = 'none';
            document.getElementById('input2GroupNumber').style.display = 'none';
            document.querySelectorAll('.calc-btn.operation').forEach(btn => btn.classList.remove('active'));
            updateCalculation();
            updateConversionPreview();
        }
        
        function clearInput2() {
            // Clear feet/inches inputs
            document.getElementById('feet2').value = '';
            document.getElementById('inches2').value = '';
            document.getElementById('fraction2').value = '0';
            // Clear factor input
            document.getElementById('factor').value = '';
        }
        
        function memoryOperation(op) {
            const currentResult = value1 || 0;
            
            switch(op) {
                case 'MC': // Memory Clear
                    memoryValue = 0;
                    break;
                case 'MR': // Memory Recall
                    if (memoryValue !== 0) {
                        const parts = inchesToParts(memoryValue);
                        document.getElementById('feet1').value = parts.feet || '';
                        document.getElementById('inches1').value = parts.inches || '';
                        document.getElementById('fraction1').value = parts.fraction || 0;
                        updateCalculation();
                    }
                    break;
                case 'M+': // Memory Add
                    memoryValue += currentResult;
                    break;
                case 'M-': // Memory Subtract
                    memoryValue -= currentResult;
                    break;
            }
            
            // Update memory indicator
            const indicator = document.getElementById('memoryIndicator');
            if (memoryValue !== 0) {
                indicator.textContent = `M: ${inchesToDisplay(memoryValue)}`;
            } else {
                indicator.textContent = '';
            }
        }
        
        function addToCalcHistory(entry) {
            const historyDiv = document.getElementById('history');
            if (!historyDiv) return;
            
            const historyItem = document.createElement('div');
            
            // Style based on type
            if (entry.type === 'conversion') {
                historyItem.className = 'history-conversion history-clickable';
                historyItem.innerHTML = `
                    <div class="history-label">Conversion</div>
                    <div class="history-equation">${entry.equation}</div>
                    <span class="history-timestamp">${entry.timestamp}</span>
                `;
            } else if (entry.type === 'preset') {
                historyItem.className = 'history-preset';
                historyItem.innerHTML = `
                    <div class="history-label">${entry.label || 'Calculation'}</div>
                    <div class="history-equation">${entry.equation}</div>
                    <span class="history-timestamp">${entry.timestamp}</span>
                `;
            } else {
                historyItem.className = 'history-result history-clickable';
                historyItem.innerHTML = `
                    <div class="history-equation">${entry.equation}</div>
                    <span class="history-timestamp">${entry.timestamp}</span>
                `;
            }
            
            // Make clickable if it has a result
            if (entry.result !== undefined) {
                historyItem.onclick = () => {
                    const parts = inchesToParts(entry.result);
                    document.getElementById('feet1').value = parts.feet || '';
                    document.getElementById('inches1').value = parts.inches || '';
                    document.getElementById('fraction1').value = parts.fraction || 0;
                    updateCalculation();
                };
            }
            
            historyDiv.insertBefore(historyItem, historyDiv.firstChild);
            
            // Keep only last 15 entries
            while (historyDiv.children.length > 15) {
                historyDiv.removeChild(historyDiv.lastChild);
            }
        }
        
        // Conversion functions - now work on the current calculator result
        function convertToDecimal() {
            const inches = getCurrentCalculatorValue();
            if (inches === 0) {
                showNotification('No result to convert. Perform a calculation first.', 'warning');
                return;
            }
            const decimal = inches.toFixed(4);
            addToCalcHistory({
                equation: `${inchesToDisplay(inches)} → ${decimal}"`,
                result: inches,
                timestamp: new Date().toLocaleTimeString(),
                type: 'conversion'
            });
            showNotification(`Decimal: ${decimal}"`, 'success');
        }
        
        function convertToFraction() {
            const inches = getCurrentCalculatorValue();
            if (inches === 0) {
                showNotification('No result to convert. Perform a calculation first.', 'warning');
                return;
            }
            const fraction = inchesToDisplay(inches);
            addToCalcHistory({
                equation: `${inches.toFixed(4)}" → ${fraction}`,
                result: inches,
                timestamp: new Date().toLocaleTimeString(),
                type: 'conversion'
            });
            showNotification(`Fraction: ${fraction}`, 'success');
        }
        
        function convertToFeet() {
            const inches = getCurrentCalculatorValue();
            if (inches === 0) {
                showNotification('No result to convert. Perform a calculation first.', 'warning');
                return;
            }
            const feet = (inches / 12).toFixed(4);
            addToCalcHistory({
                equation: `${inchesToDisplay(inches)} → ${feet} ft`,
                result: inches,
                timestamp: new Date().toLocaleTimeString(),
                type: 'conversion'
            });
            showNotification(`Decimal Feet: ${feet} ft`, 'success');
        }
        
        function convertToInches() {
            const inches = getCurrentCalculatorValue();
            if (inches === 0) {
                showNotification('No result to convert. Perform a calculation first.', 'warning');
                return;
            }
            const totalInches = inches.toFixed(4);
            addToCalcHistory({
                equation: `${inchesToDisplay(inches)} → ${totalInches}"`,
                result: inches,
                timestamp: new Date().toLocaleTimeString(),
                type: 'conversion'
            });
            showNotification(`Total Inches: ${totalInches}"`, 'success');
        }
        
        // Helper function to get the current calculator value (result or input)
        function getCurrentCalculatorValue() {
            // If there's a calculated result, use that
            if (currentValueInches > 0) {
                return currentValueInches;
            }
            // Otherwise, use input 1 if it has a value
            if (value1 > 0) {
                return value1;
            }
            // No value available
            return 0;
        }
        
        // Update the conversion preview to show what value will be converted
        function updateConversionPreview() {
            const conversionValueSpan = document.getElementById('conversionValue');
            if (!conversionValueSpan) return;
            
            const inches = getCurrentCalculatorValue();
            if (inches > 0) {
                conversionValueSpan.textContent = inchesToDisplay(inches);
                conversionValueSpan.parentElement.style.opacity = '1';
            } else {
                conversionValueSpan.textContent = 'Enter a value or calculate';
                conversionValueSpan.parentElement.style.opacity = '0.7';
            }
        }
        
        // Preset calculations with modal
        let currentModalCalc = null;
        
        function showBoardFootCalc() {
            currentModalCalc = 'boardfoot';
            const modal = document.getElementById('calcModal');
            const title = document.getElementById('calcModalTitle');
            const inputs = document.getElementById('calcModalInputs');
            
            title.textContent = 'Lumber Shopping Cart';
            inputs.innerHTML = `
                <div class="input-group">
                    <label>Thickness (inches):</label>
                    <input type="number" id="modalThickness" step="0.25" class="wide-input" placeholder="1">
                </div>
                <div class="input-group">
                    <label>Width (inches):</label>
                    <input type="number" id="modalWidth" step="0.25" class="wide-input" placeholder="6">
                </div>
                <div class="input-group">
                    <label>Length (feet):</label>
                    <input type="number" id="modalLength" step="0.5" class="wide-input" placeholder="8">
                </div>
            `;
            
            modal.style.display = 'block';
        }
        
        function calculateGoldenRatio() {
            const inches = value1 || 0;
            if (inches === 0) {
                showNotification('Enter a value first');
                return;
            }
            
            const golden = 1.618033988749895;
            const result = inches * golden;
            
            addToCalcHistory({
                equation: `${inchesToDisplay(inches)} × φ (1.618) = ${inchesToDisplay(result)}`,
                result: result,
                timestamp: new Date().toLocaleTimeString(),
                type: 'preset',
                label: 'Golden Ratio'
            });
            
            // Set result as new value1
            const parts = inchesToParts(result);
            document.getElementById('feet1').value = parts.feet || '';
            document.getElementById('inches1').value = parts.inches || '';
            document.getElementById('fraction1').value = parts.fraction || 0;
            updateCalculation();
        }
        
        function showSpacingCalc() {
            const totalLength = value1 || 0;
            if (totalLength === 0) {
                showNotification('Enter total length first');
                return;
            }
            
            currentModalCalc = 'spacing';
            const modal = document.getElementById('calcModal');
            const title = document.getElementById('calcModalTitle');
            const inputs = document.getElementById('calcModalInputs');
            
            title.textContent = 'Shelf & Division Calculator';
            inputs.innerHTML = `
                <div style="margin-bottom: 10px;">Total length: <strong>${inchesToDisplay(totalLength)}</strong></div>
                <div class="input-group">
                    <label>Number of spaces:</label>
                    <input type="number" id="modalSpaces" min="2" class="wide-input" placeholder="4">
                </div>
            `;
            
            modal.style.display = 'block';
        }
        
        function showAngleCalc() {
            currentModalCalc = 'angle';
            const modal = document.getElementById('calcModal');
            const title = document.getElementById('calcModalTitle');
            const inputs = document.getElementById('calcModalInputs');
            
            title.textContent = 'Miter & Angle Calculator';
            inputs.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <label style="font-weight: bold;">Calculator Type:</label>
                    <div style="margin-top: 10px;">
                        <label style="display: block; margin-bottom: 8px;">
                            <input type="radio" name="calcType" value="polygon" checked onchange="updateAngleCalcType()">
                            Polygon (equal-sided shape)
                        </label>
                        <label style="display: block;">
                            <input type="radio" name="calcType" value="single" onchange="updateAngleCalcType()">
                            Single angle cut
                        </label>
                    </div>
                </div>
                
                <div id="polygonInputs">
                    <div class="input-group">
                        <label>Number of sides:</label>
                        <input type="number" id="modalSides" min="3" class="wide-input" placeholder="8">
                    </div>
                    <p style="font-size: 12px; color: #666;">Examples: 4 = square, 6 = hexagon, 8 = octagon</p>
                </div>
                
                <div id="singleAngleInputs" style="display: none;">
                    <div class="input-group">
                        <label>Miter angle (degrees):</label>
                        <input type="number" id="modalAngle" step="0.5" class="wide-input" placeholder="45">
                    </div>
                    <div class="input-group">
                        <label>Board width:</label>
                        <input type="number" id="modalBoardWidth" step="0.0625" class="wide-input" placeholder="3.5">
                        <span>inches</span>
                    </div>
                    <div class="input-group">
                        <label>Known side:</label>
                        <select id="modalKnownSide" onchange="updateAngleLabels()">
                            <option value="long">Long side (back)</option>
                            <option value="short">Short side (front)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label id="knownLengthLabel">Long side length:</label>
                        <input type="number" id="modalKnownLength" step="0.0625" class="wide-input" placeholder="12">
                        <span>inches</span>
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                        <svg width="250" height="120" viewBox="0 0 250 120">
                            <!-- Board outline -->
                            <rect x="30" y="30" width="180" height="50" fill="#D2691E" stroke="#8B4513" stroke-width="2"/>
                            <!-- Miter cut line -->
                            <line x1="150" y1="30" x2="210" y2="80" stroke="#FFD700" stroke-width="3"/>
                            <line x1="152" y1="30" x2="212" y2="80" stroke="#000" stroke-width="1" stroke-dasharray="3,3"/>
                            <!-- Dimension lines -->
                            <line x1="30" y1="20" x2="150" y2="20" stroke="#333" stroke-width="1"/>
                            <line x1="30" y1="20" x2="30" y2="25" stroke="#333" stroke-width="1"/>
                            <line x1="150" y1="20" x2="150" y2="25" stroke="#333" stroke-width="1"/>
                            <line x1="30" y1="90" x2="210" y2="90" stroke="#333" stroke-width="1"/>
                            <line x1="30" y1="85" x2="30" y2="90" stroke="#333" stroke-width="1"/>
                            <line x1="210" y1="85" x2="210" y2="90" stroke="#333" stroke-width="1"/>
                            <!-- Width indicator -->
                            <line x1="220" y1="30" x2="220" y2="80" stroke="#666" stroke-width="1"/>
                            <line x1="215" y1="30" x2="220" y2="30" stroke="#666" stroke-width="1"/>
                            <line x1="215" y1="80" x2="220" y2="80" stroke="#666" stroke-width="1"/>
                            <!-- Labels -->
                            <text x="90" y="15" text-anchor="middle" font-size="11" fill="#333">Short (front)</text>
                            <text x="120" y="105" text-anchor="middle" font-size="11" fill="#333">Long (back)</text>
                            <text x="180" y="60" text-anchor="middle" font-size="10" fill="#000">Cut</text>
                            <text x="235" y="58" text-anchor="middle" font-size="9" fill="#666">Width</text>
                        </svg>
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
        }
        
        function updateAngleCalcType() {
            const calcType = document.querySelector('input[name="calcType"]:checked').value;
            document.getElementById('polygonInputs').style.display = calcType === 'polygon' ? 'block' : 'none';
            document.getElementById('singleAngleInputs').style.display = calcType === 'single' ? 'block' : 'none';
        }
        
        function updateAngleLabels() {
            const knownSide = document.getElementById('modalKnownSide').value;
            const label = document.getElementById('knownLengthLabel');
            label.textContent = knownSide === 'long' ? 'Long side length:' : 'Short side length:';
        }
        
        function closeCalcModal() {
            document.getElementById('calcModal').style.display = 'none';
            currentModalCalc = null;
        }
        
        function executeModalCalc() {
            if (currentModalCalc === 'boardfoot') {
                const thickness = parseFloat(document.getElementById('modalThickness')?.value) || 0;
                const width = parseFloat(document.getElementById('modalWidth')?.value) || 0;
                const length = parseFloat(document.getElementById('modalLength')?.value) || 0;
                
                if (thickness && width && length) {
                    const boardFeet = (thickness * width * length) / 12;
                    addToCalcHistory({
                        equation: `Board Feet: ${thickness}" × ${width}" × ${length}' = ${boardFeet.toFixed(2)} BF`,
                        result: boardFeet * 12, // Convert to inches for consistency
                        timestamp: new Date().toLocaleTimeString(),
                        type: 'preset',
                        label: 'Board Feet'
                    });
                    closeCalcModal();
                } else {
                    showNotification('Please fill in all fields');
                }
            } else if (currentModalCalc === 'spacing') {
                const spaces = parseInt(document.getElementById('modalSpaces')?.value) || 0;
                if (spaces > 0) {
                    const spacing = value1 / spaces;
                    addToCalcHistory({
                        equation: `${inchesToDisplay(value1)} ÷ ${spaces} spaces = ${inchesToDisplay(spacing)} each`,
                        result: spacing,
                        timestamp: new Date().toLocaleTimeString(),
                        type: 'preset',
                        label: 'Shelf & Division'
                    });
                    closeCalcModal();
                } else {
                    showNotification('Please enter number of spaces');
                }
            } else if (currentModalCalc === 'angle') {
                const calcType = document.querySelector('input[name="calcType"]:checked').value;
                
                if (calcType === 'polygon') {
                    const sides = parseInt(document.getElementById('modalSides')?.value) || 0;
                    if (sides > 2) {
                        const miterAngle = 180 / sides;
                        const sawAngle = 90 - miterAngle;
                        addToCalcHistory({
                            equation: `${sides}-sided: Miter ${miterAngle}°, Saw ${sawAngle}°`,
                            result: miterAngle,
                            timestamp: new Date().toLocaleTimeString(),
                            type: 'preset',
                            label: 'Polygon Angles'
                        });
                        closeCalcModal();
                    } else {
                        showNotification('Please enter valid number of sides');
                    }
                } else {
                    // Single angle calculation
                    const angle = parseFloat(document.getElementById('modalAngle')?.value) || 0;
                    const boardWidth = parseFloat(document.getElementById('modalBoardWidth')?.value) || 0;
                    const knownSide = document.getElementById('modalKnownSide').value;
                    const knownLength = parseFloat(document.getElementById('modalKnownLength')?.value) || 0;
                    
                    if (angle > 0 && angle < 90 && boardWidth > 0 && knownLength > 0) {
                        const angleRad = (angle * Math.PI) / 180;
                        let longSide, shortSide;
                        
                        // For a miter cut across a board:
                        // The difference between long and short sides = board width / tan(angle)
                        const difference = boardWidth / Math.tan(angleRad);
                        
                        if (knownSide === 'long') {
                            longSide = knownLength;
                            shortSide = longSide - difference;
                            
                            if (shortSide <= 0) {
                                showNotification('This cut would result in no material on the short side');
                                return;
                            }
                        } else {
                            shortSide = knownLength;
                            longSide = shortSide + difference;
                        }
                        
                        addToCalcHistory({
                            equation: `${angle}° miter on ${boardWidth}" board: Long ${inchesToDisplay(longSide)}, Short ${inchesToDisplay(shortSide)} (Δ ${inchesToDisplay(difference)})`,
                            result: knownSide === 'long' ? shortSide : longSide,
                            timestamp: new Date().toLocaleTimeString(),
                            type: 'preset',
                            label: 'Miter Cut'
                        });
                        
                        // Set the calculated value as new input
                        const parts = inchesToParts(knownSide === 'long' ? shortSide : longSide);
                        document.getElementById('feet1').value = parts.feet || '';
                        document.getElementById('inches1').value = parts.inches || '';
                        document.getElementById('fraction1').value = parts.fraction || 0;
                        updateCalculation();
                        
                        closeCalcModal();
                    } else {
                        showNotification('Please enter valid angle (0-90°), board width, and length');
                    }
                }
            }
        }
        
        function setCutValue() {
            cutValueInches = getInputInches('cutFeet', 'cutInches', 'cutFraction');
            document.getElementById('cutCurrentValue').textContent = inchesToDisplay(cutValueInches, 'cut');
        }
        
        function toggleInputMode() {
            inputMode = inputMode === 'fraction' ? 'decimal' : 'fraction';
            const fractionInputs = document.getElementById('fractionInputs');
            const decimalInputs = document.getElementById('decimalInputs');
            const toggleBtn = document.getElementById('modeToggle');
            
            if (inputMode === 'fraction') {
                fractionInputs.style.display = 'flex';
                decimalInputs.style.display = 'none';
                toggleBtn.textContent = 'Decimal Mode';
            } else {
                fractionInputs.style.display = 'none';
                decimalInputs.style.display = 'flex';
                toggleBtn.textContent = 'Fraction Mode';
            }
        }
        
        function getOperationValue() {
            if (inputMode === 'fraction') {
                return getInputInches('opFeet', 'opInches', 'opFraction');
            } else {
                return parseFloat(document.getElementById('operationValue')?.value) || 0;
            }
        }
        
        function quickCut(pieces) {
            if (cutValueInches <= 0) {
                showNotification('Please set a measurement first');
                return;
            }
            
            const kerfEnabled = document.getElementById('cutKerfEnabled')?.checked;
            const kerf = kerfEnabled ? parseFloat(document.getElementById('cutKerf')?.value || 0.125) : 0;
            const cutSide = document.getElementById('cutSide')?.value || 'left';
            const totalKerf = kerf * (pieces - 1);
            const pieceLength = (cutValueInches - totalKerf) / pieces;
            
            let results = [];
            let currentPos = 0;
            
            for (let i = 0; i < pieces - 1; i++) {
                // Calculate where each piece ends
                currentPos += pieceLength;
                
                // Adjust mark position based on cut side
                let markPosition = currentPos;
                if (kerfEnabled && cutSide === 'left') {
                    // If cutting on left side of mark, add kerf to mark position
                    markPosition += kerf;
                }
                // If cutting on right side, mark position stays at piece end
                
                results.push({
                    position: markPosition,
                    display: inchesToDisplay(markPosition, 'cut')
                });
            }
            
            // Create visual results
            const cutResults = document.createElement('div');
            cutResults.className = 'cut-results';
            
            const kerfNote = kerfEnabled ? ` (${inchesToDisplay(kerf, 'cut')} kerf)` : ' (no kerf)';
            const cutSideNote = kerfEnabled ? `, ${cutSide} side` : '';
            
            cutResults.innerHTML = `
                <h4>Cut ${inchesToDisplay(cutValueInches, 'cut')} into ${pieces} equal pieces${kerfNote}${cutSideNote}</h4>
                <div class="mark-list">
                    ${results.map((result, i) => `
                        <div class="mark-item">
                            <span class="mark-number">Mark ${i + 1}:</span>
                            <span class="mark-value">${result.display}</span>
                        </div>
                    `).join('')}
                </div>
                <div class="piece-info">
                    Result: ${pieces} pieces @ ${inchesToDisplay(pieceLength, 'cut')} each
                </div>
            `;
            
            // Add to history
            const historyDiv = document.getElementById('cutHistory');
            if (historyDiv) {
                historyDiv.insertBefore(cutResults, historyDiv.firstChild);
                
                // Keep only last 5 results
                while (historyDiv.children.length > 5) {
                    historyDiv.removeChild(historyDiv.lastChild);
                }
            }
        }
        
        function customCut() {
            const pieces = parseInt(document.getElementById('customPieces')?.value);
            if (!pieces || pieces < 2 || pieces > 20) {
                showNotification('Please enter a number between 2 and 20');
                return;
            }
            quickCut(pieces);
            document.getElementById('customPieces').value = '';
        }
        
        function toggleKerfDisplay() {
            const cutKerfEnabled = document.getElementById('cutKerfEnabled')?.checked;
            const optKerfEnabled = document.getElementById('optKerfEnabled')?.checked;
            
            const cutKerfRow = document.getElementById('cutKerfRow');
            const optKerfRow = document.getElementById('optKerfRow');
            
            if (cutKerfRow) {
                cutKerfRow.style.display = cutKerfEnabled ? 'flex' : 'none';
            }
            if (optKerfRow) {
                optKerfRow.style.display = optKerfEnabled ? 'flex' : 'none';
            }
            
            updateKerfDiagram();
        }
        
        function updateKerfDiagram() {
            const kerfEnabled = document.getElementById('cutKerfEnabled')?.checked;
            const cutSide = document.getElementById('cutSide')?.value || 'right';
            const diagram = document.getElementById('kerfDiagram');
            const kerfArea = document.getElementById('kerfArea');
            
            if (diagram) {
                diagram.style.display = kerfEnabled ? 'flex' : 'none';
                if (kerfArea) {
                    kerfArea.className = 'kerf-area ' + cutSide;
                }
            }
        }
        
        function operation(op) {
            // Clear previous operation highlighting
            document.querySelectorAll('.btn-operation').forEach(btn => btn.classList.remove('active'));
            
            currentOperation = op;
            
            // Highlight the selected operation
            event.target.classList.add('active');
            
            if (inputMode === 'decimal') {
                document.getElementById('operationValue')?.focus();
            }
        }
        
        function executeOperation() {
            if (currentValueInches <= 0) {
                showNotification('Please set a measurement first');
                return;
            }
            
            if (!currentOperation) {
                showNotification('Please select an operation first');
                return;
            }
            
            const value = getOperationValue();
            if (value <= 0 && currentOperation === '/') {
                showNotification('Cannot divide by zero or negative number');
                return;
            }
            
            const oldValue = currentValueInches;
            let newValue;
            
            switch (currentOperation) {
                case '+':
                    newValue = currentValueInches + value;
                    break;
                case '-':
                    newValue = currentValueInches - value;
                    break;
                case '*':
                    newValue = currentValueInches * value;
                    break;
                case '/':
                    newValue = currentValueInches / value;
                    break;
            }
            
            currentValueInches = newValue;
            document.getElementById('currentValue').textContent = inchesToDisplay(currentValueInches);
            
            const valueDisplay = inputMode === 'fraction' ? inchesToDisplay(value) : value + '"';
            addHistory(`${inchesToDisplay(oldValue)} ${currentOperation} ${valueDisplay} = ${inchesToDisplay(newValue)}`);
            
            // Clear operation selection and highlighting
            currentOperation = null;
            document.querySelectorAll('.btn-operation').forEach(btn => btn.classList.remove('active'));
            clearOperationInputs();
        }
        
        function clearOperationInputs() {
            if (document.getElementById('opFeet')) document.getElementById('opFeet').value = '';
            if (document.getElementById('opInches')) document.getElementById('opInches').value = '';
            if (document.getElementById('opFraction')) document.getElementById('opFraction').value = '0';
            if (document.getElementById('operationValue')) document.getElementById('operationValue').value = '';
        }
        
        function addHistory(item) {
            history.unshift(item);
            if (history.length > 20) history.pop();
            
            const historyDiv = document.getElementById('history');
            if (historyDiv) {
                historyDiv.innerHTML = history.map(h => `<div class="history-item">${h}</div>`).join('');
            }
        }
        
        function addCutHistory(item) {
            cutHistory.unshift(item);
            if (cutHistory.length > 20) cutHistory.pop();
            
            const historyDiv = document.getElementById('cutHistory');
            if (historyDiv) {
                historyDiv.innerHTML = cutHistory.map(h => `<div class="history-item">${h}</div>`).join('');
            }
        }
        
        function clearAll() {
            currentValueInches = 0;
            currentOperation = null;
            if (document.getElementById('currentValue')) document.getElementById('currentValue').textContent = 'Enter measurement above';
            if (document.getElementById('feet')) document.getElementById('feet').value = '';
            if (document.getElementById('inches')) document.getElementById('inches').value = '';
            if (document.getElementById('fraction')) document.getElementById('fraction').value = '0';
            clearOperationInputs();
        }
        
        function clearCut() {
            cutValueInches = 0;
            if (document.getElementById('cutCurrentValue')) document.getElementById('cutCurrentValue').textContent = 'Enter measurement above';
            if (document.getElementById('cutFeet')) document.getElementById('cutFeet').value = '';
            if (document.getElementById('cutInches')) document.getElementById('cutInches').value = '';
            if (document.getElementById('cutFraction')) document.getElementById('cutFraction').value = '0';
            if (document.getElementById('cutHistory')) document.getElementById('cutHistory').innerHTML = '';
        }
        
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (event && event.target) event.target.classList.add('active');
            const targetTab = document.getElementById(tab);
            if (targetTab) targetTab.classList.add('active');
        }
        
        function showHelp() {
            const modal = document.getElementById('helpModal');
            if (modal) modal.style.display = 'block';
        }
        
        function closeHelp() {
            const modal = document.getElementById('helpModal');
            if (modal) modal.style.display = 'none';
        }
        
        // Edit modal functions
        function showEditModal(type, data) {
            editingItem = { type: type, data: data };
            const modal = document.getElementById('editModal');
            const title = document.getElementById('editTitle');
            const inputs = document.getElementById('editInputs');
            
            if (type === 'board') {
                title.textContent = 'Edit Board';
                const parts = inchesToParts(data.length);
                inputs.innerHTML = `
                    <div class="input-group">
                        <label>Length:</label>
                        <input type="number" id="editFeet" placeholder="0" min="0" class="wide-input" value="${parts.feet}">
                        <span>ft</span>
                        <input type="number" id="editInches" placeholder="0" min="0" max="11" class="wide-input" value="${parts.inches}">
                        <span>in</span>
                        <select id="editFraction" style="width: 120px;">
                            <option value="0">0</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Quantity:</label>
                        <input type="number" id="editQuantity" placeholder="1" min="0" class="wide-input" value="${data.quantity}">
                    </div>
                `;
                updatePrecision('optimizer'); // Update fraction options with optimizer precision
                setTimeout(() => {
                    if (document.getElementById('editFraction')) {
                        document.getElementById('editFraction').value = parts.fraction;
                    }
                }, 10);
            } else if (type === 'cutGroup') {
                title.textContent = 'Edit Cut Group';
                const parts = inchesToParts(data.length);
                inputs.innerHTML = `
                    <div class="input-group">
                        <label>Length:</label>
                        <input type="number" id="editFeet" placeholder="0" min="0" class="wide-input" value="${parts.feet}">
                        <span>ft</span>
                        <input type="number" id="editInches" placeholder="0" min="0" max="11" class="wide-input" value="${parts.inches}">
                        <span>in</span>
                        <select id="editFraction" style="width: 120px;">
                            <option value="0">0</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Quantity:</label>
                        <input type="number" id="editQuantity" placeholder="1" min="0" class="wide-input" value="${data.count}">
                    </div>
                `;
                updatePrecision(); // Update fraction options
                document.getElementById('editFraction').value = parts.fraction;
            }
            
            modal.style.display = 'block';
        }
        
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            editingItem = null;
        }
        
        function saveEdit() {
            if (!editingItem) return;
            
            const newLength = getInputInches('editFeet', 'editInches', 'editFraction');
            const newQuantity = parseInt(document.getElementById('editQuantity')?.value) || 0;
            
            if (newLength <= 0) {
                showNotification('Please enter a valid length');
                return;
            }
            
            if (editingItem.type === 'board') {
                const index = editingItem.data.index;
                if (newQuantity > 0) {
                    boards[index] = { length: newLength, quantity: newQuantity };
                } else {
                    boards.splice(index, 1);
                }
                updateBoardsList();
            } else if (editingItem.type === 'cutGroup') {
                // Remove old cuts
                cuts = cuts.filter(cut => cut.id === undefined || !editingItem.data.ids.includes(cut.id));
                
                // Add new cuts
                for (let i = 0; i < newQuantity; i++) {
                    cuts.push({ length: newLength, id: cutIdCounter++ });
                }
                updateCutsList();
            }
            
            closeEditModal();
        }
        
        function deleteEdit() {
            if (!editingItem) return;
            
            if (confirm('Are you sure you want to delete this item?')) {
                if (editingItem.type === 'board') {
                    boards.splice(editingItem.data.index, 1);
                    updateBoardsList();
                } else if (editingItem.type === 'cutGroup') {
                    cuts = cuts.filter(cut => cut.id === undefined || !editingItem.data.ids.includes(cut.id));
                    updateCutsList();
                }
                closeEditModal();
            }
        }
        
        function editBoard(index) {
            showEditModal('board', { ...boards[index], index: index });
        }
        
        function editCutGroup(length, ids) {
            showEditModal('cutGroup', { length: length, count: ids.length, ids: ids });
        }
        
        function addBoard() {
            const inches = getInputInches('boardFeet', 'boardInches', 'boardFraction');
            const quantity = parseInt(document.getElementById('boardQuantity')?.value) || 1;
            if (inches <= 0) return;
            
            // Check if this board size already exists
            const existingBoard = boards.find(board => Math.abs(board.length - inches) < 0.01);
            if (existingBoard) {
                existingBoard.quantity += quantity;
            } else {
                boards.push({ length: inches, quantity: quantity });
            }
            
            updateBoardsList();
            
            if (document.getElementById('boardFeet')) document.getElementById('boardFeet').value = '';
            if (document.getElementById('boardInches')) document.getElementById('boardInches').value = '';
            if (document.getElementById('boardFraction')) document.getElementById('boardFraction').value = '0';
            if (document.getElementById('boardQuantity')) document.getElementById('boardQuantity').value = '1';
        }
        
        function addCut() {
            const inches = getInputInches('optCutFeet', 'optCutInches', 'optCutFraction');
            const quantity = parseInt(document.getElementById('cutQuantity')?.value) || 1;
            if (inches <= 0) return;
            
            for (let i = 0; i < quantity; i++) {
                cuts.push({ length: inches, id: cutIdCounter++ });
            }
            updateCutsList();
            
            if (document.getElementById('optCutFeet')) document.getElementById('optCutFeet').value = '';
            if (document.getElementById('optCutInches')) document.getElementById('optCutInches').value = '';
            if (document.getElementById('optCutFraction')) document.getElementById('optCutFraction').value = '0';
            if (document.getElementById('cutQuantity')) document.getElementById('cutQuantity').value = '1';
        }
        
        function updateBoardsList() {
            const div = document.getElementById('boardsList');
            if (!div) return;
            
            div.innerHTML = boards.map((board, i) => 
                `<div style="padding: 8px; background: #f0f0f0; margin: 4px; border-radius: 5px; display: flex; align-items: center; justify-content: space-between;">
                    <div style="flex: 1;">
                        <strong>${board.quantity}× ${inchesToDisplay(board.length, 'opt')} boards</strong>
                    </div>
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <button onclick="editBoard(${i})" style="background: #8B4513; color: white; border: none; border-radius: 3px; padding: 4px 8px; cursor: pointer; font-size: 12px;">Edit</button>
                        <button onclick="removeBoard(${i})" style="background: #cd5c5c; color: white; border: none; border-radius: 3px; padding: 4px 8px; cursor: pointer;">×</button>
                    </div>
                </div>`
            ).join('');
        }
        
        function updateCutsList() {
            const div = document.getElementById('cutsList');
            if (!div) return;
            
            const cutGroups = {};
            cuts.forEach(cut => {
                const lengthKey = cut.length.toFixed(6); // Use fixed precision for grouping
                if (!cutGroups[lengthKey]) {
                    cutGroups[lengthKey] = { length: cut.length, count: 0, ids: [] };
                }
                cutGroups[lengthKey].count++;
                cutGroups[lengthKey].ids.push(cut.id);
            });
            
            div.innerHTML = Object.values(cutGroups).map(group => 
                `<div style="padding: 8px; background: #f0f0f0; margin: 4px; border-radius: 5px; display: flex; align-items: center; justify-content: space-between;">
                    <div style="flex: 1;">
                        <strong>${group.count}× ${inchesToDisplay(group.length, 'opt')}</strong>
                    </div>
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <button onclick="editCutGroup(${group.length}, [${group.ids.join(',')}])" style="background: #8B4513; color: white; border: none; border-radius: 3px; padding: 4px 8px; cursor: pointer; font-size: 12px;">Edit</button>
                        <button onclick="removeCutGroup(${group.length})" style="background: #cd5c5c; color: white; border: none; border-radius: 3px; padding: 4px 8px; cursor: pointer;">×</button>
                    </div>
                </div>`
            ).join('');
        }
        
        function removeBoard(index) {
            boards.splice(index, 1);
            updateBoardsList();
        }
        
        function removeCutGroup(length) {
            // Remove all cuts that match this length (within small tolerance)
            cuts = cuts.filter(cut => Math.abs(cut.length - length) > 0.0001);
            updateCutsList();
        }
        
        function optimizeCuts() {
            if (boards.length === 0 || cuts.length === 0) {
                showNotification('Please add boards and cuts first');
                return;
            }
            
            const kerfEnabled = document.getElementById('optKerfEnabled')?.checked;
            const kerf = kerfEnabled ? parseFloat(document.getElementById('optKerf')?.value || 0.125) : 0;
            
            // Create expanded board list with individual boards
            let availableBoards = [];
            boards.forEach((boardType, typeIndex) => {
                for (let i = 0; i < boardType.quantity; i++) {
                    availableBoards.push({
                        length: boardType.length,
                        typeIndex: typeIndex,
                        boardNumber: i + 1
                    });
                }
            });
            
            const results = [];
            const remainingCuts = cuts.map(c => c.length).sort((a, b) => b - a); // Sort largest first
            availableBoards.sort((a, b) => b.length - a.length); // Sort by length desc
            
            let totalCutsCompleted = 0;
            
            for (let boardIndex = 0; boardIndex < availableBoards.length; boardIndex++) {
                let board = availableBoards[boardIndex];
                let boardLength = board.length;
                let cutsOnThisBoard = [];
                let usedLength = 0;
                
                for (let cutIndex = remainingCuts.length - 1; cutIndex >= 0; cutIndex--) {
                    const cutLength = remainingCuts[cutIndex];
                    const neededLength = usedLength === 0 ? cutLength : cutLength + kerf;
                    
                    if (usedLength + neededLength <= boardLength) {
                        cutsOnThisBoard.push(cutLength);
                        usedLength += neededLength;
                        remainingCuts.splice(cutIndex, 1);
                        totalCutsCompleted++;
                    }
                }
                
                if (cutsOnThisBoard.length > 0) {
                    const waste = boardLength - usedLength;
                    const boardSize = inchesToDisplay(board.length, 'opt');
                    results.push({
                        boardDisplay: `${boardSize} board #${board.boardNumber}`,
                        boardLength: board.length,
                        cuts: cutsOnThisBoard,
                        waste: waste
                    });
                }
                
                if (remainingCuts.length === 0) break;
            }
            
            displayOptimizationResults(results, remainingCuts, kerfEnabled, totalCutsCompleted, cuts.length);
        }
        
        function displayOptimizationResults(results, remainingCuts, kerfEnabled, completedCuts, totalCuts) {
            const div = document.getElementById('optimizationResults');
            if (!div) return;
            
            const kerfNote = kerfEnabled ? ` (with kerf)` : ' (no kerf)';
            let html = '<div class="results">';
            
            // Summary section
            html += '<h3>Summary:</h3>';
            html += `<p><strong>Cuts completed:</strong> ${completedCuts} of ${totalCuts}</p>`;
            
            if (remainingCuts.length > 0) {
                html += `<p style="color: #CD5C5C;"><strong>⚠️ Not enough boards!</strong> ${remainingCuts.length} cuts cannot be completed.</p>`;
            } else {
                html += `<p style="color: #4CAF50;"><strong>✅ All cuts can be completed!</strong></p>`;
            }
            
            if (results.length > 0) {
                html += `<h3 style="margin-top: 20px;">Cutting Plan${kerfNote}:</h3>`;
                results.forEach((result, index) => {
                    html += `<div class="cut-plan">
                        <strong>${result.boardDisplay}:</strong><br>
                        Cuts: ${result.cuts.map(cut => inchesToDisplay(cut, 'opt')).join(', ')}<br>
                        Waste: ${inchesToDisplay(result.waste, 'opt')}
                    </div>`;
                });
                
                const totalWaste = results.reduce((sum, result) => sum + result.waste, 0);
                html += `<p><strong>Total Waste: ${inchesToDisplay(totalWaste, 'opt')}</strong></p>`;
            }
            
            if (remainingCuts.length > 0) {
                html += '<h3 style="color: red; margin-top: 20px;">Cuts that don\'t fit:</h3>';
                const cutGroups = {};
                remainingCuts.forEach(cut => {
                    const display = inchesToDisplay(cut, 'opt');
                    cutGroups[display] = (cutGroups[display] || 0) + 1;
                });
                
                html += '<div style="background: #ffe6e6; padding: 10px; border-radius: 5px; border-left: 4px solid #CD5C5C;">';
                html += Object.entries(cutGroups).map(([display, count]) => 
                    `${count}× ${display}`
                ).join(', ');
                html += '<br><br><strong>Suggestion:</strong> Add more boards or reduce the number of cuts needed.';
                html += '</div>';
            }
            
            html += '</div>';
            
            // Add button to show visual layout
            if (results.length > 0) {
                html += '<div style="margin-top: 15px;">';
                html += '<button class="btn btn-primary" onclick="showVisualLayout()" style="margin-right: 10px;">Show Visual Layout</button>';
                html += '<button class="btn btn-secondary" onclick="exportCutList()">Export Cut List</button>';
                html += '</div>';
            }
            
            div.innerHTML = html;
            
            // Store results globally for visualization
            window.currentOptimizationResults = results;
            window.currentKerfEnabled = kerfEnabled;
        }
        
        function showVisualLayout() {
            const visualDiv = document.getElementById('visualLayout');
            const boardDiv = document.getElementById('boardVisualization');
            
            if (!window.currentOptimizationResults || !visualDiv || !boardDiv) {
                showNotification('No optimization results to visualize', 'error');
                return;
            }
            
            visualDiv.style.display = 'block';
            
            const results = window.currentOptimizationResults;
            const kerfEnabled = window.currentKerfEnabled;
            const kerf = kerfEnabled ? parseFloat(document.getElementById('optKerf')?.value || 0.125) : 0;
            
            let html = '';
            let totalWoodUsed = 0;
            let totalWaste = 0;
            
            // Calculate efficiency
            results.forEach(result => {
                const usedLength = result.boardLength - result.waste;
                totalWoodUsed += usedLength;
                totalWaste += result.waste;
            });
            
            const totalWood = totalWoodUsed + totalWaste;
            const efficiency = totalWood > 0 ? ((totalWoodUsed / totalWood) * 100) : 0;
            
            // Efficiency summary
            let efficiencyClass = 'efficiency-summary';
            if (efficiency >= 85) efficiencyClass += ' efficiency-good';
            else if (efficiency < 70) efficiencyClass += ' efficiency-poor';
            
            html += `<div class="${efficiencyClass}">
                <strong>Material Efficiency: ${efficiency.toFixed(1)}%</strong><br>
                Wood Used: ${inchesToDisplay(totalWoodUsed, 'opt')} | 
                Waste: ${inchesToDisplay(totalWaste, 'opt')} | 
                Total: ${inchesToDisplay(totalWood, 'opt')}
            </div>`;
            
            // Visualize each board
            results.forEach((result, boardIndex) => {
                const boardLength = result.boardLength;
                const maxDisplayWidth = 400; // Max width in pixels
                const scale = maxDisplayWidth / Math.max(boardLength, 48); // Scale based on largest board or 4 feet minimum
                
                html += `<div class="visual-board">
                    <div class="board-header">${result.boardDisplay} (${inchesToDisplay(boardLength, 'opt')})</div>
                    <div class="board-visual" style="width: ${boardLength * scale}px;">`;
                
                let currentPosition = 0;
                
                // Add cuts and kerf gaps
                result.cuts.forEach((cutLength, cutIndex) => {
                    // Add kerf before cut (except first cut)
                    if (cutIndex > 0 && kerfEnabled) {
                        html += `<div class="cut-segment kerf" style="left: ${currentPosition * scale}px; width: ${kerf * scale}px;" title="Kerf: ${inchesToDisplay(kerf, 'opt')}"></div>`;
                        currentPosition += kerf;
                    }
                    
                    // Add the cut
                    const cutWidth = cutLength * scale;
                    html += `<div class="cut-segment used" style="left: ${currentPosition * scale}px; width: ${cutWidth}px;" title="Cut: ${inchesToDisplay(cutLength, 'opt')}">${inchesToDisplay(cutLength, 'opt')}</div>`;
                    currentPosition += cutLength;
                });
                
                // Add waste if any
                if (result.waste > 0.01) { // Only show if waste is significant
                    const wasteWidth = result.waste * scale;
                    html += `<div class="cut-segment waste" style="left: ${currentPosition * scale}px; width: ${wasteWidth}px;" title="Waste: ${inchesToDisplay(result.waste, 'opt')}">Waste</div>`;
                }
                
                html += `</div>
                    <div class="board-stats">
                        Cuts: ${result.cuts.length} | 
                        Used: ${inchesToDisplay(boardLength - result.waste, 'opt')} | 
                        Waste: ${inchesToDisplay(result.waste, 'opt')} |
                        Efficiency: ${((boardLength - result.waste) / boardLength * 100).toFixed(1)}%
                    </div>
                </div>`;
            });
            
            boardDiv.innerHTML = html;
            
            // Scroll to visual layout
            visualDiv.scrollIntoView({ behavior: 'smooth' });
        }
        
        function toggleVisualLayout() {
            const visualDiv = document.getElementById('visualLayout');
            if (visualDiv) {
                visualDiv.style.display = visualDiv.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        function exportCutList() {
            if (!window.currentOptimizationResults) {
                showNotification('No optimization results to export', 'error');
                return;
            }
            
            const results = window.currentOptimizationResults;
            const projectName = currentProject ? currentProject.name : 'Woodworking Project';
            const date = new Date().toLocaleDateString();
            
            let exportText = `${projectName} - Cut List\n`;
            exportText += `Generated: ${date}\n`;
            exportText += `Kerf: ${window.currentKerfEnabled ? 'Enabled' : 'Disabled'}\n\n`;
            
            exportText += 'CUTTING PLAN:\n';
            exportText += '='.repeat(50) + '\n';
            
            results.forEach((result, index) => {
                exportText += `\n${result.boardDisplay}:\n`;
                exportText += `  Cuts: ${result.cuts.map(cut => inchesToDisplay(cut, 'opt')).join(', ')}\n`;
                exportText += `  Waste: ${inchesToDisplay(result.waste, 'opt')}\n`;
                exportText += `  Efficiency: ${((result.boardLength - result.waste) / result.boardLength * 100).toFixed(1)}%\n`;
            });
            
            const totalWaste = results.reduce((sum, result) => sum + result.waste, 0);
            const totalWood = results.reduce((sum, result) => sum + result.boardLength, 0);
            const efficiency = ((totalWood - totalWaste) / totalWood * 100).toFixed(1);
            
            exportText += `\nSUMMARY:\n`;
            exportText += `Total Boards Used: ${results.length}\n`;
            exportText += `Total Waste: ${inchesToDisplay(totalWaste, 'opt')}\n`;
            exportText += `Overall Efficiency: ${efficiency}%\n`;
            
            // Create downloadable file
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${projectName.replace(/[^a-zA-Z0-9]/g, '_')}_cut_list.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification('Cut list exported successfully!', 'success');
        }
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            const helpModal = document.getElementById('helpModal');
            const editModal = document.getElementById('editModal');
            const calcModal = document.getElementById('calcModal');
            const notesModal = document.getElementById('notesModal');
            
            if (event.target === helpModal) {
                helpModal.style.display = 'none';
            }
            if (event.target === editModal) {
                editModal.style.display = 'none';
                editingItem = null;
            }
            if (event.target === calcModal) {
                calcModal.style.display = 'none';
            }
            if (event.target === notesModal) {
                notesModal.style.display = 'none';
            }
        }
        
        // New Calculator Card Functions
        function toggleCalcCard(cardType) {
            const content = document.getElementById(cardType + 'Content');
            const arrow = document.querySelector(`#${cardType}Card .calc-arrow`);
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                arrow.textContent = '▲';
            } else {
                content.style.display = 'none';
                arrow.textContent = '▼';
            }
        }

        function calculateBoardFeet() {
            const species = document.getElementById('bfSpecies').value;
            const customSpecies = document.getElementById('bfCustomSpecies').value;
            const price = parseFloat(document.getElementById('bfPrice').value) || 0;
            const thickness = parseFloat(document.getElementById('bfThickness').value) || 0;
            const width = parseFloat(document.getElementById('bfWidth').value) || 0;
            const length = parseFloat(document.getElementById('bfLength').value) || 0;
            const quantity = parseFloat(document.getElementById('bfQuantity').value) || 1;
            const resultDiv = document.getElementById('boardFootResult');
            
            
            // Validate inputs - prevent negative numbers
            if (thickness < 0 || width < 0 || length < 0 || quantity < 0 || price < 0) {
                resultDiv.innerHTML = '<div class="result-placeholder">Please enter positive numbers only</div>';
                updateBoardDiagram(0, 0, 0, 0);
                return;
            }
            
            if (thickness === 0 || width === 0 || length === 0) {
                resultDiv.innerHTML = '<div class="result-placeholder">Enter dimensions above</div>';
                updateBoardDiagram(0, 0, 0, 0);
                return;
            }
            
            const boardFeet = (thickness * width * length * quantity) / 144;
            const totalCubicInches = thickness * width * length * quantity;
            const lineTotal = boardFeet * price;
            
            // Determine display species name
            const displaySpecies = species === 'Custom' ? customSpecies : species;
            const speciesDisplay = displaySpecies ? `${displaySpecies} - ` : '';
            
            resultDiv.innerHTML = `
                <div class="result-value">${speciesDisplay}${boardFeet.toFixed(3)} board feet</div>
                <div class="result-details">
                    ${quantity} piece${quantity !== 1 ? 's' : ''} × ${thickness}" × ${width}" × ${length}"<br>
                    ${price > 0 ? `Price: $${price.toFixed(2)}/BF × ${boardFeet.toFixed(3)} BF = <strong>$${lineTotal.toFixed(2)}</strong><br>` : ''}
                    Total volume: ${totalCubicInches.toLocaleString()} cubic inches
                </div>
            `;
            
            // Update visual diagram
            updateBoardDiagram(thickness, width, length, quantity);
        }

        function updateBoardDiagram(thickness, width, length, quantity) {
            const diagram = document.getElementById('boardDiagram');
            if (!diagram) return;
            
            if (thickness === 0 || width === 0 || length === 0 || quantity === 0) {
                diagram.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">Enter dimensions to see board visualization</div>';
                return;
            }
            
            // Constrain diagram size to prevent layout issues
            const maxWidth = 250;
            const maxHeight = 60;
            
            // Calculate proper aspect ratio and scale
            const aspectRatio = length / width;
            let diagramWidth, diagramHeight;
            
            if (aspectRatio >= 1) {
                // Length is longer - use full width, scale height
                diagramWidth = Math.min(maxWidth, length * 2);
                diagramHeight = Math.min(maxHeight, diagramWidth / aspectRatio);
            } else {
                // Width is longer - use full height, scale width  
                diagramHeight = Math.min(maxHeight, width * 2);
                diagramWidth = Math.min(maxWidth, diagramHeight * aspectRatio);
            }
            
            // Ensure minimum sizes for visibility
            diagramWidth = Math.max(diagramWidth, 60);
            diagramHeight = Math.max(diagramHeight, 20);
            
            diagram.innerHTML = `
                <div style="text-align: center; margin: 15px 0;">
                    <div class="lumber-piece" style="width: ${diagramWidth}px; height: ${diagramHeight}px; position: relative; margin: 0 auto; background: linear-gradient(45deg, #D2B48C, #F5DEB3); border: 2px solid #8B4513; border-radius: 4px; display: inline-block;">
                        <div style="font-size: 10px; position: absolute; top: -15px; left: 0; color: #8B4513; white-space: nowrap;">L: ${length}"</div>
                        <div style="font-size: 10px; position: absolute; left: -40px; top: 50%; transform: translateY(-50%); color: #8B4513; white-space: nowrap;">W: ${width}"</div>
                        <div style="font-size: 10px; position: absolute; right: -40px; top: 50%; transform: translateY(-50%); color: #8B4513; white-space: nowrap;">T: ${thickness}"</div>
                        ${quantity > 1 ? `<div style="font-size: 10px; position: absolute; bottom: -15px; right: 0; color: #8B4513; white-space: nowrap;">×${quantity}</div>` : ''}
                    </div>
                    <div style="font-size: 11px; color: #666; margin-top: 10px;">
                        ${thickness}" × ${width}" × ${length}" ${quantity > 1 ? `(${quantity} pieces)` : ''}
                    </div>
                </div>
            `;
        }

        let currentGoldenMode = 'short'; // Default mode: short to long
        
        function setGoldenMode(mode) {
            currentGoldenMode = mode;
            document.getElementById('goldenModeShort').classList.toggle('active', mode === 'short');
            document.getElementById('goldenModeLong').classList.toggle('active', mode === 'long');
            
            const label = document.getElementById('goldenInputLabel');
            label.textContent = mode === 'short' ? 'Short dimension:' : 'Long dimension:';
            
            calculateGoldenRatioNew(); // Recalculate with new mode
        }

        function calculateGoldenRatioNew() {
            const input = getInputInches('grFeet', 'grInches', 'grFraction');
            const resultDiv = document.getElementById('grResult');
            
            if (input === 0) {
                resultDiv.innerHTML = '<div class="result-placeholder">Enter a dimension above</div>';
                updateGoldenRectangle(0, 0);
                return;
            }
            
            const phi = 1.618033988749895;
            let result, description;
            
            if (currentGoldenMode === 'short') {
                result = input * phi;
                description = `If short side is ${inchesToDisplay(input)}, long side should be ${inchesToDisplay(result)}`;
                updateGoldenRectangle(input, result);
            } else {
                result = input / phi;
                description = `If long side is ${inchesToDisplay(input)}, short side should be ${inchesToDisplay(result)}`;
                updateGoldenRectangle(result, input);
            }
            
            resultDiv.innerHTML = `
                <div class="result-value">${inchesToDisplay(result)}</div>
                <div class="result-details">${description}<br>Ratio: 1:1.618 (φ)</div>
            `;
        }

        function updateGoldenRectangle(short, long) {
            const diagram = document.getElementById('goldenDiagram');
            if (!diagram) return;
            
            if (short === 0 || long === 0) {
                diagram.innerHTML = '<div class="golden-rectangle-placeholder">Enter a dimension to see visual</div>';
                return;
            }
            
            const maxSize = 200;
            const scale = Math.min(maxSize / long, maxSize / short);
            const shortScaled = Math.max(short * scale, 30);
            const longScaled = Math.max(long * scale, 30);
            
            diagram.innerHTML = `
                <div class="golden-rectangle" style="width: ${longScaled}px; height: ${shortScaled}px; position: relative; margin: 10px auto;">
                    <div style="font-size: 10px; position: absolute; top: -15px; left: 0; color: #8B4513;">${long.toFixed(1)}"</div>
                    <div style="font-size: 10px; position: absolute; left: -30px; top: 50%; transform: translateY(-50%); color: #8B4513;">${short.toFixed(1)}"</div>
                    <div class="golden-square" style="width: ${shortScaled}px; height: ${shortScaled}px;"></div>
                </div>
            `;
        }

        function calculateSpacing() {
            const totalLength = parseFloat(document.getElementById('spTotalLength').value) || 0;
            const numSpaces = parseInt(document.getElementById('spNumSpaces').value) || 0;
            const thickness = parseFloat(document.getElementById('spacingThickness').value) || 0;
            const resultDiv = document.getElementById('spResult');
            
            if (totalLength === 0 || numSpaces === 0) {
                resultDiv.innerHTML = '<div class="result-placeholder">Enter values above</div>';
                updateSpacingDiagram(0, 0, 0, 0);
                return;
            }
            
            let spacing, dividerInfo, description;
            
            if (thickness === 0) {
                // Simple shelf spacing without thickness
                spacing = totalLength / numSpaces;
                const centerMarks = Array.from({length: numSpaces - 1}, (_, i) => inchesToDisplay((i + 1) * spacing, 'calculator'));
                
                resultDiv.innerHTML = `
                    <div class="result-value">${spacing.toFixed(3)}" per space</div>
                    <div class="result-summary">
                        <div class="summary-row">
                            <span class="summary-label">Total Length:</span>
                            <span class="summary-value">${totalLength}"</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Spaces:</span>
                            <span class="summary-value">${numSpaces} equal spaces</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Material:</span>
                            <span class="summary-value">No thickness (center marks)</span>
                        </div>
                    </div>
                    ${centerMarks.length > 0 ? `
                    <div class="divider-marks">
                        <div class="marks-header">📐 Center Marking Guide:</div>
                        ${centerMarks.map((mark, i) => `
                            <div class="divider-mark-row">
                                <span class="divider-label">Mark ${i + 1}:</span>
                                <span class="mark-center">Center ${mark}</span>
                            </div>
                        `).join('')}
                    </div>` : ''}
                `;
            } else {
                // Account for material thickness
                const numDividers = numSpaces - 1;
                const totalThickness = numDividers * thickness;
                const availableSpace = totalLength - totalThickness;
                
                if (availableSpace <= 0) {
                    resultDiv.innerHTML = '<div class="result-placeholder">Material too thick for this spacing</div>';
                    updateSpacingDiagram(0, 0, 0, 0);
                    return;
                }
                
                spacing = availableSpace / numSpaces;
                
                // Calculate divider positions (left and right edges)
                dividerInfo = [];
                let currentPos = 0;
                
                for (let i = 0; i < numDividers; i++) {
                    currentPos += spacing; // Move to end of space
                    const leftEdge = currentPos;
                    const rightEdge = currentPos + thickness;
                    dividerInfo.push({
                        number: i + 1,
                        leftEdge: inchesToDisplay(leftEdge, 'calculator'),
                        rightEdge: inchesToDisplay(rightEdge, 'calculator')
                    });
                    currentPos += thickness; // Move past divider
                }
                
                resultDiv.innerHTML = `
                    <div class="result-value">${spacing.toFixed(3)}" per space</div>
                    <div class="result-summary">
                        <div class="summary-row">
                            <span class="summary-label">Total Length:</span>
                            <span class="summary-value">${totalLength}"</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Spaces:</span>
                            <span class="summary-value">${numSpaces} @ ${spacing.toFixed(3)}" each</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Dividers:</span>
                            <span class="summary-value">${numDividers} @ ${thickness}" thick</span>
                        </div>
                    </div>
                    <div class="divider-marks">
                        <div class="marks-header">📏 Divider Marking Guide:</div>
                        ${dividerInfo.map(div => `
                            <div class="divider-mark-row">
                                <span class="divider-label">Divider ${div.number}:</span>
                                <span class="mark-left">Left ${div.leftEdge}</span>
                                <span class="mark-right">Right ${div.rightEdge}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Update visual spacing diagram
            updateSpacingDiagram(totalLength, numSpaces, spacing, thickness);
        }

        function updateSpacingDiagram(total, spaces, spacing, thickness = 0) {
            const diagram = document.getElementById('spacingDiagram');
            if (!diagram) return;
            
            if (total === 0 || spaces === 0) {
                diagram.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">Enter dimensions to see spacing diagram</div>';
                return;
            }
            
            // Make diagrams bigger and more legible
            const containerMaxWidth = 450; // Larger container
            const minDiagramWidth = 400; // Larger minimum 
            const maxDiagramWidth = 1200; // Allow even wider for scrolling
            
            // Calculate diagram width - bigger for legibility
            let diagramWidth = Math.max(minDiagramWidth, total * 12); // Increased multiplier for bigger diagrams
            if (diagramWidth > maxDiagramWidth) diagramWidth = maxDiagramWidth;
            
            const diagramHeight = 120;
            const containerHeight = diagramHeight + 140; // Increase to accommodate 3 levels of marks (30px top + 110px bottom for 3 levels + mark height)
            const scale = diagramWidth / total;
            
            // Determine if we need horizontal scrolling
            const needsScroll = diagramWidth > containerMaxWidth;
            
            console.log(`Spacing diagram: total=${total}", spaces=${spaces}, diagramWidth=${diagramWidth}px, containerMax=${containerMaxWidth}px, needsScroll=${needsScroll}`);
            
            let html;
            if (needsScroll) {
                // Force scrollbar with explicit styles and CSS class
                html = `<div class="spacing-diagram-container" style="width: 100%; max-width: ${containerMaxWidth}px; overflow-x: scroll; overflow-y: hidden; padding: 15px 10px 25px 10px; border: 2px solid #007bff; border-radius: 8px; margin: 15px auto; background: #f8f9fa;">
                    <div style="text-align: center; font-size: 12px; color: #007bff; font-weight: bold; margin-bottom: 10px;">← Scroll horizontally to see full diagram (${diagramWidth}px wide) →</div>
                    <div style="width: ${diagramWidth}px; height: ${containerHeight}px; position: relative; border: 2px solid #8B4513; background: #fff; border-radius: 4px; margin: 0; padding-top: 40px;">`;
            } else {
                html = `<div style="padding: 10px; margin: 10px auto; text-align: center;">
                    <div style="position: relative; width: ${diagramWidth}px; height: ${containerHeight}px; border: 2px solid #8B4513; margin: 0 auto; background: #f8f9fa; display: inline-block; padding-top: 40px;">`;
            }
            
            // Add measurement line at top with better spacing
            html += `<div style="position: absolute; top: -20px; left: 0; font-size: 11px; color: #8B4513; font-weight: bold;">0"</div>`;
            html += `<div style="position: absolute; top: -20px; right: 0; font-size: 11px; color: #8B4513; font-weight: bold;">${total}"</div>`;
            
            if (thickness === 0) {
                // Simple spacing without material thickness - leader line system
                const numMarks = spaces - 1;
                const spaceFontSize = Math.max(10, Math.min(14, diagramWidth / (spaces * 6)));
                
                // Use full vertical space with leader lines for marks
                const markBoxWidth = 70; // Larger width for fractions
                const markBoxHeight = 28; // Taller boxes for fractions
                const markFontSize = 11; // Larger font for readability
                
                // Calculate vertical levels to distribute marks without overlap
                const availableBottomSpace = 110; // Enough space for 3 levels plus mark height
                const marksPerRow = Math.max(1, Math.floor(diagramWidth / (markBoxWidth + 10))); // How many marks fit per row with padding
                const levelsNeeded = Math.ceil(numMarks / marksPerRow); // Actual rows needed
                const levelHeight = Math.max(40, availableBottomSpace / 3); // Fixed spacing for 3 levels with generous room
                
                // Draw center marks with leader lines
                for (let i = 1; i < spaces; i++) {
                    const position = (i * spacing) * scale;
                    const markIndex = i - 1;
                    
                    // Vertical mark line extending down from diagram
                    html += `<div style="position: absolute; left: ${position - 1}px; top: 5px; width: 2px; height: 110px; background: #dc3545; border-radius: 1px;"></div>`;
                    
                    // Position mark NEAR its actual position on the diagram
                    const level = markIndex % 3; // Simple 3-level alternating to prevent overlap
                    const markTop = 140 + (level * levelHeight); // Position from top, below diagram
                    
                    // Position horizontally near the actual mark position
                    let markLeft = position - markBoxWidth/2; // Center the mark under the line
                    
                    // Ensure mark doesn't go off screen edges
                    if (markLeft < 5) markLeft = 5;
                    if (markLeft + markBoxWidth > diagramWidth - 5) markLeft = diagramWidth - markBoxWidth - 5;
                    
                    // Leader line from diagram position to mark box
                    const leaderStartX = position;
                    const leaderEndX = markLeft + markBoxWidth/2;
                    const leaderStartY = 115; // Bottom of diagram
                    const leaderEndY = markTop - 3; // Top of mark box
                    
                    // Always draw leader line for clarity
                    html += `<div style="position: absolute; left: ${Math.min(leaderStartX, leaderEndX)}px; top: ${leaderStartY}px; width: ${Math.abs(leaderEndX - leaderStartX) + 1}px; height: 2px; background: #dc3545; opacity: 0.8;"></div>`;
                    html += `<div style="position: absolute; left: ${leaderEndX}px; top: ${leaderStartY}px; width: 2px; height: ${leaderEndY - leaderStartY}px; background: #dc3545; opacity: 0.8;"></div>`;
                    
                    // Mark measurement box with leader line system
                    html += `<div style="position: absolute; left: ${markLeft}px; top: ${markTop}px; width: ${markBoxWidth}px; height: ${markBoxHeight}px; display: flex; align-items: center; justify-content: center; font-size: ${markFontSize}px; color: #dc3545; font-weight: bold; background: rgba(255,255,255,0.98); border: 2px solid #dc3545; border-radius: 4px; box-shadow: 0 2px 6px rgba(0,0,0,0.15);">${inchesToDisplay(i * spacing, 'calculator')}</div>`;
                }
                
                // Add space labels with adaptive sizing
                for (let i = 0; i < spaces; i++) {
                    const centerPos = (i * spacing + spacing / 2) * scale;
                    const spaceWidth = Math.max(30, Math.min(45, spacing * scale - 10));
                    
                    // Clean space indicators
                    html += `<div style="position: absolute; left: ${centerPos - spaceWidth/2}px; top: 45px; width: ${spaceWidth}px; text-align: center; font-size: ${spaceFontSize}px; color: #28a745; font-weight: bold; background: rgba(40, 167, 69, 0.1); border: 1px solid #28a745; border-radius: 15px; padding: 3px;">S${i + 1}</div>`;
                }
            } else {
                // Spacing with material thickness - leader line system for left/right marks
                const numDividers = spaces - 1;
                let currentPos = 0;
                const spaceFontSize = Math.max(10, Math.min(13, diagramWidth / (spaces * 8)));
                
                // Leader line system parameters
                const markBoxWidth = 65; // Larger width for fractions
                const markBoxHeight = 26; // Taller for fractions
                const markFontSize = 10; // Larger readable font
                
                // Calculate spacing distribution for marks
                const totalMarks = numDividers * 2; // Left + Right marks
                const availableBottomSpace = 110; // Enough space for 3 levels plus mark height
                const marksPerRow = Math.max(1, Math.floor(diagramWidth / (markBoxWidth + 15))); // Marks per row with spacing
                const levelsNeeded = Math.ceil(totalMarks / marksPerRow); // Actual rows needed
                const levelHeight = Math.max(40, availableBottomSpace / 3); // Fixed spacing for 3 levels with generous room
                
                for (let i = 0; i < spaces; i++) {
                    // Draw space with styling
                    const spaceStart = currentPos * scale;
                    const spaceEnd = (currentPos + spacing) * scale;
                    const spaceWidth = spaceEnd - spaceStart;
                    
                    // Clean space visualization - only show if wide enough
                    if (spaceWidth > 15) {
                        html += `<div style="position: absolute; left: ${spaceStart}px; top: 25px; width: ${spaceWidth}px; height: 50px; background: linear-gradient(135deg, rgba(40, 167, 69, 0.3), rgba(40, 167, 69, 0.1)); border: 2px solid #28a745; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div>`;
                        
                        // Space label
                        const labelWidth = Math.max(20, Math.min(35, spaceWidth - 10));
                        const labelLeft = spaceStart + spaceWidth/2 - labelWidth/2;
                        html += `<div style="position: absolute; left: ${labelLeft}px; top: 45px; width: ${labelWidth}px; text-align: center; font-size: ${spaceFontSize}px; color: #28a745; font-weight: bold; background: rgba(255,255,255,0.9); border-radius: 10px; padding: 2px;">S${i + 1}</div>`;
                    }
                    
                    currentPos += spacing;
                    
                    // Draw divider if not last space
                    if (i < numDividers) {
                        const dividerStart = currentPos * scale;
                        const dividerEnd = (currentPos + thickness) * scale;
                        const dividerWidth = dividerEnd - dividerStart;
                        const dividerIndex = i;
                        
                        // Clean divider visualization
                        html += `<div style="position: absolute; left: ${dividerStart}px; top: 10px; width: ${dividerWidth}px; height: 100px; background: linear-gradient(135deg, #8B4513, #A0522D); border: 2px solid #654321; border-radius: 3px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>`;
                        
                        // Smart positioning system for left and right marks
                        const markPairIndex = dividerIndex; // Each divider has a pair of marks
                        
                        // Simple alternating levels to prevent vertical overlap
                        const leftLevel = dividerIndex % 3; // Use up to 3 levels
                        const rightLevel = (dividerIndex + 1) % 3; // Offset right marks slightly
                        
                        // Position left mark NEAR its divider, using levels only for vertical spacing
                        const leftMarkTop = 140 + (leftLevel * levelHeight);
                        let leftMarkLeft = dividerStart - markBoxWidth - 15; // Left of the divider
                        
                        // If left mark would go off screen, position it above/below the divider instead
                        if (leftMarkLeft < 5) {
                            leftMarkLeft = Math.max(5, dividerStart - markBoxWidth/2);
                        }
                        
                        // Position right mark NEAR its divider, using levels only for vertical spacing  
                        const rightMarkTop = 140 + (rightLevel * levelHeight);
                        let rightMarkLeft = dividerEnd + 15; // Right of the divider
                        
                        // If right mark would go off screen, position it above/below the divider instead
                        if (rightMarkLeft + markBoxWidth > diagramWidth - 5) {
                            rightMarkLeft = Math.min(diagramWidth - markBoxWidth - 5, dividerEnd - markBoxWidth/2);
                        }
                        
                        // Draw leader lines for left mark - connect to LEFT edge of divider
                        const leftLeaderStartX = dividerStart; // Left edge of divider
                        const leftLeaderEndX = leftMarkLeft + markBoxWidth/2; // Center of mark box
                        const leftLeaderStartY = 110; // Bottom of diagram
                        const leftLeaderEndY = leftMarkTop - 3; // Top of mark box
                        
                        // Always draw leader line for left marks to show connection
                        html += `<div style="position: absolute; left: ${Math.min(leftLeaderStartX, leftLeaderEndX)}px; top: ${leftLeaderStartY}px; width: ${Math.abs(leftLeaderEndX - leftLeaderStartX) + 1}px; height: 2px; background: #8B4513; opacity: 0.8;"></div>`;
                        html += `<div style="position: absolute; left: ${leftLeaderEndX}px; top: ${leftLeaderStartY}px; width: 2px; height: ${leftLeaderEndY - leftLeaderStartY}px; background: #8B4513; opacity: 0.8;"></div>`;
                        
                        // Draw leader lines for right mark - connect to RIGHT edge of divider
                        const rightLeaderStartX = dividerEnd; // Right edge of divider
                        const rightLeaderEndX = rightMarkLeft + markBoxWidth/2; // Center of mark box
                        const rightLeaderStartY = 110; // Bottom of diagram
                        const rightLeaderEndY = rightMarkTop - 3; // Top of mark box
                        
                        // Always draw leader line for right marks to show connection
                        html += `<div style="position: absolute; left: ${Math.min(rightLeaderStartX, rightLeaderEndX)}px; top: ${rightLeaderStartY}px; width: ${Math.abs(rightLeaderEndX - rightLeaderStartX) + 1}px; height: 2px; background: #654321; opacity: 0.8;"></div>`;
                        html += `<div style="position: absolute; left: ${rightLeaderEndX}px; top: ${rightLeaderStartY}px; width: 2px; height: ${rightLeaderEndY - rightLeaderStartY}px; background: #654321; opacity: 0.8;"></div>`;
                        
                        // Left edge mark with leader line
                        html += `<div style="position: absolute; left: ${leftMarkLeft}px; top: ${leftMarkTop}px; width: ${markBoxWidth}px; height: ${markBoxHeight}px; display: flex; align-items: center; justify-content: center; font-size: ${markFontSize}px; color: #8B4513; font-weight: bold; background: rgba(255,255,255,0.98); border: 2px solid #8B4513; border-radius: 4px; box-shadow: 0 2px 6px rgba(0,0,0,0.15);">L${inchesToDisplay(currentPos, 'calculator')}</div>`;
                        
                        // Right edge mark with leader line
                        html += `<div style="position: absolute; left: ${rightMarkLeft}px; top: ${rightMarkTop}px; width: ${markBoxWidth}px; height: ${markBoxHeight}px; display: flex; align-items: center; justify-content: center; font-size: ${markFontSize}px; color: #654321; font-weight: bold; background: rgba(255,255,255,0.98); border: 2px solid #654321; border-radius: 4px; box-shadow: 0 2px 6px rgba(0,0,0,0.15);">R${inchesToDisplay(currentPos + thickness, 'calculator')}</div>`;
                        
                        // Divider number label
                        html += `<div style="position: absolute; left: ${dividerStart + dividerWidth/2 - 8}px; top: 55px; width: 16px; text-align: center; font-size: 9px; color: white; font-weight: bold; background: rgba(139, 69, 19, 0.8); border-radius: 8px; padding: 1px;">D${i + 1}</div>`;
                        
                        currentPos += thickness;
                    }
                }
            }
            
            html += '</div></div>';
            diagram.innerHTML = html;
        }

        function calculateMiterAngle() {
            const sides = parseInt(document.getElementById('maSides').value) || 0;
            const resultDiv = document.getElementById('maResult');
            
            if (sides < 3) {
                resultDiv.innerHTML = '<div class="result-placeholder">Enter number of sides (minimum 3)</div>';
                return;
            }
            
            const interiorAngle = ((sides - 2) * 180) / sides;
            const miterAngle = (180 - interiorAngle) / 2;
            const tableAngle = 90 - miterAngle;
            
            resultDiv.innerHTML = `
                <div class="result-value">${miterAngle.toFixed(2)}° miter cut</div>
                <div class="result-details">
                    Interior angle: ${interiorAngle.toFixed(1)}°<br>
                    Table saw angle: ${tableAngle.toFixed(2)}°<br>
                    Each piece needs ${miterAngle.toFixed(2)}° cut on both ends
                </div>
            `;
            
            // Update visual polygon
            updatePolygonDiagram(sides, miterAngle);
        }

        function updatePolygonDiagram(sides, miterAngle) {
            const diagram = document.getElementById('angleDiagram');
            if (!diagram) return;
            
            const radius = 40;
            const centerX = 60;
            const centerY = 60;
            
            let points = '';
            for (let i = 0; i < sides; i++) {
                const angle = (i * 2 * Math.PI) / sides - Math.PI / 2;
                const x = centerX + radius * Math.cos(angle);
                const y = centerY + radius * Math.sin(angle);
                points += `${x},${y} `;
            }
            
            diagram.innerHTML = `
                <svg width="120" height="120" style="display: block; margin: 0 auto;">
                    <polygon points="${points}" stroke="#8B4513" stroke-width="2" fill="none"/>
                    <text x="${centerX}" y="${centerY + 5}" text-anchor="middle" font-size="10" fill="#8B4513">
                        ${sides} sides
                    </text>
                </svg>
            `;
        }

        // Species Price Memory Functions
        function handleSpeciesChange() {
            const species = document.getElementById('bfSpecies').value;
            const customSpeciesRow = document.getElementById('customSpeciesRow');
            const priceInput = document.getElementById('bfPrice');
            
            // Handle custom species dropdown toggle
            if (species === 'Custom') {
                customSpeciesRow.style.display = 'block';
            } else {
                customSpeciesRow.style.display = 'none';
            }
            
            // Auto-fill remembered price for this specific species, or clear if no price saved
            if (species && species !== 'Custom') {
                if (speciesPrices[species]) {
                    priceInput.value = speciesPrices[species].toFixed(2);
                    showNotification(`Auto-filled price: $${speciesPrices[species].toFixed(2)}/BF`);
                } else {
                    priceInput.value = ''; // Clear price field for species with no saved price
                    priceInput.placeholder = 'Enter price/BF';
                }
            } else if (species === 'Custom') {
                priceInput.value = ''; // Always clear price for custom species
                priceInput.placeholder = 'Enter price/BF';
            }
            
            // Recalculate with new species/price
            calculateBoardFeet();
        }

        // Lumber Cart Management Functions
        function addToLumberCart() {
            const species = document.getElementById('bfSpecies').value;
            const customSpecies = document.getElementById('bfCustomSpecies').value;
            const price = parseFloat(document.getElementById('bfPrice').value) || 0;
            const thickness = parseFloat(document.getElementById('bfThickness').value) || 0;
            const width = parseFloat(document.getElementById('bfWidth').value) || 0;
            const length = parseFloat(document.getElementById('bfLength').value) || 0;
            const quantity = parseFloat(document.getElementById('bfQuantity').value) || 1;
            
            // Validate required fields
            if (!species || (species === 'Custom' && !customSpecies.trim())) {
                showNotification('Please select a wood species');
                return;
            }
            
            if (thickness <= 0 || width <= 0 || length <= 0 || quantity <= 0) {
                showNotification('Please enter valid dimensions and quantity');
                return;
            }
            
            if (price <= 0) {
                showNotification('Please enter a valid price per board foot');
                return;
            }
            
            // Calculate board feet and line total
            const boardFeet = (thickness * width * length * quantity) / 144;
            const lineTotal = boardFeet * price;
            const displaySpecies = species === 'Custom' ? customSpecies.trim() : species;
            
            // Create cart item
            const cartItem = {
                id: Date.now(), // Simple unique ID
                species: displaySpecies,
                thickness,
                width,
                length,
                quantity,
                pricePerBF: price,
                boardFeet,
                lineTotal
            };
            
            // Remember price for this species (for price memory feature)
            speciesPrices[displaySpecies] = price;
            
            // Add to cart
            lumberCart.push(cartItem);
            
            // Update cart display
            updateCartDisplay();
            
            // Clear form for next item
            clearBoardFootForm();
            
            showNotification(`Added ${displaySpecies} to cart`);
        }

        function removeFromLumberCart(itemId) {
            lumberCart = lumberCart.filter(item => item.id !== itemId);
            updateCartDisplay();
            showNotification('Item removed from cart');
        }

        function clearLumberCart() {
            if (lumberCart.length === 0) return;
            
            if (confirm('Clear all items from cart?')) {
                lumberCart = [];
                updateCartDisplay();
                showNotification('Cart cleared');
            }
        }

        function clearBoardFootForm() {
            document.getElementById('bfSpecies').value = '';
            document.getElementById('bfCustomSpecies').value = '';
            document.getElementById('bfPrice').value = '';
            document.getElementById('bfThickness').value = '';
            document.getElementById('bfWidth').value = '';
            document.getElementById('bfLength').value = '';
            document.getElementById('bfQuantity').value = '1';
            document.getElementById('customSpeciesRow').style.display = 'none';
            
            // Clear result display
            document.getElementById('boardFootResult').innerHTML = '<div class="result-placeholder">Enter item details above</div>';
        }

        function updateCartDisplay() {
            const cartContainer = document.getElementById('lumberCartDisplay');
            if (!cartContainer) return;
            
            if (lumberCart.length === 0) {
                cartContainer.innerHTML = '<div class="result-placeholder">No items in cart</div>';
                return;
            }
            
            let totalBoardFeet = 0;
            let totalCost = 0;
            
            let cartHTML = `
                <div class="cart-header">
                    <h4>Shopping Cart (${lumberCart.length} item${lumberCart.length !== 1 ? 's' : ''})</h4>
                    <button class="btn btn-secondary btn-sm" onclick="clearLumberCart()">Clear Cart</button>
                </div>
                <div class="cart-items">
            `;
            
            lumberCart.forEach(item => {
                totalBoardFeet += item.boardFeet;
                totalCost += item.lineTotal;
                
                cartHTML += `
                    <div class="cart-item">
                        <div class="cart-item-header">
                            <strong>${item.species}</strong>
                            <button class="btn-remove" onclick="removeFromLumberCart(${item.id})" title="Remove item">×</button>
                        </div>
                        <div class="cart-item-details">
                            ${item.quantity} pc${item.quantity !== 1 ? 's' : ''} × ${item.thickness}" × ${item.width}" × ${item.length}"
                        </div>
                        <div class="cart-item-pricing">
                            ${item.boardFeet.toFixed(3)} BF × $${item.pricePerBF.toFixed(2)}/BF = <strong>$${item.lineTotal.toFixed(2)}</strong>
                        </div>
                    </div>
                `;
            });
            
            cartHTML += `
                </div>
                <div class="cart-summary">
                    <div class="summary-row">
                        <span>Total Board Feet:</span>
                        <strong>${totalBoardFeet.toFixed(3)} BF</strong>
                    </div>
                    <div class="summary-row">
                        <span>Total Cost:</span>
                        <strong>$${totalCost.toFixed(2)}</strong>
                    </div>
                </div>
            `;
            
            cartContainer.innerHTML = cartHTML;
            
            // Enable/disable save cart button
            const saveBtn = document.getElementById('saveCartBtn');
            if (saveBtn) {
                saveBtn.disabled = lumberCart.length === 0;
            }
        }

        // Shopping History Management Functions
        function toggleShoppingHistory() {
            const section = document.getElementById('shoppingHistorySection');
            const button = document.getElementById('toggleHistoryBtn');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                button.textContent = 'Hide Shopping History';
                updateShoppingHistoryDisplay();
            } else {
                section.style.display = 'none';
                button.textContent = 'Show Shopping History';
            }
        }

        function updateShoppingHistoryDisplay() {
            const display = document.getElementById('shoppingHistoryDisplay');
            if (!display) return;
            
            if (shoppingHistory.length === 0) {
                display.innerHTML = '<div class="result-placeholder">No shopping history</div>';
                return;
            }
            
            let historyHTML = '';
            shoppingHistory.forEach((cart, index) => {
                historyHTML += `
                    <div class="shopping-history-item">
                        <div class="shopping-history-header-item">
                            <div>
                                <div class="shopping-history-date">${cart.date}</div>
                                <div class="shopping-history-summary">${cart.itemCount} items - ${cart.totalBoardFeet} BF - $${cart.totalCost}</div>
                            </div>
                            <div class="shopping-history-actions">
                                <button class="btn btn-primary btn-xs" onclick="loadShoppingCart(${index})" title="Load this cart">Load</button>
                                <button class="btn btn-secondary btn-xs" onclick="toggleHistoryDetails(${index})" title="Show/hide details">Details</button>
                                <button class="btn btn-warning btn-xs" onclick="removeShoppingHistory(${index})" title="Delete this entry">×</button>
                            </div>
                        </div>
                        <div class="shopping-history-details" id="historyDetails${index}">
                            ${cart.details}
                        </div>
                    </div>
                `;
            });
            
            display.innerHTML = historyHTML;
        }

        function toggleHistoryDetails(index) {
            const details = document.getElementById(`historyDetails${index}`);
            if (details) {
                details.classList.toggle('expanded');
            }
        }

        function loadShoppingCart(index) {
            if (index < 0 || index >= shoppingHistory.length) return;
            
            const savedCart = shoppingHistory[index];
            if (!savedCart.items || savedCart.items.length === 0) {
                showNotification('No items to load from this cart');
                return;
            }
            
            // Confirm before loading if current cart has items
            if (lumberCart.length > 0) {
                if (!confirm('This will replace your current cart. Continue?')) {
                    return;
                }
            }
            
            // Clear current cart and load saved items
            lumberCart = [...savedCart.items];
            updateCartDisplay();
            
            showNotification(`Loaded cart from ${savedCart.date}`);
        }

        function removeShoppingHistory(index) {
            if (confirm('Remove this shopping cart from history?')) {
                shoppingHistory.splice(index, 1);
                updateShoppingHistoryDisplay();
                saveToLocalStorage();
                showNotification('Shopping cart removed from history');
            }
        }

        function clearShoppingHistory() {
            if (shoppingHistory.length === 0) return;
            
            if (confirm('Clear all shopping history? This cannot be undone.')) {
                shoppingHistory = [];
                updateShoppingHistoryDisplay();
                saveToLocalStorage();
                showNotification('Shopping history cleared');
            }
        }

        function saveLumberCartToHistory() {
            if (lumberCart.length === 0) {
                showNotification('Cart is empty');
                return;
            }
            
            let totalBoardFeet = 0;
            let totalCost = 0;
            let cartSummary = 'LUMBER SHOPPING CART\n\n';
            
            lumberCart.forEach((item, index) => {
                totalBoardFeet += item.boardFeet;
                totalCost += item.lineTotal;
                
                cartSummary += `${index + 1}. ${item.species}\n`;
                cartSummary += `   ${item.quantity} pc${item.quantity !== 1 ? 's' : ''} × ${item.thickness}" × ${item.width}" × ${item.length}"\n`;
                cartSummary += `   ${item.boardFeet.toFixed(3)} BF × $${item.pricePerBF.toFixed(2)}/BF = $${item.lineTotal.toFixed(2)}\n\n`;
            });
            
            cartSummary += `TOTAL: ${totalBoardFeet.toFixed(3)} BF - $${totalCost.toFixed(2)}`;
            
            // Save to main calculator history
            addToCalcHistory({
                equation: cartSummary,
                result: `${lumberCart.length} items - $${totalCost.toFixed(2)}`,
                timestamp: new Date().toLocaleTimeString(),
                type: 'preset',
                label: 'Lumber Cart'
            });
            
            // Save to dedicated shopping history with more detail
            const now = new Date();
            const shoppingCartEntry = {
                date: now.toLocaleDateString() + ' ' + now.toLocaleTimeString(),
                itemCount: lumberCart.length,
                totalBoardFeet: totalBoardFeet.toFixed(3),
                totalCost: totalCost.toFixed(2),
                details: cartSummary,
                items: [...lumberCart] // Deep copy of cart items for reloading
            };
            
            shoppingHistory.unshift(shoppingCartEntry); // Add to beginning of array
            
            // Limit shopping history to last 20 entries
            if (shoppingHistory.length > 20) {
                shoppingHistory = shoppingHistory.slice(0, 20);
            }
            
            // Update shopping history display if visible
            const historySection = document.getElementById('shoppingHistorySection');
            if (historySection && historySection.style.display !== 'none') {
                updateShoppingHistoryDisplay();
            }
            
            saveToLocalStorage();
            showNotification('Cart saved to history');
            
            // Optionally clear cart after saving
            if (confirm('Cart saved! Clear cart for next shopping trip?')) {
                clearLumberCart();
            }
        }

        function saveBoardFeetToHistory() {
            const thickness = parseFloat(document.getElementById('bfThickness').value) || 0;
            const width = parseFloat(document.getElementById('bfWidth').value) || 0;
            const length = parseFloat(document.getElementById('bfLength').value) || 0;
            const quantity = parseFloat(document.getElementById('bfQuantity').value) || 1;
            
            if (thickness === 0 || width === 0 || length === 0) {
                showNotification('Enter dimensions first');
                return;
            }
            
            const boardFeet = (thickness * width * length * quantity) / 144;
            
            addToCalcHistory({
                equation: `${quantity}pc × ${thickness}" × ${width}" × ${length}" ÷ 144 = ${boardFeet.toFixed(3)} bf`,
                result: boardFeet,
                timestamp: new Date().toLocaleTimeString(),
                type: 'preset',
                label: 'Board Feet'
            });
            
            showNotification('Added to calculator history');
        }

        function saveGoldenRatioToHistory() {
            const input = getInputInches('grFeet', 'grInches', 'grFraction');
            
            if (input === 0) {
                showNotification('Enter a dimension first');
                return;
            }
            
            const phi = 1.618033988749895;
            let shortSide, longSide, equation;
            
            if (currentGoldenMode === 'short') {
                shortSide = input;
                longSide = input * phi;
                equation = `Golden Ratio: Short ${inchesToDisplay(shortSide)} → Long ${inchesToDisplay(longSide)}`;
            } else {
                longSide = input;
                shortSide = input / phi;
                equation = `Golden Ratio: Long ${inchesToDisplay(longSide)} → Short ${inchesToDisplay(shortSide)}`;
            }
            
            addToCalcHistory({
                equation: equation,
                result: currentGoldenMode === 'short' ? longSide : shortSide,
                timestamp: new Date().toLocaleTimeString(),
                type: 'preset',
                label: 'Golden Ratio'
            });
            
            showNotification('Added to calculator history');
        }

        function setAngleSides(sides) {
            document.getElementById('maSides').value = sides;
            calculateMiterAngle();
        }

        let currentMiterMode = 'polygon'; // Default mode: polygon
        
        function setMiterMode(mode) {
            currentMiterMode = mode;
            document.getElementById('miterModePolygon').classList.toggle('active', mode === 'polygon');
            document.getElementById('miterModeFrame').classList.toggle('active', mode === 'frame');
            document.getElementById('miterModeSingle').classList.toggle('active', mode === 'single');
            
            const polygonInputs = document.getElementById('polygonMiterInputs');
            const frameInputs = document.getElementById('frameMiterInputs');
            const singleInputs = document.getElementById('singleMiterInputs');
            
            if (mode === 'polygon') {
                polygonInputs.style.display = 'block';
                frameInputs.style.display = 'none';
                singleInputs.style.display = 'none';
                calculateMiterAngle();
            } else if (mode === 'frame') {
                polygonInputs.style.display = 'none';
                frameInputs.style.display = 'block';
                singleInputs.style.display = 'none';
                updateFrameDimensionLabels();
                calculateFrameBuilder();
            } else {
                polygonInputs.style.display = 'none';
                frameInputs.style.display = 'none';
                singleInputs.style.display = 'block';
                calculateSingleMiter();
            }
        }

        function calculateSingleMiter() {
            const angle = parseFloat(document.getElementById('singleMiterAngle').value) || 0;
            const boardWidth = getInputInches('singleBoardWidthFeet', 'singleBoardWidthInches', 'singleBoardWidthFraction');
            const knownSide = document.getElementById('singleKnownSide').value;
            const inputLength = getInputInches('singleInputLengthFeet', 'singleInputLengthInches', 'singleInputLengthFraction');
            const resultDiv = document.getElementById('maResult');
            
            if (angle === 0 || boardWidth === 0 || inputLength === 0) {
                resultDiv.innerHTML = '<div class="result-placeholder">Enter all values above</div>';
                return;
            }
            
            const angleRad = (angle * Math.PI) / 180;
            const offset = boardWidth * Math.tan(angleRad);
            
            let shortSide, longSide;
            if (knownSide === 'long') {
                longSide = inputLength;
                shortSide = longSide - offset;
            } else {
                shortSide = inputLength;
                longSide = shortSide + offset;
            }
            
            resultDiv.innerHTML = `
                <div class="result-value">${angle}° miter cut</div>
                <div class="result-details">
                    Long side (back): ${inchesToDisplay(longSide)}<br>
                    Short side (front): ${inchesToDisplay(shortSide)}<br>
                    Offset: ${inchesToDisplay(offset)}
                </div>
            `;
            
            // Update label for the input
            const label = document.getElementById('singleInputLabel');
            label.textContent = knownSide === 'long' ? 'Long side length:' : 'Short side length:';
            
            // Update diagram to show single miter cut visualization
            updateSingleMiterDiagram(angle, boardWidth, shortSide, longSide);
        }

        function updateSingleMiterDiagram(angle, boardWidth, shortSide, longSide) {
            const diagram = document.getElementById('angleDiagram');
            if (!diagram) return;
            
            // Create a simple miter cut visualization
            diagram.innerHTML = `
                <svg width="120" height="120" style="display: block; margin: 0 auto;">
                    <!-- Board outline -->
                    <rect x="30" y="45" width="60" height="${Math.min(boardWidth * 8, 20)}" fill="none" stroke="#8B4513" stroke-width="2"/>
                    <!-- Miter cut line -->
                    <line x1="30" y1="45" x2="45" y2="${45 + Math.min(boardWidth * 8, 20)}" stroke="#dc3545" stroke-width="2"/>
                    <line x1="90" y1="45" x2="75" y2="${45 + Math.min(boardWidth * 8, 20)}" stroke="#dc3545" stroke-width="2"/>
                    <!-- Angle label -->
                    <text x="60" y="35" text-anchor="middle" font-size="12" fill="#8B4513">${angle}°</text>
                    <!-- Length labels -->
                    <text x="60" y="100" text-anchor="middle" font-size="10" fill="#8B4513">
                        L: ${inchesToDisplay(longSide)}
                    </text>
                    <text x="60" y="112" text-anchor="middle" font-size="10" fill="#8B4513">
                        S: ${inchesToDisplay(shortSide)}
                    </text>
                </svg>
            `;
        }

        // Frame Builder Functions
        function updateFrameDimensionLabels() {
            const dimensionType = document.getElementById('frameDimensionType').value;
            const sides = parseInt(document.getElementById('frameShapeSides').value);
            
            // Update labels based on inside/outside selection
            if (sides === 4) {
                // Rectangle/Square
                document.getElementById('frameWidthLabel').textContent = 
                    dimensionType === 'inside' ? 'Inside Width:' : 'Outside Width:';
                document.getElementById('frameHeightLabel').textContent = 
                    dimensionType === 'inside' ? 'Inside Height:' : 'Outside Height:';
                document.getElementById('frameRectangleDimensions').style.display = 'block';
                document.getElementById('framePolygonDimensions').style.display = 'none';
            } else {
                // Regular polygon
                document.getElementById('framePolygonLabel').textContent = 
                    dimensionType === 'inside' ? 'Inside Side Length:' : 'Outside Side Length:';
                document.getElementById('frameRectangleDimensions').style.display = 'none';
                document.getElementById('framePolygonDimensions').style.display = 'block';
            }
        }

        function calculateFrameBuilder() {
            const sides = parseInt(document.getElementById('frameShapeSides').value);
            const materialWidth = getInputInches('frameMaterialWidthFeet', 'frameMaterialWidthInches', 'frameMaterialWidthFraction');
            const dimensionType = document.getElementById('frameDimensionType').value;
            const resultDiv = document.getElementById('maResult');
            
            if (materialWidth === 0) {
                resultDiv.innerHTML = '<div class="result-placeholder">Enter material width</div>';
                return;
            }
            
            // Calculate miter angle for this polygon
            const interiorAngle = ((sides - 2) * 180) / sides;
            const miterAngle = (180 - interiorAngle) / 2;
            const miterRadians = (miterAngle * Math.PI) / 180;
            
            let cutList = '';
            let totalLinearFeet = 0;
            let insideDimensions = '';
            let outsideDimensions = '';
            
            if (sides === 4) {
                // Rectangle/Square frame
                const inputWidth = getInputInches('frameWidthFeet', 'frameWidthInches', 'frameWidthFraction');
                const inputHeight = getInputInches('frameHeightFeet', 'frameHeightInches', 'frameHeightFraction');
                
                if (inputWidth === 0 || inputHeight === 0) {
                    resultDiv.innerHTML = '<div class="result-placeholder">Enter frame dimensions</div>';
                    return;
                }
                
                let insideWidth, insideHeight, outsideWidth, outsideHeight;
                
                // Calculate offset for miter joints
                const offset = materialWidth * Math.tan(miterRadians);
                
                if (dimensionType === 'inside') {
                    // User provided inside dimensions
                    insideWidth = inputWidth;
                    insideHeight = inputHeight;
                    outsideWidth = insideWidth + 2 * materialWidth;
                    outsideHeight = insideHeight + 2 * materialWidth;
                } else {
                    // User provided outside dimensions
                    outsideWidth = inputWidth;
                    outsideHeight = inputHeight;
                    insideWidth = outsideWidth - 2 * materialWidth;
                    insideHeight = outsideHeight - 2 * materialWidth;
                }
                
                // Calculate cut lengths (long side includes the offset on both ends)
                const horizontalCutLength = insideWidth + 2 * offset;
                const verticalCutLength = insideHeight + 2 * offset;
                
                // Create cut list with both inside and outside measurements for clarity
                cutList = `
                    <div class="cut-list">
                        <h4>Cut List:</h4>
                        <div class="cut-item">
                            <strong>2 horizontal pieces:</strong><br>
                            Cut Length: ${inchesToDisplay(horizontalCutLength)}<br>
                            <small>(Inside span: ${inchesToDisplay(insideWidth)}, Outside span: ${inchesToDisplay(outsideWidth)})</small>
                        </div>
                        <div class="cut-item">
                            <strong>2 vertical pieces:</strong><br>
                            Cut Length: ${inchesToDisplay(verticalCutLength)}<br>
                            <small>(Inside span: ${inchesToDisplay(insideHeight)}, Outside span: ${inchesToDisplay(outsideHeight)})</small>
                        </div>
                    </div>
                `;
                
                totalLinearFeet = ((horizontalCutLength * 2) + (verticalCutLength * 2)) / 12;
                insideDimensions = `${inchesToDisplay(insideWidth)} × ${inchesToDisplay(insideHeight)}`;
                outsideDimensions = `${inchesToDisplay(outsideWidth)} × ${inchesToDisplay(outsideHeight)}`;
                
            } else {
                // Regular polygon frame
                const inputSideLength = getInputInches('framePolygonFeet', 'framePolygonInches', 'framePolygonFraction');
                
                if (inputSideLength === 0) {
                    resultDiv.innerHTML = '<div class="result-placeholder">Enter polygon side length</div>';
                    return;
                }
                
                let insideSideLength, outsideSideLength;
                
                if (dimensionType === 'inside') {
                    insideSideLength = inputSideLength;
                    // For regular polygon, outside side length = inside + 2 * (material_width / tan((π-interior_angle)/2))
                    // Simplified: outside = inside + 2 * material_width / tan(miter_angle)
                    const sideWidthAddition = 2 * materialWidth / Math.tan(miterRadians);
                    outsideSideLength = insideSideLength + sideWidthAddition;
                } else {
                    outsideSideLength = inputSideLength;
                    const sideWidthAddition = 2 * materialWidth / Math.tan(miterRadians);
                    insideSideLength = outsideSideLength - sideWidthAddition;
                }
                
                const offset = materialWidth * Math.tan(miterRadians);
                const cutLength = insideSideLength + 2 * offset;
                
                cutList = `
                    <div class="cut-list">
                        <h4>Cut List:</h4>
                        <div class="cut-item">
                            <strong>${sides} pieces:</strong><br>
                            Cut Length: ${inchesToDisplay(cutLength)}<br>
                            <small>(Inside side: ${inchesToDisplay(insideSideLength)}, Outside side: ${inchesToDisplay(outsideSideLength)})</small>
                        </div>
                    </div>
                `;
                
                totalLinearFeet = (cutLength * sides) / 12;
                insideDimensions = `${inchesToDisplay(insideSideLength)} per side`;
                outsideDimensions = `${inchesToDisplay(outsideSideLength)} per side`;
            }
            
            resultDiv.innerHTML = `
                <div class="result-value">${miterAngle.toFixed(1)}° miter cut</div>
                <div class="result-details">
                    <strong>Inside:</strong> ${insideDimensions}<br>
                    <strong>Outside:</strong> ${outsideDimensions}<br>
                    <strong>Material needed:</strong> ${totalLinearFeet.toFixed(1)} linear feet
                </div>
                ${cutList}
            `;
            
            // Update diagram to show the frame shape
            updatePolygonDiagram(sides, miterAngle);
        }

        function saveAngleToHistory() {
            if (currentMiterMode === 'polygon') {
                const sides = parseInt(document.getElementById('maSides').value) || 0;
                
                if (sides < 3) {
                    showNotification('Enter number of sides first');
                    return;
                }
                
                const interiorAngle = ((sides - 2) * 180) / sides;
                const miterAngle = (180 - interiorAngle) / 2;
                
                addToCalcHistory({
                    equation: `${sides}-sided polygon: ${miterAngle.toFixed(2)}° miter cuts`,
                    result: miterAngle,
                    timestamp: new Date().toLocaleTimeString(),
                    type: 'preset',
                    label: 'Miter Angle'
                });
            } else if (currentMiterMode === 'frame') {
                const sides = parseInt(document.getElementById('frameShapeSides').value);
                const materialWidth = getInputInches('frameMaterialWidthFeet', 'frameMaterialWidthInches', 'frameMaterialWidthFraction');
                
                if (materialWidth === 0) {
                    showNotification('Enter frame details first');
                    return;
                }
                
                const interiorAngle = ((sides - 2) * 180) / sides;
                const miterAngle = (180 - interiorAngle) / 2;
                
                let frameName = '';
                if (sides === 4) frameName = 'Rectangle/Square';
                else if (sides === 3) frameName = 'Triangle';
                else if (sides === 6) frameName = 'Hexagon';
                else if (sides === 8) frameName = 'Octagon';
                else frameName = `${sides}-sided`;
                
                // Get dimensions summary
                let dimensionsSummary = '';
                if (sides === 4) {
                    const width = getInputInches('frameWidthFeet', 'frameWidthInches', 'frameWidthFraction');
                    const height = getInputInches('frameHeightFeet', 'frameHeightInches', 'frameHeightFraction');
                    dimensionsSummary = `${inchesToDisplay(width)} × ${inchesToDisplay(height)}`;
                } else {
                    const sideLength = getInputInches('framePolygonFeet', 'framePolygonInches', 'framePolygonFraction');
                    dimensionsSummary = `${inchesToDisplay(sideLength)} side length`;
                }
                
                addToCalcHistory({
                    equation: `${frameName} Frame: ${dimensionsSummary}, ${inchesToDisplay(materialWidth)} material`,
                    result: `${miterAngle.toFixed(1)}° cuts`,
                    timestamp: new Date().toLocaleTimeString(),
                    type: 'preset',
                    label: 'Frame Builder'
                });
            } else {
                const angle = parseFloat(document.getElementById('singleMiterAngle').value) || 0;
                const boardWidth = getInputInches('singleBoardWidthFeet', 'singleBoardWidthInches', 'singleBoardWidthFraction');
                const inputLength = getInputInches('singleInputLengthFeet', 'singleInputLengthInches', 'singleInputLengthFraction');
                const knownSide = document.getElementById('singleKnownSide').value;
                
                if (angle === 0 || boardWidth === 0 || inputLength === 0) {
                    showNotification('Enter all values first');
                    return;
                }
                
                const angleRad = (angle * Math.PI) / 180;
                const offset = boardWidth * Math.tan(angleRad);
                
                let shortSide, longSide;
                if (knownSide === 'long') {
                    longSide = inputLength;
                    shortSide = longSide - offset;
                } else {
                    shortSide = inputLength;
                    longSide = shortSide + offset;
                }
                
                addToCalcHistory({
                    equation: `${angle}° miter cut: ${inchesToDisplay(boardWidth)} board, ${knownSide} side ${inchesToDisplay(inputLength)}`,
                    result: `Long: ${inchesToDisplay(longSide)}, Short: ${inchesToDisplay(shortSide)}`,
                    timestamp: new Date().toLocaleTimeString(),
                    type: 'preset',
                    label: 'Single Miter'
                });
            }
            
            showNotification('Added to calculator history');
        }

        function saveSpacingToHistory() {
            const totalLength = parseFloat(document.getElementById('spTotalLength').value) || 0;
            const numSpaces = parseInt(document.getElementById('spNumSpaces').value) || 0;
            const thickness = parseFloat(document.getElementById('spacingThickness').value) || 0;
            
            if (totalLength === 0 || numSpaces === 0) {
                showNotification('Enter dimensions first');
                return;
            }
            
            let spacing, detailedEquation;
            
            if (thickness === 0) {
                // CENTER MARKS MODE - No material thickness
                spacing = totalLength / numSpaces;
                const centerMarks = Array.from({length: numSpaces - 1}, (_, i) => inchesToDisplay((i + 1) * spacing, 'calculator'));
                
                detailedEquation = `SHELF & DIVISION - Center Marks
Total Length: ${inchesToDisplay(totalLength, 'calculator')}
Spaces: ${numSpaces} @ ${inchesToDisplay(spacing, 'calculator')} each
Material: No thickness (center marks)

📐 Center Marking Guide:`;

                if (centerMarks.length <= 10) {
                    centerMarks.forEach((mark, i) => {
                        detailedEquation += `\nMark ${i + 1}: Center ${mark}`;
                    });
                } else {
                    // Show first 5, middle indicator, last 5
                    for (let i = 0; i < 5; i++) {
                        detailedEquation += `\nMark ${i + 1}: Center ${centerMarks[i]}`;
                    }
                    detailedEquation += `\n... ${centerMarks.length - 10} more marks ...`;
                    for (let i = centerMarks.length - 5; i < centerMarks.length; i++) {
                        detailedEquation += `\nMark ${i + 1}: Center ${centerMarks[i]}`;
                    }
                }
                
            } else {
                // DIVIDER MODE - With material thickness
                const numDividers = numSpaces - 1;
                const totalThickness = numDividers * thickness;
                const availableSpace = totalLength - totalThickness;
                spacing = availableSpace / numSpaces;
                
                // Calculate divider positions
                const dividerInfo = [];
                let currentPos = 0;
                for (let i = 0; i < numDividers; i++) {
                    currentPos += spacing;
                    const leftEdge = currentPos;
                    const rightEdge = currentPos + thickness;
                    dividerInfo.push({
                        number: i + 1,
                        left: inchesToDisplay(leftEdge, 'calculator'),
                        right: inchesToDisplay(rightEdge, 'calculator')
                    });
                    currentPos += thickness;
                }
                
                detailedEquation = `SHELF & DIVISION - With Dividers
Total Length: ${inchesToDisplay(totalLength, 'calculator')}
Spaces: ${numSpaces} @ ${inchesToDisplay(spacing, 'calculator')} each
Dividers: ${numDividers} @ ${inchesToDisplay(thickness, 'calculator')} thick

📏 Divider Marking Guide:`;

                if (dividerInfo.length <= 8) {
                    dividerInfo.forEach(div => {
                        detailedEquation += `\nDivider ${div.number}: Left ${div.left} - Right ${div.right}`;
                    });
                } else {
                    // Show first 4, middle indicator, last 4
                    for (let i = 0; i < 4; i++) {
                        const div = dividerInfo[i];
                        detailedEquation += `\nDivider ${div.number}: Left ${div.left} - Right ${div.right}`;
                    }
                    detailedEquation += `\n... ${dividerInfo.length - 8} more dividers ...`;
                    for (let i = dividerInfo.length - 4; i < dividerInfo.length; i++) {
                        const div = dividerInfo[i];
                        detailedEquation += `\nDivider ${div.number}: Left ${div.left} - Right ${div.right}`;
                    }
                }
            }
            
            addToCalcHistory({
                equation: detailedEquation,
                result: spacing,
                timestamp: new Date().toLocaleTimeString(),
                type: 'preset',
                label: 'Shelf & Division'
            });
            
            showNotification('Added to calculator history');
        }

        // Initialize all precisions
        updatePrecision('calculator');
        updatePrecision('cut');
        updatePrecision('optimizer');
        toggleKerfDisplay();
        
        // Initialize app - load saved data and set up project management
        document.addEventListener('DOMContentLoaded', function() {
            loadFromLocalStorage();
            updateProjectSelector();
            updateProjectStatusBars();
            updateConversionPreview();
            
            // Initialize diagrams
            calculateMiterAngle(); // Initialize the miter angle diagram
            
            // Add auto-save on input changes
            const inputs = document.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('change', () => {
                    setTimeout(autoSave, 1000); // Auto-save 1 second after change
                });
            });
            
            // Initialize calculator cards with default values
            calculateBoardFeet();
            calculateGoldenRatioNew();
            calculateSpacing();
            calculateMiterAngle();
            
            console.log('Woodworking Calculator with Visual Project Management loaded!');
        });
    </script>
</body>
</html>
