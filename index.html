<!DOCTYPE html>
<html lang="en">
<!-- ========================================================================
     WOODWORKING CALCULATOR - SINGLE FILE APPLICATION
     ========================================================================
     TABLE OF CONTENTS
     ========================================================================
     1. CSS STYLES (Lines 30-3820)
        1.1 Global Variables & Theme (Lines 30-150)
        1.2 Base Styles & Layout (Lines 151-500)
        1.3 Calculator Styles (Lines 501-1200)
        1.4 Cut Calculator Styles (Lines 1201-1800)
        1.5 Specialty Calculator Styles (Lines 1801-2800)
        1.6 Project & Modal Styles (Lines 2801-3600)
        1.7 Help System Styles (Lines 3601-3820)
        
     2. HTML STRUCTURE (Lines 3821-5985)
        2.1 Navigation & Header (Lines 3821-3870)
        2.2 Calculator Tab Content (Lines 3871-3985)
        2.3 Specialty Calculators Tab (includes Cut Calculator)
        2.4 Specialty Calculators Tab (Lines 4204-5558)
        2.5 Projects Tab (Lines 5559-5985)
        
     3. JAVASCRIPT (Lines 5986-16788)
        3.1 UI Configuration (Lines 5986-6280)
        3.2 Global Variables (Lines 6281-6380)
        3.3 Utility Functions (Lines 6381-7500)
        3.4 Calculator Core (Lines 7501-8500)
        3.5 Cut Calculator Functions (Lines 8501-9500)
        3.6 Specialty Calculators (Lines 9501-14000)
        3.7 Project Management (Lines 14001-15500)
        3.8 Initialization (Lines 15501-16788)
     ======================================================================== -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WorkShop Pro Calculator</title>
    <style>
        /* ================================================================
           SECTION 1: CSS STYLES
           ================================================================ */
        
        /* ----------------------------------------------------------------
           1.1 GLOBAL VARIABLES & THEME CONFIGURATION
           ---------------------------------------------------------------- */
        /* CSS Custom Properties for Themeable Colors */
        :root {
            /* Wood Theme (Default) */
            --primary-color: #8B4513;
            --primary-light: #A0522D;
            --primary-dark: #6B3410;
            --secondary-color: #D2B48C;
            --accent-color: #DEB887;
            --background-color: #FFFFFF;
            --surface-color: #F8F9FA;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-on-primary: #FFFFFF;
            --border-color: #D2B48C;
            --success-color: #4CAF50;
            --warning-color: #FF9800;
            --error-color: #F44336;
            --info-color: #2196F3;
            
            /* Gradient variations */
            --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            --gradient-surface: linear-gradient(135deg, var(--surface-color), var(--background-color));
            
            /* Theme transition */
            --theme-transition: all 0.3s ease;
        }
        
        /* Steel Theme */
        .theme-steel {
            --primary-color: #6B7280;
            --primary-light: #9CA3AF;
            --primary-dark: #4B5563;
            --secondary-color: #D1D5DB;
            --accent-color: #E5E7EB;
            --background-color: #F9FAFB;
            --surface-color: #FFFFFF;
            --text-primary: #111827;
            --text-secondary: #4B5563;
            --text-on-primary: #FFFFFF;
            --border-color: #D1D5DB;
            --success-color: #10B981;
            --warning-color: #F59E0B;
            --error-color: #EF4444;
            --info-color: #6B7280;
            --gradient-primary: linear-gradient(135deg, #6B7280, #4B5563);
            --gradient-surface: linear-gradient(135deg, var(--surface-color), var(--background-color));
        }
        
        /* Steel Theme Diamond Plate Background */
body.theme-steel {
background: 
/* Brushed metal texture */
repeating-linear-gradient(
45deg,
rgba(255,255,255,0.03) 0px,
rgba(255,255,255,0.03) 1px,
transparent 1px,
transparent 2px,
rgba(0,0,0,0.03) 2px,
rgba(0,0,0,0.03) 3px,
transparent 3px,
transparent 4px
),
/* Base steel gradient */
linear-gradient(135deg, #5A5A5A 0%, #3D3D3D 50%, #2A2A2A 100%) !important;
}        /* Steel Theme Tab Button Overrides */
        .theme-steel .tab-btn {
            background: linear-gradient(135deg, #9CA3AF, #6B7280);
            color: #FFFFFF;
            border: 1px solid #4B5563;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.2);
        }
        
        .theme-steel .tab-btn.active {
            background: linear-gradient(135deg, #4B5563, #374151);
            color: #FFFFFF;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .theme-steel .tab-btn:hover {
            background: linear-gradient(135deg, #6B7280, #4B5563);
            transform: none;
        }

        
        
        /* Dark Theme */
        .theme-dark {
            --primary-color: #3F51B5;          /* Muted Blue - subtle accent */
            --primary-light: #5C6BC0;          /* Lighter Blue */
            --primary-dark: #303F9F;           /* Darker Blue */
            --secondary-color: #424242;        /* Medium Gray */
            --accent-color: #757575;           /* Neutral Gray */
            --background-color: #121212;       /* Material Dark Background */
            --surface-color: #1E1E1E;          /* Elevated Surface */
            --text-primary: #E0E0E0;           /* Off-white text */
            --text-secondary: #A0A0A0;         /* Muted Gray text */
            --text-on-primary: #FFFFFF;        /* White text on blue */
            --border-color: #2D2D2D;           /* Subtle border */
            --success-color: #4CAF50;          /* Muted Green */
            --warning-color: #FF9800;          /* Muted Orange */
            --error-color: #F44336;            /* Muted Red */
            --info-color: #2196F3;             /* Muted Info Blue */
            --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            --gradient-surface: linear-gradient(135deg, var(--surface-color), var(--background-color));
        }
        
        /* Festool Theme */
        .theme-festool {
            --primary-color: #23AB08;          /* Festool Green */
            --primary-light: #3CC014;          /* Lighter Green */
            --primary-dark: #1A8806;           /* Darker Green */
            --secondary-color: #E2E2E2;        /* Festool Light Gray */
            --accent-color: #1C3448;           /* Festool Dark Blue-Gray */
            --background-color: #F8F8F8;       /* Light Gray */
            --surface-color: #FFFFFF;          /* White */
            --text-primary: #1C3448;           /* Dark Blue-Gray text */
            --text-secondary: #666666;         /* Medium Gray text */
            --text-on-primary: #FFFFFF;        /* White text on green */
            --border-color: #E2E2E2;           /* Light Gray border */
            --success-color: #23AB08;          /* Festool Green */
            --warning-color: #FF9800;          /* Orange */
            --error-color: #F44336;            /* Red */
            --info-color: #1C3448;             /* Dark Blue-Gray */
            --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            --gradient-surface: linear-gradient(135deg, var(--surface-color), var(--background-color));
        }
        
        /* Dewalt Theme */
        .theme-dewalt {
            --primary-color: #FEAA00;          /* Dewalt Yellow */
            --primary-light: #FFB41A;          /* Lighter Yellow */
            --primary-dark: #E09600;           /* Darker Yellow */
            --secondary-color: #333333;        /* Dark Gray */
            --accent-color: #1A1A1A;           /* Near Black */
            --background-color: #F5F5F5;       /* Light Gray */
            --surface-color: #FFFFFF;          /* White */
            --text-primary: #000000;           /* Black */
            --text-secondary: #333333;         /* Dark Gray */
            --text-on-primary: #000000;        /* Black text on yellow */
            --border-color: #CCCCCC;           /* Light Gray border */
            --success-color: #4CAF50;          /* Green */
            --warning-color: #FEAA00;          /* Dewalt Yellow */
            --error-color: #F44336;            /* Red */
            --info-color: #333333;             /* Dark Gray */
            --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            --gradient-surface: linear-gradient(135deg, var(--surface-color), var(--background-color));
        }

        /* Milwaukee Theme */
        .theme-milwaukee {
            --primary-color: #DB011C;          /* Milwaukee Red */
            --primary-light: #E23243;          /* Lighter Red */
            --primary-dark: #B80016;           /* Darker Red */
            --secondary-color: #2D2D2D;        /* Dark Gray */
            --accent-color: #000000;           /* Black */
            --background-color: #F8F8F8;       /* Light Gray */
            --surface-color: #FFFFFF;          /* White */
            --text-primary: #000000;           /* Black */
            --text-secondary: #2D2D2D;         /* Dark Gray */
            --text-on-primary: #FFFFFF;        /* White text on red */
            --border-color: #DDDDDD;           /* Light Gray border */
            --success-color: #28A745;          /* Green */
            --warning-color: #FFC107;          /* Amber */
            --error-color: #DB011C;            /* Milwaukee Red */
            --info-color: #2D2D2D;             /* Dark Gray */
            --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            --gradient-surface: linear-gradient(135deg, var(--surface-color), var(--background-color));
        }

        /* Ridgid Theme */
        .theme-ridgid {
            --primary-color: #F58025;          /* Ridgid Orange */
            --primary-light: #F79A4E;          /* Lighter Orange */
            --primary-dark: #DD6B1D;           /* Darker Orange */
            --secondary-color: #333333;        /* Dark Gray */
            --accent-color: #000000;           /* Black */
            --background-color: #F9F9F9;       /* Light Gray */
            --surface-color: #FFFFFF;          /* White */
            --text-primary: #000000;           /* Black */
            --text-secondary: #333333;         /* Dark Gray */
            --text-on-primary: #FFFFFF;        /* White text on orange */
            --border-color: #DDDDDD;           /* Light Gray border */
            --success-color: #28A745;          /* Green */
            --warning-color: #F58025;          /* Ridgid Orange */
            --error-color: #DC3545;            /* Red */
            --info-color: #333333;             /* Dark Gray */
            --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            --gradient-surface: linear-gradient(135deg, var(--surface-color), var(--background-color));
        }

        /* Makita Theme */
        .theme-makita {
            --primary-color: #007B8A;          /* Makita Teal */
            --primary-light: #00A3B5;          /* Lighter Teal */
            --primary-dark: #005A66;           /* Darker Teal */
            --secondary-color: #333333;        /* Dark Gray */
            --accent-color: #000000;           /* Black */
            --background-color: #F8F8F8;       /* Light Gray */
            --surface-color: #FFFFFF;          /* White */
            --text-primary: #000000;           /* Black */
            --text-secondary: #333333;         /* Dark Gray */
            --text-on-primary: #FFFFFF;        /* White text on teal */
            --border-color: #007B8A;           /* Teal borders */
            --hover-color: #F0F9FA;            /* Light teal hover */
            --shadow-color: rgba(0, 123, 138, 0.2); /* Teal shadow */
            --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            --gradient-surface: linear-gradient(135deg, var(--surface-color), var(--background-color));
        }

        /* Noob Theme (Ryobi) */
        .theme-noob {
            --primary-color: #C4E300;          /* Ryobi Lime Green */
            --primary-light: #D4F310;          /* Brighter Lime */
            --primary-dark: #A6C400;           /* Darker Green */
            --secondary-color: #333333;        /* Dark Gray */
            --accent-color: #000000;           /* Black */
            --background-color: #F8F8F8;       /* Light Gray */
            --surface-color: #FFFFFF;          /* White */
            --text-primary: #000000;           /* Black */
            --text-secondary: #333333;         /* Dark Gray */
            --text-on-primary: #000000;        /* Black text on lime */
            --border-color: #DDDDDD;           /* Light Gray border */
            --success-color: #C4E300;          /* Ryobi Green */
            --warning-color: #FFA500;          /* Orange */
            --error-color: #FF4444;            /* Red */
            --info-color: #333333;             /* Dark Gray */
            --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            --gradient-surface: linear-gradient(135deg, var(--surface-color), var(--background-color));
        }
        
        /* ----------------------------------------------------------------
           1.2 BASE STYLES & LAYOUT  
           ---------------------------------------------------------------- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            font-family: Arial, sans-serif;
            background: var(--primary-color);
            color: var(--text-primary);
            padding: 0;
            margin: 0;
            min-height: 100vh;
            overflow-x: hidden;
            transition: var(--theme-transition);
        }
        
        body {
            padding: 10px;
            background: var(--gradient-primary);
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: var(--background-color);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            position: relative;
            transition: var(--theme-transition);
            overflow: hidden;
        }
        
        .header-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px 0;
            background: var(--surface-color);
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header-top-row {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            position: relative;
            margin-bottom: 15px;
        }
        
        .header-top-row .dad-joke-btn {
            position: absolute;
            left: 20px;
        }
        
        .header-top-row .help-btn:not(.dad-joke-btn) {
            position: absolute;
            right: 20px;
        }
        
        h1 {
            color: var(--primary-color);
            font-size: 26px;
            font-weight: bold;
            margin: 0;
            transition: var(--theme-transition);
            white-space: nowrap;
            text-align: center;
        }
        
        .help-btn {
            background: var(--secondary-color);
            border: 2px solid var(--primary-color);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            color: var(--primary-color);
            font-weight: bold;
            font-size: 18px;
            cursor: pointer;
            z-index: 1000;
            position: relative;
            transition: var(--theme-transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .help-btn:hover {
            background: var(--primary-color);
            color: var(--text-on-primary);
            transform: scale(1.1);
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .theme-selector select,
        .mode-selector select {
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--background-color);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--theme-transition);
            min-width: 140px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .theme-selector select:focus,
        .mode-selector select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        
        .theme-selector select:hover,
        .mode-selector select:hover {
            border-color: var(--primary-color);
            background: var(--surface-color);
        }
        
        .tab-buttons {
            display: flex;
            margin-bottom: 15px;
            border-radius: 10px;
            overflow: hidden;
        }
        
        /* Global Project Selector */
        .global-project-selector {
            background: var(--gradient-primary);
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: var(--theme-transition);
        }
        
        .project-selector-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .project-label {
            color: var(--text-on-primary);
            font-weight: bold;
            font-size: 14px;
            transition: var(--theme-transition);
        }
        
        #globalProjectDropdown {
            padding: 6px 12px;
            border: 2px solid var(--border-color);
            border-radius: 5px;
            background: var(--background-color);
            color: var(--text-primary);
            font-size: 14px;
            min-width: 200px;
            cursor: pointer;
            transition: var(--theme-transition);
        }
        
        #globalProjectDropdown:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 5px rgba(139, 69, 19, 0.3);
        }
        
        .tab-btn {
            flex: 1 1 auto;
            padding: 12px 8px;
            background: var(--secondary-color);
            color: var(--primary-color);
            border: none;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--theme-transition);
            white-space: nowrap;
            min-width: fit-content;
        }
        
        /* Mobile optimization for main navigation tabs */
        @media (max-width: 768px) {
            .tab-btn {
                font-size: 11px;
                padding: 10px 4px;
                line-height: 1.2;
            }
        }
        
        @media (max-width: 600px) {
            .tab-btn {
                font-size: 10px;
                padding: 8px 2px;
            }
            
            /* Use shorter text for narrow screens */
            .tab-btn:nth-child(2) { font-size: 9px; }
            .tab-btn:nth-child(3) { font-size: 9px; }
        }
        
        @media (max-width: 480px) {
            .tab-buttons {
                gap: 2px;
                margin-bottom: 10px;
            }
            
            .tab-btn {
                font-size: 9px;
                padding: 8px 1px;
                min-height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                text-align: center;
                word-break: break-word;
                hyphens: auto;
            }
            
            /* Shorter labels for mobile */
            .tab-btn:nth-child(1) { content: "Calc"; }
            .tab-btn:nth-child(2) { content: "Cuts"; }
            .tab-btn:nth-child(3) { content: "Tools"; }
            .tab-btn:nth-child(4) { content: "📁 Files"; }
        }
        
        @media (max-width: 380px) {
            .tab-btn {
                font-size: 8px;
                padding: 6px 1px;
                min-height: 36px;
            }
            
            /* Ultra-compact for smallest screens */
            .tab-btn:nth-child(1)::after { content: "📊"; }
            .tab-btn:nth-child(2)::after { content: "✂️"; }
            .tab-btn:nth-child(3)::after { content: "🛠️"; }
            .tab-btn:nth-child(4)::after { content: "📁"; }
            
            .tab-btn {
                text-indent: -9999px;
                position: relative;
            }
            
            .tab-btn::after {
                position: absolute;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                text-indent: 0;
                font-size: 16px;
            }
        }
        
        .tab-btn.active {
            background: var(--primary-color);
            color: var(--text-on-primary);
        }
        
        /* Mobile header fixes */
        @media (max-width: 600px) {
            .header-top-row {
                padding: 0 10px;
            }
            
            .header-top-row .dad-joke-btn {
                left: 10px;
                font-size: 20px;
                padding: 5px;
            }
            
            .header-top-row .help-btn:not(.dad-joke-btn) {
                right: 10px;
                font-size: 16px;
                padding: 6px 10px;
            }
            
            h1 {
                font-size: 20px;
                padding: 0 50px; /* Space for buttons */
            }
            
            .header-controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .theme-selector, .mode-selector {
                width: 100%;
            }
            
            .theme-selector select, .mode-selector select {
                width: 100%;
                font-size: 14px;
                padding: 8px;
            }
        }
        
        @media (max-width: 480px) {
            h1 {
                font-size: 18px;
                padding: 0 45px;
            }
            
            .header-top-row .dad-joke-btn {
                font-size: 18px;
                padding: 4px;
            }
            
            .header-top-row .help-btn:not(.dad-joke-btn) {
                font-size: 14px;
                padding: 5px 8px;
            }
        }
        
        @media (max-width: 380px) {
            h1 {
                font-size: 16px;
                line-height: 1.2;
                padding: 0 40px;
            }
            
            .header-top-row .dad-joke-btn {
                font-size: 16px;
                left: 5px;
            }
            
            .header-top-row .help-btn:not(.dad-joke-btn) {
                right: 5px;
                padding: 4px 6px;
                font-size: 12px;
            }
        }
        
        .tab-content {
            display: none;
            position: relative;
            overflow: visible;
        }
        
        .tab-content.active {
            display: block;
        }
        
        
        /* Ensure specialty content is hidden when tab is not active */
        #specialty:not(.active) .calc-category-header {
            display: none !important;
        }
        
        
        /* Fix projects tab layout */
        #projects {
            width: 100%;
            max-width: 100%;
            overflow: hidden;
            position: relative;
        }
        
        .projects-dashboard {
            width: 100%;
            max-width: 100%;
            position: relative;
        }
        
        #projects .project-card,
        #projects .settings-panel,
        #projects .action-card {
            box-sizing: border-box;
            max-width: 100%;
            position: relative !important;
        }
        
        /* Ensure active project and recent projects stay within bounds */
        #activeProjectSection,
        #recentProjectsSection,
        .quick-actions-section {
            position: relative !important;
            width: 100% !important;
            max-width: 100% !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
        }
        
        .settings-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .settings-row label {
            font-weight: bold;
            min-width: 80px;
        }
        
        select, input {
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            background: var(--background-color);
            color: var(--text-primary);
            transition: var(--theme-transition);
        }
        
        /* Smart input standardized width - works with flexible card containers */
        input[id^="smart"],
        #smartGoldenRatio,
        #smartShelfLength,
        #smartShelfThickness,
        #smartTileLength,
        #smartTileWidth,
        .wide-input {
            width: 100%;
            max-width: 450px;
        }

        /* Ensure all input containers can accommodate smart inputs naturally */
        .input-row,
        .calc-inputs,
        .calculator-inputs,
        .calc-card,
        .calc-card-content {
            min-width: 0;
            width: 100%;
            overflow: visible;
        }

        /* Smart Input Feedback System */
        .input-preview {
            margin: 5px 0 10px 0;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            transition: all 0.3s ease;
        }

        .input-preview.success {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid #4CAF50;
            color: #2E7D32;
        }

        .input-preview.warning {
            background: rgba(255, 152, 0, 0.1);
            border: 1px solid #FF9800;
            color: #F57C00;
        }

        .input-preview.error {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid #F44336;
            color: #D32F2F;
        }

        /* Smart input validation states */
        .smart-input.valid {
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        .smart-input.invalid {
            border-color: #F44336;
            box-shadow: 0 0 0 2px rgba(244, 67, 54, 0.2);
        }

        .smart-input.warning {
            border-color: #FF9800;
            box-shadow: 0 0 0 2px rgba(255, 152, 0, 0.2);
        }
        
        .modal {
            display: none !important;
            position: fixed !important;
            z-index: 10000 !important;
            left: 0 !important;
            top: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background-color: rgba(0,0,0,0.5) !important;
        }
        
        .modal[style*="display: block"] {
            display: block !important;
            visibility: visible !important;
        }
        
        .modal-content {
            background-color: white !important;
            margin: 5% auto !important;
            padding: 30px !important;
            border-radius: 12px !important;
            width: 90% !important;
            max-width: 600px !important;
            max-height: 80vh !important;
            overflow-y: auto !important;
            display: block !important;
            position: relative !important;
            min-height: 200px !important;
            min-width: 300px !important;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3) !important;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        /* Save to Project Modal specific styles */
        .save-preview-section {
            margin-bottom: 20px;
        }
        
        .save-preview {
            background: #f8f9fa;
            border: 2px solid var(--secondary-color);
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            color: #333;
        }
        
        .save-preview-lumber .preview-header {
            font-size: 16px;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--secondary-color);
        }
        
        .save-preview-lumber .preview-summary {
            font-size: 14px;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .save-preview-lumber .preview-details {
            font-size: 12px;
            line-height: 1.4;
            color: #666;
        }
        
        .save-preview-cut .preview-header {
            font-size: 16px;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--secondary-color);
        }
        
        .save-preview-cut .preview-equation {
            font-size: 14px;
            margin-bottom: 8px;
            color: var(--primary-color);
        }
        
        .save-preview-cut .preview-result {
            font-size: 14px;
            margin-bottom: 10px;
            color: #28a745;
        }
        
        .save-preview-cut .preview-details {
            font-size: 12px;
            line-height: 1.4;
            color: #666;
        }
        
        .cut-result-actions {
            margin-top: 10px;
            text-align: center;
        }
        
        .save-preview-optimization .preview-header {
            font-size: 16px;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--secondary-color);
        }
        
        .save-preview-optimization .preview-equation {
            font-size: 14px;
            margin-bottom: 8px;
            color: var(--primary-color);
        }
        
        .save-preview-optimization .preview-result {
            font-size: 14px;
            margin-bottom: 8px;
            color: #28a745;
            font-weight: bold;
        }
        
        .save-preview-optimization .preview-summary {
            font-size: 13px;
            margin-bottom: 10px;
            color: #6f42c1;
            font-style: italic;
        }
        
        .save-preview-optimization .preview-details {
            font-size: 12px;
            line-height: 1.4;
            color: #666;
        }
        
        .save-preview-spacing .preview-header {
            font-size: 16px;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--secondary-color);
        }
        
        .save-preview-spacing .preview-equation {
            font-size: 14px;
            margin-bottom: 8px;
            color: var(--primary-color);
        }
        
        .save-preview-spacing .preview-result {
            font-size: 14px;
            margin-bottom: 10px;
            color: #28a745;
            font-weight: bold;
        }
        
        .save-preview-spacing .preview-marks {
            background: #f0f8f0;
            border: 1px solid #28a745;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
        }
        
        .save-preview-spacing .marks-header {
            font-weight: bold;
            color: #28a745;
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .save-preview-spacing .mark-item {
            font-size: 12px;
            color: #333;
            margin-bottom: 3px;
            font-family: monospace;
        }
        
        .save-preview-spacing .preview-summary {
            font-size: 12px;
            color: #666;
            font-style: italic;
            margin-top: 8px;
        }
        
        .save-project-selection {
            margin-bottom: 20px;
        }
        
        .save-notes-section {
            margin-bottom: 20px;
        }
        
        .save-preview h5 {
            margin: 0 0 10px 0;
            color: var(--primary-color);
            font-size: 16px;
        }
        
        /* Project Timeline Styles */
        .project-timeline-header {
            background: var(--gradient-primary);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            color: var(--text-on-primary);
            transition: var(--theme-transition);
        }
        
        .project-title-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .project-title-section h2 {
            margin: 0;
            color: white;
        }
        
        .project-actions {
            display: flex;
            gap: 10px;
        }
        
        .project-summary {
            border-top: 1px solid rgba(255,255,255,0.3);
            padding-top: 15px;
        }
        
        .project-info {
            border-top: 1px solid rgba(255,255,255,0.2);
            padding-top: 10px;
            margin-top: 10px;
        }
        
        .project-dates {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .project-date {
            color: rgba(255,255,255,0.8);
            font-size: 12px;
            font-style: italic;
        }
        
        .project-loader-section {
            border-top: 1px solid rgba(255,255,255,0.3);
            padding-top: 15px;
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .project-loader-label {
            color: rgba(255,255,255,0.9);
            font-weight: bold;
            font-size: 14px;
            margin: 0;
        }
        
        .project-loader-dropdown {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            color: white;
            padding: 8px 12px;
            font-size: 14px;
            min-width: 250px;
            cursor: pointer;
        }
        
        .project-loader-dropdown:focus {
            outline: none;
            border-color: rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.15);
        }
        
        .project-loader-dropdown option {
            background: var(--primary-color);
            color: white;
        }
        
        .project-timeline-container {
            min-height: 400px;
        }
        
        .project-timeline {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
        }
        
        /* Action card hover effects */
        .action-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .project-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .timeline-content {
            position: relative;
        }
        
        /* Timeline Item Styles */
        .timeline-item {
            position: relative;
            margin-bottom: 30px;
            padding: 0 0 0 40px;
        }
        
        .timeline-item:before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: -30px;
            width: 2px;
            background: var(--secondary-color);
        }
        
        .timeline-item:last-child:before {
            bottom: 20px;
        }
        
        .timeline-marker {
            position: absolute;
            left: 6px;
            top: 12px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            font-weight: bold;
        }
        
        .timeline-marker.calculator { background: #007bff; }
        .timeline-marker.golden { background: #ffc107; color: #333; }
        .timeline-marker.spacing { background: #28a745; }
        .timeline-marker.miter { background: #dc3545; }
        .timeline-marker.lumber { background: #6f42c1; }
        .timeline-marker.cut { background: #fd7e14; }
        .timeline-marker.optimizer { background: #20c997; }
        
        .timeline-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid var(--secondary-color);
        }
        
        .timeline-card-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .timeline-diagram {
            margin: 15px 0;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
            overflow: hidden;
        }
        
        .timeline-diagram-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #e9ecef;
            padding: 8px 12px;
            font-size: 0.9em;
            border-bottom: 1px solid #dee2e6;
        }
        
        .timeline-diagram-preview {
            padding: 12px;
            text-align: center;
        }
        
        .timeline-diagram-preview img {
            transition: transform 0.2s ease;
            border-radius: 4px;
        }
        
        .timeline-diagram-preview img:hover {
            transform: scale(1.05);
        }
        
        .timeline-tool-info {
            flex: 1;
        }
        
        .timeline-tool-name {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .timeline-timestamp {
            font-size: 12px;
            color: #666;
        }
        
        .timeline-actions {
            display: flex;
            gap: 5px;
        }
        
        .timeline-equation {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 14px;
            margin-bottom: 10px;
            color: #333;
        }
        
        .timeline-result {
            font-weight: bold;
            color: #28a745;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .timeline-details {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 10px;
            white-space: pre-line;
        }
        
        .timeline-notes {
            background: #fff9c4;
            border: 1px solid #f0e68c;
            border-radius: 4px;
            padding: 10px;
            font-style: italic;
            color: #856404;
            margin-top: 10px;
        }
        
        .timeline-notes:before {
            content: '💡 ';
            font-style: normal;
        }
        
        /* All Projects Modal */
        .projects-modal-content {
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .projects-grid-modal {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        /* Mobile responsive - actual mobile devices */
        @media (max-width: 768px) and (hover: none) and (pointer: coarse) {
            .project-title-section {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .project-actions {
                justify-content: center;
            }
        }
        
            
            .summary-stats {
                justify-content: center;
                text-align: center;
            }
            
            .timeline-item {
                padding-left: 30px;
            }
            
            .timeline-marker {
                left: 1px;
                width: 16px;
                height: 16px;
                font-size: 10px;
            }
            
            .projects-grid-modal {
                grid-template-columns: 1fr;
            }
            
            .project-loader-section {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .project-loader-dropdown {
                min-width: 100%;
            }
        }
        
        .input-mode-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .input-group {
            display: flex;
            gap: 5px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .input-group input {
            width: 80px;
            text-align: center;
        }
        
        /* Override for smart inputs in input-group - they need full width */
        .input-group input.smart-input {
            width: 450px;
            max-width: 450px;
            text-align: left;
        }
        
        .input-group select {
            width: 100px;
        }
        
        .input-group label {
            font-weight: bold;
            margin-right: 5px;
        }
        
        .current-value {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            border: 2px solid var(--primary-color);
        }
        
        /* ----------------------------------------------------------------
           1.3 CALCULATOR STYLES
           ---------------------------------------------------------------- */
        /* Calculator display styles */
        .calc-display {
            background: #2F1B14 !important; /* Dark brown background */
            color: #fff !important; /* White text */
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .calc-equation {
            font-size: 16px;
            color: #ccc;
            min-height: 24px;
            margin-bottom: 5px;
        }
        
        .calc-display .calc-result {
            font-size: 28px;
            font-weight: bold;
            text-align: center;
            min-height: 40px;
            word-break: break-all;
            color: #4CAF50 !important; /* Always green like validation text */
        }
        
        .calc-display .calc-result.has-value {
            color: #4CAF50 !important; /* Green for valid results */
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .calc-result.has-value:hover {
            background-color: rgba(76, 175, 80, 0.1);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .calc-result.negative-result {
            color: #FF5722;
            background-color: rgba(255, 87, 34, 0.1);
            border: 1px solid rgba(255, 87, 34, 0.3);
            cursor: default;
        }
        
        .calc-result.negative-result:hover {
            background-color: rgba(255, 87, 34, 0.15);
            transform: none;
        }
        
        .result-hint {
            text-align: center;
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            margin-bottom: 15px;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }
        
        .result-hint:hover {
            opacity: 1;
        }
        
        .result-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            margin: 10px 0;
            text-align: center;
            font-weight: 500;
        }
        
        .calc-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .calc-btn {
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            background: #f5f5f5;
            color: #212121;
            min-height: 55px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .calc-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }
        
        .calc-btn:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .calc-btn.operation {
            background: #ff9500;
            color: white;
            font-size: 22px;
        }
        
        .calc-btn.equals {
            background: #4CAF50;
            color: white;
            grid-column: span 2;
        }
        
        .calc-btn.save {
            background: #28a745;
            color: white;
        }
        
        .calc-btn.unit {
            background: #007aff;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }
        
        .calc-btn.clear {
            background: #ff3b30;
            color: white;
        }
        
        .calc-btn.memory {
            background: #616161;
            color: white;
            font-size: 14px;
        }
        
        .calc-btn.number {
            background: #ffffff;
            color: #000000;
            font-size: 20px;
        }
        
        .calc-btn.measurement {
            background: #9C27B0;
            color: white;
            font-size: 16px;
        }
        
        .calc-btn.fraction {
            background: #673ab7;
            color: white;
            font-size: 14px;
        }
        
        /* Keypad Layout */
        .calc-keypad {
            margin: 15px 0;
            max-width: 320px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .keypad-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .keypad-row.keypad-memory {
            margin-bottom: 12px;
        }
        
        .keypad-row.keypad-fractions {
            margin-bottom: 6px;
        }
        
        .keypad-zero {
            grid-column: span 1;
        }
        
        .calc-btn.space {
            grid-column: span 2;
            background: #E3F2FD;
            color: #1976D2;
            font-weight: 600;
        }
        
        .calc-btn.backspace {
            background: #757575;
            color: white;
        }
        
        .calc-btn.metric {
            background: #00BFA5;
            color: white;
        }
        
        .calc-btn.unit {
            background: #007AFF;
            color: white;
        }
        
        /* Responsive adjustments */
        @media (max-width: 480px) {
            .calc-keypad {
                max-width: 280px;
            }
            
            .calc-btn {
                padding: 12px 8px;
                font-size: 16px;
            }
            
            .calc-btn.fraction,
            .calc-btn.memory {
                font-size: 12px;
            }
        }
        
        .memory-display {
            position: absolute;
            top: 5px;
            right: 10px;
            font-size: 12px;
            color: var(--secondary-color);
        }
        
        .conversion-section {
            margin-bottom: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e9ecef;
        }
        
        .conversion-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 0;
        }
        
        .conversion-grid .btn {
            font-size: 14px;
            font-weight: 600;
            padding: 12px 16px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .conversion-grid .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .conversion-input-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .conversion-input-row label {
            font-weight: bold;
            color: var(--primary-color);
            min-width: 80px;
        }
        
        .conversion-preview {
            background: #ffffff;
            border: 2px solid var(--primary-color);
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 15px;
            font-size: 15px;
            text-align: center;
            font-size: 14px;
            color: #666;
        }
        
        #conversionValue {
            font-weight: bold;
            color: var(--primary-color);
        }
        
        /* WorkShop Pro Calculator Styles */
        .woodworking-calcs-section {
            margin-bottom: 20px;
        }
        
        .calc-card {
            border: 2px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 10px;
            background: #e3f2fd;
            overflow: visible;
            transition: var(--theme-transition);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .calc-card-header {
            background: transparent;
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            user-select: none;
            transition: var(--theme-transition);
            color: var(--primary-color);
            position: relative;
        }
        
        .calc-help-btn {
            position: absolute;
            right: 40px;
            background: none;
            border: 1px solid #ddd;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            color: #666;
            transition: all 0.2s;
        }
        
        .calc-help-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .calc-card-header:hover {
            background: rgba(139, 69, 19, 0.1);
        }
        
        .calc-icon {
            font-size: 18px;
        }
        
        .calc-title {
            flex: 1;
            font-weight: bold;
            color: inherit;
        }
        
        .calc-arrow {
            transition: transform 0.3s;
            color: inherit;
        }
        
        .calc-card.expanded .calc-arrow {
            transform: rotate(180deg);
        }
        
        .calc-card-content {
            display: none;
            padding: 20px;
            background: transparent;
            transition: var(--theme-transition);
        }
        
        .calc-card.expanded .calc-card-content {
            display: block;
        }
        
        
        
        /* Category header styles */
        .calc-category-header {
            transition: all 0.2s ease;
        }
        
        .calc-category-header:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }
        
        .category-arrow {
            color: var(--text-on-primary);
            font-weight: bold;
            transition: transform 0.3s;
        }

            
            .search-row {
                flex-direction: column;
            }
            
            .search-row input, .search-row select {
                width: 100%;
            }
            
            .wizard-buttons {
                flex-direction: column;
            }
            
            .wizard-buttons .btn {
                width: 100%;
            }
        }
        
        .calc-description {
            color: var(--text-secondary);
            margin-bottom: 15px;
            font-style: italic;
        }
        
        .calc-visual {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            overflow: visible;
        }
        
        /* Specific styling for miter angle diagram container */
        #angleCard .calc-visual {
            min-height: 220px; /* Reserve space for enhanced diagrams */
            margin-bottom: 0;
            position: relative;
        }
        
        /* Ensure proper spacing for calculators */
        .calc-card {
            margin-bottom: 10px !important;
        }
        
        .calc-inputs {
            margin-bottom: 20px;
        }
        
        .input-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }
        
        .input-row label {
            min-width: 120px;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .input-row input {
            flex: 1;
            max-width: 150px;
            padding: 8px;
            border: 2px solid var(--secondary-color);
            border-radius: 4px;
        }
        
        .input-row .unit {
            font-size: 12px;
            color: #666;
            min-width: 50px;
        }
        
        .calc-result {
            background: #f8f9fa;
            border: 1px solid var(--secondary-color);
            border-radius: 5px;
            padding: 15px;
            text-align: center;
        }
        
        .result-display {
            font-size: 16px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        /* Board Foot Calculator Visuals */
        .lumber-diagram {
            width: 200px;
            height: 120px;
            position: relative;
            background: #f0f0f0;
            border: 2px solid var(--primary-color);
            border-radius: 4px;
        }
        
        .lumber-piece {
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, var(--accent-color), var(--secondary-color));
            position: relative;
            overflow: hidden;
        }
        
        .lumber-piece::before {
            content: '';
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            border: 1px dashed var(--primary-color);
            border-radius: 2px;
        }
        
        .dimension-label {
            position: absolute;
            background: rgba(255,255,255,0.9);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .dimension-label.top {
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .dimension-label.left {
            left: -35px;
            top: 50%;
            transform: translateY(-50%) rotate(-90deg);
        }
        
        .dimension-label.right {
            right: -35px;
            top: 50%;
            transform: translateY(-50%) rotate(90deg);
        }
        
        /* Lumber Cart Styles */
        .cart-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
        }
        
        .cart-section {
            margin-top: 20px;
            border-top: 2px solid var(--secondary-color);
            padding-top: 15px;
        }
        
        .cart-display {
            background: #f8f9fa;
            border: 1px solid var(--secondary-color);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--secondary-color);
        }
        
        .cart-header h4 {
            margin: 0;
            color: var(--primary-color);
        }
        
        .cart-items {
            margin-bottom: 15px;
        }
        
        .cart-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .cart-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .cart-item-header strong {
            color: var(--primary-color);
            font-size: 16px;
        }
        
        .btn-remove {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        
        .btn-remove:hover {
            background: #c82333;
        }
        
        .cart-item-details {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .cart-item-pricing {
            font-size: 14px;
            color: #495057;
        }
        
        .cart-summary {
            background: #e9f7ef;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            padding: 10px;
        }
        
        .cart-bottom-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .cart-bottom-actions button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        /* ----------------------------------------------------------------
           1.4 CUT CALCULATOR & OPTIMIZATION STYLES
           ---------------------------------------------------------------- */
        /* Frame Builder Cut List Styles */
        .cut-list {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border: 1px solid var(--secondary-color);
            border-radius: 4px;
        }
        
        .cut-list h4 {
            margin: 0 0 8px 0;
            color: var(--primary-color);
            font-size: 14px;
        }
        
        .cut-item {
            padding: 4px 0;
            color: #2F1B14;
            font-weight: bold;
            border-bottom: 1px solid #e9ecef;
        }
        
        .cut-item:last-child {
            border-bottom: none;
        }
        
        .cut-item small {
            color: #6c757d;
            font-weight: normal;
            font-size: 12px;
        }
        
        /* Golden Ratio Calculator Visuals */
        .golden-diagram {
            width: 200px;
            height: 120px;
        }
        
        .golden-rectangle {
            width: 100%;
            height: 100%;
            border: 2px solid var(--primary-color);
            border-radius: 4px;
            display: flex;
            position: relative;
        }
        
        .golden-small {
            flex: 1;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border-right: 1px solid var(--primary-color);
        }
        
        .golden-large {
            flex: 1.618;
            background: linear-gradient(135deg, #F0E68C, #DDD700);
        }
        
        .ratio-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: bold;
            color: var(--primary-color);
            font-size: 14px;
        }
        
        .calc-mode-selector {
            display: flex;
            margin-bottom: 15px;
            border-radius: 6px;
            overflow: hidden;
            border: 2px solid var(--secondary-color);
        }
        
        .mode-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: #f8f9fa;
            color: var(--primary-color);
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .mode-btn.active {
            background: var(--primary-color);
            color: white;
        }
        
        /* Spacing Calculator Visuals */
        .spacing-diagram {
            width: 100%;
            height: 240px;
            position: relative;
            overflow-y: auto;
            overflow-x: auto;
        }
        
        .spacing-line {
            width: 100%;
            height: 20px;
            background: var(--accent-color);
            border: 2px solid var(--primary-color);
            border-radius: 4px;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
        }
        
        .spacing-marker {
            width: 3px;
            height: 40px;
            background: var(--primary-color);
            border-radius: 1px;
            position: relative;
        }
        
        .spacing-marker::after {
            content: '';
            position: absolute;
            top: -5px;
            left: -2px;
            width: 7px;
            height: 10px;
            background: #654321;
            border-radius: 2px;
        }
        
        /* Angle Calculator Visuals */
        .angle-diagram {
            width: 120px;
            height: 120px;
        }
        
        .polygon-shape {
            width: 100%;
            height: 100%;
            position: relative;
            border: 2px solid var(--primary-color);
            border-radius: 4px;
            background: linear-gradient(45deg, #F5DEB3, var(--secondary-color));
        }
        
        .angle-line {
            position: absolute;
            width: 2px;
            height: 40px;
            background: var(--primary-color);
            transform-origin: bottom center;
        }
        
        .preset-buttons {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .preset-btn {
            padding: 6px 12px;
            border: 1px solid var(--secondary-color);
            background: #f8f9fa;
            color: var(--primary-color);
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .preset-btn:hover {
            background: var(--primary-color);
            color: white;
        }
        
        .preset-section {
            background: #f9f9f9;
            border: 2px solid var(--secondary-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .preset-section h4 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .preset-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }
        
        .history-clickable {
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .history-clickable:hover {
            background: #e8f5e8;
        }
        
        .history-timestamp {
            font-size: 10px;
            color: #999;
            float: right;
        }
        
        .history-result {
            background: #e8f5e8;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #4CAF50;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .history-conversion {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #2196F3;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .history-preset {
            background: #fff3e0;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #ff9800;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .history-equation {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: bold;
            color: #2F1B14;
        }
        
        .history-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        
        /* Modal for calculations */
        .calc-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .calc-modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .calc-modal h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .calc-modal .input-group {
            margin-bottom: 15px;
        }
        
        .calc-modal .btn {
            margin-right: 10px;
        }
        
        .button-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .quick-cuts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .quick-cuts .btn {
            padding: 12px 8px;
            font-size: 14px;
        }
        
        .btn {
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--theme-transition);
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: var(--text-on-primary);
        }
        
        .btn-primary:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: var(--secondary-color);
            color: var(--primary-color);
        }
        
        .btn-secondary:hover {
            background: var(--accent-color);
            transform: translateY(-2px);
        }
        
        .btn-operation {
            background: var(--secondary-color);
            color: var(--primary-color);
        }
        
        .btn-operation.active {
            background: var(--primary-color);
            color: var(--text-on-primary);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
        
        /* Mode Toggle Styles */
        .mode-toggle-section {
            margin-bottom: 20px;
        }
        
        .mode-toggle {
            display: flex;
            background: #f5f5f5;
            border-radius: 10px;
            padding: 4px;
            gap: 2px;
        }
        
        .mode-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            background: transparent;
            color: #666;
        }
        
        .mode-btn:hover {
            background: #e0e0e0;
            color: #333;
        }
        
        .mode-btn.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 2px 8px rgba(139, 69, 19, 0.3);
            transform: translateY(-1px);
        }
        
        /* Visual Board Representation */
        .visual-board {
            margin: 15px 0;
            padding: 20px;
            background: #f8f8f8;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .board-container {
            position: relative;
            height: 80px;
            background: #DEB887;
            background-image: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 8px,
                    rgba(160, 82, 45, 0.2) 8px,
                    rgba(160, 82, 45, 0.2) 9px
                ),
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 15px,
                    rgba(160, 82, 45, 0.15) 15px,
                    rgba(160, 82, 45, 0.15) 16px
                ),
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 25px,
                    rgba(160, 82, 45, 0.18) 25px,
                    rgba(160, 82, 45, 0.18) 26px
                );
            border: 3px solid #8B4513;
            border-radius: 2px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .cut-mark {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #dc3545;
            box-shadow: 0 0 4px rgba(220, 53, 69, 0.5);
            z-index: 3;
        }
        
        .cut-mark::before {
            content: '';
            position: absolute;
            top: -8px;
            left: -3px;
            width: 8px;
            height: 8px;
            background: #dc3545;
            border-radius: 50%;
        }
        
        .cut-mark::after {
            content: attr(data-mark);
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            font-weight: bold;
            color: #dc3545;
            white-space: nowrap;
            background: white;
            padding: 2px 4px;
            border-radius: 3px;
            border: 1px solid #dc3545;
        }
        
        .kerf-cutout {
            position: absolute;
            top: 10px;
            bottom: 10px;
            background: rgba(220, 53, 69, 0.3);
            border: 1px dashed #dc3545;
            z-index: 2;
        }
        
        .kerf-cutout.left-side {
            border-right: 2px solid #dc3545;
        }
        
        .kerf-cutout.right-side {
            border-left: 2px solid #dc3545;
        }
        
        .board-ends {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 6px;
            background: #8B4513;
            box-shadow: 0 0 3px rgba(0, 0, 0, 0.2);
        }
        
        .board-ends.left {
            left: -6px;
            border-radius: 3px 0 0 3px;
        }
        
        .board-ends.right {
            right: -6px;
            border-radius: 0 3px 3px 0;
        }
        
        .board-dimension {
            text-align: center;
            margin-top: 15px;
            color: var(--primary-color);
            font-weight: bold;
            font-size: 14px;
        }
        
        .piece-labels {
            position: relative;
            height: 20px;
            margin-top: 40px;
        }
        
        .piece-label {
            position: absolute;
            font-size: 11px;
            color: #666;
            text-align: center;
            top: 0;
        }
        
        /* Marking Guide Styles */
        .marking-guide {
            margin: 15px 0;
            padding: 15px;
            background: #fff9e6;
            border: 1px solid #856404;
            border-radius: 8px;
        }
        
        .marking-guide .marks-header {
            font-weight: bold;
            color: #856404;
            font-size: 14px;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .marks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .marking-guide .mark-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 10px;
            background: white;
            border: 1px solid #d4d4aa;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .marking-guide .mark-number {
            font-weight: bold;
            color: #856404;
        }
        
        .marking-guide .mark-value {
            font-weight: bold;
            color: #2c5234;
        }
        
        .marking-summary {
            border-top: 1px solid #d4d4aa;
            padding-top: 10px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .summary-item {
            font-size: 12px;
            color: #555;
            text-align: center;
        }
        
        /* Screw Calculator Styles */
        .screw-identification {
            margin-bottom: 20px;
        }
        
        /* Pilot Hole Results Styling */
        .result-card {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: left;
        }
        
        .result-card h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .pilot-hole-result {
            background: linear-gradient(135deg, #f0f8ff, #e6f2ff);
            border: 2px solid #4CAF50;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .pilot-hole-result h3 {
            margin: 0 0 15px 0;
            color: #2e7d32;
            font-size: 20px;
            white-space: nowrap;
        }
        
        .drill-bit-size {
            font-size: 36px;
            font-weight: bold;
            color: #1565c0;
            margin: 10px 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        .calculation-note {
            font-size: 14px;
            color: #666;
            font-style: italic;
            margin: 10px 0 0 0;
        }
        
        .drilling-tips {
            background: #fff8dc;
            border: 1px solid var(--secondary-color);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            text-align: left;
        }
        
        .drilling-tips h4 {
            margin: 0 0 10px 0;
            color: var(--primary-color);
            font-size: 18px;
            text-align: left;
        }
        
        .drilling-tips ul {
            margin: 0;
            padding-left: 20px;
            list-style-type: none;
            text-align: left;
        }
        
        .drilling-tips ul li {
            position: relative;
            padding-left: 20px;
            margin-bottom: 8px;
            color: #555;
            line-height: 1.5;
            text-align: left;
            word-wrap: break-word;
            hyphens: none;
        }
        
        .drilling-tips ul li:before {
            content: "•";
            position: absolute;
            left: 0;
            color: var(--primary-color);
            font-weight: bold;
            font-size: 18px;
        }
        
        /* Quick Reference Table Styles */
        .reference-table-container {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .screw-reference-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .screw-reference-table th {
            background: var(--primary-color);
            color: white;
            padding: 10px 8px;
            text-align: center;
            font-size: 14px;
            border: 1px solid var(--primary-dark);
        }
        
        .screw-reference-table td {
            padding: 8px;
            text-align: center;
            border: 1px solid #ddd;
            font-size: 13px;
        }
        
        .screw-reference-table tbody tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        .screw-reference-table tbody tr:hover {
            background: #f0f8ff;
        }
        
        .screw-reference-table .screw-category {
            background: #f5f5f5;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .screw-reference-table .lag-bolt {
            background: #fff8dc;
        }
        
        .identification-tabs {
            display: flex;
            gap: 2px;
            margin-bottom: 15px;
            background: #f5f5f5;
            padding: 3px;
            border-radius: 8px;
        }
        
        .id-tab {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: transparent;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            color: #666;
        }
        
        .id-tab:hover {
            background: #e0e0e0;
            color: #333;
        }
        
        .id-tab.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 2px 4px rgba(139, 69, 19, 0.3);
        }
        
        .screw-size-circles {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 20px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 15px 0;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .screw-size-circles.lag-bolts {
            background: #F5F5DC;
            border: 2px solid var(--primary-color);
        }
        
        .size-circle-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .size-circle-container:hover {
            background: #f0f8ff;
            transform: scale(1.05);
        }
        
        .size-circle {
            background: #333;
            border-radius: 50%;
            border: 2px solid #666;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .size-circle.selected {
            background: #28A745;
            border-color: #1E7E34;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.3);
        }
        
        .size-circle.lag-bolt {
            background: var(--primary-color);
            border-color: #654321;
        }
        
        .size-circle.lag-bolt:hover {
            background: var(--primary-light);
            border-color: var(--primary-color);
        }
        
        .size-circle.lag-bolt.selected {
            background: #28A745;
            border-color: #1E7E34;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.3);
        }
        
        .common-screw-btn.selected {
            background-color: #28A745;
            color: white;
            border-color: #1E7E34;
        }
        
        .common-screw-btn.lag-btn {
            background-color: #F5F5DC;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }
        
        .common-screw-btn.lag-btn:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        .common-screw-btn.lag-btn.selected {
            background-color: #28A745;
            color: white;
            border-color: #1E7E34;
        }
        
        .wood-btn.selected {
            background-color: var(--primary-color);
            color: white;
            border-color: #654321;
        }
        
        /* Calibration Ruler */
        .zoom-calibration {
            background: #FFF3CD;
            border: 1px solid #FFC107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .calibration-ruler {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .inch-line {
            width: 96px; /* 96px = 1 inch at 96 DPI */
            height: 3px;
            background: linear-gradient(to right, #000 0%, #000 10%, transparent 10%, transparent 90%, #000 90%, #000 100%);
            border-top: 2px solid #000;
            border-bottom: 2px solid #000;
            position: relative;
        }
        
        .inch-line::before {
            content: '';
            position: absolute;
            left: 0;
            top: -5px;
            width: 2px;
            height: 13px;
            background: #000;
        }
        
        .inch-line::after {
            content: '';
            position: absolute;
            right: 0;
            top: -5px;
            width: 2px;
            height: 13px;
            background: #000;
        }
        
        .ruler-label {
            font-weight: bold;
            color: #856404;
        }
        
        .calibration-note {
            font-size: 0.9em;
            color: #856404;
            margin-top: 10px;
        }
        
        .size-circle:hover {
            background: var(--primary-color);
            border-color: var(--primary-color);
            box-shadow: 0 0 8px rgba(139, 69, 19, 0.4);
        }
        
        .size-label {
            font-size: 11px;
            font-weight: bold;
            color: #666;
            text-align: center;
            line-height: 1.2;
        }
        
        .common-screw-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .common-screw-btn {
            padding: 12px 8px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .common-screw-btn:hover {
            border-color: var(--primary-color);
            background: #f9f9f9;
            transform: translateY(-2px);
        }
        
        .common-screw-btn strong {
            color: var(--primary-color);
            display: block;
            margin-bottom: 4px;
        }
        
        .common-screw-btn small {
            color: #666;
            font-size: 10px;
        }
        
        .measurement-help {
            margin-top: 10px;
            padding: 8px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
        }
        
        .measurement-units {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .measurement-units label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        
        .selected-screw, .wood-selection {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        
        .wood-type-buttons {
            display: flex;
            gap: 15px;
            margin: 15px 0;
        }
        
        .wood-btn {
            flex: 1;
            padding: 15px 10px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-weight: bold;
        }
        
        .wood-btn:hover {
            border-color: var(--primary-color);
            background: #f9f9f9;
            transform: translateY(-2px);
        }
        
        .wood-btn.selected {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: white;
        }
        
        .wood-btn small {
            display: block;
            font-weight: normal;
            font-size: 11px;
            margin-top: 4px;
        }
        
        .btn-success {
            background: var(--success-color);
            color: var(--text-on-primary);
        }
        
        .btn-success:hover {
            background: var(--success-color);
            filter: brightness(0.9);
        }
        
        .btn-warning {
            background: var(--warning-color);
            color: var(--text-on-primary);
        }
        
        .btn-warning:hover {
            background: var(--warning-color);
            filter: brightness(0.9);
        }
        
        /* Removed old project management bar styles - now using cleaner status indicators */
        
        /* Enhanced Spacing Calculator Results */
        .result-summary {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 3px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .summary-row:last-child {
            border-bottom: none;
        }
        
        .summary-label {
            font-weight: bold;
            color: #495057;
            font-size: 12px;
        }
        
        .summary-value {
            color: #212529;
            font-family: monospace;
            font-size: 13px;
        }
        
        .divider-marks {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }
        
        .marks-header {
            font-weight: bold;
            color: #856404;
            font-size: 13px;
            margin-bottom: 8px;
            text-align: center;
        }
        
        .divider-mark-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid rgba(133, 100, 4, 0.2);
        }
        
        .divider-mark-row:last-child {
            border-bottom: none;
        }
        
        .divider-label {
            font-weight: bold;
            color: #856404;
            font-size: 12px;
            flex: 1;
        }
        
        .mark-left, .mark-right {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #856404;
            border-radius: 3px;
            padding: 2px 6px;
            font-family: monospace;
            font-size: 11px;
            font-weight: bold;
            margin: 0 2px;
        }
        
        .mark-left {
            color: #d73502;
        }
        
        .mark-right {
            color: #0f5132;
        }
        
        .mark-center {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #6c757d;
            border-radius: 3px;
            padding: 2px 6px;
            font-family: monospace;
            font-size: 11px;
            font-weight: bold;
            color: #495057;
            margin: 0 2px;
        }
        
        /* Force scrollbar visibility */
        .spacing-diagram-container {
            scrollbar-width: auto !important;
            scrollbar-color: #007bff #f8f9fa !important;
        }
        
        .spacing-diagram-container::-webkit-scrollbar {
            height: 12px !important;
        }
        
        .spacing-diagram-container::-webkit-scrollbar-track {
            background: #f8f9fa !important;
            border-radius: 6px !important;
        }
        
        .spacing-diagram-container::-webkit-scrollbar-thumb {
            background: #007bff !important;
            border-radius: 6px !important;
        }
        
        .spacing-diagram-container::-webkit-scrollbar-thumb:hover {
            background: #0056b3 !important;
        }
        
        /* Visual Layout Styles */
        .board-visualization {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border: 2px solid var(--secondary-color);
            border-radius: 8px;
            overflow-x: auto;
        }
        
        .visual-board {
            margin-bottom: 20px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
            position: relative;
        }
        
        .board-header {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .board-visual {
            height: 40px;
            background: linear-gradient(45deg, var(--secondary-color), #F5DEB3);
            border: 2px solid var(--primary-color);
            border-radius: 4px;
            position: relative;
            margin-bottom: 5px;
            overflow: hidden;
        }
        
        .cut-segment {
            position: absolute;
            height: 100%;
            border-right: 2px solid var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            color: #654321;
            text-shadow: 1px 1px 1px rgba(255,255,255,0.7);
        }
        
        .cut-segment.used {
            background: rgba(40, 167, 69, 0.3);
        }
        
        .cut-segment.waste {
            background: rgba(220, 53, 69, 0.3);
        }
        
        .cut-segment.kerf {
            background: rgba(0, 0, 0, 0.2);
            width: 2px !important;
            border-right: none;
        }
        
        .board-stats {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .visual-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .efficiency-summary {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
        }
        
        .efficiency-good {
            background: #d4edda;
            border-color: #c3e6cb;
        }
        
        .efficiency-poor {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        
        /* Projects Tab Styles */
        .projects-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .projects-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .current-project-section {
            margin-bottom: 30px;
        }
        
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .project-card {
            background: white;
            border: 2px solid var(--secondary-color);
            border-radius: 10px;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        
        .project-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .project-card.current-project {
            border-color: #28a745;
            background: linear-gradient(145deg, #f8fff9, #ffffff);
        }
        
        .project-card-content {
            padding: 15px;
        }
        
        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .project-header h4 {
            margin: 0;
            color: var(--primary-color);
            font-size: 16px;
        }
        
        .project-actions {
            display: flex;
            gap: 5px;
        }
        
        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
            min-width: auto;
        }
        
        .project-stats {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .stat {
            font-size: 12px;
            color: #666;
            background: #f8f9fa;
            padding: 3px 6px;
            border-radius: 3px;
        }
        
        .project-preview {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            min-height: 60px;
        }
        
        .preview-message {
            color: #999;
            font-style: italic;
            text-align: center;
            padding: 15px;
        }
        
        .project-preview-boards {
            display: flex;
            gap: 5px;
            margin-bottom: 5px;
            flex-wrap: wrap;
        }
        
        .preview-board {
            background: linear-gradient(45deg, var(--secondary-color), #F5DEB3);
            border: 1px solid var(--primary-color);
            border-radius: 2px;
            padding: 2px 4px;
            font-size: 10px;
            color: #654321;
        }
        
        .project-notes-preview {
            font-size: 11px;
            color: #666;
            max-height: 30px;
            overflow: hidden;
            margin-top: 5px;
            line-height: 1.3;
        }
        
        .project-date {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }
        
        .no-projects {
            grid-column: 1/-1;
        }
        
        
        @media (max-width: 600px) {
            .visual-controls {
                justify-content: center;
            }
            
            .board-visual {
                height: 50px;
            }
            
            .cut-segment {
                font-size: 10px;
            }
            
            .projects-header {
                flex-direction: column;
                text-align: center;
            }
            
            .projects-actions {
                justify-content: center;
            }
            
            .projects-grid {
                grid-template-columns: 1fr;
            }
            
            .project-stats {
                justify-content: center;
            }
            
            .project-status-bar {
                padding: 6px 10px;
                font-size: 12px;
            }
        }
        
        .manual-calc {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .history {
            max-height: 200px;
            overflow-y: auto;
            background: #f9f9f9;
            border: 2px solid var(--secondary-color);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
        }
        
        .history-item {
            padding: 8px;
            border-bottom: 1px solid #ddd;
            font-family: monospace;
            font-size: 14px;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .waste-section {
            margin-bottom: 20px;
        }
        
        .waste-section h3 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .board-input, .cut-input {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .results {
            background: #e8f5e8;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .cut-plan {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-family: monospace;
        }
        
        /* Visual diagram styles */
        .kerf-diagram {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 15px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .board-diagram {
            position: relative;
            width: 300px;
            height: 60px;
            background: linear-gradient(180deg, #D2691E 0%, var(--primary-color) 100%);
            border: 2px solid #654321;
            border-radius: 2px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .mark-line {
            position: absolute;
            top: -10px;
            width: 2px;
            height: 80px;
            background: #ff0000;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .mark-label {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            font-weight: bold;
            color: #ff0000;
            white-space: nowrap;
        }
        
        .kerf-area {
            position: absolute;
            top: 0;
            height: 100%;
            background: rgba(0,0,0,0.5);
            border: 1px dashed #fff;
        }
        
        .kerf-area.right {
            left: 50%;
            width: 10px;
        }
        
        .kerf-area.left {
            right: 50%;
            width: 10px;
        }
        
        .diagram-label {
            position: absolute;
            bottom: -20px;
            font-size: 11px;
            white-space: nowrap;
        }
        
        .left-piece {
            left: 10px;
        }
        
        .right-piece {
            right: 10px;
        }
        
        /* Cut result styles */
        .cut-results {
            background: #f5f5f5;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .cut-results h4 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .mark-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .mark-item {
            background: white;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .mark-item .mark-number {
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .mark-item .mark-value {
            font-family: monospace;
            font-size: 16px;
            font-weight: bold;
        }
        
        .piece-info {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            color: #2e7d32;
        }
        
        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #f44336;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 3000;
            opacity: 0;
            transition: opacity 0.3s;
            max-width: 80%;
            text-align: center;
            font-weight: bold;
        }
        
        .notification.show {
            opacity: 1;
        }
        
        .notification.success {
            background: #4CAF50;
        }
        
        .notification.warning {
            background: #ff9800;
        }
        
        /* Edit modal styles */
        .edit-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .edit-modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .edit-modal h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .edit-modal .input-group {
            margin-bottom: 15px;
        }
        
        .edit-modal .btn {
            margin-right: 10px;
        }

        /* Tile Calculator Styles */
        .pattern-preview {
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            background: white;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 15px 0;
        }

        .pattern-preview svg {
            max-width: 100%;
            max-height: 180px;
            border: 1px solid #eee;
        }

        .tile-results {
            background: var(--secondary-bg);
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }

        .tile-results h4 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .tile-result-summary,
        .tile-quantity-section,
        .tile-cost-section {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .tile-cost-section {
            border-bottom: none;
        }
        
        .tile-preview {
            background: var(--secondary-bg);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            text-align: center;
            border: 1px solid #eee;
        }
        
        .advanced-options-header:hover {
            background: var(--hover-color);
            border-radius: 4px;
            padding: 2px 4px;
        }
        
        .result-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 4px 0;
        }
        
        .result-label {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .result-value {
            color: var(--text-primary);
            font-weight: bold;
            font-size: 14px;
        }
        
        .total-cost {
            border-top: 2px solid var(--primary-color);
            padding-top: 8px;
            margin-top: 10px;
        }
        
        .total-cost .result-label,
        .total-cost .result-value {
            font-size: 16px;
            color: var(--primary-color);
        }

        .tile-type-result {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .tile-type-result:last-child {
            margin-bottom: 0;
        }

        .tile-type-name {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .tile-calculation-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .tile-calculation-row:last-child {
            margin-bottom: 0;
        }

        .tile-calculation-label {
            color: var(--text-secondary);
        }

        .tile-calculation-value {
            font-weight: bold;
            color: var(--text-primary);
        }

        .tile-total-section {
            border-top: 2px solid var(--border-color);
            padding-top: 15px;
            margin-top: 15px;
        }

        .tile-total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 16px;
            font-weight: bold;
        }

        .tile-total-cost {
            color: var(--primary-color);
            font-size: 18px;
        }

        .tile-input-group {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .tile-input-group h4 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: bold;
        }

        .tile-input-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }

        .tile-input-row:last-child {
            margin-bottom: 0;
        }

        .tile-input-field {
            display: flex;
            flex-direction: column;
        }

        .tile-input-field label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .tile-input-field input {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            width: 100%;
            box-sizing: border-box;
            min-width: 0;
        }

        .tile-pattern-info {
            background: var(--hover-color);
            border-left: 4px solid var(--primary-color);
            padding: 10px 15px;
            margin: 10px 0;
            font-size: 14px;
            border-radius: 0 4px 4px 0;
        }

        @media (max-width: 768px) {
            .tile-input-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            /* Ensure all inputs and selects stay within container */
            input[type="text"],
            input[type="number"],
            select,
            .wide-input,
            .smart-input {
                max-width: 100%;
                width: 100%;
                box-sizing: border-box;
            }
            
            /* Fix settings panels on mobile */
            .settings-panel {
                padding: 15px !important;
                margin: 10px 0 !important;
            }
            
            /* Ensure flex items wrap properly */
            .settings-panel > div {
                min-width: 0 !important;
            }
            
            /* Fix overflow in calc-card-content */
            .calc-card-content {
                overflow-x: hidden;
                overflow-y: visible;
                padding: 10px;
            }
            
            /* Adjust minimum widths for mobile */
            div[style*="min-width: 200px"],
            div[style*="min-width: 150px"] {
                min-width: 100% !important;
            }
        }

        .calc-mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .mode-btn {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid var(--border-color);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .mode-btn:hover {
            border-color: var(--primary-color);
            background: var(--hover-color);
        }

        .mode-btn.active {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: white;
        }

        .mode-description {
            text-align: center;
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 20px;
            padding: 10px;
            background: var(--secondary-bg);
            border-radius: 6px;
        }

        .mode-interface {
            margin: 20px 0;
        }

        .woodworking-input {
            display: flex;
            align-items: center;
            gap: 5px;
            flex-wrap: wrap;
        }

        .woodworking-input input, .woodworking-input select {
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
        }

        .woodworking-input .unit {
            font-size: 12px;
            color: var(--text-secondary);
            margin-right: 8px;
        }

        .compatible-patterns {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .pattern-tag {
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pattern-tag:hover {
            background: var(--secondary-color);
        }

        .pattern-tag.compatible {
            background: #28a745;
        }

        .pattern-tag.warning {
            background: #ffc107;
            color: #333;
        }

        .pattern-tag.incompatible {
            background: #dc3545;
        }

        .pattern-requirements {
            margin-top: 15px;
            padding: 15px;
            background: var(--secondary-bg);
            border-radius: 6px;
            border-left: 4px solid var(--primary-color);
        }

        .pattern-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 15px 0;
            padding: 15px;
            background: var(--secondary-bg);
            border-radius: 6px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            display: block;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .stat-value {
            display: block;
            font-weight: bold;
            color: var(--primary-color);
            font-size: 14px;
        }

        .difficulty-beginner { color: #28a745; }
        .difficulty-intermediate { color: #ffc107; }
        .difficulty-advanced { color: #dc3545; }

        @media (max-width: 768px) {
            .calc-mode-selector {
                flex-direction: column;
            }
            
            .woodworking-input {
                justify-content: center;
            }
            
            .pattern-stats {
                grid-template-columns: 1fr;
            }
            
            /* Fix input groups and rows on mobile */
            .input-row,
            .input-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .input-row input,
            .input-row select {
                width: 100% !important;
                margin-bottom: 5px;
            }
            
            /* Fix woodworking inputs on mobile */
            .woodworking-input {
                flex-wrap: wrap;
                justify-content: flex-start;
            }
            
            .woodworking-input input,
            .woodworking-input select {
                flex: 0 0 auto;
                min-width: 60px;
                max-width: 100px;
            }
            
            /* Prevent horizontal scroll */
            .mode-content {
                overflow-x: hidden;
            }
                gap: 10px;
            }
        }

        @media (max-width: 480px) {
            .tile-input-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .tile-input-field input {
                padding: 10px;
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }
        
        /* ----------------------------------------------------------------
           MOBILE KEYPAD STYLES
           ---------------------------------------------------------------- */
        
        /* Keypad overlay and container */
        .keypad-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .keypad-overlay.active {
            display: block;
            opacity: 1;
        }
        
        .mobile-keypad {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--background-color);
            border-top: 2px solid var(--primary-color);
            border-radius: 20px 20px 0 0;
            padding: 10px;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            max-height: 50vh;
            overflow-y: auto;
        }
        
        .keypad-overlay.active .mobile-keypad {
            transform: translateY(0);
        }
        
        /* Keypad positioned at top when needed */
        .mobile-keypad.position-top {
            bottom: auto;
            top: 0;
            border-top: none;
            border-bottom: 2px solid var(--primary-color);
            border-radius: 0 0 20px 20px;
            transform: translateY(-100%);
        }
        
        .keypad-overlay.active .mobile-keypad.position-top {
            transform: translateY(0);
        }
        
        /* Keypad header with active input display */
        .keypad-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .keypad-input-display {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
            flex: 1;
            margin-right: 10px;
            padding: 8px;
            background: var(--surface-color);
            border-radius: 8px;
            font-family: 'Monaco', 'Consolas', monospace;
        }
        
        .keypad-close-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--error-color);
            color: white;
            border: none;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        /* Button grid layout */
        .keypad-buttons {
            display: grid;
            gap: 8px;
        }
        
        /* Main number pad - 3 columns (phone style) */
        .keypad-numpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }
        
        /* Common fractions row */
        .keypad-fractions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }
        
        /* Measurement symbols */
        .keypad-operations {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }
        
        /* Units row */
        .keypad-units {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }
        
        /* Control buttons */
        .keypad-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        /* Base button styles - more compact */
        .keypad-btn {
            min-height: 42px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.1s ease;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            position: relative;
            overflow: hidden;
        }
        
        /* Button types */
        .keypad-btn.number {
            background: var(--surface-color);
            color: var(--text-primary);
            font-size: 20px;
            font-weight: 600;
        }
        
        .keypad-btn.fraction {
            background: var(--accent-color);
            color: var(--text-primary);
            font-size: 16px;
        }
        
        .keypad-btn.operation {
            background: var(--primary-light);
            color: var(--text-on-primary);
        }
        
        .keypad-btn.symbol {
            background: var(--secondary-color);
            color: var(--text-primary);
            font-size: 20px;
        }
        
        .keypad-btn.unit {
            background: var(--info-color);
            color: white;
            font-size: 14px;
            font-weight: 600;
        }
        
        .keypad-btn.control {
            background: var(--primary-color);
            color: var(--text-on-primary);
            font-weight: 600;
        }
        
        .keypad-btn.space {
            background: var(--border-color);
            color: var(--text-primary);
        }
        
        .keypad-btn.clear {
            background: var(--warning-color);
            color: white;
        }
        
        .keypad-btn.done {
            background: var(--success-color);
            color: white;
            font-size: 18px;
            font-weight: 600;
        }
        
        /* Button active states */
        .keypad-btn:active {
            transform: scale(0.95);
            opacity: 0.8;
        }
        
        /* Ripple effect for touch feedback */
        .keypad-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }
        
        .keypad-btn:active::after {
            width: 100%;
            height: 100%;
        }
        
        /* Special button styles */
        .keypad-btn.backspace {
            font-size: 24px;
        }
        
        .keypad-btn.zero {
            grid-column: span 2;
        }
        
        /* Responsive adjustments */
        @media (max-width: 360px) {
            .keypad-btn {
                min-height: 45px;
                font-size: 16px;
            }
            
            .keypad-btn.number {
                font-size: 20px;
            }
            
            .mobile-keypad {
                padding: 10px;
            }
        }
        
        /* Landscape mode adjustments */
        @media (orientation: landscape) and (max-height: 500px) {
            .mobile-keypad {
                max-height: 80vh;
                padding: 8px;
            }
            
            .keypad-btn {
                min-height: 40px;
            }
            
            .keypad-header {
                margin-bottom: 5px;
                padding-bottom: 5px;
            }
        }
        
        /* Accessibility */
        .keypad-btn:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }
        
        /* Prevent text selection on double tap */
        .mobile-keypad * {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* Smooth scrolling for keypad */
        .mobile-keypad {
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body>
    <script>
        // Early initialization functions needed by HTML elements
        function updateUIMode(mode) {
            // This will be properly defined later, but we need a stub for the HTML
            if (window.updateUIModeReal) {
                window.updateUIModeReal(mode);
            }
        }
        
        function switchTab(tab) {
            // This will be properly defined later, but we need a stub for the HTML
            if (window.switchTabReal) {
                window.switchTabReal(tab);
            }
        }
    </script>
    <!-- ================================================================
         SECTION 2: HTML STRUCTURE
         ================================================================ -->
    
    <!-- ----------------------------------------------------------------
         2.1 MAIN CONTAINER & NAVIGATION
         ---------------------------------------------------------------- -->
    <div class="container">
        <div class="header-section">
            <div class="header-top-row">
                <button class="help-btn dad-joke-btn" onclick="fetchDadJoke()" title="Nailed It! - Workshop Dad Jokes">🙄</button>
                <h1>WorkShop Pro Calculator</h1>
                <button class="help-btn" onclick="showHelp()" title="Help">?</button>
            </div>
            <div class="header-controls">
                <div class="theme-selector">
                    <select id="themeSelect" onchange="changeTheme(this.value)" title="Choose Theme">
                        <option value="wood">🟤 Wood</option>
                        <option value="steel">🔧 Steel</option>
                        <option value="dark">🌙 Dark</option>
                        <option value="festool">🟢 Festool</option>
                        <option value="milwaukee">🔴 Milwaukee</option>
                        <option value="makita">🔵 Makita</option>
                        <option value="dewalt">🟡 Dewalt</option>
                        <option value="ridgid">🟠 Ridgid</option>
                        <option value="noob">🟢 Noob</option>
                    </select>
                </div>
                <div class="mode-selector">
                    <select id="uiModeSelect" onchange="updateUIMode(this.value)" title="Choose Mode">
                        <option value="basic">Basic</option>
                        <option value="standard">Standard</option>
                        <option value="project">Project</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="tab-buttons">
            <button class="tab-btn active" onclick="switchTab('calculator')">Calculator</button>
            <button class="tab-btn" onclick="switchTab('specialty')">Specialty Calculators</button>
            <button class="tab-btn" onclick="switchTab('projects')">📁 Projects</button>
        </div>
        
        <!-- Global Project Selector -->
        <div class="global-project-selector" id="globalProjectSelector">
            <div class="project-selector-content">
                <span class="project-label">💾 Active Project:</span>
                <select id="globalProjectDropdown" onchange="switchToProject(this.value)">
                    <option value="">No Project Selected</option>
                </select>
                <button class="btn btn-primary btn-sm" onclick="createNewProject()" style="margin-left: 10px;">+ New</button>
            </div>
        </div>
        

        <!-- Calculator Tab -->
        <div id="calculator" class="tab-content active">
            <!-- Beginner Welcome Message -->
            <div id="beginnerWelcome" style="display: none; background: linear-gradient(135deg, #e8f5e8, #f0f8f0); border: 2px solid #4CAF50; border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center;">
                <h3 style="color: #2E7D32; margin: 0 0 10px 0;">👋 Welcome to Your First Calculator!</h3>
                <p style="margin: 0 0 15px 0; color: #1B5E20;">Start by entering a measurement in inches, then click + or - to do math!</p>
                <div style="font-size: 12px; color: #4CAF50;">💡 Try: Enter 25.5, click +, then enter 12.25</div>
            </div>
            
            <div class="settings-row">
                <label>Precision:</label>
                <select id="precision" onchange="updatePrecision('calculator'); updateWoodworkingFractions();">
                    <option value="32">1/32"</option>
                    <option value="16" selected>1/16"</option>
                    <option value="8">1/8"</option>
                    <option value="4">1/4"</option>
                    <option value="2">1/2"</option>
                    <option value="1">1"</option>
                </select>
            </div>
            
            <div class="calc-display">
                <div class="memory-display" id="memoryIndicator"></div>
                <div class="calc-equation" id="calcEquation">&nbsp;</div>
                <div class="calc-result" id="calcResult" onclick="useResultAsInput1()">0"</div>
            </div>
            <div id="resultHint" class="result-hint" style="display: none;">
                ↩ Click result to use in next calculation
            </div>
            
            <!-- Main Calculator Input -->
            <div class="input-group">
                <label>Enter Measurement or Expression:</label>
                <input type="text" id="smartInput1" placeholder="Try: 4'6&quot;, 48&quot;, 2 3 5/16 (for 2' 3 5/16&quot;), or 5 + 3 × 2" class="wide-input smart-input" oninput="handleSmartInput(this, 'previewInput1', updateInput1Value)" onchange="handleSmartInput(this, 'previewInput1', updateInput1Value)" inputmode="none">
            </div>
            <div id="previewInput1" class="input-preview"></div>
            
            <!-- Integrated Calculator Keypad -->
            <div class="calc-keypad">
                <!-- Memory Functions Row (only shown in standard mode) -->
                <div class="keypad-row keypad-memory" id="memoryRow" style="display: none;">
                    <button class="calc-btn memory" onclick="memoryOperation('MC')">MC</button>
                    <button class="calc-btn memory" onclick="memoryOperation('MR')">MR</button>
                    <button class="calc-btn memory" onclick="memoryOperation('M+')">M+</button>
                    <button class="calc-btn memory" onclick="memoryOperation('M-')">M−</button>
                </div>
                
                <!-- Clear and Function Row -->
                <div class="keypad-row">
                    <button class="calc-btn clear" onclick="clearCalculator()">AC</button>
                    <button class="calc-btn backspace" onclick="handleBackspace()">←</button>
                    <button class="calc-btn fraction" onclick="handleKeypadButton('/', 'fraction')" title="Fraction slash (e.g., 3/32)">⁄</button>
                    <button class="calc-btn operation" onclick="handleKeypadButton(' ÷ ', 'operation')">÷</button>
                </div>
                
                <!-- Numbers and Operations -->
                <div class="keypad-row">
                    <button class="calc-btn number" onclick="handleKeypadButton('7', 'number')">7</button>
                    <button class="calc-btn number" onclick="handleKeypadButton('8', 'number')">8</button>
                    <button class="calc-btn number" onclick="handleKeypadButton('9', 'number')">9</button>
                    <button class="calc-btn operation" onclick="handleKeypadButton(' × ', 'operation')">×</button>
                </div>
                
                <div class="keypad-row">
                    <button class="calc-btn number" onclick="handleKeypadButton('4', 'number')">4</button>
                    <button class="calc-btn number" onclick="handleKeypadButton('5', 'number')">5</button>
                    <button class="calc-btn number" onclick="handleKeypadButton('6', 'number')">6</button>
                    <button class="calc-btn operation" onclick="handleKeypadButton(' - ', 'operation')">−</button>
                </div>
                
                <div class="keypad-row">
                    <button class="calc-btn number" onclick="handleKeypadButton('1', 'number')">1</button>
                    <button class="calc-btn number" onclick="handleKeypadButton('2', 'number')">2</button>
                    <button class="calc-btn number" onclick="handleKeypadButton('3', 'number')">3</button>
                    <button class="calc-btn operation" onclick="handleKeypadButton(' + ', 'operation')">+</button>
                </div>
                
                <!-- Bottom Row with wider space button -->
                <div class="keypad-row">
                    <button class="calc-btn number" onclick="handleKeypadButton('0', 'number')">0</button>
                    <button class="calc-btn number" onclick="handleKeypadButton('.', 'number')">.</button>
                    <button class="calc-btn space" onclick="handleKeypadButton(' ', 'space')" style="grid-column: span 2;">Space</button>
                </div>
                
                <!-- Units Row -->
                <div class="keypad-row keypad-units">
                    <button class="calc-btn unit" onclick="handleKeypadButton('ft', 'unit')">ft</button>
                    <button class="calc-btn unit" onclick="handleKeypadButton('in', 'unit')">in</button>
                    <button class="calc-btn metric" onclick="handleKeypadButton('mm', 'unit')">mm</button>
                    <button class="calc-btn metric" onclick="handleKeypadButton('cm', 'unit')">cm</button>
                </div>
                
                <!-- Additional Units and Save -->
                <div class="keypad-row">
                    <button class="calc-btn metric" onclick="handleKeypadButton('m', 'unit')">m</button>
                    <button class="calc-btn save" onclick="saveCalculatorToProject()" style="grid-column: span 3;">Save to Project</button>
                </div>
            </div>
            
            
            <div class="conversion-section">
                <h4 style="color: var(--primary-color); margin-bottom: 15px; cursor: pointer; font-size: 18px; font-weight: 700; display: flex; align-items: center; justify-content: space-between;" onclick="toggleConversions()">
                    <span>Quick Conversions</span>
                    <span id="conversionToggle" style="font-size: 14px; transition: transform 0.2s ease;">▼</span>
                </h4>
                <div id="conversionContent">
                    <div id="conversionPreview" class="conversion-preview">
                        <strong>Ready to convert:</strong> <span id="conversionValue">Enter a measurement above or perform a calculation</span>
                    </div>
                    <div class="conversion-grid">
                        <button class="btn btn-secondary" onclick="convertToDecimal()">→ Decimal Inches</button>
                        <button class="btn btn-secondary" onclick="convertToFeet()">→ Decimal Feet</button>
                        <button class="btn btn-secondary" onclick="convertToMetric()">→ Metric</button>
                    </div>
                </div>
            </div>
            
            <div class="history" id="history">
                <!-- History will appear here -->
            </div>
            
            <!-- Show More Tools for Simple Mode -->
            <div id="showMoreToolsSection" style="display: none; text-align: center; margin: 30px 0; padding: 20px; background: var(--surface-color); border-radius: 8px;">
                <h3 style="color: var(--primary-color); margin-bottom: 15px;">Need More Tools?</h3>
                <p style="margin-bottom: 20px; color: var(--text-secondary);">Switch to Standard Mode to access specialty calculators like Board Foot, Miter Angles, Tile Layout, and more!</p>
                <button class="btn btn-primary" onclick="updateUIMode('standard')" style="padding: 10px 30px; font-size: 16px;">
                    🔧 Switch to Standard Mode
                </button>
            </div>
        </div>
        
        <!-- Specialty Calculators Tab -->
        <div id="specialty" class="tab-content">
            <!-- Recently Used Calculators -->
            <div id="recentCalculatorsSection" class="settings-panel" style="background: #f8f9fa; border-radius: 8px; padding: 12px 15px; margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="color: var(--primary-color); font-size: 14px; font-weight: 600; white-space: nowrap;">⚡ Recent:</span>
                    <div id="recentCalculatorsGrid" style="display: flex; gap: 10px; flex-wrap: wrap; flex: 1;">
                        <!-- Recent calculator cards will be dynamically generated here -->
                    </div>
                    <div id="noRecentCalculators" style="color: #999; font-size: 13px; font-style: italic;">
                        Use calculators to see quick access here
                    </div>
                </div>
            </div>
            
            <!-- Search Box -->
            <div style="margin-bottom: 15px; max-width: 400px; margin-left: auto; margin-right: auto;">
                <div style="position: relative;">
                    <input type="text" id="calcSearchInput" placeholder="Search calculators..." 
                           style="width: 100%; padding: 10px 40px 10px 15px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 15px;"
                           oninput="filterCalculators()">
                    <button onclick="clearCalculatorSearch()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #666; font-size: 16px;">✕</button>
                </div>
            </div>
            
            <!-- Expand/Collapse All Controls -->
            <div id="expandCollapseControls" style="text-align: center; margin-bottom: 15px; padding: 10px; background: var(--surface-color); border-radius: 8px;">
                <button class="btn btn-sm btn-secondary" onclick="expandAllCalculators()" style="margin-right: 10px; padding: 6px 12px; font-size: 13px;">
                    📖 Expand All
                </button>
                <button class="btn btn-sm btn-secondary" onclick="collapseAllCalculators()" style="padding: 6px 12px; font-size: 13px;">
                    📚 Collapse All
                </button>
            </div>
            
            <!-- Materials & Shopping Category -->
            <div class="calc-category-header" style="background: var(--gradient-primary); padding: 12px 20px; margin: 20px 0 15px 0; border-radius: 8px; border-left: 4px solid var(--primary-color); cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleCategory('materials')">
                <h3 style="margin: 0; color: var(--text-on-primary); font-size: 18px; font-weight: 600;">📦 Materials & Shopping</h3>
                <span class="category-arrow" id="materials-arrow" style="color: var(--text-on-primary);">▶</span>
            </div>
            <div class="calc-category-content" id="materials-content" style="display: none;">
            
            <!-- Board Foot Calculator -->
            <div class="calc-card" id="boardFootCard">
                <div class="calc-card-header" onclick="toggleCalcCard('boardFoot')">
                    <span class="calc-icon">📏</span>
                    <span class="calc-title">Lumber Shopping Cart</span>
                    <button class="calc-help-btn" onclick="event.stopPropagation(); showCalculatorHelp('lumberCart')" title="Help">?</button>
                    <span class="calc-arrow">▼</span>
                </div>
                <div class="calc-card-content" id="boardFootContent" style="display: none !important;">
                    <div class="calc-description">Calculate lumber costs by species and build a shopping cart</div>
                    <div class="calc-visual" id="boardDiagramContainer">
                        <svg width="100%" height="200" viewBox="0 0 400 200" style="max-width: 400px; margin: 0 auto; display: block;">
                            <!-- Grid pattern background -->
                            <defs>
                                <pattern id="bfGrid" width="20" height="20" patternUnits="userSpaceOnUse">
                                    <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#e0e0e0" stroke-width="0.5"/>
                                </pattern>
                                <!-- Wood grain pattern for lumber -->
                                <pattern id="lumberGrain" patternUnits="userSpaceOnUse" width="80" height="40">
                                    <rect width="80" height="40" fill="#DEB887"/>
                                    <path d="M0,5 Q20,3 40,5 T80,5" stroke="#D2691E" stroke-width="1" fill="none"/>
                                    <path d="M0,15 Q15,12 30,15 T80,15" stroke="#CD853F" stroke-width="0.8" fill="none"/>
                                    <path d="M0,25 Q25,22 50,25 T80,25" stroke="#D2691E" stroke-width="0.9" fill="none"/>
                                    <path d="M0,35 Q18,32 36,35 T80,35" stroke="#CD853F" stroke-width="0.7" fill="none"/>
                                </pattern>
                            </defs>
                            <rect width="400" height="200" fill="url(#bfGrid)" />
                            
                            <!-- 3D Lumber piece (interactive) -->
                            <g id="lumber3d">
                                <!-- Top face -->
                                <path id="topFace" d="M 100 60 L 250 60 L 300 40 L 150 40 Z" fill="url(#lumberGrain)" stroke="#8B4513" stroke-width="2"/>
                                <!-- Front face -->
                                <rect id="frontFace" x="100" y="60" width="150" height="80" fill="#D2691E" stroke="#8B4513" stroke-width="2"/>
                                <!-- Right face -->
                                <path id="rightFace" d="M 250 60 L 300 40 L 300 120 L 250 140 Z" fill="#A0522D" stroke="#8B4513" stroke-width="2"/>
                                
                                <!-- Wood grain lines on front -->
                                <g id="grainLines">
                                    <line x1="100" y1="80" x2="250" y2="80" stroke="#B8860B" stroke-width="0.5" opacity="0.5"/>
                                    <line x1="100" y1="100" x2="250" y2="100" stroke="#B8860B" stroke-width="0.5" opacity="0.5"/>
                                    <line x1="100" y1="120" x2="250" y2="120" stroke="#B8860B" stroke-width="0.5" opacity="0.5"/>
                                </g>
                            </g>
                            
                            <!-- Dynamic dimension labels -->
                            <text id="lengthLabel" x="175" y="170" text-anchor="middle" font-size="12" fill="#666">Length</text>
                            <text id="widthLabel" x="275" y="160" text-anchor="middle" font-size="12" fill="#666">Width</text>
                            <text id="thicknessLabel" x="50" y="105" text-anchor="middle" font-size="12" fill="#666">Thickness</text>
                            
                            <!-- Dynamic dimension arrows -->
                            <g id="dimensionArrows">
                                <!-- Length arrow (horizontal) -->
                                <path id="lengthArrow" d="M 100 150 L 250 150 M 100 150 L 105 147 M 100 150 L 105 153 M 250 150 L 245 147 M 250 150 L 245 153" stroke="#333" stroke-width="1" fill="none"/>
                                <!-- Width arrow (diagonal, positioned below lumber) -->
                                <path id="widthArrow" d="M 250 145 L 300 125 M 250 145 L 255 143 M 250 145 L 252 140 M 300 125 L 295 127 M 300 125 L 298 130" stroke="#333" stroke-width="1" fill="none"/>
                                <!-- Thickness arrow (vertical on left) -->
                                <path id="thicknessArrow" d="M 80 60 L 80 140 M 80 60 L 77 65 M 80 60 L 83 65 M 80 140 L 77 135 M 80 140 L 83 135" stroke="#333" stroke-width="1" fill="none"/>
                            </g>
                        </svg>
                    </div>
                    <!-- Species and Pricing Section -->
                    <div class="settings-panel" style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--primary-color); font-size: 16px;">Species & Pricing</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                            <div style="flex: 1; min-width: 250px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Wood Species:</label>
                                <select id="bfSpecies" onchange="handleSpeciesChange()" style="width: 100%; padding: 12px;">
                                    <option value="">Select species...</option>
                                    <option value="White Oak">White Oak</option>
                                    <option value="Red Oak">Red Oak</option>
                                    <option value="Maple">Maple</option>
                                    <option value="Cherry">Cherry</option>
                                    <option value="Walnut">Walnut</option>
                                    <option value="Poplar">Poplar</option>
                                    <option value="Pine">Pine</option>
                                    <option value="Cedar">Cedar</option>
                                    <option value="Mahogany">Mahogany</option>
                                    <option value="Ash">Ash</option>
                                    <option value="Birch">Birch</option>
                                    <option value="Custom">Custom Species</option>
                                </select>
                                <div id="customSpeciesRow" style="display: none; margin-top: 10px;">
                                    <input type="text" id="bfCustomSpecies" placeholder="Enter custom species name" oninput="calculateBoardFeet()" style="width: 100%; padding: 12px;">
                                </div>
                            </div>
                            <div style="flex: 1; min-width: 200px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Price per Board Foot:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="number" id="bfPrice" step="0.01" min="0" placeholder="8.99" oninput="calculateBoardFeet()" style="width: 100%; padding: 12px;">
                                    <span style="font-weight: 600; color: var(--text-secondary);">$/BF</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dimensions Section -->
                    <div class="calc-inputs" style="background: var(--surface-color); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--primary-color); font-size: 16px;">Board Dimensions</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Thickness:</label>
                                <input type="text" id="smartBfThickness" placeholder="Try: 3/4&quot;, 1.5&quot;, 1 1/2&quot;" class="wide-input smart-input" oninput="handleSmartInput(this, 'previewBfThickness', updateBfThicknessValue)" style="padding: 12px;">
                                <div id="previewBfThickness" class="input-preview"></div>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Width:</label>
                                <input type="text" id="smartBfWidth" placeholder="Try: 6&quot;, 5 1/2&quot;, 12.25&quot;" class="wide-input smart-input" oninput="handleSmartInput(this, 'previewBfWidth', updateBfWidthValue)" style="padding: 12px;">
                                <div id="previewBfWidth" class="input-preview"></div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 2fr 60px; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Length:</label>
                                <input type="text" id="smartBfLength" placeholder="Try: 8', 96&quot;, 8 0 1/2&quot;" class="wide-input smart-input" oninput="handleSmartInput(this, 'previewBfLength', updateBfLengthValue)" style="padding: 12px;">
                                <div id="previewBfLength" class="input-preview"></div>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Qty:</label>
                                <input type="number" id="bfQuantity" min="1" placeholder="1" value="1" oninput="calculateBoardFeet()" style="width: 100%; padding: 12px;">
                            </div>
                        </div>
                        <div style="display: none;">
                            <!-- Hidden legacy inputs -->
                            <input type="number" id="bfThickness" step="0.25" min="0.1" placeholder="1" oninput="calculateBoardFeet()">
                            <input type="number" id="bfWidth" step="0.25" min="0.1" placeholder="6" oninput="calculateBoardFeet()">
                            <input type="number" id="bfLength" step="1" min="0.1" placeholder="96" oninput="calculateBoardFeet()">
                        </div>
                    </div>
                    
                    <!-- Calculation Result -->
                    <div class="calc-result" style="margin-bottom: 20px;">
                        <div class="result-display" id="boardFootResult" style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px;">Enter item details above</div>
                        <div class="cart-actions" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <button class="btn btn-primary" onclick="addToLumberCart()" style="padding: 12px; font-size: 16px;">🛒 Add to Cart</button>
                            <button class="btn btn-secondary" onclick="clearBoardFootForm()" style="padding: 12px; font-size: 16px;">Clear Form</button>
                        </div>
                    </div>
                    
                    <!-- Shopping Cart Section -->
                    <div class="cart-section" style="background: var(--surface-color); border-radius: 12px; padding: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--primary-color); font-size: 16px; display: flex; justify-content: space-between; align-items: center;">
                            <span id="cartHeaderTitle">🛒 Shopping Cart</span>
                            <button class="btn btn-secondary btn-sm" onclick="clearLumberCart()" id="clearCartBtn" style="padding: 6px 12px; display: none;">Clear Cart</button>
                        </h4>
                        <div id="lumberCartDisplay" class="cart-display" style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 15px; max-height: 300px; overflow-y: auto;">
                            <div class="result-placeholder">No items in cart</div>
                        </div>
                        <div class="cart-bottom-actions" style="text-align: center;">
                            <button class="btn btn-success" onclick="saveLumberCartToProject()" id="saveCartBtn" disabled style="padding: 12px 24px; font-size: 16px;">💾 Save Cart to Project</button>
                        </div>
                    </div>
                </div>
            </div>
            
            </div> <!-- End Materials & Shopping Category -->
            
            <!-- Measurements & Layout Category -->
            <div class="calc-category-header" style="background: var(--gradient-primary); padding: 12px 20px; margin: 20px 0 15px 0; border-radius: 8px; border-left: 4px solid var(--primary-color); cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleCategory('measurements')">
                <h3 style="margin: 0; color: var(--text-on-primary); font-size: 18px; font-weight: 600;">📏 Measurements & Layout</h3>
                <span class="category-arrow" id="measurements-arrow" style="color: var(--text-on-primary);">▶</span>
            </div>
            <div class="calc-category-content" id="measurements-content" style="display: none;">

            <!-- Golden Ratio Calculator -->
            <div class="calc-card" id="goldenRatioCard">
                <div class="calc-card-header" onclick="toggleCalcCard('goldenRatio')">
                    <span class="calc-icon">✨</span>
                    <span class="calc-title">Golden Ratio Calculator</span>
                    <button class="calc-help-btn" onclick="event.stopPropagation(); showCalculatorHelp('goldenRatio')" title="Help">?</button>
                    <span class="calc-arrow">▼</span>
                </div>
                <div class="calc-card-content" id="goldenRatioContent" style="display: none !important;">
                    <div class="calc-description">Find proportional dimensions using the golden ratio (1.618)</div>
                    
                    <!-- Visual Preview Panel -->
                    <div class="settings-panel" style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--primary-color); font-size: 16px;">Visual Preview</h4>
                        <div class="calc-visual" id="goldenDiagramContainer">
                            <svg width="100%" height="200" viewBox="0 0 400 200" style="max-width: 400px; margin: 0 auto; display: block;">
                                <!-- Grid pattern background -->
                                <defs>
                                    <pattern id="grGrid" width="20" height="20" patternUnits="userSpaceOnUse">
                                        <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#e0e0e0" stroke-width="0.5"/>
                                    </pattern>
                                    <!-- Golden gradient -->
                                    <linearGradient id="goldenGrad1" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#FFD700;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#FFA500;stop-opacity:1" />
                                    </linearGradient>
                                    <linearGradient id="goldenGrad2" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#F0E68C;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#DAA520;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <rect width="400" height="200" fill="url(#grGrid)" />
                                
                                <!-- Golden Rectangle -->
                                <g transform="translate(80, 50)">
                                    <!-- Smaller section (1) -->
                                    <rect x="0" y="0" width="94" height="100" fill="url(#goldenGrad1)" stroke="var(--primary-color)" stroke-width="2"/>
                                    <!-- Larger section (1.618) -->
                                    <rect x="94" y="0" width="152" height="100" fill="url(#goldenGrad2)" stroke="var(--primary-color)" stroke-width="2"/>
                                    
                                    <!-- Spiral guide lines -->
                                    <line x1="94" y1="0" x2="94" y2="100" stroke="var(--primary-color)" stroke-width="2"/>
                                    
                                    <!-- Labels -->
                                    <text x="47" y="120" text-anchor="middle" font-size="14" font-weight="bold" fill="#333">1</text>
                                    <text x="170" y="120" text-anchor="middle" font-size="14" font-weight="bold" fill="#333">1.618</text>
                                    
                                    <!-- Dimension arrows -->
                                    <path d="M 0 -10 L 94 -10 M 0 -10 L 5 -13 M 0 -10 L 5 -7 M 94 -10 L 89 -13 M 94 -10 L 89 -7" stroke="#666" stroke-width="1" fill="none"/>
                                    <path d="M 94 -10 L 246 -10 M 94 -10 L 99 -13 M 94 -10 L 99 -7 M 246 -10 L 241 -13 M 246 -10 L 241 -7" stroke="#666" stroke-width="1" fill="none"/>
                                </g>
                                
                                <!-- Title -->
                                <text x="200" y="30" text-anchor="middle" font-size="16" font-weight="bold" fill="var(--primary-color)">Golden Ratio</text>
                                <text x="200" y="180" text-anchor="middle" font-size="12" fill="#666">Perfect proportions for aesthetic design</text>
                            </svg>
                        </div>
                    </div>
                    
                    <!-- Configuration Panel -->
                    <div class="settings-panel" style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--primary-color); font-size: 16px;">Configuration</h4>
                        
                        <!-- Mode Selection -->
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Calculation Mode:</label>
                            <div style="display: flex; gap: 10px;">
                                <button class="mode-btn active" onclick="setGoldenMode('short')" id="goldenModeShort" style="flex: 1;">📏 Short → Long</button>
                                <button class="mode-btn" onclick="setGoldenMode('long')" id="goldenModeLong" style="flex: 1;">📐 Long → Short</button>
                            </div>
                        </div>
                        
                        <!-- Dimension Input -->
                        <div style="margin-bottom: 15px;">
                            <label id="goldenInputLabel" style="display: block; margin-bottom: 8px; font-weight: 600;">Known dimension:</label>
                            <input type="text" 
                                   id="smartGoldenRatio" 
                                   placeholder="Try: 4'6&quot;, 48&quot;, 4 6 1/2, 48.5&quot;" 
                                   class="wide-input smart-input" 
                                   oninput="handleSmartInput(this, 'smartGoldenRatioPreview', updateGoldenRatioValue)" 
                                   onchange="handleSmartInput(this, 'smartGoldenRatioPreview', updateGoldenRatioValue)"
                                   style="padding: 12px;">
                            <div id="smartGoldenRatioPreview" class="input-preview" style="display: none;"></div>
                        </div>
                        
                        <div style="display: none;">
                            <!-- Hidden legacy inputs for backward compatibility -->
                            <input type="number" id="grFeet" placeholder="0" min="0" class="wide-input">
                            <input type="number" id="grInches" placeholder="0" min="0" max="11" class="wide-input">
                            <select id="grFraction" style="width: 120px;">
                                <option value="0">0</option>
                                <option value="0.0625">1/16"</option>
                                <option value="0.125">1/8"</option>
                                <option value="0.1875">3/16"</option>
                                <option value="0.25">1/4"</option>
                                <option value="0.3125">5/16"</option>
                                <option value="0.375">3/8"</option>
                                <option value="0.4375">7/16"</option>
                                <option value="0.5">1/2"</option>
                                <option value="0.5625">9/16"</option>
                                <option value="0.625">5/8"</option>
                                <option value="0.6875">11/16"</option>
                                <option value="0.75">3/4"</option>
                                <option value="0.8125">13/16"</option>
                                <option value="0.875">7/8"</option>
                                <option value="0.9375">15/16"</option>
                            </select>
                        </div>
                        
                        <!-- Clear Button -->
                        <button class="btn btn-secondary" onclick="clearGoldenRatio()" style="width: 100%; padding: 10px;">Clear</button>
                    </div>
                    
                    <!-- Results Panel -->
                    <div class="calc-result" style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--primary-color); font-size: 16px;">Result</h4>
                        <div class="result-display" id="grResult" style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px;">Enter a dimension to calculate</div>
                        <button class="btn btn-success btn-sm" onclick="saveGoldenRatioToProject()" style="width: 100%;">Save to Project</button>
                    </div>
                </div>
            </div>

            <!-- Shelf & Division Calculator -->
            <div class="calc-card" id="spacingCard">
                <div class="calc-card-header" onclick="toggleCalcCard('spacing')">
                    <span class="calc-icon">📐</span>
                    <span class="calc-title">Shelf & Division Calculator</span>
                    <button class="calc-help-btn" onclick="event.stopPropagation(); showCalculatorHelp('spacing')" title="Help">?</button>
                    <span class="calc-arrow">▼</span>
                </div>
                <div class="calc-card-content" id="spacingContent" style="display: none !important;">
                    <div class="calc-description">Calculate shelf spacing and divisions for woodworking projects</div>
                    
                    <!-- Settings Panel -->
                    <div class="settings-panel" style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--primary-color); font-size: 16px;">Cabinet Dimensions</h4>
                        
                        <!-- Total Length Input -->
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Total Length:</label>
                            <input type="text" id="smartShelfLength" placeholder="Try: 8' 0 3/4&quot; or 96.75&quot; or 8.0625'" class="wide-input" oninput="handleSmartInput(this, 'previewShelfLength', updateShelfLengthValue)" style="padding: 12px;">
                            <div id="previewShelfLength" class="input-preview"></div>
                        </div>
                        
                        <!-- Calculation Mode Selector -->
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Calculate By:</label>
                            <div style="display: flex; gap: 10px;">
                                <button class="mode-btn active" onclick="setShelfMode('count')" id="shelfModeCount" style="flex: 1;">Number of Shelves</button>
                                <button class="mode-btn" onclick="setShelfMode('spacing')" id="shelfModeSpacing" style="flex: 1;">Desired Spacing</button>
                            </div>
                        </div>
                        
                        <!-- Mode-specific inputs -->
                        <div id="shelfCountInput" style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Number of Shelves:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="number" id="spNumShelves" min="1" placeholder="5" oninput="calculateSpacing()" style="width: 100px; padding: 12px;">
                                <span style="font-weight: 600; color: var(--text-secondary);">shelves</span>
                            </div>
                        </div>
                        
                        <div id="shelfSpacingInput" style="display: none; margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Desired Spacing:</label>
                            <input type="text" id="smartDesiredSpacing" placeholder="Try: 12&quot;, 1', 300mm" class="wide-input" oninput="handleSmartInput(this, 'previewDesiredSpacing', updateDesiredSpacingValue)" style="padding: 12px;">
                            <div id="previewDesiredSpacing" class="input-preview"></div>
                        </div>
                        
                        <!-- Material Thickness -->
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Material Thickness:</label>
                            <select id="shelfThicknessSelect" onchange="updateShelfThickness()" style="width: 100%; padding: 12px; margin-bottom: 10px;">
                                <option value="none">None (Center Marks Only)</option>
                                <option value="0.75" selected>3/4" (Standard)</option>
                                <option value="0.5">1/2"</option>
                                <option value="1.0">1"</option>
                                <option value="1.5">1-1/2"</option>
                                <option value="custom">Custom Thickness</option>
                            </select>
                            <div id="customThicknessRow" style="display: none;">
                                <input type="text" id="smartShelfThickness" placeholder="Try: 3/4&quot; or 0.75&quot; or 19mm" class="wide-input" oninput="handleSmartInput(this, 'previewShelfThickness', updateShelfThicknessValue)" style="padding: 12px;">
                                <div id="previewShelfThickness" class="input-preview"></div>
                            </div>
                        </div>
                        
                        <!-- Clear Button -->
                        <div style="text-align: right; margin-top: 15px;">
                            <button class="btn btn-secondary" onclick="clearShelfCalculator()" style="padding: 10px 20px;">Clear All</button>
                        </div>
                    </div>
                    
                    <!-- Results Section -->
                    <div class="calc-result" style="margin-bottom: 20px;">
                        <div class="result-display" id="spResult" style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px;">Enter dimensions to calculate</div>
                        <button class="btn btn-success" onclick="saveSpacingToProject()" style="padding: 12px 24px; font-size: 16px;">💾 Save to Project</button>
                    </div>
                    <div class="calc-visual">
                        <div style="max-height: 700px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; background: #f8f9fa;">
                            <svg id="spacingDiagram" width="100%" height="800" viewBox="0 0 1000 800" style="min-width: 800px; margin: 0 auto; display: block;">
                            <!-- Grid pattern background -->
                            <defs>
                                <pattern id="spacingGrid" width="20" height="20" patternUnits="userSpaceOnUse">
                                    <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#e0e0e0" stroke-width="0.5"/>
                                </pattern>
                                <!-- Wood grain pattern for cabinet -->
                                <pattern id="cabinetWood" patternUnits="userSpaceOnUse" width="120" height="30">
                                    <rect width="120" height="30" fill="#F5DEB3"/>
                                    <path d="M0,5 Q30,3 60,5 T120,5" stroke="#DDD0A5" stroke-width="0.8" fill="none"/>
                                    <path d="M0,15 Q20,12 40,15 T120,15" stroke="#E6D8B5" stroke-width="1" fill="none"/>
                                    <path d="M0,25 Q40,22 80,25 T120,25" stroke="#DDD0A5" stroke-width="0.9" fill="none"/>
                                </pattern>
                            </defs>
                            <rect width="400" height="400" fill="url(#spacingGrid)" />
                            
                            <!-- Cabinet frame (will be updated dynamically) -->
                            <g id="cabinetFrame">
                                <rect x="100" y="50" width="120" height="280" fill="url(#cabinetWood)" stroke="var(--primary-color)" stroke-width="3" rx="4"/>
                                
                                <!-- Default message -->
                                <text x="200" y="200" text-anchor="middle" font-size="14" fill="#666">
                                    Enter dimensions to see cabinet layout
                                </text>
                            </g>
                            
                            <!-- Shelves group (will be populated dynamically) -->
                            <g id="shelvesGroup">
                                <!-- Dynamic shelves will be added here -->
                            </g>
                            
                            <!-- Measurements group (will be populated dynamically) -->
                            <g id="measurementsGroup">
                                <text x="80" y="60" text-anchor="end" font-size="12" fill="var(--primary-color)" font-weight="bold">0"</text>
                                <text x="80" y="340" text-anchor="end" font-size="12" fill="var(--primary-color)" font-weight="bold">Total</text>
                            </g>
                            
                            <!-- Title -->
                            <text x="500" y="35" text-anchor="middle" font-size="18" font-weight="bold" fill="var(--primary-color)">Cabinet Layout</text>
                            <text x="500" y="780" text-anchor="middle" font-size="14" fill="#666">Vertical spacing visualization</text>
                        </svg>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Cabinet Drawer & Face Frame Layout Calculator -->
            <div class="calc-card" id="cabinetDrawerCard">
                <div class="calc-card-header" onclick="toggleCalcCard('cabinetDrawer')">
                    <span class="calc-icon">🗄️</span>
                    <span class="calc-title">Cabinet Drawer & Face Frame Layout</span>
                    <button class="calc-help-btn" onclick="event.stopPropagation(); showCalculatorHelp('cabinetDrawer')" title="Help">?</button>
                    <span class="calc-arrow">▼</span>
                </div>
                <div class="calc-card-content" id="cabinetDrawerContent" style="display: none !important; overflow: visible;">
                    <div class="calc-description">Design drawer fronts and face frame rails for inset and overlay cabinetry</div>
                    
                    <!-- Visual Preview Panel -->
                    <div class="settings-panel" style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px; overflow: visible; min-height: 0;">
                        <h4 style="margin: 0 0 15px 0; color: var(--primary-color); font-size: 16px;">Visual Preview</h4>
                        <div class="calc-visual" id="cabinetDiagramContainer" style="overflow: visible; min-height: 0; height: auto;">
                            <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; margin-bottom: 20px;">
                                <!-- Front View -->
                                <div style="text-align: center;">
                                    <h5 style="margin: 0 0 10px 0; color: var(--text-secondary); font-size: 14px;">Front View</h5>
                                    <svg id="cabinetFrontView" width="400" height="400" viewBox="0 0 400 400" style="border: 1px solid #ddd; border-radius: 4px; background: white;">
                                        <defs>
                                            <pattern id="drawerWood" patternUnits="userSpaceOnUse" width="60" height="30">
                                                <rect width="60" height="30" fill="#D2691E"/>
                                                <path d="M0,5 Q15,3 30,5 T60,5" stroke="#BC611A" stroke-width="0.8" fill="none"/>
                                                <path d="M0,15 Q10,12 20,15 T60,15" stroke="#C86A1C" stroke-width="1" fill="none"/>
                                                <path d="M0,25 Q20,22 40,25 T60,25" stroke="#BC611A" stroke-width="0.9" fill="none"/>
                                            </pattern>
                                            <pattern id="railWood" patternUnits="userSpaceOnUse" width="60" height="20">
                                                <rect width="60" height="20" fill="#8B4513"/>
                                                <path d="M0,5 Q15,4 30,5 T60,5" stroke="#7A3A0F" stroke-width="0.8" fill="none"/>
                                                <path d="M0,15 Q20,14 40,15 T60,15" stroke="#7A3A0F" stroke-width="0.8" fill="none"/>
                                            </pattern>
                                        </defs>
                                        <!-- Cabinet outline -->
                                        <rect x="70" y="20" width="260" height="360" fill="none" stroke="#666" stroke-width="2" stroke-dasharray="5,5"/>
                                        <text x="200" y="200" text-anchor="middle" font-size="14" fill="#999">
                                            Configure cabinet to see layout
                                        </text>
                                    </svg>
                                </div>
                                <!-- Rail Placement View -->
                                <div style="text-align: center;">
                                    <h5 style="margin: 0 0 10px 0; color: var(--text-secondary); font-size: 14px;">Rail Placement</h5>
                                    <svg id="cabinetRailView" width="400" height="400" viewBox="0 0 400 400" style="border: 1px solid #ddd; border-radius: 4px; background: white;">
                                        <!-- Cabinet outline -->
                                        <rect x="20" y="20" width="260" height="360" fill="none" stroke="#666" stroke-width="2" stroke-dasharray="5,5"/>
                                        <text x="150" y="200" text-anchor="middle" font-size="14" fill="#999">
                                            Rail placement guide
                                        </text>
                                    </svg>
                                    <p style="margin: 10px 0 0 0; font-size: 11px; color: #666;">All measurements from bottom of cabinet</p>
                                </div>
                            </div>
                            
                            
                        </div>
                    </div>
                    
                    <!-- Drawer Box Views (shown when drawer box is enabled) -->
                    <div id="drawerBoxDiagramContainer" class="settings-panel" style="display: none; background: #f8f9fa; border-radius: 12px; padding: 20px; margin-top: 20px; margin-bottom: 20px; overflow: visible;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; color: var(--primary-color); font-size: 16px;">Drawer Box Construction</h4>
                            <div id="drawerSelector" style="display: none; align-items: center; gap: 10px;">
                                <label style="font-size: 14px; color: #666;">Showing:</label>
                                <select id="selectedDrawer" onchange="updateSelectedDrawer()" style="padding: 5px 10px; border-radius: 4px; border: 1px solid #ddd;">
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>
                        </div>
                        
                        <!-- Top View - Joinery Detail -->
                        <div style="text-align: center; margin-bottom: 25px;">
                            <h5 style="margin: 0 0 15px 0; color: #666; font-size: 14px; font-weight: 600;">Top View - Box Construction & Joinery</h5>
                            <svg id="drawerBoxTopView" width="600" height="500" viewBox="0 0 600 500" style="border: 1px solid #ddd; background: white; border-radius: 4px; max-width: 100%; height: auto;"></svg>
                        </div>
                        
                        <!-- Dimension Display -->
                        <div id="boxDimensionDisplay" style="padding: 15px; background: #fff; border: 1px solid #ddd; border-radius: 8px; text-align: center; margin-bottom: 25px;">
                            <h6 style="margin: 0 0 10px 0; font-weight: bold;">Box Dimensions</h6>
                            <div id="boxDimensionText" style="color: #666;">Hover over components to see details</div>
                        </div>
                        
                        <!-- Face-to-Box Mounting Diagram -->
                        <div id="faceToBoxMountingDiagram" style="padding: 20px; background: #f9f9f9; border-radius: 8px; border: 1px solid #e0e0e0; display: none; overflow: hidden;">
                            <h5 style="margin: 0 0 15px 0; text-align: center; color: var(--text-secondary); font-size: 16px; font-weight: 600;">Face-to-Box Mounting Alignment</h5>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; max-width: 100%;">
                                <!-- Front Mounting View -->
                                <div style="text-align: center;">
                                    <h6 style="margin: 0 0 10px 0; color: var(--text-secondary); font-size: 13px; font-weight: 600;">Front View - Face Alignment</h6>
                                    <svg id="faceToBoxFrontView" width="450" height="450" viewBox="0 0 450 450" style="border: 1px solid #ddd; border-radius: 4px; background: white; width: 100%; max-width: 100%; height: auto;">
                                        <!-- Content will be dynamically generated -->
                                    </svg>
                                </div>
                                <!-- Side Mounting View -->
                                <div style="text-align: center;">
                                    <h6 style="margin: 0 0 10px 0; color: var(--text-secondary); font-size: 13px; font-weight: 600;">Side View - Mounting Detail</h6>
                                    <svg id="faceToBoxSideView" width="450" height="450" viewBox="0 0 450 450" style="border: 1px solid #ddd; border-radius: 4px; background: white; width: 100%; max-width: 100%; height: auto;">
                                        <!-- Content will be dynamically generated -->
                                    </svg>
                                </div>
                            </div>
                            <!-- Mounting Instructions -->
                            <div style="padding: 15px; background: #fff3cd; border-radius: 6px; border: 1px solid #ffeaa7;">
                                <h6 style="margin: 0 0 10px 0; color: #856404; font-size: 14px; font-weight: 600;">Critical Mounting Instructions:</h6>
                                <ol style="margin: 0; padding-left: 20px; font-size: 13px; color: #856404; line-height: 1.4;">
                                    <li>Position drawer face on flat surface, back side up</li>
                                    <li>Measure and mark center lines for horizontal and vertical alignment</li>
                                    <li>Position drawer box on face using the offset dimensions shown</li>
                                    <li>Pre-drill pilot holes 1" from edges at marked locations</li>
                                    <li>Attach with 1 1/4" screws from inside the box</li>
                                    <li>Verify alignment before fully tightening all screws</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Calculator Inputs -->
                    <div class="settings-panel" style="background: #f8f9fa; border-radius: 12px; padding: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--primary-color); font-size: 16px;">Cabinet Configuration</h4>
                        
                        <!-- Cabinet Dimensions -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Opening Height:</label>
                                <input type="text" id="smartCabinetHeight" placeholder="Try: 30&quot;, 2'6&quot;, 762mm" class="wide-input" 
                                       oninput="handleSmartInput(this, 'previewCabinetHeight', updateCabinetHeightValue)" style="padding: 12px;">
                                <div id="previewCabinetHeight" class="input-preview"></div>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Opening Width:</label>
                                <input type="text" id="smartCabinetWidth" placeholder="Try: 24&quot;, 2', 610mm" class="wide-input" 
                                       oninput="handleSmartInput(this, 'previewCabinetWidth', updateCabinetWidthValue)" style="padding: 12px;">
                                <div id="previewCabinetWidth" class="input-preview"></div>
                            </div>
                        </div>
                        
                        <!-- Frame Style Selection -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Frame Style:</label>
                            <div style="display: flex; gap: 10px;">
                                <button class="mode-btn active" onclick="setFrameStyle('inset')" id="frameStyleInset" style="flex: 1;">Inset</button>
                                <button class="mode-btn" onclick="setFrameStyle('overlay')" id="frameStyleOverlay" style="flex: 1;">Overlay</button>
                            </div>
                        </div>
                        
                        <!-- Drawer Configuration Mode -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Drawer Heights:</label>
                            <div style="display: flex; gap: 10px;">
                                <button class="mode-btn active" onclick="setCabinetDrawerMode('equal')" id="drawerModeEqual" style="flex: 1;">Equal Heights</button>
                                <button class="mode-btn" onclick="setCabinetDrawerMode('custom')" id="drawerModeCustom" style="flex: 1;">Custom Heights</button>
                            </div>
                        </div>
                        
                        <!-- Equal Mode Input -->
                        <div id="equalDrawerInput" style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Number of Drawers:</label>
                            <input type="number" id="numDrawers" min="1" max="10" value="3" 
                                   oninput="calculateCabinetLayout()" style="width: 100px; padding: 12px;">
                        </div>
                        
                        <!-- Custom Mode Input -->
                        <div id="customDrawerInput" style="display: none; margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Custom Drawer Heights:</label>
                            <div id="customDrawerList" style="margin-bottom: 10px;">
                                <!-- Dynamic drawer inputs will be added here -->
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="addCustomDrawer()">+ Add Drawer</button>
                        </div>
                        
                        <!-- Inset Settings -->
                        <div id="insetSettings" style="margin-bottom: 20px;">
                            <h5 style="margin: 0 0 10px 0; color: var(--text-secondary); font-size: 14px;">Reveal Settings (Inset)</h5>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-size: 13px;">Horizontal Reveal:</label>
                                    <input type="text" id="smartHorizontalReveal" placeholder="1/8&quot; typical" class="wide-input" 
                                           value="1/8" oninput="handleSmartInput(this, 'previewHReveal', updateHorizontalRevealValue)" style="padding: 10px;">
                                    <div id="previewHReveal" class="input-preview"></div>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-size: 13px;">Vertical Reveal:</label>
                                    <input type="text" id="smartVerticalReveal" placeholder="1/8&quot; typical" class="wide-input" 
                                           value="1/8" oninput="handleSmartInput(this, 'previewVReveal', updateVerticalRevealValue)" style="padding: 10px;">
                                    <div id="previewVReveal" class="input-preview"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Overlay Settings -->
                        <div id="overlaySettings" style="display: none; margin-bottom: 20px;">
                            <h5 style="margin: 0 0 10px 0; color: var(--text-secondary); font-size: 14px;">Overlay Settings</h5>
                            <label style="display: block; margin-bottom: 5px; font-size: 13px;">Overlay Amount:</label>
                            <input type="text" id="smartOverlayAmount" placeholder="3/4&quot; typical" class="wide-input" 
                                   value="3/4" oninput="handleSmartInput(this, 'previewOverlay', updateOverlayAmountValue)" style="padding: 10px;">
                            <div id="previewOverlay" class="input-preview"></div>
                        </div>
                        
                        <!-- Rail Settings -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Face Frame Rail Thickness:</label>
                            <select id="railThicknessSelect" onchange="updateRailThickness()" style="width: 100%; padding: 12px; margin-bottom: 10px;">
                                <option value="0">No Rails (Drawer fronts only)</option>
                                <option value="0.75">3/4" Rails</option>
                                <option value="1.5" selected>1-1/2" Rails (Standard)</option>
                                <option value="2.0">2" Rails</option>
                                <option value="custom">Custom Thickness</option>
                            </select>
                            <div id="customRailRow" style="display: none;">
                                <input type="text" id="smartRailThickness" placeholder="Try: 1.5&quot;, 38mm" class="wide-input" 
                                       oninput="handleSmartInput(this, 'previewRailThickness', updateRailThicknessValue)" style="padding: 12px;">
                                <div id="previewRailThickness" class="input-preview"></div>
                            </div>
                        </div>
                        
                        <!-- Drawer Box Details Section -->
                        <div style="margin-bottom: 20px; border-top: 2px solid #e0e0e0; margin-top: 25px; padding-top: 20px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                                <input type="checkbox" id="includeDrawerBox" onchange="toggleDrawerBox()" style="width: 20px; height: 20px;">
                                <label for="includeDrawerBox" style="font-weight: 600; font-size: 16px; cursor: pointer;">Calculate Drawer Box Dimensions</label>
                                <button class="calc-help-btn" onclick="showDrawerBoxHelp()" title="Drawer Box Terminology" style="margin-left: auto;">?</button>
                            </div>
                            
                            <div id="drawerBoxSettings" style="display: none;">
                                <!-- Slide Configuration -->
                                <div style="background: #f0f4f8; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                                    <h5 style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 14px;">Slide Configuration</h5>
                                    
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: block; margin-bottom: 5px; font-size: 13px;">Slide Type:</label>
                                        <div style="display: flex; gap: 10px;">
                                            <button class="mode-btn active" onclick="setSlideType('side')" id="slideTypeSide" style="flex: 1;">Side Mount</button>
                                            <button class="mode-btn" onclick="setSlideType('bottom')" id="slideTypeBottom" style="flex: 1;">Bottom Mount</button>
                                        </div>
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-size: 13px;">Box-to-Cabinet Clearance <span style="color: #666;">(per side)</span>:</label>
                                            <input type="text" id="smartSideClearance" placeholder="1/2&quot; typical for side mount" class="wide-input" 
                                                   value="1/2" oninput="handleSmartInput(this, 'previewSideClearance', updateSideClearanceValue)" style="padding: 10px;">
                                            <div id="previewSideClearance" class="input-preview"></div>
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-size: 13px;">Rear Clearance:</label>
                                            <input type="text" id="smartRearClearance" placeholder="1&quot; typical" class="wide-input" 
                                                   value="1" oninput="handleSmartInput(this, 'previewRearClearance', updateRearClearanceValue)" style="padding: 10px;">
                                            <div id="previewRearClearance" class="input-preview"></div>
                                        </div>
                                    </div>
                                    
                                    <div id="bottomMountNote" style="display: none; margin-top: 8px; padding: 8px 12px; background: #fff3cd; border-radius: 4px; font-size: 12px; color: #856404;">
                                        <strong>Note:</strong> Bottom mount slides require:<br>
                                        • 3/16"-1/4" side clearance (less than side mount)<br>
                                        • 1/2" minimum top clearance<br>
                                        • 3/8" bottom clearance for clip hardware
                                    </div>
                                    
                                    <div style="margin-top: 10px;">
                                        <label style="display: block; margin-bottom: 5px; font-size: 13px;">Top Clearance <span style="color: #666;">(1/2" min for bottom mount)</span>:</label>
                                        <input type="text" id="smartTopClearance" placeholder="1/2&quot; typical" class="wide-input" 
                                               value="1/2" oninput="handleSmartInput(this, 'previewTopClearance', updateTopClearanceValue)" style="padding: 10px; max-width: 200px;">
                                        <div id="previewTopClearance" class="input-preview"></div>
                                    </div>
                                    
                                    <div id="bottomClearanceDiv" style="margin-top: 10px; display: none;">
                                        <label style="display: block; margin-bottom: 5px; font-size: 13px;">Bottom Clearance <span style="color: #666;">(for clip hardware)</span>:</label>
                                        <input type="text" id="smartBottomClearance" placeholder="3/8&quot; typical for bottom mount" class="wide-input" 
                                               value="3/8" oninput="handleSmartInput(this, 'previewBottomClearance', updateBottomClearanceValue)" style="padding: 10px; max-width: 200px;">
                                        <div id="previewBottomClearance" class="input-preview"></div>
                                    </div>
                                </div>
                                
                                <!-- Cabinet Dimensions -->
                                <div style="background: #f0f4f8; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                                    <h5 style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 14px;">Cabinet Dimensions</h5>
                                    
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 600;">Cabinet Interior Clear Depth <span style="color: #666;">(inside face frame to inside back wall)</span>:</label>
                                        <input type="text" id="smartCabinetDepth" placeholder="Try: 22&quot;, 560mm" class="wide-input" 
                                               oninput="handleSmartInput(this, 'previewCabinetDepth', updateCabinetDepthValue)" style="padding: 12px;">
                                        <div id="previewCabinetDepth" class="input-preview"></div>
                                    </div>
                                    
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: block; margin-bottom: 5px; font-size: 13px;">Cabinet Material Thickness <span style="color: #666;">(for overlay calculations)</span>:</label>
                                        <input type="text" id="smartCabinetMaterial" placeholder="Try: 3/4&quot;, 0.75&quot;, 19mm" class="wide-input" 
                                               value="3/4" oninput="handleSmartInput(this, 'previewCabinetMaterial', updateCabinetMaterialThicknessValue)" style="padding: 10px;">
                                        <div id="previewCabinetMaterial" class="input-preview"></div>
                                    </div>
                                </div>
                                
                                <!-- Box Construction & Material -->
                                <div style="background: #f0f4f8; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                                    <h5 style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 14px;">Box Construction & Material</h5>
                                    <div style="background: #fff3cd; border-radius: 4px; padding: 8px 12px; margin-bottom: 12px; font-size: 11px; color: #856404;">
                                        <strong>Tip:</strong> Groove depth should be 1/16" deeper than panel thickness for easy assembly
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-size: 13px;">Box Material Thickness:</label>
                                            <input type="text" id="smartBoxMaterial" placeholder="Try: 3/4&quot;, 0.75&quot;, 19mm" class="wide-input" 
                                                   value="3/4" oninput="handleSmartInput(this, 'previewBoxMaterial', updateBoxMaterialValue)" style="padding: 10px;">
                                            <div id="previewBoxMaterial" class="input-preview"></div>
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-size: 13px;">Bottom Panel Thickness:</label>
                                            <input type="text" id="smartBottomPanel" placeholder="1/4&quot; typical" class="wide-input" 
                                                   value="1/4" oninput="handleSmartInput(this, 'previewBottomPanel', updateBottomPanelValue)" style="padding: 10px;">
                                            <div id="previewBottomPanel" class="input-preview"></div>
                                        </div>
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-size: 13px;">Bottom Groove Depth <span style="color: #666; font-size: 11px;">(cut depth)</span>:</label>
                                            <input type="text" id="smartDadoDepth" placeholder="5/16&quot; typical for 1/4&quot; panel" class="wide-input" 
                                                   value="5/16" oninput="handleSmartInput(this, 'previewDadoDepth', updateDadoDepthValue)" style="padding: 10px;">
                                            <div id="previewDadoDepth" class="input-preview"></div>
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-size: 13px;">Groove Position <span style="color: #666; font-size: 11px;">(up from bottom)</span>:</label>
                                            <input type="text" id="smartDadoHeight" placeholder="1/4&quot; typical" class="wide-input" 
                                                   value="1/4" oninput="handleSmartInput(this, 'previewDadoHeight', updateDadoHeightValue)" style="padding: 10px;">
                                            <div id="previewDadoHeight" class="input-preview"></div>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-top: 10px;">
                                        <label style="display: block; margin-bottom: 5px; font-size: 13px;">Drawer Face Thickness:</label>
                                        <input type="text" id="smartFaceThickness" placeholder="3/4&quot; typical" class="wide-input" 
                                               value="3/4" oninput="handleSmartInput(this, 'previewFaceThickness', updateFaceThicknessValue)" style="padding: 10px; max-width: 200px;">
                                        <div id="previewFaceThickness" class="input-preview"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Clear Button -->
                        <div style="text-align: right;">
                            <button class="btn btn-secondary" onclick="clearCabinetCalculator()" style="padding: 10px 20px;">Clear All</button>
                        </div>
                    </div>
                    
                    <!-- Results Section -->
                    <div class="calc-result" style="margin-top: 20px;">
                        <div class="result-display" id="cabinetResult" style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px;">
                            <div class="result-placeholder">Enter cabinet dimensions to calculate layout</div>
                        </div>
                        <div id="cabinetCutList" style="display: none; padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px;">
                            <!-- Cut list will be populated here -->
                        </div>
                        <button class="btn btn-success" onclick="saveCabinetToProject()" style="padding: 12px 24px; font-size: 16px;">💾 Save to Project</button>
                    </div>
                </div>
            </div>
            </div>
            <!-- End Measurements & Layout Category -->
            
            <!-- Angles & Joinery Category -->
            <div class="calc-category-header" style="background: var(--gradient-primary); padding: 12px 20px; margin: 20px 0 15px 0; border-radius: 8px; border-left: 4px solid var(--primary-color); cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleCategory('angles')">
                <h3 style="margin: 0; color: var(--text-on-primary); font-size: 18px; font-weight: 600;">🔧 Angles & Joinery</h3>
                <span class="category-arrow" id="angles-arrow" style="color: var(--text-on-primary);">▶</span>
            </div>
            <div class="calc-category-content" id="angles-content" style="display: none;">

            <!-- Miter Angle Calculator -->
            <div class="calc-card" id="angleCard">
                <div class="calc-card-header" onclick="toggleCalcCard('angle')">
                    <span class="calc-icon">📐</span>
                    <span class="calc-title">Miter Angle Calculator</span>
                    <button class="calc-help-btn" onclick="event.stopPropagation(); showCalculatorHelp('angle')" title="Help">?</button>
                    <span class="calc-arrow">▼</span>
                </div>
                <div class="calc-card-content" id="angleContent" style="display: none !important; padding-bottom: 10px;">
                    <div class="calc-description">Calculate miter angles for frames and single board cuts</div>
                    
                    <!-- Visual Preview Panel -->
                    <div class="settings-panel" style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--primary-color); font-size: 16px;">Visual Preview</h4>
                        <div class="calc-visual" id="angleDiagramContainer" style="min-height: 200px; position: relative;">
                            <!-- Diagram will be populated by updateMiterDiagram() -->
                        </div>
                    </div>
                    
                    <!-- Mode Selection Panel -->
                    <div class="settings-panel" style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--primary-color); font-size: 16px;">Mode Selection</h4>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="mode-btn active" onclick="setMiterMode('frame')" id="miterModeFrame" style="flex: 1; min-width: 150px;">🔲 Frame Builder</button>
                            <button class="mode-btn" onclick="setMiterMode('single')" id="miterModeSingle" style="flex: 1; min-width: 150px;">🪚 Single Board Cut</button>
                        </div>
                    </div>
                    
                    <!-- Configuration Panel -->
                    <div class="settings-panel" style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--primary-color); font-size: 16px;">Configuration</h4>
                        <div class="calc-inputs">
                            <!-- Frame Builder Inputs -->
                            <div id="frameMiterInputs">
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Frame Shape:</label>
                                    <select id="frameShapeSides" onchange="updateFrameDimensionLabels(); calculateFrameBuilder()" style="width: 100%; padding: 12px;">
                                        <option value="4" selected>Rectangle/Square</option>
                                        <option value="3">Triangle</option>
                                        <option value="6">Hexagon</option>
                                        <option value="8">Octagon</option>
                                        <option value="5">Pentagon</option>
                                        <option value="7">Heptagon</option>
                                    </select>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Material Width:</label>
                                    <input type="text" id="smartFrameMaterialWidth" placeholder="Try: 2&quot;, 1.5&quot;, 1 1/2&quot;" class="wide-input smart-input" oninput="handleSmartInput(this, 'previewFrameMaterialWidth', updateFrameMaterialWidthValue)" style="padding: 12px;">
                                    <div id="previewFrameMaterialWidth" class="input-preview"></div>
                                </div>
                                <div style="display: none;">
                                    <!-- Hidden legacy inputs for backward compatibility -->
                                    <input type="number" id="frameMaterialWidthFeet" placeholder="0" min="0" class="wide-input" onchange="calculateFrameBuilder()">
                                    <input type="number" id="frameMaterialWidthInches" placeholder="2" min="0" max="11" class="wide-input" onchange="calculateFrameBuilder()">
                                    <select id="frameMaterialWidthFraction" style="width: 120px;" onchange="calculateFrameBuilder()">
                                        <option value="0" selected>0</option>
                                        <option value="0.0625">1/16"</option>
                                        <option value="0.125">1/8"</option>
                                        <option value="0.1875">3/16"</option>
                                        <option value="0.25">1/4"</option>
                                        <option value="0.3125">5/16"</option>
                                        <option value="0.375">3/8"</option>
                                        <option value="0.4375">7/16"</option>
                                        <option value="0.5">1/2"</option>
                                        <option value="0.5625">9/16"</option>
                                        <option value="0.625">5/8"</option>
                                        <option value="0.6875">11/16"</option>
                                        <option value="0.75">3/4"</option>
                                        <option value="0.8125">13/16"</option>
                                        <option value="0.875">7/8"</option>
                                        <option value="0.9375">15/16"</option>
                                    </select>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Dimension Type:</label>
                                    <select id="frameDimensionType" onchange="updateFrameDimensionLabels(); calculateFrameBuilder()" style="width: 100%; padding: 12px;">
                                        <option value="outer">Outer dimensions</option>
                                        <option value="inner">Inner dimensions</option>
                                    </select>
                                </div>
                                
                                <!-- Rectangle dimensions (width & height) -->
                                <div id="frameRectangleDimensions">
                                    <div id="frameWidthInput" style="margin-bottom: 15px;">
                                        <label id="frameWidthLabel" style="display: block; margin-bottom: 8px; font-weight: 600;">Frame outer width:</label>
                                        <input type="text" id="smartFrameWidth" placeholder="Try: 8&quot;, 0.667', 8 1/2&quot;" class="wide-input smart-input" oninput="handleSmartInput(this, 'previewFrameWidth', updateFrameWidthValue)" style="padding: 12px;">
                                        <div id="previewFrameWidth" class="input-preview"></div>
                                    </div>
                                <div style="display: none;">
                                    <!-- Hidden legacy inputs for backward compatibility -->
                                    <input type="number" id="frameWidthFeet" placeholder="0" min="0" class="wide-input" onchange="calculateFrameBuilder()">
                                    <input type="number" id="frameWidthInches" placeholder="8" min="0" max="11" class="wide-input" onchange="calculateFrameBuilder()">
                                    <select id="frameWidthFraction" style="width: 120px;" onchange="calculateFrameBuilder()">
                                        <option value="0" selected>0</option>
                                        <option value="0.0625">1/16"</option>
                                        <option value="0.125">1/8"</option>
                                        <option value="0.1875">3/16"</option>
                                        <option value="0.25">1/4"</option>
                                        <option value="0.3125">5/16"</option>
                                        <option value="0.375">3/8"</option>
                                        <option value="0.4375">7/16"</option>
                                        <option value="0.5">1/2"</option>
                                        <option value="0.5625">9/16"</option>
                                        <option value="0.625">5/8"</option>
                                        <option value="0.6875">11/16"</option>
                                        <option value="0.75">3/4"</option>
                                        <option value="0.8125">13/16"</option>
                                        <option value="0.875">7/8"</option>
                                        <option value="0.9375">15/16"</option>
                                    </select>
                                </div>
                                
                                <div id="frameHeightInput" style="margin-bottom: 15px;">
                                    <label id="frameHeightLabel" style="display: block; margin-bottom: 8px; font-weight: 600;">Frame outer height:</label>
                                    <input type="text" id="smartFrameHeight" placeholder="Try: 10&quot;, 0.833', 10 1/2&quot;" class="wide-input smart-input" oninput="handleSmartInput(this, 'previewFrameHeight', updateFrameHeightValue)" style="padding: 12px;">
                                    <div id="previewFrameHeight" class="input-preview"></div>
                                </div>
                                <div style="display: none;">
                                    <!-- Hidden legacy inputs for backward compatibility -->
                                    <input type="number" id="frameHeightFeet" placeholder="0" min="0" class="wide-input" onchange="calculateFrameBuilder()">
                                    <input type="number" id="frameHeightInches" placeholder="10" min="0" max="11" class="wide-input" onchange="calculateFrameBuilder()">
                                    <select id="frameHeightFraction" style="width: 120px;" onchange="calculateFrameBuilder()">
                                        <option value="0" selected>0</option>
                                        <option value="0.0625">1/16"</option>
                                        <option value="0.125">1/8"</option>
                                        <option value="0.1875">3/16"</option>
                                        <option value="0.25">1/4"</option>
                                        <option value="0.3125">5/16"</option>
                                        <option value="0.375">3/8"</option>
                                        <option value="0.4375">7/16"</option>
                                        <option value="0.5">1/2"</option>
                                        <option value="0.5625">9/16"</option>
                                        <option value="0.625">5/8"</option>
                                        <option value="0.6875">11/16"</option>
                                        <option value="0.75">3/4"</option>
                                        <option value="0.8125">13/16"</option>
                                        <option value="0.875">7/8"</option>
                                        <option value="0.9375">15/16"</option>
                                    </select>
                                </div>
                                </div>
                                
                                <!-- Polygon dimensions (side length) -->
                                <div id="framePolygonDimensions" style="display: none;">
                                    <div style="margin-bottom: 15px;">
                                        <label id="framePolygonLabel" style="display: block; margin-bottom: 8px; font-weight: 600;">Side Length:</label>
                                        <input type="text" id="smartFramePolygon" placeholder="Try: 6&quot;, 0.5', 6 1/2&quot;" class="wide-input smart-input" oninput="handleSmartInput(this, 'previewFramePolygon', updateFramePolygonValue)" style="padding: 12px;">
                                        <div id="previewFramePolygon" class="input-preview"></div>
                                    </div>
                                    <div style="display: none;">
                                        <!-- Hidden legacy inputs for backward compatibility -->
                                        <input type="number" id="framePolygonFeet" placeholder="0" min="0" class="wide-input" onchange="calculateFrameBuilder()">
                                        <input type="number" id="framePolygonInches" placeholder="6" min="0" max="11" class="wide-input" onchange="calculateFrameBuilder()">
                                        <select id="framePolygonFraction" style="width: 120px;" onchange="calculateFrameBuilder()">
                                            <option value="0" selected>0</option>
                                            <option value="0.0625">1/16"</option>
                                            <option value="0.125">1/8"</option>
                                            <option value="0.1875">3/16"</option>
                                            <option value="0.25">1/4"</option>
                                            <option value="0.3125">5/16"</option>
                                            <option value="0.375">3/8"</option>
                                            <option value="0.4375">7/16"</option>
                                            <option value="0.5">1/2"</option>
                                            <option value="0.5625">9/16"</option>
                                            <option value="0.625">5/8"</option>
                                            <option value="0.6875">11/16"</option>
                                            <option value="0.75">3/4"</option>
                                            <option value="0.8125">13/16"</option>
                                            <option value="0.875">7/8"</option>
                                            <option value="0.9375">15/16"</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Single Board Cut Inputs -->
                            <div id="singleMiterInputs" style="display: none;">
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Miter Angle:</label>
                                    <input type="number" id="singleMiterAngle" step="0.5" placeholder="45" oninput="calculateSingleMiter()" style="width: 150px; padding: 12px;">
                                    <span style="margin-left: 10px; color: var(--text-secondary);">degrees</span>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Board Width:</label>
                                    <input type="text" id="smartSingleBoardWidth" placeholder="Try: 3&quot;, 3.5&quot;, 3 1/2&quot;" class="wide-input smart-input" oninput="handleSmartInput(this, 'previewSingleBoardWidth', updateSingleBoardWidthValue)" style="padding: 12px;">
                                    <div id="previewSingleBoardWidth" class="input-preview"></div>
                                </div>
                            <div style="display: none;">
                                <!-- Hidden legacy inputs for backward compatibility -->
                                <input type="number" id="singleBoardWidthFeet" placeholder="0" min="0" class="wide-input" onchange="calculateSingleMiter()">
                                <input type="number" id="singleBoardWidthInches" placeholder="3" min="0" max="11" class="wide-input" onchange="calculateSingleMiter()">
                                <select id="singleBoardWidthFraction" style="width: 120px;" onchange="calculateSingleMiter()">
                                    <option value="0" selected>0</option>
                                    <option value="0.0625">1/16"</option>
                                    <option value="0.125">1/8"</option>
                                    <option value="0.1875">3/16"</option>
                                    <option value="0.25">1/4"</option>
                                    <option value="0.3125">5/16"</option>
                                    <option value="0.375">3/8"</option>
                                    <option value="0.4375">7/16"</option>
                                    <option value="0.5">1/2"</option>
                                    <option value="0.5625">9/16"</option>
                                    <option value="0.625">5/8"</option>
                                    <option value="0.6875">11/16"</option>
                                    <option value="0.75">3/4"</option>
                                    <option value="0.8125">13/16"</option>
                                    <option value="0.875">7/8"</option>
                                    <option value="0.9375">15/16"</option>
                                </select>
                            </div>
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Cut Type:</label>
                                    <select id="singleCutType" onchange="calculateSingleMiter()" style="width: 100%; padding: 12px;">
                                        <option value="one-sided">One-sided (cut one end only)</option>
                                        <option value="dual-sided">Dual-sided (cut both ends)</option>
                                    </select>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Known Side:</label>
                                    <select id="singleKnownSide" onchange="calculateSingleMiter()" style="width: 100%; padding: 12px;">
                                        <option value="long">Long side (back)</option>
                                        <option value="short">Short side (front)</option>
                                    </select>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label id="singleInputLabel" style="display: block; margin-bottom: 8px; font-weight: 600;">Long side length:</label>
                                    <input type="text" id="smartSingleInputLength" placeholder="Try: 12&quot;, 1', 1 0 1/2&quot;" class="wide-input smart-input" oninput="handleSmartInput(this, 'previewSingleInputLength', updateSingleInputLengthValue)" style="padding: 12px;">
                                    <div id="previewSingleInputLength" class="input-preview"></div>
                                </div>
                            <div style="display: none;">
                                <!-- Hidden legacy inputs for backward compatibility -->
                                <input type="number" id="singleInputLengthFeet" placeholder="1" min="0" class="wide-input" onchange="calculateSingleMiter()">
                                <input type="number" id="singleInputLengthInches" placeholder="0" min="0" max="11" class="wide-input" onchange="calculateSingleMiter()">
                                <select id="singleInputLengthFraction" style="width: 120px;" onchange="calculateSingleMiter()">
                                    <option value="0" selected>0</option>
                                    <option value="0.0625">1/16"</option>
                                    <option value="0.125">1/8"</option>
                                    <option value="0.1875">3/16"</option>
                                    <option value="0.25">1/4"</option>
                                    <option value="0.3125">5/16"</option>
                                    <option value="0.375">3/8"</option>
                                    <option value="0.4375">7/16"</option>
                                    <option value="0.5">1/2"</option>
                                    <option value="0.5625">9/16"</option>
                                    <option value="0.625">5/8"</option>
                                    <option value="0.6875">11/16"</option>
                                    <option value="0.75">3/4"</option>
                                    <option value="0.8125">13/16"</option>
                                    <option value="0.875">7/8"</option>
                                    <option value="0.9375">15/16"</option>
                                </select>
                            </div>
                            
                            <!-- Clear Button -->
                            <button class="btn btn-secondary" onclick="clearMiterCalculator()" style="width: 100%; padding: 10px; margin-top: 10px;">Clear</button>
                        </div>
                    </div>
                    
                    <!-- Results Panel -->
                    <div class="calc-result">
                        <h4 style="margin: 0 0 15px 0; color: var(--primary-color); font-size: 16px;">Results</h4>
                        <div id="miterResults">
                            <div class="result-display" id="maResult" style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px;">Select mode and enter dimensions</div>
                            <button class="btn btn-success btn-sm" onclick="saveAngleToProject()" style="width: 100%;">Save to Project</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

            <!-- Screw & Pilot Hole Calculator -->
            <div class="calc-card" id="screwCard">
                <div class="calc-card-header" onclick="toggleCalcCard('screw')">
                    <span class="calc-icon">🔩</span>
                    <span class="calc-title">Screw & Pilot Hole Calculator</span>
                    <button class="calc-help-btn" onclick="event.stopPropagation(); showCalculatorHelp('screw')" title="Help">?</button>
                    <span class="calc-arrow">▼</span>
                </div>
                <div class="calc-card-content" id="screwContent" style="display: none !important;">
                    <div class="calc-description">Find the correct pilot hole, clearance hole, and countersink sizes for any screw</div>
                    
                    <!-- Screw Identification Panel -->
                    <div class="settings-panel" style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--primary-color); font-size: 16px;">Step 1: Identify Your Screw</h4>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                            <button class="mode-btn active" onclick="setScrewIdMode('visual')" id="visualIdTab" style="flex: 1; min-width: 120px;">📏 Visual Size</button>
                            <button class="mode-btn" onclick="setScrewIdMode('common')" id="commonIdTab" style="flex: 1; min-width: 120px;">🔧 Common Types</button>
                            <button class="mode-btn" onclick="setScrewIdMode('measure')" id="measureIdTab" style="flex: 1; min-width: 120px;">📐 Measure</button>
                        </div>

                        <!-- Visual Size Identification -->
                        <div id="visualIdContent" class="id-content">
                            <!-- Calibration Guide -->
                            <div class="zoom-calibration">
                                <p><strong>⚠️ Calibration Required:</strong> Adjust your browser zoom so this line measures exactly 1 inch:</p>
                                <div class="calibration-ruler">
                                    <div class="inch-line"></div>
                                    <span class="ruler-label">1 inch reference</span>
                                </div>
                                <p class="calibration-note">Use Ctrl/Cmd + Plus/Minus to adjust zoom until the line above measures 1" with a ruler</p>
                            </div>
                            
                            <p style="margin-bottom: 15px;">Once calibrated, hold your screw up to these circles to find the matching diameter:</p>
                            
                            <!-- Standard Wood Screws -->
                            <h5 style="margin: 15px 0 10px 0; color: var(--primary-color);">📌 Standard Wood Screws</h5>
                            <div class="screw-size-circles">
                                <div class="size-circle-container">
                                    <div class="size-circle" data-size="0.086" data-name="#2" style="width: 8.2px; height: 8.2px;"></div>
                                    <span class="size-label">#2<br>(0.086")</span>
                                </div>
                                <div class="size-circle-container">
                                    <div class="size-circle" data-size="0.099" data-name="#3" style="width: 9.5px; height: 9.5px;"></div>
                                    <span class="size-label">#3<br>(0.099")</span>
                                </div>
                                <div class="size-circle-container">
                                    <div class="size-circle" data-size="0.112" data-name="#4" style="width: 10.8px; height: 10.8px;"></div>
                                    <span class="size-label">#4<br>(0.112")</span>
                                </div>
                                <div class="size-circle-container">
                                    <div class="size-circle" data-size="0.125" data-name="#5" style="width: 12px; height: 12px;"></div>
                                    <span class="size-label">#5<br>(0.125")</span>
                                </div>
                                <div class="size-circle-container">
                                    <div class="size-circle" data-size="0.138" data-name="#6" style="width: 13.2px; height: 13.2px;"></div>
                                    <span class="size-label">#6<br>(0.138")</span>
                                </div>
                                <div class="size-circle-container">
                                    <div class="size-circle" data-size="0.151" data-name="#7" style="width: 14.5px; height: 14.5px;"></div>
                                    <span class="size-label">#7<br>(0.151")</span>
                                </div>
                                <div class="size-circle-container">
                                    <div class="size-circle" data-size="0.164" data-name="#8" style="width: 15.7px; height: 15.7px;"></div>
                                    <span class="size-label">#8<br>(0.164")</span>
                                </div>
                                <div class="size-circle-container">
                                    <div class="size-circle" data-size="0.177" data-name="#9" style="width: 17px; height: 17px;"></div>
                                    <span class="size-label">#9<br>(0.177")</span>
                                </div>
                            </div>
                            
                            <div class="screw-size-circles" style="margin-top: 10px;">
                                <div class="size-circle-container">
                                    <div class="size-circle" data-size="0.190" data-name="#10" style="width: 18.2px; height: 18.2px;"></div>
                                    <span class="size-label">#10<br>(0.190")</span>
                                </div>
                                <div class="size-circle-container">
                                    <div class="size-circle" data-size="0.203" data-name="#11" style="width: 19.5px; height: 19.5px;"></div>
                                    <span class="size-label">#11<br>(0.203")</span>
                                </div>
                                <div class="size-circle-container">
                                    <div class="size-circle" data-size="0.216" data-name="#12" style="width: 20.7px; height: 20.7px;"></div>
                                    <span class="size-label">#12<br>(0.216")</span>
                                </div>
                                <div class="size-circle-container">
                                    <div class="size-circle" data-size="0.242" data-name="#14" style="width: 23.2px; height: 23.2px;"></div>
                                    <span class="size-label">#14<br>(0.242")</span>
                                </div>
                                <div class="size-circle-container">
                                    <div class="size-circle" data-size="0.25" data-name="1/4" style="width: 24px; height: 24px;"></div>
                                    <span class="size-label">1/4"<br>(0.25")</span>
                                </div>
                                <div class="size-circle-container">
                                    <div class="size-circle" data-size="0.3125" data-name="5/16" style="width: 30px; height: 30px;"></div>
                                    <span class="size-label">5/16"<br>(0.313")</span>
                                </div>
                                <div class="size-circle-container">
                                    <div class="size-circle" data-size="0.375" data-name="3/8" style="width: 36px; height: 36px;"></div>
                                    <span class="size-label">3/8"<br>(0.375")</span>
                                </div>
                            </div>
                            
                            <!-- Lag Bolts/Screws -->
                            <h5 style="margin: 20px 0 10px 0; color: var(--primary-color);">⚡ Lag Bolts/Heavy Duty Screws</h5>
                            <div class="screw-size-circles lag-bolts">
                                <div class="size-circle-container">
                                    <div class="size-circle lag-bolt" data-size="0.375" data-name="3/8 Lag" style="width: 36px; height: 36px;"></div>
                                    <span class="size-label">3/8" Lag<br>(0.375")</span>
                                </div>
                                <div class="size-circle-container">
                                    <div class="size-circle lag-bolt" data-size="0.4375" data-name="7/16 Lag" style="width: 42px; height: 42px;"></div>
                                    <span class="size-label">7/16" Lag<br>(0.438")</span>
                                </div>
                                <div class="size-circle-container">
                                    <div class="size-circle lag-bolt" data-size="0.5" data-name="1/2 Lag" style="width: 48px; height: 48px;"></div>
                                    <span class="size-label">1/2" Lag<br>(0.5")</span>
                                </div>
                                <div class="size-circle-container">
                                    <div class="size-circle lag-bolt" data-size="0.625" data-name="5/8 Lag" style="width: 60px; height: 60px;"></div>
                                    <span class="size-label">5/8" Lag<br>(0.625")</span>
                                </div>
                                <div class="size-circle-container">
                                    <div class="size-circle lag-bolt" data-size="0.75" data-name="3/4 Lag" style="width: 72px; height: 72px;"></div>
                                    <span class="size-label">3/4" Lag<br>(0.75")</span>
                                </div>
                            </div>
                        </div>

                        <!-- Common Types Identification -->
                        <div id="commonIdContent" class="id-content" style="display: none;">
                            <h5 style="margin: 10px 0; color: var(--primary-color);">🔩 Standard Screws</h5>
                            <div class="common-screw-grid">
                                <button class="common-screw-btn" onclick="selectCommonScrew('#6', 'hinge')">
                                    <strong>Hinge Screw #6</strong><br>
                                    <small>Cabinet hardware, hinges</small>
                                </button>
                                <button class="common-screw-btn" onclick="selectCommonScrew('#8', 'wood')">
                                    <strong>Wood Screw #8</strong><br>
                                    <small>Most common cabinet/furniture</small>
                                </button>
                                <button class="common-screw-btn" onclick="selectCommonScrew('#8', 'drywall')">
                                    <strong>Drywall Screw #8</strong><br>
                                    <small>Fine thread, sharp point</small>
                                </button>
                                <button class="common-screw-btn" onclick="selectCommonScrew('#10', 'wood')">
                                    <strong>Wood Screw #10</strong><br>
                                    <small>Heavy furniture, 2x4 construction</small>
                                </button>
                                <button class="common-screw-btn" onclick="selectCommonScrew('#10', 'deck')">
                                    <strong>Deck Screw #10</strong><br>
                                    <small>Exterior construction</small>
                                </button>
                                <button class="common-screw-btn" onclick="selectCommonScrew('#12', 'structural')">
                                    <strong>Structural Screw #12</strong><br>
                                    <small>Heavy-duty construction</small>
                                </button>
                                <button class="common-screw-btn" onclick="selectCommonScrew('pocket', 'kreg')">
                                    <strong>Pocket Screw</strong><br>
                                    <small>Kreg jig screws (2-1/2")</small>
                                </button>
                                <button class="common-screw-btn" onclick="selectCommonScrew('1/4', 'machine')">
                                    <strong>1/4" Machine Screw</strong><br>
                                    <small>Threaded hardware</small>
                                </button>
                            </div>
                            
                            <h5 style="margin: 20px 0 10px 0; color: var(--primary-color);">⚡ Lag Bolts & Heavy Duty</h5>
                            <div class="common-screw-grid">
                                <button class="common-screw-btn lag-btn" onclick="selectCommonScrew('3/8lag', 'lag')">
                                    <strong>3/8" Lag Bolt</strong><br>
                                    <small>Medium structural connections</small>
                                </button>
                                <button class="common-screw-btn lag-btn" onclick="selectCommonScrew('1/2lag', 'lag')">
                                    <strong>1/2" Lag Bolt</strong><br>
                                    <small>Heavy structural, deck posts</small>
                                </button>
                                <button class="common-screw-btn lag-btn" onclick="selectCommonScrew('5/8lag', 'lag')">
                                    <strong>5/8" Lag Bolt</strong><br>
                                    <small>Heavy timber framing</small>
                                </button>
                                <button class="common-screw-btn lag-btn" onclick="selectCommonScrew('3/4lag', 'lag')">
                                    <strong>3/4" Lag Bolt</strong><br>
                                    <small>Massive structural connections</small>
                                </button>
                            </div>
                        </div>

                        <!-- Manual Measurement -->
                        <div id="measureIdContent" class="id-content" style="display: none;">
                            <div class="measurement-units">
                                <label><input type="radio" name="unit" value="inches" checked onchange="toggleMeasurementUnit()"> Inches</label>
                                <label><input type="radio" name="unit" value="mm" onchange="toggleMeasurementUnit()"> Millimeters</label>
                            </div>
                            <div class="input-row">
                                <label>Screw Diameter:</label>
                                <input type="number" id="screwDiameter" step="0.01" min="0.05" max="0.5" placeholder="0.164">
                                <span id="unitLabel">inches</span>
                            </div>
                            <div class="measurement-help">
                                <small>💡 Measure across the threaded part with calipers or ruler</small>
                            </div>
                        </div>
                        
                        <!-- Clear Button -->
                        <button class="btn btn-secondary" onclick="clearScrewCalculator()" style="width: 100%; padding: 10px; margin-top: 10px;">Clear</button>
                    </div>

                    <!-- Selected Screw Display -->
                    <div class="selected-screw" id="selectedScrewDisplay" style="display: none;">
                        <h4>Selected Screw: <span id="selectedScrewType"></span></h4>
                        <div class="screw-specs" id="screwSpecs"></div>
                    </div>

                    <!-- Wood Type Selection -->
                    <div class="wood-selection" id="woodSelection" style="display: none;">
                        <h4>Step 2: Select Wood Type</h4>
                        <div class="wood-type-buttons">
                            <button class="wood-btn" onclick="selectWoodType('softwood')" id="softwoodBtn">
                                🌲 Softwood<br>
                                <small>Pine, Cedar, Fir</small>
                            </button>
                            <button class="wood-btn" onclick="selectWoodType('hardwood')" id="hardwoodBtn">
                                🌳 Hardwood<br>
                                <small>Oak, Maple, Cherry</small>
                            </button>
                            <button class="wood-btn" onclick="selectWoodType('plywood')" id="plywoodBtn">
                                📋 Plywood/MDF<br>
                                <small>Composite Materials</small>
                            </button>
                        </div>
                    </div>

                    <!-- Results Display -->
                    <div class="calc-result" id="screwResults" style="display: none;">
                        <h4 style="font-size: 20px; margin-bottom: 20px;">Step 3: Pilot Hole Recommendations</h4>
                        <div class="result-display" id="screwResultDisplay">Select a screw and wood type</div>
                    </div>
                    
                    <!-- Quick Reference Button -->
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="toggleQuickReference()">
                            📊 Quick Reference Table
                        </button>
                    </div>
                    
                    <!-- Quick Reference Table -->
                    <div id="quickReferenceTable" style="display: none; margin-top: 20px;">
                        <div class="reference-table-container">
                            <h4 style="text-align: center; margin-bottom: 15px;">🔩 Comprehensive Pilot Hole Reference</h4>
                            <table class="screw-reference-table">
                                <thead>
                                    <tr>
                                        <th rowspan="2">Screw Size</th>
                                        <th rowspan="2">Diameter</th>
                                        <th colspan="3">Pilot Hole Size</th>
                                    </tr>
                                    <tr>
                                        <th>Hardwood</th>
                                        <th>Softwood</th>
                                        <th>Plywood/MDF</th>
                                    </tr>
                                </thead>
                                <tbody id="referenceTableBody">
                                    <!-- Table rows will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            </div> <!-- End Angles & Joinery Category -->
            
            <!-- Construction Category -->
            <div class="calc-category-header" style="background: var(--gradient-primary); padding: 12px 20px; margin: 20px 0 15px 0; border-radius: 8px; border-left: 4px solid var(--primary-color); cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleCategory('construction')">
                <h3 style="margin: 0; color: var(--text-on-primary); font-size: 18px; font-weight: 600;">🏗️ Construction</h3>
                <span class="category-arrow" id="construction-arrow" style="color: var(--text-on-primary);">▶</span>
            </div>
            <div class="calc-category-content" id="construction-content" style="display: none;">

            <!-- Grade/Slope Calculator -->
            <div class="calc-card" id="gradeCard">
                <div class="calc-card-header" onclick="toggleCalcCard('grade')">
                    <span class="calc-icon">📐</span>
                    <span class="calc-title">Grade/Slope Calculator</span>
                    <button class="calc-help-btn" onclick="event.stopPropagation(); showCalculatorHelp('grade')" title="Help">?</button>
                    <span class="calc-arrow">▼</span>
                </div>
                <div class="calc-card-content" id="gradeContent" style="display: none !important;">
                    <div class="calc-description">Calculate slopes for ramps, drainage, and construction projects</div>
                    
                    <!-- Visual Preview Panel -->
                    <div class="settings-panel" style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--primary-color); font-size: 16px;">Visual Preview</h4>
                        <div class="calc-visual">
                        <svg id="slopeDiagram" width="100%" height="200" viewBox="0 0 400 200" style="max-width: 400px; margin: 0 auto; display: block;">
                            <!-- Grid lines -->
                            <defs>
                                <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
                                    <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#e0e0e0" stroke-width="0.5"/>
                                </pattern>
                            </defs>
                            <rect width="400" height="200" fill="url(#grid)" />
                            
                            <!-- Ground line -->
                            <line x1="50" y1="170" x2="350" y2="170" stroke="#666" stroke-width="2"/>
                            
                            <!-- Slope triangle -->
                            <path id="slopeTriangle" d="M 50 170 L 300 170 L 300 100 Z" fill="rgba(139, 69, 19, 0.2)" stroke="var(--primary-color)" stroke-width="3"/>
                            
                            <!-- Rise line -->
                            <line x1="300" y1="170" x2="300" y2="100" stroke="#D2691E" stroke-width="3" stroke-dasharray="5,5"/>
                            
                            <!-- Run line -->
                            <line x1="50" y1="170" x2="300" y2="170" stroke="#228B22" stroke-width="3"/>
                            
                            <!-- Angle arc -->
                            <path id="angleArc" d="M 100 170 A 50 50 0 0 0 85.35 139.65" fill="none" stroke="#FF6347" stroke-width="2"/>
                            
                            <!-- Labels -->
                            <text x="175" y="190" text-anchor="middle" font-size="14" font-weight="bold" fill="#228B22">Run</text>
                            <text x="320" y="135" text-anchor="middle" font-size="14" font-weight="bold" fill="#D2691E">Rise</text>
                            <text x="120" y="160" text-anchor="middle" font-size="12" fill="#FF6347" id="angleLabel">Angle</text>
                            
                            <!-- Result display -->
                            <text x="200" y="30" text-anchor="middle" font-size="16" font-weight="bold" fill="#333" id="gradePercentLabel">Grade: --</text>
                            <text x="200" y="50" text-anchor="middle" font-size="14" fill="#666" id="ratioLabel">Ratio: --</text>
                        </svg>
                        </div>
                    </div>
                    
                    <!-- Configuration Panel -->
                    <div class="settings-panel" style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--primary-color); font-size: 16px;">Configuration</h4>
                        
                        <!-- Calculation Mode -->
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Calculate:</label>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="mode-btn active" onclick="setGradeMode('find-grade')" id="gradeModeGrade" style="flex: 1; min-width: 120px;">📊 Find Grade %</button>
                                <button class="mode-btn" onclick="setGradeMode('find-rise')" id="gradeModeRise" style="flex: 1; min-width: 120px;">📏 Find Rise</button>
                                <button class="mode-btn" onclick="setGradeMode('find-run')" id="gradeModeRun" style="flex: 1; min-width: 120px;">↔️ Find Run</button>
                            </div>
                        </div>
                        
                        <!-- Input Fields -->
                        <div class="calc-inputs">
                            <!-- Rise Input -->
                            <div id="gradeRiseInput" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Rise (Vertical):</label>
                                <input type="text" id="smartGradeRise" placeholder="Try: 5&quot;, 6 1/2&quot;, 0.5'" class="wide-input smart-input" oninput="handleSmartInput(this, 'previewGradeRise', updateGradeRiseValue)" style="padding: 12px;">
                                <div id="previewGradeRise" class="input-preview"></div>
                            </div>
                        <div style="display: none;">
                            <!-- Hidden legacy inputs for backward compatibility -->
                            <input type="number" id="gradeRiseFeet" placeholder="0" min="0" class="wide-input" onchange="calculateGradeSlope()">
                            <input type="number" id="gradeRiseInches" placeholder="0" min="0" max="11" class="wide-input" onchange="calculateGradeSlope()">
                            <select id="gradeRiseFraction" style="width: 120px;" onchange="calculateGradeSlope()">
                                <option value="0" selected>0</option>
                                <option value="0.0625">1/16"</option>
                                <option value="0.125">1/8"</option>
                                <option value="0.1875">3/16"</option>
                                <option value="0.25">1/4"</option>
                                <option value="0.3125">5/16"</option>
                                <option value="0.375">3/8"</option>
                                <option value="0.4375">7/16"</option>
                                <option value="0.5">1/2"</option>
                                <option value="0.5625">9/16"</option>
                                <option value="0.625">5/8"</option>
                                <option value="0.6875">11/16"</option>
                                <option value="0.75">3/4"</option>
                                <option value="0.8125">13/16"</option>
                                <option value="0.875">7/8"</option>
                                <option value="0.9375">15/16"</option>
                            </select>
                        </div>
                        
                            <!-- Run Input -->
                            <div id="gradeRunInput" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Run (Horizontal):</label>
                                <input type="text" id="smartGradeRun" placeholder="Try: 12', 144&quot;, 12 0 0&quot;" class="wide-input smart-input" oninput="handleSmartInput(this, 'previewGradeRun', updateGradeRunValue)" style="padding: 12px;">
                                <div id="previewGradeRun" class="input-preview"></div>
                            </div>
                        <div style="display: none;">
                            <!-- Hidden legacy inputs for backward compatibility -->
                            <input type="number" id="gradeRunFeet" placeholder="0" min="0" class="wide-input" onchange="calculateGradeSlope()">
                            <input type="number" id="gradeRunInches" placeholder="0" min="0" max="11" class="wide-input" onchange="calculateGradeSlope()">
                            <select id="gradeRunFraction" style="width: 120px;" onchange="calculateGradeSlope()">
                                <option value="0" selected>0</option>
                                <option value="0.0625">1/16"</option>
                                <option value="0.125">1/8"</option>
                                <option value="0.1875">3/16"</option>
                                <option value="0.25">1/4"</option>
                                <option value="0.3125">5/16"</option>
                                <option value="0.375">3/8"</option>
                                <option value="0.4375">7/16"</option>
                                <option value="0.5">1/2"</option>
                                <option value="0.5625">9/16"</option>
                                <option value="0.625">5/8"</option>
                                <option value="0.6875">11/16"</option>
                                <option value="0.75">3/4"</option>
                                <option value="0.8125">13/16"</option>
                                <option value="0.875">7/8"</option>
                                <option value="0.9375">15/16"</option>
                            </select>
                        </div>
                        
                        <!-- Grade Input (for find rise/run modes) -->
                        <div id="gradePercentInput" class="input-row" style="display: none;">
                            <label>Grade Percentage:</label>
                            <input type="number" id="gradePercent" placeholder="8.33" step="0.01" min="0" onchange="calculateGradeSlope()">
                            <span>%</span>
                        </div>
                        
                        <!-- Common Use Presets -->
                        <div class="preset-section" style="margin-top: 20px;">
                            <h5 style="margin-bottom: 10px; color: var(--primary-color);">Common Applications:</h5>
                            <div class="preset-buttons" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                <button class="preset-btn" onclick="setGradePreset('ada-max', '1:12 ADA Max (8.33%)')">
                                    <strong>ADA Ramp Max</strong><br>
                                    <small>1:12 (8.33%)</small>
                                </button>
                                <button class="preset-btn" onclick="setGradePreset('ada-preferred', '1:20 ADA Preferred (5%)')">
                                    <strong>ADA Preferred</strong><br>
                                    <small>1:20 (5%)</small>
                                </button>
                                <button class="preset-btn" onclick="setGradePreset('drainage-min', 'Min Drainage (1%)')">
                                    <strong>Min Drainage</strong><br>
                                    <small>1:100 (1%)</small>
                                </button>
                                <button class="preset-btn" onclick="setGradePreset('drainage-ideal', 'Ideal Drainage (2%)')">
                                    <strong>Ideal Drainage</strong><br>
                                    <small>1:50 (2%)</small>
                                </button>
                                <button class="preset-btn" onclick="setGradePreset('driveway-max', 'Driveway Max (15%)')">
                                    <strong>Driveway Max</strong><br>
                                    <small>1:6.67 (15%)</small>
                                </button>
                                <button class="preset-btn" onclick="setGradePreset('shed-ramp', 'Shed Ramp (10%)')">
                                    <strong>Shed Ramp</strong><br>
                                    <small>1:10 (10%)</small>
                                </button>
                                <button class="preset-btn" onclick="setGradePreset('stairs-typical', 'Stairs Typical (70%)')">
                                    <strong>Stairs (35°)</strong><br>
                                    <small>7:10 (70%)</small>
                                </button>
                                <button class="preset-btn" onclick="setGradePreset('roof-min', 'Roof Min 4:12 (33%)')">
                                    <strong>Roof Min</strong><br>
                                    <small>4:12 (33.3%)</small>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Clear Button -->
                        <button class="btn btn-secondary" onclick="clearGradeCalculator()" style="width: 100%; padding: 10px; margin-top: 10px;">Clear</button>
                    </div>
                </div>
                    
                <!-- Results Panel -->
                <div class="calc-result" style="margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: var(--primary-color); font-size: 16px;">Results</h4>
                    <div id="gradeResults" style="display: none;">
                        <div class="result-display" id="gradeResultDisplay">
                            <!-- Results will be displayed here -->
                        </div>
                        <button class="btn btn-success btn-sm" onclick="saveGradeToProject()" style="width: 100%; margin-top: 15px;">Save to Project</button>
                    </div>
                    <div id="gradeNoResult" style="text-align: center; color: #666;">Enter values above to calculate</div>
                </div>
            </div>
            </div>

            <!-- Tile Calculator -->
            <div class="calc-card" id="tileCard">
                <div class="calc-card-header" onclick="toggleCalcCard('tile')">
                    <span class="calc-icon">🔲</span>
                    <span class="calc-title">Tile & Paver Calculator</span>
                    <button class="calc-help-btn" onclick="event.stopPropagation(); showCalculatorHelp('tile')" title="Help">?</button>
                    <span class="calc-arrow">▼</span>
                </div>
                <div class="calc-card-content" id="tileContent" style="display: none !important;">
                    <div class="calc-description">Calculate tile quantities, costs, and visualize patterns for flooring projects</div>
                    
                    <!-- Tile Dimensions Panel -->
                    <div class="settings-panel" style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--primary-color); font-size: 16px;">Tile Specifications</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                            <div style="flex: 1; min-width: 200px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Tile Length:</label>
                                <input type="text" id="smartTileLength" placeholder="Try: 12&quot;, 1', 12.5&quot;" class="wide-input" oninput="handleSmartInput(this, 'previewTileLength', updateTileLengthValue)" style="padding: 12px;">
                                <div id="previewTileLength" class="input-preview"></div>
                                <div style="display: none;">
                                    <!-- Hidden legacy inputs for backward compatibility -->
                                    <div class="woodworking-input">
                                        <input type="number" id="tileLengthFeet" min="0" placeholder="0" style="width: 50px;" oninput="calculateSimpleTiles()">
                                        <span class="unit">ft</span>
                                        <input type="number" id="tileLengthInches" min="0" max="11" step="1" placeholder="12" style="width: 50px;" oninput="calculateSimpleTiles()">
                                        <span class="unit">in</span>
                                        <select id="tileLengthFraction" style="width: 70px;" onchange="calculateSimpleTiles()">
                                            <option value="0">-</option>
                                        <option value="0.0625">1/16</option>
                                        <option value="0.125">1/8</option>
                                        <option value="0.1875">3/16</option>
                                        <option value="0.25">1/4</option>
                                        <option value="0.3125">5/16</option>
                                        <option value="0.375">3/8</option>
                                        <option value="0.4375">7/16</option>
                                        <option value="0.5">1/2</option>
                                        <option value="0.5625">9/16</option>
                                        <option value="0.625">5/8</option>
                                        <option value="0.6875">11/16</option>
                                        <option value="0.75">3/4</option>
                                        <option value="0.8125">13/16</option>
                                        <option value="0.875">7/8</option>
                                        <option value="0.9375">15/16</option>
                                    </select>
                                </div>
                            </div>
                            <div style="flex: 1; min-width: 200px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Tile Width:</label>
                                <input type="text" id="smartTileWidth" placeholder="Try: 6&quot;, 0.5', 6.25&quot;" class="wide-input" oninput="handleSmartInput(this, 'previewTileWidth', updateTileWidthValue)" style="padding: 12px;">
                                <div id="previewTileWidth" class="input-preview"></div>
                                <div style="display: none;">
                                    <!-- Hidden legacy inputs for backward compatibility -->
                                    <div class="woodworking-input">
                                        <input type="number" id="tileWidthFeet" min="0" placeholder="0" style="width: 50px;" oninput="calculateSimpleTiles()">
                                        <span class="unit">ft</span>
                                        <input type="number" id="tileWidthInches" min="0" max="11" step="1" placeholder="6" style="width: 50px;" oninput="calculateSimpleTiles()">
                                        <span class="unit">in</span>
                                        <select id="tileWidthFraction" style="width: 70px;" onchange="calculateSimpleTiles()">
                                            <option value="0">-</option>
                                        <option value="0.0625">1/16</option>
                                        <option value="0.125">1/8</option>
                                        <option value="0.1875">3/16</option>
                                        <option value="0.25">1/4</option>
                                        <option value="0.3125">5/16</option>
                                        <option value="0.375">3/8</option>
                                        <option value="0.4375">7/16</option>
                                        <option value="0.5">1/2</option>
                                        <option value="0.5625">9/16</option>
                                        <option value="0.625">5/8</option>
                                        <option value="0.6875">11/16</option>
                                        <option value="0.75">3/4</option>
                                        <option value="0.8125">13/16</option>
                                        <option value="0.875">7/8</option>
                                        <option value="0.9375">15/16</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Grout Spacing -->
                        <div style="margin-top: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Grout Spacing:</label>
                            <select id="groutSpacing" onchange="toggleCustomGrout(); calculateSimpleTiles()" style="width: 100%; padding: 12px;">
                                <option value="0">None</option>
                                <option value="0.0625">1/16"</option>
                                <option value="0.125" selected>1/8" (Standard)</option>
                                <option value="0.1875">3/16"</option>
                                <option value="0.25">1/4"</option>
                                <option value="custom">Custom Size</option>
                            </select>
                            <div id="customGroutRow" style="display: none; margin-top: 10px;">
                                <input type="number" id="customGrout" step="0.01" min="0" placeholder="0.125" oninput="calculateSimpleTiles()" style="width: 100%; padding: 12px;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Project Area Panel -->
                    <div class="settings-panel" style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--primary-color); font-size: 16px;">Project Area</h4>
                        
                        <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px;">
                            <div style="flex: 2; min-width: 150px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Total Square Footage:</label>
                                <input type="number" id="projectSqFt" step="0.1" min="0" placeholder="100" oninput="calculateSimpleTiles()" style="width: 100%; padding: 12px;">
                            </div>
                            <div style="flex: 1; min-width: 150px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Waste Factor:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="range" id="wasteFactor" min="5" max="20" value="10" oninput="updateWasteDisplay(); calculateSimpleTiles()" style="flex: 1;">
                                    <span id="wasteDisplay" style="font-weight: 600; color: var(--text-secondary); min-width: 40px;">10%</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pattern Offset -->
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Pattern Offset (for staggered layout):</label>
                            <select id="tileOffsetSelect" onchange="updateTileOffset()" style="width: 100%; padding: 12px;">
                                <option value="0">None (Stack Bond)</option>
                                <option value="0.5">1/2 Tile (Running Bond)</option>
                                <option value="0.333">1/3 Tile</option>
                                <option value="0.25">1/4 Tile</option>
                                <option value="custom">Custom Offset</option>
                            </select>
                            <div id="customOffsetRow" style="display: none; margin-top: 10px;">
                                <input type="text" id="smartTileOffset" placeholder="Try: 6&quot;, 0.5', 50%" class="wide-input" oninput="handleSmartInput(this, 'previewTileOffset', updateTileOffsetValue)" style="padding: 12px;">
                                <div id="previewTileOffset" class="input-preview"></div>
                            </div>
                            <div id="offsetError" class="error-message" style="display: none; color: #dc3545; font-size: 12px; margin-top: 4px;">
                                Offset cannot exceed tile length
                            </div>
                        </div>
                        
                        <!-- Hidden legacy offset inputs -->
                        <div style="display: none;">
                            <div class="woodworking-input">
                                <input type="number" id="tileOffsetFeet" min="0" placeholder="0" style="width: 50px;" oninput="calculateSimpleTiles()">
                                <span class="unit">ft</span>
                                <input type="number" id="tileOffsetInches" min="0" max="11" step="1" placeholder="0" style="width: 50px;" oninput="calculateSimpleTiles()">
                                <span class="unit">in</span>
                                <select id="tileOffsetFraction" style="width: 70px;" onchange="calculateSimpleTiles()">
                                    <option value="0">-</option>
                                    <option value="0.0625">1/16</option>
                                    <option value="0.125">1/8</option>
                                    <option value="0.1875">3/16</option>
                                    <option value="0.25">1/4</option>
                                    <option value="0.3125">5/16</option>
                                    <option value="0.375">3/8</option>
                                    <option value="0.4375">7/16</option>
                                    <option value="0.5">1/2</option>
                                    <option value="0.5625">9/16</option>
                                    <option value="0.625">5/8</option>
                                    <option value="0.6875">11/16</option>
                                    <option value="0.75">3/4</option>
                                    <option value="0.8125">13/16</option>
                                    <option value="0.875">7/8</option>
                                    <option value="0.9375">15/16</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cost Configuration Panel -->
                    <div class="settings-panel" style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--primary-color); font-size: 16px;">Cost Information</h4>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Pricing Method:</label>
                            <select id="tileCostMethod" onchange="toggleCostInputs(); calculateSimpleTiles()" style="width: 100%; padding: 12px;">
                                <option value="per-tile">Per Tile</option>
                                <option value="per-sqft" selected>Per Square Foot</option>
                                <option value="per-box">Per Box/Case</option>
                            </select>
                        </div>
                        
                        <div class="input-row" id="perTileRow" style="display: none;">
                            <label for="costPerTile">Cost per Tile:</label>
                            <input type="number" id="costPerTile" step="0.01" min="0" placeholder="2.50" oninput="calculateSimpleTiles()">
                            <span class="unit">$</span>
                        </div>
                        
                        <div class="input-row" id="perSqFtRow">
                            <label for="costPerSqFt">Cost per Sq Ft:</label>
                            <input type="number" id="costPerSqFt" step="0.01" min="0" placeholder="8.95" oninput="calculateSimpleTiles()">
                            <span class="unit">$/sq ft</span>
                        </div>
                        
                        <div class="input-row" id="perBoxRow" style="display: none;">
                            <label for="costPerBox">Cost per Box:</label>
                            <input type="number" id="costPerBox" step="0.01" min="0" placeholder="29.99" oninput="calculateSimpleTiles()">
                            <span class="unit">$</span>
                        </div>
                        
                        <div class="input-row" id="tilesPerBoxRow" style="display: none;">
                            <label for="tilesPerBox">Tiles per Box:</label>
                            <input type="number" id="tilesPerBox" step="1" min="1" placeholder="10" oninput="calculateSimpleTiles()">
                            <span class="unit">tiles</span>
                        </div>
                        
                        <div class="input-row" id="sqFtPerBoxRow" style="display: none;">
                            <label for="sqFtPerBox">Sq Ft per Box:</label>
                            <input type="number" id="sqFtPerBox" step="0.1" min="0" placeholder="10.8" oninput="calculateSimpleTiles()">
                            <span class="unit">sq ft</span>
                        </div>
                        
                        <div class="input-row">
                            <label for="additionalCosts">Additional Costs:</label>
                            <input type="number" id="additionalCosts" step="0.01" min="0" placeholder="0.00" oninput="calculateSimpleTiles()">
                            <span class="unit">$ (grout, adhesive, etc.)</span>
                        </div>
                        
                        <!-- Clear Button -->
                        <div style="text-align: right; margin-top: 15px;">
                            <button class="btn btn-secondary" onclick="clearTileCalculator()" style="padding: 10px 20px;">Clear All</button>
                        </div>
                    </div>

                    <!-- Advanced Options Panel -->
                    <div class="settings-panel" style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--primary-color); font-size: 16px; cursor: pointer;" onclick="toggleAdvancedOptions()">
                            Advanced Options <span id="advancedToggle" style="font-size: 12px; color: #666;">▼</span>
                        </h4>
                        <div id="advancedOptions" style="display: none;">
                            <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                                <div style="flex: 1; min-width: 200px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Tile Thickness (for grout calc):</label>
                                    <select id="tileThickness" onchange="calculateSimpleTiles()" style="width: 100%; padding: 12px;">
                                        <option value="0.125">1/8"</option>
                                        <option value="0.1875">3/16"</option>
                                        <option value="0.25" selected>1/4" (standard)</option>
                                        <option value="0.3125">5/16"</option>
                                        <option value="0.375">3/8"</option>
                                        <option value="0.5">1/2"</option>
                                        <option value="0.625">5/8"</option>
                                        <option value="0.75">3/4"</option>
                                        <option value="1">1"</option>
                                    </select>
                                </div>
                                <div style="flex: 1; min-width: 200px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Room Perimeter (for cuts):</label>
                                    <input type="number" id="roomPerimeter" step="0.1" min="0" placeholder="Total wall length" oninput="calculateSimpleTiles()" style="width: 100%; padding: 12px;">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Results Section -->
                    <div class="calc-result" style="margin-bottom: 20px;">
                        <div class="result-display" id="tileResults" style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px;">
                            Enter tile dimensions and project area to calculate
                        </div>
                        <button class="btn btn-success" onclick="saveSimpleTileProject()" style="padding: 12px 24px; font-size: 16px;">💾 Save to Project</button>
                    </div>
                    
                    <!-- Tile Layout Preview -->
                    <div class="calc-visual">
                        <h4 style="margin: 0 0 15px 0; color: var(--primary-color); font-size: 16px;">Layout Preview</h4>
                        <div id="tilePreview" class="tile-preview" style="background: #f8f9fa; border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; min-height: 200px;">
                            <!-- Simple tile grid will be generated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

            <!-- Cut Calculator -->
            <div class="calc-card" id="cutCalcCard">
                <div class="calc-card-header" onclick="toggleCalcCard('cutCalc')">
                    <span class="calc-icon">✂️</span>
                    <span class="calc-title">Cut Calculator</span>
                    <button class="calc-help-btn" onclick="event.stopPropagation(); showCalculatorHelp('cutCalc')" title="Help">?</button>
                    <span class="calc-arrow">▼</span>
                </div>
                <div class="calc-card-content" id="cutCalcContent" style="display: none !important;">
                    <div class="calc-description">Calculate equal divisions with kerf compensation or optimize cuts from available boards</div>
                    
                    <!-- Mode Toggle -->
                    <div class="mode-toggle-section">
                        <div class="mode-toggle">
                            <button class="mode-btn active" id="equalDivisionMode" onclick="switchCutMode('equal')">
                                📏 Equal Division
                            </button>
                            <button class="mode-btn" id="cutOptimizationMode" onclick="switchCutMode('optimization')">
                                🔧 Cut Optimization
                            </button>
                        </div>
                    </div>
                    
                    <!-- Equal Division Mode Content -->
                    <div id="equalDivisionContent" class="mode-content">
                        <!-- Settings Panel -->
                        <div class="settings-panel" style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                            <div style="display: flex; flex-wrap: wrap; gap: 20px;">
                                <!-- Left Column -->
                                <div style="flex: 1; min-width: 250px;">
                                    <div class="settings-row" style="margin-bottom: 15px;">
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">Precision:</label>
                                        <select id="cutPrecision" onchange="updatePrecision('cut')" class="wide-input" style="width: 100%;">
                                            <option value="32">1/32"</option>
                                            <option value="16" selected>1/16"</option>
                                            <option value="8">1/8"</option>
                                            <option value="4">1/4"</option>
                                            <option value="2">1/2"</option>
                                            <option value="1">1"</option>
                                        </select>
                                    </div>
                                    
                                </div>
                                
                                <!-- Right Column -->
                                <div style="flex: 1; min-width: 250px;">
                                    <div class="settings-row" id="cutKerfRow" style="margin-bottom: 15px;">
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">Kerf Width:</label>
                                        <select id="cutKerf" class="wide-input" style="width: 100%;" onchange="updateKerfDiagram()">
                                            <option value="0">None</option>
                                            <option value="0.0625">1/16"</option>
                                            <option value="0.09375">3/32"</option>
                                            <option value="0.125" selected>1/8"</option>
                                            <option value="0.1875">3/16"</option>
                                        </select>
                                    </div>
                                    
                                    <div class="settings-row" id="cutSideRow">
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">Cut Side:</label>
                                        <select id="cutSide" onchange="updateKerfDiagram()" class="wide-input" style="width: 100%;">
                                            <option value="left">Left Side</option>
                                            <option value="right">Right Side</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    
                    <!-- Kerf Visualization -->
                    <div class="kerf-diagram" id="kerfDiagram" style="display: none; background: var(--surface-color); border-radius: 12px; margin-bottom: 20px;">
                        <svg width="100%" height="150" viewBox="0 0 400 150" style="max-width: 400px; margin: 0 auto; display: block;">
                            <!-- Grid pattern background -->
                            <defs>
                                <pattern id="kerfGrid" width="20" height="20" patternUnits="userSpaceOnUse">
                                    <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#e0e0e0" stroke-width="0.5"/>
                                </pattern>
                                <!-- Wood grain pattern -->
                                <pattern id="woodGrain" patternUnits="userSpaceOnUse" width="100" height="60">
                                    <rect width="100" height="60" fill="#D2691E"/>
                                    <path d="M0,10 Q25,5 50,10 T100,10" stroke="#A0522D" stroke-width="0.8" fill="none"/>
                                    <path d="M0,25 Q30,20 60,25 T100,25" stroke="#A0522D" stroke-width="0.6" fill="none"/>
                                    <path d="M0,40 Q20,35 40,40 T100,40" stroke="#A0522D" stroke-width="0.7" fill="none"/>
                                    <path d="M0,55 Q35,50 70,55 T100,55" stroke="#A0522D" stroke-width="0.5" fill="none"/>
                                </pattern>
                            </defs>
                            <rect width="400" height="150" fill="url(#kerfGrid)" />
                            
                            <!-- Board representation -->
                            <rect x="50" y="50" width="300" height="60" fill="url(#woodGrain)" stroke="#654321" stroke-width="3" rx="2"/>
                            
                            <!-- Mark line -->
                            <line x1="200" y1="30" x2="200" y2="130" stroke="#ff0000" stroke-width="2" stroke-dasharray="4,2"/>
                            
                            <!-- Kerf area (will be positioned dynamically) -->
                            <defs>
                                <pattern id="kerfPattern" patternUnits="userSpaceOnUse" width="4" height="4">
                                    <rect width="4" height="4" fill="#ff6b6b"/>
                                    <line x1="0" y1="0" x2="4" y2="4" stroke="white" stroke-width="0.5"/>
                                    <line x1="4" y1="0" x2="0" y2="4" stroke="white" stroke-width="0.5"/>
                                </pattern>
                            </defs>
                            <rect id="kerfAreaSvg" x="200" y="50" width="0" height="60" fill="url(#kerfPattern)" stroke="#ff0000" stroke-width="2"/>
                            
                            <!-- Labels -->
                            <text x="200" y="20" text-anchor="middle" font-size="14" font-weight="bold" fill="#ff0000">Mark</text>
                            <text x="100" y="135" text-anchor="middle" font-size="12" fill="#666">Left piece</text>
                            <text x="300" y="135" text-anchor="middle" font-size="12" fill="#666">Right piece</text>
                            
                            <!-- Kerf label (will be positioned dynamically) -->
                            <text id="kerfLabelSvg" x="200" y="85" text-anchor="middle" font-size="10" font-weight="bold" fill="white" style="display: none;">KERF</text>
                            
                            <!-- Dimension arrows -->
                            <path d="M 55 45 L 195 45 M 55 45 L 60 42 M 55 45 L 60 48 M 195 45 L 190 42 M 195 45 L 190 48" stroke="#333" stroke-width="1" fill="none"/>
                            <path d="M 205 45 L 345 45 M 205 45 L 210 42 M 205 45 L 210 48 M 345 45 L 340 42 M 345 45 L 340 48" stroke="#333" stroke-width="1" fill="none"/>
                        </svg>
                    </div>
                    
                    <!-- Board Input Section -->
                    <div class="calc-section" style="margin-bottom: 25px;">
                        <div class="input-group">
                            <label style="display: block; margin-bottom: 10px; font-weight: 600; font-size: 16px; color: var(--primary-color);">Board Length:</label>
                            <input type="text" id="smartCutLength" placeholder="Try: 8', 96&quot;, 8 0 0&quot;" class="wide-input smart-input" oninput="handleSmartInput(this, 'previewCutLength', updateCutLengthValue)" style="font-size: 18px; padding: 15px;">
                        </div>
                        <div id="previewCutLength" class="input-preview"></div>
                        <div style="display: none;">
                            <!-- Hidden legacy inputs for backward compatibility -->
                            <input type="number" id="cutFeet" placeholder="0" min="0" class="wide-input" onchange="updateCutValue()">
                            <input type="number" id="cutInches" placeholder="0" min="0" max="11" class="wide-input" onchange="updateCutValue()">
                            <select id="cutFraction" style="width: 120px;" onchange="updateCutValue()">
                                <option value="0">0</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Division Controls -->
                    <div class="division-controls calc-section" style="background: var(--surface-color); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--primary-color); font-size: 16px;">Division Options</h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr auto; gap: 15px; align-items: end;">
                            <div class="input-group">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Quick Division:</label>
                                <select id="divisionSelect" class="wide-input" onchange="performDivision()" style="padding: 12px;">
                                    <option value="">Select division...</option>
                                    <option value="2">Half (2 pieces)</option>
                                    <option value="3">Thirds (3 pieces)</option>
                                    <option value="4">Fourths (4 pieces)</option>
                                    <option value="5">Fifths (5 pieces)</option>
                                    <option value="6">Sixths (6 pieces)</option>
                                    <option value="8">Eighths (8 pieces)</option>
                                </select>
                            </div>
                            
                            <div style="text-align: center; padding: 0 10px; color: var(--text-secondary); font-weight: 600;">OR</div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr auto; gap: 15px; align-items: end; margin-top: 15px;">
                            <div class="input-group">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Custom Division:</label>
                                <input type="number" id="customPieces" placeholder="Enter number of pieces" min="2" max="20" class="wide-input" oninput="performCustomDivision()" style="padding: 12px;">
                            </div>
                            
                            <button class="btn btn-primary" onclick="clearCut()" style="padding: 12px 24px; height: fit-content;">Clear All</button>
                        </div>
                    </div>
                    
                        <!-- Results Section -->
                        <div class="results-section">
                            <h4 style="margin: 0 0 15px 0; color: var(--primary-color); font-size: 16px;">Cut Results</h4>
                            <div class="history" id="cutHistory" style="max-height: 400px; overflow-y: auto;">
                                <!-- Results will appear here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cut Optimization Mode Content -->
                    <div id="cutOptimizationContent" class="mode-content" style="display: none;">
                        <!-- Settings Panel -->
                        <div class="settings-panel" style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                            <div style="display: flex; flex-wrap: wrap; gap: 20px;">
                                <!-- Left Column -->
                                <div style="flex: 1; min-width: 250px;">
                                    <div class="settings-row" style="margin-bottom: 15px;">
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">Precision:</label>
                                        <select id="optPrecision" onchange="updatePrecision('optimizer'); autoRecalculateOptimization();" class="wide-input" style="width: 100%;">
                                            <option value="32">1/32"</option>
                                            <option value="16" selected>1/16"</option>
                                            <option value="8">1/8"</option>
                                            <option value="4">1/4"</option>
                                            <option value="2">1/2"</option>
                                            <option value="1">1"</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Right Column -->
                                <div style="flex: 1; min-width: 250px;">
                                    <div class="settings-row">
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">Kerf Width:</label>
                                        <select id="optKerf" class="wide-input" style="width: 100%;" onchange="autoRecalculateOptimization()">
                                            <option value="0">None</option>
                                            <option value="0.0625">1/16"</option>
                                            <option value="0.09375">3/32"</option>
                                            <option value="0.125" selected>1/8"</option>
                                            <option value="0.1875">3/16"</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Available Boards Section -->
                        <div class="calc-section" style="background: var(--surface-color); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 15px 0; color: var(--primary-color); font-size: 16px;">Available Boards</h4>
                            <div class="board-input" style="display: grid; grid-template-columns: 2fr 60px auto; gap: 10px; align-items: end;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Board Length:</label>
                                    <input type="text" id="smartBoardLength" placeholder="Try: 8', 96&quot;, 8 0 0&quot;" class="wide-input smart-input" oninput="handleSmartInput(this, 'previewBoardLength', updateBoardLengthValue)" style="padding: 12px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Qty:</label>
                                    <input type="number" id="boardQuantity" placeholder="1" min="1" value="1" style="width: 100%; padding: 12px;">
                                </div>
                                <button class="btn btn-primary" onclick="addBoard()" style="padding: 12px 24px; height: fit-content;">Add Board</button>
                            </div>
                            <div id="previewBoardLength" class="input-preview"></div>
                                <div style="display: none;">
                                    <!-- Hidden legacy inputs for backward compatibility -->
                                    <input type="number" id="boardFeet" placeholder="0" min="0" class="wide-input">
                                    <input type="number" id="boardInches" placeholder="0" min="0" max="11" class="wide-input">
                                    <select id="boardFraction" style="width: 120px;">
                                        <option value="0">0</option>
                                        <option value="0.0625">1/16"</option>
                                        <option value="0.125">1/8"</option>
                                        <option value="0.1875">3/16"</option>
                                        <option value="0.25">1/4"</option>
                                        <option value="0.3125">5/16"</option>
                                        <option value="0.375">3/8"</option>
                                        <option value="0.4375">7/16"</option>
                                        <option value="0.5">1/2"</option>
                                        <option value="0.5625">9/16"</option>
                                        <option value="0.625">5/8"</option>
                                        <option value="0.6875">11/16"</option>
                                        <option value="0.75">3/4"</option>
                                        <option value="0.8125">13/16"</option>
                                        <option value="0.875">7/8"</option>
                                        <option value="0.9375">15/16"</option>
                                    </select>
                                </div>
                            <div id="boardsList" style="margin-top: 15px;"></div>
                        </div>
                        
                        <!-- Needed Cuts Section -->
                        <div class="calc-section" style="background: var(--surface-color); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 15px 0; color: var(--primary-color); font-size: 16px;">Needed Cuts</h4>
                            <div class="cut-input" style="display: grid; grid-template-columns: 2fr 60px auto; gap: 10px; align-items: end;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Cut Length:</label>
                                    <input type="text" id="smartOptCutLength" placeholder="Try: 24&quot;, 2', 2 0 0&quot;" class="wide-input smart-input" oninput="handleSmartInput(this, 'previewOptCutLength', updateOptCutLengthValue)" style="padding: 12px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Qty:</label>
                                    <input type="number" id="cutQuantity" placeholder="1" min="1" value="1" style="width: 100%; padding: 12px;">
                                </div>
                                <button class="btn btn-primary" onclick="addCut()" style="padding: 12px 24px; height: fit-content;">Add Cut</button>
                            </div>
                            <div id="previewOptCutLength" class="input-preview"></div>
                                <div style="display: none;">
                                    <!-- Hidden legacy inputs for backward compatibility -->
                                    <input type="number" id="optCutFeet" placeholder="0" min="0" class="wide-input">
                                    <input type="number" id="optCutInches" placeholder="0" min="0" max="11" class="wide-input">
                                    <select id="optCutFraction" style="width: 120px;">
                                        <option value="0">0</option>
                                        <option value="0.0625">1/16"</option>
                                        <option value="0.125">1/8"</option>
                                        <option value="0.1875">3/16"</option>
                                        <option value="0.25">1/4"</option>
                                        <option value="0.3125">5/16"</option>
                                        <option value="0.375">3/8"</option>
                                        <option value="0.4375">7/16"</option>
                                        <option value="0.5">1/2"</option>
                                        <option value="0.5625">9/16"</option>
                                        <option value="0.625">5/8"</option>
                                        <option value="0.6875">11/16"</option>
                                        <option value="0.75">3/4"</option>
                                        <option value="0.8125">13/16"</option>
                                        <option value="0.875">7/8"</option>
                                        <option value="0.9375">15/16"</option>
                                    </select>
                                </div>
                            <div id="cutsList" style="margin-top: 15px;"></div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <button class="btn btn-primary" onclick="optimizeCuts()" style="padding: 15px; font-size: 16px;">
                                🔧 Optimize Cuts
                            </button>
                            <button class="btn btn-secondary" onclick="clearOptimization()" style="padding: 15px; font-size: 16px;">
                                Clear All
                            </button>
                        </div>
                        
                        <!-- Results Section -->
                        <div class="results-section">
                            <div id="optimizationResults"></div>
                        </div>
                        
                        <!-- Visual Cut Layout -->
                        <div id="visualLayout" style="display: none;">
                            <h3>Visual Cut Layout</h3>
                            <div id="boardVisualization" class="board-visualization"></div>
                        </div>
                    </div>
                </div>
            </div> <!-- End Construction Category -->
            
        </div> <!-- End specialty tab-content -->

        <!-- Projects Tab -->
        <div id="projects" class="tab-content">
            <div class="projects-dashboard">
                <!-- Help Section -->
                <div id="projectsHelpSection" style="background: #e3f2fd; border-radius: 12px; padding: 20px; margin-bottom: 30px; border-left: 4px solid var(--primary-color);">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <h3 style="margin: 0 0 15px 0; color: var(--primary-color); font-size: 18px; display: flex; align-items: center; gap: 10px;">
                                📁 Welcome to Projects
                                <button onclick="document.getElementById('projectsHelpSection').style.display='none'; sessionStorage.setItem('hideProjectsHelp', 'true')" 
                                        style="margin-left: auto; background: none; border: 1px solid #1976d2; color: #1976d2; padding: 2px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;"
                                        title="Hide this help section for this session">
                                    Hide
                                </button>
                            </h3>
                            <p style="margin: 0 0 10px 0; font-size: 14px; line-height: 1.5;">
                                Projects help you organize and save all your woodworking calculations in one place.
                            </p>
                            <ul style="margin: 10px 0; padding-left: 20px; font-size: 13px; line-height: 1.6;">
                                <li><strong>Create Projects:</strong> Click "➕ New Project" to start a new woodworking project</li>
                                <li><strong>Save Calculations:</strong> Use "💾 Save to Project" in any calculator to add to the active project</li>
                                <li><strong>View Timeline:</strong> Click any project card to see all saved calculations chronologically</li>
                                <li><strong>Export/Import:</strong> Download projects as JSON files for backup or sharing</li>
                            </ul>
                            <p style="margin: 10px 0 0 0; font-size: 12px; color: #666;">
                                💡 <strong>Tip:</strong> Select your active project from the dropdown at the top of the page - all calculations will automatically save to it.
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions Section -->
                <div class="quick-actions-section" style="margin-bottom: 30px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 600px; margin: 0 auto;">
                        <!-- Create New Project Card -->
                        <div class="action-card" style="background: var(--surface-color); border: 2px dashed var(--border-color); border-radius: 12px; padding: 30px; text-align: center; cursor: pointer; transition: all 0.3s;" 
                             onclick="showNewProjectForm()" 
                             onmouseover="this.style.borderColor='var(--primary-color)'" 
                             onmouseout="this.style.borderColor='var(--border-color)'">
                            <div style="font-size: 48px; margin-bottom: 10px;">➕</div>
                            <h4 style="margin: 0 0 5px 0;">Create New Project</h4>
                            <p style="margin: 0; font-size: 14px; color: var(--text-secondary);">Start a new woodworking project</p>
                        </div>
                        
                        <!-- View All Projects Card -->
                        <div class="action-card" style="background: var(--surface-color); border: 2px solid var(--border-color); border-radius: 12px; padding: 30px; text-align: center; cursor: pointer; transition: all 0.3s;"
                             onclick="showAllProjects()"
                             onmouseover="this.style.borderColor='var(--primary-color)'"
                             onmouseout="this.style.borderColor='var(--border-color)'">
                            <div style="font-size: 48px; margin-bottom: 10px;">📋</div>
                            <h4 style="margin: 0 0 5px 0;">View All Projects</h4>
                            <p style="margin: 0; font-size: 14px; color: var(--text-secondary);">Browse and manage projects</p>
                        </div>
                    </div>
                </div>
                
                <!-- Active Project Section -->
                <div id="activeProjectSection" class="settings-panel" style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px; display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: var(--primary-color);">
                            <span style="font-size: 24px; margin-right: 10px;">📁</span>
                            <span id="activeProjectName">Current Project</span>
                        </h3>
                        <div class="project-actions">
                            <button class="btn btn-secondary btn-sm" onclick="showProjectNotes()" id="projectNotesBtn">📝 Notes</button>
                            <button class="btn btn-secondary btn-sm" onclick="exportCurrentProject()" id="projectExportBtn">📤 Export</button>
                            <button class="btn btn-primary btn-sm" onclick="viewProjectTimeline(currentProject.id)">📊 View Timeline</button>
                        </div>
                    </div>
                    <div class="project-info" style="display: flex; gap: 30px; color: var(--text-secondary);">
                        <span id="projectCreated">📅 Created: --</span>
                        <span id="projectModified">🔄 Modified: --</span>
                        <span id="projectCalcCount">📐 Calculations: 0</span>
                    </div>
                </div>
                
                <!-- New Project Form (initially hidden) -->
                <div id="newProjectForm" class="settings-panel" style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px; display: none; max-width: 600px; margin: 0 auto 20px;">
                    <h3 style="margin: 0 0 20px 0; color: var(--primary-color);">Create New Project</h3>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Project Name:</label>
                        <input type="text" id="newProjectName" placeholder="Enter project name (e.g., Kitchen Cabinet)" 
                               style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 16px;"
                               onkeypress="if(event.key === 'Enter') createProjectFromForm()">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Description (optional):</label>
                        <textarea id="newProjectDescription" placeholder="Add notes about materials, dimensions, or design ideas..." 
                                  style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; resize: vertical; min-height: 80px;"></textarea>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="hideNewProjectForm()">Cancel</button>
                        <button class="btn btn-primary" onclick="createProjectFromForm()">Create Project</button>
                    </div>
                </div>
                
                <!-- Recent Projects Section -->
                <div id="recentProjectsSection" class="settings-panel" style="background: #f8f9fa; border-radius: 12px; padding: 20px;">
                    <h3 style="margin: 0 0 20px 0; color: var(--primary-color);">Recent Projects</h3>
                    <div id="recentProjectsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
                        <!-- Project cards will be dynamically generated here -->
                    </div>
                    
                    <!-- Empty State -->
                    <div id="noProjectsMessage" style="text-align: center; padding: 60px 20px; color: #666;">
                        <div style="font-size: 64px; margin-bottom: 20px;">🛠️</div>
                        <h3>No Projects Yet</h3>
                        <p>Create your first project to start tracking your woodworking calculations!</p>
                        <button class="btn btn-primary" onclick="showNewProjectForm()" style="margin-top: 20px;">Create First Project</button>
                    </div>
                </div>
                
                <!-- Project Timeline View (initially hidden) -->
                <div id="projectTimelineView" style="display: none;">
                    <div class="settings-panel" style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0; color: var(--primary-color);">
                                <span id="timelineProjectName">Project Timeline</span>
                            </h3>
                            <button class="btn btn-secondary" onclick="backToProjectsDashboard()">← Back to Projects</button>
                        </div>
                        <div id="timelineProjectNotes" style="margin-top: 10px; padding: 15px; background: var(--surface-color); border-radius: 8px; border-left: 4px solid var(--primary-color); display: none;">
                            <h4 style="margin: 0 0 10px 0; color: var(--primary-color); font-size: 16px;">📝 Project Notes</h4>
                            <div id="timelineProjectNotesContent" style="color: var(--text-secondary); white-space: pre-wrap;"></div>
                        </div>
                    </div>
                    
                    <div class="project-timeline" id="projectTimeline">
                        <div class="timeline-content" id="timelineContent">
                            <!-- Timeline items will be dynamically generated here -->
                        </div>
                        
                        <div class="empty-timeline" id="emptyTimeline" style="display: none;">
                            <div style="text-align: center; padding: 40px 20px; color: #666;">
                                <div style="font-size: 48px; margin-bottom: 20px;">📝</div>
                                <h3>No Saved Calculations Yet</h3>
                                <p>Start using the calculators and click "Save to Project" to build your project timeline!</p>
                                <div style="margin-top: 20px;">
                                    <button class="btn btn-primary" onclick="switchTab('calculator')">Go to Calculator</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- All Projects Modal -->
        <div id="allProjectsModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeAllProjectsModal()">&times;</span>
                <h2>📁 All Projects</h2>
                <div class="projects-modal-content">
                    <div class="projects-grid-modal" id="projectsGridModal">
                        <!-- Project cards will be dynamically generated here -->
                    </div>
                    <div id="noProjectsModalMessage" class="no-projects" style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 20px;">📁</div>
                        <h3>No Projects Yet</h3>
                        <p>Create your first project and start saving calculations!</p>
                        <button class="btn btn-primary" onclick="createNewProject(); closeAllProjectsModal();">Create Project</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Project Notes Modal -->
        <div id="notesModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeProjectNotes()">&times;</span>
                <h2>📝 Project Notes</h2>
                <div id="notesContent">
                    <p><strong>Project:</strong> <span id="notesProjectName">No project selected</span></p>
                    <textarea id="projectNotesText" placeholder="Add notes about your project - materials needed, measurements, design thoughts, etc." 
                              style="width: 100%; height: 200px; margin: 10px 0; padding: 10px; border: 2px solid var(--secondary-color); border-radius: 5px; font-family: Arial, sans-serif; resize: vertical;"></textarea>
                    <div style="text-align: right; margin-top: 10px;">
                        <button class="btn btn-secondary" onclick="closeProjectNotes()" style="margin-right: 10px;">Cancel</button>
                        <button class="btn btn-success" onclick="saveProjectNotes()">Save Notes</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Save to Project Modal -->
        <div id="saveToProjectModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeSaveToProjectModal()">&times;</span>
                <h2>💾 Save to Project</h2>
                <div id="saveToProjectContent">
                    <div class="save-preview-section">
                        <h4>What you're saving:</h4>
                        <div id="savePreviewContent" class="save-preview">
                            <!-- Preview content will be populated here -->
                        </div>
                    </div>
                    
                    <div class="save-project-selection">
                        <label for="saveProjectDropdown"><strong>Save to Project:</strong></label>
                        <select id="saveProjectDropdown" style="width: 100%; padding: 8px; margin: 5px 0; border: 2px solid var(--secondary-color); border-radius: 5px;">
                            <option value="">Select a project...</option>
                        </select>
                        <button class="btn btn-primary btn-sm" onclick="createNewProjectFromSaveModal()" style="margin-top: 5px;">+ Create New Project</button>
                    </div>
                    
                    <div class="save-notes-section">
                        <label for="saveNotesText"><strong>Add Notes (optional):</strong></label>
                        <textarea id="saveNotesText" placeholder="Add context about this calculation - what you're building, why this measurement matters, etc." 
                                  style="width: 100%; height: 100px; margin: 5px 0; padding: 10px; border: 2px solid var(--secondary-color); border-radius: 5px; font-family: Arial, sans-serif; resize: vertical;"></textarea>
                    </div>
                    
                    <div style="text-align: right; margin-top: 15px;">
                        <button class="btn btn-secondary" onclick="closeSaveToProjectModal()" style="margin-right: 10px;">Cancel</button>
                        <button class="btn btn-success" onclick="executeSaveToProject()" id="saveToProjectBtn">Save to Project</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Dad Joke Modal -->
        <div id="jokeModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeJoke()">&times;</span>
                <h2 style="text-align: center; color: var(--primary-color); font-size: 28px; margin-bottom: 10px;">🔨 Nailed It!</h2>
                <p style="text-align: center; color: #666; font-style: italic; font-size: 14px; margin-top: 0; margin-bottom: 30px;">Where Jokes As Sharp As Your Tools Are Always In Stock!</p>
                
                <div id="jokeLoading" style="display: none; text-align: center; padding: 40px 20px;">
                    <p style="font-size: 18px; color: var(--primary-color);">Getting a fresh dad joke... 🎣</p>
                </div>
                
                <div id="jokeText" style="display: none; background: #f8f9fa; border-radius: 8px; padding: 30px 25px; margin: 20px 0; font-size: 18px; line-height: 1.6; color: #333; text-align: center; border: 2px solid var(--primary-color); min-height: 100px; display: flex; align-items: center; justify-content: center;">
                    <!-- Joke content will be inserted here -->
                </div>
                
                <div style="text-align: center; margin-top: 30px; display: flex; gap: 12px; justify-content: center;">
                    <button class="btn btn-primary" onclick="fetchDadJoke()" style="padding: 12px 24px; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                        Another One <span style="font-size: 20px;">🔄</span>
                    </button>
                    <button class="btn btn-secondary" onclick="closeJoke()" style="padding: 12px 24px; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                        That's Enough <span style="font-size: 20px;">😅</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Help Modal -->
        <div id="helpModal" class="modal">
            <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                <span class="close" onclick="closeHelp()">&times;</span>
                <h2 style="text-align: center; color: var(--primary-color); margin-bottom: 30px;">WorkShop Pro Calculator Help</h2>
                
                <!-- Navigation Tabs for Help Sections -->
                <div style="display: flex; justify-content: center; margin-bottom: 20px; border-bottom: 2px solid var(--border-color);">
                    <button class="help-tab-btn active" onclick="showHelpSection('calculators')" style="padding: 10px 20px; border: none; background: none; cursor: pointer; border-bottom: 3px solid transparent; font-weight: bold;">📱 Calculators</button>
                    <button class="help-tab-btn" onclick="showHelpSection('projects')" style="padding: 10px 20px; border: none; background: none; cursor: pointer; border-bottom: 3px solid transparent; font-weight: bold;">📁 Projects</button>
                    <button class="help-tab-btn" onclick="showHelpSection('tips')" style="padding: 10px 20px; border: none; background: none; cursor: pointer; border-bottom: 3px solid transparent; font-weight: bold;">💡 Tips</button>
                </div>

                <!-- Calculators Section -->
                <div id="helpCalculators" class="help-section">
                    <h3 style="color: var(--primary-color); border-left: 4px solid var(--primary-color); padding-left: 15px; margin: 25px 0 15px 0;">📊 Basic Calculators</h3>
                    
                    <div class="help-calc-card">
                        <h4>🧮 Calculator Tab</h4>
                        <p><strong>Purpose:</strong> Pure math calculations with woodworking precision</p>
                        <p><strong>Inputs:</strong> Feet, inches, fractions (1/32" to 1") or decimal inches</p>
                        <p><strong>Operations:</strong> Addition, subtraction, multiplication, division</p>
                        <p><strong>Features:</strong> Memory functions (MC, MR, M+, M-), history tracking, precision conversion</p>
                        <p><strong>Best For:</strong> Total project dimensions, adding multiple measurements, quick conversions</p>
                    </div>

                    <div class="help-calc-card">
                        <h4>✂️ Cut Calculator (in Specialty Calculators)</h4>
                        <p><strong>Purpose:</strong> Precise cutting with automatic kerf compensation</p>
                        <p><strong>Modes:</strong></p>
                        <ul style="margin: 8px 0; padding-left: 20px;">
                            <li><strong>Equal Division:</strong> Divide boards into equal pieces (halves, thirds, quarters)</li>
                            <li><strong>Cut Optimization:</strong> Minimize waste across multiple boards</li>
                        </ul>
                        <p><strong>Inputs:</strong> Board lengths, number of cuts, kerf width (1/16" to 3/16"), cut side preference</p>
                        <p><strong>Outputs:</strong> Exact cut marks, piece lengths, total waste</p>
                        <p><strong>Best For:</strong> Repetitive cuts, maximizing lumber efficiency</p>
                    </div>

                    <h3 style="color: var(--primary-color); border-left: 4px solid var(--primary-color); padding-left: 15px; margin: 25px 0 15px 0;">🛠️ Specialty Calculators</h3>

                    <div class="help-calc-card">
                        <h4>🛒 Lumber Shopping Cart</h4>
                        <p><strong>Purpose:</strong> Calculate lumber costs and board feet by species</p>
                        <p><strong>Inputs:</strong> Wood species, dimensions (thickness × width × length), quantity</p>
                        <p><strong>Outputs:</strong> Board feet, individual & total costs, shopping cart summary</p>
                        <p><strong>Features:</strong> Species pricing memory, cart management, cost comparisons</p>
                    </div>

                    <div class="help-calc-card">
                        <h4>✨ Golden Ratio Calculator</h4>
                        <p><strong>Purpose:</strong> Create proportionally pleasing dimensions using φ (1.618)</p>
                        <p><strong>Inputs:</strong> One dimension (width or height)</p>
                        <p><strong>Outputs:</strong> Complementary dimension, visual rectangle preview</p>
                        <p><strong>Best For:</strong> Picture frames, furniture proportions, aesthetic design</p>
                    </div>

                    <div class="help-calc-card">
                        <h4>📐 Shelf & Division Calculator</h4>
                        <p><strong>Purpose:</strong> Calculate equal spacing and divisions</p>
                        <p><strong>Inputs:</strong> Total length, number of divisions or desired spacing</p>
                        <p><strong>Outputs:</strong> Exact spacing, cut marks, visual diagram</p>
                        <p><strong>Best For:</strong> Shelf spacing, picket fences, drawer dividers</p>
                    </div>

                    <div class="help-calc-card">
                        <h4>📐 Miter Angle Calculator</h4>
                        <p><strong>Purpose:</strong> Calculate precise angles for joints</p>
                        <p><strong>Modes:</strong></p>
                        <ul style="margin: 8px 0; padding-left: 20px;">
                            <li><strong>Polygon:</strong> Regular polygons (3-12 sides)</li>
                            <li><strong>Frame Builder:</strong> Custom rectangles with different angles</li>
                            <li><strong>Single Cut:</strong> Individual miter cuts</li>
                        </ul>
                        <p><strong>Outputs:</strong> Miter saw angles, bevel angles, visual diagrams</p>
                    </div>

                    <div class="help-calc-card">
                        <h4>🔩 Screw & Pilot Hole Calculator</h4>
                        <p><strong>Purpose:</strong> Find correct hole sizes for any screw</p>
                        <p><strong>Inputs:</strong> Screw size (#2-#20, fractions, lag bolts), wood type</p>
                        <p><strong>Outputs:</strong> Pilot hole, clearance hole, countersink sizes</p>
                        <p><strong>Features:</strong> Complete reference table, wood-specific recommendations</p>
                    </div>

                    <div class="help-calc-card">
                        <h4>📐 Grade/Slope Calculator</h4>
                        <p><strong>Purpose:</strong> Calculate slopes and grades for construction</p>
                        <p><strong>Inputs:</strong> Rise, run, or angle</p>
                        <p><strong>Outputs:</strong> Percentage grade, angle, rise/run ratios</p>
                        <p><strong>Features:</strong> ADA compliance indicators, common slope references</p>
                        <p><strong>Best For:</strong> Ramps, drainage, roofing, stairs</p>
                    </div>

                    <div class="help-calc-card">
                        <h4>🔲 Tile & Paver Calculator</h4>
                        <p><strong>Purpose:</strong> Calculate tile quantities, costs, and layouts</p>
                        <p><strong>Inputs:</strong> Tile size, project area, grout spacing, offset, waste factor</p>
                        <p><strong>Outputs:</strong> Tiles needed, boxes required, total cost, grout estimate, cut estimation</p>
                        <p><strong>Features:</strong> Multiple pricing methods, grout type auto-detection, perimeter validation</p>
                        <p><strong>Best For:</strong> Flooring projects, backsplashes, outdoor patios</p>
                    </div>

                    <div class="help-calc-card">
                        <h4>🌳 Wood Species Database</h4>
                        <p><strong>Purpose:</strong> Research wood properties and characteristics</p>
                        <p><strong>Features:</strong> 40+ species, search/filter by use case, cost level, workability</p>
                        <p><strong>Information:</strong> Janka hardness, density, workability rating, best uses</p>
                        <p><strong>Tools:</strong> Project wizard for wood recommendations</p>
                    </div>
                </div>

                <!-- Projects Section -->
                <div id="helpProjects" class="help-section" style="display: none;">
                    <h3 style="color: var(--primary-color); border-left: 4px solid var(--primary-color); padding-left: 15px; margin: 25px 0 15px 0;">📁 Project Management System</h3>
                    
                    <div class="help-calc-card">
                        <h4>🎯 Active Project</h4>
                        <p>Select an active project from the dropdown at the top of the page. This project will:</p>
                        <ul style="margin: 8px 0; padding-left: 20px;">
                            <li>Automatically receive all saved calculations</li>
                            <li>Show in the global selector across all tabs</li>
                            <li>Be used for project-specific notes and tracking</li>
                        </ul>
                    </div>

                    <div class="help-calc-card">
                        <h4>💾 Saving Calculations</h4>
                        <p>Every calculator has a "Save to Project" button that:</p>
                        <ul style="margin: 8px 0; padding-left: 20px;">
                            <li>Captures complete calculation details (inputs, outputs, formulas)</li>
                            <li>Timestamps each save automatically</li>
                            <li>Allows adding custom notes</li>
                            <li>Shows preview before saving</li>
                        </ul>
                        <p><strong>What gets saved:</strong> Tool used, inputs, results, calculation method, timestamp</p>
                    </div>

                    <div class="help-calc-card">
                        <h4>📊 Project Timeline</h4>
                        <p>The Projects tab shows a chronological timeline of all saved calculations:</p>
                        <ul style="margin: 8px 0; padding-left: 20px;">
                            <li><strong>Filter by tool:</strong> See only specific calculator results</li>
                            <li><strong>Edit/Delete:</strong> Modify saved calculations</li>
                            <li><strong>Search:</strong> Find specific calculations quickly</li>
                            <li><strong>Export:</strong> Download project data as JSON</li>
                        </ul>
                    </div>

                    <div class="help-calc-card">
                        <h4>📝 Project Management</h4>
                        <p><strong>Creating Projects:</strong> Use the "+ New" button to create named projects</p>
                        <p><strong>Switching Projects:</strong> Use the dropdown to change active project</p>
                        <p><strong>Project Notes:</strong> Add notes to the active project for additional context</p>
                        <p><strong>Viewing History:</strong> Use the Projects tab dropdown to view any project's timeline</p>
                    </div>

                    <div class="help-calc-card">
                        <h4>📤 Import/Export</h4>
                        <p><strong>Export:</strong> Download individual projects or all projects as JSON files</p>
                        <p><strong>Import:</strong> Upload previously exported project files</p>
                        <p><strong>Backup:</strong> Regular exports serve as project backups</p>
                        <p><strong>Sharing:</strong> Share project files with colleagues or across devices</p>
                    </div>
                </div>

                <!-- Tips Section -->
                <div id="helpTips" class="help-section" style="display: none;">
                    <h3 style="color: var(--primary-color); border-left: 4px solid var(--primary-color); padding-left: 15px; margin: 25px 0 15px 0;">💡 Pro Tips & Features</h3>
                    
                    <div class="help-calc-card">
                        <h4>🎯 Precision Settings</h4>
                        <p>Set precision (1/32" to 1") to match your measuring tools. All calculations will round to your selected precision, making shop measurements easier.</p>
                    </div>

                    <div class="help-calc-card">
                        <h4>🎨 Themes</h4>
                        <p>Choose from tool brand themes (Festool, DeWalt, Milwaukee, etc.) or general themes (Wood, Steel, Dark). Themes persist between sessions.</p>
                    </div>

                    <div class="help-calc-card">
                        <h4>📱 Mobile Friendly</h4>
                        <p>Designed for use in the shop with work gloves. Large buttons, clear displays, and touch-friendly interface work great on tablets and phones.</p>
                    </div>

                    <div class="help-calc-card">
                        <h4>🔄 Automatic Conversions</h4>
                        <p>Results automatically display in the most readable format (feet + inches vs. total inches) based on the value size.</p>
                    </div>

                    <div class="help-calc-card">
                        <h4>💾 Data Persistence</h4>
                        <p>All data (projects, calculations, preferences) saves to your browser's local storage. Works completely offline after first load.</p>
                    </div>

                    <div class="help-calc-card">
                        <h4>🎭 Dad Jokes</h4>
                        <p>Click the groan emoji (🙄) for a random dad joke to brighten your shop time!</p>
                    </div>

                    <div class="help-calc-card">
                        <h4>⌨️ Keyboard Shortcuts</h4>
                        <ul style="margin: 8px 0; padding-left: 20px;">
                            <li><strong>Tab:</strong> Navigate between inputs</li>
                            <li><strong>Enter:</strong> Execute calculations</li>
                            <li><strong>Escape:</strong> Close modals</li>
                        </ul>
                    </div>
                </div>

                <style>
                    .help-tab-btn.active {
                        border-bottom-color: var(--primary-color) !important;
                        color: var(--primary-color);
                    }
                    .help-calc-card {
                        background: var(--secondary-bg);
                        border: 1px solid var(--border-color);
                        border-radius: 8px;
                        padding: 15px;
                        margin-bottom: 15px;
                        border-left: 4px solid var(--secondary-color);
                    }
                    .help-calc-card h4 {
                        color: var(--primary-color);
                        margin: 0 0 10px 0;
                        font-size: 16px;
                    }
                    .help-calc-card p {
                        margin: 8px 0;
                        line-height: 1.4;
                    }
                    .help-calc-card ul {
                        margin: 8px 0;
                    }
                    .help-calc-card li {
                        margin: 4px 0;
                    }
                </style>
            </div>
        </div>
        
        <!-- Edit Modal -->
        <div id="editModal" class="edit-modal">
            <div class="edit-modal-content">
                <h3 id="editTitle">Edit Item</h3>
                <div id="editInputs">
                    <!-- Dynamic content will be inserted here -->
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="saveEdit()">Save</button>
                    <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                    <button class="btn btn-secondary" onclick="deleteEdit()" style="background: #cd5c5c; color: white; float: right;">Delete</button>
                </div>
            </div>
        </div>
        
        <!-- Calculation Modal -->
        <div id="calcModal" class="calc-modal">
            <div class="calc-modal-content">
                <span class="close" onclick="closeCalcModal()">&times;</span>
                <h3 id="calcModalTitle">Calculation</h3>
                <div id="calcModalInputs">
                    <!-- Dynamic content will be inserted here -->
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="executeModalCalc()">Calculate</button>
                    <button class="btn btn-secondary" onclick="closeCalcModal()">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Notification element -->
        <div id="notification" class="notification"></div>
    </div>

    <script>
        /* ================================================================
           SECTION 3: JAVASCRIPT
           ================================================================ */
        
        /* ----------------------------------------------------------------
           3.1 UI CONFIGURATION SYSTEM
           ---------------------------------------------------------------- */
        // =====================================================
        // UI Configuration System
        // =====================================================
        
        // Centralized UI configuration
        const uiConfig = {
            mode: localStorage.getItem('uiMode') || 'standard', // 'basic', 'standard', or 'project'
            defaultCollapsed: true,
            categories: {
                measurement: ['spacing', 'angle', 'grade'],
                material: ['boardFoot', 'tile'],
                reference: ['goldenRatio', 'screw']
            },
            modes: {
                basic: {
                    showTabs: ['calculator'],
                    availableOperations: ['+', '-', '*', '/'],
                    inputMethod: 'feet-inches',
                    memoryButtons: false,
                    conversions: 'collapsed',
                    precision: true,
                    history: true,
                    saveToProject: false
                },
                standard: {
                    showTabs: ['calculator', 'specialty'],
                    availableOperations: ['+', '-', '*', '/'],
                    inputMethod: 'feet-inches',
                    memoryButtons: true,
                    conversions: true,
                    precision: true,
                    history: true,
                    saveToProject: false
                },
                project: {
                    showTabs: ['calculator', 'specialty', 'projects'],
                    availableOperations: ['+', '-', '*', '/'],
                    inputMethod: 'feet-inches',
                    memoryButtons: true,
                    conversions: true,
                    precision: true,
                    history: true,
                    saveToProject: true
                }
            },
            visibility: {
                memoryButtons: true,
                advancedOptions: true,
                helpSections: true,
                specialtyCalculators: true
            },
            preferences: {
                rememberCollapsedState: true,
                showDescriptions: true,
                animateTransitions: true
            },
            stats: {
                calculationsPerformed: parseInt(localStorage.getItem('calculationsPerformed')) || 0
            }
        };
        
        // Determine default mode based on user experience
        
        
        // Update visibility based on mode
        function updateUIMode(mode) {
            uiConfig.mode = mode;
            localStorage.setItem('uiMode', mode);
            applyUIMode();
        }
        
        // Set the real implementation
        window.updateUIModeReal = updateUIMode;
        
        // Restore calculator collapsed states from localStorage
        function restoreCalculatorStates() {
            // Removed - all calculators should start collapsed
            // Users can expand them as needed
        }
        
        // Apply UI mode settings
        function applyUIMode() {
            console.log('Applying UI mode:', uiConfig.mode);
            const modeConfig = uiConfig.modes[uiConfig.mode];
            
            // Update mode selector
            const modeSelect = document.getElementById('uiModeSelect');
            if (modeSelect) {
                modeSelect.value = uiConfig.mode;
            }
            
            // Show/hide tabs based on mode
            const allTabs = document.querySelectorAll('.tab-btn');
            const tabsContainer = document.querySelector('.tab-buttons');
            
            if (modeConfig.showTabs === false) {
                // Beginner mode: hide tabs completely
                tabsContainer.style.display = 'none';
                // Ensure calculator tab is active
                switchTab('calculator');
            } else {
                // Simple/Advanced mode: show specific tabs
                tabsContainer.style.display = 'flex';
                allTabs.forEach(tab => {
                    const tabName = tab.onclick.toString().match(/switchTab\('(\w+)'\)/)?.[1];
                    if (tabName) {
                        tab.style.display = modeConfig.showTabs.includes(tabName) ? 'inline-block' : 'none';
                    }
                });
            }
            
            // Handle calculator interface elements
            applyCalculatorMode(modeConfig);
            
            // Show/hide memory row based on mode
            const memoryRow = document.getElementById('memoryRow');
            if (memoryRow) {
                // Show memory row only in standard and project modes
                memoryRow.style.display = (uiConfig.mode === 'standard' || uiConfig.mode === 'project') ? 'grid' : 'none';
            }
            
            // All calculators are available in both Standard and Project modes
            // The only difference is the save to project functionality
            
            // Help button is always visible now
            const helpBtn = document.querySelector('button[onclick="showHelp()"]');
            if (helpBtn) {
                helpBtn.style.display = 'inline-block';
            }
            
            // Show/hide "Show More Tools" section
            const showMoreToolsSection = document.getElementById('showMoreToolsSection');
            if (showMoreToolsSection) {
                showMoreToolsSection.style.display = uiConfig.mode === 'basic' ? 'block' : 'none';
            }
            
            // Update expand/collapse controls
            const expandCollapseControls = document.getElementById('expandCollapseControls');
            if (expandCollapseControls) {
                expandCollapseControls.style.display = 'block'; // Show in both Standard and Advanced modes
            }
        }
        
        // Apply mode-specific calculator interface changes
        function applyCalculatorMode(modeConfig) {
            // Remove beginner welcome message since we don't have beginner mode anymore
            const beginnerWelcome = document.getElementById('beginnerWelcome');
            if (beginnerWelcome) {
                beginnerWelcome.style.display = 'none';
            }
            
            // Show/hide precision selector
            const precisionRow = document.querySelector('.settings-row');
            if (precisionRow) {
                precisionRow.style.display = modeConfig.precision ? 'block' : 'none';
            }
            
            // Handle operation buttons and progressive disclosure
            const operationButtons = document.querySelectorAll('.calc-btn.operation');
            const showMoreOperations = document.getElementById('showMoreOperations');
            
            operationButtons.forEach(btn => {
                const operation = btn.textContent.trim();
                const operationMap = { '+': '+', '−': '-', '×': '*', '÷': '/' };
                const actualOp = operationMap[operation] || operation;
                btn.style.display = modeConfig.availableOperations.includes(actualOp) ? 'block' : 'none';
            });
            
            // Show "Show More Operations" button only in beginner mode if multiply/divide are hidden
            if (showMoreOperations) {
                const hasMultiplyDivide = modeConfig.availableOperations.includes('*') && modeConfig.availableOperations.includes('/');
                showMoreOperations.style.display = (uiConfig.mode === 'beginner' && !hasMultiplyDivide) ? 'block' : 'none';
            }
            
            // Show/hide memory buttons
            const memoryButtons = document.querySelectorAll('.calc-btn.memory');
            memoryButtons.forEach(btn => {
                btn.style.display = modeConfig.memoryButtons ? 'block' : 'none';
            });
            
            // Show/hide save to project button
            const saveBtn = document.querySelector('.calc-btn.save');
            if (saveBtn) {
                saveBtn.style.display = modeConfig.saveToProject ? 'block' : 'none';
            }
            
            // Show/hide conversion section
            const conversionSection = document.querySelector('.conversion-section');
            const conversionContent = document.getElementById('conversionContent');
            const conversionToggle = document.getElementById('conversionToggle');
            
            if (conversionSection) {
                if (modeConfig.conversions === 'collapsed') {
                    conversionSection.style.display = 'block';
                    if (conversionContent) {
                        conversionContent.style.display = 'none';
                        if (conversionToggle) conversionToggle.textContent = '▶';
                    }
                } else if (modeConfig.conversions === true) {
                    conversionSection.style.display = 'block';
                    if (conversionContent) {
                        conversionContent.style.display = 'block';
                        if (conversionToggle) conversionToggle.textContent = '▼';
                    }
                } else {
                    conversionSection.style.display = 'none';
                }
            }
            
            // Show/hide history
            const history = document.getElementById('history');
            if (history) {
                history.style.display = modeConfig.history ? 'block' : 'none';
            }
            
            // Handle input method
            applyInputMethod(modeConfig.inputMethod);
            
            // Hide/show all save to project buttons throughout the app
            const saveToProjectButtons = document.querySelectorAll('button[onclick*="saveToProject"], button[onclick*="Project"]');
            saveToProjectButtons.forEach(btn => {
                // Skip if it's the main save button already handled above
                if (!btn.classList.contains('calc-btn')) {
                    btn.style.display = modeConfig.saveToProject ? 'inline-block' : 'none';
                }
            });
            
            // Hide/show global project selector
            const globalProjectSelector = document.getElementById('globalProjectSelector');
            if (globalProjectSelector) {
                const shouldShow = modeConfig.saveToProject === true;
                globalProjectSelector.style.display = shouldShow ? 'block' : 'none';
                console.log(`Global project selector: mode=${uiConfig.mode}, saveToProject=${modeConfig.saveToProject}, display=${shouldShow ? 'block' : 'none'}`);
            }
        }
        
        // Apply input method (decimal vs feet-inches)
        function applyInputMethod(method) {
            const input1Group = document.querySelector('.input-group');
            const feetInchesInputs = input1Group.querySelectorAll('input[type="number"], select');
            
            if (method === 'decimal') {
                // Hide feet/inches inputs, show single decimal input
                feetInchesInputs.forEach(input => input.style.display = 'none');
                input1Group.querySelectorAll('span').forEach(span => span.style.display = 'none');
                
                // Add decimal input if it doesn't exist
                let decimalInput = document.getElementById('decimalOnlyInput');
                if (!decimalInput) {
                    decimalInput = document.createElement('input');
                    decimalInput.id = 'decimalOnlyInput';
                    decimalInput.type = 'number';
                    decimalInput.placeholder = 'Enter inches (e.g., 37.25)';
                    decimalInput.step = '0.001';
                    decimalInput.className = 'wide-input';
                    decimalInput.style.width = '200px';
                    decimalInput.onchange = updateCalculation;
                    
                    const label = input1Group.querySelector('label');
                    label.textContent = 'Enter Measurement or Expression:';
                    input1Group.appendChild(decimalInput);
                    
                    const inchesSpan = document.createElement('span');
                    inchesSpan.textContent = 'inches';
                    inchesSpan.id = 'decimalInchesLabel';
                    input1Group.appendChild(inchesSpan);
                }
                decimalInput.style.display = 'inline-block';
                document.getElementById('decimalInchesLabel').style.display = 'inline';
            } else {
                // Show feet/inches inputs, hide decimal input
                feetInchesInputs.forEach(input => input.style.display = 'inline-block');
                input1Group.querySelectorAll('span').forEach(span => {
                    if (span.id !== 'decimalInchesLabel') span.style.display = 'inline';
                });
                
                const decimalInput = document.getElementById('decimalOnlyInput');
                if (decimalInput) decimalInput.style.display = 'none';
                const decimalLabel = document.getElementById('decimalInchesLabel');
                if (decimalLabel) decimalLabel.style.display = 'none';
                
                const label = input1Group.querySelector('label');
                label.textContent = 'Enter Measurement or Expression:';
            }
        }
        
        // =====================================================
        // Calculator Registry System
        // =====================================================
        
        const calculatorRegistry = {
            calculators: [],
            
            register(calculator) {
                this.calculators.push(calculator);
                return this;
            },
            
            getById(id) {
                return this.calculators.find(calc => calc.id === id);
            },
            
            getByCategory(category) {
                return this.calculators.filter(calc => calc.category === category);
            },
            
            getVisible() {
                return this.calculators.filter(calc => {
                    if (uiConfig.mode === 'simple' && calc.advanced) {
                        return false;
                    }
                    return true;
                });
            },
            
            initialize() {
                this.calculators.forEach(calc => {
                    if (calc.initialize) {
                        calc.initialize();
                    }
                });
            }
        };
        
        // Calculator class for modular components
        class Calculator {
            constructor(config) {
                this.id = config.id;
                this.name = config.name;
                this.category = config.category;
                this.icon = config.icon;
                this.description = config.description;
                this.advanced = config.advanced || false;
                this.defaultCollapsed = config.defaultCollapsed !== undefined ? config.defaultCollapsed : uiConfig.defaultCollapsed;
                this.element = null;
            }
            
            isCollapsed() {
                if (!this.element) return this.defaultCollapsed;
                const content = document.getElementById(this.id + 'Content');
                return content && content.style.display === 'none';
            }
            
            toggle() {
                toggleCalcCard(this.id);
            }
            
            collapse() {
                const content = document.getElementById(this.id + 'Content');
                const arrow = document.querySelector(`#${this.id}Card .calc-arrow`);
                if (content && arrow) {
                    content.style.display = 'none';
                    arrow.textContent = '▼';
                }
            }
            
            expand() {
                const content = document.getElementById(this.id + 'Content');
                const arrow = document.querySelector(`#${this.id}Card .calc-arrow`);
                if (content && arrow) {
                    content.style.display = 'block';
                    arrow.textContent = '▲';
                }
            }
            
            initialize() {
                this.element = document.getElementById(this.id + 'Card');
                if (this.defaultCollapsed && uiConfig.preferences.rememberCollapsedState) {
                    this.collapse();
                }
            }
        }
        
        // =====================================================
        // Mobile Keypad Module
        // =====================================================
        const MobileKeypad = {
            // State management
            activeInput: null,
            originalValue: '',
            cursorPosition: 0,
            isVisible: false,
            
            // Configuration
            config: {
                vibrateMs: 10,
                animationDuration: 300,
                minInputHeight: 100, // Minimum pixels from top/bottom to show keypad
            },
            
            // Initialize the keypad system
            init() {
                // Only initialize on touch devices
                if (!('ontouchstart' in window)) {
                    console.log('MobileKeypad: Not a touch device, skipping initialization');
                    return;
                }
                
                console.log('MobileKeypad: Initializing for touch device');
                
                // Get keypad elements
                this.overlay = document.getElementById('mobileKeypadOverlay');
                this.keypad = document.getElementById('mobileKeypad');
                this.display = document.getElementById('keypadInputDisplay');
                
                if (!this.overlay || !this.keypad) {
                    console.error('MobileKeypad: Required elements not found');
                    return;
                }
                
                // Set up event listeners
                this.setupEventListeners();
                
                // Mark all smart inputs for mobile keypad
                this.setupSmartInputs();
                
                console.log('MobileKeypad: Initialization complete');
            },
            
            // Set up event listeners for keypad buttons
            setupEventListeners() {
                // Long press handling
                let longPressTimer = null;
                let longPressTarget = null;
                
                // Use event delegation for all buttons
                this.keypad.addEventListener('click', (e) => {
                    const btn = e.target.closest('.keypad-btn');
                    if (!btn) return;
                    
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Haptic feedback
                    this.vibrate();
                    
                    // Handle button action
                    if (btn.hasAttribute('data-action')) {
                        this.handleAction(btn.getAttribute('data-action'));
                    } else if (btn.hasAttribute('data-value')) {
                        this.handleValue(btn.getAttribute('data-value'));
                    }
                });
                
                // Long press for fraction buttons
                this.keypad.addEventListener('touchstart', (e) => {
                    const btn = e.target.closest('.keypad-btn.fraction');
                    if (!btn) return;
                    
                    longPressTarget = btn;
                    longPressTimer = setTimeout(() => {
                        this.showFractionMenu(btn);
                        // Strong vibration for long press
                        if ('vibrate' in navigator) {
                            navigator.vibrate(50);
                        }
                    }, 500); // 500ms for long press
                });
                
                this.keypad.addEventListener('touchend', () => {
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                        longPressTarget = null;
                    }
                });
                
                this.keypad.addEventListener('touchmove', () => {
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                        longPressTarget = null;
                    }
                });
                
                // Close on overlay click
                this.overlay.addEventListener('click', (e) => {
                    if (e.target === this.overlay) {
                        this.hide();
                    }
                });
                
                // Prevent native keyboard on input focus
                document.addEventListener('touchstart', (e) => {
                    const input = e.target.closest('.smart-input, [data-mobile-keypad]');
                    // Don't show popup for main calculator input (it has integrated keypad)
                    if (input && input.tagName === 'INPUT' && input.id !== 'smartInput1') {
                        e.preventDefault();
                        this.show(input);
                    }
                }, { passive: false });
            },
            
            // Show fraction menu on long press
            showFractionMenu(button) {
                const baseValue = button.getAttribute('data-value');
                let fractions = [];
                
                // Define fraction sets based on which button was pressed
                switch(baseValue) {
                    case '1/2':
                        fractions = ['1/2', '3/2', '5/2', '7/2'];
                        break;
                    case '1/4':
                        fractions = ['1/4', '3/4', '5/4', '7/4'];
                        break;
                    case '1/8':
                        fractions = ['1/8', '3/8', '5/8', '7/8'];
                        break;
                    case '1/16':
                        fractions = ['1/16', '3/16', '5/16', '7/16', '9/16', '11/16', '13/16', '15/16'];
                        break;
                }
                
                // Create popup menu
                const menu = document.createElement('div');
                menu.className = 'fraction-popup-menu';
                menu.style.cssText = `
                    position: absolute;
                    background: var(--background-color);
                    border: 2px solid var(--primary-color);
                    border-radius: 8px;
                    padding: 8px;
                    display: flex;
                    flex-wrap: wrap;
                    gap: 4px;
                    z-index: 10000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    max-width: 250px;
                `;
                
                // Position menu above button
                const btnRect = button.getBoundingClientRect();
                const keypadRect = this.keypad.getBoundingClientRect();
                menu.style.left = `${btnRect.left - keypadRect.left}px`;
                menu.style.bottom = `${keypadRect.bottom - btnRect.top + 10}px`;
                
                // Add fraction options
                fractions.forEach(frac => {
                    const opt = document.createElement('button');
                    opt.className = 'keypad-btn fraction';
                    opt.textContent = frac;
                    opt.style.cssText = 'min-width: 50px; min-height: 40px; font-size: 14px;';
                    opt.onclick = (e) => {
                        e.stopPropagation();
                        this.handleValue(frac);
                        menu.remove();
                    };
                    menu.appendChild(opt);
                });
                
                // Add to keypad
                this.keypad.appendChild(menu);
                
                // Remove menu on next touch
                const removeMenu = () => {
                    menu.remove();
                    document.removeEventListener('touchstart', removeMenu);
                };
                setTimeout(() => {
                    document.addEventListener('touchstart', removeMenu);
                }, 100);
            },
            
            // Mark smart inputs for mobile keypad usage (excluding Calculator tab)
            setupSmartInputs() {
                // Find all inputs with smart input handlers
                const smartInputSelectors = [
                    'input[oninput*="handleSmartInput"]',
                    'input[oninput*="updateValue"]',
                    'input[oninput*="calculateValue"]',
                    '.smart-input',
                    '.wide-input'
                ];
                
                const allInputs = document.querySelectorAll(smartInputSelectors.join(','));
                
                // Filter out Calculator tab inputs - only apply to specialty calculators
                const inputs = Array.from(allInputs).filter(input => {
                    // Check if input is inside the Calculator tab
                    const calculatorTab = input.closest('#calculator');
                    return !calculatorTab; // Only include inputs NOT in Calculator tab
                });
                
                inputs.forEach(input => {
                    // Mark for mobile keypad
                    input.setAttribute('data-mobile-keypad', 'true');
                    
                    // Prevent native keyboard
                    input.setAttribute('inputmode', 'none');
                    
                    // Make readonly to prevent native keyboard but allow selection
                    // We'll handle input through our keypad
                    input.setAttribute('data-original-readonly', input.readOnly);
                    
                    // Add focus handler
                    input.addEventListener('focus', (e) => {
                        if ('ontouchstart' in window) {
                            e.preventDefault();
                            this.show(input);
                        }
                    });
                });
                
                console.log(`MobileKeypad: Set up ${inputs.length} smart inputs (excluding Calculator tab)`);
            },
            
            // Show the keypad for a specific input
            show(input) {
                if (!input || this.isVisible) return;
                
                console.log('MobileKeypad: Showing for input', input.id || input.className);
                
                this.activeInput = input;
                this.originalValue = input.value;
                this.cursorPosition = input.selectionStart || input.value.length;
                
                // Update display
                this.updateDisplay();
                
                // Position keypad based on input location
                this.positionKeypad(input);
                
                // Show overlay with animation
                this.overlay.style.display = 'block';
                requestAnimationFrame(() => {
                    this.overlay.classList.add('active');
                });
                
                // Prevent body scroll while keypad is open
                document.body.style.overflow = 'hidden';
                
                // Set readonly to prevent native keyboard
                if (!input.hasAttribute('data-original-readonly')) {
                    input.readOnly = true;
                }
                
                this.isVisible = true;
                
                // Ensure input stays visible
                this.ensureInputVisible(input);
            },
            
            // Hide the keypad
            hide() {
                if (!this.isVisible) return;
                
                console.log('MobileKeypad: Hiding');
                
                // Remove active class for animation
                this.overlay.classList.remove('active');
                
                // Wait for animation then hide
                setTimeout(() => {
                    this.overlay.style.display = 'none';
                    
                    // Restore body scroll
                    document.body.style.overflow = '';
                    
                    // Restore readonly state
                    if (this.activeInput && !this.activeInput.getAttribute('data-original-readonly')) {
                        this.activeInput.readOnly = false;
                    }
                    
                    // Trigger input event to update any calculations
                    if (this.activeInput) {
                        this.activeInput.dispatchEvent(new Event('input', { bubbles: true }));
                        this.activeInput.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                    
                    // Clear state
                    this.activeInput = null;
                    this.originalValue = '';
                    this.cursorPosition = 0;
                    this.isVisible = false;
                }, this.config.animationDuration);
            },
            
            // Position keypad based on input location
            positionKeypad(input) {
                const rect = input.getBoundingClientRect();
                const viewportHeight = window.innerHeight;
                const inputMiddle = rect.top + rect.height / 2;
                
                // If input is in top half of screen, show keypad at bottom
                // Otherwise show at top
                if (inputMiddle < viewportHeight / 2) {
                    this.keypad.classList.remove('position-top');
                } else {
                    this.keypad.classList.add('position-top');
                }
            },
            
            // Ensure input stays visible when keypad is shown
            ensureInputVisible(input) {
                setTimeout(() => {
                    const rect = input.getBoundingClientRect();
                    const keypadRect = this.keypad.getBoundingClientRect();
                    
                    // Check if input is hidden by keypad
                    if (this.keypad.classList.contains('position-top')) {
                        // Keypad at top
                        if (rect.top < keypadRect.bottom) {
                            input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    } else {
                        // Keypad at bottom
                        if (rect.bottom > keypadRect.top) {
                            input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                }, this.config.animationDuration);
            },
            
            // Handle action buttons (backspace, clear, done)
            handleAction(action) {
                if (!this.activeInput) return;
                
                switch (action) {
                    case 'backspace':
                        this.backspace();
                        break;
                    case 'clear':
                        this.clear();
                        break;
                    case 'done':
                        this.hide();
                        break;
                }
            },
            
            // Handle value buttons (numbers, symbols, etc.)
            handleValue(value) {
                if (!this.activeInput) return;
                
                const currentValue = this.activeInput.value;
                const start = this.activeInput.selectionStart || currentValue.length;
                const end = this.activeInput.selectionEnd || start;
                
                // Insert value at cursor position
                const newValue = currentValue.slice(0, start) + value + currentValue.slice(end);
                this.activeInput.value = newValue;
                
                // Update cursor position
                const newPosition = start + value.length;
                this.activeInput.setSelectionRange(newPosition, newPosition);
                this.cursorPosition = newPosition;
                
                // Update display and trigger input event
                this.updateDisplay();
                this.triggerInputEvents();
            },
            
            // Backspace function
            backspace() {
                const currentValue = this.activeInput.value;
                const start = this.activeInput.selectionStart || currentValue.length;
                const end = this.activeInput.selectionEnd || start;
                
                if (start !== end) {
                    // Delete selection
                    const newValue = currentValue.slice(0, start) + currentValue.slice(end);
                    this.activeInput.value = newValue;
                    this.activeInput.setSelectionRange(start, start);
                    this.cursorPosition = start;
                } else if (start > 0) {
                    // Delete character before cursor
                    const newValue = currentValue.slice(0, start - 1) + currentValue.slice(start);
                    this.activeInput.value = newValue;
                    const newPosition = start - 1;
                    this.activeInput.setSelectionRange(newPosition, newPosition);
                    this.cursorPosition = newPosition;
                }
                
                this.updateDisplay();
                this.triggerInputEvents();
            },
            
            // Clear input
            clear() {
                this.activeInput.value = '';
                this.activeInput.setSelectionRange(0, 0);
                this.cursorPosition = 0;
                this.updateDisplay();
                this.triggerInputEvents();
            },
            
            // Update the display to show current input value
            updateDisplay() {
                if (this.display && this.activeInput) {
                    const value = this.activeInput.value || 'Enter measurement...';
                    this.display.textContent = value;
                }
            },
            
            // Trigger input events for live validation
            triggerInputEvents() {
                if (!this.activeInput) return;
                
                // Trigger input event for real-time updates
                this.activeInput.dispatchEvent(new Event('input', { bubbles: true }));
                
                // Some handlers might listen to keyup
                this.activeInput.dispatchEvent(new KeyboardEvent('keyup', { bubbles: true }));
            },
            
            // Vibrate for haptic feedback
            vibrate() {
                if ('vibrate' in navigator) {
                    navigator.vibrate(this.config.vibrateMs);
                }
            },
            
            // Re-scan for new smart inputs (call after dynamic content loads)
            refresh() {
                console.log('MobileKeypad: Refreshing smart inputs');
                this.setupSmartInputs();
            }
        };
        
        // =====================================================
        // Theme Management Functions
        // =====================================================
        
        // Load saved theme on page load
        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('woodworking-calculator-theme') || 'wood';
            const themeSelect = document.getElementById('themeSelect');
            if (themeSelect) {
                themeSelect.value = savedTheme;
            }
            applyTheme(savedTheme);
        }
        
        // Apply theme to document body
        function applyTheme(themeName) {
            const body = document.body;
            // Remove all existing theme classes
            body.classList.remove('theme-wood', 'theme-steel', 'theme-dark', 'theme-festool', 'theme-dewalt', 'theme-milwaukee', 'theme-ridgid', 'theme-makita', 'theme-noob');
            
            // Add new theme class (except for default wood theme)
            if (themeName !== 'wood') {
                body.classList.add(`theme-${themeName}`);
            }
            
            // Save theme preference
            localStorage.setItem('woodworking-calculator-theme', themeName);
        }
        
        // Handle theme change from dropdown
        function changeTheme(themeName) {
            applyTheme(themeName);
            showNotification(`Theme changed to ${themeName.charAt(0).toUpperCase() + themeName.slice(1)}`, 'success');
        }
        
        /* ----------------------------------------------------------------
           3.2 GLOBAL VARIABLES & STATE
           ---------------------------------------------------------------- */
        // =====================================================
        // Calculator Variables
        // =====================================================
        
        let currentValueInches = 0;
        let cutValueInches = 0;
        let currentOperation = null;
        let operationValue = 0;
        let history = [];
        let cutHistory = [];
        let lastDivisionType = null; // 'quick' or 'custom'
        let lastDivisionValue = null; // number of pieces
        let lastConversionSource = 'calculator'; // Track whether last action was 'calculator' or 'direct'
        let lastCalculatorUpdate = 0; // Timestamp of last calculator calculation
        let lastDirectInputUpdate = 0; // Timestamp of last direct input
        let boards = []; // Array of {length: number, quantity: number} objects
        let cuts = []; // Array of {length: number, id: unique_id}
        let inputMode = 'fraction';
        let editingItem = null; // Track what we're editing
        let cutIdCounter = 0; // For unique cut IDs
        let memoryValue = 0; // Calculator memory
        let value1 = 0; // First calculator value
        let value2 = 0; // Second calculator value
        let projects = []; // Array to store saved projects
        let currentProject = null; // Currently active project
        let lumberCart = []; // Array to store lumber shopping cart items
        let speciesPrices = {}; // Object to remember prices for each species
        let currentCutResults = []; // Array to store cut results for saving
        
        // Data persistence functions
        function saveToLocalStorage() {
            const data = {
                projects: projects,
                currentProject: currentProject,
                history: history,
                cutHistory: cutHistory,
                memoryValue: memoryValue,
                speciesPrices: speciesPrices,
                settings: {
                    precision: document.getElementById('precision')?.value || 16,
                    cutPrecision: document.getElementById('cutPrecision')?.value || 16,
                    optPrecision: document.getElementById('optPrecision')?.value || 16
                }
            };
            localStorage.setItem('woodworkingCalculator', JSON.stringify(data));
        }
        
        function loadFromLocalStorage() {
            try {
                const data = JSON.parse(localStorage.getItem('woodworkingCalculator'));
                if (data) {
                    projects = data.projects || [];
                    currentProject = data.currentProject || null;
                    // Ensure history arrays contain only strings
                    history = data.history ? data.history.filter(h => h && typeof h === 'string') : [];
                    cutHistory = data.cutHistory ? data.cutHistory.filter(h => h && typeof h === 'string') : [];
                    memoryValue = data.memoryValue || 0;
                    speciesPrices = data.speciesPrices || {};
                    
                    // Restore settings with 1/16" default
                    if (data.settings) {
                        if (document.getElementById('precision')) document.getElementById('precision').value = data.settings.precision || 16;
                        if (document.getElementById('cutPrecision')) document.getElementById('cutPrecision').value = data.settings.cutPrecision || 16;
                        if (document.getElementById('optPrecision')) document.getElementById('optPrecision').value = data.settings.optPrecision || 16;
                    } else {
                        // No saved settings - ensure 1/16" default
                        if (document.getElementById('precision')) document.getElementById('precision').value = 16;
                        if (document.getElementById('cutPrecision')) document.getElementById('cutPrecision').value = 16;
                        if (document.getElementById('optPrecision')) document.getElementById('optPrecision').value = 16;
                    }
                    
                    // Refresh precision settings after loading
                    updatePrecision('calculator');
                    updatePrecision('cut');
                    updatePrecision('optimizer');
                    updateWoodworkingFractions();
                    
                    updateDisplays();
                }
            } catch (error) {
                console.error('Error loading data:', error);
                // Silent error handling - no notification needed
            }
        }
        
        function updateDisplays() {
            updateHistory();
            updateCutHistory();
            updateMemoryIndicator();
            // Project loading notifications removed - silent loading
        }
        
        function updateCalculatorDisplay() {
            // Update calculator display with current values
            const calcResult = document.getElementById('calcResult');
            const calcEquation = document.getElementById('calcEquation');
            
            if (calcResult) {
                calcResult.textContent = inchesToDisplay(currentValueInches, 'calculator');
            }
            
            if (calcEquation && currentOperation) {
                const val1Display = inchesToDisplay(value1, 'calculator');
                calcEquation.textContent = `${val1Display} ${currentOperation}`;
            } else if (calcEquation) {
                calcEquation.innerHTML = '&nbsp;';
            }
            
            // Update input fields
            const feet1 = document.getElementById('feet1');
            const inches1 = document.getElementById('inches1');
            if (feet1 && inches1) {
                const { feet, inches, fraction } = inchesToFeetInches(currentValueInches);
                feet1.value = feet;
                inches1.value = inches;
                
                const fraction1 = document.getElementById('fraction1');
                if (fraction1) {
                    fraction1.value = fraction;
                }
            }
        }
        
        // Project management functions
        // New project form functions
        function showNewProjectForm() {
            document.getElementById('newProjectForm').style.display = 'block';
            document.getElementById('newProjectName').focus();
            // Hide quick actions when showing form
            document.querySelector('.quick-actions-section').style.display = 'none';
        }
        
        function hideNewProjectForm() {
            document.getElementById('newProjectForm').style.display = 'none';
            document.getElementById('newProjectName').value = '';
            document.getElementById('newProjectDescription').value = '';
            // Show quick actions again
            document.querySelector('.quick-actions-section').style.display = 'block';
        }
        
        function extractSpecialtyCalculatorData() {
            // Extract current state from specialty calculators
            return {
                // Board foot calculator
                boardFootData: {
                    thickness: currentBfThicknessInches || 0,
                    width: currentBfWidthInches || 0,
                    length: currentBfLengthInches || 0,
                    quantity: parseInt(document.getElementById('bfQuantity')?.value) || 1,
                    species: document.getElementById('bfSpecies')?.value || '',
                    price: parseFloat(document.getElementById('bfPrice')?.value) || 0
                },
                // Golden ratio calculator
                goldenRatioData: {
                    dimension: currentGoldenDimension || 0,
                    mode: document.querySelector('.golden-mode-btn.active')?.textContent || ''
                },
                // Miter angle calculator
                miterData: {
                    sides: parseInt(document.getElementById('polygonSides')?.value) || 4,
                    angle: parseFloat(document.getElementById('customAngle')?.value) || 0,
                    boardWidth: currentMiterBoardWidth || 0
                },
                // Add other calculator data as needed
            };
        }
        
        function createProjectFromForm() {
            const nameInput = document.getElementById('newProjectName');
            const descInput = document.getElementById('newProjectDescription');
            const name = nameInput.value.trim();
            
            if (!name) {
                nameInput.style.borderColor = '#e74c3c';
                nameInput.focus();
                return;
            }
            
            const project = {
                id: Date.now(),
                name: name,
                description: descInput.value.trim(),
                created: new Date().toISOString(),
                boards: [...boards],
                cuts: [...cuts],
                history: [...history],
                cutHistory: [...cutHistory],
                projectLog: [],
                calculatorData: {
                    currentValueInches: currentValueInches,
                    cutValueInches: cutValueInches,
                    currentOperation: currentOperation,
                    operationValue: operationValue,
                    memoryValue: memoryValue,
                    value1: value1,
                    value2: value2,
                    inputMode: inputMode
                },
                woodworkingData: extractSpecialtyCalculatorData()
            };
            
            projects.push(project);
            currentProject = project;
            saveToLocalStorage();
            updateGlobalProjectSelector();
            hideNewProjectForm();
            updateProjectsDashboard();
            showNotification(`Project "${name}" created!`);
        }
        
        function backToProjectsDashboard() {
            document.getElementById('projectTimelineView').style.display = 'none';
            document.getElementById('activeProjectSection').style.display = currentProject ? 'block' : 'none';
            document.querySelector('.quick-actions-section').style.display = 'block';
            document.getElementById('recentProjectsSection').style.display = 'block';
            updateProjectsDashboard();
        }
        
        function updateProjectsDashboard() {
            // Update active project section
            const activeSection = document.getElementById('activeProjectSection');
            const noProjectsMsg = document.getElementById('noProjectsMessage');
            const recentGrid = document.getElementById('recentProjectsGrid');
            
            if (currentProject) {
                activeSection.style.display = 'block';
                document.getElementById('activeProjectName').textContent = currentProject.name;
                document.getElementById('projectCreated').textContent = `📅 Created: ${new Date(currentProject.created).toLocaleDateString()}`;
                document.getElementById('projectModified').textContent = `🔄 Modified: ${currentProject.modified ? new Date(currentProject.modified).toLocaleDateString() : 'Never'}`;
                const calcCount = (currentProject.projectLog || []).length;
                document.getElementById('projectCalcCount').textContent = `📐 Calculations: ${calcCount}`;
            } else {
                activeSection.style.display = 'none';
            }
            
            // Update recent projects
            if (projects.length > 0) {
                noProjectsMsg.style.display = 'none';
                recentGrid.style.display = 'grid';
                
                // Sort projects by modified date, show max 4
                const sortedProjects = [...projects].sort((a, b) => {
                    const dateA = new Date(a.modified || a.created);
                    const dateB = new Date(b.modified || b.created);
                    return dateB - dateA;
                }).slice(0, 4);
                
                recentGrid.innerHTML = sortedProjects.map(project => `
                    <div class="project-card" style="background: white; border: 2px solid var(--border-color); border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.3s;"
                         onclick="loadProject(${project.id})"
                         onmouseover="this.style.borderColor='var(--primary-color)'"
                         onmouseout="this.style.borderColor='var(--border-color)'">
                        <h4 style="margin: 0 0 10px 0; color: var(--primary-color);">📁 ${project.name}</h4>
                        <p style="margin: 0 0 10px 0; font-size: 14px; color: var(--text-secondary);">
                            ${project.description || 'No description'}
                        </p>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            <div>Created: ${new Date(project.created).toLocaleDateString()}</div>
                            <div>${(project.projectLog || []).length} calculations</div>
                        </div>
                    </div>
                `).join('');
            } else {
                noProjectsMsg.style.display = 'block';
                recentGrid.style.display = 'none';
            }
        }
        
        function createNewProject() {
            showNewProjectForm();
        }
        
        function saveCurrentProject() {
            if (!currentProject) {
                createNewProject();
                return;
            }
            
            currentProject.boards = [...boards];
            currentProject.cuts = [...cuts];
            currentProject.history = [...history];
            currentProject.cutHistory = [...cutHistory];
            currentProject.calculatorData = {
                currentValueInches: currentValueInches,
                cutValueInches: cutValueInches,
                currentOperation: currentOperation,
                operationValue: operationValue,
                memoryValue: memoryValue,
                value1: value1,
                value2: value2,
                inputMode: inputMode
            };
            currentProject.lastModified = new Date().toISOString();
            
            // Update in projects array
            const index = projects.findIndex(p => p.id === currentProject.id);
            if (index !== -1) {
                projects[index] = currentProject;
            }
            
            saveToLocalStorage();
            renderProjectsTab();
        }
        
        function loadProject(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (project) {
                currentProject = project;
                boards = [...project.boards];
                cuts = [...project.cuts];
                // Ensure history arrays contain only strings
                history = project.history ? project.history.filter(h => h && typeof h === 'string') : [];
                cutHistory = project.cutHistory ? project.cutHistory.filter(h => h && typeof h === 'string') : [];
                
                // Initialize projectLog if it doesn't exist (for older projects)
                if (!project.projectLog) {
                    project.projectLog = [];
                }
                
                // Restore calculator data if available
                if (project.calculatorData) {
                    currentValueInches = project.calculatorData.currentValueInches || 0;
                    cutValueInches = project.calculatorData.cutValueInches || 0;
                    currentOperation = project.calculatorData.currentOperation || null;
                    operationValue = project.calculatorData.operationValue || 0;
                    memoryValue = project.calculatorData.memoryValue || 0;
                    value1 = project.calculatorData.value1 || 0;
                    value2 = project.calculatorData.value2 || 0;
                    inputMode = project.calculatorData.inputMode || 'fraction';
                }
                
                updateDisplays();
                // updateBoardDisplay(); // Function doesn't exist
                // updateCutDisplay(); // Function doesn't exist
                updateCalculatorDisplay();
                
                // If we're in the Projects tab, automatically show the timeline
                const projectsTab = document.getElementById('projects');
                if (projectsTab && projectsTab.classList.contains('active')) {
                    viewProjectTimeline(projectId);
                }
            }
        }
        
        function deleteProject(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (project && confirm(`Delete project "${project.name}"?`)) {
                projects = projects.filter(p => p.id !== projectId);
                if (currentProject && currentProject.id === projectId) {
                    currentProject = null;
                }
                saveToLocalStorage();
                updateProjectSelector();
                renderProjectsTab();
                showNotification('Project deleted', 'success');
            }
        }
        
        function updateProjectSelector() {
            updateGlobalProjectSelector();
            renderProjectTimeline();
        }
        
        function updateGlobalProjectSelector() {
            const globalDropdown = document.getElementById('globalProjectDropdown');
            const timelineDropdown = document.getElementById('projectTimelineDropdown');
            
            if (globalDropdown) {
                // Clear existing options
                globalDropdown.innerHTML = '<option value="">No Project Selected</option>';
                
                // Add each project as an option
                projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.name;
                    if (currentProject && currentProject.id === project.id) {
                        option.selected = true;
                    }
                    globalDropdown.appendChild(option);
                });
            }
            
            if (timelineDropdown) {
                // Clear existing options
                timelineDropdown.innerHTML = '<option value="">Select a project to view timeline...</option>';
                
                // Add each project as an option (don't auto-select based on currentProject)
                projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.name;
                    // Only select if this is the currently viewed project, not the active project
                    if (viewedProject && viewedProject.id === project.id) {
                        option.selected = true;
                    }
                    timelineDropdown.appendChild(option);
                });
            }
        }
        
        function switchToProject(projectId) {
            if (!projectId) {
                // No project selected
                currentProject = null;
                viewedProject = null; // Clear viewed project when clearing active project
                updateProjectSelector();
                showNotification('No project selected', 'info');
                return;
            }
            
            const projectIdNum = parseInt(projectId);
            loadProject(projectIdNum);
            
            // If we're switching to a different project, clear the viewed project
            // so the timeline shows the new active project
            if (viewedProject && viewedProject.id !== projectIdNum) {
                viewedProject = null;
                const timelineDropdown = document.getElementById('projectTimelineDropdown');
                if (timelineDropdown) {
                    timelineDropdown.value = '';
                }
            }
            
            // Ensure dropdown and display are synchronized
            setTimeout(() => {
                updateProjectSelector();
                // Force sync both dropdown selections
                const globalDropdown = document.getElementById('globalProjectDropdown');
                const timelineDropdown = document.getElementById('projectTimelineDropdown');
                if (currentProject) {
                    if (globalDropdown) {
                        globalDropdown.value = currentProject.id.toString();
                    }
                    if (timelineDropdown) {
                        timelineDropdown.value = currentProject.id.toString();
                    }
                }
            }, 10);
            
            showNotification(`Switched to project: ${currentProject.name}`, 'success');
        }
        
        function showProjectManager() {
            if (projects.length === 0) {
                showNotification('No projects to manage. Create a project first!', 'warning');
                return;
            }
            
            let projectList = 'Project Overview:\n';
            projectList += '='.repeat(50) + '\n\n';
            
            projects.forEach((project, index) => {
                const created = new Date(project.created).toLocaleDateString();
                const modified = project.lastModified ? new Date(project.lastModified).toLocaleDateString() : 'Never';
                const hasNotes = project.notes && project.notes.trim().length > 0;
                const notePreview = hasNotes ? project.notes.substring(0, 50) + (project.notes.length > 50 ? '...' : '') : 'No notes';
                
                projectList += `${index + 1}. ${project.name}\n`;
                projectList += `   📅 Created: ${created}\n`;
                projectList += `   🔄 Modified: ${modified}\n`;
                projectList += `   📏 Data: ${project.boards.length} boards, ${project.cuts.length} cuts, ${project.history.length} calculations\n`;
                projectList += `   📝 Notes: ${notePreview}\n\n`;
            });
            
            projectList += 'Commands:\n';
            projectList += '• Enter project number (1-' + projects.length + ') to load\n';
            projectList += '• "delete X" to delete project X\n';
            projectList += '• "export X" to export project X data\n';
            
            const action = prompt(projectList);
            
            if (action) {
                if (action.toLowerCase().startsWith('delete ')) {
                    const projectNum = parseInt(action.split(' ')[1]) - 1;
                    if (projectNum >= 0 && projectNum < projects.length) {
                        deleteProject(projects[projectNum].id);
                    }
                } else if (action.toLowerCase().startsWith('export ')) {
                    const projectNum = parseInt(action.split(' ')[1]) - 1;
                    if (projectNum >= 0 && projectNum < projects.length) {
                        exportProjectData(projects[projectNum]);
                    }
                } else {
                    const projectNum = parseInt(action) - 1;
                    if (projectNum >= 0 && projectNum < projects.length) {
                        loadProject(projects[projectNum].id);
                        updateProjectSelector();
                    }
                }
            }
        }
        
        function exportProjectData(project) {
            // Create both text and HTML exports
            createTextExport(project);
            createHTMLExport(project);
        }
        
        function createTextExport(project) {
            const date = new Date().toLocaleDateString();
            const time = new Date().toLocaleTimeString();
            
            let exportText = `📁 ${project.name} - Project Timeline\n`;
            exportText += `${'='.repeat(60)}\n`;
            exportText += `📅 Exported: ${date} at ${time}\n`;
            exportText += `📅 Created: ${new Date(project.created).toLocaleDateString()}\n`;
            exportText += `🔄 Last Modified: ${project.lastModified ? new Date(project.lastModified).toLocaleDateString() : 'Never'}\n\n`;
            
            // Project Notes
            if (project.notes && project.notes.trim()) {
                exportText += '📝 PROJECT NOTES:\n';
                exportText += '-'.repeat(40) + '\n';
                exportText += project.notes + '\n\n';
            }
            
            // Project Timeline - Main Focus
            if (project.projectLog && project.projectLog.length > 0) {
                exportText += `📊 SAVED CALCULATIONS (${project.projectLog.length}):\n`;
                exportText += '='.repeat(50) + '\n\n';
                
                // Sort by date (most recent first)
                const sortedLog = [...project.projectLog].sort((a, b) => 
                    new Date(b.timestamp) - new Date(a.timestamp)
                );
                
                sortedLog.forEach((logEntry, index) => {
                    const toolIcon = getToolIcon(logEntry.toolName);
                    const savedDate = new Date(logEntry.saved).toLocaleDateString();
                    const savedTime = new Date(logEntry.saved).toLocaleTimeString();
                    
                    exportText += `${index + 1}. ${toolIcon} ${logEntry.toolName}\n`;
                    exportText += `   📅 Saved: ${savedDate} at ${savedTime}\n`;
                    
                    if (logEntry.equation) {
                        exportText += `   🧮 Calculation: ${logEntry.equation}\n`;
                    }
                    if (logEntry.result) {
                        exportText += `   ✅ Result: ${logEntry.result}\n`;
                    }
                    if (logEntry.details) {
                        exportText += `   📋 Details:\n`;
                        const detailLines = logEntry.details.split('\n');
                        detailLines.forEach(line => {
                            if (line.trim()) exportText += `      ${line}\n`;
                        });
                    }
                    if (logEntry.userNotes) {
                        exportText += `   💡 Notes: ${logEntry.userNotes}\n`;
                    }
                    exportText += '\n';
                });
            } else {
                exportText += '📊 SAVED CALCULATIONS:\n';
                exportText += '-'.repeat(40) + '\n';
                exportText += 'No calculations saved to this project yet.\n\n';
            }
            
            // Legacy data (if exists)
            let hasLegacyData = false;
            
            if (project.boards && project.boards.length > 0) {
                hasLegacyData = true;
                exportText += '📏 AVAILABLE BOARDS:\n';
                exportText += '-'.repeat(30) + '\n';
                project.boards.forEach((board, index) => {
                    exportText += `${index + 1}. ${inchesToDisplay(board.length, 'opt')} × ${board.quantity}\n`;
                });
                exportText += '\n';
            }
            
            if (project.cuts && project.cuts.length > 0) {
                hasLegacyData = true;
                exportText += '✂️ NEEDED CUTS:\n';
                exportText += '-'.repeat(30) + '\n';
                project.cuts.forEach((cut, index) => {
                    exportText += `${index + 1}. ${inchesToDisplay(cut.length, 'opt')}\n`;
                });
                exportText += '\n';
            }
            
            if (hasLegacyData) {
                exportText += '\n' + '-'.repeat(60) + '\n';
                exportText += 'Generated by WorkShop Pro Calculator\n';
                exportText += 'This project timeline shows your manually saved calculations.\n';
            }
            
            // Create downloadable file
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${project.name.replace(/[^a-zA-Z0-9]/g, '_')}_timeline.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        function createHTMLExport(project) {
            const date = new Date().toLocaleDateString();
            const time = new Date().toLocaleTimeString();
            
            let html = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${project.name} - Project Timeline</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; color: #333; }
        .header { background: linear-gradient(135deg, var(--primary-color), var(--primary-light)); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .header h1 { margin: 0; font-size: 24px; }
        .project-info { margin-top: 10px; font-size: 14px; opacity: 0.9; }
        .notes { background: #fff9c4; border: 1px solid #f0e68c; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .timeline { background: #f8f9fa; border-radius: 8px; padding: 20px; }
        .timeline-item { background: white; border-left: 4px solid var(--secondary-color); border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .tool-header { display: flex; align-items: center; margin-bottom: 15px; }
        .tool-icon { font-size: 20px; margin-right: 10px; }
        .tool-name { font-weight: bold; color: var(--primary-color); font-size: 16px; flex: 1; }
        .timestamp { font-size: 12px; color: #666; }
        .equation { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; padding: 10px; margin: 10px 0; font-family: monospace; }
        .result { font-weight: bold; color: #28a745; font-size: 16px; margin: 10px 0; }
        .details { color: #666; margin: 10px 0; line-height: 1.4; white-space: pre-line; }
        .user-notes { background: #fff9c4; border: 1px solid #f0e68c; border-radius: 4px; padding: 10px; margin: 10px 0; font-style: italic; }
        .footer { text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 14px; }
        .empty-state { text-align: center; color: #666; font-style: italic; }
        @media print { body { max-width: none; margin: 0; padding: 15px; } .header { background: var(--primary-color) !important; } }
    </style>
</head>
<body>
    <div class="header">
        <h1>📁 ${project.name}</h1>
        <div class="project-info">
            📅 Exported: ${date} at ${time}<br>
            📅 Created: ${new Date(project.created).toLocaleDateString()}<br>
            🔄 Last Modified: ${project.lastModified ? new Date(project.lastModified).toLocaleDateString() : 'Never'}
        </div>
    </div>`;
            
            // Project Notes
            if (project.notes && project.notes.trim()) {
                html += `<div class="notes">
                    <h3>📝 Project Notes</h3>
                    <p>${project.notes.replace(/\n/g, '<br>')}</p>
                </div>`;
            }
            
            html += '<div class="timeline">';
            html += `<h2>📊 Saved Calculations (${project.projectLog ? project.projectLog.length : 0})</h2>`;
            
            if (project.projectLog && project.projectLog.length > 0) {
                // Sort by date (most recent first)
                const sortedLog = [...project.projectLog].sort((a, b) => 
                    new Date(b.timestamp) - new Date(a.timestamp)
                );
                
                sortedLog.forEach(logEntry => {
                    const toolIcon = getToolIcon(logEntry.toolName);
                    const savedDate = new Date(logEntry.saved).toLocaleString();
                    
                    html += `<div class="timeline-item">
                        <div class="tool-header">
                            <span class="tool-icon">${toolIcon}</span>
                            <span class="tool-name">${logEntry.toolName}</span>
                            <span class="timestamp">Saved: ${savedDate}</span>
                        </div>`;
                    
                    if (logEntry.equation) {
                        html += `<div class="equation">${logEntry.equation}</div>`;
                    }
                    if (logEntry.result) {
                        html += `<div class="result">Result: ${logEntry.result}</div>`;
                    }
                    if (logEntry.details) {
                        html += `<div class="details">${logEntry.details}</div>`;
                    }
                    if (logEntry.userNotes) {
                        html += `<div class="user-notes">💡 ${logEntry.userNotes}</div>`;
                    }
                    
                    html += '</div>';
                });
            } else {
                html += '<div class="empty-state">No calculations saved to this project yet.</div>';
            }
            
            html += '</div>';
            
            html += `<div class="footer">
                Generated by WorkShop Pro Calculator<br>
                <small>This timeline shows your manually saved calculations for easy reference and printing.</small>
            </div>
        </body>
        </html>`;
            
            // Create downloadable HTML file
            const blob = new Blob([html], { type: 'text/html' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${project.name.replace(/[^a-zA-Z0-9]/g, '_')}_timeline.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification(`Project "${project.name}" exported as text and HTML files!`, 'success');
        }
        
        function showProjectNotes() {
            if (!currentProject) {
                showNotification('Please create or select a project first', 'warning');
                return;
            }
            
            const modal = document.getElementById('notesModal');
            const projectName = document.getElementById('notesProjectName');
            const notesText = document.getElementById('projectNotesText');
            
            if (modal && projectName && notesText) {
                projectName.textContent = currentProject.name;
                notesText.value = currentProject.notes || '';
                modal.style.display = 'block';
                notesText.focus();
            }
        }
        
        function closeProjectNotes() {
            const modal = document.getElementById('notesModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Save to Project Modal Functions
        let currentSaveData = null; // Store the data being saved
        
        function showSaveToProjectModal(toolNameOrData, data, diagramContainerId) {
            // Handle both old format (toolName, data) and new format (saveDataObject)
            if (typeof toolNameOrData === 'string') {
                // Old format: showSaveToProjectModal('Tool Name', data, diagramContainerId)
                currentSaveData = {
                    toolName: toolNameOrData,
                    timestamp: new Date().toISOString(),
                    ...data
                };
                
                // Capture diagram if container ID provided
                if (diagramContainerId) {
                    const diagramData = captureSVGDiagram(diagramContainerId);
                    if (diagramData) {
                        currentSaveData.diagram = diagramData;
                    }
                }
                
                const modal = document.getElementById('saveToProjectModal');
                const previewContent = document.getElementById('savePreviewContent');
                
                // Generate preview content
                let previewHtml = `<h5>${toolNameOrData}</h5>`;
                if (data.equation) {
                    previewHtml += `<strong>Calculation:</strong> ${data.equation}<br>`;
                }
                if (data.result) {
                    previewHtml += `<strong>Result:</strong> ${data.result}<br>`;
                }
                if (currentSaveData.diagram) {
                    previewHtml += `<div style="margin: 10px 0; text-align: center;">
                        <strong>Diagram:</strong><br>
                        <img src="${currentSaveData.diagram.dataUrl}" style="max-width: 200px; max-height: 100px; border: 1px solid #ddd; border-radius: 4px;" alt="Calculation Diagram">
                    </div>`;
                }
                if (data.details) {
                    previewHtml += `<strong>Details:</strong><br>${data.details.replace(/\n/g, '<br>')}`;
                }
                
                previewContent.innerHTML = previewHtml;
            } else {
                // New format: showSaveToProjectModal(saveDataObject)
                const saveData = toolNameOrData;
                currentSaveData = {
                    toolName: saveData.toolName || saveData.tool || 'Calculator',
                    timestamp: new Date().toISOString(),
                    equation: saveData.equation,
                    result: saveData.result,
                    details: saveData.details
                };
                
                // Check if saveData includes diagram container ID or diagram data
                if (saveData.diagramContainerId) {
                    const diagramData = captureSVGDiagram(saveData.diagramContainerId);
                    if (diagramData) {
                        currentSaveData.diagram = diagramData;
                    }
                } else if (saveData.diagram) {
                    currentSaveData.diagram = saveData.diagram;
                }
                
                const modal = document.getElementById('saveToProjectModal');
                const previewContent = document.getElementById('savePreviewContent');
                
                // Use the custom preview if available, otherwise generate standard preview
                if (saveData.preview) {
                    previewContent.innerHTML = saveData.preview;
                } else {
                    let previewHtml = `<h5>${saveData.toolName || saveData.tool || 'Calculator'}</h5>`;
                    if (saveData.equation) {
                        previewHtml += `<strong>Calculation:</strong> ${saveData.equation}<br>`;
                    }
                    if (saveData.result) {
                        previewHtml += `<strong>Result:</strong> ${saveData.result}<br>`;
                    }
                    if (currentSaveData.diagram) {
                        previewHtml += `<div style="margin: 10px 0; text-align: center;">
                            <strong>Diagram:</strong><br>
                            <img src="${currentSaveData.diagram.dataUrl}" style="max-width: 200px; max-height: 100px; border: 1px solid #ddd; border-radius: 4px;" alt="Calculation Diagram">
                        </div>`;
                    }
                    if (saveData.details) {
                        previewHtml += `<strong>Details:</strong><br>${saveData.details.replace(/\n/g, '<br>')}`;
                    }
                    previewContent.innerHTML = previewHtml;
                }
            }
            
            // Populate project dropdown
            populateSaveProjectDropdown();
            
            // Clear notes text
            document.getElementById('saveNotesText').value = '';
            
            // Show modal
            const modal = document.getElementById('saveToProjectModal');
            console.log('DEBUG: Modal element found:', !!modal);
            if (modal) {
                console.log('DEBUG: Setting modal display to block');
                modal.style.display = 'block';
                console.log('DEBUG: Modal display is now:', modal.style.display);
            } else {
                console.error('DEBUG: Modal element not found!');
            }
        }
        
        function closeSaveToProjectModal() {
            const modal = document.getElementById('saveToProjectModal');
            if (modal) {
                modal.style.display = 'none';
            }
            currentSaveData = null;
        }
        
        function populateSaveProjectDropdown() {
            const dropdown = document.getElementById('saveProjectDropdown');
            if (!dropdown) return;
            
            // Clear existing options
            dropdown.innerHTML = '<option value="">Select a project...</option>';
            
            // Add current project as default if one exists
            if (currentProject) {
                const option = document.createElement('option');
                option.value = currentProject.id;
                option.textContent = `${currentProject.name} (Current)`;
                option.selected = true;
                dropdown.appendChild(option);
            }
            
            // Add other projects
            projects.forEach(project => {
                if (!currentProject || project.id !== currentProject.id) {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.name;
                    dropdown.appendChild(option);
                }
            });
        }
        
        function createNewProjectFromSaveModal() {
            const name = prompt('Enter new project name:');
            if (name && name.trim()) {
                // Create the project (reuse existing function logic)
                const project = {
                    id: Date.now(),
                    name: name.trim(),
                    created: new Date().toISOString(),
                    boards: [],
                    cuts: [],
                    history: [],
                    cutHistory: [],
                    projectLog: [],
                    calculatorData: {
                        currentValueInches: 0,
                        cutValueInches: 0,
                        currentOperation: null,
                        operationValue: 0,
                        memoryValue: 0,
                        value1: 0,
                        value2: 0,
                        inputMode: 'fraction'
                    },
                    notes: '',
                    tags: []
                };
                
                projects.push(project);
                currentProject = project;
                saveToLocalStorage();
                updateProjectSelector();
                
                // Refresh the dropdown
                populateSaveProjectDropdown();
                
                showNotification(`Project "${name}" created!`, 'success');
            }
        }
        
        function executeSaveToProject() {
            const projectId = document.getElementById('saveProjectDropdown').value;
            const notes = document.getElementById('saveNotesText').value.trim();
            
            if (!projectId) {
                showNotification('Please select a project', 'warning');
                return;
            }
            
            if (!currentSaveData) {
                showNotification('No data to save', 'error');
                return;
            }
            
            // Find the target project
            const targetProject = projects.find(p => p.id == projectId);
            if (!targetProject) {
                showNotification('Project not found', 'error');
                return;
            }
            
            // Create the project log entry
            const logEntry = {
                id: Date.now(),
                timestamp: currentSaveData.timestamp,
                toolName: currentSaveData.toolName,
                equation: currentSaveData.equation || '',
                result: currentSaveData.result || '',
                details: currentSaveData.details || '',
                diagram: currentSaveData.diagram || null,
                userNotes: notes,
                saved: new Date().toISOString()
            };
            
            // Add to project log
            if (!targetProject.projectLog) {
                targetProject.projectLog = [];
            }
            targetProject.projectLog.unshift(logEntry); // Add to beginning (most recent first)
            
            // Update project modified time
            targetProject.lastModified = new Date().toISOString();
            
            // Save to localStorage
            saveToLocalStorage();
            
            // Close modal and show success
            closeSaveToProjectModal();
            showNotification(`Saved to project: ${targetProject.name}`, 'success');
            
            // Update displays
            updateProjectSelector();
        }
        
        function saveProjectNotes() {
            if (!currentProject) {
                showNotification('No active project to save notes to', 'error');
                return;
            }
            
            const notesText = document.getElementById('projectNotesText');
            if (notesText) {
                currentProject.notes = notesText.value;
                saveCurrentProject();
                closeProjectNotes();
                showNotification('Project notes saved!', 'success');
            }
        }
        
        
        // Projects Tab Functions
        function renderProjectTimeline() {
            // This function is called from many places but relates to old UI
            // Just sync the global dropdown if needed
            const globalDropdown = document.getElementById('globalProjectDropdown');
            
            // Only sync with global dropdown for active project, not timeline viewing
            if (!currentProject && globalDropdown && globalDropdown.value) {
                const projectId = parseInt(globalDropdown.value);
                const project = projects.find(p => p.id === projectId);
                if (project) {
                    currentProject = project;
                }
            }
            
            // Sync global dropdown with current project
            if (currentProject && globalDropdown) {
                if (globalDropdown.value !== currentProject.id.toString()) {
                    globalDropdown.value = currentProject.id.toString();
                }
            }
        }
        
        // View-only timeline browsing (doesn't affect working project state)
        let viewedProject = null; // Separate from currentProject for timeline viewing
        
        function viewProjectTimeline(projectId) {
            if (!projectId) {
                return;
            }
            
            const projectIdNum = parseInt(projectId);
            const project = projects.find(p => p.id === projectIdNum);
            
            if (project) {
                // Only set the viewed project, don't overwrite working state
                viewedProject = project;
                
                // Initialize projectLog if it doesn't exist (for older projects)
                if (!project.projectLog) {
                    project.projectLog = [];
                }
                
                // Hide dashboard, show timeline view
                document.getElementById('activeProjectSection').style.display = 'none';
                document.querySelector('.quick-actions-section').style.display = 'none';
                document.getElementById('newProjectForm').style.display = 'none';
                document.getElementById('recentProjectsSection').style.display = 'none';
                document.getElementById('projectTimelineView').style.display = 'block';
                
                // Update timeline header
                document.getElementById('timelineProjectName').textContent = project.name;
                
                // Update project notes if they exist
                const notesSection = document.getElementById('timelineProjectNotes');
                const notesContent = document.getElementById('timelineProjectNotesContent');
                if (project.description && project.description.trim()) {
                    notesContent.textContent = project.description;
                    notesSection.style.display = 'block';
                } else {
                    notesSection.style.display = 'none';
                }
                
                // Update only the timeline display, not working data
                updateViewedProjectTimelineHeader();
                renderViewedTimelineContent();
                
                // Update the timeline dropdown but NOT the global dropdown
                const timelineDropdown = document.getElementById('projectTimelineDropdown');
                if (timelineDropdown) {
                    timelineDropdown.value = project.id.toString();
                }
            }
        }
        
        function updateViewedProjectTimelineHeader() {
            // Timeline view is already updated in viewProjectTimeline function
            // This function is for the old UI - no action needed
        }
        
        function renderViewedTimelineContent() {
            const timelineContent = document.getElementById('timelineContent');
            const emptyTimeline = document.getElementById('emptyTimeline');
            
            if (!viewedProject.projectLog || viewedProject.projectLog.length === 0) {
                timelineContent.innerHTML = '';
                emptyTimeline.style.display = 'block';
                return;
            }
            
            emptyTimeline.style.display = 'none';
            
            // Sort by timestamp (most recent first)
            const sortedLog = [...viewedProject.projectLog].sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );
            
            let timelineHTML = '';
            sortedLog.forEach(logEntry => {
                timelineHTML += createTimelineItem(logEntry);
            });
            
            timelineContent.innerHTML = timelineHTML;
        }
        
        function showNoProjectSelected() {
            // This function is for the old UI - update dashboard instead
            updateProjectsDashboard();
        }
        
        function updateProjectTimelineHeader() {
            // This function is for the old UI - update dashboard instead
            updateProjectsDashboard();
            
            document.getElementById('noProjectSelected').style.display = 'none';
            document.getElementById('projectTimeline').style.display = 'block';
        }
        
        function renderTimelineContent() {
            const timelineContent = document.getElementById('timelineContent');
            const emptyTimeline = document.getElementById('emptyTimeline');
            
            if (!currentProject.projectLog || currentProject.projectLog.length === 0) {
                timelineContent.innerHTML = '';
                emptyTimeline.style.display = 'block';
                return;
            }
            
            emptyTimeline.style.display = 'none';
            
            // Sort by timestamp (most recent first)
            const sortedLog = [...currentProject.projectLog].sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );
            
            let timelineHTML = '';
            sortedLog.forEach(logEntry => {
                timelineHTML += createTimelineItem(logEntry);
            });
            
            timelineContent.innerHTML = timelineHTML;
        }
        
        function getTimelineDetailsDisplay(logEntry) {
            const details = logEntry.details;
            
            // Handle string format (old format)
            if (typeof details === 'string') {
                return details.replace(/\n/g, '<br>');
            }
            
            // Handle object format (new format)
            if (typeof details === 'object' && details) {
                // For spacing calculator with marks (center-marks mode)
                if (details.mode === 'center-marks' && details.marks && details.marks.length > 0) {
                    let html = `<strong>📍 Center Mark Positions:</strong><br>`;
                    details.marks.slice(0, 8).forEach(mark => {
                        html += `Shelf ${mark.shelf}: ${mark.display}<br>`;
                    });
                    if (details.marks.length > 8) {
                        html += `... and ${details.marks.length - 8} more<br>`;
                    }
                    return html;
                }
                
                // For spacing calculator in shelf-spacing mode
                if (details.mode === 'shelf-spacing') {
                    let html = `<strong>📏 Shelf Spacing Details:</strong><br>`;
                    if (details.totalLength) {
                        html += `Total Length: ${inchesToDisplay ? inchesToDisplay(details.totalLength) : details.totalLength + '"'}<br>`;
                    }
                    if (details.numShelves && details.thickness) {
                        const thicknessDisplay = inchesToDisplay ? inchesToDisplay(details.thickness) : details.thickness + '"';
                        const totalMaterial = details.numShelves * details.thickness;
                        const totalMaterialDisplay = inchesToDisplay ? inchesToDisplay(totalMaterial) : totalMaterial.toFixed(3) + '"';
                        const availableSpace = details.totalLength - totalMaterial;
                        const availableSpaceDisplay = inchesToDisplay ? inchesToDisplay(availableSpace) : availableSpace.toFixed(3) + '"';
                        
                        html += `Shelves: ${details.numShelves} × ${thicknessDisplay} thick<br>`;
                        html += `Total Material: ${totalMaterialDisplay}<br>`;
                        html += `Available Space: ${availableSpaceDisplay}<br>`;
                    }
                    if (details.spacing) {
                        const spacingDisplay = inchesToDisplay ? inchesToDisplay(details.spacing) : details.spacing.toFixed(3) + '"';
                        html += `Spacing: ${spacingDisplay} each<br>`;
                    }
                    
                    // Show shelf positions if available
                    if (details.shelfPositions && details.shelfPositions.length > 0) {
                        html += `<br><strong>Shelf Positions:</strong><br>`;
                        details.shelfPositions.slice(0, 6).forEach(pos => {
                            html += `Shelf ${pos.shelf}: ${pos.startDisplay} to ${pos.endDisplay}<br>`;
                        });
                        if (details.shelfPositions.length > 6) {
                            html += `... and ${details.shelfPositions.length - 6} more<br>`;
                        }
                    }
                    
                    return html;
                }
                
                // For cut calculator with cut marks
                if (details.cutMarks && Array.isArray(details.cutMarks)) {
                    let html = `<strong>✂️ Cut Details:</strong><br>`;
                    if (details.originalLength) {
                        html += `Original Length: ${details.originalLength}<br>`;
                    }
                    if (details.pieces && details.pieceLength) {
                        html += `Pieces: ${details.pieces} @ ${details.pieceLength} each<br>`;
                    }
                    if (details.kerfNote) {
                        html += `Kerf: ${details.kerfNote}<br>`;
                    }
                    if (details.cutSideNote) {
                        html += `Cut Side: ${details.cutSideNote}<br>`;
                    }
                    
                    if (details.cutMarks.length > 0) {
                        html += `<br><strong>Cut Marks:</strong><br>`;
                        details.cutMarks.slice(0, 8).forEach((mark, i) => {
                            html += `Mark ${i + 1}: ${mark.display || mark}<br>`;
                        });
                        if (details.cutMarks.length > 8) {
                            html += `... and ${details.cutMarks.length - 8} more marks<br>`;
                        }
                    }
                    
                    return html;
                }
                
                // For lumber shopping cart with items
                if (details.items && Array.isArray(details.items)) {
                    let html = `<strong>🛒 Lumber Cart Details:</strong><br>`;
                    if (details.totalBoardFeet && details.totalCost) {
                        html += `Total: ${details.totalBoardFeet} BF - $${details.totalCost}<br><br>`;
                    }
                    
                    if (details.items.length > 0) {
                        html += `<strong>Items:</strong><br>`;
                        details.items.slice(0, 8).forEach((item, i) => {
                            html += `${i + 1}. ${item.species || 'Unknown'} - `;
                            html += `${item.quantity}pc × ${item.thickness}" × ${item.width}" × ${item.length}" `;
                            html += `(${item.boardFeet?.toFixed(3) || '0'} BF @ $${item.pricePerBF?.toFixed(2) || '0'}/BF = $${item.lineTotal?.toFixed(2) || '0'})<br>`;
                        });
                        if (details.items.length > 8) {
                            html += `... and ${details.items.length - 8} more items<br>`;
                        }
                    }
                    
                    return html;
                }
                
                // For other calculators or fallback to fullDetails
                if (details.fullDetails) {
                    return details.fullDetails.replace(/\n/g, '<br>');
                }
                
                // Generic object display
                return JSON.stringify(details, null, 2).replace(/\n/g, '<br>');
            }
            
            return '';
        }
        
        function createTimelineItem(logEntry) {
            // Handle both toolName and type fields for backward compatibility
            const toolName = logEntry.toolName || logEntry.type || 'Unknown Tool';
            const toolType = getToolTypeFromName(toolName);
            const markerIcon = getToolIcon(toolName);
            const timestamp = new Date(logEntry.timestamp).toLocaleString();
            const savedTime = new Date(logEntry.saved).toLocaleString();
            
            return `
                <div class="timeline-item">
                    <div class="timeline-marker ${toolType}">${markerIcon}</div>
                    <div class="timeline-card">
                        <div class="timeline-card-header">
                            <div class="timeline-tool-info">
                                <div class="timeline-tool-name">${logEntry.toolName}</div>
                                <div class="timeline-timestamp">Saved: ${savedTime}</div>
                            </div>
                            <div class="timeline-actions">
                                <button class="btn btn-sm btn-secondary" onclick="deleteTimelineItem('${logEntry.id}')" title="Delete">🗑️</button>
                            </div>
                        </div>
                        
                        ${logEntry.equation ? `<div class="timeline-equation">${logEntry.equation}</div>` : ''}
                        ${logEntry.result ? `<div class="timeline-result">Result: ${logEntry.result}</div>` : ''}
                        ${logEntry.diagram ? `<div class="timeline-diagram">
                            <div class="timeline-diagram-header">
                                <strong>📊 Diagram:</strong>
                                <button class="btn btn-sm btn-secondary" onclick="viewDiagramFullSize('${logEntry.id}')" title="View Full Size">🔍</button>
                            </div>
                            <div class="timeline-diagram-preview">
                                <img src="${logEntry.diagram.dataUrl}" style="max-width: 100%; max-height: 150px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;" onclick="viewDiagramFullSize('${logEntry.id}')" alt="Calculation Diagram">
                            </div>
                        </div>` : ''}
                        ${logEntry.details ? `<div class="timeline-details">${getTimelineDetailsDisplay(logEntry)}</div>` : ''}
                        ${logEntry.userNotes ? `<div class="timeline-notes">${logEntry.userNotes}</div>` : ''}
                    </div>
                </div>
            `;
        }
        
        function getToolTypeFromName(toolName) {
            // Handle undefined or null toolName
            if (!toolName || typeof toolName !== 'string') {
                return 'unknown';
            }
            
            if (toolName.includes('Calculator') && !toolName.includes('Golden') && !toolName.includes('Miter') && !toolName.includes('Shelf') && !toolName.includes('Screw')) {
                return 'calculator';
            } else if (toolName.includes('Golden Ratio')) {
                return 'golden';
            } else if (toolName.includes('Shelf') || toolName.includes('Division')) {
                return 'spacing';
            } else if (toolName.includes('Screw')) {
                return 'screw';
            } else if (toolName.includes('Miter') || toolName.includes('Angle')) {
                return 'miter';
            } else if (toolName.includes('Lumber') || toolName.includes('Board')) {
                return 'lumber';
            }
            return 'calculator';
        }
        
        function getToolIcon(toolName) {
            if (!toolName || typeof toolName !== 'string') {
                return '🔧';
            }
            
            if (toolName.includes('Calculator') && !toolName.includes('Golden') && !toolName.includes('Miter') && !toolName.includes('Shelf') && !toolName.includes('Screw')) {
                return '🧮';
            } else if (toolName.includes('Golden Ratio')) {
                return '✨';
            } else if (toolName.includes('Shelf') || toolName.includes('Division')) {
                return '📐';
            } else if (toolName.includes('Screw')) {
                return '🔩';
            } else if (toolName.includes('Miter') || toolName.includes('Angle')) {
                return '📐';
            } else if (toolName.includes('Lumber') || toolName.includes('Board')) {
                return '📏';
            }
            return '🧮';
        }
        
        function deleteTimelineItem(itemId) {
            if (!currentProject || !currentProject.projectLog) return;
            
            if (confirm('Delete this saved calculation from your project?')) {
                currentProject.projectLog = currentProject.projectLog.filter(item => item.id != itemId);
                currentProject.lastModified = new Date().toISOString();
                saveToLocalStorage();
                renderProjectTimeline();
                updateProjectSelector();
                showNotification('Calculation removed from project', 'success');
            }
        }

        // Diagram View Functions
        function viewDiagramFullSize(itemId) {
            const project = viewedProject || currentProject;
            if (!project) return;
            
            const logEntry = project.projectLog.find(item => item.id === parseInt(itemId));
            if (!logEntry || !logEntry.diagram) return;
            
            showDiagramModal(logEntry);
        }

        function showDiagramModal(logEntry) {
            // Create modal if it doesn't exist
            let modal = document.getElementById('diagramModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'diagramModal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 90vw; max-height: 90vh;">
                        <span class="close" onclick="closeDiagramModal()">&times;</span>
                        <div id="diagramModalContent"></div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            const content = document.getElementById('diagramModalContent');
            content.innerHTML = `
                <h3 style="color: var(--primary-color); margin-bottom: 20px;">📊 ${logEntry.toolName} - Diagram</h3>
                <div style="text-align: center; margin-bottom: 20px;">
                    <img src="${logEntry.diagram.dataUrl}" style="max-width: 100%; max-height: 70vh; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);" alt="Full Size Diagram">
                </div>
                <div style="background: var(--secondary-bg); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong>Calculation:</strong> ${logEntry.equation || 'N/A'}<br>
                    <strong>Result:</strong> ${logEntry.result || 'N/A'}<br>
                    <strong>Saved:</strong> ${new Date(logEntry.saved).toLocaleString()}
                </div>
                <div style="text-align: center;">
                    <button class="btn btn-secondary" onclick="downloadDiagram('${logEntry.id}')" style="margin-right: 10px;">📥 Download SVG</button>
                    <button class="btn btn-secondary" onclick="closeDiagramModal()">Close</button>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function closeDiagramModal() {
            const modal = document.getElementById('diagramModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function downloadDiagram(itemId) {
            const project = viewedProject || currentProject;
            if (!project) return;
            
            const logEntry = project.projectLog.find(item => item.id === parseInt(itemId));
            if (!logEntry || !logEntry.diagram) return;
            
            // Create download link
            const link = document.createElement('a');
            link.href = logEntry.diagram.dataUrl;
            link.download = `${logEntry.toolName.replace(/[^a-z0-9]/gi, '_')}_diagram_${logEntry.id}.svg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Diagram downloaded', 'success');
        }
        
        // All Projects Modal Functions
        function showAllProjects() {
            const modal = document.getElementById('allProjectsModal');
            renderAllProjectsModal();
            modal.style.display = 'block';
        }
        
        function closeAllProjectsModal() {
            const modal = document.getElementById('allProjectsModal');
            modal.style.display = 'none';
        }
        
        function renderAllProjectsModal() {
            const grid = document.getElementById('projectsGridModal');
            const noProjectsMsg = document.getElementById('noProjectsModalMessage');
            
            if (projects.length === 0) {
                grid.innerHTML = '';
                noProjectsMsg.style.display = 'block';
                return;
            }
            
            noProjectsMsg.style.display = 'none';
            
            grid.innerHTML = projects.map(project => {
                const logCount = project.projectLog ? project.projectLog.length : 0;
                const isActive = currentProject && currentProject.id === project.id;
                const created = new Date(project.created).toLocaleDateString();
                const modified = project.lastModified ? new Date(project.lastModified).toLocaleDateString() : 'Never';
                
                return `
                    <div class="project-card ${isActive ? 'current-project' : ''}" onclick="loadProjectFromModal(${project.id})">
                        <div class="project-card-content">
                            <div class="project-header">
                                <h4>${project.name} ${isActive ? '(Active)' : ''}</h4>
                                <div class="project-actions" onclick="event.stopPropagation()">
                                    <button class="btn btn-sm btn-secondary" onclick="duplicateProject(${project.id})" title="Duplicate">📋</button>
                                    <button class="btn btn-sm btn-secondary" onclick="exportCurrentProject(${project.id})" title="Export">📤</button>
                                    <button class="btn btn-sm btn-warning" onclick="deleteProject(${project.id})" title="Delete">🗑️</button>
                                </div>
                            </div>
                            <div class="project-stats">
                                <span class="stat">📊 ${logCount} saved calculations</span>
                                <span class="stat">📅 ${created}</span>
                                <span class="stat">🔄 ${modified}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function loadProjectFromModal(projectId) {
            closeAllProjectsModal();
            loadProject(projectId);
            updateProjectSelector();
            // The loadProject function will automatically show timeline if we're in Projects tab
        }
        
        function exportCurrentProject(projectId = null) {
            // Export the viewed project if we're viewing one, otherwise the active project
            const projectToExport = projectId ? projects.find(p => p.id === projectId) : 
                                   viewedProject ? viewedProject : currentProject;
            if (!projectToExport) {
                showNotification('No project to export', 'warning');
                return;
            }
            
            // Use existing export functionality but update for new timeline structure
            exportProjectData(projectToExport);
        }
        
        // Legacy functions for backward compatibility
        function renderProjectsTab() {
            // Ensure the project state is synced before rendering
            updateProjectSelector();
        }
        
        
        
        function loadProjectFromCard(projectId) {
            loadProject(projectId);
            updateProjectSelector();
            renderProjectsTab();
            
            // Switch to a useful tab for continuing work
            if (currentProject && (currentProject.boards.length > 0 || currentProject.cuts.length > 0)) {
                switchTab('optimizer');
            } else {
                switchTab('calculator');
            }
        }
        
        function duplicateProject(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            const newName = prompt(`Duplicate "${project.name}":\nEnter new project name:`, `${project.name} (Copy)`);
            if (!newName || !newName.trim()) return;
            
            const newProject = {
                ...project,
                id: Date.now(),
                name: newName.trim(),
                created: new Date().toISOString(),
                lastModified: null,
                projectLog: [] // Reset project log for new duplicate
            };
            
            projects.push(newProject);
            saveToLocalStorage();
            renderProjectsTab();
            updateProjectSelector();
            
            showNotification(`Project "${newName}" created!`, 'success');
        }
        
        function exportAllProjects() {
            if (projects.length === 0) {
                showNotification('No projects to export', 'warning');
                return;
            }
            
            const exportData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                projects: projects
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `woodworking_projects_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification(`${projects.length} projects exported!`, 'success');
        }
        
        function importProjects() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importData = JSON.parse(e.target.result);
                        
                        if (!importData.projects || !Array.isArray(importData.projects)) {
                            showNotification('Invalid project file format', 'error');
                            return;
                        }
                        
                        let importedCount = 0;
                        importData.projects.forEach(project => {
                            // Assign new ID to avoid conflicts
                            project.id = Date.now() + importedCount;
                            project.name = `${project.name} (Imported)`;
                            projects.push(project);
                            importedCount++;
                        });
                        
                        saveToLocalStorage();
                        renderProjectsTab();
                        updateProjectSelector();
                        
                        showNotification(`${importedCount} projects imported!`, 'success');
                    } catch (error) {
                        showNotification('Error reading project file', 'error');
                        console.error('Import error:', error);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        
        // Essential data save (no longer auto-called, used for manual saves and app close)
        function saveEssentialData() {
            // Only save essential persistent data, not temporary calculator states
            saveToLocalStorage();
        }
        
        // Auto-save interval removed - now using manual "Save to Project" workflow
        
        // DEBUG: Test function to check modal functionality
        function testSaveModal() {
            console.log('=== DEBUG: Testing modal directly ===');
            const modal = document.getElementById('saveToProjectModal');
            console.log('Modal element:', modal);
            if (modal) {
                modal.style.display = 'block';
                console.log('Modal should now be visible');
            } else {
                console.error('Modal element not found!');
            }
        }
        
        // Track event listeners for cleanup
        const eventListenerRegistry = [];
        
        /**
         * Add event listener with automatic tracking for cleanup
         * @param {Element} element - DOM element
         * @param {string} event - Event name
         * @param {Function} handler - Event handler function
         * @param {Object} options - Event listener options
         */
        function addTrackedEventListener(element, event, handler, options) {
            element.addEventListener(event, handler, options);
            eventListenerRegistry.push({ element, event, handler, options });
        }
        
        /**
         * Remove all tracked event listeners
         * Useful for cleanup when switching tabs or modes
         */
        function cleanupEventListeners() {
            eventListenerRegistry.forEach(({ element, event, handler, options }) => {
                if (element && element.removeEventListener) {
                    element.removeEventListener(event, handler, options);
                }
            });
            // Clear the registry
            eventListenerRegistry.length = 0;
        }
        
        /**
         * Cleanup tab-specific event listeners when switching tabs
         * @param {string} oldTab - Tab being left
         * @param {string} newTab - Tab being entered
         */
        function cleanupTabEventListeners(oldTab, newTab) {
            // Clean up tile pattern specific listeners
            if (oldTab === 'tilePattern' && typeof cleanupTilePatternListeners === 'function') {
                cleanupTilePatternListeners();
            }
            
            // Clear any lingering touch event listeners
            if (isMobileDevice()) {
                const oldTabElement = document.getElementById(oldTab);
                if (oldTabElement) {
                    const buttons = oldTabElement.querySelectorAll('.calc-btn, .btn');
                    buttons.forEach(button => {
                        // Clone and replace to remove all event listeners
                        const newButton = button.cloneNode(true);
                        button.parentNode.replaceChild(newButton, button);
                    });
                }
            }
            
            // Re-initialize touch events for new tab
            if (newTab && isMobileDevice()) {
                setTimeout(() => {
                    initializeTouchEvents();
                }, 100);
            }
        }
        
        // Save essential data when user closes the app
        window.addEventListener('beforeunload', function() {
            saveEssentialData();
            cleanupEventListeners();
        });
        
        // Notification system to replace alerts
        function showNotification(message, type = 'error') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification show';
            if (type === 'success') notification.classList.add('success');
            else if (type === 'warning') notification.classList.add('warning');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Initialize fraction selectors with proper fraction display
        function updatePrecision(tabName = null) {
            let precision = 16;
            let fractionSelects = [];
            
            if (tabName === 'calculator' || !tabName) {
                precision = parseInt(document.getElementById('precision')?.value || 16);
                fractionSelects = ['fraction1', 'fraction2', 'grFraction', 'singleBoardWidthFraction', 'singleInputLengthFraction', 'frameMaterialWidthFraction', 'frameWidthFraction', 'frameHeightFraction', 'framePolygonFraction', 'spTotalLengthFraction', 'spacingThicknessFraction'];
                
                // Update calculator display with new precision
                updateCalculation();
                updateConversionPreview();
            } else if (tabName === 'cut') {
                precision = parseInt(document.getElementById('cutPrecision')?.value || 16);
                fractionSelects = ['cutFraction', 'boardFraction', 'optCutFraction'];
                
                // Update cut calculator displays
                if (typeof calculateCuts === 'function') calculateCuts();
            } else if (tabName === 'optimizer') {
                precision = parseInt(document.getElementById('optPrecision')?.value || 16);
                fractionSelects = ['boardFraction', 'optCutFraction'];
                
                // Update optimizer displays
                if (typeof calculateCuts === 'function') calculateCuts();
            } else if (tabName === 'edit') {
                // Special case for edit modal - use optimizer precision
                precision = parseInt(document.getElementById('optPrecision')?.value || 16);
                fractionSelects = ['editFraction'];
            }
            
            fractionSelects.forEach(id => {
                const select = document.getElementById(id);
                if (!select) return;
                
                const currentValue = select.value; // Store current value
                select.innerHTML = '<option value="0">0</option>';
                
                // Use DocumentFragment for better performance
                const fragment = document.createDocumentFragment();
                
                for (let i = 1; i < precision; i++) {
                    const decimal = i / precision;
                    let displayText;
                    
                    const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
                    const divisor = gcd(i, precision);
                    const simplifiedNumerator = i / divisor;
                    const simplifiedDenominator = precision / divisor;
                    
                    if (simplifiedDenominator === precision) {
                        displayText = `${i}/${precision}`;
                    } else {
                        displayText = `${simplifiedNumerator}/${simplifiedDenominator} (${i}/${precision})`;
                    }
                    
                    const option = document.createElement('option');
                    option.value = decimal;
                    option.textContent = displayText;
                    fragment.appendChild(option);
                }
                
                select.appendChild(fragment);
                
                // Restore value if it still exists
                if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
                    select.value = currentValue;
                }
            });
            
            // Update calculator second input if it exists
            if (tabName === 'calculator') {
                const fraction2 = document.getElementById('fraction2');
                if (fraction2) {
                    const currentValue = fraction2.value;
                    fraction2.innerHTML = '<option value="0">0</option>';
                    // Use DocumentFragment for better performance
                    const fragment = document.createDocumentFragment();
                    
                    for (let i = 1; i < precision; i++) {
                        const decimal = i / precision;
                        const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
                        const divisor = gcd(i, precision);
                        const simplifiedNumerator = i / divisor;
                        const simplifiedDenominator = precision / divisor;
                        
                        let displayText;
                        if (simplifiedDenominator === precision) {
                            displayText = `${i}/${precision}`;
                        } else {
                            displayText = `${simplifiedNumerator}/${simplifiedDenominator} (${i}/${precision})`;
                        }
                        
                        const option = document.createElement('option');
                        option.value = decimal;
                        option.textContent = displayText;
                        fragment.appendChild(option);
                    }
                    
                    fraction2.appendChild(fragment);
                    if (currentValue && Array.from(fraction2.options).some(opt => opt.value === currentValue)) {
                        fraction2.value = currentValue;
                    }
                }
            }
        }
        
        // Update woodworking calculator fraction dropdowns when main precision changes
        function updateWoodworkingFractions() {
            const precision = parseInt(document.getElementById('precision')?.value || 16);
            const woodworkingFractionSelects = [
                'grFraction', 'singleBoardWidthFraction', 'singleInputLengthFraction', 
                'frameMaterialWidthFraction', 'frameWidthFraction', 'frameHeightFraction', 'framePolygonFraction',
                'spTotalLengthFraction', 'spacingThicknessFraction'
            ];
            
            woodworkingFractionSelects.forEach(id => {
                const select = document.getElementById(id);
                if (!select) return;
                
                const currentValue = select.value; // Store current value
                select.innerHTML = '<option value="0">0</option>';
                
                // Use DocumentFragment for better performance
                const fragment = document.createDocumentFragment();
                
                for (let i = 1; i < precision; i++) {
                    const decimal = i / precision;
                    let displayText;
                    
                    const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
                    const divisor = gcd(i, precision);
                    const simplifiedNumerator = i / divisor;
                    const simplifiedDenominator = precision / divisor;
                    
                    if (simplifiedDenominator === precision) {
                        displayText = `${i}/${precision}"`;
                    } else {
                        displayText = `${simplifiedNumerator}/${simplifiedDenominator}"`;
                    }
                    
                    const option = document.createElement('option');
                    option.value = decimal;
                    option.textContent = displayText;
                    fragment.appendChild(option);
                }
                
                select.appendChild(fragment);
                
                // Restore value if it still exists
                if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
                    select.value = currentValue;
                }
            });
        }
        
        // Convert inches to feet/inches/fraction display
        function inchesToDisplay(totalInches, useTab = 'calculator') {
            let precision = 16;
            if (useTab === 'cut') {
                precision = parseInt(document.getElementById('cutPrecision')?.value || 16);
            } else if (useTab === 'opt') {
                precision = parseInt(document.getElementById('optPrecision')?.value || 16);
            } else {
                precision = parseInt(document.getElementById('precision')?.value || 16);
            }
            
            // Handle negative numbers
            const isNegative = totalInches < 0;
            const absInches = Math.abs(totalInches);
            
            const roundedInches = Math.round(absInches * precision) / precision;
            const feet = Math.floor(roundedInches / 12);
            const remainingInches = roundedInches - (feet * 12);
            const wholeInches = Math.floor(remainingInches);
            const fractionDecimal = remainingInches - wholeInches;
            
            let display = '';
            if (feet > 0) {
                display += feet + "'";
                if (wholeInches > 0 || fractionDecimal > 0) {
                    display += ' ';
                } else {
                    // Clean foot measurement - add 0"
                    display += ' 0"';
                    return isNegative ? '-' + display : display;
                }
            }
            
            if (wholeInches > 0 || (feet === 0 && fractionDecimal === 0)) {
                display += wholeInches;
                if (fractionDecimal > 0) {
                    display += ' ';
                }
            }
            
            if (fractionDecimal > 0) {
                const numerator = Math.round(fractionDecimal * precision);
                const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
                const divisor = gcd(numerator, precision);
                display += (numerator / divisor) + '/' + (precision / divisor);
            }
            
            if (display === '') display = '0';
            display += '"';
            
            // Add negative sign if needed
            if (isNegative) {
                display = '-' + display;
            }
            
            return display;
        }
        
        // Convert inches to feet, inches, and fraction parts
        function inchesToParts(totalInches) {
            const feet = Math.floor(totalInches / 12);
            const remainingInches = totalInches - (feet * 12);
            const wholeInches = Math.floor(remainingInches);
            const fractionDecimal = remainingInches - wholeInches;
            
            return {
                feet: feet,
                inches: wholeInches,
                fraction: fractionDecimal
            };
        }
        
        // Alias for inchesToParts for compatibility
        function inchesToFeetInches(totalInches) {
            return inchesToParts(totalInches);
        }
        
        // Convert inches to feet display string
        function inchesToFeet(totalInches) {
            const feet = Math.floor(totalInches / 12);
            const remainingInches = totalInches - (feet * 12);
            const wholeInches = Math.floor(remainingInches);
            const fractionDecimal = remainingInches - wholeInches;
            
            let display = '';
            if (feet > 0) {
                display += feet + "'";
                if (wholeInches > 0 || fractionDecimal > 0) {
                    display += ' ';
                }
            }
            
            if (wholeInches > 0 || (feet === 0 && fractionDecimal === 0)) {
                display += wholeInches;
            }
            
            if (fractionDecimal > 0) {
                const precision = 16; // default precision
                const numerator = Math.round(fractionDecimal * precision);
                if (numerator > 0) {
                    let denominator = precision;
                    let num = numerator;
                    
                    // Simplify fraction
                    while (num % 2 === 0 && denominator % 2 === 0) {
                        num /= 2;
                        denominator /= 2;
                    }
                    
                    if (wholeInches > 0 || feet > 0) {
                        display += ' ';
                    }
                    display += num + '/' + denominator;
                }
            }
            
            display += '"';
            return display;
        }
        
        // Get total inches from inputs
        function getInputInches(feetId, inchesId, fractionId) {
            const feet = parseFloat(document.getElementById(feetId)?.value) || 0;
            const inches = parseFloat(document.getElementById(inchesId)?.value) || 0;
            const fraction = parseFloat(document.getElementById(fractionId)?.value) || 0;
            return (feet * 12) + inches + fraction;
        }
        
        function setCurrentValue() {
            currentValueInches = getInputInches('feet', 'inches', 'fraction');
            document.getElementById('currentValue').textContent = inchesToDisplay(currentValueInches);
        }
        
        // New calculator functions
        function setOperation(op) {
            currentOperation = op;
            // Hide both input groups and preview divs first
            document.getElementById('input2GroupFeetInches').style.display = 'none';
            document.getElementById('input2GroupNumber').style.display = 'none';
            document.getElementById('previewInput2').style.display = 'none';
            
            // Show appropriate input group based on operation
            if (op === '+' || op === '-') {
                // Addition and subtraction use feet/inches input
                document.getElementById('input2GroupFeetInches').style.display = 'flex';
                document.getElementById('previewInput2').style.display = 'block';
            } else if (op === '*' || op === '/') {
                // Multiplication and division use simple number input
                document.getElementById('input2GroupNumber').style.display = 'flex';
                // Factor input starts blank - no default value
            }
            
            // Update button highlighting
            document.querySelectorAll('.calc-btn.operation').forEach(btn => btn.classList.remove('active'));
            const btnMap = {'+': 'addBtn', '-': 'subBtn', '*': 'mulBtn', '/': 'divBtn'};
            const activeBtn = document.getElementById(btnMap[op]);
            if (activeBtn) activeBtn.classList.add('active');
            
            updateCalculation();
        }
        
        function updateCalculation() {
            // Use smart input values if available, otherwise fall back to legacy inputs
            let value1 = currentInput1Inches;
            if (value1 === 0) {
                // Handle decimal input in beginner mode
                const decimalInput = document.getElementById('decimalOnlyInput');
                if (decimalInput && decimalInput.style.display !== 'none' && decimalInput.value) {
                    value1 = parseFloat(decimalInput.value) || 0;
                } else {
                    value1 = getInputInches('feet1', 'inches1', 'fraction1');
                }
            }
            
            // Get value2 based on operation type
            let value2 = 0;
            if (currentOperation === '+' || currentOperation === '-') {
                // For addition/subtraction, use smart input if available, otherwise legacy
                value2 = currentInput2Inches;
                if (value2 === 0) {
                    value2 = getInputInches('feet2', 'inches2', 'fraction2');
                }
            } else if (currentOperation === '*' || currentOperation === '/') {
                // For multiplication/division, use simple number factor
                const factorInput = document.getElementById('factor');
                value2 = parseFloat(factorInput.value) || 0;
            }
            
            const equation = document.getElementById('calcEquation');
            const result = document.getElementById('calcResult');
            
            if (value1 > 0) {
                let equationText = inchesToDisplay(value1);
                
                if (currentOperation) {
                    equationText += ` ${currentOperation} `;
                    if (value2 > 0) {
                        // Show appropriate format for equation
                        if (currentOperation === '+' || currentOperation === '-') {
                            equationText += inchesToDisplay(value2);
                        } else {
                            equationText += value2.toString();
                        }
                        
                        // Auto-calculate if we have both values
                        let calcResult = 0;
                        switch (currentOperation) {
                            case '+': calcResult = value1 + value2; break;
                            case '-': calcResult = value1 - value2; break;
                            case '*': calcResult = value1 * value2; break;
                            case '/': calcResult = value2 !== 0 ? value1 / value2 : 0; break;
                        }
                        
                        // Always show the result, even if it's zero or negative
                        result.textContent = inchesToDisplay(calcResult);
                        result.classList.add('has-value');
                        currentValueInches = calcResult; // Update current value
                        lastCalculatorUpdate = Date.now(); // Mark calculator as most recent
                        lastConversionSource = 'calculator';
                        updateConversionPreview(); // Update conversion preview
                        
                        // Show hint that result is clickable (but not for negative/zero)
                        if (calcResult > 0) {
                            document.getElementById('resultHint').style.display = 'block';
                        } else {
                            document.getElementById('resultHint').style.display = 'none';
                        }
                        
                        // Add warning styling for negative results
                        if (calcResult < 0) {
                            result.classList.add('negative-result');
                        } else {
                            result.classList.remove('negative-result');
                        }
                    }
                }
                equation.textContent = equationText;
            } else {
                equation.innerHTML = '&nbsp;';
                result.textContent = '0"';
                result.classList.remove('has-value');
                // Hide hint when no result
                document.getElementById('resultHint').style.display = 'none';
            }
            
            // Update conversion preview
            updateConversionPreview();
        }
        
        function calculateResult() {
            // No longer needed - replaced by saveToHistory
        }
        
        function saveToHistory() {
            // Keep original functionality for backward compatibility
            if (!currentOperation || value1 === 0) {
                if (value1 > 0) {
                    // Just save the current value
                    addToCalcHistory({
                        equation: inchesToDisplay(value1),
                        result: value1,
                        timestamp: new Date().toLocaleTimeString(),
                        type: 'value'
                    });
                }
                return;
            }
            
            let result = 0;
            switch (currentOperation) {
                case '+': result = value1 + value2; break;
                case '-': result = value1 - value2; break;
                case '*': result = value1 * value2; break;
                case '/': 
                    if (value2 === 0) {
                        showNotification('Cannot divide by zero');
                        return;
                    }
                    result = value1 / value2;
                    break;
            }
            
            const timestamp = new Date().toLocaleTimeString();
            const historyEntry = {
                equation: `${inchesToDisplay(value1)} ${currentOperation} ${inchesToDisplay(value2)} = ${inchesToDisplay(result)}`,
                result: result,
                timestamp: timestamp,
                type: 'calculation'
            };
            
            addToCalcHistory(historyEntry);
            
            // Set result as new value1 for chaining calculations
            const parts = inchesToParts(result);
            document.getElementById('feet1').value = parts.feet || '';
            document.getElementById('inches1').value = parts.inches || '';
            document.getElementById('fraction1').value = parts.fraction || 0;
            
            // Clear second input
            clearInput2();
            currentOperation = null;
            document.getElementById('input2Group').style.display = 'none';
            document.querySelectorAll('.calc-btn.operation').forEach(btn => btn.classList.remove('active'));
            
            updateCalculation();
        }
        
        // New Save to Project functions
        function saveCalculatorToProject() {
            if (!currentOperation || value1 === 0) {
                if (value1 > 0) {
                    // Save just the current value
                    const data = {
                        equation: inchesToDisplay(value1),
                        result: inchesToDisplay(value1),
                        details: `Current calculator value: ${inchesToDisplay(value1)}`
                    };
                    showSaveToProjectModal('Calculator', data);
                }
                return;
            }
            
            let result = 0;
            switch (currentOperation) {
                case '+': result = value1 + value2; break;
                case '-': result = value1 - value2; break;
                case '*': result = value1 * value2; break;
                case '/': 
                    if (value2 === 0) {
                        showNotification('Cannot divide by zero');
                        return;
                    }
                    result = value1 / value2;
                    break;
            }
            
            const equation = `${inchesToDisplay(value1)} ${currentOperation} ${inchesToDisplay(value2)} = ${inchesToDisplay(result)}`;
            const data = {
                equation: equation,
                result: inchesToDisplay(result),
                details: `Calculation: ${inchesToDisplay(value1)} ${currentOperation} ${inchesToDisplay(value2)}\nResult: ${inchesToDisplay(result)}`
            };
            
            showSaveToProjectModal('Calculator', data);
            
            // Still perform the calculation locally
            const parts = inchesToParts(result);
            document.getElementById('feet1').value = parts.feet || '';
            document.getElementById('inches1').value = parts.inches || '';
            document.getElementById('fraction1').value = parts.fraction || 0;
            
            clearInput2();
            currentOperation = null;
            document.getElementById('input2Group').style.display = 'none';
            document.querySelectorAll('.calc-btn.operation').forEach(btn => btn.classList.remove('active'));
            
            updateCalculation();
        }
        
        function resetCalculatorState() {
            // Clear ALL smart input variables
            currentInput1Inches = 0;
            currentInput2Inches = 0;
            currentValueInches = 0;
            
            // Clear ALL global variables  
            value1 = 0;
            value2 = 0;
            currentOperation = null;
            
            // Clear ALL DOM elements - smart inputs
            document.getElementById('smartInput1').value = '';
            document.getElementById('smartInput2').value = '';
            document.getElementById('factor').value = '';
            
            // Clear ALL DOM elements - legacy inputs
            document.getElementById('feet1').value = '';
            document.getElementById('inches1').value = '';
            document.getElementById('fraction1').value = '0';
            document.getElementById('feet2').value = '';
            document.getElementById('inches2').value = '';
            document.getElementById('fraction2').value = '0';
            
            // Clear ALL preview divs
            document.getElementById('previewInput1').innerHTML = '';
            document.getElementById('previewInput2').innerHTML = '';
            
            // Reset UI state
            document.querySelectorAll('.calc-btn.operation').forEach(btn => btn.classList.remove('active'));
            document.getElementById('input2GroupFeetInches').style.display = 'none';
            document.getElementById('input2GroupNumber').style.display = 'none';
            document.getElementById('resultHint').style.display = 'none';
        }
        
        function clearCalculator() {
            resetCalculatorState();
            updateCalculation();
            updateConversionPreview();
        }
        
        // Parse and calculate complex expressions with mixed units
        function calculateExpression() {
            const input = document.getElementById('smartInput1').value;
            if (!input || input.trim() === '') return;
            
            try {
                // Split expression by operators while keeping them
                const parts = input.split(/(\s*[\+\-\×\÷]\s*)/);
                let totalInches = 0;
                let currentOperation = '+';
                
                for (let i = 0; i < parts.length; i++) {
                    const part = parts[i].trim();
                    
                    // Check if it's an operator
                    if (['+', '-', '×', '÷'].includes(part)) {
                        currentOperation = part;
                        continue;
                    }
                    
                    // Skip empty parts
                    if (!part) continue;
                    
                    // Parse the measurement
                    const inches = parseMeasurementToInches(part);
                    if (inches === null || isNaN(inches)) {
                        console.warn('Could not parse:', part);
                        continue;
                    }
                    
                    // Apply the operation
                    switch (currentOperation) {
                        case '+':
                            totalInches += inches;
                            break;
                        case '-':
                            totalInches -= inches;
                            break;
                        case '×':
                            totalInches *= inches;
                            break;
                        case '÷':
                            if (inches !== 0) {
                                totalInches /= inches;
                            }
                            break;
                    }
                }
                
                // Update display with result
                currentValueInches = totalInches;
                
                // Display the equation and result
                const equation = document.getElementById('calcEquation');
                const result = document.getElementById('calcResult');
                const resultHint = document.getElementById('resultHint');
                
                equation.textContent = input;
                result.textContent = formatResult(totalInches);
                resultHint.style.display = 'block';
                
                // Clear the input and show result
                document.getElementById('smartInput1').value = '';
                document.getElementById('previewInput1').textContent = '';
                
            } catch (error) {
                console.error('Error calculating expression:', error);
                showNotification('Error calculating expression', 'error');
            }
        }
        
        // Parse a measurement string to inches (handles all formats)
        function parseMeasurementToInches(measurement) {
            if (!measurement || measurement.trim() === '') return null;
            
            let input = measurement.trim();
            
            // Handle metric units
            if (input.includes('mm')) {
                const value = parseFloat(input.replace('mm', '').trim());
                if (isNaN(value)) return null;
                return value / 25.4; // mm to inches
            }
            if (input.includes('cm')) {
                const value = parseFloat(input.replace('cm', '').trim());
                if (isNaN(value)) return null;
                return value / 2.54; // cm to inches
            }
            if (input.endsWith('m') && !input.includes('mm') && !input.includes('cm')) {
                const value = parseFloat(input.replace('m', '').trim());
                if (isNaN(value)) return null;
                return value * 39.3701; // meters to inches
            }
            
            // Handle explicit feet/inches notation (e.g., 4'6")
            const feetInchesMatch = input.match(/^(\d+)'(?:\s*(\d+(?:\s+\d+\/\d+)?|\d+\/\d+)?"?)?$/);
            if (feetInchesMatch) {
                const feet = parseInt(feetInchesMatch[1]) || 0;
                const inchPart = feetInchesMatch[2] || '0';
                const inches = parseInchesWithFraction(inchPart);
                return feet * 12 + inches;
            }
            
            // Handle inches with quotes (e.g., 12", 12.5", 12 1/2")
            if (input.endsWith('"')) {
                input = input.slice(0, -1).trim();
                return parseInchesWithFraction(input);
            }
            
            // Handle space-separated format (e.g., "4 3 3/32" for 4'3 3/32")
            const spaceParts = input.split(/\s+/);
            if (spaceParts.length >= 2) {
                const firstNum = parseFloat(spaceParts[0]);
                const secondPart = spaceParts[1];
                
                // Check various patterns for feet/inches
                if (spaceParts.length === 2) {
                    // Pattern: "4 6" (4 feet 6 inches)
                    const secondNum = parseFloat(secondPart);
                    if (!isNaN(secondNum) && secondNum < 12 && !secondPart.includes('/')) {
                        return firstNum * 12 + secondNum;
                    }
                } else if (spaceParts.length === 3) {
                    // Pattern: "4 2 1/16" (4 feet 2 and 1/16 inches)
                    const secondNum = parseFloat(secondPart);
                    const thirdPart = spaceParts[2];
                    
                    if (!isNaN(secondNum) && secondNum < 12 && thirdPart.includes('/')) {
                        const feet = firstNum;
                        const inches = secondNum + parseFraction(thirdPart);
                        return feet * 12 + inches;
                    }
                    // Pattern: "4 11 15/16" (4 feet 11 and 15/16 inches)
                    else if (!isNaN(secondNum) && secondNum < 12 && !secondPart.includes('/')) {
                        const feet = firstNum;
                        const inches = secondNum + parseFraction(thirdPart);
                        return feet * 12 + inches;
                    }
                }
            }
            
            // Try parsing as inches with fraction (e.g., "12 1/2")
            const result = parseInchesWithFraction(input);
            return (isNaN(result) || result === null) ? null : result;
        }
        
        // Parse inches that may include a fraction
        function parseInchesWithFraction(input) {
            if (!input || input.trim() === '') return 0;
            
            input = input.trim();
            
            // Check for mixed number (e.g., "12 1/2")
            const parts = input.split(/\s+/);
            if (parts.length === 2 && parts[1].includes('/')) {
                const whole = parseFloat(parts[0]) || 0;
                const fraction = parseFraction(parts[1]);
                return whole + fraction;
            }
            
            // Check for just a fraction
            if (input.includes('/')) {
                return parseFraction(input);
            }
            
            // Parse as decimal
            const result = parseFloat(input);
            return isNaN(result) ? null : result;
        }
        
        // Parse a fraction string to decimal
        function parseFraction(fraction) {
            if (!fraction || !fraction.includes('/')) return 0;
            
            const parts = fraction.split('/');
            if (parts.length !== 2) return 0;
            
            const numerator = parseFloat(parts[0]);
            const denominator = parseFloat(parts[1]);
            
            if (denominator === 0) return 0;
            return numerator / denominator;
        }
        
        // Format result as feet/inches with fraction
        // Convert decimal inches to fraction string
        function convertToFraction(decimalInches, precisionStr) {
            // Handle whole numbers
            const wholeInches = Math.floor(decimalInches);
            const fractionDecimal = decimalInches - wholeInches;
            
            if (fractionDecimal < 0.001) {
                // No fraction part
                return wholeInches > 0 ? wholeInches.toString() : '0';
            }
            
            // Parse precision (e.g., "1/16" -> 16, "1/32" -> 32)
            let precision = 16; // default
            if (precisionStr) {
                const parts = precisionStr.split('/');
                if (parts.length === 2) {
                    precision = parseInt(parts[1]);
                }
            }
            
            // Convert to fraction
            const numerator = Math.round(fractionDecimal * precision);
            if (numerator === 0) {
                return wholeInches > 0 ? wholeInches.toString() : '0';
            }
            
            // Simplify fraction
            let num = numerator;
            let denom = precision;
            
            // Find GCD and simplify
            while (num % 2 === 0 && denom % 2 === 0) {
                num /= 2;
                denom /= 2;
            }
            
            // Build result string
            let result = '';
            if (wholeInches > 0) {
                result = wholeInches + ' ';
            }
            result += num + '/' + denom;
            
            return result;
        }
        
        function formatResult(inches) {
            if (inches === 0) return '0"';
            
            const negative = inches < 0;
            inches = Math.abs(inches);
            
            const feet = Math.floor(inches / 12);
            const remainingInches = inches % 12;
            
            // Get precision setting
            const precisionSelect = document.getElementById('precision');
            const precision = precisionSelect ? precisionSelect.value : '1/16';
            
            // Convert decimal inches to fraction
            const fractionResult = convertToFraction(remainingInches, precision);
            
            let result = '';
            if (feet > 0) {
                result = feet + "'";
                if (fractionResult && fractionResult !== '0') {
                    result += " " + fractionResult + '"';
                }
            } else {
                result = fractionResult + '"';
            }
            
            return negative ? '-' + result : result;
        }
        
        // Handle backspace button
        function handleBackspace() {
            const smartInput1 = document.getElementById('smartInput1');
            if (smartInput1.value.length > 0) {
                smartInput1.value = smartInput1.value.slice(0, -1);
                handleSmartInput(smartInput1, 'previewInput1', updateInput1Value);
            }
        }
        
        function handleKeypadButton(value, type) {
            const smartInput1 = document.getElementById('smartInput1');
            const currentInput = smartInput1.value;
            
            switch(type) {
                case 'number':
                    // Append number or decimal point to current input
                    smartInput1.value = currentInput + value;
                    handleSmartInput(smartInput1, 'previewInput1', updateInput1Value);
                    break;
                    
                case 'space':
                    // Add a space
                    smartInput1.value = currentInput + ' ';
                    handleSmartInput(smartInput1, 'previewInput1', updateInput1Value);
                    break;
                    
                case 'unit':
                    // Add unit (ft, in, mm, cm, m) - handle smartly
                    if (value === 'ft') {
                        smartInput1.value = currentInput + '\'';
                    } else if (value === 'in') {
                        smartInput1.value = currentInput + '"';
                    } else {
                        // For metric units, add with appropriate spacing
                        const needsSpace = currentInput && !currentInput.endsWith(' ') && !/[+\-×÷*/]$/.test(currentInput);
                        smartInput1.value = currentInput + (needsSpace ? ' ' : '') + value;
                    }
                    handleSmartInput(smartInput1, 'previewInput1', updateInput1Value);
                    break;
                    
                case 'measurement':
                    // Legacy - kept for compatibility
                    smartInput1.value = currentInput + value;
                    handleSmartInput(smartInput1, 'previewInput1', updateInput1Value);
                    break;
                    
                case 'fraction':
                    // Add fraction slash - no space needed for fractions like 3/32
                    smartInput1.value = currentInput + value;
                    handleSmartInput(smartInput1, 'previewInput1', updateInput1Value);
                    break;
                    
                case 'clear':
                    // Clear current input only (not full calculator reset)
                    smartInput1.value = '';
                    handleSmartInput(smartInput1, 'previewInput1', updateInput1Value);
                    break;
                    
                case 'operation':
                    // Insert operation symbol as text
                    smartInput1.value = currentInput + value;
                    handleSmartInput(smartInput1, 'previewInput1', updateInput1Value);
                    break;
                    
                case 'unit':
                    // Append unit to current input
                    smartInput1.value = currentInput + value;
                    handleSmartInput(smartInput1, 'previewInput1', updateInput1Value);
                    break;
                    
                case 'equals':
                    // Calculate the expression in the input
                    calculateExpression();
                    break;
                    
                default:
                    console.warn('Unknown keypad button type:', type);
            }
            
            // Focus the input to show cursor position
            smartInput1.focus();
        }
        
        function useResultAsInput1() {
            if (currentValueInches > 0) {
                const resultValue = currentValueInches;
                
                // FIRST: Complete reset of ALL systems to eliminate conflicts
                resetCalculatorState();
                
                // THEN: Set only Input 1 with the result value
                document.getElementById('smartInput1').value = inchesToDisplay(resultValue);
                handleSmartInput(document.getElementById('smartInput1'), 'previewInput1', updateInput1Value);
                
                // Visual feedback
                const smartInput1 = document.getElementById('smartInput1');
                smartInput1.style.boxShadow = '0 0 0 3px rgba(76, 175, 80, 0.3)';
                setTimeout(() => {
                    smartInput1.style.boxShadow = '';
                }, 1000);
                
                // Show notification
                showNotification('Result moved to Input 1 - ready for next operation!');
                
                // Update display after everything is set
                updateCalculation();
            }
        }
        
        function clearInput2() {
            // Clear feet/inches inputs
            document.getElementById('feet2').value = '';
            document.getElementById('inches2').value = '';
            document.getElementById('fraction2').value = '0';
            // Clear factor input
            document.getElementById('factor').value = '';
        }
        
        function memoryOperation(op) {
            const currentResult = value1 || 0;
            
            switch(op) {
                case 'MC': // Memory Clear
                    memoryValue = 0;
                    break;
                case 'MR': // Memory Recall
                    if (memoryValue !== 0) {
                        const parts = inchesToParts(memoryValue);
                        document.getElementById('feet1').value = parts.feet || '';
                        document.getElementById('inches1').value = parts.inches || '';
                        document.getElementById('fraction1').value = parts.fraction || 0;
                        updateCalculation();
                    }
                    break;
                case 'M+': // Memory Add
                    memoryValue += currentResult;
                    break;
                case 'M-': // Memory Subtract
                    memoryValue -= currentResult;
                    break;
            }
            
            // Update memory indicator
            updateMemoryIndicator();
        }
        
        function addToCalcHistory(entry) {
            const historyDiv = document.getElementById('history');
            if (!historyDiv) return;
            
            const historyItem = document.createElement('div');
            
            // Style based on type
            if (entry.type === 'conversion') {
                historyItem.className = 'history-conversion history-clickable';
                historyItem.innerHTML = `
                    <div class="history-label">Conversion</div>
                    <div class="history-equation">${entry.equation}</div>
                    <span class="history-timestamp">${entry.timestamp}</span>
                `;
            } else if (entry.type === 'preset') {
                historyItem.className = 'history-preset';
                historyItem.innerHTML = `
                    <div class="history-label">${entry.label || 'Calculation'}</div>
                    <div class="history-equation">${entry.equation}</div>
                    <span class="history-timestamp">${entry.timestamp}</span>
                `;
            } else {
                historyItem.className = 'history-result history-clickable';
                historyItem.innerHTML = `
                    <div class="history-equation">${entry.equation}</div>
                    <span class="history-timestamp">${entry.timestamp}</span>
                `;
            }
            
            // Make clickable if it has a result
            if (entry.result !== undefined) {
                historyItem.onclick = () => {
                    const parts = inchesToParts(entry.result);
                    document.getElementById('feet1').value = parts.feet || '';
                    document.getElementById('inches1').value = parts.inches || '';
                    document.getElementById('fraction1').value = parts.fraction || 0;
                    updateCalculation();
                };
            }
            
            historyDiv.insertBefore(historyItem, historyDiv.firstChild);
            
            // Keep only last 15 entries
            while (historyDiv.children.length > 15) {
                historyDiv.removeChild(historyDiv.lastChild);
            }
        }
        
        /* ----------------------------------------------------------------
           3.3 UTILITY & CONVERSION FUNCTIONS
           ---------------------------------------------------------------- */
        // Conversion functions - now work on the current calculator result
        function convertToDecimal() {
            const inches = getCurrentCalculatorValue();
            if (inches === 0) {
                showNotification('No value to convert. Enter a value or perform a calculation first.', 'warning');
                return;
            }
            const decimal = inches.toFixed(4);
            addToCalcHistory({
                equation: `${inchesToDisplay(inches)} → ${decimal}"`,
                result: inches,
                timestamp: new Date().toLocaleTimeString(),
                type: 'conversion'
            });
            showNotification(`Converted: ${inchesToDisplay(inches)} = ${decimal}"`);
        }
        
        
        function convertToFeet() {
            const inches = getCurrentCalculatorValue();
            if (inches === 0) {
                showNotification('No value to convert. Enter a value or perform a calculation first.', 'warning');
                return;
            }
            const feet = (inches / 12).toFixed(4);
            addToCalcHistory({
                equation: `${inchesToDisplay(inches)} → ${feet}'`,
                result: inches,
                timestamp: new Date().toLocaleTimeString(),
                type: 'conversion'
            });
            showNotification(`Converted: ${inchesToDisplay(inches)} = ${feet}'`);
        }
        
        function convertToMetric() {
            const inches = getCurrentCalculatorValue();
            if (inches === 0) {
                showNotification('No value to convert. Enter a value or perform a calculation first.', 'warning');
                return;
            }
            
            const mm = inches * 25.4;
            let metricDisplay, unit;
            
            if (mm >= 1000) {
                // Use meters for large values
                const meters = (mm / 1000).toFixed(3);
                metricDisplay = meters;
                unit = 'm';
            } else if (mm >= 10) {
                // Use centimeters for medium values
                const cm = (mm / 10).toFixed(2);
                metricDisplay = cm;
                unit = 'cm';
            } else {
                // Use millimeters for small values
                metricDisplay = mm.toFixed(2);
                unit = 'mm';
            }
            
            addToCalcHistory({
                equation: `${inchesToDisplay(inches)} → ${metricDisplay}${unit}`,
                result: inches,
                timestamp: new Date().toLocaleTimeString(),
                type: 'conversion'
            });
            showNotification(`Converted: ${inchesToDisplay(inches)} = ${metricDisplay}${unit}`);
        }
        
        // Toggle conversion section visibility
        function toggleConversions() {
            const conversionContent = document.getElementById('conversionContent');
            const conversionToggle = document.getElementById('conversionToggle');
            
            if (conversionContent && conversionToggle) {
                if (conversionContent.style.display === 'none') {
                    conversionContent.style.display = 'block';
                    conversionToggle.textContent = '▼';
                    conversionToggle.style.transform = 'rotate(0deg)';
                } else {
                    conversionContent.style.display = 'none';
                    conversionToggle.textContent = '▶';
                    conversionToggle.style.transform = 'rotate(-90deg)';
                }
            }
        }
        
        
        // =====================================================
        // Touch Event Support for Mobile
        // =====================================================
        
        /**
         * Add touch event support to calculator buttons
         * Prevents double-firing and improves mobile responsiveness
         */
        function initializeTouchEvents() {
            // Only initialize if touch is supported
            if (!('ontouchstart' in window)) {
                return;
            }
            
            // Get all calculator buttons
            const buttons = document.querySelectorAll('.calc-btn, .btn');
            
            buttons.forEach(button => {
                // Prevent default touch behavior
                button.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    // Add visual feedback
                    this.classList.add('active');
                }, { passive: false });
                
                button.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    // Remove visual feedback
                    this.classList.remove('active');
                    // Trigger the click event
                    this.click();
                }, { passive: false });
                
                // Prevent ghost clicks
                button.addEventListener('touchmove', function(e) {
                    e.preventDefault();
                    this.classList.remove('active');
                }, { passive: false });
            });
            
            // Add CSS for active state if not already present
            if (!document.querySelector('#touchStyles')) {
                const style = document.createElement('style');
                style.id = 'touchStyles';
                style.textContent = `
                    .calc-btn.active, .btn.active {
                        transform: scale(0.95);
                        opacity: 0.8;
                    }
                    
                    /* Improve touch targets on mobile */
                    @media (max-width: 768px) {
                        .calc-btn, .btn {
                            min-height: 44px;
                            min-width: 44px;
                            touch-action: manipulation;
                        }
                        
                        /* Prevent tap highlight on mobile */
                        .calc-btn, .btn {
                            -webkit-tap-highlight-color: transparent;
                        }
                        
                        /* Hardware acceleration for smoother animations */
                        .calc-btn, .btn, svg, .input-preview {
                            will-change: transform;
                            -webkit-transform: translateZ(0);
                            transform: translateZ(0);
                        }
                    }
                `;
                document.head.appendChild(style);
            }
        }
        
        // =====================================================
        // Smart Input Parser System
        // =====================================================
        
        /**
         * Parse metric input and convert to inches
         * @param {string} value - User input string
         * @returns {object|null} - {value: inches, display: formatted, isValid: boolean, error: string} or null if not metric
         */
        function parseMetricInput(value) {
            // Conversion factors
            const MM_TO_INCHES = 0.0393701;
            const CM_TO_INCHES = 0.393701;
            const M_TO_INCHES = 39.3701;
            
            // Pattern for metric values with units
            // Supports: 5.4mm, 12cm, 1.5m, 4m 9cm, 2m 15cm 3mm, etc.
            // Also supports spaces before units: 5 cm, 12 mm, 1.5 m
            const metricPattern = /(\d+(?:\.\d+)?)\s*(mm|cm|m)(?:\s+(\d+(?:\.\d+)?)\s*(mm|cm|m))?(?:\s+(\d+(?:\.\d+)?)\s*(mm|cm|m))?/gi;
            
            // Check if input contains metric units
            if (!/(mm|cm|m)/i.test(value)) {
                return null;
            }
            
            let totalInches = 0;
            let hasValidMetric = false;
            let lastIndex = 0;
            
            // Extract all metric values
            let match;
            while ((match = metricPattern.exec(value)) !== null) {
                hasValidMetric = true;
                
                // Process each matched group (up to 3 metric values)
                for (let i = 1; i < match.length; i += 2) {
                    if (match[i] && match[i + 1]) {
                        const num = parseFloat(match[i]);
                        const unit = match[i + 1].toLowerCase();
                        
                        switch (unit) {
                            case 'mm':
                                totalInches += num * MM_TO_INCHES;
                                break;
                            case 'cm':
                                totalInches += num * CM_TO_INCHES;
                                break;
                            case 'm':
                                totalInches += num * M_TO_INCHES;
                                break;
                        }
                    }
                }
                lastIndex = match.index + match[0].length;
            }
            
            // Check if there's any text after the metric values that wasn't matched
            if (hasValidMetric && lastIndex === value.length) {
                return {
                    value: totalInches,
                    display: inchesToDisplay(totalInches, 'calculator'),
                    isValid: true,
                    error: '',
                    isMetric: true
                };
            }
            
            return null;
        }
        
        /**
         * Universal smart input parser for feet/inches/fractions
         * @param {string} value - User input string
         * @returns {object} - {value: inches, display: formatted, isValid: boolean, error: string}
         */
        function parseSmartInput(value) {
            if (!value || typeof value !== 'string') {
                return { value: 0, display: '0"', isValid: true, error: '' };
            }
            
            value = value.trim();
            if (value === '') {
                return { value: 0, display: '0"', isValid: true, error: '' };
            }
            
            // Normalize extra spaces to single spaces
            value = value.replace(/\s+/g, ' ');
            
            // Handle leading decimal (e.g., ".75" -> "0.75")
            value = value.replace(/^\./, '0.');
            
            // Check for metric input first
            const metricResult = parseMetricInput(value);
            if (metricResult) {
                return metricResult;
            }
            
            // Common patterns for feet/inches input
            // Note: Added support for various quote characters used by mobile keyboards
            const feetChars = "['\x27\u2019\u2018\u201A\u201B\u2032′'']";
            const inchChars = '["\\x22\\u201C\\u201D\\u201E\\u201F\\u2033″""]';
            
            const patterns = [
                // Feet and inches with fractions: 4' 6 1/2" or 4 ft 6 1/2 in
                { regex: new RegExp(`^(\\d+)(?:\\s*${feetChars}|\\s*ft)\\s*(\\d+)(?:\\s*(\\d+)\\/(\\d+))?\\s*(?:${inchChars}|\\s*in)?$`, 'i'), type: 'feet_inches_frac' },
                // Feet only with fractions: 4' 1/2 or 4 1/2 ft  
                { regex: new RegExp(`^(\\d+)(?:\\s*(\\d+)\\/(\\d+))?\\s*${feetChars}$`, 'i'), type: 'feet_frac' },
                // Feet followed by fractional inches: 1' 1/16 or 4' 3/8
                { regex: new RegExp(`^(\\d+)\\s*${feetChars}\\s*(\\d+)\\/(\\d+)\\s*${inchChars}?$`, 'i'), type: 'feet_then_frac_inches' },
                // Feet with decimal inches: 4' 3.5" or 4 ft 3.5 in
                { regex: new RegExp(`^(\\d+)\\s*(?:${feetChars}|\\s*ft)\\s*(\\d+(?:\\.\\d+)?)\\s*(?:${inchChars}|\\s*in)?$`, 'i'), type: 'feet_decimal_inches' },
                // Decimal feet with integer inches: 4.5' 6" or 4.5 ft 6 in
                { regex: new RegExp(`^(\\d+(?:\\.\\d+)?)\\s*(?:${feetChars}|\\s*ft)\\s*(\\d+)\\s*(?:${inchChars}|\\s*in)?$`, 'i'), type: 'decimal_feet_inches' },
                // Decimal feet with decimal inches: 4.5' 3.5" or 4.5 ft 3.5 in
                { regex: new RegExp(`^(\\d+(?:\\.\\d+)?)\\s*(?:${feetChars}|\\s*ft)\\s*(\\d+(?:\\.\\d+)?)\\s*(?:${inchChars}|\\s*in)?$`, 'i'), type: 'decimal_feet_decimal_inches' },
                // Decimal feet with fractional inches: 4.5' 1/2" or 4.5 ft 3/8 in
                { regex: new RegExp(`^(\\d+(?:\\.\\d+)?)\\s*(?:${feetChars}|\\s*ft)\\s*(\\d+)\\/(\\d+)\\s*(?:${inchChars}|\\s*in)?$`, 'i'), type: 'decimal_feet_frac_inches' },
                // Just inches with fractions: 54 1/2" or 54.5"
                { regex: new RegExp(`^(\\d+)(?:\\.(\\d+)|(\\d+)\\/(\\d+))?\\s*${inchChars}?$`, 'i'), type: 'inches_frac' },
                // Pure fraction: 3/4 or 3/4"
                { regex: new RegExp(`^(\\d+)\\/(\\d+)\\s*${inchChars}?$`, 'i'), type: 'pure_fraction' },
                // Inches with space-separated fraction: 1 1/16 or 12 3/4
                { regex: new RegExp(`^(\\d+)\\s+(\\d+)\\/(\\d+)\\s*${inchChars}?$`, 'i'), type: 'inches_space_frac' },
                // Decimal feet: 4.5' or 4.5 ft
                { regex: new RegExp(`^(\\d+(?:\\.\\d+)?)\\s*(?:${feetChars}|ft)$`, 'i'), type: 'decimal_feet' },
                // Space separated with decimal: "4 3.5" (feet decimal-inches)
                { regex: /^(\d+)\s+(\d+(?:\.\d+)?)$/i, type: 'space_separated_decimal' },
                // Space separated: "4 6 1/2" (feet inches fraction)
                { regex: /^(\d+)\s+(\d+)(?:\s+(\d+)\/(\d+))?$/i, type: 'space_separated' },
                // Pure decimal
                { regex: /^(\d+(?:\.\d+)?)$/i, type: 'decimal' }
            ];
            
            for (const pattern of patterns) {
                const match = value.match(pattern.regex);
                if (match) {
                    try {
                        const result = parsePattern(match, pattern.type);
                        if (result.error) {
                            return result;
                        }
                        return {
                            value: result.inches,
                            display: inchesToDisplay(result.inches, 'calculator'),
                            isValid: true,
                            error: ''
                        };
                    } catch (error) {
                        return {
                            value: 0,
                            display: '0"',
                            isValid: false,
                            error: 'Invalid input format'
                        };
                    }
                }
            }
            
            return {
                value: 0,
                display: '0"',
                isValid: false,
                error: 'Unrecognized format. Try: 4\'6", 48", 4 6 1/2, .75", 25mm, 30cm, 1.5m'
            };
        }
        
        /**
         * Parse specific pattern matches into inches
         */
        function parsePattern(match, type) {
            let inches = 0;
            
            switch (type) {
                case 'feet_inches_frac':
                    const feet1 = parseInt(match[1]) || 0;
                    const inch1 = parseInt(match[2]) || 0;
                    const num1 = parseInt(match[3]) || 0;
                    const den1 = parseInt(match[4]) || 1;
                    
                    // Validate fraction
                    if (num1 >= den1 && num1 > 0) {
                        return { error: `Invalid fraction: ${num1}/${den1} (must be less than 1)` };
                    }
                    if (den1 > 32) {
                        return { error: `Invalid fraction: ${num1}/${den1} (max denominator is 32)` };
                    }
                    
                    inches = feet1 * 12 + inch1 + (num1 / den1);
                    break;
                    
                case 'feet_frac':
                    const feet2 = parseInt(match[1]) || 0;
                    const num2 = parseInt(match[2]) || 0;
                    const den2 = parseInt(match[3]) || 1;
                    
                    if (num2 >= den2 && num2 > 0) {
                        return { error: `Invalid fraction: ${num2}/${den2} (must be less than 1)` };
                    }
                    if (den2 > 32) {
                        return { error: `Invalid fraction: ${num2}/${den2} (max denominator is 32)` };
                    }
                    
                    inches = feet2 * 12 + (num2 / den2);
                    break;
                    
                case 'feet_then_frac_inches':
                    const feetPart = parseInt(match[1]) || 0;
                    const numInchFrac = parseInt(match[2]) || 0;
                    const denInchFrac = parseInt(match[3]) || 1;
                    
                    // Validate fraction
                    if (numInchFrac >= denInchFrac && numInchFrac > 0) {
                        return { error: `Invalid fraction: ${numInchFrac}/${denInchFrac} (must be less than 1)` };
                    }
                    if (denInchFrac > 32) {
                        return { error: `Invalid fraction: ${numInchFrac}/${denInchFrac} (max denominator is 32)` };
                    }
                    
                    inches = feetPart * 12 + (numInchFrac / denInchFrac);
                    break;
                    
                case 'inches_frac':
                    const inch3 = parseInt(match[1]) || 0;
                    if (match[2]) {
                        // Decimal inches
                        inches = inch3 + (parseInt(match[2]) / Math.pow(10, match[2].length));
                    } else if (match[3] && match[4]) {
                        // Fractional inches
                        const num3 = parseInt(match[3]);
                        const den3 = parseInt(match[4]);
                        
                        if (num3 >= den3) {
                            return { error: `Invalid fraction: ${num3}/${den3} (must be less than 1)` };
                        }
                        if (den3 > 32) {
                            return { error: `Invalid fraction: ${num3}/${den3} (max denominator is 32)` };
                        }
                        
                        inches = inch3 + (num3 / den3);
                    } else {
                        inches = inch3;
                    }
                    break;
                    
                case 'decimal_feet':
                    inches = parseFloat(match[1]) * 12;
                    break;
                    
                case 'feet_decimal_inches':
                    const feetDec = parseInt(match[1]) || 0;
                    const decimalInches = parseFloat(match[2]) || 0;
                    inches = feetDec * 12 + decimalInches;
                    break;
                    
                case 'decimal_feet_inches':
                    const decFeet1 = parseFloat(match[1]) || 0;
                    const intInches = parseInt(match[2]) || 0;
                    inches = decFeet1 * 12 + intInches;
                    break;
                    
                case 'decimal_feet_decimal_inches':
                    const decFeet2 = parseFloat(match[1]) || 0;
                    const decInches = parseFloat(match[2]) || 0;
                    inches = decFeet2 * 12 + decInches;
                    break;
                    
                case 'decimal_feet_frac_inches':
                    const decFeet3 = parseFloat(match[1]) || 0;
                    const fracNum = parseInt(match[2]) || 0;
                    const fracDen = parseInt(match[3]) || 1;
                    
                    if (fracNum >= fracDen && fracNum > 0) {
                        return { error: `Invalid fraction: ${fracNum}/${fracDen} (must be less than 1)` };
                    }
                    if (fracDen > 32) {
                        return { error: `Invalid fraction: ${fracNum}/${fracDen} (max denominator is 32)` };
                    }
                    
                    inches = decFeet3 * 12 + (fracNum / fracDen);
                    break;
                    
                case 'space_separated_decimal':
                    const feetSD = parseInt(match[1]) || 0;
                    const decInchSD = parseFloat(match[2]) || 0;
                    inches = feetSD * 12 + decInchSD;
                    break;
                    
                case 'space_separated':
                    const feet4 = parseInt(match[1]) || 0;
                    const inch4 = parseInt(match[2]) || 0;
                    let fracInches = 0;
                    
                    if (match[3] && match[4]) {
                        const num4 = parseInt(match[3]);
                        const den4 = parseInt(match[4]);
                        
                        if (num4 >= den4) {
                            return { error: `Invalid fraction: ${num4}/${den4} (must be less than 1)` };
                        }
                        if (den4 > 32) {
                            return { error: `Invalid fraction: ${num4}/${den4} (max denominator is 32)` };
                        }
                        
                        fracInches = num4 / den4;
                    }
                    
                    inches = feet4 * 12 + inch4 + fracInches;
                    break;
                    
                case 'pure_fraction':
                    const num = parseInt(match[1]);
                    const den = parseInt(match[2]);
                    
                    // Validate fraction
                    if (den === 0) {
                        return { error: 'Division by zero is not allowed' };
                    }
                    if (den > 32) {
                        return { error: `Invalid fraction: ${num}/${den} (max denominator is 32)` };
                    }
                    
                    inches = num / den;
                    break;
                    
                case 'inches_space_frac':
                    const wholeInches = parseInt(match[1]) || 0;
                    const numFrac = parseInt(match[2]) || 0;
                    const denFrac = parseInt(match[3]) || 1;
                    
                    // Validate fraction
                    if (numFrac >= denFrac && numFrac > 0) {
                        return { error: `Invalid fraction: ${numFrac}/${denFrac} (must be less than 1)` };
                    }
                    if (denFrac > 32) {
                        return { error: `Invalid fraction: ${numFrac}/${denFrac} (max denominator is 32)` };
                    }
                    
                    inches = wholeInches + (numFrac / denFrac);
                    break;
                    
                case 'decimal':
                    inches = parseFloat(match[1]);
                    break;
            }
            
            // Validate reasonable range
            if (inches < 0) {
                return { error: 'Measurement cannot be negative' };
            }
            if (inches > 9999) {
                return { error: 'Measurement too large (max 9999 inches)' };
            }
            
            return { inches: inches };
        }
        
        /**
         * Universal smart input handler with real-time feedback
         * @param {HTMLElement} inputElement - The input element
         * @param {string} previewId - ID of the preview div
         * @param {function} callback - Optional callback when valid input is parsed
         */
        function handleSmartInput(inputElement, previewId, callback) {
            const value = inputElement.value;
            const previewDiv = document.getElementById(previewId);
            
            if (!previewDiv) {
                console.warn(`Preview element ${previewId} not found`);
                return;
            }
            
            // Clear previous states
            inputElement.classList.remove('valid', 'invalid', 'warning');
            previewDiv.classList.remove('success', 'warning', 'error');
            
            if (!value || value.trim() === '') {
                // Empty input - hide preview
                previewDiv.style.display = 'none';
                if (callback) callback(0, '');
                return;
            }
            
            // Check if this is an expression with operators
            // Only +, -, ×, ÷ are operators (/ is for fractions)
            const hasOperators = /[+\-×÷]/.test(value);
            
            if (hasOperators) {
                // Parse and calculate the expression
                const result = parseExpression(value);
                
                // Show preview
                previewDiv.style.display = 'block';
                
                if (result.isValid) {
                    // Show the interpreted expression and result
                    let displayText = '= ' + formatResult(result.value);
                    let callbackDisplay = formatResult(result.value);
                    
                    // If we have a parsed expression, show it
                    if (result.parsedExpression) {
                        // Replace <factor> tags with styled spans for display
                        const styledExpression = result.parsedExpression.replace(
                            /<factor>(.*?)<\/factor>/g, 
                            '<span style="color: #9C27B0; font-weight: bold;">$1</span>'
                        );
                        displayText = styledExpression + ' = ' + formatResult(result.value);
                        
                        // For callback, keep the factor tags so they can be styled later
                        callbackDisplay = result.parsedExpression + ' = ' + formatResult(result.value);
                    }
                    
                    // Use innerHTML for styled display
                    previewDiv.innerHTML = displayText;
                    previewDiv.style.color = 'var(--success-color, #4CAF50)';
                    inputElement.classList.add('valid');
                    inputElement.classList.remove('invalid');
                    
                    // Call callback with the calculated value and display string
                    if (callback && typeof callback === 'function') {
                        callback(result.value, callbackDisplay);
                    }
                } else if (result.partial) {
                    // Partial expression - show what we have so far
                    previewDiv.textContent = result.message || 'Enter next value...';
                    previewDiv.style.color = 'var(--text-secondary, #666)';
                    inputElement.classList.remove('invalid');
                    
                    if (callback) callback(0, value);
                } else {
                    previewDiv.textContent = result.error || 'Invalid expression';
                    previewDiv.style.color = 'var(--error-color, #f44336)';
                    inputElement.classList.add('invalid');
                    
                    if (callback) callback(0, value);
                }
                return;
            }
            
            // Parse the input as a single measurement
            const result = parseSmartInput(value);
            
            // Show preview
            previewDiv.style.display = 'block';
            
            if (result.isValid) {
                // Valid input
                inputElement.classList.add('valid');
                previewDiv.classList.add('success');
                
                // Show metric conversion note if applicable
                if (result.isMetric) {
                    previewDiv.textContent = `= ${result.display} (from metric)`;
                } else {
                    previewDiv.textContent = `= ${result.display}`;
                }
                previewDiv.style.color = 'var(--success-color, #4CAF50)';
                
                // Call callback with parsed value if provided
                if (callback && typeof callback === 'function') {
                    callback(result.value, result.display);
                }
            } else {
                // Invalid input
                inputElement.classList.add('invalid');
                previewDiv.classList.add('error');
                previewDiv.textContent = result.error || 'Invalid input';
                previewDiv.style.color = 'var(--error-color, #f44336)';
                
                if (callback) callback(0, value);
            }
        }
        
        // New function to parse expressions with multiple operations
        function parseExpression(expression) {
            try {
                // Don't treat / as division - it's for fractions!
                // Only ÷ is for division
                // First, protect fractions by temporarily replacing them
                let expr = expression;
                
                // Split by operators (but NOT slash since that's for fractions)
                // Only split on +, -, ×, ÷
                const tokens = expr.split(/([+\-×÷])/);
                
                // Clean up tokens - remove empty strings but keep operators
                const cleanTokens = [];
                for (let token of tokens) {
                    const trimmed = token.trim();
                    if (trimmed) {
                        cleanTokens.push(trimmed);
                    }
                }
                
                // Handle cases where expression ends with operator (partial expression)
                const endsWithOperator = /[+\-×÷]\s*$/.test(expression);
                
                if (cleanTokens.length === 1) {
                    // Just a single value, parse it
                    const inches = parseMeasurementToInches(cleanTokens[0]);
                    if (inches === null || isNaN(inches)) {
                        return { isValid: false, error: `Cannot parse: "${cleanTokens[0]}"` };
                    }
                    
                    if (endsWithOperator) {
                        // Value followed by operator - waiting for next input
                        return { 
                            isValid: false, 
                            partial: true, 
                            message: formatResult(inches) + ' ' + expression.slice(-1).trim() + ' ...' 
                        };
                    }
                    
                    return {
                        isValid: true,
                        value: inches,
                        parsedExpression: formatResult(inches)
                    };
                }
                
                if (cleanTokens.length < 3) {
                    // Not enough tokens for a complete expression
                    if (cleanTokens.length === 2 && ['+', '-', '×', '÷'].includes(cleanTokens[1])) {
                        // Value followed by operator
                        const inches = parseMeasurementToInches(cleanTokens[0]);
                        if (inches !== null && !isNaN(inches)) {
                            return { 
                                isValid: false, 
                                partial: true, 
                                message: formatResult(inches) + ' ' + cleanTokens[1] + ' ...' 
                            };
                        }
                    }
                    return { isValid: false, partial: true, message: 'Enter values...' };
                }
                
                let result = null;
                let currentOp = null;
                let parsedParts = [];
                let needsParentheses = false;
                
                // Check if we need parentheses (mix of +/- with ×/÷)
                const hasAddSub = cleanTokens.some(t => t === '+' || t === '-');
                const hasMulDiv = cleanTokens.some(t => t === '×' || t === '÷');
                needsParentheses = hasAddSub && hasMulDiv;
                
                for (let i = 0; i < cleanTokens.length; i++) {
                    const token = cleanTokens[i];
                    
                    // Check if it's an operator (×  and ÷, not * and /)
                    if (['+', '-', '×', '÷'].includes(token)) {
                        // Add closing parenthesis if ending a multiplication/division group
                        if (needsParentheses && currentOp && (currentOp === '×' || currentOp === '÷') && 
                            (token === '+' || token === '-')) {
                            parsedParts.push(')');
                        }
                        
                        currentOp = token;
                        parsedParts.push(token);
                        
                        // Add opening parenthesis if starting a multiplication/division group
                        if (needsParentheses && (token === '×' || token === '÷')) {
                            // Look back to see if we need to wrap the previous value
                            if (parsedParts.length >= 2) {
                                const prevValue = parsedParts[parsedParts.length - 2];
                                parsedParts[parsedParts.length - 2] = '(' + prevValue;
                            }
                        }
                        continue;
                    }
                    
                    // Parse the measurement (including fractions like 8/9)
                    const inches = parseMeasurementToInches(token);
                    if (inches === null || isNaN(inches)) {
                        return { isValid: false, error: `Cannot parse: "${token}"` };
                    }
                    
                    // Add formatted version to parsed expression
                    // For multiplication and division, the second operand is a unitless factor
                    if (currentOp === '×' || currentOp === '÷') {
                        // Just show the number without units (factor)
                        let factorStr;
                        if (inches === Math.floor(inches)) {
                            factorStr = inches.toString();
                        } else {
                            // Show decimal or fraction without quotes
                            factorStr = convertToFraction(inches, '1/16');
                        }
                        // Wrap factor in special marker for styling
                        parsedParts.push(`<factor>${factorStr}</factor>`);
                        
                        // Check if we need closing parenthesis (this is the last token or next is +/-)
                        if (needsParentheses && (i === cleanTokens.length - 1 || 
                            (i + 1 < cleanTokens.length && (cleanTokens[i + 1] === '+' || cleanTokens[i + 1] === '-')))) {
                            parsedParts.push(')');
                        }
                    } else {
                        // For addition/subtraction or first value, show with units
                        parsedParts.push(formatResult(inches));
                    }
                    
                    // Apply the operation
                    if (result === null) {
                        result = inches;
                    } else if (currentOp) {
                        switch (currentOp) {
                            case '+':
                                result += inches;
                                break;
                            case '-':
                                result -= inches;
                                break;
                            case '×':
                                result *= inches;
                                break;
                            case '÷':
                                if (inches === 0) {
                                    return { isValid: false, error: 'Division by zero' };
                                }
                                result /= inches;
                                break;
                        }
                        currentOp = null;
                    }
                }
                
                // Check if we have a hanging operator
                if (currentOp) {
                    return { 
                        isValid: false, 
                        partial: true, 
                        message: parsedParts.join(' ') + ' ...' 
                    };
                }
                
                return {
                    isValid: true,
                    value: result,
                    parsedExpression: parsedParts.join(' ')
                };
                
            } catch (error) {
                console.error('Expression parsing error:', error);
                return { isValid: false, error: 'Invalid expression' };
            }
        }
        
        /**
         * Create a complete smart input setup for any calculator
         * @param {string} inputId - ID for the input element
         * @param {string} label - Label text for the input
         * @param {string} placeholder - Placeholder text
         * @param {function} callback - Callback when valid input is parsed
         * @returns {string} - HTML string for the complete input setup
         */
        function createSmartInputHTML(inputId, label, placeholder, callback) {
            const previewId = inputId + 'Preview';
            
            return `
                <div class="input-row">
                    <label>${label}:</label>
                    <input type="text" 
                           id="${inputId}" 
                           placeholder="${placeholder}" 
                           class="wide-input smart-input" 
                           oninput="handleSmartInput(this, '${previewId}', ${callback ? callback.name : 'null'})" 
                           onchange="handleSmartInput(this, '${previewId}', ${callback ? callback.name : 'null'})">
                </div>
                <div id="${previewId}" class="input-preview" style="display: none;"></div>
            `;
        }
        
        // Helper function to get the current calculator value (result, input, or direct input)
        function getCurrentCalculatorValue() {
            // Priority: 1) Calculator result, 2) Input 1 value
            if (currentValueInches > 0) {
                return currentValueInches;
            }
            
            if (currentInput1Inches > 0) {
                return currentInput1Inches;
            }
            
            // No value available
            return 0;
        }
        
        // Update the conversion preview to show what value will be converted
        function updateConversionPreview() {
            const conversionValueSpan = document.getElementById('conversionValue');
            if (!conversionValueSpan) return;
            
            // Priority: 1) Calculator result, 2) Input 1 value
            let inches = 0;
            let source = '';
            
            // Check if we have a calculator result
            if (currentValueInches > 0) {
                inches = currentValueInches;
                source = 'calculator result';
            } else if (currentInput1Inches > 0) {
                inches = currentInput1Inches;
                source = 'input 1';
            }
            
            if (inches > 0) {
                conversionValueSpan.textContent = `${inchesToDisplay(inches)} (from ${source})`;
                conversionValueSpan.parentElement.style.opacity = '1';
            } else {
                conversionValueSpan.textContent = 'Enter a value or calculate';
                conversionValueSpan.parentElement.style.opacity = '0.7';
            }
        }
        
        // Preset calculations with modal
        let currentModalCalc = null;
        
        function showBoardFootCalc() {
            currentModalCalc = 'boardfoot';
            const modal = document.getElementById('calcModal');
            const title = document.getElementById('calcModalTitle');
            const inputs = document.getElementById('calcModalInputs');
            
            title.textContent = 'Lumber Shopping Cart';
            inputs.innerHTML = `
                <div class="input-group">
                    <label>Thickness (inches):</label>
                    <input type="number" id="modalThickness" step="0.25" class="wide-input" placeholder="1">
                </div>
                <div class="input-group">
                    <label>Width (inches):</label>
                    <input type="number" id="modalWidth" step="0.25" class="wide-input" placeholder="6">
                </div>
                <div class="input-group">
                    <label>Length (feet):</label>
                    <input type="number" id="modalLength" step="0.5" class="wide-input" placeholder="8">
                </div>
            `;
            
            modal.style.display = 'block';
        }
        
        function calculateGoldenRatio() {
            const inches = value1 || 0;
            if (inches === 0) {
                showNotification('Enter a value first');
                return;
            }
            
            const golden = 1.618033988749895;
            const result = inches * golden;
            
            
            // Set result as new value1
            const parts = inchesToParts(result);
            document.getElementById('feet1').value = parts.feet || '';
            document.getElementById('inches1').value = parts.inches || '';
            document.getElementById('fraction1').value = parts.fraction || 0;
            updateCalculation();
        }
        
        function showSpacingCalc() {
            const totalLength = value1 || 0;
            if (totalLength === 0) {
                showNotification('Enter total length first');
                return;
            }
            
            currentModalCalc = 'spacing';
            const modal = document.getElementById('calcModal');
            const title = document.getElementById('calcModalTitle');
            const inputs = document.getElementById('calcModalInputs');
            
            title.textContent = 'Shelf & Division Calculator';
            inputs.innerHTML = `
                <div style="margin-bottom: 10px;">Total length: <strong>${inchesToDisplay(totalLength)}</strong></div>
                <div class="input-group">
                    <label>Number of spaces:</label>
                    <input type="number" id="modalSpaces" min="2" class="wide-input" placeholder="4">
                </div>
            `;
            
            modal.style.display = 'block';
        }
        
        function showAngleCalc() {
            currentModalCalc = 'angle';
            const modal = document.getElementById('calcModal');
            const title = document.getElementById('calcModalTitle');
            const inputs = document.getElementById('calcModalInputs');
            
            title.textContent = 'Miter & Angle Calculator';
            inputs.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <label style="font-weight: bold;">Calculator Type:</label>
                    <div style="margin-top: 10px;">
                        <label style="display: block; margin-bottom: 8px;">
                            <input type="radio" name="calcType" value="polygon" checked onchange="updateAngleCalcType()">
                            Polygon (equal-sided shape)
                        </label>
                        <label style="display: block;">
                            <input type="radio" name="calcType" value="single" onchange="updateAngleCalcType()">
                            Single angle cut
                        </label>
                    </div>
                </div>
                
                <div id="polygonInputs">
                    <div class="input-group">
                        <label>Number of sides:</label>
                        <input type="number" id="modalSides" min="3" class="wide-input" placeholder="8">
                    </div>
                    <p style="font-size: 12px; color: #666;">Examples: 4 = square, 6 = hexagon, 8 = octagon</p>
                </div>
                
                <div id="singleAngleInputs" style="display: none;">
                    <div class="input-group">
                        <label>Miter angle (degrees):</label>
                        <input type="number" id="modalAngle" step="0.5" class="wide-input" placeholder="45">
                    </div>
                    <div class="input-group">
                        <label>Board width:</label>
                        <input type="number" id="modalBoardWidth" step="0.0625" class="wide-input" placeholder="3.5">
                        <span>inches</span>
                    </div>
                    <div class="input-group">
                        <label>Known side:</label>
                        <select id="modalKnownSide" onchange="updateAngleLabels()">
                            <option value="long">Long side (back)</option>
                            <option value="short">Short side (front)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label id="knownLengthLabel">Long side length:</label>
                        <input type="number" id="modalKnownLength" step="0.0625" class="wide-input" placeholder="12">
                        <span>inches</span>
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                        <svg width="250" height="120" viewBox="0 0 250 120">
                            <!-- Board outline -->
                            <rect x="30" y="30" width="180" height="50" fill="#D2691E" stroke="var(--primary-color)" stroke-width="2"/>
                            <!-- Miter cut line -->
                            <line x1="150" y1="30" x2="210" y2="80" stroke="#FFD700" stroke-width="3"/>
                            <line x1="152" y1="30" x2="212" y2="80" stroke="#000" stroke-width="1" stroke-dasharray="3,3"/>
                            <!-- Dimension lines -->
                            <line x1="30" y1="20" x2="150" y2="20" stroke="#333" stroke-width="1"/>
                            <line x1="30" y1="20" x2="30" y2="25" stroke="#333" stroke-width="1"/>
                            <line x1="150" y1="20" x2="150" y2="25" stroke="#333" stroke-width="1"/>
                            <line x1="30" y1="90" x2="210" y2="90" stroke="#333" stroke-width="1"/>
                            <line x1="30" y1="85" x2="30" y2="90" stroke="#333" stroke-width="1"/>
                            <line x1="210" y1="85" x2="210" y2="90" stroke="#333" stroke-width="1"/>
                            <!-- Width indicator -->
                            <line x1="220" y1="30" x2="220" y2="80" stroke="#666" stroke-width="1"/>
                            <line x1="215" y1="30" x2="220" y2="30" stroke="#666" stroke-width="1"/>
                            <line x1="215" y1="80" x2="220" y2="80" stroke="#666" stroke-width="1"/>
                            <!-- Labels -->
                            <text x="90" y="15" text-anchor="middle" font-size="11" fill="#333">Short (front)</text>
                            <text x="120" y="105" text-anchor="middle" font-size="11" fill="#333">Long (back)</text>
                            <text x="180" y="60" text-anchor="middle" font-size="10" fill="#000">Cut</text>
                            <text x="235" y="58" text-anchor="middle" font-size="9" fill="#666">Width</text>
                        </svg>
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
        }
        
        function updateAngleCalcType() {
            const calcType = document.querySelector('input[name="calcType"]:checked').value;
            document.getElementById('polygonInputs').style.display = calcType === 'polygon' ? 'block' : 'none';
            document.getElementById('singleAngleInputs').style.display = calcType === 'single' ? 'block' : 'none';
        }
        
        function updateAngleLabels() {
            const knownSide = document.getElementById('modalKnownSide').value;
            const label = document.getElementById('knownLengthLabel');
            label.textContent = knownSide === 'long' ? 'Long side length:' : 'Short side length:';
        }
        
        function closeCalcModal() {
            document.getElementById('calcModal').style.display = 'none';
            currentModalCalc = null;
        }
        
        function executeModalCalc() {
            if (currentModalCalc === 'boardfoot') {
                const thickness = parseFloat(document.getElementById('modalThickness')?.value) || 0;
                const width = parseFloat(document.getElementById('modalWidth')?.value) || 0;
                const length = parseFloat(document.getElementById('modalLength')?.value) || 0;
                
                if (thickness && width && length) {
                    const boardFeet = (thickness * width * length) / 12;
                    closeCalcModal();
                } else {
                    showNotification('Please fill in all fields');
                }
            } else if (currentModalCalc === 'spacing') {
                const spaces = parseInt(document.getElementById('modalSpaces')?.value) || 0;
                if (spaces > 0) {
                    const spacing = value1 / spaces;
                    closeCalcModal();
                } else {
                    showNotification('Please enter number of spaces');
                }
            } else if (currentModalCalc === 'angle') {
                const calcType = document.querySelector('input[name="calcType"]:checked').value;
                
                if (calcType === 'polygon') {
                    const sides = parseInt(document.getElementById('modalSides')?.value) || 0;
                    if (sides > 2) {
                        const miterAngle = 180 / sides;
                        const sawAngle = 90 - miterAngle;
                        closeCalcModal();
                    } else {
                        showNotification('Please enter valid number of sides');
                    }
                } else {
                    // Single angle calculation
                    const angle = parseFloat(document.getElementById('modalAngle')?.value) || 0;
                    const boardWidth = parseFloat(document.getElementById('modalBoardWidth')?.value) || 0;
                    const knownSide = document.getElementById('modalKnownSide').value;
                    const knownLength = parseFloat(document.getElementById('modalKnownLength')?.value) || 0;
                    
                    if (angle > 0 && angle < 90 && boardWidth > 0 && knownLength > 0) {
                        const angleRad = (angle * Math.PI) / 180;
                        let longSide, shortSide;
                        
                        // For a miter cut across a board:
                        // The difference between long and short sides = board width / tan(angle)
                        const difference = boardWidth / Math.tan(angleRad);
                        
                        if (knownSide === 'long') {
                            longSide = knownLength;
                            shortSide = longSide - difference;
                            
                            if (shortSide <= 0) {
                                showNotification('This cut would result in no material on the short side');
                                return;
                            }
                        } else {
                            shortSide = knownLength;
                            longSide = shortSide + difference;
                        }
                        
                        
                        // Set the calculated value as new input
                        const parts = inchesToParts(knownSide === 'long' ? shortSide : longSide);
                        document.getElementById('feet1').value = parts.feet || '';
                        document.getElementById('inches1').value = parts.inches || '';
                        document.getElementById('fraction1').value = parts.fraction || 0;
                        updateCalculation();
                        
                        closeCalcModal();
                    } else {
                        showNotification('Please enter valid angle (0-90°), board width, and length');
                    }
                }
            }
        }
        
        function updateCutValue() {
            // Use smart input value if available, otherwise fall back to legacy inputs
            if (currentCutLengthInches > 0) {
                cutValueInches = currentCutLengthInches;
            } else {
                cutValueInches = getInputInches('cutFeet', 'cutInches', 'cutFraction');
            }
            // cutCurrentValue element was removed in UI redesign
            
            // Auto-recalculate if there's an active division
            autoRecalculateDivision();
        }
        
        function performDivision() {
            const pieces = parseInt(document.getElementById('divisionSelect').value);
            if (pieces && cutValueInches > 0) {
                lastDivisionType = 'quick';
                lastDivisionValue = pieces;
                quickCut(pieces);
                // Don't reset dropdown anymore to keep selection
            } else if (pieces && cutValueInches <= 0) {
                showNotification('Please enter a board length first');
            }
        }
        
        function performCustomDivision() {
            const pieces = parseInt(document.getElementById('customPieces').value);
            if (pieces && pieces >= 2 && pieces <= 20 && cutValueInches > 0) {
                lastDivisionType = 'custom';
                lastDivisionValue = pieces;
                quickCut(pieces);
                // Clear quick division dropdown when using custom
                document.getElementById('divisionSelect').value = '';
            } else if (pieces && cutValueInches <= 0) {
                showNotification('Please enter a board length first');
            } else if (pieces && (pieces < 2 || pieces > 20)) {
                showNotification('Please enter a number between 2 and 20');
            }
        }
        
        function toggleInputMode() {
            inputMode = inputMode === 'fraction' ? 'decimal' : 'fraction';
            const fractionInputs = document.getElementById('fractionInputs');
            const decimalInputs = document.getElementById('decimalInputs');
            const toggleBtn = document.getElementById('modeToggle');
            
            if (inputMode === 'fraction') {
                fractionInputs.style.display = 'flex';
                decimalInputs.style.display = 'none';
                toggleBtn.textContent = 'Decimal Mode';
            } else {
                fractionInputs.style.display = 'none';
                decimalInputs.style.display = 'flex';
                toggleBtn.textContent = 'Fraction Mode';
            }
        }
        
        function getOperationValue() {
            if (inputMode === 'fraction') {
                return getInputInches('opFeet', 'opInches', 'opFraction');
            } else {
                return parseFloat(document.getElementById('operationValue')?.value) || 0;
            }
        }
        
        function quickCut(pieces) {
            if (cutValueInches <= 0) {
                showNotification('Please set a measurement first');
                return;
            }
            
            const kerfValue = parseFloat(document.getElementById('cutKerf')?.value || 0);
            const kerf = kerfValue;
            const cutSide = document.getElementById('cutSide')?.value || 'left';
            const totalKerf = kerf * (pieces - 1);
            const pieceLength = (cutValueInches - totalKerf) / pieces;
            
            let results = [];
            let currentPos = 0;
            
            for (let i = 0; i < pieces - 1; i++) {
                // Calculate where each piece ends without kerf
                currentPos += pieceLength;
                
                // Adjust mark position based on cut side and accumulated kerf
                let markPosition = currentPos;
                if (kerf > 0) {
                    if (cutSide === 'left') {
                        // For left side cuts, add accumulated kerf
                        markPosition += (i + 1) * kerf;
                    } else {
                        // For right side cuts, add accumulated kerf from previous cuts
                        markPosition += i * kerf;
                    }
                }
                
                results.push({
                    position: markPosition,
                    display: inchesToDisplay(markPosition, 'cut')
                });
            }
            
            // Create visual results
            const cutResults = document.createElement('div');
            cutResults.className = 'cut-results';
            
            const kerfNote = kerf > 0 ? ` (${inchesToDisplay(kerf, 'cut')} kerf)` : ' (no kerf)';
            const cutSideNote = kerf > 0 ? `, ${cutSide} side` : '';
            
            // Store cut result data globally for saving
            const cutResultData = {
                originalLength: inchesToDisplay(cutValueInches, 'cut'),
                pieces: pieces,
                pieceLength: inchesToDisplay(pieceLength, 'cut'),
                results: results,
                kerfNote: kerfNote,
                cutSideNote: cutSideNote
            };
            currentCutResults.unshift(cutResultData);
            
            // Keep only last 5 results
            if (currentCutResults.length > 5) {
                currentCutResults = currentCutResults.slice(0, 5);
            }
            
            // Generate visual board diagram
            const visualBoard = generateVisualBoard(cutValueInches, results, pieces, pieceLength);
            
            // Generate marking guide similar to Shelf & Division Calculator
            const markingGuide = generateMarkingGuide(results, pieces, pieceLength, cutValueInches);
            
            cutResults.innerHTML = `
                <h4>Cut ${inchesToDisplay(cutValueInches, 'cut')} into ${pieces} equal pieces${kerfNote}${cutSideNote}</h4>
                ${visualBoard}
                ${markingGuide}
                <div class="piece-info">
                    Each piece: ${inchesToDisplay(pieceLength, 'cut')}
                </div>
                <div class="cut-result-actions">
                    <button class="btn btn-success btn-sm" onclick="saveCutToProject(0)">Save to Project</button>
                </div>
            `;
            
            // Add to history
            const historyDiv = document.getElementById('cutHistory');
            if (historyDiv) {
                historyDiv.insertBefore(cutResults, historyDiv.firstChild);
                
                // Keep only last 5 results
                while (historyDiv.children.length > 5) {
                    historyDiv.removeChild(historyDiv.lastChild);
                }
            }
        }
        
        function generateVisualBoard(totalLength, cutMarks, pieces, pieceLength) {
            const kerfValue = parseFloat(document.getElementById('cutKerf')?.value || 0);
            const kerf = kerfValue;
            const cutSide = document.getElementById('cutSide')?.value || 'left';
            
            // Generate cut marks and kerf cutouts positioned proportionally
            const cutElements = [];
            
            cutMarks.forEach((mark, i) => {
                const markPercent = (mark.position / totalLength) * 100;
                
                // Add the cut mark line
                cutElements.push(`<div class="cut-mark" style="left: ${markPercent}%" data-mark="Mark ${i + 1}: ${mark.display}"></div>`);
                
                // Add kerf cutout if enabled
                if (kerf > 0) {
                    const kerfWidthPercent = (kerf / totalLength) * 100;
                    let kerfLeft;
                    
                    if (cutSide === 'left') {
                        // Kerf is to the left of the mark
                        kerfLeft = markPercent - kerfWidthPercent;
                    } else {
                        // Kerf is to the right of the mark
                        kerfLeft = markPercent;
                    }
                    
                    cutElements.push(`
                        <div class="kerf-cutout ${cutSide}-side" 
                             style="left: ${kerfLeft}%; width: ${kerfWidthPercent}%">
                        </div>
                    `);
                }
            });
            
            // Generate piece labels
            const pieceLabels = [];
            let currentPosition = 0;
            
            for (let i = 0; i < pieces; i++) {
                // Calculate piece start and end positions
                const pieceStart = currentPosition;
                const pieceEnd = pieceStart + pieceLength;
                const pieceCenter = ((pieceStart + pieceEnd) / totalLength) * 100;
                
                pieceLabels.push(`
                    <div class="piece-label" style="left: ${pieceCenter}%; transform: translateX(-50%);">
                        ${i + 1}<br>
                        <small>${inchesToDisplay(pieceLength, 'cut')}</small>
                    </div>
                `);
                
                // Move to next piece position (accounting for kerf)
                currentPosition = pieceEnd + kerf;
            }
            
            return `
                <div class="visual-board">
                    <div class="board-container">
                        <div class="board-ends left"></div>
                        <div class="board-ends right"></div>
                        ${cutElements.join('')}
                    </div>
                    <div class="board-dimension">Total Length: ${inchesToDisplay(totalLength, 'cut')}</div>
                    <div class="piece-labels">
                        ${pieceLabels.join('')}
                    </div>
                </div>
            `;
        }
        
        function generateMarkingGuide(cutMarks, pieces, pieceLength, totalLength) {
            if (!cutMarks || cutMarks.length === 0) {
                return '';
            }
            
            return `
                <div class="marking-guide">
                    <div class="marks-header">📍 Cut Mark Positions:</div>
                    <div class="marks-grid">
                        ${cutMarks.map((mark, i) => `
                            <div class="mark-item">
                                <span class="mark-number">Mark ${i + 1}:</span>
                                <span class="mark-value">${mark.display}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="marking-summary">
                        <div class="summary-item">
                            <strong>Total Length:</strong> ${inchesToDisplay(totalLength, 'cut')}
                        </div>
                        <div class="summary-item">
                            <strong>Pieces:</strong> ${pieces} × ${inchesToDisplay(pieceLength, 'cut')} each
                        </div>
                    </div>
                </div>
            `;
        }
        
        function customCut() {
            // This function is now handled by performCustomDivision()
            performCustomDivision();
        }
        
        function toggleKerfDisplay() {
            // Function no longer needed as kerf dropdown always visible
            updateKerfDiagram();
        }
        
        function updateKerfDiagram() {
            const kerfValue = parseFloat(document.getElementById('cutKerf')?.value || 0);
            const kerfEnabled = kerfValue > 0;
            const cutSide = document.getElementById('cutSide')?.value || 'right';
            const diagram = document.getElementById('kerfDiagram');
            const kerfArea = document.getElementById('kerfAreaSvg');
            const kerfLabel = document.getElementById('kerfLabelSvg');
            const kerfWidth = kerfValue;
            const cutSideRow = document.getElementById('cutSideRow');
            
            // Show/hide cut side dropdown based on kerf selection
            if (cutSideRow) {
                cutSideRow.style.display = kerfEnabled ? 'block' : 'none';
            }
            
            // Auto-recalculate if there's an active division
            autoRecalculateDivision();
            
            if (diagram) {
                diagram.style.display = kerfEnabled ? 'flex' : 'none';
                if (kerfArea && kerfLabel && kerfEnabled) {
                    // Exaggerate kerf width for visibility (multiply by 8 for visual clarity)
                    const svgKerfWidth = (kerfWidth / 12) * 300 * 8; // Convert inches to relative width, then exaggerate
                    
                    if (cutSide === 'left') {
                        kerfArea.setAttribute('x', 200 - svgKerfWidth);
                        kerfArea.setAttribute('width', svgKerfWidth);
                        kerfLabel.setAttribute('x', 200 - svgKerfWidth/2);
                    } else {
                        kerfArea.setAttribute('x', 200);
                        kerfArea.setAttribute('width', svgKerfWidth);
                        kerfLabel.setAttribute('x', 200 + svgKerfWidth/2);
                    }
                    kerfLabel.style.display = svgKerfWidth > 20 ? 'block' : 'none';
                }
            }
        }
        
        function operation(op) {
            // Clear previous operation highlighting
            document.querySelectorAll('.btn-operation').forEach(btn => btn.classList.remove('active'));
            
            currentOperation = op;
            
            // Highlight the selected operation
            event.target.classList.add('active');
            
            if (inputMode === 'decimal') {
                document.getElementById('operationValue')?.focus();
            }
        }
        
        function executeOperation() {
            if (currentValueInches <= 0) {
                showNotification('Please set a measurement first');
                return;
            }
            
            if (!currentOperation) {
                showNotification('Please select an operation first');
                return;
            }
            
            const value = getOperationValue();
            if (value <= 0 && currentOperation === '/') {
                showNotification('Cannot divide by zero or negative number');
                return;
            }
            
            const oldValue = currentValueInches;
            let newValue;
            
            switch (currentOperation) {
                case '+':
                    newValue = currentValueInches + value;
                    break;
                case '-':
                    newValue = currentValueInches - value;
                    break;
                case '*':
                    newValue = currentValueInches * value;
                    break;
                case '/':
                    newValue = currentValueInches / value;
                    break;
            }
            
            currentValueInches = newValue;
            document.getElementById('currentValue').textContent = inchesToDisplay(currentValueInches);
            
            const valueDisplay = inputMode === 'fraction' ? inchesToDisplay(value) : value + '"';
            addHistory(`${inchesToDisplay(oldValue)} ${currentOperation} ${valueDisplay} = ${inchesToDisplay(newValue)}`);
            
            // Clear operation selection and highlighting
            currentOperation = null;
            document.querySelectorAll('.btn-operation').forEach(btn => btn.classList.remove('active'));
            clearOperationInputs();
        }
        
        function clearOperationInputs() {
            if (document.getElementById('opFeet')) document.getElementById('opFeet').value = '';
            if (document.getElementById('opInches')) document.getElementById('opInches').value = '';
            if (document.getElementById('opFraction')) document.getElementById('opFraction').value = '0';
            if (document.getElementById('operationValue')) document.getElementById('operationValue').value = '';
        }
        
        function addHistory(item) {
            history.unshift(item);
            if (history.length > 20) history.pop();
            
            const historyDiv = document.getElementById('history');
            if (historyDiv) {
                historyDiv.innerHTML = history.map(h => `<div class="history-item">${h}</div>`).join('');
            }
        }
        
        function addCutHistory(item) {
            cutHistory.unshift(item);
            if (cutHistory.length > 20) cutHistory.pop();
            
            const historyDiv = document.getElementById('cutHistory');
            if (historyDiv) {
                historyDiv.innerHTML = cutHistory.map(h => `<div class="history-item">${h}</div>`).join('');
            }
        }
        
        function updateHistory() {
            const historyDiv = document.getElementById('history');
            if (historyDiv) {
                // Filter out any non-string items and convert objects to strings
                const validHistory = history.filter(h => h && typeof h === 'string');
                historyDiv.innerHTML = validHistory.map(h => `<div class="history-item">${h}</div>`).join('');
            }
        }
        
        function updateCutHistory() {
            const historyDiv = document.getElementById('cutHistory');
            if (historyDiv) {
                // Filter out any non-string items and convert objects to strings
                const validHistory = cutHistory.filter(h => h && typeof h === 'string');
                historyDiv.innerHTML = validHistory.map(h => `<div class="history-item">${h}</div>`).join('');
            }
        }
        
        function updateMemoryIndicator() {
            const indicator = document.getElementById('memoryIndicator');
            if (indicator) {
                if (memoryValue !== 0) {
                    indicator.textContent = `M: ${inchesToDisplay(memoryValue)}`;
                } else {
                    indicator.textContent = '';
                }
            }
        }
        
        function clearAll() {
            currentValueInches = 0;
            currentOperation = null;
            if (document.getElementById('currentValue')) document.getElementById('currentValue').textContent = 'Enter measurement above';
            if (document.getElementById('feet')) document.getElementById('feet').value = '';
            if (document.getElementById('inches')) document.getElementById('inches').value = '';
            if (document.getElementById('fraction')) document.getElementById('fraction').value = '0';
            clearOperationInputs();
        }
        
        function autoRecalculateDivision() {
            // Only recalculate if we have a board length and a previous division
            if (cutValueInches > 0 && lastDivisionValue) {
                quickCut(lastDivisionValue);
            }
        }
        
        function clearCut() {
            cutValueInches = 0;
            currentCutLengthInches = 0;
            lastDivisionType = null;
            lastDivisionValue = null;
            if (document.getElementById('smartCutLength')) document.getElementById('smartCutLength').value = '';
            if (document.getElementById('previewCutLength')) document.getElementById('previewCutLength').innerHTML = '';
            if (document.getElementById('cutFeet')) document.getElementById('cutFeet').value = '';
            if (document.getElementById('cutInches')) document.getElementById('cutInches').value = '';
            if (document.getElementById('cutFraction')) document.getElementById('cutFraction').value = '0';
            if (document.getElementById('cutHistory')) document.getElementById('cutHistory').innerHTML = '';
            if (document.getElementById('divisionSelect')) document.getElementById('divisionSelect').value = '';
            if (document.getElementById('customPieces')) document.getElementById('customPieces').value = '';
        }
        
        function clearOptimization() {
            // Clear boards and cuts arrays
            boards = [];
            cuts = [];
            
            // Clear input fields
            if (document.getElementById('smartBoardLength')) document.getElementById('smartBoardLength').value = '';
            if (document.getElementById('previewBoardLength')) document.getElementById('previewBoardLength').innerHTML = '';
            if (document.getElementById('boardQuantity')) document.getElementById('boardQuantity').value = '1';
            
            if (document.getElementById('smartOptCutLength')) document.getElementById('smartOptCutLength').value = '';
            if (document.getElementById('previewOptCutLength')) document.getElementById('previewOptCutLength').innerHTML = '';
            if (document.getElementById('cutQuantity')) document.getElementById('cutQuantity').value = '1';
            
            // Clear lists
            if (document.getElementById('boardsList')) document.getElementById('boardsList').innerHTML = '';
            if (document.getElementById('cutsList')) document.getElementById('cutsList').innerHTML = '';
            
            // Clear results
            if (document.getElementById('optimizationResults')) document.getElementById('optimizationResults').innerHTML = '';
            if (document.getElementById('boardVisualization')) document.getElementById('boardVisualization').innerHTML = '';
            if (document.getElementById('visualLayout')) document.getElementById('visualLayout').style.display = 'none';
            
            // Clear global optimization results
            window.currentOptimizationResults = null;
            window.currentKerfEnabled = null;
        }
        
        function autoRecalculateOptimization() {
            // Only recalculate if we have boards and cuts
            if (boards.length > 0 && cuts.length > 0) {
                optimizeCuts();
            }
        }
        
        function switchTab(tab, evt) {
            // Get current active tab for cleanup
            const currentActiveTab = document.querySelector('.tab-content.active');
            const oldTab = currentActiveTab ? currentActiveTab.id : null;
            
            // Clean up event listeners from the old tab
            if (oldTab && oldTab !== tab) {
                cleanupTabEventListeners(oldTab, tab);
            }
            
            // Remove active class from all tabs and buttons
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            if (tabBtns) {
                tabBtns.forEach(btn => {
                    if (btn && btn.classList) btn.classList.remove('active');
                });
            }
            
            if (tabContents) {
                tabContents.forEach(content => {
                    if (content && content.classList) content.classList.remove('active');
                });
            }
            
            // Handle button highlighting - safely check for event
            try {
                if (evt && evt.target && evt.target.classList) {
                    evt.target.classList.add('active');
                } else if (typeof event !== 'undefined' && event && event.target && event.target.classList) {
                    event.target.classList.add('active');
                } else {
                    // Find the button that corresponds to this tab
                    tabBtns.forEach(btn => {
                        if (btn && btn.onclick && btn.onclick.toString().includes(`'${tab}'`)) {
                            if (btn.classList) btn.classList.add('active');
                        }
                    });
                }
            } catch (e) {
                // If event access fails, just find the button
                tabBtns.forEach(btn => {
                    if (btn && btn.onclick && btn.onclick.toString().includes(`'${tab}'`)) {
                        if (btn.classList) btn.classList.add('active');
                    }
                });
            }
            
            // Show the selected tab
            const targetTab = document.getElementById(tab);
            if (targetTab && targetTab.classList) {
                targetTab.classList.add('active');
            }
            
            
            // Hide/show global project selector based on tab and mode
            const globalSelector = document.getElementById('globalProjectSelector');
            if (globalSelector) {
                const modeConfig = uiConfig.modes[uiConfig.mode];
                if (tab === 'projects') {
                    // Always hide in projects tab to avoid redundancy
                    globalSelector.style.display = 'none';
                } else if (modeConfig.saveToProject) {
                    // Only show in other tabs if we're in project mode
                    globalSelector.style.display = 'block';
                } else {
                    // Hide in non-project modes
                    globalSelector.style.display = 'none';
                }
            }
            
            // When switching to projects tab, update the dashboard
            if (tab === 'projects') {
                updateProjectsDashboard();
            }
            
            // Ensure category headers are properly hidden/shown
            ensureCategoryVisibility();
        }
        
        // Set the real implementation
        window.switchTabReal = switchTab;
        
        function switchCutMode(mode) {
            // Update mode buttons
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            
            if (mode === 'equal') {
                document.getElementById('equalDivisionMode').classList.add('active');
                document.getElementById('equalDivisionContent').style.display = 'block';
                document.getElementById('cutOptimizationContent').style.display = 'none';
            } else if (mode === 'optimization') {
                document.getElementById('cutOptimizationMode').classList.add('active');
                document.getElementById('equalDivisionContent').style.display = 'none';
                document.getElementById('cutOptimizationContent').style.display = 'block';
                
                // Synchronize precision settings
                const cutPrecision = document.getElementById('cutPrecision')?.value;
                const optPrecision = document.getElementById('optPrecision');
                if (cutPrecision && optPrecision) {
                    optPrecision.value = cutPrecision;
                }
                
                // Synchronize kerf settings between modes
                
                const cutKerf = document.getElementById('cutKerf')?.value;
                const optKerf = document.getElementById('optKerf');
                if (cutKerf && optKerf) {
                    optKerf.value = cutKerf;
                }
                
                // Update precision after synchronization
                updatePrecision('cut');
            }
        }
        
        // Dad Jokes Feature
        async function fetchDadJoke() {
            console.log('fetchDadJoke called');
            const modal = document.getElementById('jokeModal');
            const jokeText = document.getElementById('jokeText');
            const loadingText = document.getElementById('jokeLoading');
            
            console.log('Dad joke modal element:', modal);
            
            // Show modal with loading state
            if (modal) {
                // Move modal to body to ensure it's not constrained by parent
                document.body.appendChild(modal);
                
                // Apply the same styles that worked for the test modal
                modal.style.cssText = `
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    width: 100vw !important;
                    height: 100vh !important;
                    background-color: rgba(0,0,0,0.5) !important;
                    z-index: 99999 !important;
                    display: block !important;
                    visibility: visible !important;
                `;
                
                // Also fix the modal content
                const modalContent = modal.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.style.cssText = `
                        background-color: white !important;
                        margin: 5% auto !important;
                        padding: 20px !important;
                        border-radius: 15px !important;
                        width: 90% !important;
                        max-width: 600px !important;
                        max-height: 80vh !important;
                        overflow-y: auto !important;
                        display: block !important;
                        position: relative !important;
                    `;
                }
                
                if (jokeText) jokeText.style.display = 'none';
                if (loadingText) loadingText.style.display = 'block';
            }
            
            try {
                const response = await fetch('https://icanhazdadjoke.com/', {
                    headers: { 'Accept': 'application/json' }
                });
                
                if (!response.ok) throw new Error('Dad joke service unavailable');
                
                const data = await response.json();
                
                // Show the joke
                if (modal) {
                    loadingText.style.display = 'none';
                    jokeText.style.display = 'flex';
                    jokeText.textContent = data.joke;
                }
                
            } catch (error) {
                console.error('Dad joke fetch failed:', error);
                if (modal) {
                    loadingText.style.display = 'none';
                    jokeText.style.display = 'flex';
                    jokeText.textContent = "Dad joke service is taking a break! Here's a backup: Why don't scientists trust atoms? Because they make up everything! 😅";
                }
            }
        }
        
        function closeJoke() {
            const modal = document.getElementById('jokeModal');
            if (modal) modal.style.display = 'none';
        }

        // Help content organized by context
        const helpContent = {
            tabs: {
                calculator: {
                    title: 'Calculator Help',
                    sections: [
                        {
                            icon: '📱',
                            title: 'UI Modes',
                            content: `
                                <p style="margin: 0 0 10px 0;"><strong>Current Mode: Basic</strong></p>
                                <ul>
                                    <li><strong>Basic:</strong> Single calculator only (current view)</li>
                                    <li><strong>Standard:</strong> Adds Specialty Calculators tab with 10+ tools</li>
                                    <li><strong>Project:</strong> Adds Projects tab for saving calculations</li>
                                </ul>
                                <p style="margin-top: 10px; font-size: 12px;">Switch modes using the dropdown in the header (top right)</p>
                            `
                        },
                        {
                            icon: '🧮',
                            title: 'Calculator Operations',
                            content: `
                                <ul>
                                    <li><strong>Operations:</strong> + (add), - (subtract), × (multiply), ÷ (divide)</li>
                                    <li><strong>Memory:</strong> MC (clear), MR (recall), M+ (add), M- (subtract)</li>
                                    <li><strong>Precision:</strong> Set rounding from 1/32" to 1" to match your tools</li>
                                </ul>
                            `
                        },
                        {
                            icon: '📏',
                            title: 'Input Examples',
                            content: `
                                <ul>
                                    <li><strong>Feet & inches:</strong> 4'6", 4' 6", 4 ft 6 in</li>
                                    <li><strong>Inches only:</strong> 54", 54.5", 54 1/2"</li>
                                    <li><strong>Smart parsing:</strong> 4 6 1/2, 1 2 3/8</li>
                                    <li><strong>Fractions:</strong> 3/4", 1/16", 5/32"</li>
                                    <li><strong>Decimals:</strong> .75", 0.75", 4.5'</li>
                                    <li><strong>Metric:</strong> 25mm, 30cm, 1.5m, 2m 15cm</li>
                                </ul>
                            `
                        }
                    ]
                },
                specialty: {
                    title: 'Specialty Calculators Help',
                    sections: [
                        {
                            icon: '🔍',
                            title: 'Finding Calculators',
                            content: `
                                <ul>
                                    <li><strong>Search:</strong> Type keywords to filter calculators</li>
                                    <li><strong>Categories:</strong> Click category headers to expand/collapse</li>
                                    <li><strong>Recent:</strong> Your most-used calculators appear at the top</li>
                                    <li><strong>Expand All:</strong> Show all calculators at once</li>
                                </ul>
                            `
                        },
                        {
                            icon: '📱',
                            title: 'UI Modes',
                            content: `
                                <ul>
                                    <li><strong>Basic:</strong> Single calculator only</li>
                                    <li><strong>Standard:</strong> Calculator + Specialty tabs (current view)</li>
                                    <li><strong>Project:</strong> All tabs including Projects</li>
                                </ul>
                                <p style="margin-top: 8px; font-size: 12px;">Change modes with the dropdown in the header (top right)</p>
                            `
                        }
                    ]
                },
                projects: {
                    title: 'Projects Help',
                    sections: [
                        {
                            icon: '📁',
                            title: 'Project Basics',
                            content: `
                                <ul>
                                    <li><strong>Active Project:</strong> Select from dropdown to auto-save calculations</li>
                                    <li><strong>New Project:</strong> Click "+ New" to create</li>
                                    <li><strong>Save to Project:</strong> Available in every calculator</li>
                                    <li><strong>Timeline:</strong> View all saved calculations chronologically</li>
                                </ul>
                            `
                        },
                        {
                            icon: '📤',
                            title: 'Import/Export',
                            content: `
                                <ul>
                                    <li><strong>Export:</strong> Download projects as JSON files</li>
                                    <li><strong>Import:</strong> Load previously exported projects</li>
                                    <li><strong>Backup:</strong> Regular exports protect your data</li>
                                </ul>
                            `
                        }
                    ]
                }
            },
            calculators: {
                lumberCart: {
                    title: 'Lumber Shopping Cart',
                    icon: '🛒',
                    description: 'Calculate lumber costs and board feet by species',
                    sections: [
                        {
                            title: 'How to Use',
                            content: `
                                <ol>
                                    <li>Select wood species from dropdown</li>
                                    <li>Enter dimensions (thickness × width × length)</li>
                                    <li>Set quantity and price per board foot</li>
                                    <li>Click "Add to Cart" to build your list</li>
                                </ol>
                            `
                        },
                        {
                            title: 'Tips',
                            content: `
                                <ul>
                                    <li>Prices save per species for quick estimates</li>
                                    <li>Board feet = (T × W × L) ÷ 144 (inches) or ÷ 12 (feet)</li>
                                    <li>Export cart summary for lumber yard visits</li>
                                </ul>
                            `
                        }
                    ]
                },
                goldenRatio: {
                    title: 'Golden Ratio Calculator',
                    icon: '✨',
                    description: 'Create proportionally pleasing dimensions using φ (1.618)',
                    sections: [
                        {
                            title: 'How to Use',
                            content: `
                                <ol>
                                    <li>Enter one dimension (width OR height)</li>
                                    <li>Calculator provides the golden ratio complement</li>
                                    <li>Visual preview shows the proportions</li>
                                </ol>
                            `
                        },
                        {
                            title: 'Best For',
                            content: `
                                <ul>
                                    <li>Picture frames and artwork</li>
                                    <li>Furniture proportions</li>
                                    <li>Cabinet doors and drawers</li>
                                    <li>Any aesthetic design element</li>
                                </ul>
                            `
                        }
                    ]
                },
                spacing: {
                    title: 'Shelf & Division Calculator',
                    icon: '📐',
                    description: 'Calculate equal spacing for shelves and divisions',
                    sections: [
                        {
                            title: 'Two Modes',
                            content: `
                                <ul>
                                    <li><strong>By Count:</strong> Specify number of shelves/divisions</li>
                                    <li><strong>By Spacing:</strong> Specify desired gap between items</li>
                                </ul>
                            `
                        },
                        {
                            title: 'Common Uses',
                            content: `
                                <ul>
                                    <li>Bookshelf spacing</li>
                                    <li>Picket fence posts</li>
                                    <li>Drawer dividers</li>
                                    <li>Stair balusters</li>
                                </ul>
                            `
                        }
                    ]
                },
                angle: {
                    title: 'Miter Angle Calculator',
                    icon: '📐',
                    description: 'Calculate precise angles for joints and frames',
                    sections: [
                        {
                            title: 'Three Modes',
                            content: `
                                <ul>
                                    <li><strong>Polygon:</strong> Regular shapes (3-12 sides)</li>
                                    <li><strong>Frame:</strong> Custom rectangles with corners</li>
                                    <li><strong>Single Cut:</strong> One-off angle calculations</li>
                                </ul>
                            `
                        },
                        {
                            title: 'Results Include',
                            content: `
                                <ul>
                                    <li>Miter saw angle setting</li>
                                    <li>Actual cut angle</li>
                                    <li>Interior angle</li>
                                    <li>Visual diagram</li>
                                </ul>
                            `
                        }
                    ]
                },
                screw: {
                    title: 'Screw & Pilot Hole Calculator',
                    icon: '🔩',
                    description: 'Find correct drill sizes for any screw',
                    sections: [
                        {
                            title: 'Inputs',
                            content: `
                                <ul>
                                    <li>Screw size (#2-#20, fractions, lag bolts)</li>
                                    <li>Wood type (hardwood/softwood)</li>
                                    <li>Optional: thread pitch</li>
                                </ul>
                            `
                        },
                        {
                            title: 'Results',
                            content: `
                                <ul>
                                    <li><strong>Pilot hole:</strong> For screw threads</li>
                                    <li><strong>Clearance hole:</strong> For screw shank</li>
                                    <li><strong>Countersink:</strong> For flat head screws</li>
                                    <li><strong>Counterbore:</strong> For recessed heads</li>
                                </ul>
                            `
                        }
                    ]
                },
                grade: {
                    title: 'Grade/Slope Calculator',
                    icon: '📐',
                    description: 'Calculate slopes for ramps, roofs, and drainage',
                    sections: [
                        {
                            title: 'Input Any Two',
                            content: `
                                <ul>
                                    <li>Rise (vertical distance)</li>
                                    <li>Run (horizontal distance)</li>
                                    <li>Angle (degrees)</li>
                                </ul>
                            `
                        },
                        {
                            title: 'Compliance Info',
                            content: `
                                <ul>
                                    <li><strong>ADA Ramps:</strong> Max 1:12 (8.33%)</li>
                                    <li><strong>Parking:</strong> 1-5% typical</li>
                                    <li><strong>Drainage:</strong> Min 1-2%</li>
                                </ul>
                            `
                        }
                    ]
                },
                tile: {
                    title: 'Tile & Paver Calculator',
                    icon: '🔲',
                    description: 'Calculate quantities and costs for tile projects',
                    sections: [
                        {
                            title: 'Features',
                            content: `
                                <ul>
                                    <li>Multiple layout patterns</li>
                                    <li>Grout quantity estimation</li>
                                    <li>Automatic waste factor</li>
                                    <li>Cut tile estimation</li>
                                </ul>
                            `
                        },
                        {
                            title: 'Pro Tips',
                            content: `
                                <ul>
                                    <li>Add 10-15% waste for diagonal layouts</li>
                                    <li>Grout type auto-selected by gap size</li>
                                    <li>Include perimeter cuts in calculations</li>
                                </ul>
                            `
                        }
                    ]
                },
                cabinetDrawer: {
                    title: 'Cabinet Drawer & Face Frame Layout',
                    icon: '🗄️',
                    description: 'Calculate drawer and rail positions for cabinets',
                    sections: [
                        {
                            title: 'Configuration',
                            content: `
                                <ul>
                                    <li><strong>Frame Style:</strong> Inset or Overlay</li>
                                    <li><strong>Drawer Mode:</strong> Equal heights or Custom sizes</li>
                                    <li><strong>Rails:</strong> Optional horizontal dividers</li>
                                    <li><strong>Reveals/Overlay:</strong> Gap or overlap amount</li>
                                </ul>
                            `
                        },
                        {
                            title: 'Results Include',
                            content: `
                                <ul>
                                    <li>Visual diagrams (front view & rail placement)</li>
                                    <li>Cut list with exact dimensions</li>
                                    <li>Rail marking guide from bottom</li>
                                    <li>All measurements in specified precision</li>
                                </ul>
                            `
                        }
                    ]
                },
                cutCalc: {
                    title: 'Cut Calculator',
                    icon: '✂️',
                    description: 'Divide boards into equal pieces with kerf compensation',
                    sections: [
                        {
                            title: 'Two Modes',
                            content: `
                                <ul>
                                    <li><strong>Equal Division:</strong> Cut one board into equal pieces</li>
                                    <li><strong>Cut Optimization:</strong> Distribute cuts across multiple boards</li>
                                </ul>
                            `
                        },
                        {
                            title: 'Kerf Settings',
                            content: `
                                <ul>
                                    <li>Common blade widths: 1/16", 3/32", 1/8", 3/16"</li>
                                    <li>Cut side preference affects final piece sizes</li>
                                    <li>Visual diagram shows blade position</li>
                                </ul>
                            `
                        },
                        {
                            title: 'Results',
                            content: `
                                <ul>
                                    <li>Exact cut mark measurements</li>
                                    <li>Final piece dimensions</li>
                                    <li>Total waste calculation</li>
                                    <li>Save multiple scenarios</li>
                                </ul>
                            `
                        }
                    ]
                }
            }
        };

        function showHelp() {
            // Determine which tab is active
            const activeTab = document.querySelector('.tab-content[style*="block"]')?.id?.replace('Tab', '') || 'calculator';
            
            // Determine current UI mode
            const currentMode = uiConfig.mode || 'basic';
            
            // Update mode-specific content
            if (helpContent.tabs.calculator && helpContent.tabs.calculator.sections[0]) {
                const modeSection = helpContent.tabs.calculator.sections[0];
                let modeText = '';
                switch(currentMode) {
                    case 'basic':
                        modeText = '<p style="margin: 0 0 10px 0;"><strong>Current Mode: Basic</strong></p>';
                        break;
                    case 'standard':
                        modeText = '<p style="margin: 0 0 10px 0;"><strong>Current Mode: Standard</strong></p>';
                        break;
                    case 'advanced':
                        modeText = '<p style="margin: 0 0 10px 0;"><strong>Current Mode: Project</strong></p>';
                        break;
                }
                modeSection.content = modeText + `
                    <ul>
                        <li><strong>Basic:</strong> Single calculator only</li>
                        <li><strong>Standard:</strong> Calculator + Specialty Calculators tab</li>
                        <li><strong>Project:</strong> All tabs including Projects</li>
                    </ul>
                    <p style="margin-top: 10px; font-size: 12px;">Switch modes using the dropdown in the header (top right)</p>
                `;
            }
            
            showContextHelp(activeTab);
        }

        function showContextHelp(context) {
            const modal = document.getElementById('helpModal');
            if (modal) {
                // Move modal to body to ensure it's not constrained by parent
                document.body.appendChild(modal);
                
                // Apply the same styles that worked for the test modal
                modal.style.cssText = `
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    width: 100vw !important;
                    height: 100vh !important;
                    background-color: rgba(0,0,0,0.5) !important;
                    z-index: 99999 !important;
                    display: block !important;
                    visibility: visible !important;
                `;
                
                // Also fix the modal content
                const modalContent = modal.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.style.cssText = `
                        background-color: white !important;
                        margin: 5% auto !important;
                        padding: 20px !important;
                        border-radius: 15px !important;
                        width: 90% !important;
                        max-width: 600px !important;
                        max-height: 80vh !important;
                        overflow-y: auto !important;
                        display: block !important;
                        position: relative !important;
                    `;
                    
                    // Update content based on context
                    const helpData = helpContent.tabs[context] || helpContent.tabs.calculator;
                    
                    let contentHTML = `
                        <span class="close" onclick="closeHelp()" style="font-size: 28px; font-weight: bold; cursor: pointer; position: absolute; right: 15px; top: 10px;">&times;</span>
                        <h2 style="text-align: center; color: var(--primary-color); margin: 0 0 20px 0;">${helpData.title}</h2>
                    `;
                    
                    helpData.sections.forEach(section => {
                        contentHTML += `
                            <div style="margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                <h3 style="margin: 0 0 10px 0; color: var(--primary-color); font-size: 16px;">
                                    ${section.icon} ${section.title}
                                </h3>
                                <div style="font-size: 14px; line-height: 1.6;">
                                    ${section.content}
                                </div>
                            </div>
                        `;
                    });
                    
                    modalContent.innerHTML = contentHTML;
                }
            }
        }
        
        function closeHelp() {
            const modal = document.getElementById('helpModal');
            if (modal) modal.style.display = 'none';
        }
        
        function showCalculatorHelp(calcId) {
            const helpData = helpContent.calculators[calcId];
            if (!helpData) {
                console.warn(`No help content for calculator: ${calcId}`);
                return;
            }
            
            const modal = document.getElementById('helpModal');
            if (modal) {
                // Move modal to body to ensure it's not constrained by parent
                document.body.appendChild(modal);
                
                // Apply modal styles
                modal.style.cssText = `
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    width: 100vw !important;
                    height: 100vh !important;
                    background-color: rgba(0,0,0,0.5) !important;
                    z-index: 99999 !important;
                    display: block !important;
                    visibility: visible !important;
                `;
                
                const modalContent = modal.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.style.cssText = `
                        background-color: white !important;
                        margin: 5% auto !important;
                        padding: 20px !important;
                        border-radius: 15px !important;
                        width: 90% !important;
                        max-width: 500px !important;
                        max-height: 70vh !important;
                        overflow-y: auto !important;
                        display: block !important;
                        position: relative !important;
                    `;
                    
                    let contentHTML = `
                        <span class="close" onclick="closeHelp()" style="font-size: 28px; font-weight: bold; cursor: pointer; position: absolute; right: 15px; top: 10px;">&times;</span>
                        <div style="text-align: center; margin-bottom: 15px;">
                            <span style="font-size: 48px;">${helpData.icon}</span>
                        </div>
                        <h2 style="text-align: center; color: var(--primary-color); margin: 0 0 10px 0; font-size: 20px;">${helpData.title}</h2>
                        <p style="text-align: center; color: #666; margin: 0 0 20px 0; font-size: 14px;">${helpData.description}</p>
                    `;
                    
                    helpData.sections.forEach(section => {
                        contentHTML += `
                            <div style="margin-bottom: 15px;">
                                <h4 style="margin: 0 0 8px 0; color: var(--primary-color); font-size: 15px;">${section.title}</h4>
                                <div style="font-size: 13px; line-height: 1.5;">
                                    ${section.content}
                                </div>
                            </div>
                        `;
                    });
                    
                    modalContent.innerHTML = contentHTML;
                }
            }
        }

        // SVG Diagram Capture Utility
        function captureSVGDiagram(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return null;
            
            const svg = container.querySelector('svg');
            if (!svg) return null;
            
            try {
                // Clone the SVG to avoid modifying the original
                const svgClone = svg.cloneNode(true);
                
                // Remove interactive elements for static save
                svgClone.querySelectorAll('[onmouseover], [onclick], [onhover]').forEach(el => {
                    el.removeAttribute('onmouseover');
                    el.removeAttribute('onclick');
                    el.removeAttribute('onhover');
                });
                
                // Ensure proper styling is preserved
                svgClone.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
                
                // Get computed styles and add inline styles for key visual elements
                const computedStyles = window.getComputedStyle(svg);
                if (computedStyles.backgroundColor && computedStyles.backgroundColor !== 'rgba(0, 0, 0, 0)') {
                    svgClone.style.backgroundColor = computedStyles.backgroundColor;
                }
                
                // Serialize to string
                const serializer = new XMLSerializer();
                const svgString = serializer.serializeToString(svgClone);
                
                // Create data URL for easy embedding
                const svgDataUrl = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgString)));
                
                return {
                    svgString: svgString,
                    dataUrl: svgDataUrl,
                    width: svg.getAttribute('width') || svg.viewBox?.baseVal?.width || 400,
                    height: svg.getAttribute('height') || svg.viewBox?.baseVal?.height || 200
                };
            } catch (error) {
                console.warn('Failed to capture SVG diagram:', error);
                return null;
            }
        }

        
        // Edit modal functions
        function showEditModal(type, data) {
            editingItem = { type: type, data: data };
            const modal = document.getElementById('editModal');
            const title = document.getElementById('editTitle');
            const inputs = document.getElementById('editInputs');
            
            if (type === 'board') {
                title.textContent = 'Edit Board';
                const parts = inchesToParts(data.length);
                inputs.innerHTML = `
                    <div class="input-group">
                        <label>Length:</label>
                        <input type="number" id="editFeet" placeholder="0" min="0" class="wide-input" value="${parts.feet}">
                        <span>ft</span>
                        <input type="number" id="editInches" placeholder="0" min="0" max="11" class="wide-input" value="${parts.inches}">
                        <span>in</span>
                        <select id="editFraction" style="width: 120px;">
                            <option value="0">0</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Quantity:</label>
                        <input type="number" id="editQuantity" placeholder="1" min="0" class="wide-input" value="${data.quantity}">
                    </div>
                `;
                updatePrecision('edit'); // Update fraction options for edit modal
                setTimeout(() => {
                    if (document.getElementById('editFraction')) {
                        document.getElementById('editFraction').value = parts.fraction;
                    }
                }, 10);
            } else if (type === 'cutGroup') {
                title.textContent = 'Edit Cut Group';
                const parts = inchesToParts(data.length);
                inputs.innerHTML = `
                    <div class="input-group">
                        <label>Length:</label>
                        <input type="number" id="editFeet" placeholder="0" min="0" class="wide-input" value="${parts.feet}">
                        <span>ft</span>
                        <input type="number" id="editInches" placeholder="0" min="0" max="11" class="wide-input" value="${parts.inches}">
                        <span>in</span>
                        <select id="editFraction" style="width: 120px;">
                            <option value="0">0</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Quantity:</label>
                        <input type="number" id="editQuantity" placeholder="1" min="0" class="wide-input" value="${data.count}">
                    </div>
                `;
                updatePrecision('edit'); // Update fraction options for edit modal
                document.getElementById('editFraction').value = parts.fraction;
            }
            
            modal.style.display = 'block';
        }
        
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            editingItem = null;
        }
        
        function saveEdit() {
            if (!editingItem) return;
            
            const newLength = getInputInches('editFeet', 'editInches', 'editFraction');
            const newQuantity = parseInt(document.getElementById('editQuantity')?.value) || 0;
            
            if (newLength <= 0) {
                showNotification('Please enter a valid length');
                return;
            }
            
            if (editingItem.type === 'board') {
                const index = editingItem.data.index;
                if (newQuantity > 0) {
                    boards[index] = { length: newLength, quantity: newQuantity };
                } else {
                    boards.splice(index, 1);
                }
                updateBoardsList();
            } else if (editingItem.type === 'cutGroup') {
                // Remove old cuts
                cuts = cuts.filter(cut => cut.id === undefined || !editingItem.data.ids.includes(cut.id));
                
                // Add new cuts
                for (let i = 0; i < newQuantity; i++) {
                    cuts.push({ length: newLength, id: cutIdCounter++ });
                }
                updateCutsList();
            }
            
            closeEditModal();
        }
        
        function deleteEdit() {
            if (!editingItem) return;
            
            if (confirm('Are you sure you want to delete this item?')) {
                if (editingItem.type === 'board') {
                    boards.splice(editingItem.data.index, 1);
                    updateBoardsList();
                } else if (editingItem.type === 'cutGroup') {
                    cuts = cuts.filter(cut => cut.id === undefined || !editingItem.data.ids.includes(cut.id));
                    updateCutsList();
                }
                closeEditModal();
            }
        }
        
        function editBoard(index) {
            showEditModal('board', { ...boards[index], index: index });
        }
        
        function editCutGroup(length, ids) {
            showEditModal('cutGroup', { length: length, count: ids.length, ids: ids });
        }
        
        function addBoard() {
            // Use smart input value if available, otherwise fall back to legacy inputs
            let inches = currentBoardLengthInches;
            if (inches === 0) {
                inches = getInputInches('boardFeet', 'boardInches', 'boardFraction');
            }
            const quantity = parseInt(document.getElementById('boardQuantity')?.value) || 1;
            if (inches <= 0) return;
            
            // Check if this board size already exists
            const existingBoard = boards.find(board => Math.abs(board.length - inches) < 0.01);
            if (existingBoard) {
                existingBoard.quantity += quantity;
            } else {
                boards.push({ length: inches, quantity: quantity });
            }
            
            updateBoardsList();
            
            if (document.getElementById('boardFeet')) document.getElementById('boardFeet').value = '';
            if (document.getElementById('boardInches')) document.getElementById('boardInches').value = '';
            
            // Auto-recalculate if we have cuts
            autoRecalculateOptimization();
            if (document.getElementById('boardFraction')) document.getElementById('boardFraction').value = '0';
            if (document.getElementById('boardQuantity')) document.getElementById('boardQuantity').value = '1';
        }
        
        function addCut() {
            // Use smart input value if available, otherwise fall back to legacy inputs
            let inches = currentOptCutLengthInches;
            if (inches === 0) {
                inches = getInputInches('optCutFeet', 'optCutInches', 'optCutFraction');
            }
            const quantity = parseInt(document.getElementById('cutQuantity')?.value) || 1;
            if (inches <= 0) return;
            
            for (let i = 0; i < quantity; i++) {
                cuts.push({ length: inches, id: cutIdCounter++ });
            }
            updateCutsList();
            
            if (document.getElementById('optCutFeet')) document.getElementById('optCutFeet').value = '';
            if (document.getElementById('optCutInches')) document.getElementById('optCutInches').value = '';
            if (document.getElementById('optCutFraction')) document.getElementById('optCutFraction').value = '0';
            if (document.getElementById('cutQuantity')) document.getElementById('cutQuantity').value = '1';
            
            // Auto-recalculate if we have boards
            autoRecalculateOptimization();
        }
        
        function updateBoardsList() {
            const div = document.getElementById('boardsList');
            if (!div) return;
            
            div.innerHTML = boards.map((board, i) => 
                `<div style="padding: 10px; background: #f0f0f0; margin: 4px 0; border-radius: 5px; display: flex; align-items: center; justify-content: space-between;">
                    <div style="flex: 1;">
                        <strong>${board.quantity}× ${inchesToDisplay(board.length, 'opt')} boards</strong>
                    </div>
                    <button onclick="removeBoard(${i})" style="background: #dc3545; color: white; border: none; border-radius: 3px; padding: 6px 12px; cursor: pointer; font-weight: bold;">×</button>
                </div>`
            ).join('');
        }
        
        function updateCutsList() {
            const div = document.getElementById('cutsList');
            if (!div) return;
            
            const cutGroups = {};
            cuts.forEach(cut => {
                const lengthKey = cut.length.toFixed(6); // Use fixed precision for grouping
                if (!cutGroups[lengthKey]) {
                    cutGroups[lengthKey] = { length: cut.length, count: 0, ids: [] };
                }
                cutGroups[lengthKey].count++;
                cutGroups[lengthKey].ids.push(cut.id);
            });
            
            div.innerHTML = Object.values(cutGroups).map(group => 
                `<div style="padding: 10px; background: #f0f0f0; margin: 4px 0; border-radius: 5px; display: flex; align-items: center; justify-content: space-between;">
                    <div style="flex: 1;">
                        <strong>${group.count}× ${inchesToDisplay(group.length, 'opt')}</strong>
                    </div>
                    <button onclick="removeCutGroup(${group.length})" style="background: #dc3545; color: white; border: none; border-radius: 3px; padding: 6px 12px; cursor: pointer; font-weight: bold;">×</button>
                </div>`
            ).join('');
        }
        
        function removeBoard(index) {
            boards.splice(index, 1);
            updateBoardsList();
            autoRecalculateOptimization();
        }
        
        function removeCutGroup(length) {
            // Remove all cuts that match this length (within small tolerance)
            cuts = cuts.filter(cut => Math.abs(cut.length - length) > 0.0001);
            updateCutsList();
            autoRecalculateOptimization();
        }
        
        function optimizeCuts() {
            if (boards.length === 0 || cuts.length === 0) {
                showNotification('Please add boards and cuts first');
                return;
            }
            
            const kerfValue = parseFloat(document.getElementById('optKerf')?.value || 0);
            const kerf = kerfValue;
            const kerfEnabled = kerfValue > 0;
            
            // Create expanded board list with individual boards
            let availableBoards = [];
            boards.forEach((boardType, typeIndex) => {
                for (let i = 0; i < boardType.quantity; i++) {
                    availableBoards.push({
                        length: boardType.length,
                        typeIndex: typeIndex,
                        boardNumber: i + 1
                    });
                }
            });
            
            const results = [];
            const remainingCuts = cuts.map(c => c.length).sort((a, b) => b - a); // Sort largest first
            availableBoards.sort((a, b) => b.length - a.length); // Sort by length desc
            
            let totalCutsCompleted = 0;
            
            for (let boardIndex = 0; boardIndex < availableBoards.length; boardIndex++) {
                let board = availableBoards[boardIndex];
                let boardLength = board.length;
                let cutsOnThisBoard = [];
                let usedLength = 0;
                
                for (let cutIndex = remainingCuts.length - 1; cutIndex >= 0; cutIndex--) {
                    const cutLength = remainingCuts[cutIndex];
                    const neededLength = usedLength === 0 ? cutLength : cutLength + kerf;
                    
                    if (usedLength + neededLength <= boardLength) {
                        cutsOnThisBoard.push(cutLength);
                        usedLength += neededLength;
                        remainingCuts.splice(cutIndex, 1);
                        totalCutsCompleted++;
                    }
                }
                
                if (cutsOnThisBoard.length > 0) {
                    const waste = boardLength - usedLength;
                    const boardSize = inchesToDisplay(board.length, 'opt');
                    results.push({
                        boardDisplay: `${boardSize} board #${board.boardNumber}`,
                        boardLength: board.length,
                        cuts: cutsOnThisBoard,
                        waste: waste
                    });
                }
                
                if (remainingCuts.length === 0) break;
            }
            
            displayOptimizationResults(results, remainingCuts, kerfEnabled, totalCutsCompleted, cuts.length);
        }
        
        function displayOptimizationResults(results, remainingCuts, kerfEnabled, completedCuts, totalCuts) {
            const div = document.getElementById('optimizationResults');
            if (!div) return;
            
            const kerfNote = kerfEnabled ? ` (with kerf)` : ' (no kerf)';
            let html = '<div class="results">';
            
            // Summary section
            html += '<h3>Summary:</h3>';
            html += `<p><strong>Cuts completed:</strong> ${completedCuts} of ${totalCuts}</p>`;
            
            if (remainingCuts.length > 0) {
                html += `<p style="color: #CD5C5C;"><strong>⚠️ Not enough boards!</strong> ${remainingCuts.length} cuts cannot be completed.</p>`;
            } else {
                html += `<p style="color: #4CAF50;"><strong>✅ All cuts can be completed!</strong></p>`;
            }
            
            if (results.length > 0) {
                html += `<h3 style="margin-top: 20px;">Cutting Plan${kerfNote}:</h3>`;
                results.forEach((result, index) => {
                    html += `<div class="cut-plan">
                        <strong>${result.boardDisplay}:</strong><br>
                        Cuts: ${result.cuts.map(cut => inchesToDisplay(cut, 'opt')).join(', ')}<br>
                        Waste: ${inchesToDisplay(result.waste, 'opt')}
                    </div>`;
                });
                
                const totalWaste = results.reduce((sum, result) => sum + result.waste, 0);
                html += `<p><strong>Total Waste: ${inchesToDisplay(totalWaste, 'opt')}</strong></p>`;
            }
            
            if (remainingCuts.length > 0) {
                html += '<h3 style="color: red; margin-top: 20px;">Cuts that don\'t fit:</h3>';
                const cutGroups = {};
                remainingCuts.forEach(cut => {
                    const display = inchesToDisplay(cut, 'opt');
                    cutGroups[display] = (cutGroups[display] || 0) + 1;
                });
                
                html += '<div style="background: #ffe6e6; padding: 10px; border-radius: 5px; border-left: 4px solid #CD5C5C;">';
                html += Object.entries(cutGroups).map(([display, count]) => 
                    `${count}× ${display}`
                ).join(', ');
                html += '<br><br><strong>Suggestion:</strong> Add more boards or reduce the number of cuts needed.';
                html += '</div>';
            }
            
            html += '</div>';
            
            // Add save to project button
            if (results.length > 0) {
                html += '<div style="margin-top: 15px;">';
                html += '<button class="btn btn-success btn-sm" onclick="saveOptimizationToProject()">Save to Project</button>';
                html += '</div>';
            }
            
            div.innerHTML = html;
            
            // Store results globally for visualization
            window.currentOptimizationResults = results;
            window.currentKerfEnabled = kerfEnabled;
            
            // Automatically show visual layout if there are results
            if (results.length > 0) {
                showVisualLayout();
            }
        }
        
        function showVisualLayout() {
            const visualDiv = document.getElementById('visualLayout');
            const boardDiv = document.getElementById('boardVisualization');
            
            if (!window.currentOptimizationResults || !visualDiv || !boardDiv) {
                showNotification('No optimization results to visualize', 'error');
                return;
            }
            
            visualDiv.style.display = 'block';
            
            const results = window.currentOptimizationResults;
            const kerfEnabled = window.currentKerfEnabled;
            const kerf = kerfEnabled ? parseFloat(document.getElementById('optKerf')?.value || 0.125) : 0;
            
            let html = '';
            let totalWoodUsed = 0;
            let totalWaste = 0;
            
            // Calculate efficiency
            results.forEach(result => {
                const usedLength = result.boardLength - result.waste;
                totalWoodUsed += usedLength;
                totalWaste += result.waste;
            });
            
            const totalWood = totalWoodUsed + totalWaste;
            const efficiency = totalWood > 0 ? ((totalWoodUsed / totalWood) * 100) : 0;
            
            // Efficiency summary
            let efficiencyClass = 'efficiency-summary';
            if (efficiency >= 85) efficiencyClass += ' efficiency-good';
            else if (efficiency < 70) efficiencyClass += ' efficiency-poor';
            
            html += `<div class="${efficiencyClass}">
                <strong>Material Efficiency: ${efficiency.toFixed(1)}%</strong><br>
                Wood Used: ${inchesToDisplay(totalWoodUsed, 'opt')} | 
                Waste: ${inchesToDisplay(totalWaste, 'opt')} | 
                Total: ${inchesToDisplay(totalWood, 'opt')}
            </div>`;
            
            // Visualize each board
            results.forEach((result, boardIndex) => {
                const boardLength = result.boardLength;
                const maxDisplayWidth = 400; // Max width in pixels
                const scale = maxDisplayWidth / Math.max(boardLength, 48); // Scale based on largest board or 4 feet minimum
                
                html += `<div class="visual-board">
                    <div class="board-header">${result.boardDisplay} (${inchesToDisplay(boardLength, 'opt')})</div>
                    <div class="board-visual" style="width: ${boardLength * scale}px;">`;
                
                let currentPosition = 0;
                
                // Add cuts and kerf gaps
                result.cuts.forEach((cutLength, cutIndex) => {
                    // Add kerf before cut (except first cut)
                    if (cutIndex > 0 && kerfEnabled) {
                        html += `<div class="cut-segment kerf" style="left: ${currentPosition * scale}px; width: ${kerf * scale}px;" title="Kerf: ${inchesToDisplay(kerf, 'opt')}"></div>`;
                        currentPosition += kerf;
                    }
                    
                    // Add the cut
                    const cutWidth = cutLength * scale;
                    html += `<div class="cut-segment used" style="left: ${currentPosition * scale}px; width: ${cutWidth}px;" title="Cut: ${inchesToDisplay(cutLength, 'opt')}">${inchesToDisplay(cutLength, 'opt')}</div>`;
                    currentPosition += cutLength;
                });
                
                // Add waste if any
                if (result.waste > 0.01) { // Only show if waste is significant
                    const wasteWidth = result.waste * scale;
                    html += `<div class="cut-segment waste" style="left: ${currentPosition * scale}px; width: ${wasteWidth}px;" title="Waste: ${inchesToDisplay(result.waste, 'opt')}">Waste</div>`;
                }
                
                html += `</div>
                    <div class="board-stats">
                        Cuts: ${result.cuts.length} | 
                        Used: ${inchesToDisplay(boardLength - result.waste, 'opt')} | 
                        Waste: ${inchesToDisplay(result.waste, 'opt')} |
                        Efficiency: ${((boardLength - result.waste) / boardLength * 100).toFixed(1)}%
                    </div>
                </div>`;
            });
            
            boardDiv.innerHTML = html;
            
            // Scroll to visual layout
            visualDiv.scrollIntoView({ behavior: 'smooth' });
        }
        
        function exportEqualDivisionResult(index) {
            if (!currentCutResults || currentCutResults.length === 0 || index >= currentCutResults.length) {
                showNotification('No cut result to export', 'error');
                return;
            }
            
            const cutData = currentCutResults[index];
            const projectName = currentProject ? currentProject.name : 'Woodworking Project';
            const date = new Date().toLocaleDateString();
            
            let exportText = `${projectName} - Equal Division Cut List\n`;
            exportText += `Generated: ${date}\n\n`;
            
            exportText += 'CUT INSTRUCTIONS:\n';
            exportText += '='.repeat(50) + '\n';
            exportText += `Original Board Length: ${cutData.originalLength}\n`;
            exportText += `Number of Pieces: ${cutData.pieces}\n`;
            exportText += `Piece Length: ${cutData.pieceLength}\n`;
            exportText += `Kerf Settings: ${cutData.kerfNote}${cutData.cutSideNote}\n\n`;
            
            if (cutData.results && cutData.results.length > 0) {
                exportText += 'CUTTING MARKS:\n';
                exportText += '-'.repeat(30) + '\n';
                cutData.results.forEach((mark, i) => {
                    exportText += `Mark ${i + 1}: ${mark.display}\n`;
                });
                exportText += '\n';
            }
            
            exportText += 'CUTTING SEQUENCE:\n';
            exportText += '-'.repeat(30) + '\n';
            exportText += '1. Measure and mark all cut positions\n';
            exportText += '2. Double-check measurements before cutting\n';
            exportText += '3. Cut at each marked position\n';
            exportText += `4. Result: ${cutData.pieces} pieces @ ${cutData.pieceLength} each\n`;
            
            // Create downloadable file
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${projectName.replace(/[^a-zA-Z0-9]/g, '_')}_equal_division_cuts.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification('Cut list exported successfully!', 'success');
        }
        
        function toggleVisualLayout() {
            const visualDiv = document.getElementById('visualLayout');
            if (visualDiv) {
                visualDiv.style.display = visualDiv.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        function exportCutList() {
            if (!window.currentOptimizationResults) {
                showNotification('No optimization results to export', 'error');
                return;
            }
            
            const results = window.currentOptimizationResults;
            const projectName = currentProject ? currentProject.name : 'Woodworking Project';
            const date = new Date().toLocaleDateString();
            
            let exportText = `${projectName} - Cut List\n`;
            exportText += `Generated: ${date}\n`;
            exportText += `Kerf: ${window.currentKerfEnabled ? 'Enabled' : 'Disabled'}\n\n`;
            
            exportText += 'CUTTING PLAN:\n';
            exportText += '='.repeat(50) + '\n';
            
            results.forEach((result, index) => {
                exportText += `\n${result.boardDisplay}:\n`;
                exportText += `  Cuts: ${result.cuts.map(cut => inchesToDisplay(cut, 'opt')).join(', ')}\n`;
                exportText += `  Waste: ${inchesToDisplay(result.waste, 'opt')}\n`;
                exportText += `  Efficiency: ${((result.boardLength - result.waste) / result.boardLength * 100).toFixed(1)}%\n`;
            });
            
            const totalWaste = results.reduce((sum, result) => sum + result.waste, 0);
            const totalWood = results.reduce((sum, result) => sum + result.boardLength, 0);
            const efficiency = ((totalWood - totalWaste) / totalWood * 100).toFixed(1);
            
            exportText += `\nSUMMARY:\n`;
            exportText += `Total Boards Used: ${results.length}\n`;
            exportText += `Total Waste: ${inchesToDisplay(totalWaste, 'opt')}\n`;
            exportText += `Overall Efficiency: ${efficiency}%\n`;
            
            // Create downloadable file
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${projectName.replace(/[^a-zA-Z0-9]/g, '_')}_cut_list.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification('Cut list exported successfully!', 'success');
        }
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            const helpModal = document.getElementById('helpModal');
            const jokeModal = document.getElementById('jokeModal');
            const editModal = document.getElementById('editModal');
            const calcModal = document.getElementById('calcModal');
            const notesModal = document.getElementById('notesModal');
            const saveToProjectModal = document.getElementById('saveToProjectModal');
            const allProjectsModal = document.getElementById('allProjectsModal');
            
            if (event.target === helpModal) {
                helpModal.style.display = 'none';
            }
            if (event.target === jokeModal) {
                jokeModal.style.display = 'none';
            }
            if (event.target === editModal) {
                editModal.style.display = 'none';
                editingItem = null;
            }
            if (event.target === calcModal) {
                calcModal.style.display = 'none';
            }
            if (event.target === notesModal) {
                notesModal.style.display = 'none';
            }
            if (event.target === saveToProjectModal) {
                closeSaveToProjectModal();
            }
            if (event.target === allProjectsModal) {
                closeAllProjectsModal();
            }
        }
        
        // New Calculator Card Functions
        function toggleCalcCard(cardType) {
            const card = document.getElementById(cardType + 'Card');
            const content = document.getElementById(cardType + 'Content');
            const arrow = document.querySelector(`#${cardType}Card .calc-arrow`);
            
            if (content.style.display === 'none' || content.style.display === '' || window.getComputedStyle(content).display === 'none') {
                // Show the content
                content.style.display = 'block';
                
                if (card) {
                    card.classList.add('expanded');
                }
                arrow.textContent = '▲';
                
                // Save state
                if (uiConfig.preferences.rememberCollapsedState) {
                    localStorage.setItem(`calc-${cardType}-collapsed`, 'false');
                }
                // Track calculator usage when expanded
                trackCalculatorUsage(cardType);
                
                // Trigger recalculation for cabinet drawer calculator to show diagrams
                if (cardType === 'cabinetDrawer') {
                    calculateCabinetLayout();
                }
            } else {
                // Hide the content
                content.style.display = 'none';
                
                if (card) {
                    card.classList.remove('expanded');
                }
                arrow.textContent = '▼';
                
                // Save state
                if (uiConfig.preferences.rememberCollapsedState) {
                    localStorage.setItem(`calc-${cardType}-collapsed`, 'true');
                }
            }
        }
        
        // Progressive Disclosure Functions
        function showMoreCalculatorFeatures() {
            // Add multiply and divide to beginner mode
            uiConfig.modes.beginner.availableOperations = ['+', '-', '*', '/'];
            
            // Update the interface
            applyUIMode();
            
            // Show a helpful notification
            showNotification('✨ Multiply (×) and Divide (÷) unlocked!', 'success');
        }
        
        // Expand/Collapse All Functions
        // Calculator tracking and filtering functions
        function trackCalculatorUsage(calcId) {
            // Get calculator info
            const calcInfo = getCalculatorInfo(calcId);
            if (!calcInfo) return;
            
            // Get recent calculators from localStorage
            let recentCalcs = JSON.parse(localStorage.getItem('recentCalculators') || '[]');
            
            // Remove if already exists (to move to front)
            recentCalcs = recentCalcs.filter(id => id !== calcId);
            
            // Add to front
            recentCalcs.unshift(calcId);
            
            // Keep only last 3
            recentCalcs = recentCalcs.slice(0, 3);
            
            // Save to localStorage
            localStorage.setItem('recentCalculators', JSON.stringify(recentCalcs));
            
            // Update UI
            updateRecentCalculators();
        }
        
        function getCalculatorInfo(calcId) {
            const calculatorMap = {
                'boardFoot': { name: 'Lumber Shopping Cart', icon: '📏' },
                'goldenRatio': { name: 'Golden Ratio Calculator', icon: '✨' },
                'spacing': { name: 'Shelf & Division Calculator', icon: '📐' },
                'angle': { name: 'Miter Angle Calculator', icon: '📐' },
                'screw': { name: 'Screw & Pilot Hole Calculator', icon: '🔩' },
                'grade': { name: 'Grade/Slope Calculator', icon: '📐' },
                'tile': { name: 'Tile & Paver Calculator', icon: '🔲' },
                'cutCalc': { name: 'Cut Calculator', icon: '✂️' },
                'cabinetDrawer': { name: 'Cabinet Drawer & Face Frame Layout', icon: '🗄️' }
            };
            return calculatorMap[calcId];
        }
        
        function updateRecentCalculators() {
            const recentCalcs = JSON.parse(localStorage.getItem('recentCalculators') || '[]');
            const grid = document.getElementById('recentCalculatorsGrid');
            const noRecent = document.getElementById('noRecentCalculators');
            
            if (recentCalcs.length === 0) {
                grid.style.display = 'none';
                noRecent.style.display = 'block';
            } else {
                grid.style.display = 'flex';
                noRecent.style.display = 'none';
                
                grid.innerHTML = recentCalcs.map(calcId => {
                    const info = getCalculatorInfo(calcId);
                    if (!info) return '';
                    
                    return `
                        <div class="recent-calc-card" style="background: white; border: 1px solid var(--border-color); border-radius: 6px; padding: 8px 12px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px;"
                             onclick="jumpToCalculator('${calcId}')"
                             onmouseover="this.style.borderColor='var(--primary-color)'; this.style.backgroundColor='var(--surface-color)'"
                             onmouseout="this.style.borderColor='var(--border-color)'; this.style.backgroundColor='white'">
                            <span style="font-size: 16px;">${info.icon}</span>
                            <span style="font-size: 13px; color: var(--text-primary);">${info.name}</span>
                        </div>
                    `;
                }).join('');
            }
        }
        
        function jumpToCalculator(calcId) {
            // Find and scroll to calculator
            const calcCard = document.getElementById(calcId + 'Card');
            if (calcCard) {
                // First, expand the category if it's collapsed
                const categoryContent = calcCard.closest('.calc-category-content');
                if (categoryContent && categoryContent.style.display === 'none') {
                    const categoryId = categoryContent.id.replace('-content', '');
                    toggleCategory(categoryId);
                }
                
                // Scroll to calculator
                setTimeout(() => {
                    calcCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
                
                // Expand calculator
                const content = document.getElementById(calcId + 'Content');
                const arrow = document.querySelector(`#${calcId}Card .calc-arrow`);
                if (content && content.style.display !== 'block') {
                    content.style.display = 'block';
                    arrow.textContent = '▲';
                }
                
                // Brief highlight effect
                calcCard.style.transition = 'background-color 0.3s';
                calcCard.style.backgroundColor = 'var(--primary-color-light)';
                setTimeout(() => {
                    calcCard.style.backgroundColor = '';
                }, 1000);
            }
        }
        
        function filterCalculators() {
            const searchTerm = document.getElementById('calcSearchInput').value.toLowerCase();
            const specialtyTab = document.getElementById('specialty');
            const calcCards = specialtyTab ? specialtyTab.querySelectorAll('.calc-card') : [];
            const categoryHeaders = specialtyTab ? specialtyTab.querySelectorAll('.calc-category-header') : [];
            const categoryContents = specialtyTab ? specialtyTab.querySelectorAll('.calc-category-content') : [];
            
            if (!searchTerm) {
                // Show all calculators and headers, but keep categories collapsed
                calcCards.forEach(card => card.style.display = 'block');
                // Show category headers (we're already scoped to specialty tab)
                categoryHeaders.forEach(header => header.style.display = 'flex');
            } else {
                // Expand all categories for search
                categoryContents.forEach(content => {
                    content.style.display = 'block';
                    const categoryId = content.id.replace('-content', '');
                    const arrow = document.getElementById(categoryId + '-arrow');
                    if (arrow) arrow.textContent = '▼';
                });
                
                // Filter based on search
                calcCards.forEach(card => {
                    const title = card.querySelector('.calc-title')?.textContent.toLowerCase() || '';
                    const description = card.querySelector('.calc-description')?.textContent.toLowerCase() || '';
                    
                    if (title.includes(searchTerm) || description.includes(searchTerm)) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
                
                // Hide empty categories
                categoryContents.forEach(content => {
                    const calcCardsInCategory = content.querySelectorAll('.calc-card');
                    let hasVisibleCalc = false;
                    
                    calcCardsInCategory.forEach(card => {
                        if (card.style.display !== 'none') {
                            hasVisibleCalc = true;
                        }
                    });
                    
                    const categoryId = content.id.replace('-content', '');
                    const header = content.previousElementSibling;
                    
                    if (!hasVisibleCalc) {
                        header.style.display = 'none';
                        content.style.display = 'none';
                    } else {
                        // Show header (we're already scoped to specialty tab)
                        header.style.display = 'flex';
                    }
                });
            }
        }
        
        function clearCalculatorSearch() {
            document.getElementById('calcSearchInput').value = '';
            filterCalculators();
        }
        
        // Ensure category headers and calc cards are hidden in non-active tabs
        function ensureCategoryVisibility() {
            const activeTab = document.querySelector('.tab-content.active');
            const specialtyTab = document.getElementById('specialty');
            const categoryHeaders = specialtyTab ? specialtyTab.querySelectorAll('.calc-category-header') : [];
            const categoryContents = specialtyTab ? specialtyTab.querySelectorAll('.calc-category-content') : [];
            const specialtyCalcCards = specialtyTab ? specialtyTab.querySelectorAll('.calc-card') : [];
            
            if (activeTab && activeTab.id === 'specialty') {
                // Show category headers in specialty tab
                categoryHeaders.forEach(header => {
                    header.style.display = 'flex';
                });
                // Show calc cards in specialty tab
                specialtyCalcCards.forEach(card => {
                    card.style.display = 'block';
                });
                // Restore category content display state
                categoryContents.forEach(content => {
                    if (content.getAttribute('data-was-expanded') === 'true') {
                        content.style.display = 'block';
                        content.removeAttribute('data-was-expanded');
                        // Update arrow to show expanded state
                        const categoryId = content.id.replace('-content', '');
                        const arrow = document.getElementById(categoryId + '-arrow');
                        if (arrow) arrow.textContent = '▼';
                    }
                });
            } else {
                // Hide all category headers if not in specialty tab
                categoryHeaders.forEach(header => {
                    header.style.display = 'none';
                });
                // Hide all category content containers if not in specialty tab
                categoryContents.forEach(content => {
                    // Store the current display state to restore later
                    if (content.style.display !== 'none') {
                        content.setAttribute('data-was-expanded', 'true');
                    }
                    content.style.display = 'none';
                });
                // Hide specialty calc cards if not in specialty tab
                specialtyCalcCards.forEach(card => {
                    card.style.display = 'none';
                });
            }
        }
        
        function toggleCategory(categoryId) {
            const content = document.getElementById(categoryId + '-content');
            const arrow = document.getElementById(categoryId + '-arrow');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.textContent = '▼';
                
            } else {
                content.style.display = 'none';
                arrow.textContent = '▶';
            }
        }
        
        function expandAllCalculators() {
            // Expand all categories first
            const categoryContents = document.querySelectorAll('.calc-category-content');
            categoryContents.forEach(content => {
                content.style.display = 'block';
                const categoryId = content.id.replace('-content', '');
                const arrow = document.getElementById(categoryId + '-arrow');
                if (arrow) arrow.textContent = '▼';
            });
            
            // Then expand all calculators
            calculatorRegistry.calculators.forEach(calc => {
                calc.expand();
                // Save individual states
                if (uiConfig.preferences.rememberCollapsedState) {
                    localStorage.setItem(`calc-${calc.id}-collapsed`, 'false');
                }
            });
        }
        
        function collapseAllCalculators() {
            // Collapse all calculators first
            calculatorRegistry.calculators.forEach(calc => {
                calc.collapse();
                // Save individual states
                if (uiConfig.preferences.rememberCollapsedState) {
                    localStorage.setItem(`calc-${calc.id}-collapsed`, 'true');
                }
            });
            
            // Then collapse all categories
            const categoryContents = document.querySelectorAll('.calc-category-content');
            categoryContents.forEach(content => {
                content.style.display = 'none';
                const categoryId = content.id.replace('-content', '');
                const arrow = document.getElementById(categoryId + '-arrow');
                if (arrow) arrow.textContent = '▶';
            });
        }

        function calculateBoardFeet() {
            const species = document.getElementById('bfSpecies').value;
            const customSpecies = document.getElementById('bfCustomSpecies').value;
            const price = parseFloat(document.getElementById('bfPrice').value) || 0;
            
            // Use smart input values if available, otherwise fall back to legacy inputs
            let thickness = currentBfThicknessInches;
            if (thickness === 0) {
                thickness = parseFloat(document.getElementById('bfThickness').value) || 0;
            }
            
            let width = currentBfWidthInches;
            if (width === 0) {
                width = parseFloat(document.getElementById('bfWidth').value) || 0;
            }
            
            let length = currentBfLengthInches;
            if (length === 0) {
                length = parseFloat(document.getElementById('bfLength').value) || 0;
            }
            const quantity = parseFloat(document.getElementById('bfQuantity').value) || 1;
            const resultDiv = document.getElementById('boardFootResult');
            
            
            // Validate inputs - prevent negative numbers
            if (thickness < 0 || width < 0 || length < 0 || quantity < 0 || price < 0) {
                resultDiv.innerHTML = '<div class="result-placeholder">Please enter positive numbers only</div>';
                updateBoardDiagram(0, 0, 0, 0);
                return;
            }
            
            if (thickness === 0 || width === 0 || length === 0) {
                resultDiv.innerHTML = '<div class="result-placeholder">Enter dimensions above</div>';
                updateBoardDiagram(0, 0, 0, 0);
                return;
            }
            
            const boardFeet = (thickness * width * length * quantity) / 144;
            const totalCubicInches = thickness * width * length * quantity;
            const lineTotal = boardFeet * price;
            
            // Determine display species name
            const displaySpecies = species === 'Custom' ? customSpecies : species;
            const speciesDisplay = displaySpecies ? `${displaySpecies} - ` : '';
            
            resultDiv.innerHTML = `
                <div class="result-value">${speciesDisplay}${boardFeet.toFixed(3)} board feet</div>
                <div class="result-details">
                    ${quantity} piece${quantity !== 1 ? 's' : ''} × ${thickness}" × ${width}" × ${length}"<br>
                    ${price > 0 ? `Price: $${price.toFixed(2)}/BF × ${boardFeet.toFixed(3)} BF = <strong>$${lineTotal.toFixed(2)}</strong><br>` : ''}
                    Total volume: ${totalCubicInches.toLocaleString()} cubic inches
                </div>
            `;
            
            // Update visual diagram
            updateBoardDiagram(thickness, width, length, quantity);
        }

        function updateBoardDiagram(thickness, width, length, quantity) {
            const lengthLabel = document.getElementById('lengthLabel');
            const widthLabel = document.getElementById('widthLabel');
            const thicknessLabel = document.getElementById('thicknessLabel');
            const frontFace = document.getElementById('frontFace');
            const topFace = document.getElementById('topFace');
            const rightFace = document.getElementById('rightFace');
            const grainLines = document.getElementById('grainLines');
            
            if (!lengthLabel || !widthLabel || !thicknessLabel) return;
            
            // Update labels with actual dimensions
            if (length > 0) lengthLabel.textContent = `Length: ${length}"`;
            if (width > 0) widthLabel.textContent = `Width: ${width}"`;
            if (thickness > 0) thicknessLabel.textContent = `Thickness: ${thickness}"`;
            
            // Scale the lumber piece based on dimensions (if all are provided)
            if (thickness > 0 && width > 0 && length > 0) {
                // Calculate scale factors (normalize to reasonable display sizes)
                const maxLength = 150;  // max pixel width for length
                const maxWidth = 80;    // max pixel height for width
                const maxThickness = 50; // max pixel depth for thickness
                
                const lengthScale = Math.min(maxLength / length, 1) * Math.max(0.3, length / 96); // 96" = 8ft max
                const widthScale = Math.min(maxWidth / width, 1) * Math.max(0.3, width / 12);   // 12" max width
                const thicknessScale = Math.min(maxThickness / thickness, 1) * Math.max(0.3, thickness / 4); // 4" max thickness
                
                const scaledLength = Math.max(60, lengthScale * 150);
                const scaledWidth = Math.max(30, widthScale * 80);
                const scaledThickness = Math.max(20, thicknessScale * 50);
                
                // Update front face
                if (frontFace) {
                    frontFace.setAttribute('width', scaledLength);
                    frontFace.setAttribute('height', scaledWidth);
                }
                
                // Update top face
                if (topFace) {
                    const path = `M 100 60 L ${100 + scaledLength} 60 L ${100 + scaledLength + scaledThickness} ${60 - scaledThickness} L ${100 + scaledThickness} ${60 - scaledThickness} Z`;
                    topFace.setAttribute('d', path);
                }
                
                // Update right face
                if (rightFace) {
                    const path = `M ${100 + scaledLength} 60 L ${100 + scaledLength + scaledThickness} ${60 - scaledThickness} L ${100 + scaledLength + scaledThickness} ${60 - scaledThickness + scaledWidth} L ${100 + scaledLength} ${60 + scaledWidth} Z`;
                    rightFace.setAttribute('d', path);
                }
                
                // Update grain lines
                if (grainLines) {
                    const lines = grainLines.querySelectorAll('line');
                    const spacing = scaledWidth / 4;
                    lines.forEach((line, index) => {
                        const y = 60 + (index + 1) * spacing;
                        line.setAttribute('x1', '100');
                        line.setAttribute('x2', 100 + scaledLength);
                        line.setAttribute('y1', y);
                        line.setAttribute('y2', y);
                    });
                }
                
                // Update interactive arrows to match scaled lumber
                const lengthArrow = document.getElementById('lengthArrow');
                const widthArrow = document.getElementById('widthArrow');
                const thicknessArrow = document.getElementById('thicknessArrow');
                const lengthLabel = document.getElementById('lengthLabel');
                const widthLabel = document.getElementById('widthLabel');
                const thicknessLabel = document.getElementById('thicknessLabel');
                
                // Update length arrow (horizontal, below lumber)
                if (lengthArrow) {
                    const arrowY = 60 + scaledWidth + 10;
                    const path = `M 100 ${arrowY} L ${100 + scaledLength} ${arrowY} M 100 ${arrowY} L 105 ${arrowY - 3} M 100 ${arrowY} L 105 ${arrowY + 3} M ${100 + scaledLength} ${arrowY} L ${100 + scaledLength - 5} ${arrowY - 3} M ${100 + scaledLength} ${arrowY} L ${100 + scaledLength - 5} ${arrowY + 3}`;
                    lengthArrow.setAttribute('d', path);
                }
                
                // Update length label position
                if (lengthLabel) {
                    lengthLabel.setAttribute('x', 100 + scaledLength / 2);
                    lengthLabel.setAttribute('y', 60 + scaledWidth + 25);
                }
                
                // Update width arrow (diagonal, following 3D perspective)
                if (widthArrow) {
                    const startX = 100 + scaledLength;
                    const startY = 60 + scaledWidth + 5;
                    const endX = 100 + scaledLength + scaledThickness;
                    const endY = 60 + scaledWidth + 5 - scaledThickness;
                    const path = `M ${startX} ${startY} L ${endX} ${endY} M ${startX} ${startY} L ${startX + 5} ${startY - 2} M ${startX} ${startY} L ${startX + 2} ${startY - 5} M ${endX} ${endY} L ${endX - 5} ${endY + 2} M ${endX} ${endY} L ${endX - 2} ${endY + 5}`;
                    widthArrow.setAttribute('d', path);
                }
                
                // Update width label position
                if (widthLabel) {
                    const midX = 100 + scaledLength + scaledThickness / 2;
                    const midY = 60 + scaledWidth + 15;
                    widthLabel.setAttribute('x', midX);
                    widthLabel.setAttribute('y', midY);
                }
                
                // Update thickness arrow (vertical, on left side)
                if (thicknessArrow) {
                    const arrowX = 80;
                    const path = `M ${arrowX} 60 L ${arrowX} ${60 + scaledWidth} M ${arrowX} 60 L ${arrowX - 3} 65 M ${arrowX} 60 L ${arrowX + 3} 65 M ${arrowX} ${60 + scaledWidth} L ${arrowX - 3} ${60 + scaledWidth - 5} M ${arrowX} ${60 + scaledWidth} L ${arrowX + 3} ${60 + scaledWidth - 5}`;
                    thicknessArrow.setAttribute('d', path);
                }
                
                // Update thickness label position
                if (thicknessLabel) {
                    thicknessLabel.setAttribute('y', 60 + scaledWidth / 2);
                }
                
                // Add quantity indicator
                if (quantity > 1) {
                    let qtyLabel = document.getElementById('quantityLabel');
                    if (!qtyLabel) {
                        qtyLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                        qtyLabel.id = 'quantityLabel';
                        qtyLabel.setAttribute('text-anchor', 'end');
                        qtyLabel.setAttribute('font-size', '12');
                        qtyLabel.setAttribute('font-weight', 'bold');
                        qtyLabel.setAttribute('fill', '#333');
                        document.querySelector('#lumber3d').appendChild(qtyLabel);
                    }
                    qtyLabel.setAttribute('x', 100 + scaledLength + scaledThickness + 10);
                    qtyLabel.setAttribute('y', 70);
                    qtyLabel.textContent = `×${quantity}`;
                } else {
                    const qtyLabel = document.getElementById('quantityLabel');
                    if (qtyLabel) qtyLabel.remove();
                }
            }
        }

        let currentGoldenMode = 'short'; // Default mode: short to long
        
        function setGoldenMode(mode) {
            currentGoldenMode = mode;
            document.getElementById('goldenModeShort').classList.toggle('active', mode === 'short');
            document.getElementById('goldenModeLong').classList.toggle('active', mode === 'long');
            
            const label = document.getElementById('goldenInputLabel');
            label.textContent = mode === 'short' ? 'Known dimension (short):' : 'Known dimension (long):';
            
            calculateGoldenRatioNew(); // Recalculate with new mode
        }
        
        function clearGoldenRatio() {
            // Clear smart input
            document.getElementById('smartGoldenRatio').value = '';
            
            // Clear preview
            const preview = document.getElementById('smartGoldenRatioPreview');
            if (preview) {
                preview.style.display = 'none';
                preview.innerHTML = '';
            }
            
            // Reset result display
            document.getElementById('grResult').innerHTML = 'Enter a dimension to calculate';
            
            // Clear any stored value
            currentGoldenRatioInches = 0;
            
            // Clear legacy inputs (for backward compatibility)
            document.getElementById('grFeet').value = '';
            document.getElementById('grInches').value = '';
            document.getElementById('grFraction').value = '0';
        }

        // Smart input callback for Golden Ratio calculator
        let currentGoldenRatioInches = 0;
        
        function updateGoldenRatioValue(inches, display) {
            currentGoldenRatioInches = inches;
            calculateGoldenRatioNew();
        }

        // Smart input callbacks for Shelf & Division Calculator
        let currentShelfLengthInches = 0;
        let currentShelfThicknessInches = 0.75; // Default to 3/4"
        let currentDesiredSpacingInches = 0;
        let shelfCalculationMode = 'count'; // 'count' or 'spacing'

        function updateShelfLengthValue(inches, display) {
            currentShelfLengthInches = inches;
            calculateSpacing();
        }

        function updateShelfThicknessValue(inches, display) {
            currentShelfThicknessInches = inches;
            calculateSpacing();
        }
        
        function updateDesiredSpacingValue(inches, display) {
            currentDesiredSpacingInches = inches;
            calculateSpacing();
        }

        // Smart input callbacks for Basic Calculator
        let currentInput1Inches = 0;
        let currentInput2Inches = 0;

        function updateInput1Value(inches, display) {
            currentInput1Inches = inches;
            
            // If the display contains an equals sign, it's a calculated expression result
            // Show it directly in the result area instead of treating it as input 1
            if (display && display.includes('=')) {
                const resultElement = document.getElementById('calcResult');
                const equationElement = document.getElementById('calcEquation');
                if (resultElement && equationElement) {
                    // Extract the calculation part and result
                    const parts = display.split('=');
                    if (parts.length === 2) {
                        // Style factors in a lighter purple for visibility on dark background
                        const styledEquation = parts[0].trim().replace(
                            /<factor>(.*?)<\/factor>/g, 
                            '<span style="color: #CE93D8; font-weight: bold;">$1</span>'
                        );
                        equationElement.innerHTML = styledEquation;
                        resultElement.textContent = '= ' + parts[1].trim();
                        return; // Don't call updateCalculation for expression results
                    }
                }
            }
            
            updateCalculation();
        }

        function updateInput2Value(inches, display) {
            currentInput2Inches = inches;
            updateCalculation();
        }

        // Smart input callbacks for Lumber Shopping Cart
        let currentBfThicknessInches = 0;
        let currentBfWidthInches = 0;
        let currentBfLengthInches = 0;
        
        // Smart input callbacks for other calculators
        let currentGoldenDimension = 0;
        let currentMiterBoardWidth = 0;

        function updateBfThicknessValue(inches, display) {
            currentBfThicknessInches = inches;
            calculateBoardFeet();
        }

        function updateBfWidthValue(inches, display) {
            currentBfWidthInches = inches;
            calculateBoardFeet();
        }

        function updateBfLengthValue(inches, display) {
            currentBfLengthInches = inches;
            calculateBoardFeet();
        }

        // Smart input callbacks for Miter Angle Calculator
        let currentSingleBoardWidthInches = 0;
        let currentSingleInputLengthInches = 0;
        let currentFrameMaterialWidthInches = 0;
        let currentFrameWidthInches = 0;
        let currentFrameHeightInches = 0;
        let currentFramePolygonInches = 0;

        function updateSingleBoardWidthValue(inches, display) {
            currentSingleBoardWidthInches = inches;
            calculateSingleMiter();
        }

        function updateSingleInputLengthValue(inches, display) {
            currentSingleInputLengthInches = inches;
            calculateSingleMiter();
        }

        function updateFrameMaterialWidthValue(inches, display) {
            currentFrameMaterialWidthInches = inches;
            calculateFrameBuilder();
        }

        function updateFrameWidthValue(inches, display) {
            currentFrameWidthInches = inches;
            calculateFrameBuilder();
        }

        function updateFrameHeightValue(inches, display) {
            currentFrameHeightInches = inches;
            calculateFrameBuilder();
        }

        function updateFramePolygonValue(inches, display) {
            currentFramePolygonInches = inches;
            calculateFrameBuilder();
        }

        // Smart input callbacks for Grade/Slope Calculator
        let currentGradeRiseInches = 0;
        let currentGradeRunInches = 0;

        function updateGradeRiseValue(inches, display) {
            currentGradeRiseInches = inches;
            calculateGradeSlope();
        }

        function updateGradeRunValue(inches, display) {
            currentGradeRunInches = inches;
            calculateGradeSlope();
        }

        // Smart input callbacks for Tile & Paver Calculator
        let currentTileLengthInches = 0;
        let currentTileWidthInches = 0;
        let currentTileOffsetInches = 0;

        function updateTileLengthValue(inches, display) {
            currentTileLengthInches = inches;
            calculateSimpleTiles();
        }

        function updateTileWidthValue(inches, display) {
            currentTileWidthInches = inches;
            calculateSimpleTiles();
        }
        
        function updateTileOffsetValue(inches, display) {
            currentTileOffsetInches = inches;
            calculateSimpleTiles();
        }

        // Smart input callbacks for Cut Calculator
        let currentCutLengthInches = 0;

        function updateCutLengthValue(inches, display) {
            currentCutLengthInches = inches;
            updateCutValue();
        }

        // Smart input callbacks for Cut Optimization
        let currentBoardLengthInches = 0;
        let currentOptCutLengthInches = 0;

        function updateBoardLengthValue(inches, display) {
            currentBoardLengthInches = inches;
            // Note: addBoard() function will read this value when called
        }

        function updateOptCutLengthValue(inches, display) {
            currentOptCutLengthInches = inches;
            // Note: addCut() function will read this value when called
        }

        function calculateGoldenRatioNew() {
            // Use smart input value if available, otherwise fall back to legacy inputs
            let input = currentGoldenRatioInches;
            if (input === 0) {
                input = getInputInches('grFeet', 'grInches', 'grFraction');
            }
            
            const resultDiv = document.getElementById('grResult');
            
            if (input === 0) {
                resultDiv.innerHTML = '<div class="result-placeholder">Enter a dimension above</div>';
                updateGoldenRectangle(0, 0);
                return;
            }
            
            const phi = 1.618033988749895;
            let result, description;
            
            if (currentGoldenMode === 'short') {
                result = input * phi;
                description = `If short side is ${inchesToDisplay(input)}, long side should be ${inchesToDisplay(result)}`;
                updateGoldenRectangle(input, result);
            } else {
                result = input / phi;
                description = `If long side is ${inchesToDisplay(input)}, short side should be ${inchesToDisplay(result)}`;
                updateGoldenRectangle(result, input);
            }
            
            resultDiv.innerHTML = `
                <div class="result-value">${inchesToDisplay(result)}</div>
                <div class="result-details">${description}<br>Ratio: 1:1.618 (φ)</div>
            `;
        }

        function updateGoldenRectangle(short, long) {
            // The SVG diagram is now static - we don't need to update it dynamically
            // The visual representation shows the conceptual 1:1.618 ratio
            return;
        }

        function setShelfMode(mode) {
            shelfCalculationMode = mode;
            
            // Update button states
            document.getElementById('shelfModeCount').classList.toggle('active', mode === 'count');
            document.getElementById('shelfModeSpacing').classList.toggle('active', mode === 'spacing');
            
            // Show/hide appropriate inputs
            document.getElementById('shelfCountInput').style.display = mode === 'count' ? 'block' : 'none';
            document.getElementById('shelfSpacingInput').style.display = mode === 'spacing' ? 'block' : 'none';
            
            // Recalculate if we have data
            calculateSpacing();
        }
        
        function updateShelfThickness() {
            const select = document.getElementById('shelfThicknessSelect');
            const customRow = document.getElementById('customThicknessRow');
            
            if (select.value === 'custom') {
                customRow.style.display = 'block';
            } else {
                customRow.style.display = 'none';
                if (select.value === 'none') {
                    currentShelfThicknessInches = 0;
                } else {
                    currentShelfThicknessInches = parseFloat(select.value);
                }
                calculateSpacing();
            }
        }
        
        function clearShelfCalculator() {
            // Clear inputs
            document.getElementById('smartShelfLength').value = '';
            document.getElementById('previewShelfLength').innerHTML = '';
            document.getElementById('spNumShelves').value = '';
            document.getElementById('smartDesiredSpacing').value = '';
            document.getElementById('previewDesiredSpacing').innerHTML = '';
            document.getElementById('shelfThicknessSelect').value = '0.75';
            document.getElementById('smartShelfThickness').value = '';
            document.getElementById('previewShelfThickness').innerHTML = '';
            document.getElementById('customThicknessRow').style.display = 'none';
            
            // Reset state variables
            currentShelfLengthInches = 0;
            currentShelfThicknessInches = 0.75;
            currentDesiredSpacingInches = 0;
            
            // Reset to count mode
            setShelfMode('count');
            
            // Clear results
            document.getElementById('spResult').innerHTML = '<div class="result-placeholder">Enter dimensions to calculate</div>';
            updateSpacingDiagram(0, 0, 0, 0);
        }

        function calculateSpacing() {
            // Use smart input values if available, otherwise fall back to legacy inputs
            let totalLength = currentShelfLengthInches;
            if (totalLength === 0) {
                totalLength = getInputInches('spTotalLengthFeet', 'spTotalLengthInches', 'spTotalLengthFraction');
            }
            
            let thickness = currentShelfThicknessInches;
            const resultDiv = document.getElementById('spResult');
            
            // Handle different calculation modes
            let numShelves = 0;
            let spacing = 0;
            
            if (shelfCalculationMode === 'count') {
                numShelves = parseInt(document.getElementById('spNumShelves').value) || 0;
                
                if (totalLength === 0 || numShelves === 0) {
                    resultDiv.innerHTML = '<div class="result-placeholder">Enter total length and number of shelves</div>';
                    updateSpacingDiagram(0, 0, 0, 0);
                    return;
                }
            } else { // spacing mode
                spacing = currentDesiredSpacingInches;
                
                if (totalLength === 0 || spacing === 0) {
                    resultDiv.innerHTML = '<div class="result-placeholder">Enter total length and desired spacing</div>';
                    updateSpacingDiagram(0, 0, 0, 0);
                    return;
                }
                
                // Calculate number of shelves that fit with given spacing
                const availableLength = totalLength - spacing; // Account for first space
                const shelfPlusSpace = thickness + spacing;
                
                if (shelfPlusSpace > 0) {
                    numShelves = Math.floor(availableLength / shelfPlusSpace);
                }
                
                if (numShelves <= 0) {
                    resultDiv.innerHTML = '<div class="result-warning">Spacing too large for cabinet length</div>';
                    updateSpacingDiagram(0, 0, 0, 0);
                    return;
                }
            }
            
            // Convert shelves to spaces: N shelves = N+1 spaces
            const numSpaces = numShelves + 1;
            let shelfInfo, description;
            
            // Calculate spacing if not already known (count mode)
            if (shelfCalculationMode === 'count') {
                if (thickness === 0) {
                    // Simple shelf spacing without thickness
                    spacing = totalLength / numSpaces;
                } else {
                    // Account for shelf thickness
                    const totalThickness = numShelves * thickness;
                    const availableSpace = totalLength - totalThickness;
                    
                    if (availableSpace < 0) {
                        resultDiv.innerHTML = '<div class="result-warning">Shelves too thick for total length!</div>';
                        updateSpacingDiagram(0, 0, 0, 0);
                        return;
                    }
                    
                    spacing = availableSpace / numSpaces;
                }
            }
            
            // Generate the display based on thickness
            if (thickness === 0) {
                const centerMarks = Array.from({length: numShelves}, (_, i) => inchesToDisplay((i + 1) * spacing, 'calculator'));
                
                resultDiv.innerHTML = `
                    <div class="result-value">${inchesToDisplay(spacing, 'calculator')} per space</div>
                    <div class="result-summary">
                        <div class="summary-row">
                            <span class="summary-label">Total Length:</span>
                            <span class="summary-value">${inchesToDisplay(totalLength, 'calculator')}</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Shelves:</span>
                            <span class="summary-value">${numShelves} shelves (${numSpaces} spaces)</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Material:</span>
                            <span class="summary-value">No thickness (center marks)</span>
                        </div>
                    </div>
                    ${centerMarks.length > 0 ? `
                    <div class="divider-marks">
                        <div class="marks-header">📐 Shelf Center Marking Guide:</div>
                        ${centerMarks.map((mark, i) => `
                            <div class="divider-mark-row">
                                <span class="divider-label">Shelf ${i + 1}:</span>
                                <span class="mark-center">Center ${mark}</span>
                            </div>
                        `).join('')}
                    </div>` : ''}
                `;
            } else {
                
                // Calculate shelf positions (left and right edges)
                shelfInfo = [];
                let currentPos = 0;
                
                for (let i = 0; i < numShelves; i++) {
                    currentPos += spacing; // Move to end of space
                    const leftEdge = currentPos;
                    const rightEdge = currentPos + thickness;
                    shelfInfo.push({
                        number: i + 1,
                        bottomEdge: inchesToDisplay(leftEdge, 'calculator'),
                        topEdge: inchesToDisplay(rightEdge, 'calculator')
                    });
                    currentPos += thickness; // Move past shelf
                }
                
                const modeText = shelfCalculationMode === 'spacing' ? 
                    ` (fits ${numShelves} shelves with ${inchesToDisplay(spacing, 'calculator')} spacing)` : '';
                
                resultDiv.innerHTML = `
                    <div class="result-value">${inchesToDisplay(spacing, 'calculator')} per space${modeText}</div>
                    <div class="result-summary">
                        <div class="summary-row">
                            <span class="summary-label">Total Length:</span>
                            <span class="summary-value">${inchesToDisplay(totalLength, 'calculator')}</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Shelves:</span>
                            <span class="summary-value">${numShelves} @ ${inchesToDisplay(thickness, 'calculator')} thick</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Spaces:</span>
                            <span class="summary-value">${numSpaces} @ ${inchesToDisplay(spacing, 'calculator')} each</span>
                        </div>
                        ${shelfCalculationMode === 'spacing' ? `
                        <div class="summary-row" style="color: var(--primary-color); font-weight: bold;">
                            <span class="summary-label">Mode:</span>
                            <span class="summary-value">Calculated by desired spacing</span>
                        </div>` : ''}
                    </div>
                    <div class="divider-marks">
                        <div class="marks-header">📏 Shelf Marking Guide:</div>
                        ${shelfInfo.map(shelf => `
                            <div class="divider-mark-row">
                                <span class="divider-label">Shelf ${shelf.number}:</span>
                                <span class="mark-left">Bottom ${shelf.bottomEdge}</span>
                                <span class="mark-right">Top ${shelf.topEdge}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Update visual spacing diagram
            updateSpacingDiagram(totalLength, numSpaces, spacing, thickness, numShelves);
        }

        function updateSpacingDiagram(total, spaces, spacing, thickness = 0, numShelves = 0) {
            const cabinetFrame = document.getElementById('cabinetFrame');
            const shelvesGroup = document.getElementById('shelvesGroup');
            const measurementsGroup = document.getElementById('measurementsGroup');
            
            if (!cabinetFrame || !shelvesGroup || !measurementsGroup) return;
            
            // Clear previous content
            shelvesGroup.innerHTML = '';
            
            if (total === 0 || spaces === 0) {
                // Show default state - larger dimensions for new viewBox
                cabinetFrame.innerHTML = `
                    <rect x="200" y="80" width="250" height="500" fill="url(#cabinetWood)" stroke="var(--primary-color)" stroke-width="4" rx="8"/>
                    <text x="325" y="340" text-anchor="middle" font-size="20" fill="#666">
                        Enter dimensions to see cabinet layout
                    </text>
                `;
                measurementsGroup.innerHTML = `
                    <text x="180" y="90" text-anchor="end" font-size="16" fill="var(--primary-color)" font-weight="bold">0"</text>
                    <text x="180" y="590" text-anchor="end" font-size="16" fill="var(--primary-color)" font-weight="bold">Total</text>
                `;
                return;
            }
            
            // Calculate cabinet dimensions - much larger for better visibility
            const cabinetHeight = 500;
            const cabinetWidth = 250;
            const cabinetX = 200;
            const cabinetY = 80;
            const scale = cabinetHeight / total;
            
            // Update cabinet frame
            cabinetFrame.innerHTML = `
                <rect x="${cabinetX}" y="${cabinetY}" width="${cabinetWidth}" height="${cabinetHeight}" 
                      fill="url(#cabinetWood)" stroke="var(--primary-color)" stroke-width="4" rx="8"/>
            `;
            
            // Update measurements with more reference lines
            let measurementLines = `
                <text x="180" y="90" text-anchor="end" font-size="16" fill="var(--primary-color)" font-weight="bold">0"</text>
                <text x="180" y="590" text-anchor="end" font-size="16" fill="var(--primary-color)" font-weight="bold">${inchesToDisplay(total)}</text>
                <line x1="185" y1="80" x2="195" y2="80" stroke="var(--primary-color)" stroke-width="3"/>
                <line x1="185" y1="580" x2="195" y2="580" stroke="var(--primary-color)" stroke-width="3"/>
            `;
            
            if (thickness === 0) {
                // Simple shelf spacing without thickness - show center marks with better detail
                for (let i = 1; i < spaces; i++) {
                    const position = cabinetY + (i * spacing * scale);
                    
                    // Shelf mark line with extension
                    shelvesGroup.innerHTML += `
                        <line x1="${cabinetX}" y1="${position}" x2="${cabinetX + cabinetWidth}" y2="${position}" 
                              stroke="#dc3545" stroke-width="4"/>
                        <line x1="${cabinetX + cabinetWidth}" y1="${position}" x2="${cabinetX + cabinetWidth + 40}" y2="${position}" 
                              stroke="#dc3545" stroke-width="3"/>
                        <text x="${cabinetX + cabinetWidth + 50}" y="${position + 7}" 
                              font-size="16" fill="#dc3545" font-weight="bold">
                              Shelf ${i}: ${inchesToDisplay(i * spacing)}
                        </text>
                    `;
                    
                    // Add measurement line
                    measurementLines += `
                        <line x1="185" y1="${position}" x2="195" y2="${position}" stroke="#dc3545" stroke-width="3"/>
                        <text x="175" y="${position + 7}" text-anchor="end" font-size="14" fill="#dc3545" font-weight="bold">${inchesToDisplay(i * spacing)}</text>
                    `;
                }
                
                // Add space labels with better styling
                for (let i = 0; i < spaces; i++) {
                    const centerPos = cabinetY + (i * spacing + spacing / 2) * scale;
                    shelvesGroup.innerHTML += `
                        <rect x="${cabinetX + cabinetWidth/2 - 35}" y="${centerPos - 16}" width="70" height="32" 
                              fill="rgba(40, 167, 69, 0.15)" stroke="#28a745" stroke-width="2" rx="8"/>
                        <text x="${cabinetX + cabinetWidth/2}" y="${centerPos + 4}" 
                              text-anchor="middle" font-size="16" font-weight="bold" fill="#28a745">
                              Space ${i + 1}
                        </text>
                        <text x="${cabinetX + cabinetWidth/2}" y="${centerPos - 22}" 
                              text-anchor="middle" font-size="13" fill="#28a745">
                              ${inchesToDisplay(spacing)}
                        </text>
                    `;
                }
            } else {
                // Show shelves with thickness and guaranteed non-overlapping labels
                let currentPos = 0;
                let shelves = [];
                
                // Calculate all shelf positions first
                for (let i = 0; i < numShelves; i++) {
                    currentPos += spacing;
                    const shelfTop = cabinetY + (currentPos * scale);
                    const shelfBottom = cabinetY + ((currentPos + thickness) * scale);
                    
                    shelves.push({
                        shelfNum: i + 1,
                        topPos: currentPos,
                        bottomPos: currentPos + thickness,
                        shelfTop: shelfTop,
                        shelfBottom: shelfBottom
                    });
                    
                    currentPos += thickness;
                }
                
                // Use simple sequential positioning with guaranteed spacing
                let nextAvailableLabelY = cabinetY + 40; // Start well below cabinet top
                const guaranteedSpacing = 50; // Guaranteed minimum space between labels
                
                for (let shelf of shelves) {
                    // Draw shelf
                    shelvesGroup.innerHTML += `
                        <rect x="${cabinetX}" y="${shelf.shelfTop}" width="${cabinetWidth}" height="${shelf.shelfBottom - shelf.shelfTop}" 
                              fill="#8B4513" stroke="#654321" stroke-width="3"/>
                        
                        <!-- Shelf thickness indicator -->
                        <text x="${cabinetX + cabinetWidth/2}" y="${shelf.shelfTop + (shelf.shelfBottom - shelf.shelfTop)/2 + 7}" 
                              text-anchor="middle" font-size="14" font-weight="bold" fill="white">
                              ${inchesToDisplay(thickness)} thick
                        </text>
                    `;
                    
                    // Calculate label positions - try to use actual shelf position, but ensure no overlap
                    let topLabelY = Math.max(shelf.shelfTop, nextAvailableLabelY);
                    let bottomLabelY = topLabelY + 22; // Bottom label 22px below top label
                    
                    // Top edge marking
                    shelvesGroup.innerHTML += `
                        <line x1="${cabinetX + cabinetWidth}" y1="${shelf.shelfTop}" x2="${cabinetX + cabinetWidth + 30}" y2="${shelf.shelfTop}" 
                              stroke="#654321" stroke-width="3"/>
                        <line x1="${cabinetX + cabinetWidth + 30}" y1="${shelf.shelfTop}" x2="${cabinetX + cabinetWidth + 40}" y2="${topLabelY}" 
                              stroke="#654321" stroke-width="2" stroke-dasharray="2,2"/>
                        <text x="${cabinetX + cabinetWidth + 50}" y="${topLabelY + 6}" 
                              font-size="15" fill="#654321" font-weight="bold">
                              Shelf ${shelf.shelfNum} Top: ${inchesToDisplay(shelf.topPos)}
                        </text>
                    `;
                    
                    // Bottom edge marking
                    shelvesGroup.innerHTML += `
                        <line x1="${cabinetX + cabinetWidth}" y1="${shelf.shelfBottom}" x2="${cabinetX + cabinetWidth + 60}" y2="${shelf.shelfBottom}" 
                              stroke="#654321" stroke-width="3"/>
                        <line x1="${cabinetX + cabinetWidth + 60}" y1="${shelf.shelfBottom}" x2="${cabinetX + cabinetWidth + 70}" y2="${bottomLabelY}" 
                              stroke="#654321" stroke-width="2" stroke-dasharray="2,2"/>
                        <text x="${cabinetX + cabinetWidth + 80}" y="${bottomLabelY + 6}" 
                              font-size="15" fill="#654321" font-weight="bold">
                              Shelf ${shelf.shelfNum} Bottom: ${inchesToDisplay(shelf.bottomPos)}
                        </text>
                    `;
                    
                    // Add measurement reference lines
                    measurementLines += `
                        <line x1="185" y1="${shelf.shelfTop}" x2="195" y2="${shelf.shelfTop}" stroke="#654321" stroke-width="3"/>
                        <line x1="185" y1="${shelf.shelfBottom}" x2="195" y2="${shelf.shelfBottom}" stroke="#654321" stroke-width="2"/>
                        <text x="175" y="${shelf.shelfTop + 6}" text-anchor="end" font-size="13" fill="#654321" font-weight="bold">${inchesToDisplay(shelf.topPos)}</text>
                    `;
                    
                    // Update next available position
                    nextAvailableLabelY = bottomLabelY + guaranteedSpacing;
                }
                
                // Add space labels between shelves with better detail
                currentPos = 0;
                for (let i = 0; i < spaces; i++) {
                    const spaceStart = cabinetY + (currentPos * scale);
                    currentPos += spacing;
                    const spaceEnd = cabinetY + (currentPos * scale);
                    const spaceCenterY = (spaceStart + spaceEnd) / 2;
                    
                    shelvesGroup.innerHTML += `
                        <rect x="${cabinetX + cabinetWidth/2 - 40}" y="${spaceCenterY - 20}" width="80" height="40" 
                              fill="rgba(40, 167, 69, 0.1)" stroke="#28a745" stroke-width="2" rx="8"/>
                        <text x="${cabinetX + cabinetWidth/2}" y="${spaceCenterY + 2}" 
                              text-anchor="middle" font-size="15" font-weight="bold" fill="#28a745">
                              Space ${i + 1}
                        </text>
                        <text x="${cabinetX + cabinetWidth/2}" y="${spaceCenterY + 18}" 
                              text-anchor="middle" font-size="13" fill="#28a745">
                              ${inchesToDisplay(spacing)} clear
                        </text>
                    `;
                    
                    if (i < numShelves) currentPos += thickness;
                }
            }
            
            measurementsGroup.innerHTML = measurementLines;
        }

        // Removed old updateSpacingDiagram function - replaced with SVG version above

        // Species Price Memory Functions
        function handleSpeciesChange() {
            const species = document.getElementById('bfSpecies').value;
            const customSpeciesRow = document.getElementById('customSpeciesRow');
            const priceInput = document.getElementById('bfPrice');
            
            // Handle custom species dropdown toggle
            if (species === 'Custom') {
                customSpeciesRow.style.display = 'block';
            } else {
                customSpeciesRow.style.display = 'none';
            }
            
            // Auto-fill remembered price for this specific species, or clear if no price saved
            if (species && species !== 'Custom') {
                if (speciesPrices[species]) {
                    priceInput.value = speciesPrices[species].toFixed(2);
                    showNotification(`Auto-filled price: $${speciesPrices[species].toFixed(2)}/BF`);
                } else {
                    priceInput.value = ''; // Clear price field for species with no saved price
                    priceInput.placeholder = 'Enter price/BF';
                }
            } else if (species === 'Custom') {
                priceInput.value = ''; // Always clear price for custom species
                priceInput.placeholder = 'Enter price/BF';
            }
            
            // Recalculate with new species/price
            calculateBoardFeet();
        }

        // Lumber Cart Management Functions
        function addToLumberCart() {
            const species = document.getElementById('bfSpecies').value;
            const customSpecies = document.getElementById('bfCustomSpecies').value;
            const price = parseFloat(document.getElementById('bfPrice').value) || 0;
            
            // Use smart input values
            const thickness = currentBfThicknessInches || parseFloat(document.getElementById('bfThickness').value) || 0;
            const width = currentBfWidthInches || parseFloat(document.getElementById('bfWidth').value) || 0;
            const lengthInInches = currentBfLengthInches || parseFloat(document.getElementById('bfLength').value) || 0;
            const quantity = parseFloat(document.getElementById('bfQuantity').value) || 1;
            
            // Validate required fields
            if (!species || (species === 'Custom' && !customSpecies.trim())) {
                showNotification('Please select a wood species');
                return;
            }
            
            if (thickness <= 0 || width <= 0 || lengthInInches <= 0 || quantity <= 0) {
                showNotification('Please enter valid dimensions and quantity');
                return;
            }
            
            if (price <= 0) {
                showNotification('Please enter a valid price per board foot');
                return;
            }
            
            // Calculate board feet and line total (using length in inches)
            const boardFeet = (thickness * width * lengthInInches * quantity) / 144;
            const lineTotal = boardFeet * price;
            const displaySpecies = species === 'Custom' ? customSpecies.trim() : species;
            
            // Create cart item
            const cartItem = {
                id: Date.now(), // Simple unique ID
                species: displaySpecies,
                thickness,
                width,
                length: lengthInInches, // Store length in inches
                quantity,
                pricePerBF: price,
                boardFeet,
                lineTotal
            };
            
            // Remember price for this species (for price memory feature)
            speciesPrices[displaySpecies] = price;
            
            // Add to cart
            lumberCart.push(cartItem);
            
            // Update cart display
            updateCartDisplay();
            
            // Clear form for next item
            clearBoardFootForm();
            
            showNotification(`Added ${displaySpecies} to cart`);
        }

        function removeFromLumberCart(itemId) {
            lumberCart = lumberCart.filter(item => item.id !== itemId);
            updateCartDisplay();
            showNotification('Item removed from cart');
        }

        function clearLumberCart() {
            if (lumberCart.length === 0) return;
            
            if (confirm('Clear all items from cart?')) {
                lumberCart = [];
                updateCartDisplay();
                showNotification('Cart cleared');
            }
        }

        function clearBoardFootForm() {
            // Clear dropdowns and inputs
            document.getElementById('bfSpecies').value = '';
            document.getElementById('bfCustomSpecies').value = '';
            document.getElementById('bfPrice').value = '';
            document.getElementById('bfQuantity').value = '1';
            document.getElementById('customSpeciesRow').style.display = 'none';
            
            // Clear smart inputs
            document.getElementById('smartBfThickness').value = '';
            document.getElementById('smartBfWidth').value = '';
            document.getElementById('smartBfLength').value = '';
            
            // Clear preview displays
            document.getElementById('previewBfThickness').innerHTML = '';
            document.getElementById('previewBfWidth').innerHTML = '';
            document.getElementById('previewBfLength').innerHTML = '';
            
            // Clear legacy inputs
            document.getElementById('bfThickness').value = '';
            document.getElementById('bfWidth').value = '';
            document.getElementById('bfLength').value = '';
            
            // Reset smart input values
            currentBfThicknessInches = 0;
            currentBfWidthInches = 0;
            currentBfLengthInches = 0;
            
            // Clear result display
            document.getElementById('boardFootResult').innerHTML = '<div class="result-placeholder">Enter item details above</div>';
        }

        // OLD POLYGON MODE FUNCTION - KEPT FOR REFERENCE BUT NO LONGER USED
        /*
        function calculateMiterAngle() {
            const sides = parseInt(document.getElementById('maSides').value) || 0;
            const resultDiv = document.getElementById('maResult');
            
            if (sides < 3) {
                resultDiv.innerHTML = '<div class="result-placeholder">Enter number of sides (minimum 3)</div>';
                return;
            }
            
            const interiorAngle = ((sides - 2) * 180) / sides;
            const miterAngle = (180 - interiorAngle) / 2;
            const tableAngle = 90 - miterAngle;
            
            resultDiv.innerHTML = `
                <div class="result-value">${miterAngle.toFixed(2)}° miter cut</div>
                <div class="result-details">
                    Interior angle: ${interiorAngle.toFixed(1)}°<br>
                    Table saw angle: ${tableAngle.toFixed(2)}°<br>
                    Each piece needs ${miterAngle.toFixed(2)}° cut on both ends
                </div>
            `;
            
            // Update visual diagram
            updateMiterDiagram();
        }
        */

        // OLD POLYGON DIAGRAM FUNCTION - NO LONGER USED
        /*
        function updatePolygonDiagram(sides, miterAngle) {
            const polygon = document.getElementById('miterPolygon');
            const miterAnglesGroup = document.getElementById('miterAngles');
            const sidesLabel = document.getElementById('sidesLabel');
            const angleLabel = document.getElementById('angleLabel');
            
            if (!polygon || !miterAnglesGroup) return;
            
            const radius = 60;
            
            // Calculate polygon points
            let points = '';
            let vertices = [];
            for (let i = 0; i < sides; i++) {
                const angle = (i * 2 * Math.PI) / sides - Math.PI / 2;
                const x = radius * Math.cos(angle);
                const y = radius * Math.sin(angle);
                points += `${x},${y} `;
                vertices.push({x, y, angle});
            }
            
            // Update polygon
            polygon.setAttribute('points', points.trim());
            
            // Clear and regenerate miter angle indicators
            miterAnglesGroup.innerHTML = '';
            
            // Generate miter joint details for first few corners
            for (let i = 0; i < Math.min(sides, 4); i++) {
                const vertex = vertices[i];
                const nextVertex = vertices[(i + 1) % sides];
                
                // Draw miter cut indication at each corner
                const miterLength = 15;
                const angleToNext = Math.atan2(nextVertex.y - vertex.y, nextVertex.x - vertex.x);
                const angleToPrev = Math.atan2(vertices[(i - 1 + sides) % sides].y - vertex.y, vertices[(i - 1 + sides) % sides].x - vertex.x);
                
                const miterX1 = vertex.x + miterLength * Math.cos(angleToNext);
                const miterY1 = vertex.y + miterLength * Math.sin(angleToNext);
                const miterX2 = vertex.x + miterLength * Math.cos(angleToPrev);
                const miterY2 = vertex.y + miterLength * Math.sin(angleToPrev);
                
                miterAnglesGroup.innerHTML += `<line x1="${vertex.x}" y1="${vertex.y}" x2="${miterX1}" y2="${miterY1}" stroke="#dc3545" stroke-width="2" stroke-dasharray="3,2"/>`;
                miterAnglesGroup.innerHTML += `<line x1="${vertex.x}" y1="${vertex.y}" x2="${miterX2}" y2="${miterY2}" stroke="#dc3545" stroke-width="2" stroke-dasharray="3,2"/>`;
                
                // Add corner numbers
                const labelOffset = 25;
                const labelX = vertex.x + labelOffset * Math.cos(vertex.angle);
                const labelY = vertex.y + labelOffset * Math.sin(vertex.angle);
                miterAnglesGroup.innerHTML += `<circle cx="${labelX}" cy="${labelY}" r="10" fill="#007bff" opacity="0.8"/>`;
                miterAnglesGroup.innerHTML += `<text x="${labelX}" y="${labelY + 4}" text-anchor="middle" font-size="10" font-weight="bold" fill="white">${i + 1}</text>`;
            }
            
            // Update labels
            if (sidesLabel) sidesLabel.textContent = `${sides} Sides`;
            if (angleLabel) angleLabel.textContent = `Miter Angle: ${miterAngle.toFixed(1)}°`;
        }
        */

        // Removed old updatePolygonDiagramOLD function - replaced with SVG version above

        // Species Price Memory Functions
        function handleSpeciesChange() {
            const species = document.getElementById('bfSpecies').value;
            const customSpeciesRow = document.getElementById('customSpeciesRow');
            const priceInput = document.getElementById('bfPrice');
            
            // Handle custom species dropdown toggle
            if (species === 'Custom') {
                customSpeciesRow.style.display = 'block';
            } else {
                customSpeciesRow.style.display = 'none';
            }
            
            // Auto-fill remembered price for this specific species, or clear if no price saved
            if (species && species !== 'Custom') {
                if (speciesPrices[species]) {
                    priceInput.value = speciesPrices[species].toFixed(2);
                    showNotification(`Auto-filled price: $${speciesPrices[species].toFixed(2)}/BF`);
                } else {
                    priceInput.value = ''; // Clear price field for species with no saved price
                    priceInput.placeholder = 'Enter price/BF';
                }
            } else if (species === 'Custom') {
                priceInput.value = ''; // Always clear price for custom species
                priceInput.placeholder = 'Enter price/BF';
            }
            
            // Recalculate with new species/price
            calculateBoardFeet();
        }

        function updateCartDisplay() {
            const cartContainer = document.getElementById('lumberCartDisplay');
            const cartHeader = document.getElementById('cartHeaderTitle');
            const clearBtn = document.getElementById('clearCartBtn');
            const saveBtn = document.getElementById('saveCartBtn');
            
            if (!cartContainer) return;
            
            // Update header with item count
            if (cartHeader) {
                cartHeader.textContent = lumberCart.length === 0 
                    ? '🛒 Shopping Cart' 
                    : `🛒 Shopping Cart (${lumberCart.length} item${lumberCart.length !== 1 ? 's' : ''})`;
            }
            
            // Show/hide clear button
            if (clearBtn) {
                clearBtn.style.display = lumberCart.length === 0 ? 'none' : 'block';
            }
            
            // Enable/disable save button
            if (saveBtn) {
                saveBtn.disabled = lumberCart.length === 0;
            }
            
            if (lumberCart.length === 0) {
                cartContainer.innerHTML = '<div class="result-placeholder">No items in cart</div>';
                return;
            }
            
            let totalBoardFeet = 0;
            let totalCost = 0;
            
            let cartHTML = '';
            
            lumberCart.forEach(item => {
                totalBoardFeet += item.boardFeet;
                totalCost += item.lineTotal;
                
                cartHTML += `
                    <div class="cart-item" style="background: #f8f9fa; padding: 12px; margin-bottom: 10px; border-radius: 6px;">
                        <div class="cart-item-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <strong style="color: var(--primary-color);">${item.species}</strong>
                            <button onclick="removeFromLumberCart(${item.id})" style="background: #dc3545; color: white; border: none; border-radius: 3px; padding: 4px 10px; cursor: pointer; font-weight: bold;">×</button>
                        </div>
                        <div class="cart-item-details" style="font-size: 14px; color: #666; margin-bottom: 4px;">
                            ${item.quantity} pc${item.quantity !== 1 ? 's' : ''} × ${item.thickness}" × ${item.width}" × ${item.length}"
                        </div>
                        <div class="cart-item-pricing" style="font-size: 14px;">
                            ${item.boardFeet.toFixed(3)} BF × $${item.pricePerBF.toFixed(2)}/BF = <strong style="color: var(--primary-color);">$${item.lineTotal.toFixed(2)}</strong>
                        </div>
                    </div>
                `;
            });
            
            cartHTML += `
                <div class="cart-summary" style="background: #e8f5e9; border: 2px solid #4CAF50; border-radius: 6px; padding: 15px; margin-top: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-weight: 600;">Total Board Feet:</span>
                        <strong>${totalBoardFeet.toFixed(3)} BF</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 18px;">
                        <span style="font-weight: 600;">Total Cost:</span>
                        <strong style="color: var(--primary-color);">$${totalCost.toFixed(2)}</strong>
                    </div>
                </div>
            `;
            
            cartContainer.innerHTML = cartHTML;
            
            // Enable/disable save cart button
            const saveCartBtn = document.getElementById('saveCartBtn');
            if (saveCartBtn) {
                saveCartBtn.disabled = lumberCart.length === 0;
            }
        }


        function saveLumberCartToProject() {
            if (lumberCart.length === 0) {
                showNotification('Cart is empty');
                return;
            }
            
            let totalBoardFeet = 0;
            let totalCost = 0;
            let cartSummary = '';
            
            lumberCart.forEach((item, index) => {
                totalBoardFeet += item.boardFeet;
                totalCost += item.lineTotal;
                
                cartSummary += `${index + 1}. ${item.species} - `;
                cartSummary += `${item.quantity} pc${item.quantity !== 1 ? 's' : ''} × ${item.thickness}" × ${item.width}" × ${item.length}" `;
                cartSummary += `(${item.boardFeet.toFixed(3)} BF × $${item.pricePerBF.toFixed(2)}/BF = $${item.lineTotal.toFixed(2)})\n`;
            });
            
            const previewContent = `
                <div class="save-preview-lumber">
                    <div class="preview-header">
                        <strong>🛒 Lumber Shopping Cart</strong>
                    </div>
                    <div class="preview-summary">
                        <strong>Total: ${totalBoardFeet.toFixed(3)} BF - $${totalCost.toFixed(2)}</strong>
                    </div>
                    <div class="preview-details">
                        ${cartSummary.replace(/\n/g, '<br>')}
                    </div>
                </div>
            `;
            
            const saveData = {
                tool: 'lumber',
                equation: `Lumber Cart: ${lumberCart.length} items`,
                result: `${totalBoardFeet.toFixed(3)} BF - $${totalCost.toFixed(2)}`,
                details: {
                    items: [...lumberCart],
                    totalBoardFeet: totalBoardFeet.toFixed(3),
                    totalCost: totalCost.toFixed(2),
                    itemCount: lumberCart.length
                },
                preview: previewContent
            };
            
            showSaveToProjectModal(saveData);
        }

        function saveBoardFeetToHistory() {
            const thickness = parseFloat(document.getElementById('bfThickness').value) || 0;
            const width = parseFloat(document.getElementById('bfWidth').value) || 0;
            const length = parseFloat(document.getElementById('bfLength').value) || 0;
            const quantity = parseFloat(document.getElementById('bfQuantity').value) || 1;
            
            if (thickness === 0 || width === 0 || length === 0) {
                showNotification('Enter dimensions first');
                return;
            }
            
            const boardFeet = (thickness * width * length * quantity) / 144;
            
        }

        function saveGoldenRatioToHistory() {
            const input = getInputInches('grFeet', 'grInches', 'grFraction');
            
            if (input === 0) {
                showNotification('Enter a dimension first');
                return;
            }
            
            const phi = 1.618033988749895;
            let shortSide, longSide, equation;
            
            if (currentGoldenMode === 'short') {
                shortSide = input;
                longSide = input * phi;
                equation = `Golden Ratio: Short ${inchesToDisplay(shortSide)} → Long ${inchesToDisplay(longSide)}`;
            } else {
                longSide = input;
                shortSide = input / phi;
                equation = `Golden Ratio: Long ${inchesToDisplay(longSide)} → Short ${inchesToDisplay(shortSide)}`;
            }
            
        }
        
        function saveGoldenRatioToProject() {
            const input = getInputInches('grFeet', 'grInches', 'grFraction');
            
            if (input === 0) {
                showNotification('Enter a dimension first', 'warning');
                return;
            }
            
            const phi = 1.618033988749895;
            let shortSide, longSide, equation, details;
            
            if (currentGoldenMode === 'short') {
                shortSide = input;
                longSide = input * phi;
                equation = `Golden Ratio: Short ${inchesToDisplay(shortSide)} → Long ${inchesToDisplay(longSide)}`;
                details = `Input (short side): ${inchesToDisplay(shortSide)}\nGolden ratio result (long side): ${inchesToDisplay(longSide)}\nRatio: 1:1.618 (φ = golden ratio)`;
            } else {
                longSide = input;
                shortSide = input / phi;
                equation = `Golden Ratio: Long ${inchesToDisplay(longSide)} → Short ${inchesToDisplay(shortSide)}`;
                details = `Input (long side): ${inchesToDisplay(longSide)}\nGolden ratio result (short side): ${inchesToDisplay(shortSide)}\nRatio: 1.618:1 (φ = golden ratio)`;
            }
            
            const data = {
                equation: equation,
                result: `Long: ${inchesToDisplay(longSide)}, Short: ${inchesToDisplay(shortSide)}`,
                details: details
            };
            
            showSaveToProjectModal('Golden Ratio Calculator', data, 'goldenDiagramContainer');
        }

        // OLD POLYGON MODE FUNCTION - NO LONGER USED
        /*
        function setAngleSides(sides) {
            document.getElementById('maSides').value = sides;
            calculateMiterAngle();
        }
        */

        let currentMiterMode = 'frame'; // Default mode: frame builder
        
        function clearMiterCalculator() {
            // Clear all inputs based on current mode
            if (currentMiterMode === 'frame') {
                // Clear frame inputs
                document.getElementById('smartFrameMaterialWidth').value = '';
                document.getElementById('smartFrameWidth').value = '';
                document.getElementById('smartFrameHeight').value = '';
                document.getElementById('smartFramePolygon').value = '';
                
                // Clear previews
                const framePreviews = ['previewFrameMaterialWidth', 'previewFrameWidth', 'previewFrameHeight', 'previewFramePolygon'];
                framePreviews.forEach(id => {
                    const preview = document.getElementById(id);
                    if (preview) {
                        preview.style.display = 'none';
                        preview.innerHTML = '';
                    }
                });
                
                // Clear stored values
                currentFrameMaterialWidthInches = 0;
                currentFrameWidthInches = 0;
                currentFrameHeightInches = 0;
                currentFramePolygonInches = 0;
                
                // Clear legacy inputs
                ['frameMaterialWidthFeet', 'frameMaterialWidthInches', 'frameWidthFeet', 'frameWidthInches', 
                 'frameHeightFeet', 'frameHeightInches', 'framePolygonFeet', 'framePolygonInches'].forEach(id => {
                    const elem = document.getElementById(id);
                    if (elem) elem.value = '';
                });
                
                ['frameMaterialWidthFraction', 'frameWidthFraction', 'frameHeightFraction', 'framePolygonFraction'].forEach(id => {
                    const elem = document.getElementById(id);
                    if (elem) elem.value = '0';
                });
                
                // Reset frame shape
                document.getElementById('frameShapeSides').value = '4';
                document.getElementById('frameDimensionType').value = 'outer';
                updateFrameDimensionLabels();
                
            } else if (currentMiterMode === 'single') {
                // Clear single board inputs
                document.getElementById('singleMiterAngle').value = '';
                document.getElementById('smartSingleBoardWidth').value = '';
                document.getElementById('smartSingleInputLength').value = '';
                
                // Clear previews
                const singlePreviews = ['previewSingleBoardWidth', 'previewSingleInputLength'];
                singlePreviews.forEach(id => {
                    const preview = document.getElementById(id);
                    if (preview) {
                        preview.style.display = 'none';
                        preview.innerHTML = '';
                    }
                });
                
                // Clear stored values
                currentSingleBoardWidthInches = 0;
                currentSingleInputLengthInches = 0;
                
                // Clear legacy inputs
                ['singleBoardWidthFeet', 'singleBoardWidthInches', 'singleInputLengthFeet', 'singleInputLengthInches'].forEach(id => {
                    const elem = document.getElementById(id);
                    if (elem) elem.value = '';
                });
                
                ['singleBoardWidthFraction', 'singleInputLengthFraction'].forEach(id => {
                    const elem = document.getElementById(id);
                    if (elem) elem.value = '0';
                });
                
                // Reset selects
                document.getElementById('singleCutType').value = 'one-sided';
                document.getElementById('singleKnownSide').value = 'long';
            }
            
            // Clear result display
            document.getElementById('maResult').innerHTML = 'Select mode and enter dimensions';
            
            // Update diagram
            updateMiterDiagram();
        }
        
        function setMiterMode(mode) {
            currentMiterMode = mode;
            document.getElementById('miterModeFrame').classList.toggle('active', mode === 'frame');
            document.getElementById('miterModeSingle').classList.toggle('active', mode === 'single');
            
            const frameInputs = document.getElementById('frameMiterInputs');
            const singleInputs = document.getElementById('singleMiterInputs');
            
            // Clear all preview elements when switching modes
            document.querySelectorAll('#angleCard .input-preview').forEach(preview => {
                preview.style.display = 'none';
                preview.innerHTML = '';
            });
            
            if (mode === 'frame') {
                frameInputs.style.display = 'block';
                singleInputs.style.display = 'none';
                updateFrameDimensionLabels();
                calculateFrameBuilder();
            } else {
                frameInputs.style.display = 'none';
                singleInputs.style.display = 'block';
                calculateSingleMiter();
            }
            
            // Update miter diagram
            updateMiterDiagram();
        }

        function updateMiterDiagram() {
            const diagram = document.getElementById('angleDiagramContainer');
            if (!diagram) return;
            
            // Clear any existing content first
            diagram.innerHTML = '';
            
            if (currentMiterMode === 'frame') {
                // Get all frame parameters
                const sides = parseInt(document.getElementById('frameShapeSides').value) || 4;
                const miterAngle = 180 / sides;
                const tableAngle = 90 - miterAngle;
                const dimensionType = document.getElementById('frameDimensionType').value;
                
                // Get material width
                let materialWidth = currentFrameMaterialWidthInches > 0 ? 
                    currentFrameMaterialWidthInches : 
                    getInputInches('frameMaterialWidthFeet', 'frameMaterialWidthInches', 'frameMaterialWidthFraction');
                
                // Create responsive SVG with proper viewport
                const svgWidth = 450;
                const svgHeight = 300;
                const centerX = svgWidth / 2;
                const centerY = svgHeight / 2;
                
                // Calculate frame dimensions for display
                let frameWidth, frameHeight, sideLength;
                if (sides === 4) {
                    frameWidth = currentFrameWidthInches > 0 ? currentFrameWidthInches : 
                        getInputInches('frameWidthFeet', 'frameWidthInches', 'frameWidthFraction');
                    frameHeight = currentFrameHeightInches > 0 ? currentFrameHeightInches :
                        getInputInches('frameHeightFeet', 'frameHeightInches', 'frameHeightFraction');
                } else {
                    sideLength = currentFramePolygonInches > 0 ? currentFramePolygonInches :
                        getInputInches('framePolygonFeet', 'framePolygonInches', 'framePolygonFraction');
                }
                
                // Scale factor for visualization
                const maxDimension = sides === 4 ? Math.max(frameWidth || 12, frameHeight || 12) : (sideLength || 12);
                const scale = Math.min(150 / maxDimension, 10); // Limit scale for very small frames
                const displayThickness = Math.max(materialWidth * scale * 0.7, 8); // Visual thickness
                
                let svg = `
                    <svg width="${svgWidth}" height="${svgHeight}" viewBox="0 0 ${svgWidth} ${svgHeight}" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <!-- Blueprint grid pattern -->
                            <pattern id="frameGrid" width="20" height="20" patternUnits="userSpaceOnUse">
                                <rect width="20" height="20" fill="#f8f9fa"/>
                                <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#e0e0e0" stroke-width="0.5"/>
                            </pattern>
                            <!-- Wood grain texture -->
                            <pattern id="woodGrain" patternUnits="userSpaceOnUse" width="100" height="100">
                                <rect width="100" height="100" fill="#D2691E"/>
                                <path d="M0,20 Q25,15 50,20 T100,20" stroke="#B8860B" stroke-width="1" opacity="0.4"/>
                                <path d="M0,40 Q30,35 60,40 T100,40" stroke="#A0522D" stroke-width="1.5" opacity="0.3"/>
                                <path d="M0,60 Q20,55 40,60 T100,60" stroke="#B8860B" stroke-width="1" opacity="0.4"/>
                                <path d="M0,80 Q35,75 70,80 T100,80" stroke="#8B4513" stroke-width="2" opacity="0.3"/>
                            </pattern>
                            <!-- Drop shadow filter -->
                            <filter id="dropshadow" x="-50%" y="-50%" width="200%" height="200%">
                                <feGaussianBlur in="SourceAlpha" stdDeviation="3"/>
                                <feOffset dx="2" dy="2" result="offsetblur"/>
                                <feComponentTransfer>
                                    <feFuncA type="linear" slope="0.3"/>
                                </feComponentTransfer>
                                <feMerge>
                                    <feMergeNode/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>
                        </defs>
                        
                        <!-- Background -->
                        <rect width="${svgWidth}" height="${svgHeight}" fill="url(#frameGrid)"/>`;
                
                // Calculate frame corners based on shape
                if (sides === 4) {
                    // Rectangle/Square specific rendering
                    const displayWidth = (frameWidth || 12) * scale;
                    const displayHeight = (frameHeight || 12) * scale;
                    const halfThickness = displayThickness / 2;
                    
                    // Calculate miter cut points for each corner
                    const corners = [
                        { x: centerX - displayWidth/2, y: centerY - displayHeight/2, angle: 0 },    // Top-left
                        { x: centerX + displayWidth/2, y: centerY - displayHeight/2, angle: 90 },   // Top-right
                        { x: centerX + displayWidth/2, y: centerY + displayHeight/2, angle: 180 },  // Bottom-right
                        { x: centerX - displayWidth/2, y: centerY + displayHeight/2, angle: 270 }   // Bottom-left
                    ];
                    
                    // Draw frame pieces with proper miter cuts
                    const pieces = [
                        { // Top piece
                            outer: `M ${corners[0].x - halfThickness} ${corners[0].y - halfThickness} 
                                    L ${corners[1].x + halfThickness} ${corners[1].y - halfThickness}
                                    L ${corners[1].x - halfThickness} ${corners[1].y + halfThickness}
                                    L ${corners[0].x + halfThickness} ${corners[0].y + halfThickness} Z`,
                            label: { x: centerX, y: corners[0].y - halfThickness - 15, 
                                    text: inchesToDisplay(frameWidth || 0, 'calculator') }
                        },
                        { // Right piece
                            outer: `M ${corners[1].x + halfThickness} ${corners[1].y - halfThickness}
                                    L ${corners[2].x + halfThickness} ${corners[2].y + halfThickness}
                                    L ${corners[2].x - halfThickness} ${corners[2].y - halfThickness}
                                    L ${corners[1].x - halfThickness} ${corners[1].y + halfThickness} Z`,
                            label: { x: corners[1].x + halfThickness + 20, y: centerY, 
                                    text: inchesToDisplay(frameHeight || 0, 'calculator'), rotate: 90 }
                        },
                        { // Bottom piece
                            outer: `M ${corners[2].x + halfThickness} ${corners[2].y + halfThickness}
                                    L ${corners[3].x - halfThickness} ${corners[3].y + halfThickness}
                                    L ${corners[3].x + halfThickness} ${corners[3].y - halfThickness}
                                    L ${corners[2].x - halfThickness} ${corners[2].y - halfThickness} Z`,
                            label: { x: centerX, y: corners[2].y + halfThickness + 20, 
                                    text: inchesToDisplay(frameWidth || 0, 'calculator') }
                        },
                        { // Left piece
                            outer: `M ${corners[3].x - halfThickness} ${corners[3].y + halfThickness}
                                    L ${corners[0].x - halfThickness} ${corners[0].y - halfThickness}
                                    L ${corners[0].x + halfThickness} ${corners[0].y + halfThickness}
                                    L ${corners[3].x + halfThickness} ${corners[3].y - halfThickness} Z`,
                            label: { x: corners[3].x - halfThickness - 20, y: centerY, 
                                    text: inchesToDisplay(frameHeight || 0, 'calculator'), rotate: -90 }
                        }
                    ];
                    
                    // Draw each frame piece
                    pieces.forEach((piece, i) => {
                        svg += `
                            <path d="${piece.outer}" 
                                fill="url(#woodGrain)" 
                                stroke="#654321" 
                                stroke-width="2" 
                                filter="url(#dropshadow)"/>`;
                    });
                    
                    // Add dimension labels for long sides
                    pieces.forEach((piece, i) => {
                        const transform = piece.label.rotate ? 
                            `rotate(${piece.label.rotate} ${piece.label.x} ${piece.label.y})` : '';
                        svg += `
                            <text x="${piece.label.x}" y="${piece.label.y}" 
                                text-anchor="middle" 
                                font-size="12" 
                                font-weight="bold" 
                                fill="#333"
                                transform="${transform}">
                                ${piece.label.text}
                            </text>`;
                    });
                    
                    // Calculate and add short side dimensions (inside dimensions)
                    const shortWidth = frameWidth - 2 * (materialWidth / scale);
                    const shortHeight = frameHeight - 2 * (materialWidth / scale);
                    
                    // Add short side labels with different styling
                    if (dimensionType === 'inside') {
                        // When showing inside dimensions, the short sides are actually the frameWidth/Height minus the material
                        svg += `
                            <text x="${centerX}" y="${centerY - displayHeight/2 + 15}" 
                                text-anchor="middle" 
                                font-size="10" 
                                font-style="italic"
                                fill="#666">
                                (${inchesToDisplay(frameWidth - 2 * materialWidth)} short)
                            </text>
                            <text x="${centerX + displayWidth/2 - 35}" y="${centerY}" 
                                text-anchor="middle" 
                                font-size="10" 
                                font-style="italic"
                                fill="#666"
                                transform="rotate(90 ${centerX + displayWidth/2 - 35} ${centerY})">
                                (${inchesToDisplay(frameHeight - 2 * materialWidth)} short)
                            </text>`;
                    } else {
                        // When showing outside dimensions, calculate inside short dimensions
                        svg += `
                            <text x="${centerX}" y="${centerY - displayHeight/2 + 15}" 
                                text-anchor="middle" 
                                font-size="10" 
                                font-style="italic"
                                fill="#666">
                                (${inchesToDisplay(frameWidth)} short)
                            </text>
                            <text x="${centerX + displayWidth/2 - 35}" y="${centerY}" 
                                text-anchor="middle" 
                                font-size="10" 
                                font-style="italic"
                                fill="#666"
                                transform="rotate(90 ${centerX + displayWidth/2 - 35} ${centerY})">
                                (${inchesToDisplay(frameHeight)} short)
                            </text>`;
                    }
                    
                    // For rectangles, we'll just show dimensions, no redundant angle indicators
                    
                } else {
                    // Polygon rendering (triangle, hexagon, etc.)
                    const radius = (sideLength || 12) * scale / (2 * Math.sin(Math.PI / sides));
                    
                    // Calculate vertices
                    let vertices = [];
                    for (let i = 0; i < sides; i++) {
                        const angle = (i / sides) * 2 * Math.PI - Math.PI / 2;
                        vertices.push({
                            x: centerX + radius * Math.cos(angle),
                            y: centerY + radius * Math.sin(angle),
                            angle: angle
                        });
                    }
                    
                    // Draw frame pieces
                    for (let i = 0; i < sides; i++) {
                        const v1 = vertices[i];
                        const v2 = vertices[(i + 1) % sides];
                        const midX = (v1.x + v2.x) / 2;
                        const midY = (v1.y + v2.y) / 2;
                        
                        // Calculate piece endpoints with miter cuts
                        const angle = Math.atan2(v2.y - v1.y, v2.x - v1.x);
                        const perpAngle = angle + Math.PI / 2;
                        
                        const piece = `M ${v1.x - displayThickness/2 * Math.cos(perpAngle)} ${v1.y - displayThickness/2 * Math.sin(perpAngle)} L ${v2.x - displayThickness/2 * Math.cos(perpAngle)} ${v2.y - displayThickness/2 * Math.sin(perpAngle)} L ${v2.x + displayThickness/2 * Math.cos(perpAngle)} ${v2.y + displayThickness/2 * Math.sin(perpAngle)} L ${v1.x + displayThickness/2 * Math.cos(perpAngle)} ${v1.y + displayThickness/2 * Math.sin(perpAngle)} Z`;
                        
                        svg += `
                            <path d="${piece}" 
                                fill="url(#woodGrain)" 
                                stroke="#654321" 
                                stroke-width="2" 
                                filter="url(#dropshadow)"/>`;
                        
                        // Add side length label
                        svg += `
                            <text x="${midX}" y="${midY}" 
                                text-anchor="middle" 
                                font-size="11" 
                                font-weight="bold" 
                                fill="#333"
                                transform="rotate(${angle * 180 / Math.PI} ${midX} ${midY})">
                                ${inchesToDisplay(sideLength || 0, 'calculator')}
                            </text>`;
                    }
                    
                    // Add corner angles
                    vertices.forEach((v, i) => {
                        svg += `
                            <text x="${v.x}" y="${v.y}" 
                                text-anchor="middle" 
                                font-size="10" 
                                fill="#dc3545" 
                                font-weight="bold"
                                transform="translate(${-25 * Math.cos(v.angle)}, ${-25 * Math.sin(v.angle)})">
                                ${miterAngle.toFixed(1)}°
                            </text>`;
                    });
                }
                
                // Add title and info
                const shapeName = sides === 3 ? 'Triangle' : 
                                 sides === 4 ? 'Rectangle' :
                                 sides === 5 ? 'Pentagon' :
                                 sides === 6 ? 'Hexagon' :
                                 sides === 8 ? 'Octagon' : `${sides}-sided`;
                
                svg += `
                    <text x="${centerX}" y="25" text-anchor="middle" font-size="16" font-weight="bold" fill="var(--primary-color)">
                        ${shapeName} Frame - ${dimensionType === 'inner' ? 'Inner' : 'Outer'} Dimensions
                    </text>
                    <text x="${centerX}" y="${svgHeight - 20}" text-anchor="middle" font-size="13" fill="#666">
                        Material: ${inchesToDisplay(materialWidth || 0, 'calculator')} wide | 
                        Miter Angle: ${miterAngle.toFixed(1)}°
                    </text>
                </svg>`;
                
                diagram.innerHTML = svg;
                
            } else if (currentMiterMode === 'single') {
                // For single board mode, show the board cut diagram
                const angle = parseFloat(document.getElementById('singleMiterAngle').value) || 45;
                const boardWidth = currentSingleBoardWidthInches || 6;
                const cutType = document.getElementById('singleCutType').value || 'one-sided';
                
                // Use updateSingleMiterDiagram if it exists, otherwise create inline
                if (typeof updateSingleMiterDiagram === 'function') {
                    const knownSide = document.getElementById('singleKnownSide').value || 'long';
                    const inputLength = currentSingleInputLengthInches || 12;
                    const shortSide = knownSide === 'short' ? inputLength : inputLength - (boardWidth * Math.tan(angle * Math.PI / 180));
                    const longSide = knownSide === 'long' ? inputLength : inputLength + (boardWidth * Math.tan(angle * Math.PI / 180));
                    updateSingleMiterDiagram(angle, boardWidth, shortSide, longSide, cutType);
                } else {
                    // Create a simple board diagram for single cut mode
                    const svgWidth = 400;
                    const svgHeight = 200;
                    const boardLength = 300; // Larger board for better visibility
                    const displayWidth = Math.min(boardWidth * 10, 80); // Scale board width
                    
                    let svg = `
                        <svg width="${svgWidth}" height="${svgHeight}" viewBox="0 0 ${svgWidth} ${svgHeight}" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <pattern id="boardGrid" width="20" height="20" patternUnits="userSpaceOnUse">
                                    <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#e0e0e0" stroke-width="0.5"/>
                                </pattern>
                            </defs>
                            <rect width="${svgWidth}" height="${svgHeight}" fill="url(#boardGrid)" />`;
                    
                    const startX = (svgWidth - boardLength) / 2;
                    const startY = (svgHeight - displayWidth) / 2;
                    
                    // Draw board
                    svg += `
                        <rect x="${startX}" y="${startY}" width="${boardLength}" height="${displayWidth}" 
                            fill="#D2691E" stroke="#8B4513" stroke-width="2"/>`;
                    
                    // Draw cut line
                    if (cutType === 'one-sided') {
                        const cutX = startX + boardLength - 50;
                        const cutEndX = cutX - displayWidth * Math.tan(angle * Math.PI / 180);
                        svg += `
                            <line x1="${cutX}" y1="${startY}" x2="${cutEndX}" y2="${startY + displayWidth}" 
                                stroke="#ff0000" stroke-width="3" stroke-dasharray="5,5"/>`;
                        
                        // Add angle arc
                        svg += `
                            <path d="M ${cutX - 30} ${startY} A 30 30 0 0 0 ${cutX - 30 * Math.cos(angle * Math.PI / 180)} ${startY + 30 * Math.sin(angle * Math.PI / 180)}" 
                                fill="none" stroke="#ff6b6b" stroke-width="2"/>
                            <text x="${cutX - 40}" y="${startY + 20}" font-size="12" fill="#ff6b6b">${angle}°</text>`;
                    } else {
                        // Compound cut - show both ends
                        const cut1X = startX + 50;
                        const cut1EndX = cut1X + displayWidth * Math.tan(angle * Math.PI / 180);
                        const cut2X = startX + boardLength - 50;
                        const cut2EndX = cut2X - displayWidth * Math.tan(angle * Math.PI / 180);
                        
                        svg += `
                            <line x1="${cut1X}" y1="${startY}" x2="${cut1EndX}" y2="${startY + displayWidth}" 
                                stroke="#ff0000" stroke-width="3" stroke-dasharray="5,5"/>
                            <line x1="${cut2X}" y1="${startY}" x2="${cut2EndX}" y2="${startY + displayWidth}" 
                                stroke="#ff0000" stroke-width="3" stroke-dasharray="5,5"/>`;
                    }
                    
                    // Add labels
                    svg += `
                        <text x="${svgWidth / 2}" y="20" text-anchor="middle" font-size="14" font-weight="bold" fill="var(--primary-color)">
                            ${cutType === 'one-sided' ? 'Single' : 'Compound'} Miter Cut
                        </text>
                        <text x="${svgWidth / 2}" y="${svgHeight - 10}" text-anchor="middle" font-size="12" fill="#666">
                            Angle: ${angle}° | Board Width: ${inchesToFeet(boardWidth)}
                        </text>
                    </svg>`;
                    
                    diagram.innerHTML = svg;
                }
            }
        }

        function calculateSingleMiter() {
            const angle = parseFloat(document.getElementById('singleMiterAngle').value) || 0;
            
            // Use smart input values if available, otherwise fall back to legacy inputs
            let boardWidth;
            if (currentSingleBoardWidthInches > 0) {
                boardWidth = currentSingleBoardWidthInches;
            } else {
                boardWidth = getInputInches('singleBoardWidthFeet', 'singleBoardWidthInches', 'singleBoardWidthFraction');
            }
            
            const knownSide = document.getElementById('singleKnownSide').value;
            const cutType = document.getElementById('singleCutType').value;
            
            let inputLength;
            if (currentSingleInputLengthInches > 0) {
                inputLength = currentSingleInputLengthInches;
            } else {
                inputLength = getInputInches('singleInputLengthFeet', 'singleInputLengthInches', 'singleInputLengthFraction');
            }
            const resultDiv = document.getElementById('maResult');
            
            if (angle === 0 || boardWidth === 0 || inputLength === 0) {
                resultDiv.innerHTML = '<div class="result-placeholder">Enter all values above</div>';
                return;
            }
            
            const angleRad = (angle * Math.PI) / 180;
            const singleOffset = boardWidth * Math.tan(angleRad);
            const totalOffset = cutType === 'dual-sided' ? singleOffset * 2 : singleOffset;
            
            let shortSide, longSide;
            if (knownSide === 'long') {
                longSide = inputLength;
                shortSide = longSide - totalOffset;
            } else {
                shortSide = inputLength;
                longSide = shortSide + totalOffset;
            }
            
            const cutDescription = cutType === 'one-sided' ? 'Single Board Cut (One End)' : 'Single Board Cut (Both Ends)';
            const offsetDescription = cutType === 'one-sided' ? 
                `Offset: ${inchesToDisplay(singleOffset)} (one end)` : 
                `Total Offset: ${inchesToDisplay(totalOffset)} (${inchesToDisplay(singleOffset)} per end)`;
            
            resultDiv.innerHTML = `
                <div class="result-value">${angle}° ${cutDescription}</div>
                <div class="result-details">
                    Long side (back): ${inchesToDisplay(longSide, 'calculator')}<br>
                    Short side (front): ${inchesToDisplay(shortSide, 'calculator')}<br>
                    ${offsetDescription}
                </div>
            `;
            
            // Update label for the input
            const label = document.getElementById('singleInputLabel');
            label.textContent = knownSide === 'long' ? 'Long side length:' : 'Short side length:';
            
            // Update diagram to show single miter cut visualization
            updateSingleMiterDiagram(angle, boardWidth, shortSide, longSide, cutType);
        }

        function updateSingleMiterDiagram(angle, boardWidth, shortSide, longSide, cutType = 'one-sided') {
            const diagram = document.getElementById('angleDiagramContainer');
            if (!diagram) return;
            
            // Create enhanced visualization with proper dimensions
            const svgWidth = 450;
            const svgHeight = 300;
            const centerX = svgWidth / 2;
            const centerY = svgHeight / 2;
            
            // Calculate board dimensions and scale
            const maxBoardLength = Math.max(longSide, 24); // Minimum 24" for display
            const scale = Math.min(250 / maxBoardLength, 12); // Responsive scaling
            const boardLength = longSide * scale;
            const boardVisualWidth = Math.max(boardWidth * scale * 0.7, 60); // Visual board width
            const angleRad = angle * Math.PI / 180;
            
            // Position board in center
            const boardX = centerX - boardLength/2;
            const boardY = centerY - boardVisualWidth/2;
            
            // Calculate dynamic miter cut endpoints based on actual angle
            const cutHeight = boardVisualWidth;
            const cutOffset = cutHeight / Math.tan(angleRad); // How far the cut moves horizontally
            
            // Left cut coordinates (angled based on miter angle)
            const leftCutX1 = boardX;
            const leftCutY1 = boardY;
            const leftCutX2 = boardX + Math.abs(cutOffset);
            const leftCutY2 = boardY + boardVisualWidth;
            
            // Right cut coordinates (for dual-sided)
            const rightCutX1 = boardX + boardLength;
            const rightCutY1 = boardY;
            const rightCutX2 = boardX + boardLength - Math.abs(cutOffset);
            const rightCutY2 = boardY + boardVisualWidth;
            
            diagram.innerHTML = `
                <div style="text-align: center; margin: 0; padding: 10px;">
                    <svg width="${svgWidth}" height="${svgHeight}" viewBox="0 0 ${svgWidth} ${svgHeight}" style="display: block; margin: 0 auto; border: 1px solid #ddd; border-radius: 8px; background: #fafafa; max-width: 100%;">
                        <!-- Wood grain pattern definition -->
                        <defs>
                            <pattern id="singleBoardGrain" patternUnits="userSpaceOnUse" width="100" height="100">
                                <rect width="100" height="100" fill="#D2691E"/>
                                <path d="M0,20 Q25,15 50,20 T100,20" stroke="#B8860B" stroke-width="1" opacity="0.4"/>
                                <path d="M0,40 Q25,35 50,40 T100,40" stroke="#B8860B" stroke-width="1" opacity="0.3"/>
                                <path d="M0,60 Q25,55 50,60 T100,60" stroke="#B8860B" stroke-width="1" opacity="0.4"/>
                                <path d="M0,80 Q25,75 50,80 T100,80" stroke="#B8860B" stroke-width="1" opacity="0.3"/>
                            </pattern>
                            <filter id="dropShadow" x="-50%" y="-50%" width="200%" height="200%">
                                <feGaussianBlur in="SourceAlpha" stdDeviation="3"/>
                                <feOffset dx="2" dy="2" result="offsetblur"/>
                                <feComponentTransfer>
                                    <feFuncA type="linear" slope="0.2"/>
                                </feComponentTransfer>
                                <feMerge>
                                    <feMergeNode/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>
                        </defs>
                        
                        <!-- Board with 3D effect -->
                        <rect x="${boardX}" y="${boardY}" width="${boardLength}" height="${boardVisualWidth}" 
                              fill="url(#singleBoardGrain)" stroke="#8B4513" stroke-width="3" rx="2" filter="url(#dropShadow)"/>
                        
                        <!-- Dynamic miter cut lines based on actual angle -->
                        ${cutType === 'dual-sided' ? `
                            <!-- Left miter cut -->
                            <line x1="${leftCutX1}" y1="${leftCutY1}" x2="${leftCutX2}" y2="${leftCutY2}" 
                                  stroke="#dc3545" stroke-width="4" stroke-dasharray="5,3"/>
                            
                            <!-- Left angle indicator arc -->
                            <path d="M ${leftCutX1 + 30} ${leftCutY1} A 30 30 0 0 1 ${leftCutX1 + 30 * Math.cos(angleRad)} ${leftCutY1 + 30 * Math.sin(angleRad)}" 
                                  stroke="#dc3545" stroke-width="2" fill="none" stroke-dasharray="2,2"/>
                            <text x="${leftCutX1 + 40}" y="${leftCutY1 + 20}" font-size="12" fill="#dc3545" font-weight="bold">${angle}°</text>
                            
                            <!-- Right miter cut -->
                            <line x1="${rightCutX1}" y1="${rightCutY1}" x2="${rightCutX2}" y2="${rightCutY2}" 
                                  stroke="#dc3545" stroke-width="4" stroke-dasharray="5,3"/>
                            
                            <!-- Right angle indicator arc -->
                            <path d="M ${rightCutX1 - 30} ${rightCutY1} A 30 30 0 0 0 ${rightCutX1 - 30 * Math.cos(angleRad)} ${rightCutY1 + 30 * Math.sin(angleRad)}" 
                                  stroke="#dc3545" stroke-width="2" fill="none" stroke-dasharray="2,2"/>
                            <text x="${rightCutX1 - 50}" y="${rightCutY1 + 20}" font-size="12" fill="#dc3545" font-weight="bold">${angle}°</text>
                        ` : `
                            <!-- Single-sided cut (left side only) -->
                            <line x1="${leftCutX1}" y1="${leftCutY1}" x2="${leftCutX2}" y2="${leftCutY2}" 
                                  stroke="#dc3545" stroke-width="4" stroke-dasharray="5,3"/>
                            
                            <!-- Angle indicator arc -->
                            <path d="M ${leftCutX1 + 30} ${leftCutY1} A 30 30 0 0 1 ${leftCutX1 + 30 * Math.cos(angleRad)} ${leftCutY1 + 30 * Math.sin(angleRad)}" 
                                  stroke="#dc3545" stroke-width="2" fill="none" stroke-dasharray="2,2"/>
                            <text x="${leftCutX1 + 40}" y="${leftCutY1 + 20}" font-size="12" fill="#dc3545" font-weight="bold">${angle}°</text>
                            
                            <!-- Show straight right edge for one-sided -->
                            <line x1="${rightCutX1}" y1="${rightCutY1}" x2="${rightCutX1}" y2="${rightCutY2}" 
                                  stroke="#28a745" stroke-width="3"/>
                            <text x="${rightCutX1 + 10}" y="${centerY}" text-anchor="start" font-size="11" fill="#28a745" font-weight="bold">
                                90°
                            </text>
                        `}
                        
                        <!-- Title with cut type -->
                        <text x="${centerX}" y="25" text-anchor="middle" font-size="18" font-weight="bold" fill="var(--primary-color)">
                            ${angle}° Miter ${cutType === 'one-sided' ? 'One-End' : 'Both-Ends'} Cut
                        </text>
                        
                        <!-- Long side dimension on top with extension line -->
                        <line x1="${boardX}" y1="${boardY - 15}" 
                              x2="${boardX + boardLength}" y2="${boardY - 15}" 
                              stroke="#333" stroke-width="1"/>
                        <line x1="${boardX}" y1="${boardY - 10}" 
                              x2="${boardX}" y2="${boardY - 20}" 
                              stroke="#333" stroke-width="1"/>
                        <line x1="${boardX + boardLength}" y1="${boardY - 10}" 
                              x2="${boardX + boardLength}" y2="${boardY - 20}" 
                              stroke="#333" stroke-width="1"/>
                        <text x="${centerX}" y="${boardY - 25}" text-anchor="middle" font-size="14" font-weight="bold" fill="#333">
                            Long: ${inchesToDisplay(longSide)}
                        </text>
                        
                        <!-- Short side dimension on bottom with extension line -->
                        ${cutType === 'dual-sided' ? `
                            <!-- For dual-sided, measure between the two cut starts -->
                            <line x1="${leftCutX2}" y1="${boardY + boardVisualWidth + 15}" 
                                  x2="${rightCutX2}" y2="${boardY + boardVisualWidth + 15}" 
                                  stroke="#666" stroke-width="1"/>
                            <line x1="${leftCutX2}" y1="${boardY + boardVisualWidth + 10}" 
                                  x2="${leftCutX2}" y2="${boardY + boardVisualWidth + 20}" 
                                  stroke="#666" stroke-width="1"/>
                            <line x1="${rightCutX2}" y1="${boardY + boardVisualWidth + 10}" 
                                  x2="${rightCutX2}" y2="${boardY + boardVisualWidth + 20}" 
                                  stroke="#666" stroke-width="1"/>
                            <text x="${centerX}" y="${boardY + boardVisualWidth + 35}" text-anchor="middle" font-size="14" font-weight="bold" fill="#666">
                                Short: ${inchesToDisplay(shortSide)}
                            </text>
                        ` : `
                            <!-- For one-sided, measure from cut start to right edge -->
                            <line x1="${leftCutX2}" y1="${boardY + boardVisualWidth + 15}" 
                                  x2="${boardX + boardLength}" y2="${boardY + boardVisualWidth + 15}" 
                                  stroke="#666" stroke-width="1"/>
                            <line x1="${leftCutX2}" y1="${boardY + boardVisualWidth + 10}" 
                                  x2="${leftCutX2}" y2="${boardY + boardVisualWidth + 20}" 
                                  stroke="#666" stroke-width="1"/>
                            <line x1="${boardX + boardLength}" y1="${boardY + boardVisualWidth + 10}" 
                                  x2="${boardX + boardLength}" y2="${boardY + boardVisualWidth + 20}" 
                                  stroke="#666" stroke-width="1"/>
                            <text x="${(leftCutX2 + boardX + boardLength) / 2}" y="${boardY + boardVisualWidth + 35}" text-anchor="middle" font-size="14" font-weight="bold" fill="#666">
                                Short: ${inchesToDisplay(shortSide)}
                            </text>
                        `}
                        
                        <!-- Board width label on the board -->
                        <text x="${centerX}" y="${centerY + 4}" text-anchor="middle" font-size="12" font-weight="bold" fill="white" 
                              style="text-shadow: 1px 1px 2px rgba(0,0,0,0.7)">
                            ${inchesToDisplay(boardWidth)} wide
                        </text>
                        
                        <!-- Visual waste indicator -->
                        ${cutType === 'dual-sided' ? `
                            <polygon points="${leftCutX1},${leftCutY1} ${leftCutX2},${leftCutY2} ${leftCutX1},${leftCutY2}" 
                                     fill="#ffcccc" stroke="#dc3545" stroke-width="1" opacity="0.6"/>
                            <polygon points="${rightCutX1},${rightCutY1} ${rightCutX2},${rightCutY2} ${rightCutX1},${rightCutY2}" 
                                     fill="#ffcccc" stroke="#dc3545" stroke-width="1" opacity="0.6"/>
                            <text x="${leftCutX1 + 5}" y="${centerY}" font-size="9" fill="#dc3545" font-weight="bold" transform="rotate(${angle}, ${leftCutX1 + 5}, ${centerY})">
                                waste
                            </text>
                            <text x="${rightCutX1 - 25}" y="${centerY}" font-size="9" fill="#dc3545" font-weight="bold" transform="rotate(-${angle}, ${rightCutX1 - 25}, ${centerY})">
                                waste
                            </text>
                        ` : `
                            <polygon points="${leftCutX1},${leftCutY1} ${leftCutX2},${leftCutY2} ${leftCutX1},${leftCutY2}" 
                                     fill="#ffcccc" stroke="#dc3545" stroke-width="1" opacity="0.6"/>
                            <text x="${leftCutX1 + 5}" y="${centerY}" font-size="9" fill="#dc3545" font-weight="bold" transform="rotate(${angle}, ${leftCutX1 + 5}, ${centerY})">
                                waste
                            </text>
                        `}
                    </svg>
                </div>
            `;
        }

        // Frame Builder Functions
        function updateFrameDimensionLabels() {
            const dimensionType = document.getElementById('frameDimensionType').value;
            const sides = parseInt(document.getElementById('frameShapeSides').value);
            
            // Update labels based on inside/outside selection
            if (sides === 4) {
                // Rectangle/Square
                document.getElementById('frameWidthLabel').textContent = 
                    dimensionType === 'inside' ? 'Inside Width:' : 'Outside Width:';
                document.getElementById('frameHeightLabel').textContent = 
                    dimensionType === 'inside' ? 'Inside Height:' : 'Outside Height:';
                document.getElementById('frameRectangleDimensions').style.display = 'block';
                document.getElementById('framePolygonDimensions').style.display = 'none';
            } else {
                // Regular polygon
                document.getElementById('framePolygonLabel').textContent = 
                    dimensionType === 'inside' ? 'Inside Side Length:' : 'Outside Side Length:';
                document.getElementById('frameRectangleDimensions').style.display = 'none';
                document.getElementById('framePolygonDimensions').style.display = 'block';
            }
        }

        function calculateFrameBuilder() {
            const sides = parseInt(document.getElementById('frameShapeSides').value);
            
            // Use smart input values if available, otherwise fall back to legacy inputs
            let materialWidth;
            if (currentFrameMaterialWidthInches > 0) {
                materialWidth = currentFrameMaterialWidthInches;
            } else {
                materialWidth = getInputInches('frameMaterialWidthFeet', 'frameMaterialWidthInches', 'frameMaterialWidthFraction');
            }
            
            const dimensionType = document.getElementById('frameDimensionType').value;
            const resultDiv = document.getElementById('maResult');
            
            if (materialWidth === 0) {
                resultDiv.innerHTML = '<div class="result-placeholder">Enter material width</div>';
                return;
            }
            
            // Calculate miter angle for this polygon
            const interiorAngle = ((sides - 2) * 180) / sides;
            const miterAngle = (180 - interiorAngle) / 2;
            const miterRadians = (miterAngle * Math.PI) / 180;
            
            let cutList = '';
            let totalLinearFeet = 0;
            let insideDimensions = '';
            let outsideDimensions = '';
            
            if (sides === 4) {
                // Rectangle/Square frame
                let inputWidth, inputHeight;
                
                // Use smart input values if available, otherwise fall back to legacy inputs
                if (currentFrameWidthInches > 0) {
                    inputWidth = currentFrameWidthInches;
                } else {
                    inputWidth = getInputInches('frameWidthFeet', 'frameWidthInches', 'frameWidthFraction');
                }
                
                if (currentFrameHeightInches > 0) {
                    inputHeight = currentFrameHeightInches;
                } else {
                    inputHeight = getInputInches('frameHeightFeet', 'frameHeightInches', 'frameHeightFraction');
                }
                
                if (inputWidth === 0 || inputHeight === 0) {
                    resultDiv.innerHTML = '<div class="result-placeholder">Enter frame dimensions</div>';
                    return;
                }
                
                let insideWidth, insideHeight, outsideWidth, outsideHeight;
                
                // Calculate offset for miter joints
                const offset = materialWidth * Math.tan(miterRadians);
                
                if (dimensionType === 'inside') {
                    // User provided inside dimensions
                    insideWidth = inputWidth;
                    insideHeight = inputHeight;
                    outsideWidth = insideWidth + 2 * materialWidth;
                    outsideHeight = insideHeight + 2 * materialWidth;
                } else {
                    // User provided outside dimensions
                    outsideWidth = inputWidth;
                    outsideHeight = inputHeight;
                    insideWidth = outsideWidth - 2 * materialWidth;
                    insideHeight = outsideHeight - 2 * materialWidth;
                }
                
                // Calculate cut lengths (long side includes the offset on both ends)
                const horizontalCutLength = insideWidth + 2 * offset;
                const verticalCutLength = insideHeight + 2 * offset;
                
                // Create cut list with both inside and outside measurements for clarity
                cutList = `
                    <div class="cut-list">
                        <h4>Cut List:</h4>
                        <div class="cut-item">
                            <strong>2 horizontal pieces:</strong><br>
                            Cut Length: ${inchesToDisplay(horizontalCutLength)}<br>
                            <small>(Inside span: ${inchesToDisplay(insideWidth)}, Outside span: ${inchesToDisplay(outsideWidth)})</small>
                        </div>
                        <div class="cut-item">
                            <strong>2 vertical pieces:</strong><br>
                            Cut Length: ${inchesToDisplay(verticalCutLength)}<br>
                            <small>(Inside span: ${inchesToDisplay(insideHeight)}, Outside span: ${inchesToDisplay(outsideHeight)})</small>
                        </div>
                    </div>
                `;
                
                totalLinearFeet = ((horizontalCutLength * 2) + (verticalCutLength * 2)) / 12;
                insideDimensions = `${inchesToDisplay(insideWidth)} × ${inchesToDisplay(insideHeight)}`;
                outsideDimensions = `${inchesToDisplay(outsideWidth)} × ${inchesToDisplay(outsideHeight)}`;
                
            } else {
                // Regular polygon frame
                let inputSideLength;
                
                // Use smart input values if available, otherwise fall back to legacy inputs
                if (currentFramePolygonInches > 0) {
                    inputSideLength = currentFramePolygonInches;
                } else {
                    inputSideLength = getInputInches('framePolygonFeet', 'framePolygonInches', 'framePolygonFraction');
                }
                
                if (inputSideLength === 0) {
                    resultDiv.innerHTML = '<div class="result-placeholder">Enter polygon side length</div>';
                    return;
                }
                
                let insideSideLength, outsideSideLength;
                
                if (dimensionType === 'inside') {
                    insideSideLength = inputSideLength;
                    // For regular polygon, outside side length = inside + 2 * (material_width / tan((π-interior_angle)/2))
                    // Simplified: outside = inside + 2 * material_width / tan(miter_angle)
                    const sideWidthAddition = 2 * materialWidth / Math.tan(miterRadians);
                    outsideSideLength = insideSideLength + sideWidthAddition;
                } else {
                    outsideSideLength = inputSideLength;
                    const sideWidthAddition = 2 * materialWidth / Math.tan(miterRadians);
                    insideSideLength = outsideSideLength - sideWidthAddition;
                }
                
                const offset = materialWidth * Math.tan(miterRadians);
                const cutLength = insideSideLength + 2 * offset;
                
                cutList = `
                    <div class="cut-list">
                        <h4>Cut List:</h4>
                        <div class="cut-item">
                            <strong>${sides} pieces:</strong><br>
                            Cut Length: ${inchesToDisplay(cutLength)}<br>
                            <small>(Inside side: ${inchesToDisplay(insideSideLength)}, Outside side: ${inchesToDisplay(outsideSideLength)})</small>
                        </div>
                    </div>
                `;
                
                totalLinearFeet = (cutLength * sides) / 12;
                insideDimensions = `${inchesToDisplay(insideSideLength)} per side`;
                outsideDimensions = `${inchesToDisplay(outsideSideLength)} per side`;
            }
            
            resultDiv.innerHTML = `
                <div class="result-value">${miterAngle.toFixed(1)}° miter cut</div>
                <div class="result-details">
                    <strong>Inside:</strong> ${insideDimensions}<br>
                    <strong>Outside:</strong> ${outsideDimensions}<br>
                    <strong>Material needed:</strong> ${totalLinearFeet.toFixed(1)} linear feet
                </div>
                ${cutList}
            `;
            
            // Update diagram to show the frame shape
            updateMiterDiagram();
        }

        // OLD SAVE TO HISTORY FUNCTION - NO LONGER USED
        /*
        function saveAngleToHistory() {
            if (currentMiterMode === 'polygon') {
                const sides = parseInt(document.getElementById('maSides').value) || 0;
                
                if (sides < 3) {
                    showNotification('Enter number of sides first');
                    return;
                }
                
                const interiorAngle = ((sides - 2) * 180) / sides;
                const miterAngle = (180 - interiorAngle) / 2;
                
            } else if (currentMiterMode === 'frame') {
                const sides = parseInt(document.getElementById('frameShapeSides').value);
                
                // Use smart input values if available, otherwise fall back to legacy inputs
                let materialWidth;
                if (currentFrameMaterialWidthInches > 0) {
                    materialWidth = currentFrameMaterialWidthInches;
                } else {
                    materialWidth = getInputInches('frameMaterialWidthFeet', 'frameMaterialWidthInches', 'frameMaterialWidthFraction');
                }
                
                if (materialWidth === 0) {
                    showNotification('Enter frame details first');
                    return;
                }
                
                const interiorAngle = ((sides - 2) * 180) / sides;
                const miterAngle = (180 - interiorAngle) / 2;
                
                let frameName = '';
                if (sides === 4) frameName = 'Rectangle/Square';
                else if (sides === 3) frameName = 'Triangle';
                else if (sides === 6) frameName = 'Hexagon';
                else if (sides === 8) frameName = 'Octagon';
                else frameName = `${sides}-sided`;
                
                // Get dimensions summary
                let dimensionsSummary = '';
                if (sides === 4) {
                    // Use smart input values if available, otherwise fall back to legacy inputs
                    let width, height;
                    if (currentFrameWidthInches > 0) {
                        width = currentFrameWidthInches;
                    } else {
                        width = getInputInches('frameWidthFeet', 'frameWidthInches', 'frameWidthFraction');
                    }
                    if (currentFrameHeightInches > 0) {
                        height = currentFrameHeightInches;
                    } else {
                        height = getInputInches('frameHeightFeet', 'frameHeightInches', 'frameHeightFraction');
                    }
                    dimensionsSummary = `${inchesToDisplay(width)} × ${inchesToDisplay(height)}`;
                } else {
                    // Use smart input values if available, otherwise fall back to legacy inputs
                    let sideLength;
                    if (currentFramePolygonInches > 0) {
                        sideLength = currentFramePolygonInches;
                    } else {
                        sideLength = getInputInches('framePolygonFeet', 'framePolygonInches', 'framePolygonFraction');
                    }
                    dimensionsSummary = `${inchesToDisplay(sideLength)} side length`;
                }
                
            } else {
                const angle = parseFloat(document.getElementById('singleMiterAngle').value) || 0;
                const boardWidth = getInputInches('singleBoardWidthFeet', 'singleBoardWidthInches', 'singleBoardWidthFraction');
                const inputLength = getInputInches('singleInputLengthFeet', 'singleInputLengthInches', 'singleInputLengthFraction');
                const knownSide = document.getElementById('singleKnownSide').value;
                
                if (angle === 0 || boardWidth === 0 || inputLength === 0) {
                    showNotification('Enter all values first');
                    return;
                }
                
                const angleRad = (angle * Math.PI) / 180;
                const offset = boardWidth * Math.tan(angleRad);
                
                let shortSide, longSide;
                if (knownSide === 'long') {
                    longSide = inputLength;
                    shortSide = longSide - offset;
                } else {
                    shortSide = inputLength;
                    longSide = shortSide + offset;
                }
                
            }
        }
        */
        
        function saveAngleToProject() {
            if (currentMiterMode === 'frame') {
                const sides = parseInt(document.getElementById('frameShapeSides').value);
                
                // Use smart input values if available, otherwise fall back to legacy inputs
                let materialWidth;
                if (currentFrameMaterialWidthInches > 0) {
                    materialWidth = currentFrameMaterialWidthInches;
                } else {
                    materialWidth = getInputInches('frameMaterialWidthFeet', 'frameMaterialWidthInches', 'frameMaterialWidthFraction');
                }
                
                if (materialWidth === 0) {
                    showNotification('Enter frame details first', 'warning');
                    return;
                }
                
                const interiorAngle = ((sides - 2) * 180) / sides;
                const miterAngle = (180 - interiorAngle) / 2;
                
                let frameName = sides === 4 ? 'Rectangle/Square' : `${sides}-sided Polygon`;
                let dimensionsSummary = '';
                
                if (sides === 4) {
                    // Use smart input values if available, otherwise fall back to legacy inputs
                    let width, height;
                    if (currentFrameWidthInches > 0) {
                        width = currentFrameWidthInches;
                    } else {
                        width = getInputInches('frameWidthFeet', 'frameWidthInches', 'frameWidthFraction');
                    }
                    if (currentFrameHeightInches > 0) {
                        height = currentFrameHeightInches;
                    } else {
                        height = getInputInches('frameHeightFeet', 'frameHeightInches', 'frameHeightFraction');
                    }
                    dimensionsSummary = `${inchesToDisplay(width)} × ${inchesToDisplay(height)}`;
                } else {
                    // Use smart input values if available, otherwise fall back to legacy inputs
                    let sideLength;
                    if (currentFramePolygonInches > 0) {
                        sideLength = currentFramePolygonInches;
                    } else {
                        sideLength = getInputInches('framePolygonFeet', 'framePolygonInches', 'framePolygonFraction');
                    }
                    dimensionsSummary = `${inchesToDisplay(sideLength)} per side`;
                }
                
                const data = {
                    equation: `${frameName} Frame: ${dimensionsSummary}, ${inchesToDisplay(materialWidth)} material`,
                    result: `${miterAngle.toFixed(1)}° cuts`,
                    details: `Frame: ${frameName}\nDimensions: ${dimensionsSummary}\nMaterial width: ${inchesToDisplay(materialWidth)}\nMiter angle: ${miterAngle.toFixed(1)}°\nCut angle for joining frame pieces`
                };
                
                showSaveToProjectModal('Miter Angle Calculator - Frame Builder', data, 'angleDiagramContainer');
                
            } else {
                // Single Board Cut mode
                const angle = parseFloat(document.getElementById('singleMiterAngle').value) || 0;
                const boardWidth = getInputInches('singleBoardWidthFeet', 'singleBoardWidthInches', 'singleBoardWidthFraction');
                const knownSide = document.getElementById('singleKnownSide').value;
                const cutType = document.getElementById('singleCutType').value;
                const inputLength = getInputInches('singleInputLengthFeet', 'singleInputLengthInches', 'singleInputLengthFraction');
                
                if (angle === 0 || boardWidth === 0 || inputLength === 0) {
                    showNotification('Enter all values first', 'warning');
                    return;
                }
                
                const angleRad = (angle * Math.PI) / 180;
                const singleOffset = boardWidth * Math.tan(angleRad);
                const totalOffset = cutType === 'dual-sided' ? singleOffset * 2 : singleOffset;
                
                let shortSide, longSide;
                if (knownSide === 'long') {
                    longSide = inputLength;
                    shortSide = longSide - totalOffset;
                } else {
                    shortSide = inputLength;
                    longSide = shortSide + totalOffset;
                }
                
                const cutDescription = cutType === 'one-sided' ? 'One End Cut' : 'Both Ends Cut';
                
                const data = {
                    equation: `${angle}° miter cut: ${inchesToDisplay(boardWidth)} board, ${knownSide} side ${inchesToDisplay(inputLength)}`,
                    result: `Long: ${inchesToDisplay(longSide)}, Short: ${inchesToDisplay(shortSide)}`,
                    details: `Cut Type: ${cutDescription}\nAngle: ${angle}°\nBoard width: ${inchesToDisplay(boardWidth)}\nKnown side: ${knownSide} (${inchesToDisplay(inputLength)})\nLong side: ${inchesToDisplay(longSide)}\nShort side: ${inchesToDisplay(shortSide)}\nOffset: ${inchesToDisplay(totalOffset)}`
                };
                
                showSaveToProjectModal('Miter Angle Calculator - Single Board Cut', data, 'angleDiagramContainer');
            }
        }

        function saveSpacingToHistory() {
            const totalLength = getInputInches('spTotalLengthFeet', 'spTotalLengthInches', 'spTotalLengthFraction');
            const numShelves = parseInt(document.getElementById('spNumShelves').value) || 0;
            const thickness = getInputInches('spacingThicknessFeet', 'spacingThicknessInches', 'spacingThicknessFraction');
            
            if (totalLength === 0 || numShelves === 0) {
                showNotification('Enter dimensions first');
                return;
            }
            
            // Convert shelves to spaces: N shelves = N+1 spaces
            const numSpaces = numShelves + 1;
            let spacing, detailedEquation;
            
            if (thickness === 0) {
                // CENTER MARKS MODE - No material thickness
                spacing = totalLength / numSpaces;
                const centerMarks = Array.from({length: numShelves}, (_, i) => inchesToDisplay((i + 1) * spacing, 'calculator'));
                
                detailedEquation = `SHELF & DIVISION - Center Marks
Total Length: ${inchesToDisplay(totalLength, 'calculator')}
Shelves: ${numShelves} shelves (${numSpaces} spaces)
Space Size: ${inchesToDisplay(spacing, 'calculator')} each
Material: No thickness (center marks)

📐 Shelf Center Marking Guide:`;

                if (centerMarks.length <= 10) {
                    centerMarks.forEach((mark, i) => {
                        detailedEquation += `\nShelf ${i + 1}: Center ${mark}`;
                    });
                } else {
                    // Show first 5, middle indicator, last 5
                    for (let i = 0; i < 5; i++) {
                        detailedEquation += `\nShelf ${i + 1}: Center ${centerMarks[i]}`;
                    }
                    detailedEquation += `\n... ${centerMarks.length - 10} more shelves ...`;
                    for (let i = centerMarks.length - 5; i < centerMarks.length; i++) {
                        detailedEquation += `\nShelf ${i + 1}: Center ${centerMarks[i]}`;
                    }
                }
                
            } else {
                // SHELF MODE - With material thickness
                const totalThickness = numShelves * thickness;
                const availableSpace = totalLength - totalThickness;
                spacing = availableSpace / numSpaces;
                
                // Calculate shelf positions
                const shelfInfo = [];
                let currentPos = 0;
                for (let i = 0; i < numShelves; i++) {
                    currentPos += spacing;
                    const leftEdge = currentPos;
                    const rightEdge = currentPos + thickness;
                    shelfInfo.push({
                        number: i + 1,
                        bottom: inchesToDisplay(leftEdge, 'calculator'),
                        top: inchesToDisplay(rightEdge, 'calculator')
                    });
                    currentPos += thickness;
                }
                
                detailedEquation = `SHELF & DIVISION - With Shelves
Total Length: ${inchesToDisplay(totalLength, 'calculator')}
Shelves: ${numShelves} @ ${inchesToDisplay(thickness, 'calculator')} thick
Spaces: ${numSpaces} @ ${inchesToDisplay(spacing, 'calculator')} each

📏 Shelf Marking Guide:`;

                if (shelfInfo.length <= 8) {
                    shelfInfo.forEach(shelf => {
                        detailedEquation += `\nShelf ${shelf.number}: Bottom ${shelf.bottom} - Top ${shelf.top}`;
                    });
                } else {
                    // Show first 4, middle indicator, last 4
                    for (let i = 0; i < 4; i++) {
                        const shelf = shelfInfo[i];
                        detailedEquation += `\nShelf ${shelf.number}: Bottom ${shelf.bottom} - Top ${shelf.top}`;
                    }
                    detailedEquation += `\n... ${shelfInfo.length - 8} more shelves ...`;
                    for (let i = shelfInfo.length - 4; i < shelfInfo.length; i++) {
                        const shelf = shelfInfo[i];
                        detailedEquation += `\nShelf ${shelf.number}: Bottom ${shelf.bottom} - Top ${shelf.top}`;
                    }
                }
            }
            
        }
        
        function saveSpacingToProject() {
            const totalLength = getInputInches('spTotalLengthFeet', 'spTotalLengthInches', 'spTotalLengthFraction');
            const numShelves = parseInt(document.getElementById('spNumShelves').value) || 0;
            const thickness = getInputInches('spacingThicknessFeet', 'spacingThicknessInches', 'spacingThicknessFraction');
            
            if (totalLength === 0 || numShelves === 0) {
                showNotification('Enter dimensions first', 'warning');
                return;
            }
            
            // Convert shelves to spaces: N shelves = N+1 spaces
            const numSpaces = numShelves + 1;
            let spacing, equation, details;
            
            if (thickness === 0) {
                // CENTER MARKS MODE - No material thickness
                spacing = totalLength / numSpaces;
                const centerMarks = Array.from({length: numShelves}, (_, i) => inchesToDisplay((i + 1) * spacing, 'calculator'));
                
                equation = `${numShelves} shelves in ${inchesToDisplay(totalLength)} = ${inchesToDisplay(spacing)} spacing`;
                details = `Total Length: ${inchesToDisplay(totalLength)}\nShelves: ${numShelves} shelves (${numSpaces} spaces)\nSpace Size: ${inchesToDisplay(spacing)} each\nMode: Center marks (no material thickness)`;
                
                if (centerMarks.length <= 5) {
                    details += '\n\nShelf center marks:\n' + centerMarks.map((mark, i) => `Shelf ${i + 1}: ${mark}`).join('\n');
                }
                
            } else {
                // SHELF MODE - With material thickness
                const totalThickness = numShelves * thickness;
                const availableSpace = totalLength - totalThickness;
                spacing = availableSpace / numSpaces;
                
                equation = `${numShelves} shelves (${inchesToDisplay(thickness)} thick) in ${inchesToDisplay(totalLength)} = ${inchesToDisplay(spacing)} spacing`;
                details = `Total Length: ${inchesToDisplay(totalLength)}\nShelves: ${numShelves} × ${inchesToDisplay(thickness)} thick\nTotal Material: ${inchesToDisplay(totalThickness)}\nAvailable Space: ${inchesToDisplay(availableSpace)}\nSpacing: ${inchesToDisplay(spacing)} each`;
            }
            
            // Create enhanced preview for timeline display
            const previewContent = `
                <div class="save-preview-spacing">
                    <div class="preview-header">
                        <strong>📐 Shelf & Division Calculator</strong>
                    </div>
                    <div class="preview-equation">
                        ${equation}
                    </div>
                    <div class="preview-result">
                        <strong>${inchesToDisplay(spacing)} spacing between ${numShelves} shelves</strong>
                    </div>
                    ${thickness === 0 ? 
                        // Center marks mode - show the marks clearly
                        `<div class="preview-marks">
                            <div class="marks-header">📍 Center Mark Positions:</div>
                            ${Array.from({length: Math.min(numShelves, 8)}, (_, i) => 
                                `<div class="mark-item">Shelf ${i + 1}: ${inchesToDisplay((i + 1) * spacing, 'calculator')}</div>`
                            ).join('')}
                            ${numShelves > 8 ? '<div class="mark-item">... and more</div>' : ''}
                        </div>` :
                        // Shelf mode - show detailed spacing info
                        `<div class="preview-summary">
                            Total Material: ${inchesToDisplay(numShelves * thickness)} • Available Space: ${inchesToDisplay(totalLength - numShelves * thickness)}
                        </div>
                        <div class="preview-spacing-details">
                            <div class="spacing-header">📏 Spacing Details:</div>
                            <div class="spacing-item">Space Size: ${inchesToDisplay(spacing)} each</div>
                            <div class="spacing-item">Number of Spaces: ${numSpaces} (between and around ${numShelves} shelves)</div>
                            ${numShelves <= 6 ? 
                                `<div class="spacing-positions">
                                    <div class="positions-header">Shelf Positions:</div>
                                    ${Array.from({length: numShelves}, (_, i) => {
                                        const shelfPosition = spacing + (i * (spacing + thickness));
                                        return `<div class="position-item">Shelf ${i + 1}: ${inchesToDisplay(shelfPosition)} to ${inchesToDisplay(shelfPosition + thickness)}</div>`;
                                    }).join('')}
                                </div>` : 
                                `<div class="spacing-item">Shelf positions available for ${numShelves} shelves</div>`
                            }
                        </div>`
                    }
                </div>
            `;
            
            const saveData = {
                tool: 'spacing',
                toolName: 'Shelf & Division Calculator',
                equation: equation,
                result: `${inchesToDisplay(spacing)} spacing between ${numShelves} shelves`,
                details: {
                    totalLength: totalLength,
                    numShelves: numShelves,
                    thickness: thickness,
                    spacing: spacing,
                    mode: thickness === 0 ? 'center-marks' : 'shelf-spacing',
                    marks: thickness === 0 ? Array.from({length: numShelves}, (_, i) => ({
                        shelf: i + 1,
                        position: (i + 1) * spacing,
                        display: inchesToDisplay((i + 1) * spacing, 'calculator')
                    })) : null,
                    shelfPositions: thickness > 0 ? Array.from({length: numShelves}, (_, i) => {
                        const startPos = spacing + (i * (spacing + thickness));
                        const endPos = startPos + thickness;
                        return {
                            shelf: i + 1,
                            startPosition: startPos,
                            endPosition: endPos,
                            startDisplay: inchesToDisplay(startPos, 'calculator'),
                            endDisplay: inchesToDisplay(endPos, 'calculator')
                        };
                    }) : null,
                    fullDetails: details
                },
                preview: previewContent,
                diagramContainerId: 'spacingContent'
            };
            
            showSaveToProjectModal(saveData);
        }

        // ============================================================================
        // CABINET DRAWER & FACE FRAME LAYOUT CALCULATOR
        // ============================================================================
        
        // Global variables for Cabinet Calculator
        let currentCabinetHeightInches = 0;
        let currentCabinetWidthInches = 0;
        let currentHorizontalRevealInches = 0.125; // Default 1/8"
        let currentVerticalRevealInches = 0.125;   // Default 1/8"
        let currentOverlayAmountInches = 0.75;     // Default 3/4"
        let currentRailThicknessInches = 1.5;      // Default 1.5"
        let cabinetFrameStyle = 'inset';           // 'inset' or 'overlay'
        let cabinetDrawerMode = 'equal';           // 'equal' or 'custom'
        // Layout is always bottom-up (all measurements from bottom)
        let customDrawerHeights = [];              // Array of custom drawer heights
        
        // Drawer box calculation variables
        let includeDrawerBox = false;               // Toggle for drawer box calculations
        let drawerSlideType = 'side';              // 'side' or 'bottom'
        let selectedDrawerIndex = 0;                // Which drawer to show in diagrams
        let currentCabinetDepthInches = 0;         // Interior cabinet depth
        let currentCabinetMaterialThickness = 0.75; // Default 3/4" cabinet material thickness
        let currentBoxMaterialThickness = 0.75;    // Default 3/4" for sides/front/back
        let currentBottomThickness = 0.25;         // Default 1/4" for bottom
        
        // Initialization flag to prevent auto-calculation on page load
        let currentBottomDadoDepth = 0.3125;       // Default 5/16" groove depth (for 1/4" panel)
        let currentBottomDadoHeight = 0.25;        // Default 1/4" up from bottom
        let currentSideClearance = 0.5;            // Default 1/2" per side for side mount
        let currentRearClearance = 1;              // Default 1" rear clearance
        let currentTopClearance = 0.5;             // Default 1/2" top clearance
        let currentBottomClearance = 0.375;        // Default 3/8" bottom clearance for bottom mount
        let currentFaceThickness = 0.75;           // Default 3/4" drawer face thickness
        
        // Smart input callback functions
        function updateCabinetHeightValue(inches, display) {
            
            currentCabinetHeightInches = inches;
            calculateCabinetLayout();
        }
        
        function updateCabinetWidthValue(inches, display) {
            
            currentCabinetWidthInches = inches;
            calculateCabinetLayout();
        }
        
        function updateHorizontalRevealValue(inches, display) {
            currentHorizontalRevealInches = inches;
            calculateCabinetLayout();
        }
        
        function updateVerticalRevealValue(inches, display) {
            currentVerticalRevealInches = inches;
            calculateCabinetLayout();
        }
        
        function updateOverlayAmountValue(inches, display) {
            currentOverlayAmountInches = inches;
            calculateCabinetLayout();
        }
        
        function updateRailThicknessValue(inches, display) {
            currentRailThicknessInches = inches;
            calculateCabinetLayout();
        }
        
        // Drawer box smart input callbacks
        function updateCabinetDepthValue(inches, display) {
            
            currentCabinetDepthInches = inches;
            
            // Update diagram visibility if drawer box is enabled
            if (includeDrawerBox) {
                document.getElementById('drawerBoxDiagramContainer').style.display = inches > 0 ? 'block' : 'none';
            }
            
            calculateCabinetLayout();
        }
        
        function updateSideClearanceValue(inches, display) {
            currentSideClearance = inches;
            calculateCabinetLayout();
        }
        
        function updateRearClearanceValue(inches, display) {
            currentRearClearance = inches;
            calculateCabinetLayout();
        }
        
        function updateTopClearanceValue(inches, display) {
            currentTopClearance = inches;
            calculateCabinetLayout();
        }
        
        function updateBoxMaterialValue(inches, display) {
            currentBoxMaterialThickness = inches;
            calculateCabinetLayout();
        }
        
        function updateBottomPanelValue(inches, display) {
            currentBottomThickness = inches;
            calculateCabinetLayout();
        }
        
        function updateDadoDepthValue(inches, display) {
            currentBottomDadoDepth = inches;
            calculateCabinetLayout();
        }
        
        function updateDadoHeightValue(inches, display) {
            currentBottomDadoHeight = inches;
            calculateCabinetLayout();
        }
        
        function updateFaceThicknessValue(inches, display) {
            currentFaceThickness = inches;
            calculateCabinetLayout();
        }
        
        function updateCabinetMaterialThicknessValue(inches, display) {
            const timestamp = Date.now();
            const cabinetContent = document.getElementById('cabinetDrawerContent');
            
            currentCabinetMaterialThickness = inches;
            calculateCabinetLayout();
        }
        
        function updateBottomClearanceValue(inches, display) {
            currentBottomClearance = inches;
            calculateCabinetLayout();
        }
        
        // Toggle drawer box calculations
        function toggleDrawerBox() {
            includeDrawerBox = document.getElementById('includeDrawerBox').checked;
            
            const settingsEl = document.getElementById('drawerBoxSettings');
            const diagramEl = document.getElementById('drawerBoxDiagramContainer');
            
            
            document.getElementById('drawerBoxSettings').style.display = includeDrawerBox ? 'block' : 'none';
            
            // Only show diagram container if we have valid cabinet depth
            if (includeDrawerBox && currentCabinetDepthInches > 0) {
                document.getElementById('drawerBoxDiagramContainer').style.display = 'block';
            } else {
                document.getElementById('drawerBoxDiagramContainer').style.display = 'none';
            }
            
            // Only calculate if initialization is complete
            calculateCabinetLayout();
        }
        
        // Set slide type
        function setSlideType(type) {
            drawerSlideType = type;
            
            // Update button states
            document.getElementById('slideTypeSide').classList.toggle('active', type === 'side');
            document.getElementById('slideTypeBottom').classList.toggle('active', type === 'bottom');
            
            // Update default clearances based on slide type
            if (type === 'bottom') {
                document.getElementById('smartSideClearance').value = '3/16';
                document.getElementById('smartSideClearance').placeholder = '3/16&quot; to 1/4&quot; typical for bottom mount';
                currentSideClearance = 0.1875; // 3/16"
                document.getElementById('bottomMountNote').style.display = 'block';
                // Show bottom clearance input for bottom mount
                const bottomClearanceDiv = document.getElementById('bottomClearanceDiv');
                if (bottomClearanceDiv) {
                    bottomClearanceDiv.style.display = 'block';
                }
            } else {
                document.getElementById('smartSideClearance').value = '1/2';
                document.getElementById('smartSideClearance').placeholder = '1/2&quot; typical for side mount';
                currentSideClearance = 0.5; // 1/2"
                document.getElementById('bottomMountNote').style.display = 'none';
                // Hide bottom clearance input for side mount
                const bottomClearanceDiv = document.getElementById('bottomClearanceDiv');
                if (bottomClearanceDiv) {
                    bottomClearanceDiv.style.display = 'none';
                }
            }
            
            calculateCabinetLayout();
        }
        
        // Show drawer box help
        function showDrawerBoxHelp() {
            showNotification(`
                <h4>Drawer Box Terminology</h4>
                <dl style="text-align: left; margin-top: 10px;">
                    <dt><strong>Slide Setback:</strong></dt>
                    <dd>Distance from cabinet front edge to where drawer slide mounts</dd>
                    
                    <dt><strong>Box-to-Cabinet Clearance:</strong></dt>
                    <dd>Gap between drawer box sides and cabinet opening (per side)</dd>
                    
                    <dt><strong>Rear Clearance:</strong></dt>
                    <dd>Space between back of drawer box and rear cabinet wall</dd>
                    
                    <dt><strong>Bottom Groove Depth:</strong></dt>
                    <dd>How deep to cut the groove (should be 1/16" deeper than panel thickness for easy assembly)</dd>
                    
                    <dt><strong>Groove Position:</strong></dt>
                    <dd>Distance from bottom edge to groove center (typically 1/4" to 3/8")</dd>
                    
                    <dt><strong>Face Attachment Offset:</strong></dt>
                    <dd>How far drawer face extends beyond drawer box edges</dd>
                </dl>
            `, 'info');
        }
        
        // Mode switching functions
        function setFrameStyle(style) {
            cabinetFrameStyle = style;
            
            // Update button states
            document.getElementById('frameStyleInset').classList.toggle('active', style === 'inset');
            document.getElementById('frameStyleOverlay').classList.toggle('active', style === 'overlay');
            
            // Show/hide relevant settings
            document.getElementById('insetSettings').style.display = style === 'inset' ? 'block' : 'none';
            document.getElementById('overlaySettings').style.display = style === 'overlay' ? 'block' : 'none';
            
            // Clear preview elements when switching modes
            document.querySelectorAll('#cabinetDrawerContent .input-preview').forEach(el => {
                el.style.display = 'none';
            });
            
            // Only calculate if the calculator is visible
            const cabinetContent = document.getElementById('cabinetDrawerContent');
            if (cabinetContent && window.getComputedStyle(cabinetContent).display !== 'none') {
                calculateCabinetLayout();
            }
        }
        
        function setCabinetDrawerMode(mode) {
            cabinetDrawerMode = mode;
            
            // Update button states
            document.getElementById('drawerModeEqual').classList.toggle('active', mode === 'equal');
            document.getElementById('drawerModeCustom').classList.toggle('active', mode === 'custom');
            
            // Show/hide relevant inputs
            document.getElementById('equalDrawerInput').style.display = mode === 'equal' ? 'block' : 'none';
            document.getElementById('customDrawerInput').style.display = mode === 'custom' ? 'block' : 'none';
            
            // Initialize custom drawer list if switching to custom mode
            if (mode === 'custom' && customDrawerHeights.length === 0) {
                // Add default 3 drawers
                customDrawerHeights = [6, 8, 10]; // Example: 6", 8", 10" drawers
                updateCustomDrawerList();
            }
            
            // Only calculate if the calculator is visible
            const cabinetContent = document.getElementById('cabinetDrawerContent');
            if (cabinetContent && window.getComputedStyle(cabinetContent).display !== 'none') {
                calculateCabinetLayout();
            }
        }
        
        
        // Rail thickness handling
        function updateRailThickness() {
            const select = document.getElementById('railThicknessSelect');
            const customRow = document.getElementById('customRailRow');
            
            if (select.value === 'custom') {
                customRow.style.display = 'block';
            } else {
                customRow.style.display = 'none';
                currentRailThicknessInches = parseFloat(select.value) || 0;
                calculateCabinetLayout();
            }
        }
        
        // Custom drawer management
        function addCustomDrawer() {
            const defaultHeight = 6; // Default 6" drawer
            customDrawerHeights.push(defaultHeight);
            updateCustomDrawerList();
            calculateCabinetLayout();
        }
        
        function removeCustomDrawer(index) {
            customDrawerHeights.splice(index, 1);
            updateCustomDrawerList();
            calculateCabinetLayout();
        }
        
        function updateCustomDrawerHeight(index, value) {
            // Parse the input to handle fractions, decimals, etc.
            const result = parseSmartInput(value);
            if (result.isValid && result.value > 0) {
                customDrawerHeights[index] = result.value;
                calculateCabinetLayout();
            }
        }
        
        function updateCustomDrawerList() {
            const listDiv = document.getElementById('customDrawerList');
            
            if (customDrawerHeights.length === 0) {
                listDiv.innerHTML = '<p style="color: #666; font-style: italic;">No drawers added. Click "+ Add Drawer" to start.</p>';
                return;
            }
            
            // Clear existing content
            listDiv.innerHTML = '';
            
            // Use DocumentFragment for better performance
            const fragment = document.createDocumentFragment();
            
            customDrawerHeights.forEach((height, index) => {
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; align-items: center; gap: 10px; margin-bottom: 10px;';
                
                const span = document.createElement('span');
                span.style.cssText = 'min-width: 80px; font-weight: 600;';
                span.textContent = `Drawer ${index + 1}:`;
                div.appendChild(span);
                
                const input = document.createElement('input');
                input.type = 'text';
                input.value = inchesToDisplay(height);
                input.placeholder = 'e.g. 6, 4 1/2, 3.75';
                input.style.cssText = 'width: 100px; padding: 8px;';
                input.oninput = function() { updateCustomDrawerHeight(index, this.value); };
                div.appendChild(input);
                
                const inchesSpan = document.createElement('span');
                inchesSpan.style.color = '#666';
                inchesSpan.textContent = 'inches';
                div.appendChild(inchesSpan);
                
                const button = document.createElement('button');
                button.className = 'btn btn-sm';
                button.style.cssText = 'background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;';
                button.textContent = 'Remove';
                button.onclick = function() { removeCustomDrawer(index); };
                div.appendChild(button);
                
                fragment.appendChild(div);
            });
            
            listDiv.appendChild(fragment);
        }
        
        // Main calculation function
        function calculateCabinetLayout() {
            
            const cabinetContent = document.getElementById('cabinetDrawerContent');
            
            
            // Only skip if calculator is collapsed
            if (cabinetContent && window.getComputedStyle(cabinetContent).display === 'none') {
                return;
            }
            
            const resultDiv = document.getElementById('cabinetResult');
            const cutListDiv = document.getElementById('cabinetCutList');
            
            // Validate inputs
            if (currentCabinetHeightInches <= 0 || currentCabinetWidthInches <= 0) {
                resultDiv.innerHTML = '<div class="result-placeholder">Enter cabinet opening dimensions</div>';
                cutListDiv.style.display = 'none';
                updateCabinetDiagrams(null);
                return;
            }
            
            let drawerData = [];
            let railData = [];
            let validationError = null;
            
            // Calculate based on mode
            if (cabinetDrawerMode === 'equal') {
                const numDrawers = parseInt(document.getElementById('numDrawers').value) || 3;
                
                // Calculate drawer dimensions
                const drawerWidth = cabinetFrameStyle === 'inset' ? 
                    currentCabinetWidthInches - (2 * currentHorizontalRevealInches) :
                    currentCabinetWidthInches + (2 * currentOverlayAmountInches);
                
                // Calculate available height and drawer height
                let availableHeight, drawerHeight;
                let totalVerticalReveals = 0;
                let totalRails = 0;
                
                if (cabinetFrameStyle === 'inset') {
                    // Inset: Calculate opening sizes first, then drawer fronts
                    totalRails = (numDrawers - 1) * currentRailThicknessInches;
                    // Available space for drawer openings
                    const availableForOpenings = currentCabinetHeightInches - totalRails;
                    // Each drawer opening height
                    const openingHeight = availableForOpenings / numDrawers;
                    // Drawer front is smaller than opening by reveals on both sides
                    drawerHeight = openingHeight - (2 * currentVerticalRevealInches);
                    
                    if (drawerHeight <= 0) {
                        validationError = 'Not enough space for drawers with current reveal and rail settings';
                    }
                } else {
                    // Overlay: Drawer fronts extend beyond cabinet opening
                    if (numDrawers === 1) {
                        // Single drawer - just add overlay on top and bottom
                        drawerHeight = currentCabinetHeightInches + (2 * currentOverlayAmountInches);
                    } else {
                        // Multiple drawers - need to account for rails and overlaps
                        // First check if overlay is too large for rail thickness
                        if (currentOverlayAmountInches * 2 > currentRailThicknessInches) {
                            validationError = `Overlay amount (${inchesToDisplay(currentOverlayAmountInches)}) is too large for rail thickness (${inchesToDisplay(currentRailThicknessInches)}). Rails need to be at least ${inchesToDisplay(currentOverlayAmountInches * 2)} thick.`;
                        } else {
                            const totalRails = (numDrawers - 1) * currentRailThicknessInches;
                            // Calculate the space each drawer gets
                            const spacePerDrawer = (currentCabinetHeightInches - totalRails) / numDrawers;
                            // For first and last drawer: overlay on one side + full opening + overlay on other side
                            // For middle drawers: they share overlay space at rails
                            // So we add 2*overlay for non-shared edges only
                            drawerHeight = spacePerDrawer + (2 * currentOverlayAmountInches);
                        }
                    }
                }
                
                // Generate drawer data
                if (!validationError) {
                    // For equal mode, all drawers have the same dimensions
                    for (let i = 0; i < numDrawers; i++) {
                        drawerData.push({
                            number: i + 1,
                            width: drawerWidth,
                            height: drawerHeight,
                            // Store opening height for inset mode positioning
                            openingHeight: cabinetFrameStyle === 'inset' ? drawerHeight + (2 * currentVerticalRevealInches) : drawerHeight
                        });
                    }
                }
                
            } else {
                // Custom mode
                if (customDrawerHeights.length === 0) {
                    validationError = 'Add at least one drawer';
                } else {
                    const numDrawers = customDrawerHeights.length;
                    
                    // Validate total height
                    const totalCustomHeight = customDrawerHeights.reduce((sum, h) => sum + h, 0);
                    
                    if (cabinetFrameStyle === 'inset') {
                        // For custom inset drawers, the specified heights are the opening sizes
                        // Reveals are WITHIN the openings, not additional space
                        const totalRails = (numDrawers - 1) * currentRailThicknessInches;
                        const requiredHeight = totalCustomHeight + totalRails;
                        
                        if (requiredHeight > currentCabinetHeightInches) {
                            const excess = requiredHeight - currentCabinetHeightInches;
                            validationError = `Total height (${inchesToDisplay(requiredHeight)}) exceeds cabinet opening (${inchesToDisplay(currentCabinetHeightInches)}) by ${inchesToDisplay(excess)}`;
                        } else if (requiredHeight < currentCabinetHeightInches) {
                            const gap = currentCabinetHeightInches - requiredHeight;
                            validationError = `Total drawer openings (${inchesToDisplay(totalCustomHeight)}) plus rails (${inchesToDisplay(totalRails)}) = ${inchesToDisplay(requiredHeight)} leaves a ${inchesToDisplay(gap)} gap. Custom drawer openings must exactly fill the cabinet height.`;
                        }
                    } else {
                        // For overlay, need to account for overlaps
                        // First check if overlay is too large for rail thickness when multiple drawers
                        if (numDrawers > 1 && currentOverlayAmountInches * 2 > currentRailThicknessInches) {
                            validationError = `Overlay amount (${inchesToDisplay(currentOverlayAmountInches)}) is too large for rail thickness (${inchesToDisplay(currentRailThicknessInches)}). Rails need to be at least ${inchesToDisplay(currentOverlayAmountInches * 2)} thick.`;
                        } else {
                            const totalRails = (numDrawers - 1) * currentRailThicknessInches;
                            // Custom heights represent the drawer box openings
                            // Total cabinet space needed = sum of openings + rails
                            const requiredHeight = totalCustomHeight + totalRails;
                            
                            if (requiredHeight > currentCabinetHeightInches) {
                                const excess = requiredHeight - currentCabinetHeightInches;
                                validationError = `Total drawer openings (${inchesToDisplay(totalCustomHeight)}) plus rails (${inchesToDisplay(totalRails)}) exceeds cabinet height (${inchesToDisplay(currentCabinetHeightInches)}) by ${inchesToDisplay(excess)}`;
                            } else if (requiredHeight < currentCabinetHeightInches) {
                                const gap = currentCabinetHeightInches - requiredHeight;
                                validationError = `Total drawer openings (${inchesToDisplay(totalCustomHeight)}) plus rails (${inchesToDisplay(totalRails)}) = ${inchesToDisplay(requiredHeight)} leaves a ${inchesToDisplay(gap)} gap. Custom drawer openings must exactly fill the cabinet height.`;
                            }
                        }
                    }
                    
                    // Generate drawer data
                    if (!validationError) {
                        // For custom mode, dimensions represent openings
                        const drawerWidth = cabinetFrameStyle === 'inset' ? 
                            currentCabinetWidthInches :  // Full cabinet width for opening
                            currentCabinetWidthInches + (2 * currentOverlayAmountInches);
                        
                        customDrawerHeights.forEach((height, i) => {
                            drawerData.push({
                                number: i + 1,
                                width: drawerWidth,
                                height: cabinetFrameStyle === 'overlay' ? height + (2 * currentOverlayAmountInches) : height,
                                isCustom: true  // Flag to indicate custom mode
                            });
                        });
                    }
                }
            }
            
            // Display results or error
            if (validationError) {
                resultDiv.innerHTML = `<div class="result-warning">${validationError}</div>`;
                cutListDiv.style.display = 'none';
                updateCabinetDiagrams(null);
                document.getElementById('boxDimensionDisplay').style.display = 'none';
                document.getElementById('faceToBoxMountingDiagram').style.display = 'none';
                return;
            }
            
            // Calculate rail positions and generate cut list
            const layoutData = calculateRailPositions(drawerData, cabinetDrawerMode);
            
            // Display results
            const frameTypeDisplay = cabinetFrameStyle.charAt(0).toUpperCase() + cabinetFrameStyle.slice(1);
            const modeDisplay = cabinetDrawerMode === 'equal' ? 'Equal Heights' : 'Custom Heights';
            
            // Generate rail marking guide
            let railMarkingGuide = '';
            if (currentRailThicknessInches > 0) {
                const rails = layoutData.positions.filter(p => p.type === 'rail');
                if (rails.length > 0) {
                    railMarkingGuide = `
                        <div class="divider-marks" style="margin-top: 15px;">
                            <div class="marks-header" style="font-weight: bold; margin-bottom: 10px; color: var(--primary-color); font-size: 14px;">
                                📐 Rail Marking Guide (measuring from bottom)
                            </div>
                            <div style="display: grid; gap: 10px;">
                                ${rails.map(rail => {
                                    // In overlay mode, positions are physical and don't change with measurement direction
                                    // Only the displayed measurement value changes
                                    let bottomMark, centerMark, topMark;
                                    
                                    if (cabinetFrameStyle === 'overlay') {
                                        // Always measure from bottom
                                        bottomMark = rail.bottom;
                                        centerMark = rail.bottom + rail.thickness/2;
                                        topMark = rail.top;
                                    } else {
                                        // Inset mode - keep original logic
                                        bottomMark = rail.bottom;
                                        centerMark = rail.bottom + rail.thickness/2;
                                        topMark = rail.top;
                                    }
                                    
                                    return `
                                    <div style="background: #f8f9fa; border-radius: 8px; padding: 12px; border: 1px solid #e0e0e0;">
                                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                            <span style="display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; background: var(--primary-color); color: white; border-radius: 50%; font-size: 12px; font-weight: bold;">
                                                ${rail.number}
                                            </span>
                                            <span style="font-weight: 600; color: var(--primary-color); font-size: 13px;">
                                                Mark ${rail.number} - Rail ${rail.number}
                                            </span>
                                        </div>
                                        <div style="display: grid; grid-template-columns: auto 1fr; gap: 6px 15px; font-size: 12px;">
                                            <span style="color: #666;">Bottom:</span>
                                            <span style="font-weight: 500;">${inchesToDisplay(bottomMark)}</span>
                                            <span style="color: #666;">Center:</span>
                                            <span style="font-weight: 500; color: var(--primary-color);">${inchesToDisplay(centerMark)}</span>
                                            <span style="color: #666;">Top:</span>
                                            <span style="font-weight: 500;">${inchesToDisplay(topMark)}</span>
                                        </div>
                                    </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
            }
            
            resultDiv.innerHTML = `
                <div class="result-value">${frameTypeDisplay} Cabinet - ${drawerData.length} Drawers (${modeDisplay})</div>
                <div class="result-summary">
                    <div class="summary-row">
                        <span class="summary-label">Cabinet Opening:</span>
                        <span class="summary-value">${inchesToDisplay(currentCabinetWidthInches)} W × ${inchesToDisplay(currentCabinetHeightInches)} H</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Drawer Fronts:</span>
                        <span class="summary-value">${inchesToDisplay(drawerData[0].width)} W × Various Heights</span>
                    </div>
                    ${currentRailThicknessInches > 0 ? `
                    <div class="summary-row">
                        <span class="summary-label">Rails:</span>
                        <span class="summary-value">${drawerData.length - 1} rails @ ${inchesToDisplay(currentRailThicknessInches)} thick</span>
                    </div>` : ''}
                </div>
                ${railMarkingGuide}
            `;
            
            // Generate cut list
            let cutListHTML = `
                <h4 style="margin: 0 0 10px 0; color: var(--primary-color); font-size: 14px;">Cut List</h4>
                <div style="background: white; border: 1px solid #ddd; border-radius: 4px; padding: 12px; font-size: 12px;">
                    <h5 style="margin: 0 0 8px 0; color: #333; font-size: 13px;">Drawer Fronts:</h5>
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead>
                            <tr style="border-bottom: 1px solid #ddd;">
                                <th style="text-align: left; padding: 6px; font-size: 11px; font-weight: 600;">Item</th>
                                <th style="text-align: left; padding: 6px; font-size: 11px; font-weight: 600;">Qty</th>
                                <th style="text-align: left; padding: 6px; font-size: 11px; font-weight: 600;">Width</th>
                                <th style="text-align: left; padding: 6px; font-size: 11px; font-weight: 600;">Height</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            drawerData.forEach(drawer => {
                // For custom inset drawers, the drawer front is smaller than the opening by 2× reveal
                let actualDrawerHeight = drawer.height;
                let actualDrawerWidth = drawer.width;
                
                if (cabinetFrameStyle === 'inset' && drawer.isCustom) {
                    // In custom mode for inset, drawer.height is the opening size
                    // The actual drawer front is the opening minus reveals on both sides
                    actualDrawerHeight = drawer.height - (2 * currentVerticalRevealInches);
                    actualDrawerWidth = drawer.width - (2 * currentHorizontalRevealInches);
                }
                
                cutListHTML += `
                    <tr style="border-bottom: 1px solid #f0f0f0;">
                        <td style="padding: 6px; font-size: 12px;">Drawer ${drawer.number}</td>
                        <td style="padding: 6px; font-size: 12px;">1</td>
                        <td style="padding: 6px; font-size: 12px;">${inchesToDisplay(actualDrawerWidth)}</td>
                        <td style="padding: 6px; font-size: 12px;">${inchesToDisplay(actualDrawerHeight)}</td>
                    </tr>
                `;
            });
            
            cutListHTML += `
                        </tbody>
                    </table>
            `;
            
            if (currentRailThicknessInches > 0 && drawerData.length > 1) {
                cutListHTML += `
                    <h5 style="margin: 15px 0 8px 0; color: #333; font-size: 13px;">Face Frame Rails:</h5>
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead>
                            <tr style="border-bottom: 1px solid #ddd;">
                                <th style="text-align: left; padding: 6px; font-size: 11px; font-weight: 600;">Item</th>
                                <th style="text-align: left; padding: 6px; font-size: 11px; font-weight: 600;">Qty</th>
                                <th style="text-align: left; padding: 6px; font-size: 11px; font-weight: 600;">Width</th>
                                <th style="text-align: left; padding: 6px; font-size: 11px; font-weight: 600;">Thickness</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid #f0f0f0;">
                                <td style="padding: 6px; font-size: 12px;">Horizontal Rails</td>
                                <td style="padding: 6px; font-size: 12px;">${drawerData.length - 1}</td>
                                <td style="padding: 6px; font-size: 12px;">${inchesToDisplay(currentCabinetWidthInches)}</td>
                                <td style="padding: 6px; font-size: 12px;">${inchesToDisplay(currentRailThicknessInches)}</td>
                            </tr>
                        </tbody>
                    </table>
                `;
            }
            
            cutListHTML += `
                    <div style="margin-top: 15px; padding-top: 12px; border-top: 1px solid #ddd;">
                        <strong style="font-size: 12px;">Notes:</strong>
                        <ul style="margin: 5px 0 0 20px; font-size: 11px; line-height: 1.4;">
                            <li>All dimensions are finished sizes</li>
                            ${cabinetFrameStyle === 'overlay' ? '<li>Drawer fronts include overlay on all edges</li>' : ''}
                            ${cabinetFrameStyle === 'inset' ? '<li>Drawer fronts sized for ' + inchesToDisplay(currentHorizontalRevealInches) + ' reveals</li>' : ''}
                            <li>Add edgebanding or finish as required</li>
                        </ul>
                    </div>
                </div>
            `;
            
            // Add drawer box components if enabled
            if (includeDrawerBox && currentCabinetDepthInches > 0) {
                const boxCalculations = calculateDrawerBoxes(drawerData, layoutData);
                
                if (boxCalculations && boxCalculations.length > 0) {
                    cutListHTML += `
                        <h4 style="margin: 20px 0 10px 0; color: var(--primary-color); font-size: 14px;">Drawer Box Components</h4>
                        <div style="background: white; border: 1px solid #ddd; border-radius: 4px; padding: 12px; font-size: 12px;">
                    `;
                } else if (boxCalculations === null) {
                    // Check if it's a depth or height issue
                    const testHeight = drawerData[0].height - currentTopClearance - (drawerSlideType === 'bottom' ? currentBottomClearance : 0);
                    const isHeightIssue = testHeight <= 0;
                    
                    if (isHeightIssue) {
                        // Insufficient height message
                        cutListHTML += `
                            <h4 style="margin: 20px 0 10px 0; color: var(--primary-color); font-size: 14px;">Drawer Box Components</h4>
                            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 15px; font-size: 12px;">
                                <strong style="color: #856404;">⚠️ Insufficient Drawer Height</strong><br>
                                <div style="margin-top: 8px; color: #856404;">
                                    The clearances are too large for the drawer opening height.<br>
                                    Drawer opening: ${inchesToDisplay(drawerData[0].height)}<br>
                                    • Top clearance: ${inchesToDisplay(currentTopClearance)}<br>
                                    ${drawerSlideType === 'bottom' ? `• Bottom clearance: ${inchesToDisplay(currentBottomClearance)}<br>` : ''}
                                    • Total clearances: ${inchesToDisplay(currentTopClearance + (drawerSlideType === 'bottom' ? currentBottomClearance : 0))}<br>
                                    <br>
                                    <strong>Solution:</strong> Reduce the clearances or increase the drawer opening height.
                                </div>
                            </div>
                    `;
                    } else {
                        // Insufficient depth message
                        const minDepthNeeded = (2 * currentBoxMaterialThickness) + currentRearClearance + 0.5; // Add 0.5" for minimum usable depth
                        cutListHTML += `
                            <h4 style="margin: 20px 0 10px 0; color: var(--primary-color); font-size: 14px;">Drawer Box Components</h4>
                            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 15px; font-size: 12px;">
                                <strong style="color: #856404;">⚠️ Insufficient Cabinet Depth</strong><br>
                                <div style="margin-top: 8px; color: #856404;">
                                    Current cabinet depth (${inchesToDisplay(currentCabinetDepthInches)}) is too shallow for drawer boxes.<br>
                                    With current settings, you need at least ${inchesToDisplay(minDepthNeeded)} of cabinet depth:<br>
                                    • Box material thickness: ${inchesToDisplay(currentBoxMaterialThickness)} × 2 = ${inchesToDisplay(2 * currentBoxMaterialThickness)}<br>
                                    • Rear clearance: ${inchesToDisplay(currentRearClearance)}<br>
                                    • Minimum usable depth: 1/2"
                                </div>
                            </div>
                    `;
                    }
                    
                    cutListDiv.innerHTML = cutListHTML;
                    cutListDiv.style.display = 'block';
                    return; // Skip the rest of drawer box section
                }
                
                if (boxCalculations && boxCalculations.length > 0) {
                    // Group materials by thickness
                    const materialGroups = {};
                    
                    boxCalculations.forEach((drawer, index) => {
                        // Add box material
                        const boxKey = `${currentBoxMaterialThickness}_box`;
                        if (!materialGroups[boxKey]) {
                            materialGroups[boxKey] = {
                                thickness: currentBoxMaterialThickness,
                                type: 'box',
                                parts: []
                            };
                        }
                        
                        materialGroups[boxKey].parts.push(
                            { name: `Drawer ${drawer.number} Sides`, qty: 2, width: drawer.boxHeight, length: drawer.boxDepth },
                            { name: `Drawer ${drawer.number} Front`, qty: 1, width: drawer.boxWidth, length: drawer.boxHeight },
                            { name: `Drawer ${drawer.number} Back`, qty: 1, width: drawer.boxWidth, length: drawer.boxHeight }
                        );
                        
                        // Add bottom panel
                        const bottomKey = `${currentBottomThickness}_bottom`;
                        if (!materialGroups[bottomKey]) {
                            materialGroups[bottomKey] = {
                                thickness: currentBottomThickness,
                                type: 'bottom',
                                parts: []
                            };
                        }
                        
                        materialGroups[bottomKey].parts.push(
                            { name: `Drawer ${drawer.number} Bottom`, qty: 1, width: drawer.bottomWidth, length: drawer.bottomDepth }
                        );
                    });
                    
                    // Display grouped materials
                    Object.entries(materialGroups).forEach(([key, group]) => {
                        cutListHTML += `
                            <h5 style="margin: 15px 0 8px 0; color: #333; font-size: 13px;">
                                ${inchesToDisplay(group.thickness)} Stock ${group.type === 'bottom' ? '(Plywood for Bottoms)' : '(Plywood/Solid for Box)'}
                            </h5>
                            <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                <thead>
                                    <tr style="border-bottom: 1px solid #ddd;">
                                        <th style="text-align: left; padding: 6px; font-size: 11px; font-weight: 600;">Part</th>
                                        <th style="text-align: left; padding: 6px; font-size: 11px; font-weight: 600;">Qty</th>
                                        <th style="text-align: left; padding: 6px; font-size: 11px; font-weight: 600;">Dimensions</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        group.parts.forEach(part => {
                            cutListHTML += `
                                <tr style="border-bottom: 1px solid #f0f0f0;">
                                    <td style="padding: 6px; font-size: 12px;">${part.name}</td>
                                    <td style="padding: 6px; font-size: 12px;">${part.qty}</td>
                                    <td style="padding: 6px; font-size: 12px;">${inchesToDisplay(part.width)} × ${inchesToDisplay(part.length)}</td>
                                </tr>
                            `;
                        });
                        
                        cutListHTML += `
                                </tbody>
                            </table>
                        `;
                    });
                    
                    // Add assembly notes
                    cutListHTML += `
                        <div style="margin-top: 15px; padding-top: 12px; border-top: 1px solid #ddd;">
                            <strong style="font-size: 12px;">Assembly Notes:</strong>
                            <ul style="margin: 5px 0 0 20px; font-size: 11px; line-height: 1.4;">
                                <li>Bottom panel: ${inchesToDisplay(currentBottomDadoDepth)} deep groove, ${inchesToDisplay(currentBottomDadoHeight)} up from bottom edge</li>
                                <li>Slide mounting: ${cabinetFrameStyle === 'overlay' ? 'Box front extends ' + inchesToDisplay(currentCabinetMaterialThickness) + ' forward of cabinet interior' : 'Box front flush with cabinet interior front'}</li>
                                <li>Pre-drill face mounting holes ${boxCalculations[0].mountingHoleOffset} from box edges</li>
                                <li>Maximum screw length: ${inchesToDisplay(currentBoxMaterialThickness + currentFaceThickness - 0.25)}</li>
                                <li>Assembly: Front and back run full width, sides fit between them</li>
                            </ul>
                        </div>
                    `;
                    
                    // Add face mounting guide
                    cutListHTML += `
                        <h5 style="margin: 15px 0 8px 0; color: #333; font-size: 13px;">Face-to-Box Mounting Guide</h5>
                        <div style="background: #f8f9fa; border-radius: 4px; padding: 10px; font-size: 11px;">
                            <div style="margin-bottom: 15px; padding: 10px; background: #fff3cd; border-radius: 4px; border: 1px solid #ffeaa7;">
                                <strong style="color: #856404;">⚠️ CRITICAL STEP - Test Fit Before Final Assembly!</strong><br>
                                <span style="color: #856404;">Always dry fit the complete assembly in the cabinet before attaching the face to the box.</span>
                            </div>
                            
                            <h6 style="margin: 0 0 8px 0; font-size: 12px; color: #333;">Assembly Instructions:</h6>
                            <ol style="margin: 0 0 15px 20px; line-height: 1.5;">
                                <li>Place drawer face face-down on a padded surface</li>
                                <li>Position drawer box on back of face using measurements below</li>
                                <li>Use spacers or a jig to maintain exact positioning</li>
                                <li>Clamp assembly securely before drilling</li>
                                <li>Pre-drill pilot holes at marked locations (${boxCalculations[0].mountingHoleOffset} from edges)</li>
                                <li>Attach with screws no longer than ${inchesToDisplay(currentBoxMaterialThickness + currentFaceThickness - 0.25)}</li>
                                <li>Test fit in cabinet and verify all clearances before final tightening</li>
                            </ol>
                    `;
                    
                    boxCalculations.forEach(drawer => {
                        cutListHTML += `
                            <div style="margin-bottom: 12px; padding-bottom: 12px; ${drawer.number < boxCalculations.length ? 'border-bottom: 1px solid #e0e0e0;' : ''}">
                                <strong>Drawer ${drawer.number}:</strong>
                                <div style="margin-top: 5px; display: grid; grid-template-columns: auto 1fr; gap: 5px 15px;">
                                    <span style="color: #666;">Face Size:</span>
                                    <span>${inchesToDisplay(drawer.faceWidth)} W × ${inchesToDisplay(drawer.faceHeight)} H</span>
                                    <span style="color: #666;">Box Size:</span>
                                    <span>${inchesToDisplay(drawer.boxWidth)} W × ${inchesToDisplay(drawer.boxHeight)} H</span>
                                    <span style="color: #666;">Horizontal Offset:</span>
                                    <span>${drawer.horizontalOffset} each side</span>
                                    <span style="color: #666;">Vertical Offset:</span>
                                    <span>${drawer.verticalOffset} top and bottom</span>
                                </div>
                            </div>
                        `;
                    });
                    
                    cutListHTML += `
                        </div>
                        
                        <h5 style="margin: 15px 0 8px 0; color: #333; font-size: 13px;">Hardware Requirements</h5>
                        <div style="background: #f8f9fa; border-radius: 4px; padding: 10px; font-size: 11px;">
                            <div style="display: grid; grid-template-columns: auto 1fr; gap: 5px 15px;">
                                <span style="color: #666;">Drawer Slides:</span>
                                <span>${drawerData.length} pairs × ${boxCalculations[0].slideLength} ${drawerSlideType}-mount slides</span>
                                <span style="color: #666;">Slide Setback:</span>
                                <span>${cabinetFrameStyle === 'overlay' ? 'Flush with cabinet front' : inchesToDisplay(currentFaceThickness) + ' from cabinet front'}</span>
                            </div>
                        </div>
                    `;
                    
                    cutListHTML += `</div>`;
                    
                    // Add box construction summary
                    cutListHTML += `
                        <h5 style="margin: 20px 0 8px 0; color: #333; font-size: 13px;">Box Construction Summary</h5>
                        <div style="background: #e8f4f9; border-radius: 4px; padding: 12px; font-size: 12px;">
                            <h6 style="margin: 0 0 10px 0; font-size: 12px; color: #333;">Configuration</h6>
                            <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px 15px; margin-bottom: 15px;">
                                <span style="color: #666;">Frame Style:</span>
                                <span><strong>${cabinetFrameStyle === 'inset' ? 'Inset' : 'Overlay'}</strong></span>
                                
                                <span style="color: #666;">Slide Type:</span>
                                <span>${drawerSlideType === 'side' ? 'Side Mount' : 'Bottom Mount'}</span>
                                
                                <span style="color: #666;">Number of Drawers:</span>
                                <span>${boxCalculations.length}</span>
                            </div>
                            
                            <h6 style="margin: 15px 0 10px 0; font-size: 12px; color: #333;">Box Dimensions${boxCalculations.length > 1 && boxCalculations.some((d, i) => i > 0 && d.boxHeight !== boxCalculations[0].boxHeight) ? ' (Drawer 1 shown)' : ' (All Drawers)'}</h6>
                            <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px 15px; margin-bottom: 15px;">
                                <span style="color: #666;">Box Width:</span>
                                <span><strong>${inchesToDisplay(boxCalculations[0].boxWidth)}</strong></span>
                                
                                <span style="color: #666;">Box Height:</span>
                                <span><strong>${inchesToDisplay(boxCalculations[0].boxHeight)}</strong></span>
                                
                                <span style="color: #666;">Box Depth (sides):</span>
                                <span><strong>${inchesToDisplay(boxCalculations[0].boxDepth)}</strong></span>
                                
                                <span style="color: #666;">Total Assembled Depth:</span>
                                <span><strong>${inchesToDisplay(boxCalculations[0].totalDepth)}</strong></span>
                                
                                <span style="color: #666;">Front/Back Width:</span>
                                <span>${inchesToDisplay(boxCalculations[0].boxWidth)}</span>
                                
                                <span style="color: #666;">Front/Back Height:</span>
                                <span>${inchesToDisplay(boxCalculations[0].boxHeight)}</span>
                                
                                <span style="color: #666;">Bottom Panel:</span>
                                <span>${inchesToDisplay(boxCalculations[0].bottomWidth)} × ${inchesToDisplay(boxCalculations[0].bottomDepth)}</span>
                                
                                <span style="color: #666;">Drawer Face:</span>
                                <span><strong>${inchesToDisplay(boxCalculations[0].faceWidth)} × ${inchesToDisplay(boxCalculations[0].faceHeight)}</strong></span>
                            </div>
                            
                            <h6 style="margin: 15px 0 10px 0; font-size: 12px; color: #333;">Clearances & Offsets</h6>
                            <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px 15px; margin-bottom: 15px;">
                                <span style="color: #666;">Side Clearance:</span>
                                <span>${inchesToDisplay(currentSideClearance)} per side</span>
                                
                                <span style="color: #666;">Top Clearance:</span>
                                <span>${inchesToDisplay(currentTopClearance)}</span>
                                
                                ${drawerSlideType === 'bottom' ? `
                                <span style="color: #666;">Bottom Clearance:</span>
                                <span>${inchesToDisplay(currentBottomClearance)}</span>
                                ` : ''}
                                
                                <span style="color: #666;">Rear Clearance:</span>
                                <span>${inchesToDisplay(currentRearClearance)}</span>
                                
                                <span style="color: #666;">Face-to-Box Offset:</span>
                                <span>${boxCalculations[0].horizontalOffset} H × ${boxCalculations[0].verticalOffset} V</span>
                            </div>
                            
                            <h6 style="margin: 15px 0 10px 0; font-size: 12px; color: #333;">Material & Hardware</h6>
                            <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px 15px; margin-bottom: 15px;">
                                <span style="color: #666;">Box Material:</span>
                                <span>${inchesToDisplay(currentBoxMaterialThickness)} thick</span>
                                
                                <span style="color: #666;">Bottom Panel:</span>
                                <span>${inchesToDisplay(currentBottomThickness)} thick</span>
                                
                                <span style="color: #666;">Drawer Face:</span>
                                <span>${inchesToDisplay(currentFaceThickness)} thick</span>
                                
                                ${cabinetFrameStyle === 'overlay' ? `
                                <span style="color: #666;">Cabinet Material:</span>
                                <span>${inchesToDisplay(currentCabinetMaterialThickness)} thick</span>
                                ` : ''}
                                
                                <span style="color: #666;">Slide Length:</span>
                                <span>${boxCalculations[0].slideLength}</span>
                            </div>
                            
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ccc; font-size: 11px; color: #666;">
                                <strong>Depth Calculation:</strong><br>
                                ${cabinetFrameStyle === 'inset' ? 
                                    `Max Depth = ${inchesToDisplay(currentCabinetDepthInches)} - ${inchesToDisplay(currentRearClearance)} = ${inchesToDisplay(currentCabinetDepthInches - currentRearClearance)}<br>
                                     Side Length = ${inchesToDisplay(currentCabinetDepthInches - currentRearClearance)} - (2 × ${inchesToDisplay(currentBoxMaterialThickness)}) = ${inchesToDisplay(boxCalculations[0].boxDepth)}` :
                                    `Max Depth = ${inchesToDisplay(currentCabinetDepthInches)} + ${inchesToDisplay(currentCabinetMaterialThickness)} - ${inchesToDisplay(currentRearClearance)} = ${inchesToDisplay(currentCabinetDepthInches + currentCabinetMaterialThickness - currentRearClearance)}<br>
                                     Side Length = ${inchesToDisplay(currentCabinetDepthInches + currentCabinetMaterialThickness - currentRearClearance)} - (2 × ${inchesToDisplay(currentBoxMaterialThickness)}) = ${inchesToDisplay(boxCalculations[0].boxDepth)}`
                                }
                            </div>
                        </div>
                    `;
                }
            }
            
            cutListDiv.innerHTML = cutListHTML;
            cutListDiv.style.display = 'block';
            
            // Update visual diagrams
            updateCabinetDiagrams(layoutData);
            
            // Update drawer box diagrams if enabled
            console.log('DEBUG: Diagram update check - includeDrawerBox:', includeDrawerBox, 'currentCabinetDepthInches:', currentCabinetDepthInches);
            if (includeDrawerBox && currentCabinetDepthInches > 0) {
                console.log('DEBUG: Calculating drawer boxes...');
                const boxCalculations = calculateDrawerBoxes(drawerData, layoutData);
                console.log('DEBUG: Box calculations result:', boxCalculations);
                if (boxCalculations && boxCalculations.length > 0) {
                    console.log('DEBUG: Updating drawer box diagrams with', boxCalculations.length, 'drawers');
                    // Ensure container is visible
                    const boxContainer = document.getElementById('drawerBoxDiagramContainer');
                    boxContainer.style.display = 'block';
                    
                    updateDrawerBoxDiagrams(boxCalculations);
                    updateFaceToBoxMountingDiagram(boxCalculations);
                } else {
                    // Clear diagrams if calculations are invalid
                    const topView = document.getElementById('drawerBoxTopView');
                    const dimensionDisplay = document.getElementById('boxDimensionDisplay');
                    const faceToBoxDiagram = document.getElementById('faceToBoxMountingDiagram');
                    
                    if (topView) topView.innerHTML = '<text x="250" y="200" text-anchor="middle" font-size="12" fill="#999">Insufficient dimensions for drawer box</text>';
                    if (dimensionDisplay) dimensionDisplay.style.display = 'none';
                    if (faceToBoxDiagram) faceToBoxDiagram.style.display = 'none';
                }
            }
        }
        
        // Calculate drawer box dimensions
        function calculateDrawerBoxes(drawerData, layoutData) {
            if (!includeDrawerBox || currentCabinetDepthInches <= 0) return null;
            
            const boxCalculations = [];
            
            // Standard slide lengths (in inches)
            const standardSlideLengths = [8, 10, 12, 14, 16, 18, 20, 22, 24];
            
            // Calculate maximum TOTAL box depth based on cabinet depth and clearances
            // Note: currentCabinetDepthInches is the interior clear depth (inside face frame to inside back wall)
            let maxTotalBoxDepth;
            if (cabinetFrameStyle === 'inset') {
                // For inset, drawer box can use the full interior depth minus rear clearance
                maxTotalBoxDepth = currentCabinetDepthInches - currentRearClearance;
            } else {
                // For overlay, box extends forward by cabinet material thickness
                maxTotalBoxDepth = currentCabinetDepthInches + currentCabinetMaterialThickness - currentRearClearance;
            }
            
            // Calculate the actual side length needed
            const sideLength = maxTotalBoxDepth - (2 * currentBoxMaterialThickness);
            
            // Validate that we have enough depth for a drawer box
            if (sideLength <= 0) {
                console.warn('Insufficient depth for drawer box. Need more than', (2 * currentBoxMaterialThickness) + currentRearClearance, 'inches total depth.');
                return null;
            }
            
            // Validate groove depth vs panel thickness
            if (currentBottomDadoDepth < currentBottomThickness) {
                showNotification(`Warning: Groove depth (${inchesToDisplay(currentBottomDadoDepth)}) is less than panel thickness (${inchesToDisplay(currentBottomThickness)}). Panel may not fit properly.`, 'warning');
            }
            
            // Find appropriate slide length (must be <= total box depth, not side length)
            // Slides mount to the assembled box, so they can be up to the full box depth
            const recommendedSlideLength = [...standardSlideLengths].reverse().find(length => length <= maxTotalBoxDepth) || standardSlideLengths[0];
            
            // Debug logging
            console.log('Drawer Box Calculation Debug:');
            console.log('Cabinet Depth:', currentCabinetDepthInches);
            console.log('Rear Clearance:', currentRearClearance);
            console.log('Box Material Thickness:', currentBoxMaterialThickness);
            console.log('Max Total Box Depth:', maxTotalBoxDepth);
            console.log('Side Length:', sideLength);
            console.log('Recommended Slide Length:', recommendedSlideLength);
            
            drawerData.forEach(drawer => {
                // Calculate box width
                let boxWidth;
                if (cabinetFrameStyle === 'inset') {
                    // Inset: account for reveals and slide clearances
                    boxWidth = currentCabinetWidthInches - (2 * currentHorizontalRevealInches) - (2 * currentSideClearance);
                } else {
                    // Overlay: just slide clearances
                    boxWidth = currentCabinetWidthInches - (2 * currentSideClearance);
                }
                
                // Calculate box height
                let boxHeight;
                if (drawerSlideType === 'bottom') {
                    // Bottom mount needs specific clearances:
                    // - Top: currentTopClearance
                    // - Bottom: currentBottomClearance for clip hardware
                    boxHeight = drawer.height - currentTopClearance - currentBottomClearance;
                } else {
                    // Side mount only needs top clearance
                    boxHeight = drawer.height - currentTopClearance;
                }
                
                // For inset custom drawers, drawer.height is the opening size
                if (cabinetFrameStyle === 'inset' && drawer.isCustom) {
                    boxHeight = drawer.height - (2 * currentVerticalRevealInches) - currentTopClearance;
                    // Also subtract bottom clearance for bottom mount
                    if (drawerSlideType === 'bottom') {
                        boxHeight -= currentBottomClearance;
                    }
                }
                
                // Validate box height is positive
                if (boxHeight <= 0) {
                    console.warn('Box height is too small after applying clearances. Height would be:', boxHeight);
                    return null;
                }
                
                // Calculate bottom panel dimensions (accounting for dado)
                // Panel extends into grooves on all four sides by the panel thickness amount
                const bottomWidth = (boxWidth - 2 * currentBoxMaterialThickness) + (2 * currentBottomThickness);
                const bottomDepth = sideLength + (2 * currentBottomThickness);
                
                // Calculate face mounting offsets
                let horizontalOffset, verticalOffset;
                if (cabinetFrameStyle === 'inset') {
                    // Face is same width as opening minus reveals
                    const faceWidth = currentCabinetWidthInches - (2 * currentHorizontalRevealInches);
                    const faceHeight = drawer.height - (drawer.isCustom ? 0 : 2 * currentVerticalRevealInches);
                    horizontalOffset = (faceWidth - boxWidth) / 2;
                    
                    // Vertical offset depends on slide type
                    if (drawerSlideType === 'bottom') {
                        // Bottom mount: offset by bottom clearance
                        verticalOffset = currentBottomClearance;
                    } else {
                        // Side mount: bottom-aligned (no offset)
                        verticalOffset = 0;
                    }
                } else {
                    // Overlay face extends beyond box
                    const faceWidth = drawer.width;
                    const faceHeight = drawer.height;
                    horizontalOffset = (faceWidth - boxWidth) / 2;
                    
                    // Vertical offset depends on slide type
                    if (drawerSlideType === 'bottom') {
                        // Bottom mount: offset by bottom clearance
                        verticalOffset = currentBottomClearance;
                    } else {
                        // Side mount: bottom-aligned (no offset)
                        verticalOffset = 0;
                    }
                }
                
                // The actual total box depth includes front and back thickness
                const totalBoxDepth = sideLength + (2 * currentBoxMaterialThickness);
                
                boxCalculations.push({
                    number: drawer.number,
                    boxWidth: boxWidth,
                    boxHeight: boxHeight,
                    boxDepth: sideLength,  // This is the side length
                    totalDepth: totalBoxDepth,  // This is the complete box depth
                    bottomWidth: bottomWidth,
                    bottomDepth: bottomDepth,
                    slideLength: inchesToDisplay(recommendedSlideLength),
                    faceWidth: drawer.width,
                    faceHeight: cabinetFrameStyle === 'inset' && drawer.isCustom ? 
                        drawer.height - (2 * currentVerticalRevealInches) : drawer.height,
                    horizontalOffset: inchesToDisplay(horizontalOffset),
                    verticalOffset: inchesToDisplay(verticalOffset),
                    mountingHoleOffset: inchesToDisplay(Math.min(1, boxWidth * 0.15)), // 1" or 15% of width
                    mountingHoleOffsetInches: Math.min(1, boxWidth * 0.15) // Store numeric value for calculations
                });
            });
            
            return boxCalculations;
        }
        
        // Calculate rail positions and drawer layout
        function calculateRailPositions(drawerData, drawerMode = 'equal') {
            const positions = [];
            let currentPosition = 0;
            
            // All positioning is bottom-up (measurements from bottom)
                if (cabinetFrameStyle === 'overlay') {
                    // Overlay mode - drawers extend beyond cabinet bounds
                    // Calculate actual drawer box positions first
                    const numRails = drawerData.length - 1;
                    const totalRailHeight = numRails * currentRailThicknessInches;
                    const availableForDrawers = currentCabinetHeightInches - totalRailHeight;
                    const drawerBoxHeight = availableForDrawers / drawerData.length;
                    
                    currentPosition = 0; // Start at bottom of cabinet
                    
                    drawerData.forEach((drawer, index) => {
                        // Calculate drawer front position
                        // Each drawer extends beyond its opening by overlay amount on both sides
                        const drawerBottom = currentPosition - currentOverlayAmountInches;
                        const drawerTop = currentPosition + drawerBoxHeight + currentOverlayAmountInches;
                        
                        positions.push({
                            type: 'drawer',
                            number: drawer.number,
                            bottom: drawerBottom,
                            top: drawerTop,
                            height: drawerTop - drawerBottom,
                            width: drawer.width
                        });
                        
                        // Move to next drawer box position
                        currentPosition += drawerBoxHeight;
                        
                        // Add rail if not last drawer
                        if (index < drawerData.length - 1) {
                            const railBottom = currentPosition;
                            const railTop = railBottom + currentRailThicknessInches;
                            
                            positions.push({
                                type: 'rail',
                                number: index + 1,
                                bottom: railBottom,
                                top: railTop,
                                thickness: currentRailThicknessInches
                            });
                            
                            currentPosition = railTop;
                        }
                    });
                } else {
                    // Inset mode
                    if (drawerMode === 'custom') {
                        // Custom mode: drawer heights are opening sizes
                        // Start at bottom (0) - no reveal adjustment
                        currentPosition = 0;
                        
                        drawerData.forEach((drawer, index) => {
                            const drawerBottom = currentPosition;
                            const drawerTop = currentPosition + drawer.height;
                            
                            positions.push({
                                type: 'drawer',
                                number: drawer.number,
                                bottom: drawerBottom,
                                top: drawerTop,
                                height: drawer.height,
                                width: drawer.width
                            });
                            
                            currentPosition = drawerTop;
                            
                            // Add rail if not last drawer
                            if (index < drawerData.length - 1 && currentRailThicknessInches > 0) {
                                // No reveals in custom mode - rails directly adjacent to openings
                                const railBottom = currentPosition;
                                const railTop = currentPosition + currentRailThicknessInches;
                                
                                positions.push({
                                    type: 'rail',
                                    number: index + 1,
                                    bottom: railBottom,
                                    top: railTop,
                                    thickness: currentRailThicknessInches
                                });
                                
                                currentPosition = railTop;
                            }
                        });
                        
                    } else {
                        // Equal mode: position drawer openings to fill cabinet exactly
                        drawerData.forEach((drawer, index) => {
                            // Use opening height if available (for inset), otherwise use drawer height
                            const openingHeight = drawer.openingHeight || drawer.height;
                            
                            const drawerBottom = currentPosition;
                            const drawerTop = currentPosition + openingHeight;
                        
                        
                        positions.push({
                            type: 'drawer',
                            number: drawer.number,
                            bottom: drawerBottom,
                            top: drawerTop,
                            height: openingHeight,
                            width: drawer.width
                        });
                        
                        currentPosition = drawerTop;
                        
                        // Add rail if not last drawer
                        if (index < drawerData.length - 1 && currentRailThicknessInches > 0) {
                            // Rails are directly adjacent to openings (no reveals)
                            const railBottom = currentPosition;
                            const railTop = currentPosition + currentRailThicknessInches;
                            
                            positions.push({
                                type: 'rail',
                                number: index + 1,
                                bottom: railBottom,
                                top: railTop,
                                thickness: currentRailThicknessInches
                            });
                            
                            currentPosition = railTop;
                        }
                        });
                    }
                }
            
            return {
                positions: positions,
                cabinetHeight: currentCabinetHeightInches,
                cabinetWidth: currentCabinetWidthInches,
                layoutDirection: 'bottom-up',
                frameStyle: cabinetFrameStyle,
                drawerMode: drawerMode,
                reveals: {
                    horizontal: currentHorizontalRevealInches,
                    vertical: currentVerticalRevealInches
                },
                overlay: currentOverlayAmountInches
            };
        }
        
        // Update SVG diagrams
        function updateCabinetDiagrams(layoutData) {
            const frontView = document.getElementById('cabinetFrontView');
            const railView = document.getElementById('cabinetRailView');
            
            if (!frontView || !railView) return;
            
            if (!layoutData) {
                // Reset to empty state
                frontView.innerHTML = `
                    <rect x="70" y="20" width="260" height="360" fill="none" stroke="#666" stroke-width="2" stroke-dasharray="5,5"/>
                    <text x="200" y="200" text-anchor="middle" font-size="14" fill="#999">
                        Configure cabinet to see layout
                    </text>
                `;
                railView.innerHTML = `
                    <rect x="70" y="20" width="260" height="360" fill="none" stroke="#666" stroke-width="2" stroke-dasharray="5,5"/>
                    <text x="200" y="200" text-anchor="middle" font-size="14" fill="#999">
                        Rail placement guide
                    </text>
                `;
                return;
            }
            
            // Front view
            const svgWidth = 400;
            const svgHeight = 400;
            const leftMargin = 40;
            const rightMargin = 120;
            const topMargin = 40;
            const bottomMargin = 40;
            const drawableWidth = svgWidth - leftMargin - rightMargin;
            const drawableHeight = svgHeight - topMargin - bottomMargin;
            
            // Scale to fit
            const scale = Math.min(
                drawableWidth / layoutData.cabinetWidth,
                drawableHeight / layoutData.cabinetHeight
            ) * 0.85;
            
            const cabinetPixelWidth = layoutData.cabinetWidth * scale;
            const cabinetPixelHeight = layoutData.cabinetHeight * scale;
            const offsetX = leftMargin + (drawableWidth - cabinetPixelWidth) / 2;
            const offsetY = topMargin + (drawableHeight - cabinetPixelHeight) / 2;
            
            let frontContent = `
                <defs>
                    <pattern id="drawerWood" patternUnits="userSpaceOnUse" width="60" height="30">
                        <rect width="60" height="30" fill="#D2691E"/>
                        <path d="M0,5 Q15,3 30,5 T60,5" stroke="#BC611A" stroke-width="0.8" fill="none"/>
                        <path d="M0,15 Q10,12 20,15 T60,15" stroke="#C86A1C" stroke-width="1" fill="none"/>
                        <path d="M0,25 Q20,22 40,25 T60,25" stroke="#BC611A" stroke-width="0.9" fill="none"/>
                    </pattern>
                    <pattern id="railWood" patternUnits="userSpaceOnUse" width="60" height="20">
                        <rect width="60" height="20" fill="#8B4513"/>
                        <path d="M0,5 Q15,4 30,5 T60,5" stroke="#7A3A0F" stroke-width="0.8" fill="none"/>
                        <path d="M0,15 Q20,14 40,15 T60,15" stroke="#7A3A0F" stroke-width="0.8" fill="none"/>
                    </pattern>
                </defs>
            `;
            
            // Draw cabinet opening
            frontContent += `<rect x="${offsetX}" y="${offsetY}" width="${cabinetPixelWidth}" height="${cabinetPixelHeight}" 
                            fill="none" stroke="#333" stroke-width="2"/>`;
            
            // Draw rails first (behind drawers)
            layoutData.positions.filter(item => item.type === 'rail').forEach(rail => {
                const railY = offsetY + (layoutData.cabinetHeight - rail.top) * scale;
                const railHeight = rail.thickness * scale;
                
                frontContent += `
                    <rect x="${offsetX}" y="${railY}" width="${cabinetPixelWidth}" height="${railHeight}" 
                          fill="url(#railWood)" stroke="#654321" stroke-width="1"/>
                `;
            });
            
            // Draw drawers on top of rails
            layoutData.positions.filter(item => item.type === 'drawer').forEach(drawer => {
                let y, height, x, width;
                
                if (layoutData.frameStyle === 'inset' && layoutData.drawerMode === 'custom') {
                    // Custom inset mode: drawer.height is opening size, need to show drawer front with reveals
                    const actualDrawerHeight = drawer.height - (2 * layoutData.reveals.vertical);
                    // Calculate position based on opening, then add reveal offset
                    const openingY = offsetY + (layoutData.cabinetHeight - drawer.top) * scale;
                    
                    
                    // Check if this is the topmost drawer (highest top value)
                    const allDrawers = layoutData.positions.filter(item => item.type === 'drawer');
                    const maxTop = Math.max(...allDrawers.map(d => d.top));
                    
                    if (drawer.top === maxTop) {
                        // Top drawer: position so there's a reveal at the top of the cabinet
                        y = offsetY + (layoutData.reveals.vertical * scale);
                    } else {
                        // Other drawers: position with reveal from the opening top
                        y = openingY + (layoutData.reveals.vertical * scale);
                    }
                    
                    height = actualDrawerHeight * scale;
                    x = offsetX + (layoutData.reveals.horizontal * scale);
                    width = (layoutData.cabinetWidth - 2 * layoutData.reveals.horizontal) * scale;
                } else if (layoutData.frameStyle === 'inset') {
                    // Equal inset mode: drawer.height is opening size, need to calculate drawer front
                    const actualDrawerHeight = drawer.height - (2 * layoutData.reveals.vertical);
                    const openingY = offsetY + (layoutData.cabinetHeight - drawer.top) * scale;
                    
                    y = openingY + (layoutData.reveals.vertical * scale);
                    height = actualDrawerHeight * scale;
                    x = offsetX + (layoutData.reveals.horizontal * scale);
                    width = (layoutData.cabinetWidth - 2 * layoutData.reveals.horizontal) * scale;
                } else {
                    // Overlay mode
                    y = offsetY + (layoutData.cabinetHeight - drawer.top) * scale;
                    height = drawer.height * scale;
                    x = offsetX - (layoutData.overlay * scale);
                    width = (layoutData.cabinetWidth + 2 * layoutData.overlay) * scale;
                }
                
                // Draw drawer front with opacity for overlay mode
                const drawerOpacity = layoutData.frameStyle === 'overlay' ? '0.85' : '1';
                frontContent += `
                    <rect x="${x}" y="${y}" width="${width}" height="${height}" 
                          fill="url(#drawerWood)" stroke="#8B4513" stroke-width="1.5" opacity="${drawerOpacity}"/>
                    <text x="${x + width/2}" y="${y + height/2 + 5}" text-anchor="middle" 
                          font-size="12" fill="white" font-weight="bold">D${drawer.number}</text>
                `;
            });
            
            // Add dimensions
            frontContent += `
                <text x="${offsetX + cabinetPixelWidth + 10}" y="${offsetY + cabinetPixelHeight/2}" 
                      font-size="11" fill="#666" transform="rotate(-90, ${offsetX + cabinetPixelWidth + 10}, ${offsetY + cabinetPixelHeight/2})">
                    ${inchesToDisplay(layoutData.cabinetHeight)}
                </text>
                <text x="${offsetX + cabinetPixelWidth/2}" y="${offsetY + cabinetPixelHeight + 20}" 
                      text-anchor="middle" font-size="11" fill="#666">
                    ${inchesToDisplay(layoutData.cabinetWidth)}
                </text>
            `;
            
            frontView.innerHTML = frontContent;
            
            // Rail placement view
            updateCabinetRailView(layoutData, railView);
        }
        
        // Update selected drawer for diagrams
        function updateSelectedDrawer() {
            const selector = document.getElementById('selectedDrawer');
            if (selector) {
                selectedDrawerIndex = parseInt(selector.value) || 0;
                // Re-calculate to update diagrams
                calculateCabinetLayout();
            }
        }
        
        // Update drawer box construction diagrams
        function updateDrawerBoxDiagrams(boxCalculations) {
            console.log('DEBUG: updateDrawerBoxDiagrams called with:', boxCalculations);
            console.log('DEBUG: Current slide type:', drawerSlideType);
            const topView = document.getElementById('drawerBoxTopView');
            const dimensionDisplay = document.getElementById('boxDimensionDisplay');
            
            console.log('DEBUG: SVG elements found - topView:', !!topView);
            console.log('DEBUG: dimensionDisplay found:', !!dimensionDisplay);
            
            if (!topView || !boxCalculations || boxCalculations.length === 0) {
                console.log('DEBUG: Early return - missing elements or no box calculations');
                if (dimensionDisplay) {
                    dimensionDisplay.style.display = 'none';
                }
                if (topView) {
                    topView.innerHTML = '<text x="250" y="200" text-anchor="middle" font-size="12" fill="#999">Insufficient dimensions for drawer box</text>';
                }
                return;
            }
            
            // Show dimension display
            dimensionDisplay.style.display = 'block';
            
            // Populate drawer selector if multiple drawers
            const drawerSelectorDiv = document.getElementById('drawerSelector');
            const drawerSelect = document.getElementById('selectedDrawer');
            if (boxCalculations.length > 1 && drawerSelectorDiv && drawerSelect) {
                drawerSelectorDiv.style.display = 'flex';
                drawerSelect.innerHTML = boxCalculations.map((drawer, index) => 
                    `<option value="${index}" ${index === selectedDrawerIndex ? 'selected' : ''}>Drawer ${drawer.number}</option>`
                ).join('');
            } else if (drawerSelectorDiv) {
                drawerSelectorDiv.style.display = 'none';
            }
            
            // Use selected drawer for demonstration
            const drawer = boxCalculations[selectedDrawerIndex] || boxCalculations[0];
            
            // SVG dimensions for top view
            const svgWidth = 600;
            const svgHeight = 500;
            const padding = 70;
            const drawableWidth = svgWidth - (2 * padding);
            const drawableHeight = svgHeight - (2 * padding);
            const centerX = svgWidth / 2;
            const centerY = svgHeight / 2;
            
            // Calculate scale to fit the largest dimension with padding
            const maxDimension = Math.max(drawer.boxWidth, drawer.boxDepth);
            const scale = Math.min(drawableWidth, drawableHeight) / maxDimension * 0.9; // 90% to maximize size
            
            // Common dimensions for top view
            const boxW = drawer.boxWidth * scale;
            const boxD = drawer.boxDepth * scale;
            const matThick = Math.max(currentBoxMaterialThickness * scale, 4); // Minimum 4px for visibility in larger view
            
            // Top view content
            let topContent = `
                <defs>
                    <pattern id="plywoodPattern" patternUnits="userSpaceOnUse" width="40" height="40">
                        <rect width="40" height="40" fill="#F5DEB3"/>
                        <path d="M0,10 L40,10 M0,20 L40,20 M0,30 L40,30" stroke="#DEB887" stroke-width="0.5"/>
                    </pattern>
                    <pattern id="bottomPattern" patternUnits="userSpaceOnUse" width="30" height="30">
                        <rect width="30" height="30" fill="#FAEBD7"/>
                        <circle cx="15" cy="15" r="10" fill="none" stroke="#D2B48C" stroke-width="0.5"/>
                    </pattern>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#999"/>
                    </marker>
                </defs>
            `;
            
            // Top view positioning
            const topX = centerX - boxW / 2;
            const topY = centerY - boxD / 2;
            
            // Draw top view
            topContent += `
                <!-- Box top view -->
                <g class="drawer-part" data-part="box-top" data-dims="Width: ${inchesToDisplay(drawer.boxWidth)} × Total Depth: ${inchesToDisplay(drawer.totalDepth)}">
                    <!-- Back (full width) -->
                    <rect x="${topX}" y="${topY}" width="${boxW}" height="${matThick}" 
                          fill="url(#plywoodPattern)" stroke="#8B4513" stroke-width="1.5"/>
                    
                    <!-- Front (full width) -->
                    <rect x="${topX}" y="${topY + boxD - matThick}" width="${boxW}" height="${matThick}" 
                          fill="url(#plywoodPattern)" stroke="#8B4513" stroke-width="1.5"/>
                    
                    <!-- Left side (between front/back) -->
                    <rect x="${topX}" y="${topY + matThick}" width="${matThick}" height="${boxD - 2 * matThick}" 
                          fill="url(#plywoodPattern)" stroke="#8B4513" stroke-width="1.5"/>
                    
                    <!-- Right side (between front/back) -->
                    <rect x="${topX + boxW - matThick}" y="${topY + matThick}" width="${matThick}" height="${boxD - 2 * matThick}" 
                          fill="url(#plywoodPattern)" stroke="#8B4513" stroke-width="1.5"/>
                    
                    <!-- Bottom panel (visible from top) -->
                    <rect x="${topX + matThick}" y="${topY + matThick}" 
                          width="${boxW - 2 * matThick}" height="${boxD - 2 * matThick}" 
                          fill="url(#bottomPattern)" stroke="#D2B48C" stroke-width="0.5" opacity="0.4"/>
                    
                    <!-- Construction labels -->
                    <g font-size="10" fill="#666" text-anchor="middle">
                        <text x="${centerX}" y="${topY + matThick/2 + 3}">BACK</text>
                        <text x="${centerX}" y="${topY + boxD - matThick/2 + 3}">FRONT</text>
                        <text x="${topX + matThick/2}" y="${centerY}" transform="rotate(-90, ${topX + matThick/2}, ${centerY})">LEFT</text>
                        <text x="${topX + boxW - matThick/2}" y="${centerY}" transform="rotate(90, ${topX + boxW - matThick/2}, ${centerY})">RIGHT</text>
                    </g>
                </g>
                
                <!-- Slide indicators -->
                ${drawerSlideType === 'side' ? `
                    <g opacity="0.6">
                        <rect x="${topX - 15}" y="${topY}" width="10" height="${boxD}" 
                              fill="#e0e0e0" stroke="#999" stroke-width="1" stroke-dasharray="3,2"/>
                        <rect x="${topX + boxW + 5}" y="${topY}" width="10" height="${boxD}" 
                              fill="#e0e0e0" stroke="#999" stroke-width="1" stroke-dasharray="3,2"/>
                        <text x="${topX - 20}" y="${centerY}" text-anchor="middle" font-size="9" fill="#666" 
                              transform="rotate(-90, ${topX - 20}, ${centerY})">
                            Side Mount Slide
                        </text>
                        <text x="${topX + boxW + 20}" y="${centerY}" text-anchor="middle" font-size="9" fill="#666" 
                              transform="rotate(90, ${topX + boxW + 20}, ${centerY})">
                            Side Mount Slide
                        </text>
                    </g>
                ` : ''}
                
                <!-- Dimension lines -->
                <g stroke="#999" stroke-width="0.5" fill="none">
                    <!-- Width dimension -->
                    <line x1="${topX}" y1="${topY - 20}" x2="${topX + boxW}" y2="${topY - 20}" marker-end="url(#arrowhead)" marker-start="url(#arrowhead)"/>
                    <text x="${centerX}" y="${topY - 25}" text-anchor="middle" font-size="12" fill="#666" font-weight="600">
                        ${inchesToDisplay(drawer.boxWidth)} Box Width
                    </text>
                    
                    <!-- Depth dimension -->
                    <line x1="${topX - 30}" y1="${topY}" x2="${topX - 30}" y2="${topY + boxD}" marker-end="url(#arrowhead)" marker-start="url(#arrowhead)"/>
                    <text x="${topX - 35}" y="${centerY}" text-anchor="middle" font-size="12" fill="#666" font-weight="600" transform="rotate(-90, ${topX - 35}, ${centerY})">
                        ${inchesToDisplay(drawer.totalDepth)} Total Depth
                    </text>
                    
                    <!-- Side length dimension -->
                    <line x1="${topX + matThick}" y1="${topY + boxD + 25}" x2="${topX + boxW - matThick}" y2="${topY + boxD + 25}" marker-end="url(#arrowhead)" marker-start="url(#arrowhead)" stroke-dasharray="2,2"/>
                    <text x="${centerX}" y="${topY + boxD + 40}" text-anchor="middle" font-size="10" fill="#999">
                        ${inchesToDisplay(drawer.boxDepth)} Side Length (cut between front/back)
                    </text>
                    
                    <!-- Clearance indicators -->
                    <g font-size="9" fill="#999">
                        <line x1="${topX - matThick - 8}" y1="${topY + 30}" x2="${topX}" y2="${topY + 30}" stroke-dasharray="1,1"/>
                        <text x="${topX - matThick/2 - 8}" y="${topY + 27}" text-anchor="middle" font-size="8">${inchesToDisplay(currentSideClearance)}</text>
                        <line x1="${topX + boxW}" y1="${topY + 30}" x2="${topX + boxW + matThick + 8}" y2="${topY + 30}" stroke-dasharray="1,1"/>
                        <text x="${topX + boxW + matThick/2 + 8}" y="${topY + 27}" text-anchor="middle" font-size="8">${inchesToDisplay(currentSideClearance)}</text>
                    </g>
                </g>
                
                <!-- Labels -->
                <text x="${centerX}" y="25" text-anchor="middle" font-size="14" fill="#666" font-weight="600">
                    Drawer Box Construction - Top View
                </text>
                
                <!-- Front indicator -->
                <g>
                    <text x="${centerX}" y="${topY + boxD + 60}" text-anchor="middle" font-size="11" fill="#666">
                        ↓ FRONT ↓
                    </text>
                </g>
                
                <!-- Construction note -->
                <text x="${centerX}" y="${svgHeight - 15}" text-anchor="middle" font-size="10" fill="#999">
                    Front/back run full width • Sides fit between front/back
                </text>
            `;
            
            topView.innerHTML = topContent;
            
            // Add interactivity to the top view
            const allParts = document.querySelectorAll('.drawer-part');
            const dimensionText = document.getElementById('boxDimensionText');
            
            allParts.forEach(part => {
                part.addEventListener('mouseenter', function() {
                    this.style.opacity = '1';
                    this.style.filter = 'drop-shadow(3px 3px 6px rgba(0,0,0,0.3))';
                    const dims = this.getAttribute('data-dims');
                    if (dimensionText) {
                        dimensionText.textContent = dims;
                    }
                });
                
                part.addEventListener('mouseleave', function() {
                    this.style.opacity = '';
                    this.style.filter = '';
                    if (dimensionText) {
                        dimensionText.textContent = 'Hover over components to see details';
                    }
                });
            });
            
            console.log('DEBUG: updateDrawerBoxDiagrams completed successfully');
        }
        
        // Update face-to-box mounting diagram
        function updateFaceToBoxMountingDiagram(boxCalculations) {
            const frontView = document.getElementById('faceToBoxFrontView');
            const sideView = document.getElementById('faceToBoxSideView');
            const diagramContainer = document.getElementById('faceToBoxMountingDiagram');
            
            if (!frontView || !sideView || !boxCalculations || boxCalculations.length === 0) return;
            
            // Show the diagram container
            diagramContainer.style.display = 'block';
            
            // Use selected drawer for demonstration
            const drawer = boxCalculations[selectedDrawerIndex] || boxCalculations[0];
            
            // SVG dimensions
            const svgSize = 450;
            const padding = 70; // Padding for dimension lines and labels
            const drawableSize = svgSize - (2 * padding);
            const centerX = svgSize / 2;
            const centerY = svgSize / 2;
            
            // Calculate scale to fit the largest dimension
            const maxDimension = Math.max(drawer.faceWidth, drawer.faceHeight);
            const scale = drawableSize / maxDimension * 0.9; // 90% to maximize size while leaving room for dimensions
            
            // Create front view showing face and box alignment
            let frontContent = `
                <defs>
                    <pattern id="woodGrain" patternUnits="userSpaceOnUse" width="40" height="40">
                        <rect width="40" height="40" fill="#D2691E"/>
                        <path d="M0,10 L40,10 M0,20 L40,20 M0,30 L40,30" stroke="#A0522D" stroke-width="0.5" opacity="0.3"/>
                    </pattern>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#666"/>
                    </marker>
                    <marker id="centerArrow" markerWidth="8" markerHeight="8" refX="4" refY="4" orient="auto">
                        <circle cx="4" cy="4" r="2" fill="#ff0000"/>
                    </marker>
                </defs>
            `;
            
            // Dimensions
            const faceW = drawer.faceWidth * scale;
            const faceH = drawer.faceHeight * scale;
            const boxW = drawer.boxWidth * scale;
            const boxH = drawer.boxHeight * scale;
            
            // Calculate positions
            const faceX = centerX - faceW / 2;
            const faceY = centerY - faceH / 2;
            const boxX = centerX - boxW / 2;
            // Box is bottom-aligned with face, adjusted by vertical offset
            const verticalOffsetScaled = parseFloat(drawer.verticalOffset.replace(/['"]/g, '')) * scale;
            // Position box based on slide type
            let boxY;
            if (drawerSlideType === 'bottom') {
                // Bottom mount: position from top with top clearance
                boxY = faceY + (currentTopClearance * scale);
            } else {
                // Side mount: position from bottom (flush)
                boxY = faceY + faceH - boxH;
            }
            
            // Draw the front view
            frontContent += `
                <!-- Drawer face (shown with transparency) -->
                <g opacity="0.3">
                    <rect x="${faceX}" y="${faceY}" width="${faceW}" height="${faceH}" 
                          fill="url(#woodGrain)" stroke="#8B4513" stroke-width="2"/>
                    <text x="${centerX}" y="${faceY - 5}" text-anchor="middle" font-size="11" fill="#666">
                        Drawer Face: ${inchesToDisplay(drawer.faceWidth)} × ${inchesToDisplay(drawer.faceHeight)}
                    </text>
                </g>
                
                <!-- Drawer box front -->
                <rect x="${boxX}" y="${boxY}" width="${boxW}" height="${boxH}" 
                      fill="none" stroke="#0066cc" stroke-width="2"/>
                <text x="${centerX}" y="${boxY + boxH + 15}" text-anchor="middle" font-size="11" fill="#0066cc">
                    Box Front: ${inchesToDisplay(drawer.boxWidth)} × ${inchesToDisplay(drawer.boxHeight)}
                </text>
                
                <!-- Center lines -->
                <g stroke="#ff0000" stroke-width="0.5" stroke-dasharray="2,2">
                    <line x1="${centerX}" y1="${faceY - 10}" x2="${centerX}" y2="${faceY + faceH + 10}"/>
                    <line x1="${faceX - 10}" y1="${centerY}" x2="${faceX + faceW + 10}" y2="${centerY}"/>
                </g>
                
                <!-- Offset dimensions -->
                <g stroke="#666" stroke-width="0.5" fill="none">
                    <!-- Horizontal offset -->
                    <line x1="${faceX}" y1="${Math.max(faceY - 30, padding / 2)}" x2="${boxX}" y2="${Math.max(faceY - 30, padding / 2)}" 
                          marker-end="url(#arrowhead)" marker-start="url(#arrowhead)"/>
                    <text x="${(faceX + boxX) / 2}" y="${Math.max(faceY - 35, padding / 2 - 5)}" text-anchor="middle" font-size="10" fill="#666">
                        ${drawer.horizontalOffset}
                    </text>
                    
                    <line x1="${boxX + boxW}" y1="${Math.max(faceY - 30, padding / 2)}" x2="${faceX + faceW}" y2="${Math.max(faceY - 30, padding / 2)}" 
                          marker-end="url(#arrowhead)" marker-start="url(#arrowhead)"/>
                    <text x="${(boxX + boxW + faceX + faceW) / 2}" y="${Math.max(faceY - 35, padding / 2 - 5)}" text-anchor="middle" font-size="10" fill="#666">
                        ${drawer.horizontalOffset}
                    </text>
                    
                    <!-- Vertical gaps based on slide type -->
                    ${drawerSlideType === 'bottom' ? `
                        <!-- Top gap (top clearance) -->
                        <line x1="${Math.max(faceX - 40, padding)}" y1="${faceY}" x2="${Math.max(faceX - 40, padding)}" y2="${boxY}" 
                              marker-end="url(#arrowhead)" marker-start="url(#arrowhead)"/>
                        <text x="${Math.max(faceX - 45, padding - 5)}" y="${(faceY + boxY) / 2}" text-anchor="middle" font-size="10" fill="#666"
                              transform="rotate(-90, ${Math.max(faceX - 45, padding - 5)}, ${(faceY + boxY) / 2})">
                            ${inchesToDisplay(currentTopClearance)}
                        </text>
                        
                        <!-- Bottom gap (bottom clearance) -->
                        <line x1="${Math.max(faceX - 40, padding)}" y1="${boxY + boxH}" x2="${Math.max(faceX - 40, padding)}" y2="${faceY + faceH}" 
                              marker-end="url(#arrowhead)" marker-start="url(#arrowhead)"/>
                        <text x="${Math.max(faceX - 45, padding - 5)}" y="${(boxY + boxH + faceY + faceH) / 2}" text-anchor="middle" font-size="10" fill="#666"
                              transform="rotate(-90, ${Math.max(faceX - 45, padding - 5)}, ${(boxY + boxH + faceY + faceH) / 2})">
                            ${inchesToDisplay(currentBottomClearance)}
                        </text>
                    ` : `
                        <!-- Side mount: box is flush at bottom, gap at top -->
                        <line x1="${Math.max(faceX - 40, padding)}" y1="${faceY}" x2="${Math.max(faceX - 40, padding)}" y2="${boxY}" 
                              marker-end="url(#arrowhead)" marker-start="url(#arrowhead)"/>
                        <text x="${Math.max(faceX - 45, padding - 5)}" y="${(faceY + boxY) / 2}" text-anchor="middle" font-size="10" fill="#666"
                              transform="rotate(-90, ${Math.max(faceX - 45, padding - 5)}, ${(faceY + boxY) / 2})">
                            ${inchesToDisplay((boxY - faceY) / scale)}
                        </text>
                    `}
                </g>
                
                <!-- Mounting hole indicators -->
                <g fill="#ff0000" opacity="0.8">
                    <circle cx="${boxX + drawer.mountingHoleOffsetInches * scale}" cy="${boxY + drawer.mountingHoleOffsetInches * scale}" r="3"/>
                    <circle cx="${boxX + boxW - drawer.mountingHoleOffsetInches * scale}" cy="${boxY + drawer.mountingHoleOffsetInches * scale}" r="3"/>
                    <circle cx="${boxX + drawer.mountingHoleOffsetInches * scale}" cy="${boxY + boxH - drawer.mountingHoleOffsetInches * scale}" r="3"/>
                    <circle cx="${boxX + boxW - drawer.mountingHoleOffsetInches * scale}" cy="${boxY + boxH - drawer.mountingHoleOffsetInches * scale}" r="3"/>
                    <text x="${boxX + drawer.mountingHoleOffsetInches * scale}" y="${boxY + drawer.mountingHoleOffsetInches * scale + 15}" text-anchor="middle" font-size="9" fill="#ff0000">
                        ${drawer.mountingHoleOffset}
                    </text>
                </g>
                
                <!-- Title -->
                <text x="${centerX}" y="${padding / 2}" text-anchor="middle" font-size="13" fill="#333" font-weight="600">
                    Face and Box Alignment
                </text>
                
                <!-- Legend -->
                <g font-size="9" fill="#666">
                    <text x="${padding / 2}" y="${svgSize - 30}">Red dots = Pilot hole locations</text>
                    <text x="${padding / 2}" y="${svgSize - 18}">Measure from box edges</text>
                </g>
            `;
            
            frontView.innerHTML = frontContent;
            
            // Create side view
            let sideContent = `
                <defs>
                    <pattern id="crossSection" patternUnits="userSpaceOnUse" width="4" height="4">
                        <rect width="4" height="4" fill="#E0E0E0"/>
                        <path d="M0,0 L4,4 M0,4 L4,0" stroke="#999" stroke-width="0.5"/>
                    </pattern>
                </defs>
            `;
            
            // Side view dimensions - calculate separate scale for side view
            const sideMaxDimension = Math.max(drawer.totalDepth + currentFaceThickness, drawer.faceHeight);
            const sideScale = drawableSize / sideMaxDimension * 0.9; // 90% to maximize size
            
            const thickness = Math.max(currentFaceThickness * sideScale, 10); // Min 10px for visibility
            const boxThickness = Math.max(currentBoxMaterialThickness * sideScale, 8);
            const totalDepth = (drawer.totalDepth + currentFaceThickness) * sideScale;
            const sideH = drawer.faceHeight * sideScale;
            const sideBoxH = drawer.boxHeight * sideScale;
            
            // Position for side view
            const sideX = centerX - totalDepth / 2;
            const sideY = centerY - sideH / 2;
            
            sideContent += `
                <!-- Cabinet opening outline -->
                <rect x="${sideX - 20}" y="${sideY - 20}" width="${totalDepth + 40}" height="${sideH + 40}" 
                      fill="none" stroke="#ccc" stroke-width="1" stroke-dasharray="3,3"/>
                <text x="${centerX}" y="${sideY - 25}" text-anchor="middle" font-size="10" fill="#999">
                    Cabinet Opening
                </text>
                
                <!-- Drawer face (side view) -->
                <rect x="${sideX}" y="${sideY}" width="${thickness}" height="${sideH}" 
                      fill="url(#woodGrain)" stroke="#8B4513" stroke-width="2"/>
                <text x="${sideX + thickness / 2}" y="${sideY - 5}" text-anchor="middle" font-size="10" fill="#666">
                    Face
                </text>
                
                <!-- Drawer box (side view) -->
                <g transform="translate(${thickness}, 0)">
                    <rect x="${sideX}" y="${drawerSlideType === 'bottom' ? sideY + (currentTopClearance * scale) : sideY + sideH - sideBoxH}" width="${totalDepth - thickness}" height="${sideBoxH}" 
                          fill="url(#crossSection)" stroke="#0066cc" stroke-width="1.5"/>
                    
                    <!-- Bottom groove detail -->
                    <line x1="${sideX}" y1="${(drawerSlideType === 'bottom' ? sideY + (currentTopClearance * scale) : sideY + sideH - sideBoxH) + sideBoxH - (currentBottomDadoHeight * scale)}" 
                          x2="${sideX + totalDepth - thickness}" y2="${(drawerSlideType === 'bottom' ? sideY + (currentTopClearance * scale) : sideY + sideH - sideBoxH) + sideBoxH - (currentBottomDadoHeight * scale)}" 
                          stroke="#666" stroke-width="2" stroke-dasharray="2,2"/>
                    <text x="${sideX + 5}" y="${(drawerSlideType === 'bottom' ? sideY + (currentTopClearance * scale) : sideY + sideH - sideBoxH) + sideBoxH - (currentBottomDadoHeight * scale) - 3}" 
                          font-size="8" fill="#666">Groove: ${inchesToDisplay(currentBottomDadoHeight)} up</text>
                    
                    <text x="${sideX + (totalDepth - thickness) / 2}" y="${sideY + sideH + 15}" 
                          text-anchor="middle" font-size="10" fill="#0066cc">
                        Box Depth: ${inchesToDisplay(drawer.totalDepth)}
                    </text>
                </g>
                
                <!-- Mounting screws -->
                <g stroke="#ff0000" stroke-width="2" fill="none">
                    <line x1="${sideX + thickness - 2}" y1="${drawerSlideType === 'bottom' ? sideY + (currentTopClearance * scale) + 30 : sideY + sideH - sideBoxH + 30}" x2="${sideX + thickness + 20}" y2="${drawerSlideType === 'bottom' ? sideY + (currentTopClearance * scale) + 30 : sideY + sideH - sideBoxH + 30}"/>
                    <circle cx="${sideX + thickness - 2}" cy="${drawerSlideType === 'bottom' ? sideY + (currentTopClearance * scale) + 30 : sideY + sideH - sideBoxH + 30}" r="2" fill="#ff0000"/>
                    <text x="${sideX + thickness + 25}" y="${drawerSlideType === 'bottom' ? sideY + (currentTopClearance * scale) + 33 : sideY + sideH - sideBoxH + 33}" font-size="9" fill="#ff0000">1¼" screw</text>
                    
                    <line x1="${sideX + thickness - 2}" y1="${drawerSlideType === 'bottom' ? sideY + (currentTopClearance * scale) + sideBoxH - 30 : sideY + sideH - 30}" x2="${sideX + thickness + 20}" y2="${drawerSlideType === 'bottom' ? sideY + (currentTopClearance * scale) + sideBoxH - 30 : sideY + sideH - 30}"/>
                    <circle cx="${sideX + thickness - 2}" cy="${drawerSlideType === 'bottom' ? sideY + (currentTopClearance * scale) + sideBoxH - 30 : sideY + sideH - 30}" r="2" fill="#ff0000"/>
                </g>
                
                <!-- Dimensions -->
                <g stroke="#666" stroke-width="0.5" fill="none">
                    <!-- Face thickness -->
                    <line x1="${sideX}" y1="${sideY + sideH + 30}" x2="${sideX + thickness}" y2="${sideY + sideH + 30}" 
                          marker-end="url(#arrowhead)" marker-start="url(#arrowhead)"/>
                    <text x="${sideX + thickness / 2}" y="${sideY + sideH + 45}" text-anchor="middle" font-size="10" fill="#666">
                        ${inchesToDisplay(currentFaceThickness)}
                    </text>
                    
                    <!-- Total assembly depth -->
                    <line x1="${sideX}" y1="${sideY + sideH + 50}" x2="${sideX + totalDepth}" y2="${sideY + sideH + 50}" 
                          marker-end="url(#arrowhead)" marker-start="url(#arrowhead)"/>
                    <text x="${centerX}" y="${sideY + sideH + 65}" text-anchor="middle" font-size="10" fill="#666">
                        Total: ${inchesToDisplay(drawer.totalDepth + currentFaceThickness)}
                    </text>
                </g>
                
                <!-- Title -->
                <text x="${centerX}" y="${padding / 2}" text-anchor="middle" font-size="13" fill="#333" font-weight="600">
                    Side Mounting View
                </text>
                
                <!-- Notes -->
                <g font-size="9" fill="#666">
                    <text x="${padding / 2}" y="${svgSize - 30}">Attach from inside box</text>
                    <text x="${padding / 2}" y="${svgSize - 18}">Pre-drill to prevent splitting</text>
                </g>
            `;
            
            sideView.innerHTML = sideContent;
        }
        
        function updateCabinetRailView(layoutData, railView) {
            const svgWidth = 400;
            const svgHeight = 400;
            const leftMargin = 40;
            const rightMargin = 120; // More space for dimensions
            const topMargin = 40;
            const bottomMargin = 40;
            const drawableWidth = svgWidth - leftMargin - rightMargin;
            const drawableHeight = svgHeight - topMargin - bottomMargin;
            
            // Scale to fit
            const scale = Math.min(
                drawableWidth / layoutData.cabinetWidth,
                drawableHeight / layoutData.cabinetHeight
            ) * 0.85;
            
            const cabinetPixelWidth = layoutData.cabinetWidth * scale;
            const cabinetPixelHeight = layoutData.cabinetHeight * scale;
            const offsetX = leftMargin + (drawableWidth - cabinetPixelWidth) / 2;
            const offsetY = topMargin + (drawableHeight - cabinetPixelHeight) / 2;
            
            let railContent = `
                <defs>
                    <pattern id="railWoodGuide" patternUnits="userSpaceOnUse" width="60" height="20">
                        <rect width="60" height="20" fill="#8B4513"/>
                        <path d="M0,5 Q15,4 30,5 T60,5" stroke="#7A3A0F" stroke-width="0.8" fill="none"/>
                        <path d="M0,15 Q20,14 40,15 T60,15" stroke="#7A3A0F" stroke-width="0.8" fill="none"/>
                    </pattern>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#666"/>
                    </marker>
                </defs>
            `;
            
            // Draw cabinet opening
            railContent += `<rect x="${offsetX}" y="${offsetY}" width="${cabinetPixelWidth}" height="${cabinetPixelHeight}" 
                            fill="none" stroke="#333" stroke-width="2"/>`;
            
            // Draw rails only
            const rails = layoutData.positions.filter(p => p.type === 'rail');
            let dimensionLines = '';
            
            rails.forEach((rail, index) => {
                const railY = offsetY + (layoutData.cabinetHeight - rail.top) * scale;
                const railHeight = rail.thickness * scale;
                
                // Draw rail
                railContent += `
                    <rect x="${offsetX}" y="${railY}" width="${cabinetPixelWidth}" height="${railHeight}" 
                          fill="url(#railWoodGuide)" stroke="#654321" stroke-width="1.5"/>
                    <text x="${offsetX + cabinetPixelWidth/2}" y="${railY + railHeight/2 + 4}" 
                          text-anchor="middle" font-size="11" fill="white" font-weight="bold">
                        Rail ${rail.number}
                    </text>
                `;
                
                // Add simple mark designator
                const markX = offsetX + cabinetPixelWidth + 20;
                const markY = railY + railHeight/2;
                
                // Simple mark indicator
                dimensionLines += `
                    <circle cx="${markX}" cy="${markY}" r="12" fill="var(--primary-color)" opacity="0.9"/>
                    <text x="${markX}" y="${markY + 4}" text-anchor="middle" font-size="11" fill="white" font-weight="bold">
                        ${rail.number}
                    </text>
                    <line x1="${offsetX + cabinetPixelWidth}" y1="${markY}" x2="${markX - 12}" y2="${markY}" 
                          stroke="var(--primary-color)" stroke-width="1" stroke-dasharray="2,2" opacity="0.5"/>
                `;
                
                // Rail thickness dimension
                const thickX = offsetX - 25;
                dimensionLines += `
                    <line x1="${thickX}" y1="${railY}" x2="${thickX}" y2="${railY + railHeight}" 
                          stroke="#666" stroke-width="1"/>
                    <line x1="${thickX - 3}" y1="${railY}" x2="${thickX + 3}" y2="${railY}" 
                          stroke="#666" stroke-width="1"/>
                    <line x1="${thickX - 3}" y1="${railY + railHeight}" x2="${thickX + 3}" y2="${railY + railHeight}" 
                          stroke="#666" stroke-width="1"/>
                    <text x="${thickX - 5}" y="${railY + railHeight/2 + 3}" 
                          font-size="9" fill="#666" text-anchor="end">
                        ${inchesToDisplay(rail.thickness)}
                    </text>
                `;
            });
            
            // Add drawer opening dimensions
            const drawers = layoutData.positions.filter(p => p.type === 'drawer');
            drawers.forEach((drawer, index) => {
                const drawerY = offsetY + (layoutData.cabinetHeight - drawer.top) * scale;
                const drawerHeight = drawer.height * scale;
                
                // Show drawer opening area (lighter shade)
                railContent += `
                    <rect x="${offsetX}" y="${drawerY}" width="${cabinetPixelWidth}" height="${drawerHeight}" 
                          fill="#f0f0f0" stroke="none" opacity="0.3"/>
                `;
                
                // Calculate actual opening height based on rail positions
                let openingHeight;
                
                if (layoutData.frameStyle === 'inset') {
                    // For inset, opening = drawer height
                    openingHeight = drawer.height;
                } else {
                    // For overlay, calculate based on rail positions
                    const rails = layoutData.positions.filter(p => p.type === 'rail');
                    
                    if (rails.length === 0) {
                        // Single drawer - opening is full cabinet height
                        openingHeight = layoutData.cabinetHeight;
                    } else {
                        // Multiple drawers - find the rails that bound this drawer
                        if (drawer.number === 1) {
                            // First drawer - from bottom to first rail
                            openingHeight = rails[0].bottom;
                        } else if (drawer.number === drawers.length) {
                            // Last drawer - from last rail to top
                            openingHeight = layoutData.cabinetHeight - rails[rails.length - 1].top;
                        } else {
                            // Middle drawer - between two rails
                            const prevRail = rails[drawer.number - 2];
                            const nextRail = rails[drawer.number - 1];
                            openingHeight = nextRail.bottom - prevRail.top;
                        }
                    }
                }
                
                railContent += `
                    <text x="${offsetX + cabinetPixelWidth/2}" y="${drawerY + drawerHeight/2 + 4}" 
                          text-anchor="middle" font-size="11" fill="#666" font-style="italic">
                        Opening: ${inchesToDisplay(openingHeight)}
                    </text>
                `;
            });
            
            // Add all dimension lines
            railContent += dimensionLines;
            
            // Add cabinet dimensions
            railContent += `
                <text x="${offsetX + cabinetPixelWidth/2}" y="${offsetY - 10}" 
                      text-anchor="middle" font-size="11" fill="#666" font-weight="bold">
                    Cabinet: ${inchesToDisplay(layoutData.cabinetWidth)} W × ${inchesToDisplay(layoutData.cabinetHeight)} H
                </text>
                <text x="${offsetX + cabinetPixelWidth/2}" y="${offsetY + cabinetPixelHeight + 25}" 
                      text-anchor="middle" font-size="10" fill="#666">
                    ${layoutData.layoutDirection === 'bottom-up' ? 'Dimensions from Bottom' : 'Dimensions from Top'}
                </text>
            `;
            
            railView.innerHTML = railContent;
        }
        
        // Clear function
        function clearCabinetCalculator() {
            // Reset all inputs
            document.getElementById('smartCabinetHeight').value = '';
            document.getElementById('smartCabinetWidth').value = '';
            document.getElementById('numDrawers').value = '3';
            document.getElementById('smartHorizontalReveal').value = '0.125';
            document.getElementById('smartVerticalReveal').value = '0.125';
            document.getElementById('smartOverlayAmount').value = '0.75';
            document.getElementById('railThicknessSelect').value = '1.5';
            
            // Reset variables
            currentCabinetHeightInches = 0;
            currentCabinetWidthInches = 0;
            currentHorizontalRevealInches = 0.125;
            currentVerticalRevealInches = 0.125;
            currentOverlayAmountInches = 0.75;
            currentRailThicknessInches = 1.5;
            customDrawerHeights = [];
            
            // Reset drawer box variables
            includeDrawerBox = false;
            drawerSlideType = 'side';
            currentCabinetDepthInches = 0;
            currentBoxMaterialThickness = 0.75;
            currentBottomThickness = 0.25;
            currentBottomDadoDepth = 0.3125;
            currentBottomDadoHeight = 0.25;
            currentSideClearance = 0.5;
            currentRearClearance = 1;
            currentTopClearance = 0.5;
            currentBottomClearance = 0.375;
            currentFaceThickness = 0.75;
            currentCabinetMaterialThickness = 0.75;
            selectedDrawerIndex = 0;
            
            // Reset drawer box UI
            document.getElementById('includeDrawerBox').checked = false;
            document.getElementById('drawerBoxSettings').style.display = 'none';
            document.getElementById('drawerBoxDiagramContainer').style.display = 'none';
            document.getElementById('smartCabinetDepth').value = '';
            document.getElementById('smartCabinetMaterial').value = '3/4';
            document.getElementById('smartSideClearance').value = '1/2';
            document.getElementById('smartRearClearance').value = '1';
            document.getElementById('smartTopClearance').value = '1/2';
            document.getElementById('smartBottomClearance').value = '3/8';
            document.getElementById('smartBoxMaterial').value = '3/4';
            document.getElementById('smartBottomPanel').value = '1/4';
            document.getElementById('smartDadoDepth').value = '5/16';
            document.getElementById('smartDadoHeight').value = '1/4';
            document.getElementById('smartFaceThickness').value = '3/4';
            setSlideType('side');
            
            // Reset to defaults
            setFrameStyle('inset');
            setCabinetDrawerMode('equal');
            
            // Clear custom drawer list
            updateCustomDrawerList();
            
            // Clear all preview elements
            document.querySelectorAll('#cabinetDrawerContent .input-preview').forEach(el => {
                el.style.display = 'none';
            });
            
            // Clear results
            document.getElementById('cabinetResult').innerHTML = '<div class="result-placeholder">Enter cabinet dimensions to calculate layout</div>';
            document.getElementById('cabinetCutList').style.display = 'none';
            
            // Reset diagrams
            updateCabinetDiagrams(null);
            document.getElementById('drawerBoxDiagramContainer').style.display = 'none';
        }
        
        // Save to project function
        function saveCabinetToProject() {
            if (currentCabinetHeightInches <= 0 || currentCabinetWidthInches <= 0) {
                showNotification('Calculate layout first', 'warning');
                return;
            }
            
            // Get current layout data
            const numDrawers = cabinetDrawerMode === 'equal' ? 
                parseInt(document.getElementById('numDrawers').value) || 3 :
                customDrawerHeights.length;
            
            const frameType = cabinetFrameStyle.charAt(0).toUpperCase() + cabinetFrameStyle.slice(1);
            const modeType = cabinetDrawerMode === 'equal' ? 'Equal Heights' : 'Custom Heights';
            
            // Capture both SVG diagrams
            const frontViewSVG = document.getElementById('cabinetFrontView');
            const railViewSVG = document.getElementById('cabinetRailView');
            
            let diagramsHTML = '';
            if (frontViewSVG && railViewSVG) {
                try {
                    // Create proper SVG strings with all necessary attributes
                    const frontSVGString = new XMLSerializer().serializeToString(frontViewSVG);
                    const railSVGString = new XMLSerializer().serializeToString(railViewSVG);
                    
                    // Create data URLs for the SVGs
                    const frontDataURL = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(frontSVGString)));
                    const railDataURL = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(railSVGString)));
                    
                    diagramsHTML = `
                        <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin: 10px 0;">
                            <div style="text-align: center;">
                                <p style="margin: 0 0 5px 0; font-size: 12px; font-weight: bold;">Front View</p>
                                <img src="${frontDataURL}" width="200" height="200" style="border: 1px solid #ddd;">
                            </div>
                            <div style="text-align: center;">
                                <p style="margin: 0 0 5px 0; font-size: 12px; font-weight: bold;">Rail Placement</p>
                                <img src="${railDataURL}" width="200" height="200" style="border: 1px solid #ddd;">
                            </div>
                        </div>
                    `;
                } catch (e) {
                    console.error('Error capturing diagrams:', e);
                }
            }
            
            // Get detailed cut list and marking information
            let detailedCutListHTML = '';
            
            // Build drawer data
            const drawerData = cabinetDrawerMode === 'equal' ? 
                Array(parseInt(document.getElementById('numDrawers').value) || 3).fill(null).map((_, i) => {
                    let drawerHeight, drawerWidth;
                    if (cabinetFrameStyle === 'inset') {
                        const totalRails = (parseInt(document.getElementById('numDrawers').value) || 3 - 1) * currentRailThicknessInches;
                        const availableForOpenings = currentCabinetHeightInches - totalRails;
                        const openingHeight = availableForOpenings / (parseInt(document.getElementById('numDrawers').value) || 3);
                        drawerHeight = openingHeight - (2 * currentVerticalRevealInches);
                        drawerWidth = currentCabinetWidthInches - (2 * currentHorizontalRevealInches);
                    } else {
                        const totalRails = (parseInt(document.getElementById('numDrawers').value) || 3 - 1) * currentRailThicknessInches;
                        const availableHeight = currentCabinetHeightInches - totalRails;
                        drawerHeight = availableHeight / (parseInt(document.getElementById('numDrawers').value) || 3);
                        drawerWidth = currentCabinetWidthInches + (2 * currentOverlayAmountInches);
                    }
                    return { number: i + 1, height: drawerHeight, width: drawerWidth };
                }) :
                customDrawerHeights.map((height, i) => {
                    let drawerWidth;
                    if (cabinetFrameStyle === 'inset') {
                        drawerWidth = currentCabinetWidthInches - (2 * currentHorizontalRevealInches);
                    } else {
                        drawerWidth = currentCabinetWidthInches + (2 * currentOverlayAmountInches);
                    }
                    return { 
                        number: i + 1, 
                        height: cabinetFrameStyle === 'inset' ? height - (2 * currentVerticalRevealInches) : height,
                        width: drawerWidth 
                    };
                });
            
            // Get layout data for rail positions
            const layoutData = calculateRailPositions(drawerData, cabinetDrawerMode);
            
            // Build drawer fronts list
            let drawerFrontsHTML = '<div style="margin-top: 8px; font-size: 12px;"><strong>Drawer Fronts:</strong><ul style="margin: 3px 0 0 20px; padding: 0;">';
            drawerData.forEach(drawer => {
                drawerFrontsHTML += `<li>Drawer ${drawer.number}: ${inchesToDisplay(drawer.width)} W × ${inchesToDisplay(drawer.height)} H</li>`;
            });
            drawerFrontsHTML += '</ul></div>';
            
            // Build rails list if applicable
            let railsHTML = '';
            if (currentRailThicknessInches > 0 && layoutData.positions.filter(p => p.type === 'rail').length > 0) {
                const rails = layoutData.positions.filter(p => p.type === 'rail');
                railsHTML = '<div style="margin-top: 8px; font-size: 12px;"><strong>Rails:</strong><ul style="margin: 3px 0 0 20px; padding: 0;">';
                rails.forEach(rail => {
                    railsHTML += `<li>Rail ${rail.number}: ${inchesToDisplay(currentCabinetWidthInches)} W × ${inchesToDisplay(rail.thickness)} H</li>`;
                });
                railsHTML += '</ul></div>';
                
                // Add rail marking guide
                railsHTML += '<div style="margin-top: 8px; font-size: 12px;"><strong>Rail Marks (from bottom):</strong><ul style="margin: 3px 0 0 20px; padding: 0;">';
                rails.forEach(rail => {
                    const centerMark = rail.bottom + rail.thickness/2;
                    railsHTML += `<li>Rail ${rail.number}: Bottom ${inchesToDisplay(rail.bottom)}, Center ${inchesToDisplay(centerMark)}, Top ${inchesToDisplay(rail.top)}</li>`;
                });
                railsHTML += '</ul></div>';
            }
            
            detailedCutListHTML = drawerFrontsHTML + railsHTML;
            
            // Get configuration details
            const configDetails = `
                <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
                    <p style="margin: 0 0 3px 0; font-size: 14px;"><strong>Configuration:</strong></p>
                    <p style="margin: 2px 0; font-size: 13px;">Cabinet: ${inchesToDisplay(currentCabinetWidthInches)} W × ${inchesToDisplay(currentCabinetHeightInches)} H • ${frameType} • ${modeType}</p>
                    <p style="margin: 2px 0; font-size: 13px;">Drawers: ${numDrawers} • ${cabinetFrameStyle === 'inset' ? 
                        `Reveals: H ${inchesToDisplay(currentHorizontalRevealInches)}, V ${inchesToDisplay(currentVerticalRevealInches)}` :
                        `Overlay: ${inchesToDisplay(currentOverlayAmountInches)}`
                    } • ${currentRailThicknessInches > 0 ? 
                        `Rails: ${inchesToDisplay(currentRailThicknessInches)}` :
                        'No Rails'
                    }</p>
                </div>
            `;
            
            const equation = `${frameType} cabinet ${inchesToDisplay(currentCabinetWidthInches)} × ${inchesToDisplay(currentCabinetHeightInches)} with ${numDrawers} drawers (${modeType})`;
            const result = `${numDrawers} drawer fronts${currentRailThicknessInches > 0 ? ` + ${numDrawers - 1} rails` : ''}`;
            
            // Combine all content in a clean layout
            const fullDetails = configDetails + diagramsHTML + detailedCutListHTML;
            
            const saveData = {
                tool: 'Cabinet Drawer & Face Frame Layout',
                equation: equation,
                result: result,
                details: fullDetails,
                timestamp: new Date().toISOString()
            };
            
            showSaveToProjectModal(saveData);
        }

        function saveCutToProject(index) {
            if (!currentCutResults || currentCutResults.length === 0 || index >= currentCutResults.length) {
                showNotification('No cut result to save', 'warning');
                return;
            }
            
            const cutData = currentCutResults[index];
            const cutMarks = cutData.results;
            
            const equation = `Cut ${cutData.originalLength} into ${cutData.pieces} equal pieces${cutData.kerfNote}${cutData.cutSideNote}`;
            const result = `${cutData.pieces} pieces @ ${cutData.pieceLength} each`;
            
            let details = `Original Length: ${cutData.originalLength}\nPieces: ${cutData.pieces}\nPiece Length: ${cutData.pieceLength}${cutData.kerfNote}${cutData.cutSideNote}`;
            
            if (cutMarks.length > 0) {
                details += '\n\nCut marks:';
                cutMarks.forEach((mark, i) => {
                    details += `\nMark ${i + 1}: ${mark.display}`;
                });
            }
            
            const previewContent = `
                <div class="save-preview-cut">
                    <div class="preview-header">
                        <strong>✂️ Cut Calculator</strong>
                    </div>
                    <div class="preview-equation">
                        ${equation}
                    </div>
                    <div class="preview-result">
                        <strong>${result}</strong>
                    </div>
                    <div class="preview-details">
                        ${details.replace(/\n/g, '<br>')}
                    </div>
                </div>
            `;
            
            const saveData = {
                tool: 'cut',
                equation: equation,
                result: result,
                details: {
                    originalLength: cutData.originalLength,
                    pieces: cutData.pieces,
                    pieceLength: cutData.pieceLength,
                    cutMarks: cutMarks,
                    kerfNote: cutData.kerfNote,
                    cutSideNote: cutData.cutSideNote
                },
                preview: previewContent
            };
            
            showSaveToProjectModal(saveData);
        }

        function saveOptimizationToProject() {
            if (!window.currentOptimizationResults || window.currentOptimizationResults.length === 0) {
                showNotification('No optimization results to save', 'warning');
                return;
            }
            
            const results = window.currentOptimizationResults;
            const kerfEnabled = window.currentKerfEnabled;
            const kerfNote = kerfEnabled ? ' (with kerf)' : ' (no kerf)';
            
            // Calculate summary data
            const totalBoards = results.length;
            const totalWaste = results.reduce((sum, result) => sum + result.waste, 0);
            const completedCuts = results.reduce((sum, result) => sum + result.cuts.length, 0);
            
            const equation = `Waste Optimization: ${totalBoards} boards used${kerfNote}`;
            const result = `${completedCuts} cuts completed, ${inchesToDisplay(totalWaste, 'optimizer')} total waste`;
            
            // Build detailed information
            let details = `Optimization Results${kerfNote}:\n`;
            details += `Boards Used: ${totalBoards}\n`;
            details += `Cuts Completed: ${completedCuts}\n`;
            details += `Total Waste: ${inchesToDisplay(totalWaste, 'optimizer')}\n\n`;
            details += `Cutting Plan:\n`;
            
            results.forEach((board, index) => {
                details += `${board.boardDisplay}:\n`;
                details += `  Cuts: ${board.cuts.map(cut => inchesToDisplay(cut, 'optimizer')).join(', ')}\n`;
                details += `  Waste: ${inchesToDisplay(board.waste, 'optimizer')}\n`;
            });
            
            // Create preview content
            const previewContent = `
                <div class="save-preview-optimization">
                    <div class="preview-header">
                        <strong>🔧 Cut Optimization</strong>
                    </div>
                    <div class="preview-equation">
                        ${equation}
                    </div>
                    <div class="preview-result">
                        <strong>${result}</strong>
                    </div>
                    <div class="preview-summary">
                        ${totalBoards} boards used • ${completedCuts} cuts completed • ${inchesToDisplay(totalWaste, 'optimizer')} waste
                    </div>
                    <div class="preview-details">
                        ${details.replace(/\n/g, '<br>').substring(0, 300)}${details.length > 300 ? '...' : ''}
                    </div>
                </div>
            `;
            
            const saveData = {
                tool: 'optimizer',
                equation: equation,
                result: result,
                details: {
                    totalBoards: totalBoards,
                    completedCuts: completedCuts,
                    totalWaste: totalWaste,
                    kerfEnabled: kerfEnabled,
                    cuttingPlan: results,
                    fullDetails: details
                },
                preview: previewContent
            };
            
            showSaveToProjectModal(saveData);
        }

        // Initialize app - load saved data and set up project management
        // Screw Calculator Functions
        function initScrewCalculator() {
            console.log('Initializing Screw Calculator...');
            
            // Add event listeners for visual size circles
            const sizeCircles = document.querySelectorAll('.size-circle');
            console.log('Found', sizeCircles.length, 'size circles');
            
            sizeCircles.forEach(circle => {
                circle.addEventListener('click', function(e) {
                    console.log('Size circle clicked:', this.dataset.size, this.dataset.name);
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Clear other selections
                    document.querySelectorAll('.size-circle').forEach(c => c.classList.remove('selected'));
                    // Select this one
                    this.classList.add('selected');
                    
                    const size = parseFloat(this.dataset.size);
                    const name = this.dataset.name;
                    
                    console.log('Parsed values:', size, name);
                    showSelectedScrew(name, size);
                });
            });
            
            // Add event listener for manual measurement input
            const manualInput = document.getElementById('screwDiameter');
            if (manualInput) {
                manualInput.addEventListener('input', calculateFromMeasurement);
            }
        }
        
        // Screw calculator helper functions
        function clearScrewCalculator() {
            // Reset selected screw
            currentScrewSize = null;
            currentWoodType = null;
            
            // Clear manual input
            document.getElementById('screwDiameter').value = '';
            
            // Remove active states from all selection buttons
            document.querySelectorAll('.size-circle').forEach(circle => {
                circle.classList.remove('selected');
            });
            document.querySelectorAll('.common-screw-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.querySelectorAll('.wood-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Hide displays
            document.getElementById('selectedScrewDisplay').style.display = 'none';
            document.getElementById('woodSelection').style.display = 'none';
            document.getElementById('screwResults').style.display = 'none';
            document.getElementById('screwNoResult').style.display = 'block';
            
            // Reset to visual mode
            setScrewIdMode('visual');
        }
        
        function setScrewIdMode(mode) {
            console.log('Setting screw ID mode to:', mode);
            // Update tab appearance
            document.querySelectorAll('.id-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(mode + 'IdTab').classList.add('active');
            
            // Show/hide content sections
            document.querySelectorAll('.id-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(mode + 'IdContent').style.display = 'block';
        }
        
        function selectCommonScrew(size, type) {
            console.log('Selecting common screw:', size, type);
            // Clear other selections
            document.querySelectorAll('.common-screw-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
            
            // Convert size to decimal
            const sizeMap = {
                '#2': 0.086,
                '#3': 0.099,
                '#4': 0.112,
                '#5': 0.125,
                '#6': 0.138,
                '#7': 0.151,
                '#8': 0.164,
                '#9': 0.177,
                '#10': 0.190,
                '#11': 0.203,
                '#12': 0.216,
                '#14': 0.242,
                '1/4': 0.25,
                '5/16': 0.3125,
                '3/8': 0.375,
                '3/8lag': 0.375,
                '7/16lag': 0.4375,
                '1/2lag': 0.5,
                '5/8lag': 0.625,
                '3/4lag': 0.75,
                'pocket': 0.15 // Typical pocket screw size
            };
            
            const decimalSize = sizeMap[size] || 0.15;
            const displayName = size.includes('lag') ? size.replace('lag', ' Lag Bolt') : size;
            showSelectedScrew(displayName, decimalSize);
        }
        
        function toggleMeasurementUnit() {
            const isMetric = document.querySelector('input[name="unit"]:checked').value === 'mm';
            const input = document.getElementById('screwDiameter');
            const label = document.getElementById('unitLabel');
            
            if (isMetric) {
                input.placeholder = '4.2';
                input.min = '1';
                input.max = '12';
                input.step = '0.1';
                label.textContent = 'mm';
            } else {
                input.placeholder = '0.164';
                input.min = '0.05';
                input.max = '0.5';
                input.step = '0.01';
                label.textContent = 'inches';
            }
            
            // Recalculate if there's a value
            if (input.value) {
                calculateFromMeasurement();
            }
        }
        
        function calculateFromMeasurement() {
            const input = document.getElementById('screwDiameter');
            let diameter = parseFloat(input.value);
            const unitRadio = document.querySelector('input[name="unit"]:checked');
            const isMetric = unitRadio ? unitRadio.value === 'mm' : false;
            
            console.log('Calculating from measurement:', diameter, isMetric ? 'mm' : 'inches');
            
            if (diameter && diameter > 0) {
                // Convert mm to inches if needed
                if (isMetric) {
                    diameter = diameter / 25.4;
                }
                
                const displayName = isMetric ? 
                    `${(diameter * 25.4).toFixed(1)}mm` : 
                    `${diameter} inch`;
                    
                showSelectedScrew(displayName, diameter);
            }
        }
        
        function showSelectedScrew(displayName, size) {
            console.log('Showing selected screw:', displayName, size);
            // Show selected screw info
            const display = document.getElementById('selectedScrewDisplay');
            const typeSpan = document.getElementById('selectedScrewType');
            const specs = document.getElementById('screwSpecs');
            
            if (display && typeSpan && specs) {
                typeSpan.textContent = displayName;
                specs.innerHTML = `Diameter: ${size}" | ${(size * 25.4).toFixed(1)}mm`;
                display.style.display = 'block';
                
                // Show wood selection
                const woodSelection = document.getElementById('woodSelection');
                if (woodSelection) {
                    woodSelection.style.display = 'block';
                }
                
                // Store current screw for calculation
                window.currentScrewSize = size;
                window.currentScrewType = displayName;
                console.log('DEBUG: Screw selected - Size:', size, 'Type:', displayName);
            }
        }
        
        function selectWoodType(woodType) {
            console.log('Selecting wood type:', woodType);
            console.log('Current screw size:', window.currentScrewSize);
            
            // Clear other selections
            document.querySelectorAll('.wood-btn').forEach(btn => btn.classList.remove('selected'));
            const selectedBtn = document.getElementById(woodType + 'Btn');
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
                console.log('Wood type button selected successfully');
            } else {
                console.error('Wood type button not found:', woodType + 'Btn');
                return;
            }
            
            // Store wood type selection
            window.currentWoodType = woodType;
            console.log('DEBUG: Wood type selected:', woodType);
            
            // Calculate pilot hole
            if (window.currentScrewSize) {
                console.log('Calling calculatePilotHole with:', window.currentScrewSize, woodType);
                calculatePilotHole(window.currentScrewSize, woodType);
            } else {
                console.error('No screw size selected - currentScrewSize is:', window.currentScrewSize);
            }
        }
        
        function saveScrewToProject() {
            if (!window.currentScrewType || !window.currentWoodType || !window.currentPilotHoleSize) {
                showNotification('Calculate pilot hole first', 'warning');
                return;
            }
            
            const equation = `${window.currentScrewType} screw in ${window.currentWoodType}`;
            const details = `Screw: ${window.currentScrewType}\nWood Type: ${window.currentWoodType}\nPilot Hole: ${window.currentPilotHoleSize}`;
            
            const previewContent = `
                <div class="preview-equation">
                    ${window.currentScrewType} → ${window.currentPilotHoleSize} pilot hole
                </div>
                <div class="preview-result">
                    <strong>Pilot hole: ${window.currentPilotHoleSize} for ${window.currentWoodType}</strong>
                </div>
                <div class="preview-details">
                    Screw: ${window.currentScrewType} • Pilot Hole: ${window.currentPilotHoleSize}
                </div>
            `;
            
            showSaveToProjectModal('Screw & Pilot Hole Calculation', {
                tool: 'Screw & Pilot Hole Calculator',
                equation: equation,
                result: `${window.currentPilotHoleSize} pilot hole for ${window.currentScrewType} in ${window.currentWoodType}`,
                details: details,
                preview: previewContent
            });
        }

        // =====================================================
        // Grade/Slope Calculator Functions
        // =====================================================
        
        let gradeMode = 'find-grade'; // Current calculation mode
        
        function setGradeMode(mode) {
            gradeMode = mode;
            
            // Clear all preview elements when switching modes (clean slate)
            document.getElementById('previewGradeRise').innerHTML = '';
            document.getElementById('previewGradeRise').style.display = 'none';
            document.getElementById('previewGradeRun').innerHTML = '';
            document.getElementById('previewGradeRun').style.display = 'none';
            
            // Update button states
            document.querySelectorAll('#gradeCard .calc-mode-selector .mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('gradeMode' + mode.split('-')[1].charAt(0).toUpperCase() + mode.split('-')[1].slice(1)).classList.add('active');
            
            // Show/hide inputs based on mode
            const riseInput = document.getElementById('gradeRiseInput');
            const runInput = document.getElementById('gradeRunInput');
            const percentInput = document.getElementById('gradePercentInput');
            
            if (mode === 'find-grade') {
                riseInput.style.display = 'flex';
                runInput.style.display = 'flex';
                percentInput.style.display = 'none';
            } else if (mode === 'find-rise') {
                riseInput.style.display = 'none';
                runInput.style.display = 'flex';
                percentInput.style.display = 'flex';
            } else if (mode === 'find-run') {
                riseInput.style.display = 'flex';
                runInput.style.display = 'none';
                percentInput.style.display = 'flex';
            }
            
            calculateGradeSlope();
        }
        
        function clearGradeCalculator() {
            // Clear smart inputs
            document.getElementById('smartGradeRise').value = '';
            document.getElementById('smartGradeRun').value = '';
            document.getElementById('gradePercent').value = '';
            
            // Clear previews
            const risePreview = document.getElementById('previewGradeRise');
            const runPreview = document.getElementById('previewGradeRun');
            if (risePreview) {
                risePreview.style.display = 'none';
                risePreview.innerHTML = '';
            }
            if (runPreview) {
                runPreview.style.display = 'none';
                runPreview.innerHTML = '';
            }
            
            // Clear stored values
            currentGradeRiseInches = 0;
            currentGradeRunInches = 0;
            
            // Clear legacy inputs
            document.getElementById('gradeRiseFeet').value = '';
            document.getElementById('gradeRiseInches').value = '';
            document.getElementById('gradeRiseFraction').value = '0';
            document.getElementById('gradeRunFeet').value = '';
            document.getElementById('gradeRunInches').value = '';
            document.getElementById('gradeRunFraction').value = '0';
            
            // Hide results
            document.getElementById('gradeResults').style.display = 'none';
            document.getElementById('gradeNoResult').style.display = 'block';
            
            // Reset diagram
            updateSlopeDiagram(0, 12);
        }
        
        function calculateGradeSlope() {
            let rise = 0, run = 0, percent = 0;
            
            // Use smart input values if available, otherwise fall back to legacy inputs
            rise = currentGradeRiseInches;
            if (rise === 0) {
                const riseFeet = parseFloat(document.getElementById('gradeRiseFeet').value) || 0;
                const riseInches = parseFloat(document.getElementById('gradeRiseInches').value) || 0;
                const riseFraction = parseFloat(document.getElementById('gradeRiseFraction').value) || 0;
                rise = (riseFeet * 12) + riseInches + riseFraction;
            }
            
            run = currentGradeRunInches;
            if (run === 0) {
                const runFeet = parseFloat(document.getElementById('gradeRunFeet').value) || 0;
                const runInches = parseFloat(document.getElementById('gradeRunInches').value) || 0;
                const runFraction = parseFloat(document.getElementById('gradeRunFraction').value) || 0;
                run = (runFeet * 12) + runInches + runFraction;
            }
            
            // Get Percentage value
            percent = parseFloat(document.getElementById('gradePercent').value) || 0;
            
            let calculatedRise, calculatedRun, calculatedPercent, angle, ratio;
            
            if (gradeMode === 'find-grade') {
                if (rise > 0 && run > 0) {
                    calculatedPercent = (rise / run) * 100;
                    angle = Math.atan(rise / run) * (180 / Math.PI);
                    ratio = `1:${(run / rise).toFixed(2)}`;
                    displayGradeResults(rise, run, calculatedPercent, angle, ratio);
                    updateSlopeVisual(rise, run, calculatedPercent, angle);
                } else {
                    hideGradeResults();
                }
            } else if (gradeMode === 'find-rise') {
                if (run > 0 && percent > 0) {
                    calculatedRise = (run * percent) / 100;
                    angle = Math.atan(calculatedRise / run) * (180 / Math.PI);
                    ratio = `1:${(run / calculatedRise).toFixed(2)}`;
                    displayGradeResults(calculatedRise, run, percent, angle, ratio);
                    updateSlopeVisual(calculatedRise, run, percent, angle);
                } else {
                    hideGradeResults();
                }
            } else if (gradeMode === 'find-run') {
                if (rise > 0 && percent > 0) {
                    calculatedRun = (rise * 100) / percent;
                    angle = Math.atan(rise / calculatedRun) * (180 / Math.PI);
                    ratio = `1:${(calculatedRun / rise).toFixed(2)}`;
                    displayGradeResults(rise, calculatedRun, percent, angle, ratio);
                    updateSlopeVisual(rise, calculatedRun, percent, angle);
                } else {
                    hideGradeResults();
                }
            }
        }
        
        function displayGradeResults(rise, run, percent, angle, ratio) {
            const resultsDiv = document.getElementById('gradeResults');
            const resultDisplay = document.getElementById('gradeResultDisplay');
            const noResultDiv = document.getElementById('gradeNoResult');
            
            // Show results, hide placeholder
            resultsDiv.style.display = 'block';
            if (noResultDiv) noResultDiv.style.display = 'none';
            
            // Convert values back to feet/inches for display
            const riseDisplay = inchesToDisplay(rise);
            const runDisplay = inchesToDisplay(run);
            
            // Determine compliance color coding
            let complianceColor = '#333';
            let complianceText = '';
            
            if (percent <= 5) {
                complianceColor = '#228B22';
                complianceText = '✅ ADA Compliant (Preferred)';
            } else if (percent <= 8.33) {
                complianceColor = '#FFA500';
                complianceText = '⚠️ ADA Max Compliance';
            } else if (percent <= 15) {
                complianceColor = '#FF6347';
                complianceText = '⚡ Steep (Check local codes)';
            } else {
                complianceColor = '#DC143C';
                complianceText = '🚨 Very Steep (May not be allowed)';
            }
            
            let html = `
                <div class="grade-result-summary" style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 10px;">
                        <div>
                            <strong>Grade:</strong> <span style="font-size: 18px; color: var(--primary-color);">${percent.toFixed(2)}%</span>
                        </div>
                        <div>
                            <strong>Angle:</strong> <span style="font-size: 18px; color: var(--primary-color);">${angle.toFixed(2)}°</span>
                        </div>
                        <div>
                            <strong>Ratio:</strong> <span style="font-size: 16px; color: #666;">${ratio}</span>
                        </div>
                        <div>
                            <strong>Rise:Run:</strong> <span style="font-size: 16px; color: #666;">${(rise/12).toFixed(2)}:${(run/12).toFixed(2)}</span>
                        </div>
                    </div>
                    <div style="text-align: center; font-weight: bold; color: ${complianceColor};">
                        ${complianceText}
                    </div>
                </div>
                
                <div class="grade-detailed-results">
                    <h5 style="margin-bottom: 10px; color: var(--primary-color);">Detailed Measurements:</h5>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                        <div><strong>Rise (Vertical):</strong> ${riseDisplay}</div>
                        <div><strong>Run (Horizontal):</strong> ${runDisplay}</div>
                    </div>
                </div>
            `;
            
            if (gradeMode === 'find-rise') {
                html += `
                    <div class="calculated-value" style="margin-top: 15px; padding: 10px; background: #e8f5e8; border-radius: 5px;">
                        <strong>📏 Calculated Rise:</strong> ${riseDisplay}
                    </div>
                `;
            } else if (gradeMode === 'find-run') {
                html += `
                    <div class="calculated-value" style="margin-top: 15px; padding: 10px; background: #e8f5e8; border-radius: 5px;">
                        <strong>📏 Calculated Run:</strong> ${runDisplay}
                    </div>
                `;
            }
            
            // Save calculation data for project saving
            window.currentGradeCalculation = {
                mode: gradeMode,
                rise: rise,
                run: run,
                percent: percent,
                angle: angle,
                ratio: ratio,
                riseDisplay: riseDisplay,
                runDisplay: runDisplay,
                timestamp: new Date().toISOString()
            };
            
            resultDisplay.innerHTML = html;
            resultsDiv.style.display = 'block';
        }
        
        function hideGradeResults() {
            document.getElementById('gradeResults').style.display = 'none';
            
            // Reset visual display
            document.getElementById('gradePercentLabel').textContent = 'Grade: --';
            document.getElementById('ratioLabel').textContent = 'Ratio: --';
            document.getElementById('angleLabel').textContent = 'Angle';
        }
        
        function updateSlopeVisual(rise, run, percent, angle) {
            // Update the SVG visual representation
            const svg = document.getElementById('slopeDiagram');
            const triangle = document.getElementById('slopeTriangle');
            const angleArc = document.getElementById('angleArc');
            const gradeLabel = document.getElementById('gradePercentLabel');
            const ratioLabel = document.getElementById('ratioLabel');
            const angleLabel = document.getElementById('angleLabel');
            
            // Calculate proportional dimensions for visual (keeping within SVG bounds)
            const maxWidth = 250; // Available width for run
            const maxHeight = 100; // Available height for rise
            
            let visualRun = maxWidth;
            let visualRise = (rise / run) * maxWidth;
            
            // If rise is too tall, scale both proportionally
            if (visualRise > maxHeight) {
                const scale = maxHeight / visualRise;
                visualRise = maxHeight;
                visualRun = visualRun * scale;
            }
            
            // Update triangle path
            const startX = 50;
            const startY = 170;
            const endX = startX + visualRun;
            const topY = startY - visualRise;
            
            triangle.setAttribute('d', `M ${startX} ${startY} L ${endX} ${startY} L ${endX} ${topY} Z`);
            
            // Update rise line
            svg.querySelector('line[stroke="#D2691E"]').setAttribute('x1', endX);
            svg.querySelector('line[stroke="#D2691E"]').setAttribute('y1', startY);
            svg.querySelector('line[stroke="#D2691E"]').setAttribute('x2', endX);
            svg.querySelector('line[stroke="#D2691E"]').setAttribute('y2', topY);
            
            // Update run line
            svg.querySelector('line[stroke="#228B22"]').setAttribute('x1', startX);
            svg.querySelector('line[stroke="#228B22"]').setAttribute('x2', endX);
            
            // Update angle arc (simplified)
            const arcRadius = Math.min(50, visualRun / 3);
            const arcEndX = startX + arcRadius * Math.cos(angle * Math.PI / 180);
            const arcEndY = startY - arcRadius * Math.sin(angle * Math.PI / 180);
            angleArc.setAttribute('d', `M ${startX + arcRadius} ${startY} A ${arcRadius} ${arcRadius} 0 0 0 ${arcEndX} ${arcEndY}`);
            
            // Update labels
            gradeLabel.textContent = `Grade: ${percent.toFixed(2)}%`;
            ratioLabel.textContent = `Ratio: 1:${(run/rise).toFixed(2)}`;
            angleLabel.textContent = `${angle.toFixed(1)}°`;
            
            // Position angle label
            const labelX = startX + (arcRadius * 1.5);
            const labelY = startY - (arcRadius * 0.3);
            angleLabel.setAttribute('x', labelX);
            angleLabel.setAttribute('y', labelY);
        }
        
        function setGradePreset(presetType, description) {
            // Clear existing values
            document.getElementById('gradeRiseFeet').value = '';
            document.getElementById('gradeRiseInches').value = '';
            document.getElementById('gradeRiseFraction').value = '0';
            document.getElementById('gradeRunFeet').value = '';
            document.getElementById('gradeRunInches').value = '';
            document.getElementById('gradeRunFraction').value = '0';
            document.getElementById('gradePercent').value = '';
            
            // Set to find-grade mode for most presets
            setGradeMode('find-grade');
            
            switch(presetType) {
                case 'ada-max':
                    // 1:12 ratio - 1 inch rise for every 12 inches run
                    document.getElementById('gradeRiseInches').value = '1';
                    document.getElementById('gradeRunFeet').value = '1';
                    break;
                case 'ada-preferred':
                    // 1:20 ratio - 1 inch rise for every 20 inches run
                    document.getElementById('gradeRiseInches').value = '1';
                    document.getElementById('gradeRunInches').value = '20';
                    break;
                case 'drainage-min':
                    // 1% grade - 1 inch rise per 100 inches run
                    document.getElementById('gradeRiseInches').value = '1';
                    document.getElementById('gradeRunFeet').value = '8';
                    document.getElementById('gradeRunInches').value = '4';
                    break;
                case 'drainage-ideal':
                    // 2% grade - 2 inches rise per 100 inches run
                    document.getElementById('gradeRiseInches').value = '2';
                    document.getElementById('gradeRunFeet').value = '8';
                    document.getElementById('gradeRunInches').value = '4';
                    break;
                case 'driveway-max':
                    // 15% grade - 15 inches rise per 100 inches run
                    document.getElementById('gradeRiseInches').value = '15';
                    document.getElementById('gradeRunFeet').value = '8';
                    document.getElementById('gradeRunInches').value = '4';
                    break;
                case 'shed-ramp':
                    // 10% grade - 10 inches rise per 100 inches run
                    document.getElementById('gradeRiseInches').value = '10';
                    document.getElementById('gradeRunFeet').value = '8';
                    document.getElementById('gradeRunInches').value = '4';
                    break;
                case 'stairs-typical':
                    // 35° angle, approximately 70% grade
                    document.getElementById('gradeRiseInches').value = '7';
                    document.getElementById('gradeRunInches').value = '10';
                    break;
                case 'roof-min':
                    // 4:12 roof pitch - 4 inches rise per 12 inches run
                    document.getElementById('gradeRiseInches').value = '4';
                    document.getElementById('gradeRunFeet').value = '1';
                    break;
            }
            
            calculateGradeSlope();
            showNotification(`Applied preset: ${description}`, 'success');
        }
        
        function saveGradeToProject() {
            if (!window.currentGradeCalculation) {
                showNotification('No calculation to save', 'error');
                return;
            }
            
            const calc = window.currentGradeCalculation;
            
            // Create preview content
            let previewContent = `
                <div class="save-preview-spacing">
                    <div class="preview-header">Grade/Slope Calculation</div>
                    <div class="preview-equation">Mode: ${calc.mode.replace('find-', 'Calculate ').replace('grade', 'Grade %').replace('rise', 'Rise').replace('run', 'Run')}</div>
                    <div class="preview-result">
                        Grade: ${calc.percent.toFixed(2)}% | Angle: ${calc.angle.toFixed(2)}° | Ratio: ${calc.ratio}
                    </div>
                    <div class="preview-summary">
                        Rise: ${calc.riseDisplay} | Run: ${calc.runDisplay}
                    </div>
                </div>
            `;
            
            // Determine equation based on mode
            let equation = '';
            if (calc.mode === 'find-grade') {
                equation = `${calc.riseDisplay} rise ÷ ${calc.runDisplay} run = ${calc.percent.toFixed(2)}%`;
            } else if (calc.mode === 'find-rise') {
                equation = `${calc.runDisplay} run × ${calc.percent.toFixed(2)}% = ${calc.riseDisplay} rise`;
            } else if (calc.mode === 'find-run') {
                equation = `${calc.riseDisplay} rise ÷ ${calc.percent.toFixed(2)}% = ${calc.runDisplay} run`;
            }
            
            // Determine compliance status
            let complianceText = '';
            if (calc.percent <= 5) {
                complianceText = 'ADA Compliant (Preferred)';
            } else if (calc.percent <= 8.33) {
                complianceText = 'ADA Max Compliance';
            } else if (calc.percent <= 15) {
                complianceText = 'Steep (Check local codes)';
            } else {
                complianceText = 'Very Steep (May not be allowed)';
            }
            
            const saveData = {
                toolName: 'Grade/Slope Calculator',
                type: 'Grade/Slope Calculator',
                summary: `${calc.percent.toFixed(2)}% grade (${calc.angle.toFixed(1)}°) - ${complianceText}`,
                equation: equation,
                result: `${calc.percent.toFixed(2)}% grade, ${calc.angle.toFixed(2)}° angle, ${calc.ratio} ratio`,
                details: `Mode: ${calc.mode.replace('find-', 'Calculate ').replace('grade', 'Grade %').replace('rise', 'Rise').replace('run', 'Run')}\nRise: ${calc.riseDisplay}\nRun: ${calc.runDisplay}\nGrade: ${calc.percent.toFixed(2)}%\nAngle: ${calc.angle.toFixed(2)}°\nRatio: ${calc.ratio}\nCompliance: ${complianceText}`,
                preview: previewContent,
                diagramContainerId: 'gradeContent'
            };
            
            showSaveToProjectModal(saveData);
        }
        
        function toggleQuickReference() {
            const tableDiv = document.getElementById('quickReferenceTable');
            const isHidden = tableDiv.style.display === 'none';
            
            if (isHidden) {
                // Populate table if not already done
                populateReferenceTable();
                tableDiv.style.display = 'block';
            } else {
                tableDiv.style.display = 'none';
            }
        }
        
        function populateReferenceTable() {
            const tbody = document.getElementById('referenceTableBody');
            
            // Check if already populated
            if (tbody.children.length > 0) return;
            
            // Define all screw sizes and their pilot holes
            const screwData = [
                // Standard wood screws
                { size: '#2', diameter: '0.086"', hardwood: '1/16"', softwood: '3/64"', plywood: '3/64"' },
                { size: '#3', diameter: '0.099"', hardwood: '1/16"', softwood: '1/16"', plywood: '3/64"' },
                { size: '#4', diameter: '0.112"', hardwood: '5/64"', softwood: '1/16"', plywood: '1/16"' },
                { size: '#5', diameter: '0.125"', hardwood: '5/64"', softwood: '1/16"', plywood: '1/16"' },
                { size: '#6', diameter: '0.138"', hardwood: '3/32"', softwood: '5/64"', plywood: '5/64"' },
                { size: '#7', diameter: '0.151"', hardwood: '3/32"', softwood: '5/64"', plywood: '5/64"' },
                { size: '#8', diameter: '0.164"', hardwood: '7/64"', softwood: '3/32"', plywood: '3/32"' },
                { size: '#9', diameter: '0.177"', hardwood: '1/8"', softwood: '3/32"', plywood: '3/32"' },
                { size: '#10', diameter: '0.190"', hardwood: '1/8"', softwood: '7/64"', plywood: '7/64"' },
                { size: '#12', diameter: '0.216"', hardwood: '9/64"', softwood: '1/8"', plywood: '1/8"' },
                { size: '#14', diameter: '0.242"', hardwood: '5/32"', softwood: '9/64"', plywood: '9/64"' },
                { size: '#16', diameter: '0.268"', hardwood: '3/16"', softwood: '5/32"', plywood: '5/32"' },
                { size: '#18', diameter: '0.294"', hardwood: '13/64"', softwood: '3/16"', plywood: '3/16"' },
                { size: '#20', diameter: '0.320"', hardwood: '7/32"', softwood: '13/64"', plywood: '13/64"' },
                // Fractional sizes
                { size: '1/4"', diameter: '0.250"', hardwood: '11/64"', softwood: '5/32"', plywood: '5/32"' },
                { size: '5/16"', diameter: '0.313"', hardwood: '7/32"', softwood: '3/16"', plywood: '3/16"' },
                { size: '3/8"', diameter: '0.375"', hardwood: '1/4"', softwood: '7/32"', plywood: '7/32"' },
                { size: '7/16"', diameter: '0.438"', hardwood: '5/16"', softwood: '9/32"', plywood: '9/32"' },
                // Lag bolts
                { size: '1/4" Lag', diameter: '0.250"', hardwood: '3/16"', softwood: '5/32"', plywood: '5/32"', isLag: true },
                { size: '5/16" Lag', diameter: '0.313"', hardwood: '1/4"', softwood: '13/64"', plywood: '13/64"', isLag: true },
                { size: '3/8" Lag', diameter: '0.375"', hardwood: '5/16"', softwood: '1/4"', plywood: '1/4"', isLag: true },
                { size: '1/2" Lag', diameter: '0.500"', hardwood: '3/8"', softwood: '5/16"', plywood: '5/16"', isLag: true },
                { size: '5/8" Lag', diameter: '0.625"', hardwood: '1/2"', softwood: '7/16"', plywood: '7/16"', isLag: true },
                { size: '3/4" Lag', diameter: '0.750"', hardwood: '5/8"', softwood: '1/2"', plywood: '1/2"', isLag: true }
            ];
            
            // Create table rows
            let html = '';
            let lastCategory = '';
            
            screwData.forEach(screw => {
                // Add category row
                const currentCategory = screw.isLag ? 'lag' : 'standard';
                if (currentCategory !== lastCategory) {
                    html += `<tr class="screw-category">
                        <td colspan="5">${screw.isLag ? 'Lag Bolts' : 'Standard Wood Screws'}</td>
                    </tr>`;
                    lastCategory = currentCategory;
                }
                
                // Add data row
                html += `<tr class="${screw.isLag ? 'lag-bolt' : ''}">
                    <td><strong>${screw.size}</strong></td>
                    <td>${screw.diameter}</td>
                    <td>${screw.hardwood}</td>
                    <td>${screw.softwood}</td>
                    <td>${screw.plywood}</td>
                </tr>`;
            });
            
            tbody.innerHTML = html;
        }
        
        function calculatePilotHole(screwSize, woodType) {
            console.log('calculatePilotHole called with:', screwSize, woodType);
            
            // Convert to numeric if string
            const size = typeof screwSize === 'string' ? parseFloat(screwSize) : screwSize;
            console.log('Converted size to:', size);
            
            // Use provided wood type or get from selector (fallback for old calls)
            if (!woodType) {
                console.error('No wood type provided to calculatePilotHole');
                return;
            }
            
            // Pilot hole calculation based on wood type and screw size
            let pilotHoleSize;
            let drillBitSize = '';
            
            // Adjust pilot hole size based on screw type and wood
            if (size >= 0.375) { // Lag bolts and large screws
                if (woodType === 'softwood') {
                    pilotHoleSize = size * 0.65; // 65% for large screws in softwood
                } else if (woodType === 'hardwood') {
                    pilotHoleSize = size * 0.75; // 75% for large screws in hardwood
                } else if (woodType === 'plywood') {
                    pilotHoleSize = size * 0.7; // 70% for large screws in plywood
                } else {
                    pilotHoleSize = size * 0.7;
                }
            } else { // Standard wood screws
                if (woodType === 'softwood') {
                    pilotHoleSize = size * 0.7; // 70% of screw diameter for softwood
                } else if (woodType === 'hardwood') {
                    pilotHoleSize = size * 0.8; // 80% of screw diameter for hardwood
                } else if (woodType === 'plywood') {
                    pilotHoleSize = size * 0.75; // 75% of screw diameter for plywood
                } else {
                    pilotHoleSize = size * 0.75;
                }
            }
            
            // Find closest standard drill bit (expanded range for lag bolts)
            const drillBits = [
                { size: 1/16, display: '1/16"' },
                { size: 5/64, display: '5/64"' },
                { size: 3/32, display: '3/32"' },
                { size: 7/64, display: '7/64"' },
                { size: 1/8, display: '1/8"' },
                { size: 9/64, display: '9/64"' },
                { size: 5/32, display: '5/32"' },
                { size: 11/64, display: '11/64"' },
                { size: 3/16, display: '3/16"' },
                { size: 13/64, display: '13/64"' },
                { size: 7/32, display: '7/32"' },
                { size: 15/64, display: '15/64"' },
                { size: 1/4, display: '1/4"' },
                { size: 17/64, display: '17/64"' },
                { size: 9/32, display: '9/32"' },
                { size: 19/64, display: '19/64"' },
                { size: 5/16, display: '5/16"' },
                { size: 21/64, display: '21/64"' },
                { size: 11/32, display: '11/32"' },
                { size: 23/64, display: '23/64"' },
                { size: 3/8, display: '3/8"' },
                { size: 25/64, display: '25/64"' },
                { size: 13/32, display: '13/32"' },
                { size: 27/64, display: '27/64"' },
                { size: 7/16, display: '7/16"' },
                { size: 29/64, display: '29/64"' },
                { size: 15/32, display: '15/32"' },
                { size: 31/64, display: '31/64"' },
                { size: 1/2, display: '1/2"' },
                { size: 33/64, display: '33/64"' },
                { size: 17/32, display: '17/32"' },
                { size: 35/64, display: '35/64"' },
                { size: 9/16, display: '9/16"' },
                { size: 37/64, display: '37/64"' },
                { size: 19/32, display: '19/32"' },
                { size: 39/64, display: '39/64"' },
                { size: 5/8, display: '5/8"' }
            ];
            
            // Find closest drill bit size
            let closest = drillBits[0];
            let minDiff = Math.abs(pilotHoleSize - closest.size);
            
            for (let bit of drillBits) {
                const diff = Math.abs(pilotHoleSize - bit.size);
                if (diff < minDiff) {
                    minDiff = diff;
                    closest = bit;
                }
            }
            
            drillBitSize = closest.display;
            
            // Store the calculated result globally for saving
            window.currentPilotHoleSize = drillBitSize;
            
            // Display results
            const resultsDiv = document.getElementById('screwResults');
            const resultDisplay = document.getElementById('screwResultDisplay');
            
            if (resultsDiv && resultDisplay) {
                // Determine display format for screw size
                let screwDisplay;
                if (size === 0.086) screwDisplay = '#2';
                else if (size === 0.099) screwDisplay = '#3';
                else if (size === 0.112) screwDisplay = '#4';
                else if (size === 0.125) screwDisplay = '#5';
                else if (size === 0.138) screwDisplay = '#6';
                else if (size === 0.151) screwDisplay = '#7';
                else if (size === 0.164) screwDisplay = '#8';
                else if (size === 0.177) screwDisplay = '#9';
                else if (size === 0.190) screwDisplay = '#10';
                else if (size === 0.203) screwDisplay = '#11';
                else if (size === 0.216) screwDisplay = '#12';
                else if (size === 0.242) screwDisplay = '#14';
                else if (size === 0.25) screwDisplay = '1/4"';
                else if (size === 0.3125) screwDisplay = '5/16"';
                else if (size === 0.375) screwDisplay = '3/8"';
                else if (size === 0.4375) screwDisplay = '7/16" Lag';
                else if (size === 0.5) screwDisplay = '1/2" Lag';
                else if (size === 0.625) screwDisplay = '5/8" Lag';
                else if (size === 0.75) screwDisplay = '3/4" Lag';
                else screwDisplay = `${size.toFixed(3)}"`;
                
                resultDisplay.innerHTML = `
                    <div class="result-card">
                        <h4>📏 Screw: ${screwDisplay} diameter</h4>
                        <h4>🪵 Wood Type: ${woodType.charAt(0).toUpperCase() + woodType.slice(1)}</h4>
                        <div class="pilot-hole-result">
                            <h3>🔩 Recommended Pilot Hole:</h3>
                            <div class="drill-bit-size">${drillBitSize}</div>
                            <p class="calculation-note">
                                Calculated: ${(pilotHoleSize * 64).toFixed(1)}/64" ≈ ${drillBitSize}
                            </p>
                        </div>
                        <div class="drilling-tips">
                            <h4>💡 Drilling Tips:</h4>
                            <ul>
                                <li>Use a drill bit slightly smaller than calculated if unsure</li>
                                <li>Test on scrap wood first</li>
                                <li>Pre-drill slowly to avoid splitting</li>
                                <li>For ${woodType}: ${woodType === 'hardwood' ? 'Go slow, use cutting oil if needed' : woodType === 'softwood' ? 'Standard drilling speed works well' : woodType === 'plywood' ? 'Medium speed, watch for tear-out' : 'Use appropriate speed for material'}</li>
                            </ul>
                        </div>
                        <div style="text-align: center; margin-top: 20px;">
                            <button class="btn btn-success btn-sm" onclick="saveScrewToProject()">📁 Save to Project</button>
                        </div>
                    </div>
                `;
                
                // Show the results section
                resultsDiv.style.display = 'block';
                
                console.log('Results displayed successfully');
                
                // Save to project log if we have an active project
                if (currentProject) {
                    const logEntry = {
                        timestamp: new Date().toISOString(),
                        toolName: 'Screw Calculator',
                        type: 'Screw Calculator', // Keep for backward compatibility
                        summary: `Pilot hole for ${screwDisplay} screw in ${woodType}`,
                        details: `Screw: ${screwDisplay} diameter\nWood: ${woodType}\nPilot Hole: ${drillBitSize}\nCalculated: ${(pilotHoleSize * 64).toFixed(1)}/64"`
                    };
                    
                    currentProject.projectLog = currentProject.projectLog || [];
                    currentProject.projectLog.push(logEntry);
                    saveCurrentProject();
                    updateProjectSelector();
                }
            }
        }
        
        // =====================================================
        // Tile Calculator Functions
        // =====================================================

        // Comprehensive Pattern Database
        const patternDatabase = {
            // === TILE PATTERNS ===
            'straight-lay': {
                name: 'Straight Lay/Grid',
                category: 'tile',
                difficulty: 'beginner',
                description: 'Basic alignment with tiles in straight rows and columns',
                tileRequirements: {
                    shapes: ['rectangle', 'square'],
                    minAspectRatio: 1.0,
                    maxAspectRatio: 4.0,
                    offsetLimitation: 0
                },
                tiles: [
                    { name: 'Main Tile', ratio: 1, color: '#8B4513' }
                ],
                calculations: {
                    wastePercentage: 5,
                    cuttingComplexity: 'low',
                    borderTileRatio: 0.10
                }
            },
            'running-bond': {
                name: 'Running Bond',
                category: 'tile',
                difficulty: 'beginner',
                description: 'Industry-standard brick pattern with 33% offset (NOT 50%)',
                tileRequirements: {
                    shapes: ['rectangle'],
                    minAspectRatio: 1.5,
                    maxAspectRatio: 4.0,
                    offsetLimitation: 0.33
                },
                tiles: [
                    { name: 'Main Tile', ratio: 1, color: '#8B4513' }
                ],
                calculations: {
                    wastePercentage: 8,
                    cuttingComplexity: 'low',
                    borderTileRatio: 0.15
                }
            },
            'herringbone': {
                name: 'Herringbone',
                category: 'tile',
                difficulty: 'intermediate',
                description: '90° interlocking rectangles (NOT squares) in zigzag pattern',
                tileRequirements: {
                    shapes: ['rectangle'],
                    minAspectRatio: 2.0,
                    maxAspectRatio: 4.0,
                    offsetLimitation: 0
                },
                tiles: [
                    { name: 'Plank Tile', ratio: 1, color: '#8B4513' }
                ],
                calculations: {
                    wastePercentage: 15,
                    cuttingComplexity: 'high',
                    borderTileRatio: 0.25
                }
            },
            'chevron': {
                name: 'Chevron',
                category: 'tile',
                difficulty: 'advanced',
                description: 'Angled-end rectangles forming continuous zigzag pattern',
                tileRequirements: {
                    shapes: ['rectangle-angled'],
                    minAspectRatio: 3.0,
                    maxAspectRatio: 6.0,
                    offsetLimitation: 0
                },
                tiles: [
                    { name: 'Chevron Tile', ratio: 1, color: '#8B4513' }
                ],
                calculations: {
                    wastePercentage: 20,
                    cuttingComplexity: 'very-high',
                    borderTileRatio: 0.30
                }
            },
            'diagonal-grid': {
                name: 'Diagonal Grid',
                category: 'tile',
                difficulty: 'intermediate',
                description: 'Straight lay rotated 45° - makes small spaces appear larger',
                tileRequirements: {
                    shapes: ['rectangle', 'square'],
                    minAspectRatio: 1.0,
                    maxAspectRatio: 2.0,
                    offsetLimitation: 0
                },
                tiles: [
                    { name: 'Main Tile', ratio: 1, color: '#8B4513' }
                ],
                calculations: {
                    wastePercentage: 12,
                    cuttingComplexity: 'medium',
                    borderTileRatio: 0.20
                }
            },
            'checkerboard': {
                name: 'Checkerboard',
                category: 'tile',
                difficulty: 'beginner',
                description: 'Alternating colors/finishes using same size square tiles',
                tileRequirements: {
                    shapes: ['square'],
                    minAspectRatio: 1.0,
                    maxAspectRatio: 1.0,
                    offsetLimitation: 0
                },
                tiles: [
                    { name: 'Color A', ratio: 1, color: '#8B4513' },
                    { name: 'Color B', ratio: 1, color: '#D2B48C' }
                ],
                calculations: {
                    wastePercentage: 6,
                    cuttingComplexity: 'low',
                    borderTileRatio: 0.12
                }
            },
            'basketweave': {
                name: 'Basketweave',
                category: 'tile',
                difficulty: 'intermediate',
                description: 'Alternating pairs of rectangles (2:1 ratio required)',
                tileRequirements: {
                    shapes: ['rectangle'],
                    minAspectRatio: 2.0,
                    maxAspectRatio: 2.0,
                    offsetLimitation: 0
                },
                tiles: [
                    { name: 'Main Tile', ratio: 1, color: '#8B4513' }
                ],
                calculations: {
                    wastePercentage: 10,
                    cuttingComplexity: 'medium',
                    borderTileRatio: 0.18
                }
            },
            'versailles': {
                name: 'Versailles',
                category: 'tile',
                difficulty: 'advanced',
                description: 'Multiple tile sizes in repeating French pattern',
                tileRequirements: {
                    shapes: ['rectangle', 'square'],
                    minAspectRatio: 1.0,
                    maxAspectRatio: 2.0,
                    offsetLimitation: 0
                },
                tiles: [
                    { name: 'Large Square', ratio: 4, color: '#8B4513' },
                    { name: 'Medium Rectangle', ratio: 2, color: '#D2B48C' },
                    { name: 'Small Square', ratio: 1, color: '#CD853F' }
                ],
                calculations: {
                    wastePercentage: 18,
                    cuttingComplexity: 'very-high',
                    borderTileRatio: 0.25
                }
            },
            'hexagon': {
                name: 'Hexagon',
                category: 'tile',
                difficulty: 'intermediate',
                description: '6-sided tiles in honeycomb pattern',
                tileRequirements: {
                    shapes: ['hexagon'],
                    minAspectRatio: 1.0,
                    maxAspectRatio: 1.0,
                    offsetLimitation: 0
                },
                tiles: [
                    { name: 'Hex Tile', ratio: 1, color: '#8B4513' }
                ],
                calculations: {
                    wastePercentage: 12,
                    cuttingComplexity: 'high',
                    borderTileRatio: 0.22
                }
            },

            // === PAVER PATTERNS ===
            'paver-stack-bond': {
                name: 'Stack Bond (Pavers)',
                category: 'paver',
                difficulty: 'beginner',
                description: 'Straight alignment - easiest paver pattern for DIY',
                tileRequirements: {
                    shapes: ['rectangle', 'square'],
                    minAspectRatio: 1.0,
                    maxAspectRatio: 3.0,
                    offsetLimitation: 0
                },
                tiles: [
                    { name: 'Paver', ratio: 1, color: '#A0522D' }
                ],
                calculations: {
                    wastePercentage: 5,
                    cuttingComplexity: 'very-low',
                    borderTileRatio: 0.08
                }
            },
            'paver-running-bond': {
                name: 'Running Bond (Pavers)',
                category: 'paver',
                difficulty: 'beginner',
                description: 'Classic brick pattern with 50% offset (pavers can handle this)',
                tileRequirements: {
                    shapes: ['rectangle'],
                    minAspectRatio: 1.5,
                    maxAspectRatio: 3.0,
                    offsetLimitation: 0.50
                },
                tiles: [
                    { name: 'Paver', ratio: 1, color: '#A0522D' }
                ],
                calculations: {
                    wastePercentage: 8,
                    cuttingComplexity: 'low',
                    borderTileRatio: 0.12
                }
            },
            'paver-herringbone': {
                name: 'Herringbone (Pavers)',
                category: 'paver',
                difficulty: 'intermediate',
                description: '90° interlocking brick pattern - very structural',
                tileRequirements: {
                    shapes: ['rectangle'],
                    minAspectRatio: 2.0,
                    maxAspectRatio: 2.5,
                    offsetLimitation: 0
                },
                tiles: [
                    { name: 'Paver', ratio: 1, color: '#A0522D' }
                ],
                calculations: {
                    wastePercentage: 12,
                    cuttingComplexity: 'medium',
                    borderTileRatio: 0.20
                }
            },
            'paver-basketweave': {
                name: 'Basketweave (Pavers)',
                category: 'paver',
                difficulty: 'intermediate',
                description: 'Alternating pairs - requires 2:1 ratio pavers',
                tileRequirements: {
                    shapes: ['rectangle'],
                    minAspectRatio: 2.0,
                    maxAspectRatio: 2.0,
                    offsetLimitation: 0
                },
                tiles: [
                    { name: 'Paver', ratio: 1, color: '#A0522D' }
                ],
                calculations: {
                    wastePercentage: 10,
                    cuttingComplexity: 'medium',
                    borderTileRatio: 0.15
                }
            },
            
            // === ADDITIONAL TILE PATTERNS ===
            'windmill': {
                name: 'Windmill',
                category: 'tile',
                difficulty: 'advanced',
                description: 'Four rectangles around central square forming windmill pattern',
                tileRequirements: {
                    shapes: ['rectangle', 'square'],
                    minAspectRatio: 1.0,
                    maxAspectRatio: 2.0,
                    offsetLimitation: 0
                },
                tiles: [
                    { name: 'Rectangle', ratio: 2, color: '#8B4513' },
                    { name: 'Square', ratio: 1, color: '#D2B48C' }
                ],
                calculations: {
                    wastePercentage: 14,
                    cuttingComplexity: 'high',
                    borderTileRatio: 0.20
                }
            },
            'pinwheel': {
                name: 'Pinwheel',
                category: 'tile',
                difficulty: 'advanced',
                description: 'Four triangular shapes around center creating pinwheel effect',
                tileRequirements: {
                    shapes: ['triangle', 'square'],
                    minAspectRatio: 1.0,
                    maxAspectRatio: 1.0,
                    offsetLimitation: 0
                },
                tiles: [
                    { name: 'Triangle', ratio: 4, color: '#8B4513' },
                    { name: 'Center Square', ratio: 1, color: '#F4A460' }
                ],
                calculations: {
                    wastePercentage: 16,
                    cuttingComplexity: 'very-high',
                    borderTileRatio: 0.25
                }
            },
            'hopscotch': {
                name: 'Hopscotch',
                category: 'tile',
                difficulty: 'intermediate',
                description: 'Alternating large and small squares in hopscotch pattern',
                tileRequirements: {
                    shapes: ['square'],
                    minAspectRatio: 1.0,
                    maxAspectRatio: 1.0,
                    offsetLimitation: 0
                },
                tiles: [
                    { name: 'Large Square', ratio: 1, color: '#8B4513' },
                    { name: 'Small Square', ratio: 0.5, color: '#D2B48C' }
                ],
                calculations: {
                    wastePercentage: 8,
                    cuttingComplexity: 'medium',
                    borderTileRatio: 0.15
                }
            },
            'offset-grid': {
                name: 'Offset Grid',
                category: 'tile',
                difficulty: 'beginner',
                description: 'Grid pattern with 50% offset every other row',
                tileRequirements: {
                    shapes: ['rectangle', 'square'],
                    minAspectRatio: 1.0,
                    maxAspectRatio: 3.0,
                    offsetLimitation: 0.50
                },
                tiles: [
                    { name: 'Main Tile', ratio: 1, color: '#8B4513' }
                ],
                calculations: {
                    wastePercentage: 7,
                    cuttingComplexity: 'low',
                    borderTileRatio: 0.12
                }
            },
            'french-pattern': {
                name: 'French Pattern',
                category: 'tile',
                difficulty: 'expert',
                description: 'Complex multi-size pattern with 4 different tile sizes',
                tileRequirements: {
                    shapes: ['rectangle', 'square'],
                    minAspectRatio: 1.0,
                    maxAspectRatio: 2.0,
                    offsetLimitation: 0
                },
                tiles: [
                    { name: 'Large Rectangle', ratio: 2, color: '#8B4513' },
                    { name: 'Medium Rectangle', ratio: 1.5, color: '#D2B48C' },
                    { name: 'Small Rectangle', ratio: 1, color: '#F4A460' },
                    { name: 'Small Square', ratio: 0.7, color: '#DEB887' }
                ],
                calculations: {
                    wastePercentage: 22,
                    cuttingComplexity: 'very-high',
                    borderTileRatio: 0.30
                }
            },
            'modular': {
                name: 'Modular',
                category: 'tile',
                difficulty: 'advanced',
                description: 'Three tile sizes in repeating modular pattern',
                tileRequirements: {
                    shapes: ['rectangle'],
                    minAspectRatio: 2.0,
                    maxAspectRatio: 3.0,
                    offsetLimitation: 0
                },
                tiles: [
                    { name: 'Long Rectangle', ratio: 3, color: '#8B4513' },
                    { name: 'Medium Rectangle', ratio: 2, color: '#D2B48C' },
                    { name: 'Short Rectangle', ratio: 1, color: '#F4A460' }
                ],
                calculations: {
                    wastePercentage: 18,
                    cuttingComplexity: 'high',
                    borderTileRatio: 0.25
                }
            },
            'cobblestone': {
                name: 'Cobblestone',
                category: 'tile',
                difficulty: 'intermediate',
                description: 'Irregular brick pattern mimicking old cobblestone streets',
                tileRequirements: {
                    shapes: ['rectangle'],
                    minAspectRatio: 1.5,
                    maxAspectRatio: 2.5,
                    offsetLimitation: 0.25
                },
                tiles: [
                    { name: 'Cobble Tile', ratio: 1, color: '#696969' }
                ],
                calculations: {
                    wastePercentage: 12,
                    cuttingComplexity: 'medium',
                    borderTileRatio: 0.18
                }
            },
            'brick-ashlar': {
                name: 'Brick Ashlar',
                category: 'tile',
                difficulty: 'intermediate',
                description: 'Mixed brick sizes in ashlar masonry pattern',
                tileRequirements: {
                    shapes: ['rectangle'],
                    minAspectRatio: 2.0,
                    maxAspectRatio: 4.0,
                    offsetLimitation: 0.33
                },
                tiles: [
                    { name: 'Long Brick', ratio: 2, color: '#B22222' },
                    { name: 'Short Brick', ratio: 1, color: '#CD5C5C' }
                ],
                calculations: {
                    wastePercentage: 15,
                    cuttingComplexity: 'medium',
                    borderTileRatio: 0.20
                }
            },
            'quarter-turn': {
                name: 'Quarter Turn',
                category: 'tile',
                difficulty: 'intermediate',
                description: 'Four tiles arranged in pinwheel with 90° rotations',
                tileRequirements: {
                    shapes: ['rectangle'],
                    minAspectRatio: 2.0,
                    maxAspectRatio: 3.0,
                    offsetLimitation: 0
                },
                tiles: [
                    { name: 'Rectangle', ratio: 1, color: '#8B4513' }
                ],
                calculations: {
                    wastePercentage: 13,
                    cuttingComplexity: 'medium',
                    borderTileRatio: 0.18
                }
            },
            'mixed-size-straight': {
                name: 'Mixed Size Straight',
                category: 'tile',
                difficulty: 'beginner',
                description: 'Two different tile sizes in straight-lay pattern',
                tileRequirements: {
                    shapes: ['rectangle', 'square'],
                    minAspectRatio: 1.0,
                    maxAspectRatio: 2.0,
                    offsetLimitation: 0
                },
                tiles: [
                    { name: 'Large Tile', ratio: 2, color: '#8B4513' },
                    { name: 'Small Tile', ratio: 1, color: '#D2B48C' }
                ],
                calculations: {
                    wastePercentage: 9,
                    cuttingComplexity: 'low',
                    borderTileRatio: 0.14
                }
            },
            
            // === ADDITIONAL PAVER PATTERNS ===
            'paver-circular': {
                name: 'Circular (Pavers)',
                category: 'paver',
                difficulty: 'expert',
                description: 'Curved circular pattern requiring specialized shaped pavers',
                tileRequirements: {
                    shapes: ['wedge', 'curved'],
                    minAspectRatio: 1.0,
                    maxAspectRatio: 2.0,
                    offsetLimitation: 0
                },
                tiles: [
                    { name: 'Wedge Paver', ratio: 1, color: '#A0522D' }
                ],
                calculations: {
                    wastePercentage: 25,
                    cuttingComplexity: 'very-high',
                    borderTileRatio: 0.35
                }
            },
            'paver-fan': {
                name: 'Fan (Pavers)',
                category: 'paver',
                difficulty: 'expert',
                description: 'Fan-shaped repeating pattern with wedge pavers',
                tileRequirements: {
                    shapes: ['wedge'],
                    minAspectRatio: 1.0,
                    maxAspectRatio: 1.5,
                    offsetLimitation: 0
                },
                tiles: [
                    { name: 'Fan Wedge', ratio: 1, color: '#A0522D' }
                ],
                calculations: {
                    wastePercentage: 20,
                    cuttingComplexity: 'very-high',
                    borderTileRatio: 0.30
                }
            },
            'paver-cobblestone': {
                name: 'Cobblestone (Pavers)',
                category: 'paver',
                difficulty: 'intermediate',
                description: 'Random cobblestone pattern with varying paver sizes',
                tileRequirements: {
                    shapes: ['rectangle', 'square'],
                    minAspectRatio: 1.0,
                    maxAspectRatio: 2.0,
                    offsetLimitation: 0
                },
                tiles: [
                    { name: 'Large Cobble', ratio: 2, color: '#A0522D' },
                    { name: 'Medium Cobble', ratio: 1.5, color: '#8B7355' },
                    { name: 'Small Cobble', ratio: 1, color: '#696969' }
                ],
                calculations: {
                    wastePercentage: 18,
                    cuttingComplexity: 'high',
                    borderTileRatio: 0.25
                }
            },
            'paver-random': {
                name: 'Random (Pavers)',
                category: 'paver',
                difficulty: 'advanced',
                description: 'Completely random placement with mixed paver sizes',
                tileRequirements: {
                    shapes: ['rectangle', 'square'],
                    minAspectRatio: 1.0,
                    maxAspectRatio: 3.0,
                    offsetLimitation: 0
                },
                tiles: [
                    { name: 'Large Paver', ratio: 3, color: '#A0522D' },
                    { name: 'Medium Paver', ratio: 2, color: '#8B7355' },
                    { name: 'Small Paver', ratio: 1, color: '#696969' }
                ],
                calculations: {
                    wastePercentage: 22,
                    cuttingComplexity: 'high',
                    borderTileRatio: 0.28
                }
            }
        };

        // Current tile calculation data
        let currentTileData = {
            mode: 'tile-first', // 'tile-first' or 'pattern-first'
            selectedPattern: 'running-bond',
            tileLength: 0, // in inches
            tileWidth: 0, // in inches
            aspectRatio: 0,
            compatiblePatterns: [],
            groutSpacing: 0,
            projectSqFt: 0,
            wasteFactor: 10,
            tiles: []
        };

        function initTileCalculator() {
            populatePatternDropdown();
            setTileMode('tile-first');
            updateWasteDisplay();
        }

        // === DUAL-MODE INTERFACE FUNCTIONS ===

        function setTileMode(mode) {
            currentTileData.mode = mode;
            
            // Update button states
            document.getElementById('tileModeBtn').classList.remove('active');
            document.getElementById('patternModeBtn').classList.remove('active');
            
            if (mode === 'tile-first') {
                document.getElementById('tileModeBtn').classList.add('active');
                document.getElementById('tileFristInterface').style.display = 'block';
                document.getElementById('patternFirstInterface').style.display = 'none';
                document.getElementById('modeDescription').textContent = 'Enter your tile dimensions to see compatible patterns';
            } else {
                document.getElementById('patternModeBtn').classList.add('active');
                document.getElementById('tileFristInterface').style.display = 'none';
                document.getElementById('patternFirstInterface').style.display = 'block';
                document.getElementById('modeDescription').textContent = 'Choose a pattern to see ideal tile size requirements';
            }
            
            updateTileCalculations();
        }

        function populatePatternDropdown() {
            const dropdown = document.getElementById('selectedPattern');
            dropdown.innerHTML = '';
            
            // Group patterns by category
            const tilePatterns = [];
            const paverPatterns = [];
            
            Object.entries(patternDatabase).forEach(([key, pattern]) => {
                if (pattern.category === 'tile') {
                    tilePatterns.push({ key, pattern });
                } else if (pattern.category === 'paver') {
                    paverPatterns.push({ key, pattern });
                }
            });
            
            // Add tile patterns
            if (tilePatterns.length > 0) {
                const tileGroup = document.createElement('optgroup');
                tileGroup.label = 'Tile Patterns';
                tilePatterns.forEach(({ key, pattern }) => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = `${pattern.name} (${pattern.difficulty})`;
                    tileGroup.appendChild(option);
                });
                dropdown.appendChild(tileGroup);
            }
            
            // Add paver patterns
            if (paverPatterns.length > 0) {
                const paverGroup = document.createElement('optgroup');
                paverGroup.label = 'Paver Patterns';
                paverPatterns.forEach(({ key, pattern }) => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = `${pattern.name} (${pattern.difficulty})`;
                    paverGroup.appendChild(option);
                });
                dropdown.appendChild(paverGroup);
            }
        }

        // === PRECISION INPUT FUNCTIONS (reusing existing system) ===

        function getInputInches(feetId, inchesId, fractionId) {
            const feetEl = document.getElementById(feetId);
            const inchesEl = document.getElementById(inchesId);
            const fractionEl = document.getElementById(fractionId);
            
            const feet = feetEl ? (parseFloat(feetEl.value) || 0) : 0;
            const inches = inchesEl ? (parseFloat(inchesEl.value) || 0) : 0;
            const fraction = fractionEl ? (parseFloat(fractionEl.value) || 0) : 0;
            return (feet * 12) + inches + fraction;
        }

        function updateTileFromDimensions() {
            // Use smart input values if available, otherwise fall back to legacy inputs
            if (currentTileLengthInches > 0) {
                currentTileData.tileLength = currentTileLengthInches;
            } else {
                currentTileData.tileLength = getInputInches('tileLengthFeet', 'tileLengthInches', 'tileLengthFraction');
            }
            
            if (currentTileWidthInches > 0) {
                currentTileData.tileWidth = currentTileWidthInches;
            } else {
                currentTileData.tileWidth = getInputInches('tileWidthFeet', 'tileWidthInches', 'tileWidthFraction');
            }
            
            if (currentTileData.tileLength > 0 && currentTileData.tileWidth > 0) {
                currentTileData.aspectRatio = currentTileData.tileLength / currentTileData.tileWidth;
                document.getElementById('tileAspectRatio').value = currentTileData.aspectRatio.toFixed(2) + ':1';
                
                // Find compatible patterns
                findCompatiblePatterns();
            } else {
                document.getElementById('tileAspectRatio').value = '';
                document.getElementById('compatiblePatterns').innerHTML = 'Enter dimensions above';
            }
            
            updateTileCalculations();
        }

        function findCompatiblePatterns() {
            const aspectRatio = currentTileData.aspectRatio;
            currentTileData.compatiblePatterns = [];
            
            Object.entries(patternDatabase).forEach(([key, pattern]) => {
                const minRatio = pattern.tileRequirements.minAspectRatio;
                const maxRatio = pattern.tileRequirements.maxAspectRatio;
                
                let compatibility = 'incompatible';
                if (aspectRatio >= minRatio && aspectRatio <= maxRatio) {
                    compatibility = 'compatible';
                    currentTileData.compatiblePatterns.push({ key, pattern, compatibility });
                } else if (Math.abs(aspectRatio - minRatio) <= 0.2 || Math.abs(aspectRatio - maxRatio) <= 0.2) {
                    compatibility = 'warning';
                    currentTileData.compatiblePatterns.push({ key, pattern, compatibility });
                }
            });
            
            displayCompatiblePatterns();
        }

        function displayCompatiblePatterns() {
            const container = document.getElementById('compatiblePatterns');
            
            if (currentTileData.compatiblePatterns.length === 0) {
                container.innerHTML = '<div class="pattern-tag incompatible">No compatible patterns found</div>';
                return;
            }
            
            let html = '';
            currentTileData.compatiblePatterns.forEach(({ key, pattern, compatibility }) => {
                html += `<div class="pattern-tag ${compatibility}" onclick="selectPatternFromCompatible('${key}')">${pattern.name}</div>`;
            });
            
            container.innerHTML = html;
        }

        function selectPatternFromCompatible(patternKey) {
            currentTileData.selectedPattern = patternKey;
            updateSelectedPatternDisplay();
            updateTileCalculations();
        }

        function updatePatternFirst() {
            const selectedKey = document.getElementById('selectedPattern').value;
            currentTileData.selectedPattern = selectedKey;
            
            if (selectedKey && patternDatabase[selectedKey]) {
                const pattern = patternDatabase[selectedKey];
                displayPatternRequirements(pattern);
                updateSelectedPatternDisplay();
            }
            
            updateTileCalculations();
        }

        function displayPatternRequirements(pattern) {
            const container = document.getElementById('patternRequirements');
            const reqs = pattern.tileRequirements;
            
            let html = `
                <h4>Pattern Requirements</h4>
                <div class="requirement-item">
                    <strong>Shapes:</strong> ${reqs.shapes.join(', ')}
                </div>
                <div class="requirement-item">
                    <strong>Aspect Ratio:</strong> ${reqs.minRatio}:1 to ${reqs.maxRatio}:1
                </div>
            `;
            
            if (reqs.offsetLimitation > 0) {
                html += `
                    <div class="requirement-item">
                        <strong>Max Offset:</strong> ${(reqs.offsetLimitation * 100)}%
                    </div>
                `;
            }
            
            // Suggest common tile sizes
            html += `
                <div class="requirement-item">
                    <strong>Suggested Tile Sizes:</strong>
                    <div class="suggested-sizes">
            `;
            
            // Generate suggestions based on aspect ratio requirements
            const commonSizes = generateSuggestedSizes(reqs);
            commonSizes.forEach(size => {
                html += `<span class="size-suggestion" onclick="applySuggestedSize(${size.length}, ${size.width})">${size.display}</span>`;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function generateSuggestedSizes(requirements) {
            const suggestions = [];
            const minRatio = requirements.minAspectRatio;
            const maxRatio = requirements.maxAspectRatio;
            
            // Common tile dimensions in inches
            const commonDimensions = [
                { w: 6, l: 12 }, { w: 6, l: 18 }, { w: 6, l: 24 }, { w: 6, l: 36 },
                { w: 8, l: 16 }, { w: 8, l: 24 }, { w: 8, l: 32 }, { w: 8, l: 48 },
                { w: 12, l: 12 }, { w: 12, l: 24 }, { w: 16, l: 16 }, { w: 18, l: 18 },
                { w: 24, l: 24 }, { w: 12, l: 36 }, { w: 9, l: 47 }
            ];
            
            commonDimensions.forEach(dim => {
                const ratio = dim.l / dim.w;
                if (ratio >= minRatio && ratio <= maxRatio) {
                    suggestions.push({
                        width: dim.w,
                        length: dim.l,
                        display: `${dim.l}" × ${dim.w}"`
                    });
                }
            });
            
            return suggestions.slice(0, 6); // Limit to 6 suggestions
        }

        function applySuggestedSize(length, width) {
            // Switch to tile-first mode and populate dimensions
            setTileMode('tile-first');
            
            // Set length
            document.getElementById('tileLengthFeet').value = Math.floor(length / 12);
            document.getElementById('tileLengthInches').value = length % 12;
            document.getElementById('tileLengthFraction').value = 0;
            
            // Set width
            document.getElementById('tileWidthFeet').value = Math.floor(width / 12);
            document.getElementById('tileWidthInches').value = width % 12;
            document.getElementById('tileWidthFraction').value = 0;
            
            updateTileFromDimensions();
        }

        function updateSelectedPatternDisplay() {
            const pattern = patternDatabase[currentTileData.selectedPattern];
            if (!pattern) return;
            
            document.getElementById('currentPatternName').textContent = pattern.name;
            document.getElementById('currentPatternDescription').textContent = pattern.description;
            document.getElementById('patternDifficulty').textContent = pattern.difficulty;
            document.getElementById('patternDifficulty').className = `stat-value difficulty-${pattern.difficulty}`;
            document.getElementById('patternWaste').textContent = pattern.calculations.wastePercentage + '%';
            document.getElementById('patternCutting').textContent = pattern.calculations.cuttingComplexity;
            
            // Update pattern preview
            generateInteractivePatternPreview();
        }

        // === INTERACTIVE SVG PATTERN VISUALIZATION ===

        // SVG Pattern Cache to avoid regenerating identical patterns
        const svgPatternCache = new Map();
        
        // Mobile device detection utility
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
                || window.innerWidth < 768;
        }
        
        // Get pattern cache key
        function getPatternCacheKey(patternKey, tileLength, tileWidth, canvasWidth, canvasHeight) {
            return `${patternKey}_${tileLength}_${tileWidth}_${canvasWidth}_${canvasHeight}`;
        }

        function generateInteractivePatternPreview() {
            const pattern = patternDatabase[currentTileData.selectedPattern];
            if (!pattern) return;
            
            const container = document.getElementById('patternPreview');
            const svgWidth = 400;
            const svgHeight = 250;
            
            // Calculate tile dimensions for preview (scale to fit nicely)
            let previewTileLength = 40;
            let previewTileWidth = 20;
            
            if (currentTileData.tileLength > 0 && currentTileData.tileWidth > 0) {
                const scale = Math.min(60 / currentTileData.tileLength, 40 / currentTileData.tileWidth);
                previewTileLength = currentTileData.tileLength * scale;
                previewTileWidth = currentTileData.tileWidth * scale;
            }
            
            let svg = `
                <svg width="${svgWidth}" height="${svgHeight}" viewBox="0 0 ${svgWidth} ${svgHeight}" 
                     style="border: 1px solid #ddd; border-radius: 4px; background: #f9f9f9;">
                    <defs>
                        <pattern id="grout" patternUnits="userSpaceOnUse" width="2" height="2">
                            <rect width="2" height="2" fill="#C0C0C0"/>
                        </pattern>
                    </defs>
            `;
            
            // Generate pattern-specific SVG
            svg += generatePatternSVG(currentTileData.selectedPattern, previewTileLength, previewTileWidth, svgWidth, svgHeight);
            
            // Add measurements and annotations
            svg += generatePatternAnnotations(pattern, previewTileLength, previewTileWidth);
            
            svg += '</svg>';
            container.innerHTML = svg;
        }

        function generatePatternSVG(patternKey, tileLength, tileWidth, canvasWidth, canvasHeight) {
            // Check cache first
            const cacheKey = getPatternCacheKey(patternKey, tileLength, tileWidth, canvasWidth, canvasHeight);
            if (svgPatternCache.has(cacheKey)) {
                return svgPatternCache.get(cacheKey);
            }
            
            const pattern = patternDatabase[patternKey];
            const groutWidth = 1; // Visual grout width for preview
            let result = '';
            
            switch(patternKey) {
                case 'straight-lay':
                    result = generateStraightLaySVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, pattern.tiles[0].color);
                    break;
                    
                case 'running-bond':
                    result = generateRunningBondSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, pattern.tiles[0].color);
                    break;
                    
                case 'herringbone':
                    result = generateHerringboneSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, pattern.tiles[0].color);
                    break;
                    
                case 'diagonal-grid':
                    result = generateDiagonalGridSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, pattern.tiles[0].color);
                    break;
                    
                case 'checkerboard':
                    result = generateCheckerboardSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, pattern.tiles);
                    break;
                    
                case 'basketweave':
                    result = generateBasketweaveSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, pattern.tiles[0].color);
                    break;
                    
                case 'versailles':
                    result = generateVersaillesSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, pattern.tiles);
                    break;
                    
                case 'hexagon':
                    result = generateHexagonSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, pattern.tiles[0].color);
                    break;
                    
                // Paver patterns
                case 'paver-stack-bond':
                    result = generateStraightLaySVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, pattern.tiles[0].color);
                    break;
                    
                case 'paver-running-bond':
                    result = generateRunningBondSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, pattern.tiles[0].color, 0.5); // 50% offset for pavers
                    break;
                    
                case 'paver-herringbone':
                    result = generateHerringboneSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, pattern.tiles[0].color);
                    break;
                    
                case 'paver-basketweave':
                    result = generateBasketweaveSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, pattern.tiles[0].color);
                    break;
                    
                // New tile patterns
                case 'windmill':
                    result = generateWindmillSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, pattern.tiles);
                    break;
                case 'pinwheel':
                    result = generatePinwheelSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, pattern.tiles);
                    break;
                case 'hopscotch':
                    result = generateHopscotchSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, pattern.tiles);
                    break;
                case 'offset-grid':
                    result = generateOffsetGridSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, pattern.tiles[0].color);
                    break;
                case 'french-pattern':
                    result = generateFrenchPatternSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, pattern.tiles);
                    break;
                case 'modular':
                    result = generateModularSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, pattern.tiles);
                    break;
                case 'cobblestone':
                    result = generateCobbleStoneSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, pattern.tiles[0].color);
                    break;
                case 'brick-ashlar':
                    result = generateBrickAshlarSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, pattern.tiles);
                    break;
                case 'quarter-turn':
                    result = generateQuarterTurnSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, pattern.tiles[0].color);
                    break;
                case 'mixed-size-straight':
                    result = generateMixedSizeStraightSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, pattern.tiles);
                    break;
                    
                // New paver patterns
                case 'paver-circular':
                    result = generatePaverCircularSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, pattern.tiles[0].color);
                    break;
                case 'paver-fan':
                    result = generatePaverFanSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, pattern.tiles[0].color);
                    break;
                case 'paver-cobblestone':
                    result = generatePaverCobbleStoneSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, pattern.tiles);
                    break;
                case 'paver-random':
                    result = generatePaverRandomSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, pattern.tiles);
                    break;
                    
                default:
                    result = `<text x="200" y="125" text-anchor="middle" fill="#666" font-size="14">Pattern preview coming soon</text>`;
            }
            
            // Cache the result
            svgPatternCache.set(cacheKey, result);
            
            // Limit cache size to prevent memory issues
            if (svgPatternCache.size > 50) {
                const firstKey = svgPatternCache.keys().next().value;
                svgPatternCache.delete(firstKey);
            }
            
            return result;
        }

        function generateStraightLaySVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, color) {
            const svgParts = [];
            const effectiveTileLength = tileLength + groutWidth;
            const effectiveTileWidth = tileWidth + groutWidth;
            
            // Detect mobile device and limit complexity
            const isMobile = isMobileDevice();
            const maxTiles = isMobile ? 100 : 500; // Limit tiles on mobile
            let tileCount = 0;
            
            for (let row = 0; row * effectiveTileWidth < canvasHeight + effectiveTileWidth; row++) {
                for (let col = 0; col * effectiveTileLength < canvasWidth + effectiveTileLength; col++) {
                    const x = col * effectiveTileLength;
                    const y = row * effectiveTileWidth;
                    
                    if (x < canvasWidth && y < canvasHeight) {
                        if (tileCount >= maxTiles) {
                            svgParts.push(`<text x="${canvasWidth/2}" y="${canvasHeight/2}" text-anchor="middle" fill="#999" font-size="12">Pattern continues...</text>`);
                            return svgParts.join('');
                        }
                        svgParts.push(`<rect x="${x}" y="${y}" width="${tileLength}" height="${tileWidth}" fill="${color}" stroke="#C0C0C0" stroke-width="0.5" />`);
                        tileCount++;
                    }
                }
            }
            return svgParts.join('');
        }

        function generateRunningBondSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, color, offsetPercent = 0.33) {
            const svgParts = [];
            const effectiveTileLength = tileLength + groutWidth;
            const effectiveTileWidth = tileWidth + groutWidth;
            const offset = tileLength * offsetPercent;
            
            // Detect mobile device and limit complexity
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const maxTiles = isMobile ? 100 : 500;
            let tileCount = 0;
            
            for (let row = 0; row * effectiveTileWidth < canvasHeight + effectiveTileWidth; row++) {
                const rowOffset = (row % 2) * offset;
                for (let col = 0; col * effectiveTileLength < canvasWidth + effectiveTileLength + offset; col++) {
                    const x = col * effectiveTileLength + rowOffset;
                    const y = row * effectiveTileWidth;
                    
                    if (x < canvasWidth + offset && y < canvasHeight && x + tileLength > 0) {
                        if (tileCount >= maxTiles) {
                            svgParts.push(`<text x="${canvasWidth/2}" y="${canvasHeight/2}" text-anchor="middle" fill="#999" font-size="12">Pattern continues...</text>`);
                            return svgParts.join('');
                        }
                        svgParts.push(`<rect x="${x}" y="${y}" width="${tileLength}" height="${tileWidth}" fill="${color}" stroke="#C0C0C0" stroke-width="0.5" />`);
                        tileCount++;
                    }
                }
            }
            return svgParts.join('');
        }

        function generateHerringboneSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, color) {
            const svgParts = [];
            const unitWidth = tileLength + tileWidth + groutWidth * 2;
            const unitHeight = tileLength + tileWidth + groutWidth * 2;
            
            // Detect mobile device and limit complexity
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const maxTiles = isMobile ? 50 : 250; // Herringbone uses 2 tiles per unit
            let tileCount = 0;
            
            for (let row = 0; row * unitHeight < canvasHeight + unitHeight; row++) {
                for (let col = 0; col * unitWidth < canvasWidth + unitWidth; col++) {
                    const baseX = col * unitWidth;
                    const baseY = row * unitHeight;
                    
                    if (tileCount >= maxTiles) {
                        svgParts.push(`<text x="${canvasWidth/2}" y="${canvasHeight/2}" text-anchor="middle" fill="#999" font-size="12">Pattern continues...</text>`);
                        return svgParts.join('');
                    }
                    
                    // First tile (horizontal)
                    svgParts.push(`<rect x="${baseX}" y="${baseY}" width="${tileLength}" height="${tileWidth}" fill="${color}" stroke="#C0C0C0" stroke-width="0.5" />`);
                    tileCount++;
                    
                    // Second tile (vertical)
                    svgParts.push(`<rect x="${baseX + tileLength + groutWidth}" y="${baseY}" width="${tileWidth}" height="${tileLength}" fill="${color}" stroke="#C0C0C0" stroke-width="0.5" />`);
                    tileCount++;
                }
            }
            return svgParts.join('');
        }

        function generateDiagonalGridSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, color) {
            let svg = '';
            const transform = `rotate(45 ${canvasWidth/2} ${canvasHeight/2})`;
            
            svg += `<g transform="${transform}">`;
            svg += generateStraightLaySVG(tileLength, tileWidth, groutWidth, canvasWidth * 1.5, canvasHeight * 1.5, color);
            svg += `</g>`;
            
            return svg;
        }

        function generateCheckerboardSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, tiles) {
            const svgParts = [];
            const effectiveTileLength = tileLength + groutWidth;
            const effectiveTileWidth = tileWidth + groutWidth;
            
            // Detect mobile device and limit complexity
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const maxTiles = isMobile ? 100 : 500;
            let tileCount = 0;
            
            for (let row = 0; row * effectiveTileWidth < canvasHeight + effectiveTileWidth; row++) {
                for (let col = 0; col * effectiveTileLength < canvasWidth + effectiveTileLength; col++) {
                    const x = col * effectiveTileLength;
                    const y = row * effectiveTileWidth;
                    const colorIndex = (row + col) % 2;
                    const color = tiles[colorIndex].color;
                    
                    if (x < canvasWidth && y < canvasHeight) {
                        if (tileCount >= maxTiles) {
                            svgParts.push(`<text x="${canvasWidth/2}" y="${canvasHeight/2}" text-anchor="middle" fill="#999" font-size="12">Pattern continues...</text>`);
                            return svgParts.join('');
                        }
                        svgParts.push(`<rect x="${x}" y="${y}" width="${tileLength}" height="${tileWidth}" fill="${color}" stroke="#C0C0C0" stroke-width="0.5" />`);
                        tileCount++;
                    }
                }
            }
            return svgParts.join('');
        }

        function generateBasketweaveSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, color) {
            const svgParts = [];
            const pairWidth = tileLength * 2 + groutWidth * 3;
            const pairHeight = tileWidth * 2 + groutWidth * 3;
            
            // Detect mobile device and limit complexity
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const maxTiles = isMobile ? 50 : 250; // Basketweave uses 2 tiles per unit
            let tileCount = 0;
            
            for (let row = 0; row * pairHeight < canvasHeight + pairHeight; row++) {
                for (let col = 0; col * pairWidth < canvasWidth + pairWidth; col++) {
                    const baseX = col * pairWidth;
                    const baseY = row * pairHeight;
                    const isHorizontal = (row + col) % 2 === 0;
                    
                    if (tileCount >= maxTiles) {
                        svgParts.push(`<text x="${canvasWidth/2}" y="${canvasHeight/2}" text-anchor="middle" fill="#999" font-size="12">Pattern continues...</text>`);
                        return svgParts.join('');
                    }
                    
                    if (isHorizontal) {
                        // Two horizontal tiles
                        svgParts.push(`<rect x="${baseX}" y="${baseY}" width="${tileLength}" height="${tileWidth}" fill="${color}" stroke="#C0C0C0" stroke-width="0.5" />`);
                        svgParts.push(`<rect x="${baseX}" y="${baseY + tileWidth + groutWidth}" width="${tileLength}" height="${tileWidth}" fill="${color}" stroke="#C0C0C0" stroke-width="0.5" />`);
                        tileCount += 2;
                    } else {
                        // Two vertical tiles
                        svgParts.push(`<rect x="${baseX}" y="${baseY}" width="${tileWidth}" height="${tileLength}" fill="${color}" stroke="#C0C0C0" stroke-width="0.5" />`);
                        svgParts.push(`<rect x="${baseX + tileWidth + groutWidth}" y="${baseY}" width="${tileWidth}" height="${tileLength}" fill="${color}" stroke="#C0C0C0" stroke-width="0.5" />`);
                        tileCount += 2;
                    }
                }
            }
            return svgParts.join('');
        }

        function generateVersaillesSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, tiles) {
            const svgParts = [];
            
            // Versailles pattern uses multiple tile sizes - simplified 4-tile repeat pattern
            const largeSize = Math.max(tileLength, tileWidth);
            const mediumSize = largeSize * 0.7;
            const smallSize = largeSize * 0.5;
            
            // Pattern repeat dimensions
            const patternWidth = largeSize * 2 + groutWidth * 3;
            const patternHeight = largeSize * 2 + groutWidth * 3;
            
            // Get colors for different tile sizes
            const largeColor = tiles[0] ? tiles[0].color : '#8B4513';
            const mediumColor = tiles[1] ? tiles[1].color : '#D2B48C';
            const smallColor = tiles[2] ? tiles[2].color : '#F4A460';
            
            // Detect mobile device and limit complexity
            const isMobile = isMobileDevice();
            const maxTiles = isMobile ? 40 : 200; // Versailles uses 4 tiles per unit
            let tileCount = 0;
            
            for (let row = 0; row * patternHeight < canvasHeight + patternHeight; row++) {
                for (let col = 0; col * patternWidth < canvasWidth + patternWidth; col++) {
                    const baseX = col * patternWidth;
                    const baseY = row * patternHeight;
                    
                    if (tileCount >= maxTiles) {
                        svgParts.push(`<text x="${canvasWidth/2}" y="${canvasHeight/2}" text-anchor="middle" fill="#999" font-size="12">Pattern continues...</text>`);
                        return svgParts.join('');
                    }
                    
                    // Large center square
                    svgParts.push(`<rect x="${baseX + groutWidth}" y="${baseY + groutWidth}" width="${largeSize}" height="${largeSize}" fill="${largeColor}" stroke="#C0C0C0" stroke-width="0.5" />`);
                    
                    // Medium rectangles around large square
                    svgParts.push(`<rect x="${baseX + largeSize + groutWidth * 2}" y="${baseY + groutWidth}" width="${mediumSize}" height="${mediumSize * 0.6}" fill="${mediumColor}" stroke="#C0C0C0" stroke-width="0.5" />`);
                    svgParts.push(`<rect x="${baseX + groutWidth}" y="${baseY + largeSize + groutWidth * 2}" width="${mediumSize * 0.6}" height="${mediumSize}" fill="${mediumColor}" stroke="#C0C0C0" stroke-width="0.5" />`);
                    
                    // Small accent squares
                    svgParts.push(`<rect x="${baseX + largeSize + groutWidth * 2}" y="${baseY + mediumSize * 0.6 + groutWidth * 2}" width="${smallSize}" height="${smallSize}" fill="${smallColor}" stroke="#C0C0C0" stroke-width="0.5" />`);
                    
                    tileCount += 4;
                }
            }
            return svgParts.join('');
        }

        function generateHexagonSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, color) {
            const svgParts = [];
            
            // Hexagon dimensions - use the smaller dimension as the radius
            const radius = Math.min(tileLength, tileWidth) / 2;
            const hexHeight = radius * Math.sqrt(3);
            const hexWidth = radius * 2;
            
            // Spacing between hexagon centers
            const horizontalSpacing = hexWidth * 0.75 + groutWidth;
            const verticalSpacing = hexHeight + groutWidth;
            
            // Generate hexagon path
            function createHexagonPath(centerX, centerY, radius) {
                const points = [];
                for (let i = 0; i < 6; i++) {
                    const angle = (Math.PI / 3) * i;
                    const x = centerX + radius * Math.cos(angle);
                    const y = centerY + radius * Math.sin(angle);
                    points.push(`${x},${y}`);
                }
                return `M ${points.join(' L ')} Z`;
            }
            
            // Detect mobile device and limit complexity
            const isMobile = isMobileDevice();
            const maxTiles = isMobile ? 80 : 400;
            let tileCount = 0;
            
            // Draw hexagon grid
            for (let row = 0; row * verticalSpacing < canvasHeight + verticalSpacing; row++) {
                for (let col = 0; col * horizontalSpacing < canvasWidth + horizontalSpacing; col++) {
                    const offsetX = (row % 2) * (horizontalSpacing / 2); // Offset every other row
                    const centerX = col * horizontalSpacing + radius + offsetX;
                    const centerY = row * verticalSpacing + hexHeight / 2;
                    
                    // Only draw if hexagon is visible in canvas
                    if (centerX - radius < canvasWidth && centerY - hexHeight / 2 < canvasHeight) {
                        if (tileCount >= maxTiles) {
                            svgParts.push(`<text x="${canvasWidth/2}" y="${canvasHeight/2}" text-anchor="middle" fill="#999" font-size="12">Pattern continues...</text>`);
                            return svgParts.join('');
                        }
                        const hexPath = createHexagonPath(centerX, centerY, radius * 0.9); // Slightly smaller for grout lines
                        svgParts.push(`<path d="${hexPath}" fill="${color}" stroke="#C0C0C0" stroke-width="0.5" />`);
                        tileCount++;
                    }
                }
            }
            return svgParts.join('');
        }

        function generatePatternAnnotations(pattern, tileLength, tileWidth) {
            // Add measurements and pattern info
            return `
                <text x="10" y="20" fill="#333" font-size="12" font-weight="bold">${pattern.name}</text>
                <text x="10" y="35" fill="#666" font-size="10">Difficulty: ${pattern.difficulty}</text>
                <text x="10" y="48" fill="#666" font-size="10">Waste: ${pattern.calculations.wastePercentage}%</text>
            `;
        }
        
        // === NEW PATTERN SVG FUNCTIONS ===
        function generateWindmillSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, tiles) {
            const svgParts = [];
            const rectColor = tiles[0] ? tiles[0].color : '#8B4513';
            const squareColor = tiles[1] ? tiles[1].color : '#D2B48C';
            
            const patternWidth = tileLength * 2 + groutWidth * 3;
            const patternHeight = tileWidth * 2 + groutWidth * 3;
            
            // Detect mobile device and limit complexity
            const isMobile = isMobileDevice();
            const maxTiles = isMobile ? 25 : 125; // Windmill uses 5 tiles per unit
            let tileCount = 0;
            
            for (let row = 0; row * patternHeight < canvasHeight + patternHeight; row++) {
                for (let col = 0; col * patternWidth < canvasWidth + patternWidth; col++) {
                    const baseX = col * patternWidth;
                    const baseY = row * patternHeight;
                    
                    if (tileCount >= maxTiles) {
                        svgParts.push(`<text x="${canvasWidth/2}" y="${canvasHeight/2}" text-anchor="middle" fill="#999" font-size="12">Pattern continues...</text>`);
                        return svgParts.join('');
                    }
                    
                    // Center square
                    svgParts.push(`<rect x="${baseX + tileLength/2}" y="${baseY + tileWidth/2}" width="${tileLength}" height="${tileWidth}" fill="${squareColor}" stroke="#C0C0C0" stroke-width="0.5" />`);
                    
                    // Four surrounding rectangles
                    svgParts.push(`<rect x="${baseX}" y="${baseY + tileWidth/2}" width="${tileLength/2}" height="${tileWidth}" fill="${rectColor}" stroke="#C0C0C0" stroke-width="0.5" />`);
                    svgParts.push(`<rect x="${baseX + tileLength*1.5}" y="${baseY + tileWidth/2}" width="${tileLength/2}" height="${tileWidth}" fill="${rectColor}" stroke="#C0C0C0" stroke-width="0.5" />`);
                    svgParts.push(`<rect x="${baseX + tileLength/2}" y="${baseY}" width="${tileLength}" height="${tileWidth/2}" fill="${rectColor}" stroke="#C0C0C0" stroke-width="0.5" />`);
                    svgParts.push(`<rect x="${baseX + tileLength/2}" y="${baseY + tileWidth*1.5}" width="${tileLength}" height="${tileWidth/2}" fill="${rectColor}" stroke="#C0C0C0" stroke-width="0.5" />`);
                    
                    tileCount += 5;
                }
            }
            return svgParts.join('');
        }
        
        function generateHopscotchSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, tiles) {
            const svgParts = [];
            const largeColor = tiles[0] ? tiles[0].color : '#8B4513';
            const smallColor = tiles[1] ? tiles[1].color : '#D2B48C';
            
            const largeSize = Math.max(tileLength, tileWidth);
            const smallSize = largeSize * 0.5;
            
            // Detect mobile device and limit complexity
            const isMobile = isMobileDevice();
            const maxTiles = isMobile ? 60 : 300;
            let tileCount = 0;
            
            for (let row = 0; row * (largeSize + groutWidth) < canvasHeight + largeSize; row++) {
                for (let col = 0; col * (largeSize + groutWidth) < canvasWidth + largeSize; col++) {
                    const x = col * (largeSize + groutWidth);
                    const y = row * (largeSize + groutWidth);
                    
                    if (tileCount >= maxTiles) {
                        svgParts.push(`<text x="${canvasWidth/2}" y="${canvasHeight/2}" text-anchor="middle" fill="#999" font-size="12">Pattern continues...</text>`);
                        return svgParts.join('');
                    }
                    
                    if ((row + col) % 2 === 0) {
                        // Large square
                        svgParts.push(`<rect x="${x}" y="${y}" width="${largeSize}" height="${largeSize}" fill="${largeColor}" stroke="#C0C0C0" stroke-width="0.5" />`);
                        tileCount++;
                    } else {
                        // Four small squares
                        svgParts.push(`<rect x="${x}" y="${y}" width="${smallSize}" height="${smallSize}" fill="${smallColor}" stroke="#C0C0C0" stroke-width="0.5" />`);
                        svgParts.push(`<rect x="${x + smallSize}" y="${y}" width="${smallSize}" height="${smallSize}" fill="${smallColor}" stroke="#C0C0C0" stroke-width="0.5" />`);
                        svgParts.push(`<rect x="${x}" y="${y + smallSize}" width="${smallSize}" height="${smallSize}" fill="${smallColor}" stroke="#C0C0C0" stroke-width="0.5" />`);
                        svgParts.push(`<rect x="${x + smallSize}" y="${y + smallSize}" width="${smallSize}" height="${smallSize}" fill="${smallColor}" stroke="#C0C0C0" stroke-width="0.5" />`);
                        tileCount += 4;
                    }
                }
            }
            return svgParts.join('');
        }
        
        function generateOffsetGridSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, color) {
            return generateRunningBondSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, color, 0.5);
        }
        
        function generateMixedSizeStraightSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, tiles) {
            let svg = '';
            const largeColor = tiles[0] ? tiles[0].color : '#8B4513';
            const smallColor = tiles[1] ? tiles[1].color : '#D2B48C';
            
            const rowHeight = tileWidth + groutWidth;
            const largeWidth = tileLength * 2;
            const smallWidth = tileLength;
            
            for (let row = 0; row * rowHeight < canvasHeight + rowHeight; row++) {
                let x = 0;
                while (x < canvasWidth + largeWidth) {
                    const y = row * rowHeight;
                    if (Math.random() > 0.5) {
                        // Large tile
                        svg += `<rect x="${x}" y="${y}" width="${largeWidth}" height="${tileWidth}" 
                                fill="${largeColor}" stroke="#C0C0C0" stroke-width="0.5" />`;
                        x += largeWidth + groutWidth;
                    } else {
                        // Small tile
                        svg += `<rect x="${x}" y="${y}" width="${smallWidth}" height="${tileWidth}" 
                                fill="${smallColor}" stroke="#C0C0C0" stroke-width="0.5" />`;
                        x += smallWidth + groutWidth;
                    }
                }
            }
            return svg;
        }
        
        // Simplified implementations for complex patterns
        function generatePinwheelSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, tiles) {
            return `<text x="200" y="125" text-anchor="middle" fill="#666" font-size="14">Pinwheel Pattern</text>
                    <text x="200" y="145" text-anchor="middle" fill="#666" font-size="12">Complex triangular layout</text>`;
        }
        
        function generateFrenchPatternSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, tiles) {
            return `<text x="200" y="125" text-anchor="middle" fill="#666" font-size="14">French Pattern</text>
                    <text x="200" y="145" text-anchor="middle" fill="#666" font-size="12">4-tile complex layout</text>`;
        }
        
        function generateModularSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, tiles) {
            return `<text x="200" y="125" text-anchor="middle" fill="#666" font-size="14">Modular Pattern</text>
                    <text x="200" y="145" text-anchor="middle" fill="#666" font-size="12">3-size modular layout</text>`;
        }
        
        function generateCobbleStoneSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, color) {
            return generateRunningBondSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, color, 0.25);
        }
        
        function generateBrickAshlarSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, tiles) {
            return generateRunningBondSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, tiles[0].color, 0.33);
        }
        
        function generateQuarterTurnSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, color) {
            return `<text x="200" y="125" text-anchor="middle" fill="#666" font-size="14">Quarter Turn Pattern</text>
                    <text x="200" y="145" text-anchor="middle" fill="#666" font-size="12">90° rotated tiles</text>`;
        }
        
        // Paver pattern functions
        function generatePaverCircularSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, color) {
            return `<text x="200" y="125" text-anchor="middle" fill="#666" font-size="14">Circular Paver Pattern</text>
                    <text x="200" y="145" text-anchor="middle" fill="#666" font-size="12">Curved wedge layout</text>`;
        }
        
        function generatePaverFanSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, color) {
            return `<text x="200" y="125" text-anchor="middle" fill="#666" font-size="14">Fan Paver Pattern</text>
                    <text x="200" y="145" text-anchor="middle" fill="#666" font-size="12">Fan-shaped wedges</text>`;
        }
        
        function generatePaverCobbleStoneSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, tiles) {
            let svg = '';
            const colors = tiles.map(t => t.color);
            
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const x = col * (tileLength * 0.8);
                    const y = row * (tileWidth * 0.8);
                    const colorIndex = Math.floor(Math.random() * colors.length);
                    const size = tileLength * (0.6 + Math.random() * 0.4);
                    
                    svg += `<rect x="${x}" y="${y}" width="${size}" height="${size * 0.8}" 
                            fill="${colors[colorIndex]}" stroke="#C0C0C0" stroke-width="0.5" />`;
                }
            }
            return svg;
        }
        
        function generatePaverRandomSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, tiles) {
            return generatePaverCobbleStoneSVG(tileLength, tileWidth, groutWidth, canvasWidth, canvasHeight, tiles);
        }

        // ===== SIMPLIFIED TILE CALCULATOR FUNCTIONS =====
        
        function toggleAdvancedOptions() {
            const options = document.getElementById('advancedOptions');
            const toggle = document.getElementById('advancedToggle');
            
            // Check both inline style and computed style
            const isHidden = options.style.display === 'none' || 
                           window.getComputedStyle(options).display === 'none';
            
            if (isHidden) {
                options.style.display = 'block';
                toggle.textContent = '▲ Hide';
            } else {
                options.style.display = 'none';
                toggle.textContent = '▼ Show';
            }
        }

        function getTileDimensions() {
            // Prefer smart input values if available
            let tileLength = 0;
            let tileWidth = 0;
            
            if (typeof currentTileLengthInches !== 'undefined' && currentTileLengthInches > 0) {
                tileLength = currentTileLengthInches;
            } else {
                // Fall back to legacy inputs
                const lengthFeet = parseFloat(document.getElementById('tileLengthFeet').value) || 0;
                const lengthInches = parseFloat(document.getElementById('tileLengthInches').value) || 0;
                const lengthFraction = parseFloat(document.getElementById('tileLengthFraction').value) || 0;
                tileLength = lengthFeet * 12 + lengthInches + lengthFraction;
            }
            
            if (typeof currentTileWidthInches !== 'undefined' && currentTileWidthInches > 0) {
                tileWidth = currentTileWidthInches;
            } else {
                // Fall back to legacy inputs
                const widthFeet = parseFloat(document.getElementById('tileWidthFeet').value) || 0;
                const widthInches = parseFloat(document.getElementById('tileWidthInches').value) || 0;
                const widthFraction = parseFloat(document.getElementById('tileWidthFraction').value) || 0;
                tileWidth = widthFeet * 12 + widthInches + widthFraction;
            }
            
            return { length: tileLength, width: tileWidth };
        }

        function getTileOffset() {
            const offsetSelect = document.getElementById('tileOffsetSelect');
            const tileDimensions = getTileDimensions();
            
            if (offsetSelect.value === 'custom') {
                // Use smart input value if available
                if (typeof currentTileOffsetInches !== 'undefined' && currentTileOffsetInches > 0) {
                    return currentTileOffsetInches;
                }
                // Fall back to legacy inputs
                const offsetFeet = parseFloat(document.getElementById('tileOffsetFeet').value) || 0;
                const offsetInches = parseFloat(document.getElementById('tileOffsetInches').value) || 0;
                const offsetFraction = parseFloat(document.getElementById('tileOffsetFraction').value) || 0;
                return offsetFeet * 12 + offsetInches + offsetFraction;
            } else {
                // Use dropdown value as fraction of tile length
                const offsetFraction = parseFloat(offsetSelect.value) || 0;
                return tileDimensions.length * offsetFraction;
            }
        }

        function updateTileOffset() {
            const offsetSelect = document.getElementById('tileOffsetSelect');
            const customRow = document.getElementById('customOffsetRow');
            
            if (offsetSelect.value === 'custom') {
                customRow.style.display = 'block';
            } else {
                customRow.style.display = 'none';
            }
            
            // Auto-recalculate when offset changes
            calculateSimpleTiles();
        }
        
        function toggleCustomGrout() {
            const groutSelect = document.getElementById('groutSpacing');
            const customRow = document.getElementById('customGroutRow');
            
            if (groutSelect.value === 'custom') {
                customRow.style.display = 'block';
            } else {
                customRow.style.display = 'none';
            }
        }

        function clearTileCalculator() {
            // Clear smart inputs
            document.getElementById('smartTileLength').value = '';
            document.getElementById('smartTileWidth').value = '';
            document.getElementById('previewTileLength').textContent = '';
            document.getElementById('previewTileWidth').textContent = '';
            
            // Clear tile dimensions (legacy)
            document.getElementById('tileLengthFeet').value = '';
            document.getElementById('tileLengthInches').value = '';
            document.getElementById('tileLengthFraction').value = '0';
            document.getElementById('tileWidthFeet').value = '';
            document.getElementById('tileWidthInches').value = '';
            document.getElementById('tileWidthFraction').value = '0';
            
            // Clear project area
            document.getElementById('projectSqFt').value = '';
            document.getElementById('wasteFactor').value = '10';
            document.getElementById('wasteDisplay').textContent = '10%';
            
            // Reset options
            document.getElementById('groutSpacing').value = '0.125';
            document.getElementById('customGrout').value = '';
            document.getElementById('customGroutRow').style.display = 'none';
            document.getElementById('tileOffsetSelect').value = '0';
            document.getElementById('smartTileOffset').value = '';
            document.getElementById('previewTileOffset').textContent = '';
            document.getElementById('customOffsetRow').style.display = 'none';
            
            // Clear cost fields
            document.getElementById('tileCostMethod').value = 'per-sqft';
            document.getElementById('costPerTile').value = '';
            document.getElementById('costPerSqFt').value = '';
            document.getElementById('costPerBox').value = '';
            document.getElementById('tilesPerBox').value = '';
            document.getElementById('sqFtPerBox').value = '';
            document.getElementById('additionalCosts').value = '';
            // Reset visibility
            document.getElementById('perTileRow').style.display = 'none';
            document.getElementById('perSqFtRow').style.display = 'block';
            document.getElementById('perBoxRow').style.display = 'none';
            document.getElementById('tilesPerBoxRow').style.display = 'none';
            document.getElementById('sqFtPerBoxRow').style.display = 'none';
            
            // Clear advanced options
            document.getElementById('tileThickness').value = '0.25';
            document.getElementById('roomPerimeter').value = '';
            
            // Clear results
            document.getElementById('tileResults').innerHTML = 'Enter tile dimensions and project area to calculate';
            document.getElementById('tilePreview').innerHTML = '';
            
            // Clear smart input state
            if (typeof currentTileLengthInches !== 'undefined') currentTileLengthInches = 0;
            if (typeof currentTileWidthInches !== 'undefined') currentTileWidthInches = 0;
            if (typeof currentTileOffsetInches !== 'undefined') currentTileOffsetInches = 0;
            
            // Clear offset error
            document.getElementById('offsetError').style.display = 'none';
        }

        function validateOffset() {
            const dimensions = getTileDimensions();
            const offset = getTileOffset();
            const errorElement = document.getElementById('offsetError');
            
            if (offset > dimensions.length) {
                errorElement.style.display = 'block';
                return false;
            } else {
                errorElement.style.display = 'none';
                return true;
            }
        }

        function calculateSimpleTiles() {
            // Validate offset first
            if (!validateOffset()) {
                document.getElementById('tileResults').innerHTML = '<p style="color: #dc3545;">Please fix the offset error above.</p>';
                return;
            }

            // Handle custom grout spacing
            const groutSelect = document.getElementById('groutSpacing');
            let groutSpacing = 0;
            if (groutSelect.value === 'custom') {
                document.getElementById('customGroutRow').style.display = 'block';
                groutSpacing = parseFloat(document.getElementById('customGrout').value) || 0;
            } else {
                document.getElementById('customGroutRow').style.display = 'none';
                groutSpacing = parseFloat(groutSelect.value) || 0;
            }

            // Get inputs
            const dimensions = getTileDimensions();
            const offset = getTileOffset();
            const projectSqFt = parseFloat(document.getElementById('projectSqFt').value) || 0;
            const wasteFactor = parseInt(document.getElementById('wasteFactor').value) || 10;
            const tileThickness = parseFloat(document.getElementById('tileThickness').value) || 0.25;
            const roomPerimeter = parseFloat(document.getElementById('roomPerimeter').value) || 0;

            // Check if we have valid dimensions
            if (dimensions.length <= 0 || dimensions.width <= 0) {
                document.getElementById('tileResults').innerHTML = '<p style="color: #007bff;">Enter valid tile dimensions to see calculations.</p>';
                return;
            }

            if (projectSqFt <= 0) {
                document.getElementById('tileResults').innerHTML = '<p>Enter project square footage to see results.</p>';
                return;
            }

            // Calculate tile quantities
            const effectiveLength = dimensions.length + groutSpacing;
            const effectiveWidth = dimensions.width + groutSpacing;
            const tileSqFt = (effectiveLength * effectiveWidth) / 144;
            
            const tilesNeeded = Math.ceil(projectSqFt / tileSqFt);
            const tilesWithWaste = Math.ceil(tilesNeeded * (1 + wasteFactor / 100));

            // Calculate costs
            const costMethod = document.getElementById('tileCostMethod').value;
            let tileCost = 0;
            let boxesNeeded = 0;
            let costDetails = {};

            if (costMethod === 'per-tile') {
                const costPerTile = parseFloat(document.getElementById('costPerTile').value) || 0;
                tileCost = tilesWithWaste * costPerTile;
                costDetails = { method: 'per-tile', rate: costPerTile };
            } else if (costMethod === 'per-sqft') {
                const costPerSqFt = parseFloat(document.getElementById('costPerSqFt').value) || 0;
                tileCost = projectSqFt * (1 + wasteFactor / 100) * costPerSqFt;
                costDetails = { method: 'per-sqft', rate: costPerSqFt };
            } else if (costMethod === 'per-box') {
                const costPerBox = parseFloat(document.getElementById('costPerBox').value) || 0;
                const tilesPerBox = parseInt(document.getElementById('tilesPerBox').value) || 1;
                boxesNeeded = Math.ceil(tilesWithWaste / tilesPerBox);
                tileCost = boxesNeeded * costPerBox;
                costDetails = { method: 'per-box', rate: costPerBox, tilesPerBox: tilesPerBox };
            }

            // Calculate grout needed
            const groutInfo = calculateGroutNeeded(projectSqFt, dimensions, groutSpacing, tileThickness);
            
            // Estimate cuts
            const cutEstimate = estimateCuts(projectSqFt, dimensions, offset, roomPerimeter);

            // Additional costs
            const additionalCosts = parseFloat(document.getElementById('additionalCosts').value) || 0;
            const totalCost = tileCost + additionalCosts;

            // Display results
            displaySimpleTileResults({
                projectSqFt,
                tileLength: dimensions.length,
                tileWidth: dimensions.width,
                groutSpacing,
                offset,
                tileSqFt,
                tilesNeeded,
                tilesWithWaste,
                wasteFactor,
                boxesNeeded,
                tileCost,
                additionalCosts,
                totalCost,
                costDetails,
                groutInfo,
                cutEstimate
            });

            // Update preview
            updateTilePreview(dimensions, groutSpacing, offset);
        }

        function calculateGroutNeeded(projectSqFt, dimensions, groutSpacing, tileThickness) {
            if (groutSpacing <= 0) {
                return { weight: 0, bags: 0, type: 'none' };
            }

            // Auto-detect grout type
            const groutType = groutSpacing <= 0.125 ? 'unsanded' : 'sanded';
            const groutDensity = groutType === 'unsanded' ? 0.11 : 0.13; // lb/in³

            // Convert everything to inches for consistent units
            const tileArea = projectSqFt * 144; // sq inches
            const tileLengthInches = dimensions.length;
            const tileWidthInches = dimensions.width;
            
            // Calculate grout line length per tile (between tiles)
            const groutLinePerTile = (tileLengthInches + tileWidthInches) / (tileLengthInches * tileWidthInches);
            
            // Calculate grout volume between tiles
            const groutVolumeBetweenTiles = tileArea * groutLinePerTile * groutSpacing * tileThickness;
            
            // Calculate perimeter grout (always needed along walls)
            const roomPerimeter = parseFloat(document.getElementById('roomPerimeter').value) || 0;
            let perimeterToUse = roomPerimeter;
            
            // If no perimeter provided, calculate for square room
            if (perimeterToUse <= 0) {
                perimeterToUse = 4 * Math.sqrt(projectSqFt);
            }
            
            // Convert perimeter to inches and calculate volume
            const perimeterInches = perimeterToUse * 12;
            const groutVolumePerimeter = perimeterInches * groutSpacing * tileThickness;
            
            // Total grout volume
            const totalGroutVolume = groutVolumeBetweenTiles + groutVolumePerimeter;
            
            // Convert to pounds
            const groutWeight = totalGroutVolume * groutDensity;
            
            // Calculate bags needed (25 lb bags standard)
            const groutBags = Math.ceil(groutWeight / 25);

            return {
                weight: groutWeight,
                bags: groutBags,
                type: groutType
            };
        }

        function validatePerimeter(projectSqFt, roomPerimeter) {
            if (roomPerimeter <= 0) return { valid: true };
            
            // Calculate minimum possible perimeter for given area (circle)
            const minPerimeter = 2 * Math.sqrt(Math.PI * projectSqFt);
            
            // Calculate maximum reasonable perimeter (very long narrow rectangle, 1:100 ratio)
            const maxPerimeter = 2 * (Math.sqrt(projectSqFt * 100) + Math.sqrt(projectSqFt / 100));
            
            if (roomPerimeter < minPerimeter) {
                return { 
                    valid: false, 
                    error: `Perimeter too small. Minimum possible: ${minPerimeter.toFixed(1)} ft (circular room)`,
                    suggestion: minPerimeter
                };
            }
            
            if (roomPerimeter > maxPerimeter) {
                return { 
                    valid: false, 
                    error: `Perimeter unusually large. Maximum reasonable: ${maxPerimeter.toFixed(1)} ft`,
                    suggestion: maxPerimeter
                };
            }
            
            // Warn if perimeter seems unusual (less than square room)
            const squarePerimeter = 4 * Math.sqrt(projectSqFt);
            if (roomPerimeter < squarePerimeter * 0.9) {
                return {
                    valid: true,
                    warning: `Perimeter seems small. Square room would be ${squarePerimeter.toFixed(1)} ft`
                };
            }
            
            return { valid: true };
        }

        function estimateCuts(projectSqFt, dimensions, offset, roomPerimeter) {
            let borderTiles = 0;
            let calculationMethod = 'estimated';
            let validationResult = { valid: true };
            
            if (roomPerimeter > 0) {
                // Validate perimeter makes sense for the area
                validationResult = validatePerimeter(projectSqFt, roomPerimeter);
                
                if (validationResult.valid) {
                    // Use actual perimeter for more accurate calculation
                    const tileLength = dimensions.length / 12; // Convert to feet
                    const tilesAlongPerimeter = Math.ceil(roomPerimeter / tileLength);
                    borderTiles = tilesAlongPerimeter;
                    calculationMethod = 'perimeter-based';
                } else {
                    // Fall back to square room if invalid perimeter
                    const roomSide = Math.sqrt(projectSqFt);
                    const tilesPerSide = Math.ceil(roomSide / (dimensions.length / 12));
                    borderTiles = Math.max(tilesPerSide * 4 - 4, 0);
                    calculationMethod = 'invalid-perimeter-fallback';
                }
            } else {
                // Fall back to square room assumption
                const roomSide = Math.sqrt(projectSqFt);
                const tilesPerSide = Math.ceil(roomSide / (dimensions.length / 12)); // Convert to feet
                borderTiles = Math.max(tilesPerSide * 4 - 4, 0); // Subtract corners
                calculationMethod = 'square-room-estimated';
            }
            
            // Offset creates additional cuts (every other row needs cutting)
            const offsetCuts = offset > 0 ? Math.ceil(borderTiles * 0.3) : 0;
            
            // Field cuts (interior cuts due to layout constraints)
            const fieldCuts = Math.ceil(projectSqFt / 100); // Rough estimate: 1 cut per 100 sq ft
            
            const perimeter = roomPerimeter > 0 ? roomPerimeter : Math.sqrt(projectSqFt) * 4;
            
            return {
                borderCuts: borderTiles,
                offsetCuts: offsetCuts,
                fieldCuts: fieldCuts,
                totalCuts: borderTiles + offsetCuts + fieldCuts,
                perimeter: perimeter,
                calculationMethod: calculationMethod,
                validation: validationResult
            };
        }

        function displaySimpleTileResults(data) {
            const container = document.getElementById('tileResults');
            
            let html = `
                <h4>Tile Requirements & Costs</h4>
                
                <div class="tile-result-summary">
                    <div class="result-row">
                        <span class="result-label">Project Area:</span>
                        <span class="result-value">${data.projectSqFt} sq ft</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">Tile Size:</span>
                        <span class="result-value">${(data.tileLength/12).toFixed(2)}" × ${(data.tileWidth/12).toFixed(2)}" (${data.tileLength.toFixed(1)}" × ${data.tileWidth.toFixed(1)}")</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">Grout Spacing:</span>
                        <span class="result-value">${data.groutSpacing > 0 ? (data.groutSpacing * 16).toFixed(0) + '/16"' : 'None'}</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">Offset:</span>
                        <span class="result-value">${data.offset > 0 ? data.offset.toFixed(1) + '"' : 'None'}</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">Area per Tile:</span>
                        <span class="result-value">${data.tileSqFt.toFixed(3)} sq ft</span>
                    </div>
                </div>
                
                <div class="tile-quantity-section">
                    <h5>Quantities</h5>
                    <div class="result-row">
                        <span class="result-label">Tiles Needed (exact):</span>
                        <span class="result-value">${data.tilesNeeded}</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">With Waste (+${data.wasteFactor}%):</span>
                        <span class="result-value">${data.tilesWithWaste}</span>
                    </div>`;
            
            if (data.boxesNeeded > 0) {
                html += `
                    <div class="result-row">
                        <span class="result-label">Boxes Needed:</span>
                        <span class="result-value">${data.boxesNeeded} (${data.costDetails.tilesPerBox} tiles/box)</span>
                    </div>`;
            }

            if (data.cutEstimate.totalCuts > 0) {
                html += `
                    <div class="result-row">
                        <span class="result-label">Estimated Cuts:</span>
                        <span class="result-value">${data.cutEstimate.totalCuts} tiles</span>
                    </div>`;
                
                // Show breakdown and validation info
                if (data.cutEstimate.calculationMethod === 'perimeter-based') {
                    html += `
                        <div class="result-row" style="font-size: 12px; color: #666; margin-left: 10px;">
                            <span class="result-label">└ Border: ${data.cutEstimate.borderCuts}, Offset: ${data.cutEstimate.offsetCuts}, Field: ${data.cutEstimate.fieldCuts}</span>
                            <span class="result-value">Perimeter-based</span>
                        </div>`;
                } else if (data.cutEstimate.calculationMethod === 'invalid-perimeter-fallback') {
                    html += `
                        <div class="result-row" style="font-size: 12px; color: #dc3545; margin-left: 10px;">
                            <span class="result-label">└ Border: ${data.cutEstimate.borderCuts}, Offset: ${data.cutEstimate.offsetCuts}, Field: ${data.cutEstimate.fieldCuts}</span>
                            <span class="result-value">Invalid perimeter - using estimate</span>
                        </div>`;
                } else {
                    html += `
                        <div class="result-row" style="font-size: 12px; color: #666; margin-left: 10px;">
                            <span class="result-label">└ Border: ${data.cutEstimate.borderCuts}, Offset: ${data.cutEstimate.offsetCuts}, Field: ${data.cutEstimate.fieldCuts}</span>
                            <span class="result-value">Square room est.</span>
                        </div>`;
                }
                
                // Show validation errors or warnings
                if (data.cutEstimate.validation && !data.cutEstimate.validation.valid) {
                    html += `
                        <div class="result-row" style="font-size: 12px; color: #dc3545; margin-left: 10px; font-style: italic;">
                            <span class="result-label">⚠️ ${data.cutEstimate.validation.error}</span>
                            <span class="result-value"></span>
                        </div>`;
                } else if (data.cutEstimate.validation && data.cutEstimate.validation.warning) {
                    html += `
                        <div class="result-row" style="font-size: 12px; color: #f57c00; margin-left: 10px; font-style: italic;">
                            <span class="result-label">💡 ${data.cutEstimate.validation.warning}</span>
                            <span class="result-value"></span>
                        </div>`;
                }
            }
            
            html += `</div>`;

            // Materials section
            html += `
                <div class="tile-cost-section">
                    <h5>Materials & Costs</h5>`;
            
            if (data.costDetails.method === 'per-tile') {
                html += `
                    <div class="result-row">
                        <span class="result-label">Cost per Tile:</span>
                        <span class="result-value">$${data.costDetails.rate.toFixed(2)}</span>
                    </div>`;
            } else if (data.costDetails.method === 'per-sqft') {
                html += `
                    <div class="result-row">
                        <span class="result-label">Cost per Sq Ft:</span>
                        <span class="result-value">$${data.costDetails.rate.toFixed(2)}</span>
                    </div>`;
            } else if (data.costDetails.method === 'per-box') {
                html += `
                    <div class="result-row">
                        <span class="result-label">Cost per Box:</span>
                        <span class="result-value">$${data.costDetails.rate.toFixed(2)}</span>
                    </div>`;
            }
            
            html += `
                    <div class="result-row">
                        <span class="result-label">Tile Cost:</span>
                        <span class="result-value">$${data.tileCost.toFixed(2)}</span>
                    </div>`;

            // Grout information
            if (data.groutInfo.weight > 0) {
                html += `
                    <div class="result-row">
                        <span class="result-label">Grout Needed:</span>
                        <span class="result-value">${data.groutInfo.weight.toFixed(1)} lbs (${data.groutInfo.type})</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">Grout Bags:</span>
                        <span class="result-value">${data.groutInfo.bags} bags (25 lb)</span>
                    </div>`;
            }
            
            if (data.additionalCosts > 0) {
                html += `
                    <div class="result-row">
                        <span class="result-label">Additional Costs:</span>
                        <span class="result-value">$${data.additionalCosts.toFixed(2)}</span>
                    </div>`;
            }
            
            html += `
                    <div class="result-row total-cost">
                        <span class="result-label"><strong>Total Cost:</strong></span>
                        <span class="result-value"><strong>$${data.totalCost.toFixed(2)}</strong></span>
                    </div>
                </div>`;
            
            container.innerHTML = html;
        }

        function updateTilePreview(dimensions, groutSpacing, offset) {
            const container = document.getElementById('tilePreview');
            const previewSize = 300;
            const gridSize = 8;
            
            // Calculate tile size for preview (proportional)
            const maxDimension = Math.max(dimensions.length, dimensions.width);
            const scale = (previewSize / gridSize) / maxDimension;
            
            const previewLength = dimensions.length * scale;
            const previewWidth = dimensions.width * scale;
            const previewGrout = groutSpacing * scale;
            const previewOffset = offset * scale;
            
            let svg = `<svg width="${previewSize}" height="${previewSize}" viewBox="0 0 ${previewSize} ${previewSize}">`;
            
            // Draw tiles in grid
            for (let row = 0; row < gridSize; row++) {
                for (let col = 0; col < gridSize; col++) {
                    let x = col * (previewLength + previewGrout);
                    let y = row * (previewWidth + previewGrout);
                    
                    // Apply offset for alternating rows
                    if (offset > 0 && row % 2 === 1) {
                        x += previewOffset;
                    }
                    
                    // Only draw if tile fits in preview
                    if (x + previewLength <= previewSize && y + previewWidth <= previewSize) {
                        svg += `<rect x="${x}" y="${y}" width="${previewLength}" height="${previewWidth}" 
                                fill="#8B4513" stroke="#C0C0C0" stroke-width="1" opacity="0.8" />`;
                    }
                }
            }
            
            // Add dimensions label
            svg += `<text x="10" y="20" fill="#333" font-size="12" font-weight="bold">
                    ${dimensions.length.toFixed(1)}" × ${dimensions.width.toFixed(1)}"</text>`;
            
            if (groutSpacing > 0) {
                svg += `<text x="10" y="35" fill="#666" font-size="10">
                        Grout: ${(groutSpacing * 16).toFixed(0)}/16"</text>`;
            }
            
            if (offset > 0) {
                svg += `<text x="10" y="50" fill="#666" font-size="10">
                        Offset: ${offset.toFixed(1)}"</text>`;
            }
            
            svg += '</svg>';
            container.innerHTML = svg;
        }

        function saveSimpleTileProject() {
            const dimensions = getTileDimensions();
            const offset = getTileOffset();
            const projectSqFt = parseFloat(document.getElementById('projectSqFt').value) || 0;
            const groutSpacing = parseFloat(document.getElementById('groutSpacing').value === 'custom' ? 
                document.getElementById('customGrout').value : document.getElementById('groutSpacing').value) || 0;
            const wasteFactor = parseInt(document.getElementById('wasteFactor').value) || 10;
            const tileThickness = parseFloat(document.getElementById('tileThickness').value) || 0.25;
            const roomPerimeter = parseFloat(document.getElementById('roomPerimeter').value) || 0;
            
            if (projectSqFt <= 0 || dimensions.length <= 0 || dimensions.width <= 0) {
                alert('Please enter tile dimensions and project area before saving.');
                return;
            }

            // Perform all calculations
            const tileSqFt = (dimensions.length * dimensions.width) / 144;
            const tilesNeeded = Math.ceil(projectSqFt / tileSqFt);
            const tilesWithWaste = Math.ceil(tilesNeeded * (1 + wasteFactor / 100));
            
            // Get cost info
            const costPerTile = parseFloat(document.getElementById('costPerTile').value) || 0;
            const costPerBox = parseFloat(document.getElementById('costPerBox').value) || 0;
            const tilesPerBox = parseInt(document.getElementById('tilesPerBox').value) || 0;
            const costPerSqFt = parseFloat(document.getElementById('costPerSqFt').value) || 0;
            const additionalCosts = parseFloat(document.getElementById('additionalCosts').value) || 0;
            
            // Calculate costs
            let costDetails = {};
            let totalTileCost = 0;
            if (document.getElementById('perTileRow').style.display !== 'none' && costPerTile > 0) {
                totalTileCost = tilesWithWaste * costPerTile;
                costDetails = { method: 'per-tile', rate: costPerTile };
            } else if (document.getElementById('perSqFtRow').style.display !== 'none' && costPerSqFt > 0) {
                totalTileCost = projectSqFt * costPerSqFt * (1 + wasteFactor / 100);
                costDetails = { method: 'per-sqft', rate: costPerSqFt };
            } else if (document.getElementById('perBoxRow').style.display !== 'none' && costPerBox > 0 && tilesPerBox > 0) {
                const boxesNeeded = Math.ceil(tilesWithWaste / tilesPerBox);
                totalTileCost = boxesNeeded * costPerBox;
                costDetails = { method: 'per-box', rate: costPerBox, tilesPerBox: tilesPerBox, boxes: boxesNeeded };
            }
            
            // Calculate grout
            const groutInfo = calculateGroutNeeded(projectSqFt, dimensions, groutSpacing, tileThickness);
            
            // Calculate cuts
            const cutEstimate = estimateCuts(projectSqFt, dimensions, offset, roomPerimeter);
            
            // Build comprehensive details
            const groutDisplay = groutSpacing > 0 ? `${(groutSpacing * 16).toFixed(0)}/16"` : 'None';
            const offsetDisplay = offset > 0 ? `${offset.toFixed(1)}"` : 'None';
            
            const equation = `${projectSqFt} sq ft with ${dimensions.length}" × ${dimensions.width}" tiles`;
            const result = `${tilesWithWaste} tiles needed (includes ${wasteFactor}% waste)`;
            
            let details = `PROJECT SUMMARY
================
Area: ${projectSqFt} sq ft
${roomPerimeter > 0 ? `Perimeter: ${roomPerimeter} linear ft` : 'Perimeter: Not specified (assumed square room)'}

TILE SPECIFICATIONS
==================
Size: ${dimensions.length}" × ${dimensions.width}" (${tileSqFt.toFixed(2)} sq ft per tile)
Grout Spacing: ${groutDisplay}
Offset: ${offsetDisplay}
Tile Thickness: ${tileThickness}"

MATERIAL CALCULATIONS
====================
Base Tiles Needed: ${tilesNeeded} tiles
Waste Factor: ${wasteFactor}%
Total Tiles Needed: ${tilesWithWaste} tiles`;

            if (costDetails.method === 'per-box' && costDetails.boxes) {
                details += `\nBoxes Needed: ${costDetails.boxes} boxes (${costDetails.tilesPerBox} tiles/box)`;
            }

            details += `\n\nGROUT REQUIREMENTS
==================
Type: ${groutInfo.type === 'none' ? 'No grout needed' : groutInfo.type.charAt(0).toUpperCase() + groutInfo.type.slice(1) + ' grout'}`;
            
            if (groutInfo.weight > 0) {
                details += `\nAmount Needed: ${groutInfo.weight.toFixed(1)} lbs
Bags Needed: ${groutInfo.bags} bags (25 lb bags)`;
            }

            details += `\n\nCUT ESTIMATION
==============
Total Cuts: ${cutEstimate.totalCuts}
- Border Cuts: ${cutEstimate.borderCuts}
- Field Cuts: ${cutEstimate.fieldCuts}
- Offset Cuts: ${cutEstimate.offsetCuts}
${cutEstimate.note ? `Note: ${cutEstimate.note}` : ''}`;

            if (totalTileCost > 0 || additionalCosts > 0) {
                details += `\n\nCOST BREAKDOWN
==============`;
                if (totalTileCost > 0) {
                    if (costDetails.method === 'per-tile') {
                        details += `\nTile Cost: $${totalTileCost.toFixed(2)} (${tilesWithWaste} tiles × $${costDetails.rate.toFixed(2)}/tile)`;
                    } else if (costDetails.method === 'per-sqft') {
                        details += `\nTile Cost: $${totalTileCost.toFixed(2)} (${projectSqFt} sq ft × $${costDetails.rate.toFixed(2)}/sq ft × ${(1 + wasteFactor/100).toFixed(2)})`;
                    } else if (costDetails.method === 'per-box') {
                        details += `\nTile Cost: $${totalTileCost.toFixed(2)} (${costDetails.boxes} boxes × $${costDetails.rate.toFixed(2)}/box)`;
                    }
                }
                if (additionalCosts > 0) {
                    details += `\nAdditional Costs: $${additionalCosts.toFixed(2)}`;
                }
                details += `\nTotal Project Cost: $${(totalTileCost + additionalCosts).toFixed(2)}`;
            }

            const saveData = {
                tool: 'Tile Calculator',
                equation: equation,
                result: result,
                details: details,
                timestamp: new Date().toISOString(),
                diagramContainerId: 'tilePreview'
            };

            showSaveToProjectModal(saveData);
        }
        
        // Updated cost-enabled tile calculation function
        function calculateTilesWithCost() {
            // Handle custom grout spacing
            const groutSelect = document.getElementById('groutSpacing');
            if (groutSelect.value === 'custom') {
                document.getElementById('customGroutRow').style.display = 'block';
                currentTileData.groutSpacing = parseFloat(document.getElementById('customGrout').value) || 0;
            } else {
                document.getElementById('customGroutRow').style.display = 'none';
                currentTileData.groutSpacing = parseFloat(groutSelect.value) || 0;
            }
            
            // Get basic inputs
            const projectSqFt = parseFloat(document.getElementById('projectSqFt').value) || 0;
            const wasteFactor = parseInt(document.getElementById('wasteFactor').value) || 10;
            
            if (projectSqFt <= 0) {
                document.getElementById('tileResults').innerHTML = '<p>Enter project square footage to see results.</p>';
                return;
            }
            
            // Get tile dimensions from dynamic inputs
            const tileInputs = document.getElementById('tileInputs');
            const lengthInput = tileInputs.querySelector('[data-field="length"]');
            const widthInput = tileInputs.querySelector('[data-field="width"]');
            
            if (!lengthInput || !widthInput) {
                document.getElementById('tileResults').innerHTML = '<p>Configure tile dimensions to see calculations.</p>';
                return;
            }
            
            const tileLength = parseFloat(lengthInput.value) || 0;
            const tileWidth = parseFloat(widthInput.value) || 0;
            
            if (tileLength <= 0 || tileWidth <= 0) {
                document.getElementById('tileResults').innerHTML = '<p>Enter valid tile dimensions to see calculations.</p>';
                return;
            }
            
            // Calculate tile area including grout
            const effectiveLength = tileLength + currentTileData.groutSpacing;
            const effectiveWidth = tileWidth + currentTileData.groutSpacing;
            const sqFtPerTile = (effectiveLength * effectiveWidth) / 144;
            
            // Calculate quantities
            const pattern = patternDatabase[currentTileData.selectedPattern];
            const patternWaste = pattern ? pattern.calculations.wastePercentage : 10;
            const totalWaste = Math.max(wasteFactor, patternWaste);
            
            const tilesNeeded = Math.ceil(projectSqFt / sqFtPerTile);
            const tilesWithWaste = Math.ceil(tilesNeeded * (1 + totalWaste / 100));
            
            // Calculate costs
            const costMethod = document.getElementById('tileCostMethod').value;
            let tileCost = 0;
            let boxesNeeded = 0;
            let costPerTile = 0;
            let costPerSqFt = 0;
            let costPerBox = 0;
            let tilesPerBox = 1;
            
            if (costMethod === 'per-tile') {
                costPerTile = parseFloat(document.getElementById('costPerTile').value) || 0;
                tileCost = tilesWithWaste * costPerTile;
            } else if (costMethod === 'per-sqft') {
                costPerSqFt = parseFloat(document.getElementById('costPerSqFt').value) || 0;
                tileCost = projectSqFt * (1 + totalWaste / 100) * costPerSqFt;
            } else if (costMethod === 'per-box') {
                costPerBox = parseFloat(document.getElementById('costPerBox').value) || 0;
                tilesPerBox = parseInt(document.getElementById('tilesPerBox').value) || 1;
                boxesNeeded = Math.ceil(tilesWithWaste / tilesPerBox);
                tileCost = boxesNeeded * costPerBox;
            }
            
            const additionalCosts = parseFloat(document.getElementById('additionalCosts').value) || 0;
            const totalCost = tileCost + additionalCosts;
            
            displayTileResultsWithCost({
                projectSqFt,
                tileLength,
                tileWidth,
                sqFtPerTile,
                tilesNeeded,
                tilesWithWaste,
                totalWaste,
                boxesNeeded,
                tileCost,
                additionalCosts,
                totalCost,
                costMethod,
                costPerTile,
                costPerSqFt,
                costPerBox,
                tilesPerBox,
                pattern: pattern ? pattern.name : 'Unknown'
            });
        }
        
        function displayTileResultsWithCost(data) {
            const container = document.getElementById('tileResults');
            
            let html = `
                <h4>Tile Requirements & Costs</h4>
                <div class="tile-result-summary">
                    <div class="result-row">
                        <span class="result-label">Project Area:</span>
                        <span class="result-value">${data.projectSqFt} sq ft</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">Tile Size:</span>
                        <span class="result-value">${data.tileLength}" × ${data.tileWidth}"</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">Pattern:</span>
                        <span class="result-value">${data.pattern}</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">Area per Tile:</span>
                        <span class="result-value">${data.sqFtPerTile.toFixed(3)} sq ft</span>
                    </div>
                </div>
                
                <div class="tile-quantity-section">
                    <h5>Quantities</h5>
                    <div class="result-row">
                        <span class="result-label">Tiles Needed (exact):</span>
                        <span class="result-value">${data.tilesNeeded}</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">With Waste (+${data.totalWaste}%):</span>
                        <span class="result-value">${data.tilesWithWaste}</span>
                    </div>`;
            
            if (data.boxesNeeded > 0) {
                html += `
                    <div class="result-row">
                        <span class="result-label">Boxes Needed:</span>
                        <span class="result-value">${data.boxesNeeded} (${data.tilesPerBox} tiles/box)</span>
                    </div>`;
            }
            
            html += `</div>
                
                <div class="tile-cost-section">
                    <h5>Cost Breakdown</h5>`;
            
            if (data.costMethod === 'per-tile') {
                html += `
                    <div class="result-row">
                        <span class="result-label">Cost per Tile:</span>
                        <span class="result-value">$${data.costPerTile.toFixed(2)}</span>
                    </div>`;
            } else if (data.costMethod === 'per-sqft') {
                html += `
                    <div class="result-row">
                        <span class="result-label">Cost per Sq Ft:</span>
                        <span class="result-value">$${data.costPerSqFt.toFixed(2)}</span>
                    </div>`;
            } else if (data.costMethod === 'per-box') {
                html += `
                    <div class="result-row">
                        <span class="result-label">Cost per Box:</span>
                        <span class="result-value">$${data.costPerBox.toFixed(2)}</span>
                    </div>`;
            }
            
            html += `
                    <div class="result-row">
                        <span class="result-label">Tile Cost:</span>
                        <span class="result-value">$${data.tileCost.toFixed(2)}</span>
                    </div>`;
            
            if (data.additionalCosts > 0) {
                html += `
                    <div class="result-row">
                        <span class="result-label">Additional Costs:</span>
                        <span class="result-value">$${data.additionalCosts.toFixed(2)}</span>
                    </div>`;
            }
            
            html += `
                    <div class="result-row total-cost">
                        <span class="result-label"><strong>Total Cost:</strong></span>
                        <span class="result-value"><strong>$${data.totalCost.toFixed(2)}</strong></span>
                    </div>
                </div>`;
            
            container.innerHTML = html;
        }

        // Global function for tile hover info (called from SVG)
        window.showTileInfo = function(element, info) {
            element.setAttribute('title', info);
        };

        function updateTileCalculations() {
            // Update waste factor display
            updateWasteDisplay();
            
            // Trigger pattern preview update
            updateSelectedPatternDisplay();
            
            // Calculate tiles if we have enough information
            calculateTiles();
        }

        function generateTileInputs(pattern) {
            const container = document.getElementById('tileInputs');
            const patternData = tilePatterns[pattern];
            
            let html = `<div class="tile-pattern-info">${patternData.description}</div>`;
            
            patternData.tiles.forEach((tile, index) => {
                html += `
                    <div class="tile-input-group">
                        <h4>${tile.name}</h4>
                        <div class="tile-input-row">
                            <div class="tile-input-field">
                                <label>Length (inches)</label>
                                <input type="number" id="tile${index}Length" step="0.125" min="0.125" placeholder="12" oninput="calculateTiles()">
                            </div>
                            <div class="tile-input-field">
                                <label>Width (inches)</label>
                                <input type="number" id="tile${index}Width" step="0.125" min="0.125" placeholder="6" oninput="calculateTiles()">
                            </div>
                            <div class="tile-input-field">
                                <label>Tiles per Box</label>
                                <input type="number" id="tile${index}PerBox" min="1" placeholder="10" oninput="calculateTiles()">
                            </div>
                        </div>
                        <div class="tile-input-row">
                            <div class="tile-input-field">
                                <label>Cost per Box ($)</label>
                                <input type="number" id="tile${index}Cost" step="0.01" min="0" placeholder="29.99" oninput="calculateTiles()">
                            </div>
                            <div class="tile-input-field">
                                <label>Pattern Ratio</label>
                                <input type="number" id="tile${index}Ratio" value="${tile.ratio}" min="1" readonly style="background: #f5f5f5;">
                            </div>
                            <div class="tile-input-field">
                                <label>Sq Ft per Tile</label>
                                <input type="text" id="tile${index}SqFt" readonly placeholder="0.50" style="background: #f5f5f5;">
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function generatePatternPreview(pattern) {
            const container = document.getElementById('patternPreview');
            const patternData = tilePatterns[pattern];
            
            // Create SVG pattern visualization
            let svg = `
                <svg width="300" height="200" viewBox="0 0 300 200">
                    <defs>
                        <pattern id="grout" patternUnits="userSpaceOnUse" width="2" height="2">
                            <rect width="2" height="2" fill="#C0C0C0"/>
                        </pattern>
                    </defs>
            `;
            
            // Generate pattern based on type
            switch(pattern) {
                case 'running-bond':
                    svg += generateRunningBondSVG();
                    break;
                case 'subway':
                    svg += generateSubwaySVG();
                    break;
                case 'herringbone':
                    svg += generateHerringboneSVG();
                    break;
                case 'basketweave':
                    svg += generateBasketweaveSVG();
                    break;
                case 'custom':
                    svg += generateCustomSVG();
                    break;
            }
            
            svg += '</svg>';
            container.innerHTML = svg;
        }





        function generateCustomSVG() {
            return `<text x="150" y="100" text-anchor="middle" fill="#666" font-size="14">Custom Pattern Preview</text>
                    <text x="150" y="120" text-anchor="middle" fill="#666" font-size="12">Configure your tiles to see preview</text>`;
        }

        function updateWasteDisplay() {
            const wasteFactor = document.getElementById('wasteFactor').value;
            document.getElementById('wasteDisplay').textContent = wasteFactor + '%';
            currentTileData.wasteFactor = parseInt(wasteFactor);
        }
        
        function toggleCostInputs() {
            const method = document.getElementById('tileCostMethod').value;
            
            // Hide all cost input rows
            document.getElementById('perTileRow').style.display = 'none';
            document.getElementById('perSqFtRow').style.display = 'none';
            document.getElementById('perBoxRow').style.display = 'none';
            document.getElementById('tilesPerBoxRow').style.display = 'none';
            document.getElementById('sqFtPerBoxRow').style.display = 'none';
            
            // Show relevant rows based on method
            if (method === 'per-tile') {
                document.getElementById('perTileRow').style.display = 'block';
            } else if (method === 'per-sqft') {
                document.getElementById('perSqFtRow').style.display = 'block';
            } else if (method === 'per-box') {
                document.getElementById('perBoxRow').style.display = 'block';
                document.getElementById('tilesPerBoxRow').style.display = 'block';
                document.getElementById('sqFtPerBoxRow').style.display = 'block';
            }
        }

        function calculateTiles() {
            // Handle custom grout spacing
            const groutSelect = document.getElementById('groutSpacing');
            if (groutSelect.value === 'custom') {
                document.getElementById('customGroutRow').style.display = 'block';
                currentTileData.groutSpacing = parseFloat(document.getElementById('customGrout').value) || 0;
            } else {
                document.getElementById('customGroutRow').style.display = 'none';
                currentTileData.groutSpacing = parseFloat(groutSelect.value) || 0;
            }

            const pattern = currentTileData.pattern;
            const patternData = tilePatterns[pattern];
            const projectSqFt = parseFloat(document.getElementById('projectSqFt').value) || 0;
            
            if (projectSqFt <= 0) {
                document.getElementById('tileResults').innerHTML = '<p>Enter project square footage to see results.</p>';
                return;
            }

            let results = [];
            let totalCost = 0;
            let totalRatio = 0;

            // Calculate total pattern ratio
            patternData.tiles.forEach((tile, index) => {
                totalRatio += tile.ratio;
            });

            // Calculate for each tile type
            patternData.tiles.forEach((tile, index) => {
                const length = parseFloat(document.getElementById(`tile${index}Length`).value) || 0;
                const width = parseFloat(document.getElementById(`tile${index}Width`).value) || 0;
                const tilesPerBox = parseInt(document.getElementById(`tile${index}PerBox`).value) || 1;
                const costPerBox = parseFloat(document.getElementById(`tile${index}Cost`).value) || 0;

                if (length > 0 && width > 0) {
                    // Account for grout spacing
                    const effectiveLength = length + currentTileData.groutSpacing;
                    const effectiveWidth = width + currentTileData.groutSpacing;
                    
                    // Calculate square footage per tile
                    const sqFtPerTile = (effectiveLength * effectiveWidth) / 144;
                    document.getElementById(`tile${index}SqFt`).value = sqFtPerTile.toFixed(3);

                    // Calculate tiles needed for this type based on pattern ratio
                    const patternSqFt = projectSqFt * (tile.ratio / totalRatio);
                    const tilesNeeded = Math.ceil(patternSqFt / sqFtPerTile);
                    const tilesWithWaste = Math.ceil(tilesNeeded * (1 + currentTileData.wasteFactor / 100));
                    const boxesNeeded = Math.ceil(tilesWithWaste / tilesPerBox);
                    const cost = boxesNeeded * costPerBox;

                    results.push({
                        name: tile.name,
                        length: length,
                        width: width,
                        sqFtPerTile: sqFtPerTile,
                        tilesNeeded: tilesNeeded,
                        tilesWithWaste: tilesWithWaste,
                        boxesNeeded: boxesNeeded,
                        tilesPerBox: tilesPerBox,
                        costPerBox: costPerBox,
                        totalCost: cost
                    });

                    totalCost += cost;
                }
            });

            displayTileResults(results, totalCost, projectSqFt);
        }

        function displayTileResults(results, totalCost, projectSqFt) {
            const container = document.getElementById('tileResults');
            
            if (results.length === 0) {
                container.innerHTML = '<p>Enter tile dimensions to see calculations.</p>';
                return;
            }

            let html = '<h4>Tile Requirements</h4>';

            results.forEach(result => {
                html += `
                    <div class="tile-type-result">
                        <div class="tile-type-name">${result.name} (${result.length}" × ${result.width}")</div>
                        <div class="tile-calculation-row">
                            <span class="tile-calculation-label">Tiles needed (exact):</span>
                            <span class="tile-calculation-value">${result.tilesNeeded}</span>
                        </div>
                        <div class="tile-calculation-row">
                            <span class="tile-calculation-label">Tiles with waste (+${currentTileData.wasteFactor}%):</span>
                            <span class="tile-calculation-value">${result.tilesWithWaste}</span>
                        </div>
                        <div class="tile-calculation-row">
                            <span class="tile-calculation-label">Boxes needed:</span>
                            <span class="tile-calculation-value">${result.boxesNeeded} boxes</span>
                        </div>
                        <div class="tile-calculation-row">
                            <span class="tile-calculation-label">Cost:</span>
                            <span class="tile-calculation-value">$${result.totalCost.toFixed(2)}</span>
                        </div>
                    </div>
                `;
            });

            html += `
                <div class="tile-total-section">
                    <div class="tile-total-row">
                        <span>Project Area:</span>
                        <span>${projectSqFt} sq ft</span>
                    </div>
                    <div class="tile-total-row">
                        <span>Grout Spacing:</span>
                        <span>${currentTileData.groutSpacing > 0 ? currentTileData.groutSpacing + '"' : 'None'}</span>
                    </div>
                    <div class="tile-total-row">
                        <span>Total Project Cost:</span>
                        <span class="tile-total-cost">$${totalCost.toFixed(2)}</span>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        function saveTileProject() {
            const pattern = document.getElementById('tilePattern').value;
            const projectSqFt = parseFloat(document.getElementById('projectSqFt').value) || 0;
            const groutSpacing = currentTileData.groutSpacing;
            const wasteFactor = currentTileData.wasteFactor;

            if (projectSqFt <= 0) {
                showNotification('Please enter project details before saving.', 'error');
                return;
            }

            // Collect tile data
            const patternData = tilePatterns[pattern];
            let tileData = [];
            let totalCost = 0;

            patternData.tiles.forEach((tile, index) => {
                const length = parseFloat(document.getElementById(`tile${index}Length`).value) || 0;
                const width = parseFloat(document.getElementById(`tile${index}Width`).value) || 0;
                const tilesPerBox = parseInt(document.getElementById(`tile${index}PerBox`).value) || 1;
                const costPerBox = parseFloat(document.getElementById(`tile${index}Cost`).value) || 0;

                if (length > 0 && width > 0) {
                    tileData.push({
                        name: tile.name,
                        length: length,
                        width: width,
                        tilesPerBox: tilesPerBox,
                        costPerBox: costPerBox
                    });
                    
                    // Quick cost calculation for project summary
                    const sqFtPerTile = ((length + groutSpacing) * (width + groutSpacing)) / 144;
                    const tilesNeeded = Math.ceil((projectSqFt * (tile.ratio / patternData.tiles.reduce((sum, t) => sum + t.ratio, 0))) / sqFtPerTile);
                    const tilesWithWaste = Math.ceil(tilesNeeded * (1 + wasteFactor / 100));
                    const boxesNeeded = Math.ceil(tilesWithWaste / tilesPerBox);
                    totalCost += boxesNeeded * costPerBox;
                }
            });

            // Create equation and details for standard save format
            const equation = `${tilePatterns[pattern].name} - ${projectSqFt} sq ft`;
            const details = `Pattern: ${tilePatterns[pattern].name}\nArea: ${projectSqFt} sq ft\nGrout: ${groutSpacing > 0 ? groutSpacing + '"' : 'None'}\nWaste Factor: ${wasteFactor}%\nTotal Cost: $${totalCost.toFixed(2)}`;

            const saveData = {
                equation: equation,
                result: `$${totalCost.toFixed(2)} total cost`,
                details: details,
                // Store additional tile-specific data
                tileData: {
                    pattern: tilePatterns[pattern].name,
                    projectSqFt: projectSqFt,
                    groutSpacing: groutSpacing,
                    wasteFactor: wasteFactor,
                    tiles: tileData,
                    totalCost: totalCost
                }
            };

            showSaveToProjectModal('Tile Calculator', saveData);
        }
        
        // =====================================================
        // Initialize Application on DOM Ready
        // =====================================================
        document.addEventListener('DOMContentLoaded', function() {
            const timestamp = Date.now();
            
            // Load saved theme
            loadSavedTheme();
            
            // Initialize touch events for mobile
            initializeTouchEvents();
            
            // Initialize mobile keypad for specialty calculator smart inputs only
            // (Main calculator uses integrated keypad, not popup)
            MobileKeypad.init();
            
            // Disable native keyboard on mobile for calculator input
            const smartInput1 = document.getElementById('smartInput1');
            if (smartInput1) {
                // Detect if on mobile device
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                                ('ontouchstart' in window) || 
                                (navigator.maxTouchPoints > 0);
                
                if (isMobile) {
                    // Prevent native keyboard from showing
                    smartInput1.setAttribute('readonly', 'readonly');
                    
                    // Allow custom keypad to still modify the input
                    smartInput1.addEventListener('click', function(e) {
                        e.preventDefault();
                        this.blur(); // Remove focus to ensure keyboard doesn't show
                    });
                    
                    smartInput1.addEventListener('focus', function(e) {
                        this.blur(); // Immediately blur to prevent keyboard
                    });
                }
            }
            
            // Initialize screw calculator
            initScrewCalculator();
            
            // Load saved data from localStorage
            loadFromLocalStorage();
            
            // Apply UI mode
            applyUIMode();
            
            // Restore calculator collapsed states
            restoreCalculatorStates();
            
            
            // Initialize kerf diagram state
            updateKerfDiagram();
            updateWoodworkingFractions();
            toggleKerfDisplay();
            
            // Check if projects help should be hidden for this session
            if (sessionStorage.getItem('hideProjectsHelp') === 'true') {
                const projectsHelp = document.getElementById('projectsHelpSection');
                if (projectsHelp) {
                    projectsHelp.style.display = 'none';
                }
            }
            
            // Initialize tile cost inputs with default per-sqft method
            toggleCostInputs();
            updateConversionPreview();
            
            // Initialize diagrams
            updateMiterDiagram();
            
            // Initialize calculator registry
            calculatorRegistry.initialize();
            
            const finalTimestamp = Date.now();
            const finalCabinetContent = document.getElementById('cabinetDrawerContent');
            
            console.log('Application initialized successfully');
        });
    </script>
    </div> <!-- End of main container from line 4106 -->
    
    <!-- Mobile Keypad HTML Structure -->
    <div id="mobileKeypadOverlay" class="keypad-overlay">
        <div id="mobileKeypad" class="mobile-keypad">
            <!-- Keypad Header -->
            <div class="keypad-header">
                <div class="keypad-input-display" id="keypadInputDisplay"></div>
                <button class="keypad-close-btn" onclick="MobileKeypad.hide()">×</button>
            </div>
            
            <!-- Compact Mobile Keypad Grid -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; padding: 8px;">
                <!-- Row 1: Numbers 1-3 + ft -->
                <button class="keypad-btn number" data-value="1">1</button>
                <button class="keypad-btn number" data-value="2">2</button>
                <button class="keypad-btn number" data-value="3">3</button>
                <button class="keypad-btn symbol" data-value="'" style="background: #007aff; color: white;">ft</button>
                
                <!-- Row 2: Numbers 4-6 + in -->
                <button class="keypad-btn number" data-value="4">4</button>
                <button class="keypad-btn number" data-value="5">5</button>
                <button class="keypad-btn number" data-value="6">6</button>
                <button class="keypad-btn symbol" data-value="&quot;" style="background: #007aff; color: white;">in</button>
                
                <!-- Row 3: Numbers 7-9 + backspace -->
                <button class="keypad-btn number" data-value="7">7</button>
                <button class="keypad-btn number" data-value="8">8</button>
                <button class="keypad-btn number" data-value="9">9</button>
                <button class="keypad-btn control backspace" data-action="backspace" style="background: #ff3b30; color: white;">⌫</button>
                
                <!-- Row 4: 0, decimal, slash, clear -->
                <button class="keypad-btn number" data-value="0">0</button>
                <button class="keypad-btn symbol" data-value=".">.</button>
                <button class="keypad-btn symbol" data-value="/" title="Fraction">⁄</button>
                <button class="keypad-btn clear" data-action="clear" style="background: #ff3b30; color: white;">C</button>
                
                <!-- Row 5: Space (2 cols), mm, cm -->
                <button class="keypad-btn space" data-value=" " style="grid-column: span 2; background: #34c759; color: white;">Space</button>
                <button class="keypad-btn unit" data-value="mm" style="background: #00bfa5; color: white;">mm</button>
                <button class="keypad-btn unit" data-value="cm" style="background: #00bfa5; color: white;">cm</button>
                
                <!-- Row 6: Done button (full width) -->
                <button class="keypad-btn done" data-action="done" style="grid-column: span 4; background: #007aff; color: white; font-weight: bold;">Done</button>
            </div>
        </div>
    </div>
</body>
</html>
