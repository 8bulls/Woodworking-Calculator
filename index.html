<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WorkShop Pro Calculator</title>
    <style>
        /* CSS Custom Properties for Themeable Colors */
        :root {
            /* Wood Theme (Default) */
            --primary-color: #8B4513;
            --primary-light: #A0522D;
            --primary-dark: #6B3410;
            --secondary-color: #D2B48C;
            --accent-color: #DEB887;
            --background-color: #FFFFFF;
            --surface-color: #F8F9FA;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-on-primary: #FFFFFF;
            --border-color: #D2B48C;
            --success-color: #4CAF50;
            --warning-color: #FF9800;
            --error-color: #F44336;
            --info-color: #2196F3;
            
            /* Gradient variations */
            --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            --gradient-surface: linear-gradient(135deg, var(--surface-color), var(--background-color));
            
            /* Theme transition */
            --theme-transition: all 0.3s ease;
        }
        
        /* Steel Theme */
        .theme-steel {
            --primary-color: #6B7280;
            --primary-light: #9CA3AF;
            --primary-dark: #4B5563;
            --secondary-color: #D1D5DB;
            --accent-color: #E5E7EB;
            --background-color: #F9FAFB;
            --surface-color: #FFFFFF;
            --text-primary: #111827;
            --text-secondary: #4B5563;
            --text-on-primary: #FFFFFF;
            --border-color: #D1D5DB;
            --success-color: #10B981;
            --warning-color: #F59E0B;
            --error-color: #EF4444;
            --info-color: #6B7280;
            --gradient-primary: linear-gradient(135deg, #6B7280, #4B5563);
            --gradient-surface: linear-gradient(135deg, var(--surface-color), var(--background-color));
        }
        
        /* Steel Theme Diamond Plate Background */
body.theme-steel {
background: 
/* Brushed metal texture */
repeating-linear-gradient(
45deg,
rgba(255,255,255,0.03) 0px,
rgba(255,255,255,0.03) 1px,
transparent 1px,
transparent 2px,
rgba(0,0,0,0.03) 2px,
rgba(0,0,0,0.03) 3px,
transparent 3px,
transparent 4px
),
/* Base steel gradient */
linear-gradient(135deg, #5A5A5A 0%, #3D3D3D 50%, #2A2A2A 100%) !important;
}        /* Steel Theme Tab Button Overrides */
        .theme-steel .tab-btn {
            background: linear-gradient(135deg, #9CA3AF, #6B7280);
            color: #FFFFFF;
            border: 1px solid #4B5563;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.2);
        }
        
        .theme-steel .tab-btn.active {
            background: linear-gradient(135deg, #4B5563, #374151);
            color: #FFFFFF;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .theme-steel .tab-btn:hover {
            background: linear-gradient(135deg, #6B7280, #4B5563);
            transform: none;
        }

        
        
        /* Dark Theme */
        .theme-dark {
            --primary-color: #3F51B5;          /* Muted Blue - subtle accent */
            --primary-light: #5C6BC0;          /* Lighter Blue */
            --primary-dark: #303F9F;           /* Darker Blue */
            --secondary-color: #424242;        /* Medium Gray */
            --accent-color: #757575;           /* Neutral Gray */
            --background-color: #121212;       /* Material Dark Background */
            --surface-color: #1E1E1E;          /* Elevated Surface */
            --text-primary: #E0E0E0;           /* Off-white text */
            --text-secondary: #A0A0A0;         /* Muted Gray text */
            --text-on-primary: #FFFFFF;        /* White text on blue */
            --border-color: #2D2D2D;           /* Subtle border */
            --success-color: #4CAF50;          /* Muted Green */
            --warning-color: #FF9800;          /* Muted Orange */
            --error-color: #F44336;            /* Muted Red */
            --info-color: #2196F3;             /* Muted Info Blue */
            --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            --gradient-surface: linear-gradient(135deg, var(--surface-color), var(--background-color));
        }
        
        /* Festool Theme */
        .theme-festool {
            --primary-color: #23AB08;          /* Festool Green */
            --primary-light: #3CC014;          /* Lighter Green */
            --primary-dark: #1A8806;           /* Darker Green */
            --secondary-color: #E2E2E2;        /* Festool Light Gray */
            --accent-color: #1C3448;           /* Festool Dark Blue-Gray */
            --background-color: #F8F8F8;       /* Light Gray */
            --surface-color: #FFFFFF;          /* White */
            --text-primary: #1C3448;           /* Dark Blue-Gray text */
            --text-secondary: #666666;         /* Medium Gray text */
            --text-on-primary: #FFFFFF;        /* White text on green */
            --border-color: #E2E2E2;           /* Light Gray border */
            --success-color: #23AB08;          /* Festool Green */
            --warning-color: #FF9800;          /* Orange */
            --error-color: #F44336;            /* Red */
            --info-color: #1C3448;             /* Dark Blue-Gray */
            --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            --gradient-surface: linear-gradient(135deg, var(--surface-color), var(--background-color));
        }
        
        /* Dewalt Theme */
        .theme-dewalt {
            --primary-color: #FEAA00;          /* Dewalt Yellow */
            --primary-light: #FFB41A;          /* Lighter Yellow */
            --primary-dark: #E09600;           /* Darker Yellow */
            --secondary-color: #333333;        /* Dark Gray */
            --accent-color: #1A1A1A;           /* Near Black */
            --background-color: #F5F5F5;       /* Light Gray */
            --surface-color: #FFFFFF;          /* White */
            --text-primary: #000000;           /* Black */
            --text-secondary: #333333;         /* Dark Gray */
            --text-on-primary: #000000;        /* Black text on yellow */
            --border-color: #CCCCCC;           /* Light Gray border */
            --success-color: #4CAF50;          /* Green */
            --warning-color: #FEAA00;          /* Dewalt Yellow */
            --error-color: #F44336;            /* Red */
            --info-color: #333333;             /* Dark Gray */
            --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            --gradient-surface: linear-gradient(135deg, var(--surface-color), var(--background-color));
        }

        /* Milwaukee Theme */
        .theme-milwaukee {
            --primary-color: #DB011C;          /* Milwaukee Red */
            --primary-light: #E23243;          /* Lighter Red */
            --primary-dark: #B80016;           /* Darker Red */
            --secondary-color: #2D2D2D;        /* Dark Gray */
            --accent-color: #000000;           /* Black */
            --background-color: #F8F8F8;       /* Light Gray */
            --surface-color: #FFFFFF;          /* White */
            --text-primary: #000000;           /* Black */
            --text-secondary: #2D2D2D;         /* Dark Gray */
            --text-on-primary: #FFFFFF;        /* White text on red */
            --border-color: #DDDDDD;           /* Light Gray border */
            --success-color: #28A745;          /* Green */
            --warning-color: #FFC107;          /* Amber */
            --error-color: #DB011C;            /* Milwaukee Red */
            --info-color: #2D2D2D;             /* Dark Gray */
            --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            --gradient-surface: linear-gradient(135deg, var(--surface-color), var(--background-color));
        }

        /* Ridgid Theme */
        .theme-ridgid {
            --primary-color: #F58025;          /* Ridgid Orange */
            --primary-light: #F79A4E;          /* Lighter Orange */
            --primary-dark: #DD6B1D;           /* Darker Orange */
            --secondary-color: #333333;        /* Dark Gray */
            --accent-color: #000000;           /* Black */
            --background-color: #F9F9F9;       /* Light Gray */
            --surface-color: #FFFFFF;          /* White */
            --text-primary: #000000;           /* Black */
            --text-secondary: #333333;         /* Dark Gray */
            --text-on-primary: #FFFFFF;        /* White text on orange */
            --border-color: #DDDDDD;           /* Light Gray border */
            --success-color: #28A745;          /* Green */
            --warning-color: #F58025;          /* Ridgid Orange */
            --error-color: #DC3545;            /* Red */
            --info-color: #333333;             /* Dark Gray */
            --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            --gradient-surface: linear-gradient(135deg, var(--surface-color), var(--background-color));
        }

        /* Makita Theme */
        .theme-makita {
            --primary-color: #007B8A;          /* Makita Teal */
            --primary-light: #00A3B5;          /* Lighter Teal */
            --primary-dark: #005A66;           /* Darker Teal */
            --secondary-color: #333333;        /* Dark Gray */
            --accent-color: #000000;           /* Black */
            --background-color: #F8F8F8;       /* Light Gray */
            --surface-color: #FFFFFF;          /* White */
            --text-primary: #000000;           /* Black */
            --text-secondary: #333333;         /* Dark Gray */
            --text-on-primary: #FFFFFF;        /* White text on teal */
            --border-color: #007B8A;           /* Teal borders */
            --hover-color: #F0F9FA;            /* Light teal hover */
            --shadow-color: rgba(0, 123, 138, 0.2); /* Teal shadow */
            --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            --gradient-surface: linear-gradient(135deg, var(--surface-color), var(--background-color));
        }

        /* Noob Theme (Ryobi) */
        .theme-noob {
            --primary-color: #C4E300;          /* Ryobi Lime Green */
            --primary-light: #D4F310;          /* Brighter Lime */
            --primary-dark: #A6C400;           /* Darker Green */
            --secondary-color: #333333;        /* Dark Gray */
            --accent-color: #000000;           /* Black */
            --background-color: #F8F8F8;       /* Light Gray */
            --surface-color: #FFFFFF;          /* White */
            --text-primary: #000000;           /* Black */
            --text-secondary: #333333;         /* Dark Gray */
            --text-on-primary: #000000;        /* Black text on lime */
            --border-color: #DDDDDD;           /* Light Gray border */
            --success-color: #C4E300;          /* Ryobi Green */
            --warning-color: #FFA500;          /* Orange */
            --error-color: #FF4444;            /* Red */
            --info-color: #333333;             /* Dark Gray */
            --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            --gradient-surface: linear-gradient(135deg, var(--surface-color), var(--background-color));
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            font-family: Arial, sans-serif;
            background: var(--primary-color);
            color: var(--text-primary);
            padding: 0;
            margin: 0;
            min-height: 100vh;
            overflow-x: hidden;
            transition: var(--theme-transition);
        }
        
        body {
            padding: 10px;
            background: var(--gradient-primary);
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: var(--background-color);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            position: relative;
            transition: var(--theme-transition);
        }
        
        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        h1 {
            color: var(--primary-color);
            font-size: 24px;
            font-weight: bold;
            margin: 0;
            transition: var(--theme-transition);
        }
        
        .help-btn {
            background: var(--secondary-color);
            border: 2px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            color: var(--primary-color);
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: var(--theme-transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .help-btn:hover {
            background: var(--primary-color);
            color: var(--text-on-primary);
            transform: scale(1.1);
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .theme-selector select {
            padding: 6px 10px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--background-color);
            color: var(--primary-color);
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--theme-transition);
            min-width: 90px;
        }
        
        .theme-selector select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        
        .theme-selector select:hover {
            border-color: var(--primary-light);
        }
        
        .tab-buttons {
            display: flex;
            margin-bottom: 15px;
            border-radius: 10px;
            overflow: hidden;
        }
        
        /* Global Project Selector */
        .global-project-selector {
            background: var(--gradient-primary);
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: var(--theme-transition);
        }
        
        .project-selector-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .project-label {
            color: var(--text-on-primary);
            font-weight: bold;
            font-size: 14px;
            transition: var(--theme-transition);
        }
        
        #globalProjectDropdown {
            padding: 6px 12px;
            border: 2px solid var(--border-color);
            border-radius: 5px;
            background: var(--background-color);
            color: var(--text-primary);
            font-size: 14px;
            min-width: 200px;
            cursor: pointer;
            transition: var(--theme-transition);
        }
        
        #globalProjectDropdown:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 5px rgba(139, 69, 19, 0.3);
        }
        
        .tab-btn {
            flex: 1 1 auto;
            padding: 12px 8px;
            background: var(--secondary-color);
            color: var(--primary-color);
            border: none;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--theme-transition);
            white-space: nowrap;
            min-width: fit-content;
        }
        
        /* Only apply responsive changes on truly small screens */
        @media (max-width: 500px) {
            .tab-btn {
                font-size: 12px;
                padding: 8px 4px;
            }
            
            /* Replace long text with shorter versions for very narrow windows */
            .tab-btn:nth-child(2):after { content: "Cut Calc"; }
            .tab-btn:nth-child(3):after { content: "Specialty"; }
            
            .tab-btn:nth-child(2),
            .tab-btn:nth-child(3) {
                text-indent: -9999px;
                position: relative;
            }
            
            .tab-btn:nth-child(2):after,
            .tab-btn:nth-child(3):after {
                position: absolute;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                text-indent: 0;
                font-size: 12px;
                font-weight: bold;
            }
        }
        
        .tab-btn.active {
            background: var(--primary-color);
            color: var(--text-on-primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .settings-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .settings-row label {
            font-weight: bold;
            min-width: 80px;
        }
        
        select, input {
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            background: var(--background-color);
            color: var(--text-primary);
            transition: var(--theme-transition);
        }
        
        .wide-input {
            width: 80px !important;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        /* Save to Project Modal specific styles */
        .save-preview-section {
            margin-bottom: 20px;
        }
        
        .save-preview {
            background: #f8f9fa;
            border: 2px solid var(--secondary-color);
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            color: #333;
        }
        
        .save-preview-lumber .preview-header {
            font-size: 16px;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--secondary-color);
        }
        
        .save-preview-lumber .preview-summary {
            font-size: 14px;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .save-preview-lumber .preview-details {
            font-size: 12px;
            line-height: 1.4;
            color: #666;
        }
        
        .save-preview-cut .preview-header {
            font-size: 16px;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--secondary-color);
        }
        
        .save-preview-cut .preview-equation {
            font-size: 14px;
            margin-bottom: 8px;
            color: var(--primary-color);
        }
        
        .save-preview-cut .preview-result {
            font-size: 14px;
            margin-bottom: 10px;
            color: #28a745;
        }
        
        .save-preview-cut .preview-details {
            font-size: 12px;
            line-height: 1.4;
            color: #666;
        }
        
        .cut-result-actions {
            margin-top: 10px;
            text-align: center;
        }
        
        .save-preview-optimization .preview-header {
            font-size: 16px;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--secondary-color);
        }
        
        .save-preview-optimization .preview-equation {
            font-size: 14px;
            margin-bottom: 8px;
            color: var(--primary-color);
        }
        
        .save-preview-optimization .preview-result {
            font-size: 14px;
            margin-bottom: 8px;
            color: #28a745;
            font-weight: bold;
        }
        
        .save-preview-optimization .preview-summary {
            font-size: 13px;
            margin-bottom: 10px;
            color: #6f42c1;
            font-style: italic;
        }
        
        .save-preview-optimization .preview-details {
            font-size: 12px;
            line-height: 1.4;
            color: #666;
        }
        
        .save-preview-spacing .preview-header {
            font-size: 16px;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--secondary-color);
        }
        
        .save-preview-spacing .preview-equation {
            font-size: 14px;
            margin-bottom: 8px;
            color: var(--primary-color);
        }
        
        .save-preview-spacing .preview-result {
            font-size: 14px;
            margin-bottom: 10px;
            color: #28a745;
            font-weight: bold;
        }
        
        .save-preview-spacing .preview-marks {
            background: #f0f8f0;
            border: 1px solid #28a745;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
        }
        
        .save-preview-spacing .marks-header {
            font-weight: bold;
            color: #28a745;
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .save-preview-spacing .mark-item {
            font-size: 12px;
            color: #333;
            margin-bottom: 3px;
            font-family: monospace;
        }
        
        .save-preview-spacing .preview-summary {
            font-size: 12px;
            color: #666;
            font-style: italic;
            margin-top: 8px;
        }
        
        .save-project-selection {
            margin-bottom: 20px;
        }
        
        .save-notes-section {
            margin-bottom: 20px;
        }
        
        .save-preview h5 {
            margin: 0 0 10px 0;
            color: var(--primary-color);
            font-size: 16px;
        }
        
        /* Project Timeline Styles */
        .project-timeline-header {
            background: var(--gradient-primary);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            color: var(--text-on-primary);
            transition: var(--theme-transition);
        }
        
        .project-title-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .project-title-section h2 {
            margin: 0;
            color: white;
        }
        
        .project-actions {
            display: flex;
            gap: 10px;
        }
        
        .project-summary {
            border-top: 1px solid rgba(255,255,255,0.3);
            padding-top: 15px;
        }
        
        .project-info {
            border-top: 1px solid rgba(255,255,255,0.2);
            padding-top: 10px;
            margin-top: 10px;
        }
        
        .project-dates {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .project-date {
            color: rgba(255,255,255,0.8);
            font-size: 12px;
            font-style: italic;
        }
        
        .project-loader-section {
            border-top: 1px solid rgba(255,255,255,0.3);
            padding-top: 15px;
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .project-loader-label {
            color: rgba(255,255,255,0.9);
            font-weight: bold;
            font-size: 14px;
            margin: 0;
        }
        
        .project-loader-dropdown {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            color: white;
            padding: 8px 12px;
            font-size: 14px;
            min-width: 250px;
            cursor: pointer;
        }
        
        .project-loader-dropdown:focus {
            outline: none;
            border-color: rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.15);
        }
        
        .project-loader-dropdown option {
            background: var(--primary-color);
            color: white;
        }
        
        .project-timeline-container {
            min-height: 400px;
        }
        
        .project-timeline {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
        }
        
        .timeline-content {
            position: relative;
        }
        
        /* Timeline Item Styles */
        .timeline-item {
            position: relative;
            margin-bottom: 30px;
            padding: 0 0 0 40px;
        }
        
        .timeline-item:before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: -30px;
            width: 2px;
            background: var(--secondary-color);
        }
        
        .timeline-item:last-child:before {
            bottom: 20px;
        }
        
        .timeline-marker {
            position: absolute;
            left: 6px;
            top: 12px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            font-weight: bold;
        }
        
        .timeline-marker.calculator { background: #007bff; }
        .timeline-marker.golden { background: #ffc107; color: #333; }
        .timeline-marker.spacing { background: #28a745; }
        .timeline-marker.miter { background: #dc3545; }
        .timeline-marker.lumber { background: #6f42c1; }
        .timeline-marker.cut { background: #fd7e14; }
        .timeline-marker.optimizer { background: #20c997; }
        
        .timeline-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid var(--secondary-color);
        }
        
        .timeline-card-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .timeline-tool-info {
            flex: 1;
        }
        
        .timeline-tool-name {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .timeline-timestamp {
            font-size: 12px;
            color: #666;
        }
        
        .timeline-actions {
            display: flex;
            gap: 5px;
        }
        
        .timeline-equation {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 14px;
            margin-bottom: 10px;
            color: #333;
        }
        
        .timeline-result {
            font-weight: bold;
            color: #28a745;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .timeline-details {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 10px;
            white-space: pre-line;
        }
        
        .timeline-notes {
            background: #fff9c4;
            border: 1px solid #f0e68c;
            border-radius: 4px;
            padding: 10px;
            font-style: italic;
            color: #856404;
            margin-top: 10px;
        }
        
        .timeline-notes:before {
            content: 'üí° ';
            font-style: normal;
        }
        
        /* All Projects Modal */
        .projects-modal-content {
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .projects-grid-modal {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        /* Mobile responsive - actual mobile devices */
        @media (max-width: 768px) and (hover: none) and (pointer: coarse) {
            .project-title-section {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .project-actions {
                justify-content: center;
            }
        }
        
        /* Very narrow windows - mobile or narrow desktop */
        @media (max-width: 500px) {
            .tab-btn {
                font-size: 12px;
                padding: 8px 4px;
            }
            
            /* Further shorten tab names for very narrow windows */
            .tab-btn:nth-child(2):after { content: "Cut"; }
            .tab-btn:nth-child(3):after { content: "Tools"; }
            .tab-btn:nth-child(4):after { content: "üìÅ Projects"; }
            
            .tab-btn:nth-child(4) {
                text-indent: -9999px;
                position: relative;
            }
            
            .tab-btn:nth-child(4):after {
                position: absolute;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                text-indent: 0;
                font-size: 12px;
                font-weight: bold;
            }
        }
        
        @media (max-width: 480px) {
            .tab-btn {
                font-size: 10px;
                padding: 8px 2px;
            }
            
            .tab-buttons {
                margin-bottom: 10px;
            }
            
            .container {
                padding: 15px;
                margin: 10px;
                border-radius: 10px;
            }
            
            /* Even shorter names for very small screens */
            .tab-btn:nth-child(2):after { content: "Cut"; }
            .tab-btn:nth-child(3):after { content: "Tools"; }
            .tab-btn:nth-child(4):after { content: "üìÅ"; }
            
            .tab-btn:nth-child(4):after {
                font-size: 14px;
            }
        }
        
        @media (max-width: 360px) {
            .tab-btn {
                font-size: 9px;
                padding: 6px 1px;
            }
            
            /* Ultra-compact for smallest screens */
            .tab-btn:nth-child(1):after { content: "Calc"; }
            .tab-btn:nth-child(2):after { content: "Cut"; }
            .tab-btn:nth-child(3):after { content: "üîß"; }
            .tab-btn:nth-child(4):after { content: "üìÅ"; }
            
            .tab-btn:nth-child(1) {
                text-indent: -9999px;
                position: relative;
            }
            
            .tab-btn:nth-child(1):after {
                position: absolute;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                text-indent: 0;
                font-size: 9px;
                font-weight: bold;
            }
            
            .tab-btn:nth-child(3):after,
            .tab-btn:nth-child(4):after {
                font-size: 12px;
            }
        }
            
            .summary-stats {
                justify-content: center;
                text-align: center;
            }
            
            .timeline-item {
                padding-left: 30px;
            }
            
            .timeline-marker {
                left: 1px;
                width: 16px;
                height: 16px;
                font-size: 10px;
            }
            
            .projects-grid-modal {
                grid-template-columns: 1fr;
            }
            
            .project-loader-section {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .project-loader-dropdown {
                min-width: 100%;
            }
        }
        
        .input-mode-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .input-group {
            display: flex;
            gap: 5px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .input-group input {
            width: 80px;
            text-align: center;
        }
        
        .input-group select {
            width: 100px;
        }
        
        .input-group label {
            font-weight: bold;
            margin-right: 5px;
        }
        
        .current-value {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            border: 2px solid var(--primary-color);
        }
        
        /* Calculator display styles */
        .calc-display {
            background: #2F1B14;
            color: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .calc-equation {
            font-size: 16px;
            color: var(--secondary-color);
            min-height: 24px;
            margin-bottom: 5px;
        }
        
        .calc-result {
            font-size: 28px;
            font-weight: bold;
            text-align: right;
            min-height: 40px;
            word-break: break-all;
        }
        
        .calc-result.has-value {
            color: #4CAF50;
        }
        
        .calc-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .calc-btn {
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--secondary-color);
            color: #2F1B14;
        }
        
        .calc-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .calc-btn:active {
            transform: translateY(0);
        }
        
        .calc-btn.operation {
            background: var(--primary-color);
            color: white;
        }
        
        .calc-btn.equals {
            background: #4CAF50;
            color: white;
            grid-column: span 2;
        }
        
        .calc-btn.save {
            background: #28a745;
            color: white;
        }
        
        .calc-btn.clear {
            background: #f44336;
            color: white;
        }
        
        .calc-btn.memory {
            background: #607D8B;
            color: white;
            font-size: 14px;
        }
        
        .memory-display {
            position: absolute;
            top: 5px;
            right: 10px;
            font-size: 12px;
            color: var(--secondary-color);
        }
        
        .conversion-section {
            margin-bottom: 20px;
        }
        
        .conversion-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .conversion-input-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .conversion-input-row label {
            font-weight: bold;
            color: var(--primary-color);
            min-width: 80px;
        }
        
        .conversion-preview {
            background: #f8f9fa;
            border: 1px solid var(--secondary-color);
            border-radius: 5px;
            padding: 8px 12px;
            margin-bottom: 10px;
            font-size: 14px;
            color: #666;
        }
        
        #conversionValue {
            font-weight: bold;
            color: var(--primary-color);
        }
        
        /* WorkShop Pro Calculator Styles */
        .woodworking-calcs-section {
            margin-bottom: 20px;
        }
        
        .calc-card {
            border: 2px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 10px;
            background: var(--background-color);
            overflow: visible;
            transition: var(--theme-transition);
        }
        
        .calc-card-header {
            background: var(--gradient-primary);
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            user-select: none;
            transition: var(--theme-transition);
            color: var(--text-on-primary);
        }
        
        .calc-card-header:hover {
            background: var(--primary-light);
        }
        
        .calc-icon {
            font-size: 18px;
        }
        
        .calc-title {
            flex: 1;
            font-weight: bold;
            color: inherit;
        }
        
        .calc-arrow {
            transition: transform 0.3s;
            color: inherit;
        }
        
        .calc-card.expanded .calc-arrow {
            transform: rotate(180deg);
        }
        
        .calc-card-content {
            display: none;
            padding: 20px;
            background: var(--surface-color);
            transition: var(--theme-transition);
        }
        
        .calc-card.expanded .calc-card-content {
            display: block;
        }

        /* Wood Species Database Styles */
        .wood-species-container {
            max-width: 100%;
        }

        .wood-controls {
            margin-bottom: 20px;
        }

        .search-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-row input, .search-row select {
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            background: var(--surface-color);
            color: var(--text-primary);
            font-size: 14px;
        }

        .search-row input {
            flex: 1;
            min-width: 200px;
        }

        .search-row select {
            min-width: 120px;
        }

        .wood-species-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .wood-species-card {
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--surface-color);
            padding: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .wood-species-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 8px var(--shadow-color);
            transform: translateY(-2px);
        }

        .wood-species-card.recommended {
            border-color: var(--primary-color);
            background: var(--hover-color);
            box-shadow: 0 2px 8px var(--shadow-color);
        }

        .wood-species-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .wood-species-name {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-primary);
        }

        .wood-cost-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .wood-cost-badge.budget {
            background: #d4edda;
            color: #155724;
        }

        .wood-cost-badge.mid {
            background: #fff3cd;
            color: #856404;
        }

        .wood-cost-badge.premium {
            background: #f8d7da;
            color: #721c24;
        }

        .wood-properties {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin: 10px 0;
            font-size: 14px;
        }

        .wood-property {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
        }

        .hardness-bar {
            display: flex;
            align-items: center;
            gap: 5px;
            margin: 8px 0;
        }

        .hardness-scale {
            flex: 1;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .hardness-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #FF9800, #F44336);
            transition: width 0.3s ease;
        }

        .wood-uses {
            margin: 10px 0;
        }

        .wood-uses h5 {
            margin: 0 0 5px 0;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .use-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .use-tag {
            background: var(--primary-color);
            color: var(--text-on-primary);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .wood-description {
            font-size: 13px;
            color: var(--text-secondary);
            margin: 10px 0;
            line-height: 1.4;
        }

        .workability-stars {
            display: flex;
            align-items: center;
            gap: 5px;
            margin: 5px 0;
        }

        .star {
            color: #ffc107;
        }

        .star.empty {
            color: #e0e0e0;
        }

        .project-wizard {
            background: var(--surface-color);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
        }

        .wizard-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }

        .wizard-buttons .btn {
            font-size: 14px;
            padding: 8px 12px;
        }

        .project-recommendations {
            margin-top: 15px;
        }

        .recommendation-item {
            background: var(--hover-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px;
            margin: 5px 0;
        }

        .recommendation-item.top-choice {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: var(--text-on-primary);
        }

        @media (max-width: 768px) {
            .wood-species-grid {
                grid-template-columns: 1fr;
            }
            
            .search-row {
                flex-direction: column;
            }
            
            .search-row input, .search-row select {
                width: 100%;
            }
            
            .wizard-buttons {
                flex-direction: column;
            }
            
            .wizard-buttons .btn {
                width: 100%;
            }
        }
        
        .calc-description {
            color: var(--text-secondary);
            margin-bottom: 15px;
            font-style: italic;
        }
        
        .calc-visual {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            overflow: visible;
        }
        
        /* Specific styling for miter angle diagram container */
        #angleCard .calc-visual {
            min-height: 220px; /* Reserve space for enhanced diagrams */
            margin-bottom: 30px;
            position: relative;
        }
        
        .calc-inputs {
            margin-bottom: 20px;
        }
        
        .input-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }
        
        .input-row label {
            min-width: 120px;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .input-row input {
            flex: 1;
            max-width: 150px;
            padding: 8px;
            border: 2px solid var(--secondary-color);
            border-radius: 4px;
        }
        
        .input-row .unit {
            font-size: 12px;
            color: #666;
            min-width: 50px;
        }
        
        .calc-result {
            background: #f8f9fa;
            border: 1px solid var(--secondary-color);
            border-radius: 5px;
            padding: 15px;
            text-align: center;
        }
        
        .result-display {
            font-size: 16px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        /* Board Foot Calculator Visuals */
        .lumber-diagram {
            width: 200px;
            height: 120px;
            position: relative;
            background: #f0f0f0;
            border: 2px solid var(--primary-color);
            border-radius: 4px;
        }
        
        .lumber-piece {
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, var(--accent-color), var(--secondary-color));
            position: relative;
            overflow: hidden;
        }
        
        .lumber-piece::before {
            content: '';
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            border: 1px dashed var(--primary-color);
            border-radius: 2px;
        }
        
        .dimension-label {
            position: absolute;
            background: rgba(255,255,255,0.9);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .dimension-label.top {
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .dimension-label.left {
            left: -35px;
            top: 50%;
            transform: translateY(-50%) rotate(-90deg);
        }
        
        .dimension-label.right {
            right: -35px;
            top: 50%;
            transform: translateY(-50%) rotate(90deg);
        }
        
        /* Lumber Cart Styles */
        .cart-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
        }
        
        .cart-section {
            margin-top: 20px;
            border-top: 2px solid var(--secondary-color);
            padding-top: 15px;
        }
        
        .cart-display {
            background: #f8f9fa;
            border: 1px solid var(--secondary-color);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--secondary-color);
        }
        
        .cart-header h4 {
            margin: 0;
            color: var(--primary-color);
        }
        
        .cart-items {
            margin-bottom: 15px;
        }
        
        .cart-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .cart-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .cart-item-header strong {
            color: var(--primary-color);
            font-size: 16px;
        }
        
        .btn-remove {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        
        .btn-remove:hover {
            background: #c82333;
        }
        
        .cart-item-details {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .cart-item-pricing {
            font-size: 14px;
            color: #495057;
        }
        
        .cart-summary {
            background: #e9f7ef;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            padding: 10px;
        }
        
        .cart-bottom-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .cart-bottom-actions button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        
        /* Frame Builder Cut List Styles */
        .cut-list {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border: 1px solid var(--secondary-color);
            border-radius: 4px;
        }
        
        .cut-list h4 {
            margin: 0 0 8px 0;
            color: var(--primary-color);
            font-size: 14px;
        }
        
        .cut-item {
            padding: 4px 0;
            color: #2F1B14;
            font-weight: bold;
            border-bottom: 1px solid #e9ecef;
        }
        
        .cut-item:last-child {
            border-bottom: none;
        }
        
        .cut-item small {
            color: #6c757d;
            font-weight: normal;
            font-size: 12px;
        }
        
        /* Golden Ratio Calculator Visuals */
        .golden-diagram {
            width: 200px;
            height: 120px;
        }
        
        .golden-rectangle {
            width: 100%;
            height: 100%;
            border: 2px solid var(--primary-color);
            border-radius: 4px;
            display: flex;
            position: relative;
        }
        
        .golden-small {
            flex: 1;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border-right: 1px solid var(--primary-color);
        }
        
        .golden-large {
            flex: 1.618;
            background: linear-gradient(135deg, #F0E68C, #DDD700);
        }
        
        .ratio-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: bold;
            color: var(--primary-color);
            font-size: 14px;
        }
        
        .calc-mode-selector {
            display: flex;
            margin-bottom: 15px;
            border-radius: 6px;
            overflow: hidden;
            border: 2px solid var(--secondary-color);
        }
        
        .mode-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: #f8f9fa;
            color: var(--primary-color);
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .mode-btn.active {
            background: var(--primary-color);
            color: white;
        }
        
        /* Spacing Calculator Visuals */
        .spacing-diagram {
            width: 100%;
            height: 240px;
            position: relative;
            overflow-y: auto;
            overflow-x: auto;
        }
        
        .spacing-line {
            width: 100%;
            height: 20px;
            background: var(--accent-color);
            border: 2px solid var(--primary-color);
            border-radius: 4px;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
        }
        
        .spacing-marker {
            width: 3px;
            height: 40px;
            background: var(--primary-color);
            border-radius: 1px;
            position: relative;
        }
        
        .spacing-marker::after {
            content: '';
            position: absolute;
            top: -5px;
            left: -2px;
            width: 7px;
            height: 10px;
            background: #654321;
            border-radius: 2px;
        }
        
        /* Angle Calculator Visuals */
        .angle-diagram {
            width: 120px;
            height: 120px;
        }
        
        .polygon-shape {
            width: 100%;
            height: 100%;
            position: relative;
            border: 2px solid var(--primary-color);
            border-radius: 4px;
            background: linear-gradient(45deg, #F5DEB3, var(--secondary-color));
        }
        
        .angle-line {
            position: absolute;
            width: 2px;
            height: 40px;
            background: var(--primary-color);
            transform-origin: bottom center;
        }
        
        .preset-buttons {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .preset-btn {
            padding: 6px 12px;
            border: 1px solid var(--secondary-color);
            background: #f8f9fa;
            color: var(--primary-color);
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .preset-btn:hover {
            background: var(--primary-color);
            color: white;
        }
        
        .preset-section {
            background: #f9f9f9;
            border: 2px solid var(--secondary-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .preset-section h4 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .preset-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }
        
        .history-clickable {
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .history-clickable:hover {
            background: #e8f5e8;
        }
        
        .history-timestamp {
            font-size: 10px;
            color: #999;
            float: right;
        }
        
        .history-result {
            background: #e8f5e8;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #4CAF50;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .history-conversion {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #2196F3;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .history-preset {
            background: #fff3e0;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #ff9800;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .history-equation {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: bold;
            color: #2F1B14;
        }
        
        .history-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        
        /* Modal for calculations */
        .calc-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .calc-modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .calc-modal h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .calc-modal .input-group {
            margin-bottom: 15px;
        }
        
        .calc-modal .btn {
            margin-right: 10px;
        }
        
        .button-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .quick-cuts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .quick-cuts .btn {
            padding: 12px 8px;
            font-size: 14px;
        }
        
        .btn {
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--theme-transition);
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: var(--text-on-primary);
        }
        
        .btn-primary:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: var(--secondary-color);
            color: var(--primary-color);
        }
        
        .btn-secondary:hover {
            background: var(--accent-color);
            transform: translateY(-2px);
        }
        
        .btn-operation {
            background: var(--secondary-color);
            color: var(--primary-color);
        }
        
        .btn-operation.active {
            background: var(--primary-color);
            color: var(--text-on-primary);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
        
        /* Mode Toggle Styles */
        .mode-toggle-section {
            margin-bottom: 20px;
        }
        
        .mode-toggle {
            display: flex;
            background: #f5f5f5;
            border-radius: 10px;
            padding: 4px;
            gap: 2px;
        }
        
        .mode-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            background: transparent;
            color: #666;
        }
        
        .mode-btn:hover {
            background: #e0e0e0;
            color: #333;
        }
        
        .mode-btn.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 2px 8px rgba(139, 69, 19, 0.3);
            transform: translateY(-1px);
        }
        
        /* Visual Board Representation */
        .visual-board {
            margin: 15px 0;
            padding: 20px;
            background: #f8f8f8;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .board-container {
            position: relative;
            height: 80px;
            background: #DEB887;
            background-image: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 8px,
                    rgba(160, 82, 45, 0.2) 8px,
                    rgba(160, 82, 45, 0.2) 9px
                ),
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 15px,
                    rgba(160, 82, 45, 0.15) 15px,
                    rgba(160, 82, 45, 0.15) 16px
                ),
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 25px,
                    rgba(160, 82, 45, 0.18) 25px,
                    rgba(160, 82, 45, 0.18) 26px
                );
            border: 3px solid #8B4513;
            border-radius: 2px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .cut-mark {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #dc3545;
            box-shadow: 0 0 4px rgba(220, 53, 69, 0.5);
            z-index: 3;
        }
        
        .cut-mark::before {
            content: '';
            position: absolute;
            top: -8px;
            left: -3px;
            width: 8px;
            height: 8px;
            background: #dc3545;
            border-radius: 50%;
        }
        
        .cut-mark::after {
            content: attr(data-mark);
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            font-weight: bold;
            color: #dc3545;
            white-space: nowrap;
            background: white;
            padding: 2px 4px;
            border-radius: 3px;
            border: 1px solid #dc3545;
        }
        
        .kerf-cutout {
            position: absolute;
            top: 10px;
            bottom: 10px;
            background: rgba(220, 53, 69, 0.3);
            border: 1px dashed #dc3545;
            z-index: 2;
        }
        
        .kerf-cutout.left-side {
            border-right: 2px solid #dc3545;
        }
        
        .kerf-cutout.right-side {
            border-left: 2px solid #dc3545;
        }
        
        .board-ends {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 6px;
            background: #8B4513;
            box-shadow: 0 0 3px rgba(0, 0, 0, 0.2);
        }
        
        .board-ends.left {
            left: -6px;
            border-radius: 3px 0 0 3px;
        }
        
        .board-ends.right {
            right: -6px;
            border-radius: 0 3px 3px 0;
        }
        
        .board-dimension {
            text-align: center;
            margin-top: 15px;
            color: var(--primary-color);
            font-weight: bold;
            font-size: 14px;
        }
        
        .piece-labels {
            position: relative;
            height: 20px;
            margin-top: 40px;
        }
        
        .piece-label {
            position: absolute;
            font-size: 11px;
            color: #666;
            text-align: center;
            top: 0;
        }
        
        /* Marking Guide Styles */
        .marking-guide {
            margin: 15px 0;
            padding: 15px;
            background: #fff9e6;
            border: 1px solid #856404;
            border-radius: 8px;
        }
        
        .marking-guide .marks-header {
            font-weight: bold;
            color: #856404;
            font-size: 14px;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .marks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .marking-guide .mark-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 10px;
            background: white;
            border: 1px solid #d4d4aa;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .marking-guide .mark-number {
            font-weight: bold;
            color: #856404;
        }
        
        .marking-guide .mark-value {
            font-weight: bold;
            color: #2c5234;
        }
        
        .marking-summary {
            border-top: 1px solid #d4d4aa;
            padding-top: 10px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .summary-item {
            font-size: 12px;
            color: #555;
            text-align: center;
        }
        
        /* Screw Calculator Styles */
        .screw-identification {
            margin-bottom: 20px;
        }
        
        /* Pilot Hole Results Styling */
        .result-card {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: left;
        }
        
        .result-card h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .pilot-hole-result {
            background: linear-gradient(135deg, #f0f8ff, #e6f2ff);
            border: 2px solid #4CAF50;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .pilot-hole-result h3 {
            margin: 0 0 15px 0;
            color: #2e7d32;
            font-size: 20px;
            white-space: nowrap;
        }
        
        .drill-bit-size {
            font-size: 36px;
            font-weight: bold;
            color: #1565c0;
            margin: 10px 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        .calculation-note {
            font-size: 14px;
            color: #666;
            font-style: italic;
            margin: 10px 0 0 0;
        }
        
        .drilling-tips {
            background: #fff8dc;
            border: 1px solid var(--secondary-color);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            text-align: left;
        }
        
        .drilling-tips h4 {
            margin: 0 0 10px 0;
            color: var(--primary-color);
            font-size: 18px;
            text-align: left;
        }
        
        .drilling-tips ul {
            margin: 0;
            padding-left: 20px;
            list-style-type: none;
            text-align: left;
        }
        
        .drilling-tips ul li {
            position: relative;
            padding-left: 20px;
            margin-bottom: 8px;
            color: #555;
            line-height: 1.5;
            text-align: left;
            word-wrap: break-word;
            hyphens: none;
        }
        
        .drilling-tips ul li:before {
            content: "‚Ä¢";
            position: absolute;
            left: 0;
            color: var(--primary-color);
            font-weight: bold;
            font-size: 18px;
        }
        
        /* Quick Reference Table Styles */
        .reference-table-container {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .screw-reference-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .screw-reference-table th {
            background: var(--primary-color);
            color: white;
            padding: 10px 8px;
            text-align: center;
            font-size: 14px;
            border: 1px solid var(--primary-dark);
        }
        
        .screw-reference-table td {
            padding: 8px;
            text-align: center;
            border: 1px solid #ddd;
            font-size: 13px;
        }
        
        .screw-reference-table tbody tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        .screw-reference-table tbody tr:hover {
            background: #f0f8ff;
        }
        
        .screw-reference-table .screw-category {
            background: #f5f5f5;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .screw-reference-table .lag-bolt {
            background: #fff8dc;
        }
        
        .identification-tabs {
            display: flex;
            gap: 2px;
            margin-bottom: 15px;
            background: #f5f5f5;
            padding: 3px;
            border-radius: 8px;
        }
        
        .id-tab {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: transparent;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            color: #666;
        }
        
        .id-tab:hover {
            background: #e0e0e0;
            color: #333;
        }
        
        .id-tab.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 2px 4px rgba(139, 69, 19, 0.3);
        }
        
        .screw-size-circles {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 20px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 15px 0;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .screw-size-circles.lag-bolts {
            background: #F5F5DC;
            border: 2px solid var(--primary-color);
        }
        
        .size-circle-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .size-circle-container:hover {
            background: #f0f8ff;
            transform: scale(1.05);
        }
        
        .size-circle {
            background: #333;
            border-radius: 50%;
            border: 2px solid #666;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .size-circle.selected {
            background: #28A745;
            border-color: #1E7E34;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.3);
        }
        
        .size-circle.lag-bolt {
            background: var(--primary-color);
            border-color: #654321;
        }
        
        .size-circle.lag-bolt:hover {
            background: var(--primary-light);
            border-color: var(--primary-color);
        }
        
        .size-circle.lag-bolt.selected {
            background: #28A745;
            border-color: #1E7E34;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.3);
        }
        
        .common-screw-btn.selected {
            background-color: #28A745;
            color: white;
            border-color: #1E7E34;
        }
        
        .common-screw-btn.lag-btn {
            background-color: #F5F5DC;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }
        
        .common-screw-btn.lag-btn:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        .common-screw-btn.lag-btn.selected {
            background-color: #28A745;
            color: white;
            border-color: #1E7E34;
        }
        
        .wood-btn.selected {
            background-color: var(--primary-color);
            color: white;
            border-color: #654321;
        }
        
        /* Calibration Ruler */
        .zoom-calibration {
            background: #FFF3CD;
            border: 1px solid #FFC107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .calibration-ruler {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .inch-line {
            width: 96px; /* 96px = 1 inch at 96 DPI */
            height: 3px;
            background: linear-gradient(to right, #000 0%, #000 10%, transparent 10%, transparent 90%, #000 90%, #000 100%);
            border-top: 2px solid #000;
            border-bottom: 2px solid #000;
            position: relative;
        }
        
        .inch-line::before {
            content: '';
            position: absolute;
            left: 0;
            top: -5px;
            width: 2px;
            height: 13px;
            background: #000;
        }
        
        .inch-line::after {
            content: '';
            position: absolute;
            right: 0;
            top: -5px;
            width: 2px;
            height: 13px;
            background: #000;
        }
        
        .ruler-label {
            font-weight: bold;
            color: #856404;
        }
        
        .calibration-note {
            font-size: 0.9em;
            color: #856404;
            margin-top: 10px;
        }
        
        .size-circle:hover {
            background: var(--primary-color);
            border-color: var(--primary-color);
            box-shadow: 0 0 8px rgba(139, 69, 19, 0.4);
        }
        
        .size-label {
            font-size: 11px;
            font-weight: bold;
            color: #666;
            text-align: center;
            line-height: 1.2;
        }
        
        .common-screw-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .common-screw-btn {
            padding: 12px 8px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .common-screw-btn:hover {
            border-color: var(--primary-color);
            background: #f9f9f9;
            transform: translateY(-2px);
        }
        
        .common-screw-btn strong {
            color: var(--primary-color);
            display: block;
            margin-bottom: 4px;
        }
        
        .common-screw-btn small {
            color: #666;
            font-size: 10px;
        }
        
        .measurement-help {
            margin-top: 10px;
            padding: 8px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
        }
        
        .measurement-units {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .measurement-units label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        
        .selected-screw, .wood-selection {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        
        .wood-type-buttons {
            display: flex;
            gap: 15px;
            margin: 15px 0;
        }
        
        .wood-btn {
            flex: 1;
            padding: 15px 10px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-weight: bold;
        }
        
        .wood-btn:hover {
            border-color: var(--primary-color);
            background: #f9f9f9;
            transform: translateY(-2px);
        }
        
        .wood-btn.selected {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: white;
        }
        
        .wood-btn small {
            display: block;
            font-weight: normal;
            font-size: 11px;
            margin-top: 4px;
        }
        
        .btn-success {
            background: var(--success-color);
            color: var(--text-on-primary);
        }
        
        .btn-success:hover {
            background: var(--success-color);
            filter: brightness(0.9);
        }
        
        .btn-warning {
            background: var(--warning-color);
            color: var(--text-on-primary);
        }
        
        .btn-warning:hover {
            background: var(--warning-color);
            filter: brightness(0.9);
        }
        
        /* Removed old project management bar styles - now using cleaner status indicators */
        
        /* Enhanced Spacing Calculator Results */
        .result-summary {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 3px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .summary-row:last-child {
            border-bottom: none;
        }
        
        .summary-label {
            font-weight: bold;
            color: #495057;
            font-size: 12px;
        }
        
        .summary-value {
            color: #212529;
            font-family: monospace;
            font-size: 13px;
        }
        
        .divider-marks {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }
        
        .marks-header {
            font-weight: bold;
            color: #856404;
            font-size: 13px;
            margin-bottom: 8px;
            text-align: center;
        }
        
        .divider-mark-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid rgba(133, 100, 4, 0.2);
        }
        
        .divider-mark-row:last-child {
            border-bottom: none;
        }
        
        .divider-label {
            font-weight: bold;
            color: #856404;
            font-size: 12px;
            flex: 1;
        }
        
        .mark-left, .mark-right {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #856404;
            border-radius: 3px;
            padding: 2px 6px;
            font-family: monospace;
            font-size: 11px;
            font-weight: bold;
            margin: 0 2px;
        }
        
        .mark-left {
            color: #d73502;
        }
        
        .mark-right {
            color: #0f5132;
        }
        
        .mark-center {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #6c757d;
            border-radius: 3px;
            padding: 2px 6px;
            font-family: monospace;
            font-size: 11px;
            font-weight: bold;
            color: #495057;
            margin: 0 2px;
        }
        
        /* Force scrollbar visibility */
        .spacing-diagram-container {
            scrollbar-width: auto !important;
            scrollbar-color: #007bff #f8f9fa !important;
        }
        
        .spacing-diagram-container::-webkit-scrollbar {
            height: 12px !important;
        }
        
        .spacing-diagram-container::-webkit-scrollbar-track {
            background: #f8f9fa !important;
            border-radius: 6px !important;
        }
        
        .spacing-diagram-container::-webkit-scrollbar-thumb {
            background: #007bff !important;
            border-radius: 6px !important;
        }
        
        .spacing-diagram-container::-webkit-scrollbar-thumb:hover {
            background: #0056b3 !important;
        }
        
        /* Visual Layout Styles */
        .board-visualization {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border: 2px solid var(--secondary-color);
            border-radius: 8px;
            overflow-x: auto;
        }
        
        .visual-board {
            margin-bottom: 20px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
            position: relative;
        }
        
        .board-header {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .board-visual {
            height: 40px;
            background: linear-gradient(45deg, var(--secondary-color), #F5DEB3);
            border: 2px solid var(--primary-color);
            border-radius: 4px;
            position: relative;
            margin-bottom: 5px;
            overflow: hidden;
        }
        
        .cut-segment {
            position: absolute;
            height: 100%;
            border-right: 2px solid var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            color: #654321;
            text-shadow: 1px 1px 1px rgba(255,255,255,0.7);
        }
        
        .cut-segment.used {
            background: rgba(40, 167, 69, 0.3);
        }
        
        .cut-segment.waste {
            background: rgba(220, 53, 69, 0.3);
        }
        
        .cut-segment.kerf {
            background: rgba(0, 0, 0, 0.2);
            width: 2px !important;
            border-right: none;
        }
        
        .board-stats {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .visual-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .efficiency-summary {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
        }
        
        .efficiency-good {
            background: #d4edda;
            border-color: #c3e6cb;
        }
        
        .efficiency-poor {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        
        /* Projects Tab Styles */
        .projects-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .projects-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .current-project-section {
            margin-bottom: 30px;
        }
        
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .project-card {
            background: white;
            border: 2px solid var(--secondary-color);
            border-radius: 10px;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        
        .project-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .project-card.current-project {
            border-color: #28a745;
            background: linear-gradient(145deg, #f8fff9, #ffffff);
        }
        
        .project-card-content {
            padding: 15px;
        }
        
        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .project-header h4 {
            margin: 0;
            color: var(--primary-color);
            font-size: 16px;
        }
        
        .project-actions {
            display: flex;
            gap: 5px;
        }
        
        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
            min-width: auto;
        }
        
        .project-stats {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .stat {
            font-size: 12px;
            color: #666;
            background: #f8f9fa;
            padding: 3px 6px;
            border-radius: 3px;
        }
        
        .project-preview {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            min-height: 60px;
        }
        
        .preview-message {
            color: #999;
            font-style: italic;
            text-align: center;
            padding: 15px;
        }
        
        .project-preview-boards {
            display: flex;
            gap: 5px;
            margin-bottom: 5px;
            flex-wrap: wrap;
        }
        
        .preview-board {
            background: linear-gradient(45deg, var(--secondary-color), #F5DEB3);
            border: 1px solid var(--primary-color);
            border-radius: 2px;
            padding: 2px 4px;
            font-size: 10px;
            color: #654321;
        }
        
        .project-notes-preview {
            font-size: 11px;
            color: #666;
            max-height: 30px;
            overflow: hidden;
            margin-top: 5px;
            line-height: 1.3;
        }
        
        .project-date {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }
        
        .no-projects {
            grid-column: 1/-1;
        }
        
        
        /* Project Status Bar */
        .project-status-bar {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 1px solid var(--secondary-color);
            border-radius: 6px;
            padding: 8px 12px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }
        
        .project-status-bar.active {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border-color: #28a745;
        }
        
        .project-status-bar .status-text {
            font-weight: 500;
            color: #666;
        }
        
        .project-status-bar.active .status-text {
            color: #155724;
        }
        
        @media (max-width: 600px) {
            .visual-controls {
                justify-content: center;
            }
            
            .board-visual {
                height: 50px;
            }
            
            .cut-segment {
                font-size: 10px;
            }
            
            .projects-header {
                flex-direction: column;
                text-align: center;
            }
            
            .projects-actions {
                justify-content: center;
            }
            
            .projects-grid {
                grid-template-columns: 1fr;
            }
            
            .project-stats {
                justify-content: center;
            }
            
            .project-status-bar {
                padding: 6px 10px;
                font-size: 12px;
            }
        }
        
        .manual-calc {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .history {
            max-height: 200px;
            overflow-y: auto;
            background: #f9f9f9;
            border: 2px solid var(--secondary-color);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
        }
        
        .history-item {
            padding: 8px;
            border-bottom: 1px solid #ddd;
            font-family: monospace;
            font-size: 14px;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .waste-section {
            margin-bottom: 20px;
        }
        
        .waste-section h3 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .board-input, .cut-input {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .results {
            background: #e8f5e8;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .cut-plan {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-family: monospace;
        }
        
        /* Visual diagram styles */
        .kerf-diagram {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 15px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .board-diagram {
            position: relative;
            width: 300px;
            height: 60px;
            background: linear-gradient(180deg, #D2691E 0%, var(--primary-color) 100%);
            border: 2px solid #654321;
            border-radius: 2px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .mark-line {
            position: absolute;
            top: -10px;
            width: 2px;
            height: 80px;
            background: #ff0000;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .mark-label {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            font-weight: bold;
            color: #ff0000;
            white-space: nowrap;
        }
        
        .kerf-area {
            position: absolute;
            top: 0;
            height: 100%;
            background: rgba(0,0,0,0.5);
            border: 1px dashed #fff;
        }
        
        .kerf-area.right {
            left: 50%;
            width: 10px;
        }
        
        .kerf-area.left {
            right: 50%;
            width: 10px;
        }
        
        .diagram-label {
            position: absolute;
            bottom: -20px;
            font-size: 11px;
            white-space: nowrap;
        }
        
        .left-piece {
            left: 10px;
        }
        
        .right-piece {
            right: 10px;
        }
        
        /* Cut result styles */
        .cut-results {
            background: #f5f5f5;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .cut-results h4 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .mark-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .mark-item {
            background: white;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .mark-item .mark-number {
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .mark-item .mark-value {
            font-family: monospace;
            font-size: 16px;
            font-weight: bold;
        }
        
        .piece-info {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            color: #2e7d32;
        }
        
        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #f44336;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 3000;
            opacity: 0;
            transition: opacity 0.3s;
            max-width: 80%;
            text-align: center;
            font-weight: bold;
        }
        
        .notification.show {
            opacity: 1;
        }
        
        .notification.success {
            background: #4CAF50;
        }
        
        .notification.warning {
            background: #ff9800;
        }
        
        /* Edit modal styles */
        .edit-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .edit-modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .edit-modal h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .edit-modal .input-group {
            margin-bottom: 15px;
        }
        
        .edit-modal .btn {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-section">
            <h1>WorkShop Pro Calculator</h1>
            <div class="header-controls">
                <div class="theme-selector">
                    <select id="themeSelect" onchange="changeTheme(this.value)" title="Choose Theme">
                        <option value="wood">üü§ Wood</option>
                        <option value="steel">üîß Steel</option>
                        <option value="dark">üåô Dark</option>
                        <option value="festool">üü¢ Festool</option>
                        <option value="milwaukee">üî¥ Milwaukee</option>
                        <option value="makita">üîµ Makita</option>
                        <option value="dewalt">üü° Dewalt</option>
                        <option value="ridgid">üü† Ridgid</option>
                        <option value="noob">üü¢ Noob</option>
                    </select>
                </div>
                <button class="help-btn" onclick="showHelp()" title="Help">?</button>
                <button class="help-btn" onclick="fetchDadJoke()" title="Groan Zone - Dad Jokes">üôÑ</button>
            </div>
        </div>
        
        <div class="tab-buttons">
            <button class="tab-btn active" onclick="switchTab('calculator')">Calculator</button>
            <button class="tab-btn" onclick="switchTab('cutCalculator')">Cut Calculator</button>
            <button class="tab-btn" onclick="switchTab('specialty')">Specialty Calculators</button>
            <button class="tab-btn" onclick="switchTab('projects')">üìÅ Projects</button>
        </div>
        
        <!-- Global Project Selector -->
        <div class="global-project-selector" id="globalProjectSelector">
            <div class="project-selector-content">
                <span class="project-label">üíæ Active Project:</span>
                <select id="globalProjectDropdown" onchange="switchToProject(this.value)">
                    <option value="">No Project Selected</option>
                </select>
                <button class="btn btn-primary btn-sm" onclick="createNewProject()" style="margin-left: 10px;">+ New</button>
            </div>
        </div>
        

        <!-- Calculator Tab -->
        <div id="calculator" class="tab-content active">
            <div class="settings-row">
                <label>Precision:</label>
                <select id="precision" onchange="updatePrecision('calculator'); updateWoodworkingFractions();">
                    <option value="32">1/32"</option>
                    <option value="16" selected>1/16"</option>
                    <option value="8">1/8"</option>
                    <option value="4">1/4"</option>
                    <option value="2">1/2"</option>
                    <option value="1">1"</option>
                </select>
            </div>
            
            <div class="calc-display">
                <div class="memory-display" id="memoryIndicator"></div>
                <div class="calc-equation" id="calcEquation">&nbsp;</div>
                <div class="calc-result" id="calcResult">0"</div>
            </div>
            
            <div class="input-group">
                <label>Input 1:</label>
                <input type="number" id="feet1" placeholder="0" min="0" class="wide-input" onchange="updateCalculation()">
                <span>ft</span>
                <input type="number" id="inches1" placeholder="0" min="0" max="11" class="wide-input" onchange="updateCalculation()">
                <span>in</span>
                <select id="fraction1" style="width: 120px;" onchange="updateCalculation()">
                    <option value="0">0</option>
                </select>
            </div>
            
            <div class="calc-grid">
                <button class="calc-btn operation" onclick="setOperation('+')" id="addBtn">+</button>
                <button class="calc-btn operation" onclick="setOperation('-')" id="subBtn">‚àí</button>
                <button class="calc-btn operation" onclick="setOperation('*')" id="mulBtn">√ó</button>
                <button class="calc-btn operation" onclick="setOperation('/')" id="divBtn">√∑</button>
            </div>
            
            <!-- Input 2 for Addition/Subtraction (feet/inches) -->
            <div class="input-group" id="input2GroupFeetInches" style="display: none;">
                <label>Input 2:</label>
                <input type="number" id="feet2" placeholder="0" min="0" class="wide-input" onchange="updateCalculation()">
                <span>ft</span>
                <input type="number" id="inches2" placeholder="0" min="0" max="11" class="wide-input" onchange="updateCalculation()">
                <span>in</span>
                <select id="fraction2" style="width: 120px;" onchange="updateCalculation()">
                    <option value="0">0</option>
                </select>
            </div>
            
            <!-- Input 2 for Multiplication/Division (simple number) -->
            <div class="input-group" id="input2GroupNumber" style="display: none;">
                <label>Factor:</label>
                <input type="number" id="factor" placeholder="2" min="0" step="0.1" class="wide-input" onchange="updateCalculation()" style="width: 150px;">
                <span style="color: #666; font-size: 12px; margin-left: 5px;">(multiply/divide by this number)</span>
            </div>
            
            <div class="calc-grid" style="margin-top: 15px;">
                <button class="calc-btn memory" onclick="memoryOperation('MC')">MC</button>
                <button class="calc-btn memory" onclick="memoryOperation('MR')">MR</button>
                <button class="calc-btn memory" onclick="memoryOperation('M+')">M+</button>
                <button class="calc-btn memory" onclick="memoryOperation('M-')">M‚àí</button>
                <button class="calc-btn clear" onclick="clearCalculator()">Clear</button>
                <button class="calc-btn save" onclick="saveCalculatorToProject()">Save to Project</button>
            </div>
            
            <div class="conversion-section">
                <h4 style="color: var(--primary-color); margin-bottom: 10px;">Quick Conversions</h4>
                <div class="conversion-input-row">
                    <label>Direct Input:</label>
                    <input type="number" id="directDecimalInput" placeholder="37.625" step="0.001" class="wide-input" onchange="handleDirectInput()">
                    <span>inches</span>
                    <button class="btn btn-primary" onclick="convertDirectInput()">Convert</button>
                </div>
                <div id="conversionPreview" class="conversion-preview">
                    Convert: <span id="conversionValue">Enter a value or calculate</span>
                </div>
                <div class="conversion-grid">
                    <button class="btn btn-secondary" onclick="convertToDecimal()">‚Üí Decimal</button>
                    <button class="btn btn-secondary" onclick="convertToFraction()">‚Üí Fraction</button>
                    <button class="btn btn-secondary" onclick="convertToFeet()">‚Üí Decimal Feet</button>
                    <button class="btn btn-secondary" onclick="convertToInches()">‚Üí Total Inches</button>
                </div>
            </div>
            
            <div class="history" id="history">
                <!-- History will appear here -->
            </div>
        </div>
        
        <!-- Cut Calculator Tab -->
        <div id="cutCalculator" class="tab-content">
            <!-- Mode Toggle -->
            <div class="mode-toggle-section">
                <div class="mode-toggle">
                    <button class="mode-btn active" id="equalDivisionMode" onclick="switchCutMode('equal')">
                        üìè Equal Division
                    </button>
                    <button class="mode-btn" id="cutOptimizationMode" onclick="switchCutMode('optimization')">
                        üîß Cut Optimization
                    </button>
                </div>
            </div>
            
            <!-- Equal Division Mode Content -->
            <div id="equalDivisionContent" class="mode-content">
                <div class="settings-row">
                    <label>Precision:</label>
                    <select id="cutPrecision" onchange="updatePrecision('cut')">
                        <option value="32">1/32"</option>
                        <option value="16" selected>1/16"</option>
                        <option value="8">1/8"</option>
                        <option value="4">1/4"</option>
                        <option value="2">1/2"</option>
                        <option value="1">1"</option>
                    </select>
                </div>
            
            <div class="settings-row">
                <label>
                    <input type="checkbox" id="cutKerfEnabled" checked onchange="toggleKerfDisplay()"> 
                    Kerf Compensation
                </label>
            </div>
            
            <div class="settings-row" id="cutKerfRow">
                <label>Kerf:</label>
                <select id="cutKerf">
                    <option value="0.0625">1/16"</option>
                    <option value="0.09375">3/32"</option>
                    <option value="0.125" selected>1/8"</option>
                    <option value="0.1875">3/16"</option>
                </select>
            </div>
            
            <div class="settings-row">
                <label>Cut Side of Mark:</label>
                <select id="cutSide" onchange="updateKerfDiagram()">
                    <option value="left">Left Side</option>
                    <option value="right">Right Side</option>
                </select>
            </div>
            
            <div class="kerf-diagram" id="kerfDiagram" style="display: none;">
                <svg width="100%" height="150" viewBox="0 0 400 150" style="max-width: 400px; margin: 0 auto; display: block;">
                    <!-- Grid pattern background -->
                    <defs>
                        <pattern id="kerfGrid" width="20" height="20" patternUnits="userSpaceOnUse">
                            <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#e0e0e0" stroke-width="0.5"/>
                        </pattern>
                        <!-- Wood grain pattern -->
                        <pattern id="woodGrain" patternUnits="userSpaceOnUse" width="100" height="60">
                            <rect width="100" height="60" fill="#D2691E"/>
                            <path d="M0,10 Q25,5 50,10 T100,10" stroke="#A0522D" stroke-width="0.8" fill="none"/>
                            <path d="M0,25 Q30,20 60,25 T100,25" stroke="#A0522D" stroke-width="0.6" fill="none"/>
                            <path d="M0,40 Q20,35 40,40 T100,40" stroke="#A0522D" stroke-width="0.7" fill="none"/>
                            <path d="M0,55 Q35,50 70,55 T100,55" stroke="#A0522D" stroke-width="0.5" fill="none"/>
                        </pattern>
                    </defs>
                    <rect width="400" height="150" fill="url(#kerfGrid)" />
                    
                    <!-- Board representation -->
                    <rect x="50" y="50" width="300" height="60" fill="url(#woodGrain)" stroke="#654321" stroke-width="3" rx="2"/>
                    
                    <!-- Mark line -->
                    <line x1="200" y1="30" x2="200" y2="130" stroke="#ff0000" stroke-width="2" stroke-dasharray="4,2"/>
                    
                    <!-- Kerf area (will be positioned dynamically) -->
                    <defs>
                        <pattern id="kerfPattern" patternUnits="userSpaceOnUse" width="4" height="4">
                            <rect width="4" height="4" fill="#ff6b6b"/>
                            <line x1="0" y1="0" x2="4" y2="4" stroke="white" stroke-width="0.5"/>
                            <line x1="4" y1="0" x2="0" y2="4" stroke="white" stroke-width="0.5"/>
                        </pattern>
                    </defs>
                    <rect id="kerfAreaSvg" x="200" y="50" width="0" height="60" fill="url(#kerfPattern)" stroke="#ff0000" stroke-width="2"/>
                    
                    <!-- Labels -->
                    <text x="200" y="20" text-anchor="middle" font-size="14" font-weight="bold" fill="#ff0000">Mark</text>
                    <text x="100" y="135" text-anchor="middle" font-size="12" fill="#666">Left piece</text>
                    <text x="300" y="135" text-anchor="middle" font-size="12" fill="#666">Right piece</text>
                    
                    <!-- Kerf label (will be positioned dynamically) -->
                    <text id="kerfLabelSvg" x="200" y="85" text-anchor="middle" font-size="10" font-weight="bold" fill="white" style="display: none;">KERF</text>
                    
                    <!-- Dimension arrows -->
                    <path d="M 55 45 L 195 45 M 55 45 L 60 42 M 55 45 L 60 48 M 195 45 L 190 42 M 195 45 L 190 48" stroke="#333" stroke-width="1" fill="none"/>
                    <path d="M 205 45 L 345 45 M 205 45 L 210 42 M 205 45 L 210 48 M 345 45 L 340 42 M 345 45 L 340 48" stroke="#333" stroke-width="1" fill="none"/>
                </svg>
            </div>
            
            <div class="input-group">
                <label>Board Length:</label>
                <input type="number" id="cutFeet" placeholder="0" min="0" class="wide-input" onchange="updateCutValue()">
                <span>ft</span>
                <input type="number" id="cutInches" placeholder="0" min="0" max="11" class="wide-input" onchange="updateCutValue()">
                <span>in</span>
                <select id="cutFraction" style="width: 120px;" onchange="updateCutValue()">
                    <option value="0">0</option>
                </select>
            </div>
            
            <div class="current-value" id="cutCurrentValue">
                Enter measurement above
            </div>
            
            <div class="division-controls">
                <div class="input-group">
                    <label>Divide into:</label>
                    <select id="divisionSelect" class="wide-input" onchange="performDivision()">
                        <option value="">Select division...</option>
                        <option value="2">Half (2 pieces)</option>
                        <option value="3">Thirds (3 pieces)</option>
                        <option value="4">Fourths (4 pieces)</option>
                        <option value="5">Fifths (5 pieces)</option>
                        <option value="6">Sixths (6 pieces)</option>
                        <option value="8">Eighths (8 pieces)</option>
                    </select>
                </div>
                
                <div class="input-group" style="margin-top: 10px;">
                    <label>Custom pieces:</label>
                    <input type="number" id="customPieces" placeholder="# pieces" min="2" max="20" class="wide-input" onchange="performCustomDivision()">
                    <button class="btn btn-secondary" onclick="clearCut()">Clear</button>
                </div>
            </div>
            
                <div class="history" id="cutHistory">
                    <!-- Results will appear here -->
                </div>
            </div>
            
            <!-- Cut Optimization Mode Content -->
            <div id="cutOptimizationContent" class="mode-content" style="display: none;">
                <div class="settings-row">
                    <label>Precision:</label>
                    <select id="optPrecision" onchange="updatePrecision('optimizer')">
                        <option value="32">1/32"</option>
                        <option value="16" selected>1/16"</option>
                        <option value="8">1/8"</option>
                        <option value="4">1/4"</option>
                        <option value="2">1/2"</option>
                        <option value="1">1"</option>
                    </select>
                </div>
                
                <div class="settings-row">
                    <label>
                        <input type="checkbox" id="optKerfEnabled" checked onchange="toggleKerfDisplay()"> 
                        Kerf Compensation
                    </label>
                </div>
                
                <div class="settings-row" id="optKerfRow">
                    <label>Kerf:</label>
                    <select id="optKerf">
                        <option value="0.0625">1/16"</option>
                        <option value="0.09375">3/32"</option>
                        <option value="0.125" selected>1/8"</option>
                        <option value="0.1875">3/16"</option>
                    </select>
                </div>
                
                <div class="waste-section">
                    <h3>Available Boards</h3>
                    <div class="board-input">
                        <input type="number" id="boardFeet" placeholder="0" min="0" class="wide-input">
                        <span>ft</span>
                        <input type="number" id="boardInches" placeholder="0" min="0" max="11" class="wide-input">
                        <span>in</span>
                        <select id="boardFraction" style="width: 120px;">
                            <option value="0">0</option>
                        </select>
                        <input type="number" id="boardQuantity" placeholder="1" min="1" class="wide-input">
                        <span>qty</span>
                        <button class="btn btn-secondary" onclick="addBoard()">Add</button>
                    </div>
                    <div id="boardsList"></div>
                </div>
                
                <div class="waste-section">
                    <h3>Needed Cuts</h3>
                    <div class="cut-input">
                        <input type="number" id="optCutFeet" placeholder="0" min="0" class="wide-input">
                        <span>ft</span>
                        <input type="number" id="optCutInches" placeholder="0" min="0" max="11" class="wide-input">
                        <span>in</span>
                        <select id="optCutFraction" style="width: 120px;">
                            <option value="0">0</option>
                        </select>
                        <input type="number" id="cutQuantity" placeholder="1" min="1" class="wide-input">
                        <span>qty</span>
                        <button class="btn btn-secondary" onclick="addCut()">Add</button>
                    </div>
                    <div id="cutsList"></div>
                </div>
                
                <button class="btn btn-primary" onclick="optimizeCuts()" style="width: 100%; margin-bottom: 15px;">Optimize Cuts</button>
                
                <div id="optimizationResults"></div>
                
                <!-- Visual Cut Layout -->
                <div id="visualLayout" style="display: none;">
                    <h3>Visual Cut Layout</h3>
                    <div id="boardVisualization" class="board-visualization"></div>
                </div>
            </div>
        </div>

        <!-- Specialty Calculators Tab -->
        <div id="specialty" class="tab-content">
            <!-- Board Foot Calculator -->
            <div class="calc-card" id="boardFootCard">
                <div class="calc-card-header" onclick="toggleCalcCard('boardFoot')">
                    <span class="calc-icon">üìè</span>
                    <span class="calc-title">Lumber Shopping Cart</span>
                    <span class="calc-arrow">‚ñº</span>
                </div>
                <div class="calc-card-content" id="boardFootContent">
                    <div class="calc-description">Calculate lumber costs by species and build a shopping cart</div>
                    <div class="calc-visual" id="boardDiagramContainer">
                        <svg width="100%" height="200" viewBox="0 0 400 200" style="max-width: 400px; margin: 0 auto; display: block;">
                            <!-- Grid pattern background -->
                            <defs>
                                <pattern id="bfGrid" width="20" height="20" patternUnits="userSpaceOnUse">
                                    <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#e0e0e0" stroke-width="0.5"/>
                                </pattern>
                                <!-- Wood grain pattern for lumber -->
                                <pattern id="lumberGrain" patternUnits="userSpaceOnUse" width="80" height="40">
                                    <rect width="80" height="40" fill="#DEB887"/>
                                    <path d="M0,5 Q20,3 40,5 T80,5" stroke="#D2691E" stroke-width="1" fill="none"/>
                                    <path d="M0,15 Q15,12 30,15 T80,15" stroke="#CD853F" stroke-width="0.8" fill="none"/>
                                    <path d="M0,25 Q25,22 50,25 T80,25" stroke="#D2691E" stroke-width="0.9" fill="none"/>
                                    <path d="M0,35 Q18,32 36,35 T80,35" stroke="#CD853F" stroke-width="0.7" fill="none"/>
                                </pattern>
                            </defs>
                            <rect width="400" height="200" fill="url(#bfGrid)" />
                            
                            <!-- 3D Lumber piece (interactive) -->
                            <g id="lumber3d">
                                <!-- Top face -->
                                <path id="topFace" d="M 100 60 L 250 60 L 300 40 L 150 40 Z" fill="url(#lumberGrain)" stroke="#8B4513" stroke-width="2"/>
                                <!-- Front face -->
                                <rect id="frontFace" x="100" y="60" width="150" height="80" fill="#D2691E" stroke="#8B4513" stroke-width="2"/>
                                <!-- Right face -->
                                <path id="rightFace" d="M 250 60 L 300 40 L 300 120 L 250 140 Z" fill="#A0522D" stroke="#8B4513" stroke-width="2"/>
                                
                                <!-- Wood grain lines on front -->
                                <g id="grainLines">
                                    <line x1="100" y1="80" x2="250" y2="80" stroke="#B8860B" stroke-width="0.5" opacity="0.5"/>
                                    <line x1="100" y1="100" x2="250" y2="100" stroke="#B8860B" stroke-width="0.5" opacity="0.5"/>
                                    <line x1="100" y1="120" x2="250" y2="120" stroke="#B8860B" stroke-width="0.5" opacity="0.5"/>
                                </g>
                            </g>
                            
                            <!-- Dynamic dimension labels -->
                            <text id="lengthLabel" x="175" y="170" text-anchor="middle" font-size="12" fill="#666">Length</text>
                            <text id="widthLabel" x="275" y="160" text-anchor="middle" font-size="12" fill="#666">Width</text>
                            <text id="thicknessLabel" x="50" y="105" text-anchor="middle" font-size="12" fill="#666">Thickness</text>
                            
                            <!-- Dynamic dimension arrows -->
                            <g id="dimensionArrows">
                                <!-- Length arrow (horizontal) -->
                                <path id="lengthArrow" d="M 100 150 L 250 150 M 100 150 L 105 147 M 100 150 L 105 153 M 250 150 L 245 147 M 250 150 L 245 153" stroke="#333" stroke-width="1" fill="none"/>
                                <!-- Width arrow (diagonal, positioned below lumber) -->
                                <path id="widthArrow" d="M 250 145 L 300 125 M 250 145 L 255 143 M 250 145 L 252 140 M 300 125 L 295 127 M 300 125 L 298 130" stroke="#333" stroke-width="1" fill="none"/>
                                <!-- Thickness arrow (vertical on left) -->
                                <path id="thicknessArrow" d="M 80 60 L 80 140 M 80 60 L 77 65 M 80 60 L 83 65 M 80 140 L 77 135 M 80 140 L 83 135" stroke="#333" stroke-width="1" fill="none"/>
                            </g>
                        </svg>
                    </div>
                    <div class="calc-inputs">
                        <div class="input-row">
                            <label>Wood Species:</label>
                            <select id="bfSpecies" onchange="handleSpeciesChange()">
                                <option value="">Select species...</option>
                                <option value="White Oak">White Oak</option>
                                <option value="Red Oak">Red Oak</option>
                                <option value="Maple">Maple</option>
                                <option value="Cherry">Cherry</option>
                                <option value="Walnut">Walnut</option>
                                <option value="Poplar">Poplar</option>
                                <option value="Pine">Pine</option>
                                <option value="Cedar">Cedar</option>
                                <option value="Mahogany">Mahogany</option>
                                <option value="Ash">Ash</option>
                                <option value="Birch">Birch</option>
                                <option value="Custom">Custom Species</option>
                            </select>
                        </div>
                        <div class="input-row" id="customSpeciesRow" style="display: none;">
                            <label>Custom Species:</label>
                            <input type="text" id="bfCustomSpecies" placeholder="Enter species name" oninput="calculateBoardFeet()">
                        </div>
                        <div class="input-row">
                            <label>Price per Board Foot:</label>
                            <input type="number" id="bfPrice" step="0.01" min="0" placeholder="8.99" oninput="calculateBoardFeet()">
                            <span class="unit">$/BF</span>
                        </div>
                        <div class="input-row">
                            <label>Thickness:</label>
                            <input type="number" id="bfThickness" step="0.25" min="0.1" placeholder="1" oninput="calculateBoardFeet()">
                            <span class="unit">inches</span>
                        </div>
                        <div class="input-row">
                            <label>Width:</label>
                            <input type="number" id="bfWidth" step="0.25" min="0.1" placeholder="6" oninput="calculateBoardFeet()">
                            <span class="unit">inches</span>
                        </div>
                        <div class="input-row">
                            <label>Length:</label>
                            <input type="number" id="bfLength" step="1" min="0.1" placeholder="96" oninput="calculateBoardFeet()">
                            <span class="unit">inches</span>
                        </div>
                        <div class="input-row">
                            <label>Quantity:</label>
                            <input type="number" id="bfQuantity" min="1" placeholder="1" value="1" oninput="calculateBoardFeet()">
                            <span class="unit">pieces</span>
                        </div>
                    </div>
                    <div class="calc-result">
                        <div class="result-display" id="boardFootResult">Enter item details above</div>
                        <div class="cart-actions">
                            <button class="btn btn-primary btn-sm" onclick="addToLumberCart()">Add to Cart</button>
                            <button class="btn btn-secondary btn-sm" onclick="clearBoardFootForm()">Clear Form</button>
                        </div>
                    </div>
                    
                    <!-- Cart Display Section -->
                    <div class="cart-section">
                        <div id="lumberCartDisplay" class="cart-display">
                            <div class="result-placeholder">No items in cart</div>
                        </div>
                        <div class="cart-bottom-actions">
                            <button class="btn btn-success btn-sm" onclick="saveLumberCartToProject()" id="saveCartBtn" disabled>Save Cart to Project</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Golden Ratio Calculator -->
            <div class="calc-card" id="goldenRatioCard">
                <div class="calc-card-header" onclick="toggleCalcCard('goldenRatio')">
                    <span class="calc-icon">‚ú®</span>
                    <span class="calc-title">Golden Ratio Calculator</span>
                    <span class="calc-arrow">‚ñº</span>
                </div>
                <div class="calc-card-content" id="goldenRatioContent">
                    <div class="calc-description">Find proportional dimensions using the golden ratio (1.618)</div>
                    <div class="calc-visual" id="goldenDiagramContainer">
                        <svg width="100%" height="200" viewBox="0 0 400 200" style="max-width: 400px; margin: 0 auto; display: block;">
                            <!-- Grid pattern background -->
                            <defs>
                                <pattern id="grGrid" width="20" height="20" patternUnits="userSpaceOnUse">
                                    <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#e0e0e0" stroke-width="0.5"/>
                                </pattern>
                                <!-- Golden gradient -->
                                <linearGradient id="goldenGrad1" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#FFD700;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#FFA500;stop-opacity:1" />
                                </linearGradient>
                                <linearGradient id="goldenGrad2" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#F0E68C;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#DAA520;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                            <rect width="400" height="200" fill="url(#grGrid)" />
                            
                            <!-- Golden Rectangle -->
                            <g transform="translate(80, 50)">
                                <!-- Smaller section (1) -->
                                <rect x="0" y="0" width="94" height="100" fill="url(#goldenGrad1)" stroke="var(--primary-color)" stroke-width="2"/>
                                <!-- Larger section (1.618) -->
                                <rect x="94" y="0" width="152" height="100" fill="url(#goldenGrad2)" stroke="var(--primary-color)" stroke-width="2"/>
                                
                                <!-- Spiral guide lines -->
                                <line x1="94" y1="0" x2="94" y2="100" stroke="var(--primary-color)" stroke-width="2"/>
                                
                                <!-- Labels -->
                                <text x="47" y="120" text-anchor="middle" font-size="14" font-weight="bold" fill="#333">1</text>
                                <text x="170" y="120" text-anchor="middle" font-size="14" font-weight="bold" fill="#333">1.618</text>
                                
                                <!-- Dimension arrows -->
                                <path d="M 0 -10 L 94 -10 M 0 -10 L 5 -13 M 0 -10 L 5 -7 M 94 -10 L 89 -13 M 94 -10 L 89 -7" stroke="#666" stroke-width="1" fill="none"/>
                                <path d="M 94 -10 L 246 -10 M 94 -10 L 99 -13 M 94 -10 L 99 -7 M 246 -10 L 241 -13 M 246 -10 L 241 -7" stroke="#666" stroke-width="1" fill="none"/>
                            </g>
                            
                            <!-- Title -->
                            <text x="200" y="30" text-anchor="middle" font-size="16" font-weight="bold" fill="var(--primary-color)">Golden Ratio</text>
                            <text x="200" y="180" text-anchor="middle" font-size="12" fill="#666">Perfect proportions for aesthetic design</text>
                        </svg>
                    </div>
                    <div class="calc-inputs">
                        <div class="calc-mode-selector">
                            <button class="mode-btn active" onclick="setGoldenMode('short')" id="goldenModeShort">Short ‚Üí Long</button>
                            <button class="mode-btn" onclick="setGoldenMode('long')" id="goldenModeLong">Long ‚Üí Short</button>
                        </div>
                        <div class="input-row">
                            <label id="goldenInputLabel">Known dimension:</label>
                            <input type="number" id="grFeet" placeholder="0" min="0" class="wide-input" onchange="calculateGoldenRatioNew()">
                            <span>ft</span>
                            <input type="number" id="grInches" placeholder="0" min="0" max="11" class="wide-input" onchange="calculateGoldenRatioNew()">
                            <span>in</span>
                            <select id="grFraction" style="width: 120px;" onchange="calculateGoldenRatioNew()">
                                <option value="0">0</option>
                                <option value="0.0625">1/16"</option>
                                <option value="0.125">1/8"</option>
                                <option value="0.1875">3/16"</option>
                                <option value="0.25">1/4"</option>
                                <option value="0.3125">5/16"</option>
                                <option value="0.375">3/8"</option>
                                <option value="0.4375">7/16"</option>
                                <option value="0.5">1/2"</option>
                                <option value="0.5625">9/16"</option>
                                <option value="0.625">5/8"</option>
                                <option value="0.6875">11/16"</option>
                                <option value="0.75">3/4"</option>
                                <option value="0.8125">13/16"</option>
                                <option value="0.875">7/8"</option>
                                <option value="0.9375">15/16"</option>
                            </select>
                        </div>
                    </div>
                    <div class="calc-result">
                        <div class="result-display" id="grResult">Enter a dimension to calculate</div>
                        <button class="btn btn-success btn-sm" onclick="saveGoldenRatioToProject()">Save to Project</button>
                    </div>
                </div>
            </div>

            <!-- Shelf & Division Calculator -->
            <div class="calc-card" id="spacingCard">
                <div class="calc-card-header" onclick="toggleCalcCard('spacing')">
                    <span class="calc-icon">üìê</span>
                    <span class="calc-title">Shelf & Division Calculator</span>
                    <span class="calc-arrow">‚ñº</span>
                </div>
                <div class="calc-card-content" id="spacingContent">
                    <div class="calc-description">Calculate shelf spacing and divisions for woodworking projects</div>
                    <div class="calc-inputs">
                        <div class="input-row">
                            <label>Total Length:</label>
                            <input type="number" id="spTotalLengthFeet" placeholder="4" min="0" class="wide-input" oninput="calculateSpacing()">
                            <span>ft</span>
                            <input type="number" id="spTotalLengthInches" placeholder="0" min="0" max="11" class="wide-input" oninput="calculateSpacing()">
                            <span>in</span>
                            <select id="spTotalLengthFraction" style="width: 120px;" oninput="calculateSpacing()">
                                <option value="0" selected>0</option>
                            </select>
                        </div>
                        <div class="input-row">
                            <label>Number of Shelves:</label>
                            <input type="number" id="spNumShelves" min="1" placeholder="5" oninput="calculateSpacing()">
                            <span class="unit">shelves</span>
                        </div>
                        <div class="input-row">
                            <label>Material Thickness:</label>
                            <input type="number" id="spacingThicknessFeet" placeholder="0" min="0" class="wide-input" oninput="calculateSpacing()">
                            <span>ft</span>
                            <input type="number" id="spacingThicknessInches" placeholder="0" min="0" max="11" class="wide-input" oninput="calculateSpacing()">
                            <span>in</span>
                            <select id="spacingThicknessFraction" style="width: 120px;" oninput="calculateSpacing()">
                                <option value="0.75" selected>3/4"</option>
                            </select>
                        </div>
                    </div>
                    <div class="calc-result">
                        <div class="result-display" id="spResult">Enter dimensions to calculate</div>
                        <button class="btn btn-success btn-sm" onclick="saveSpacingToProject()">Save to Project</button>
                    </div>
                    <div class="calc-visual">
                        <div style="max-height: 700px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; background: #f8f9fa;">
                            <svg id="spacingDiagram" width="100%" height="800" viewBox="0 0 1000 800" style="min-width: 800px; margin: 0 auto; display: block;">
                            <!-- Grid pattern background -->
                            <defs>
                                <pattern id="spacingGrid" width="20" height="20" patternUnits="userSpaceOnUse">
                                    <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#e0e0e0" stroke-width="0.5"/>
                                </pattern>
                                <!-- Wood grain pattern for cabinet -->
                                <pattern id="cabinetWood" patternUnits="userSpaceOnUse" width="120" height="30">
                                    <rect width="120" height="30" fill="#F5DEB3"/>
                                    <path d="M0,5 Q30,3 60,5 T120,5" stroke="#DDD0A5" stroke-width="0.8" fill="none"/>
                                    <path d="M0,15 Q20,12 40,15 T120,15" stroke="#E6D8B5" stroke-width="1" fill="none"/>
                                    <path d="M0,25 Q40,22 80,25 T120,25" stroke="#DDD0A5" stroke-width="0.9" fill="none"/>
                                </pattern>
                            </defs>
                            <rect width="400" height="400" fill="url(#spacingGrid)" />
                            
                            <!-- Cabinet frame (will be updated dynamically) -->
                            <g id="cabinetFrame">
                                <rect x="100" y="50" width="120" height="280" fill="url(#cabinetWood)" stroke="var(--primary-color)" stroke-width="3" rx="4"/>
                                
                                <!-- Default message -->
                                <text x="200" y="200" text-anchor="middle" font-size="14" fill="#666">
                                    Enter dimensions to see cabinet layout
                                </text>
                            </g>
                            
                            <!-- Shelves group (will be populated dynamically) -->
                            <g id="shelvesGroup">
                                <!-- Dynamic shelves will be added here -->
                            </g>
                            
                            <!-- Measurements group (will be populated dynamically) -->
                            <g id="measurementsGroup">
                                <text x="80" y="60" text-anchor="end" font-size="12" fill="var(--primary-color)" font-weight="bold">0"</text>
                                <text x="80" y="340" text-anchor="end" font-size="12" fill="var(--primary-color)" font-weight="bold">Total</text>
                            </g>
                            
                            <!-- Title -->
                            <text x="500" y="35" text-anchor="middle" font-size="18" font-weight="bold" fill="var(--primary-color)">Cabinet Layout</text>
                            <text x="500" y="780" text-anchor="middle" font-size="14" fill="#666">Vertical spacing visualization</text>
                        </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Miter Angle Calculator -->
            <div class="calc-card" id="angleCard">
                <div class="calc-card-header" onclick="toggleCalcCard('angle')">
                    <span class="calc-icon">üìê</span>
                    <span class="calc-title">Miter Angle Calculator</span>
                    <span class="calc-arrow">‚ñº</span>
                </div>
                <div class="calc-card-content" id="angleContent">
                    <div class="calc-description">Calculate miter angles for polygons and frames</div>
                    <div class="calc-visual" id="angleDiagramContainer">
                        <svg width="100%" height="200" viewBox="0 0 400 200" style="max-width: 400px; margin: 0 auto; display: block;">
                            <!-- Grid pattern background -->
                            <defs>
                                <pattern id="angleGrid" width="20" height="20" patternUnits="userSpaceOnUse">
                                    <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#e0e0e0" stroke-width="0.5"/>
                                </pattern>
                                <!-- Wood texture for polygon -->
                                <pattern id="woodTexture" patternUnits="userSpaceOnUse" width="60" height="60">
                                    <rect width="60" height="60" fill="#F5DEB3"/>
                                    <path d="M0,10 Q15,8 30,10 T60,10" stroke="#E6D8B5" stroke-width="1" fill="none"/>
                                    <path d="M0,25 Q20,22 40,25 T60,25" stroke="#DDD0A5" stroke-width="1.2" fill="none"/>
                                    <path d="M0,40 Q10,38 20,40 T60,40" stroke="#E6D8B5" stroke-width="0.8" fill="none"/>
                                    <path d="M0,55 Q25,52 50,55 T60,55" stroke="#DDD0A5" stroke-width="1" fill="none"/>
                                </pattern>
                            </defs>
                            <rect width="400" height="200" fill="url(#angleGrid)" />
                            
                            <!-- Default polygon (square) -->
                            <g id="polygonGroup" transform="translate(200, 100)">
                                <polygon id="miterPolygon" points="-60,-60 60,-60 60,60 -60,60" 
                                    fill="url(#woodTexture)" 
                                    stroke="var(--primary-color)" 
                                    stroke-width="3"/>
                                
                                <!-- Miter angle indicators -->
                                <g id="miterAngles">
                                    <!-- Will be populated dynamically -->
                                </g>
                            </g>
                            
                            <!-- Labels -->
                            <text x="200" y="20" text-anchor="middle" font-size="14" font-weight="bold" fill="var(--primary-color)">
                                <tspan id="sidesLabel">4 Sides</tspan>
                            </text>
                            <text x="200" y="185" text-anchor="middle" font-size="12" fill="#666">
                                <tspan id="angleLabel">Miter Angle: 45¬∞</tspan>
                            </text>
                        </svg>
                    </div>
                    <div class="calc-inputs">
                        <div class="calc-mode-selector">
                            <button class="mode-btn active" onclick="setMiterMode('polygon')" id="miterModePolygon">Polygon</button>
                            <button class="mode-btn" onclick="setMiterMode('frame')" id="miterModeFrame">Frame Builder</button>
                            <button class="mode-btn" onclick="setMiterMode('single')" id="miterModeSingle">Single Board Cut</button>
                        </div>
                        
                        <div id="polygonMiterInputs">
                            <div class="input-row">
                                <label>Number of Sides:</label>
                                <input type="number" id="maSides" min="3" max="20" placeholder="4" value="4" oninput="calculateMiterAngle()">
                                <span class="unit">sides</span>
                            </div>
                            <div class="preset-buttons">
                                <button class="preset-btn" onclick="setAngleSides(3)">Triangle</button>
                                <button class="preset-btn" onclick="setAngleSides(4)">Square</button>
                                <button class="preset-btn" onclick="setAngleSides(6)">Hexagon</button>
                                <button class="preset-btn" onclick="setAngleSides(8)">Octagon</button>
                            </div>
                        </div>
                        
                        <div id="singleMiterInputs" style="display: none;">
                            <div class="input-row">
                                <label>Miter Angle:</label>
                                <input type="number" id="singleMiterAngle" step="0.5" placeholder="45" oninput="calculateSingleMiter()">
                                <span class="unit">degrees</span>
                            </div>
                            <div class="input-row">
                                <label>Board Width:</label>
                                <input type="number" id="singleBoardWidthFeet" placeholder="0" min="0" class="wide-input" onchange="calculateSingleMiter()">
                                <span>ft</span>
                                <input type="number" id="singleBoardWidthInches" placeholder="3" min="0" max="11" class="wide-input" onchange="calculateSingleMiter()">
                                <span>in</span>
                                <select id="singleBoardWidthFraction" style="width: 120px;" onchange="calculateSingleMiter()">
                                    <option value="0" selected>0</option>
                                    <option value="0.0625">1/16"</option>
                                    <option value="0.125">1/8"</option>
                                    <option value="0.1875">3/16"</option>
                                    <option value="0.25">1/4"</option>
                                    <option value="0.3125">5/16"</option>
                                    <option value="0.375">3/8"</option>
                                    <option value="0.4375">7/16"</option>
                                    <option value="0.5">1/2"</option>
                                    <option value="0.5625">9/16"</option>
                                    <option value="0.625">5/8"</option>
                                    <option value="0.6875">11/16"</option>
                                    <option value="0.75">3/4"</option>
                                    <option value="0.8125">13/16"</option>
                                    <option value="0.875">7/8"</option>
                                    <option value="0.9375">15/16"</option>
                                </select>
                            </div>
                            <div class="input-row">
                                <label>Cut Type:</label>
                                <select id="singleCutType" onchange="calculateSingleMiter()">
                                    <option value="one-sided">One-sided (cut one end only)</option>
                                    <option value="dual-sided">Dual-sided (cut both ends)</option>
                                </select>
                            </div>
                            <div class="input-row">
                                <label>Known Side:</label>
                                <select id="singleKnownSide" onchange="calculateSingleMiter()">
                                    <option value="long">Long side (back)</option>
                                    <option value="short">Short side (front)</option>
                                </select>
                            </div>
                            <div class="input-row">
                                <label id="singleInputLabel">Long side length:</label>
                                <input type="number" id="singleInputLengthFeet" placeholder="1" min="0" class="wide-input" onchange="calculateSingleMiter()">
                                <span>ft</span>
                                <input type="number" id="singleInputLengthInches" placeholder="0" min="0" max="11" class="wide-input" onchange="calculateSingleMiter()">
                                <span>in</span>
                                <select id="singleInputLengthFraction" style="width: 120px;" onchange="calculateSingleMiter()">
                                    <option value="0" selected>0</option>
                                    <option value="0.0625">1/16"</option>
                                    <option value="0.125">1/8"</option>
                                    <option value="0.1875">3/16"</option>
                                    <option value="0.25">1/4"</option>
                                    <option value="0.3125">5/16"</option>
                                    <option value="0.375">3/8"</option>
                                    <option value="0.4375">7/16"</option>
                                    <option value="0.5">1/2"</option>
                                    <option value="0.5625">9/16"</option>
                                    <option value="0.625">5/8"</option>
                                    <option value="0.6875">11/16"</option>
                                    <option value="0.75">3/4"</option>
                                    <option value="0.8125">13/16"</option>
                                    <option value="0.875">7/8"</option>
                                    <option value="0.9375">15/16"</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Frame Builder Inputs -->
                        <div id="frameMiterInputs" style="display: none;">
                            <div class="input-row">
                                <label>Frame Shape:</label>
                                <select id="frameShapeSides" onchange="updateFrameDimensionLabels(); calculateFrameBuilder()">
                                    <option value="4" selected>Rectangle/Square</option>
                                    <option value="3">Triangle</option>
                                    <option value="6">Hexagon</option>
                                    <option value="8">Octagon</option>
                                    <option value="5">Pentagon</option>
                                    <option value="7">Heptagon</option>
                                </select>
                            </div>
                            
                            <div class="input-row">
                                <label>Material Width:</label>
                                <input type="number" id="frameMaterialWidthFeet" placeholder="0" min="0" class="wide-input" onchange="calculateFrameBuilder()">
                                <span>ft</span>
                                <input type="number" id="frameMaterialWidthInches" placeholder="2" min="0" max="11" class="wide-input" onchange="calculateFrameBuilder()">
                                <span>in</span>
                                <select id="frameMaterialWidthFraction" style="width: 120px;" onchange="calculateFrameBuilder()">
                                    <option value="0" selected>0</option>
                                    <option value="0.0625">1/16"</option>
                                    <option value="0.125">1/8"</option>
                                    <option value="0.1875">3/16"</option>
                                    <option value="0.25">1/4"</option>
                                    <option value="0.3125">5/16"</option>
                                    <option value="0.375">3/8"</option>
                                    <option value="0.4375">7/16"</option>
                                    <option value="0.5">1/2"</option>
                                    <option value="0.5625">9/16"</option>
                                    <option value="0.625">5/8"</option>
                                    <option value="0.6875">11/16"</option>
                                    <option value="0.75">3/4"</option>
                                    <option value="0.8125">13/16"</option>
                                    <option value="0.875">7/8"</option>
                                    <option value="0.9375">15/16"</option>
                                </select>
                            </div>
                            
                            <div class="input-row">
                                <label>Target Dimensions:</label>
                                <select id="frameDimensionType" onchange="updateFrameDimensionLabels(); calculateFrameBuilder()">
                                    <option value="inside" selected>Inside Dimensions (opening size)</option>
                                    <option value="outside">Outside Dimensions (frame outer edge)</option>
                                </select>
                            </div>
                            
                            <!-- Rectangle/Square Dimensions -->
                            <div id="frameRectangleDimensions">
                                <div class="input-row">
                                    <label id="frameWidthLabel">Inside Width:</label>
                                    <input type="number" id="frameWidthFeet" placeholder="0" min="0" class="wide-input" onchange="calculateFrameBuilder()">
                                    <span>ft</span>
                                    <input type="number" id="frameWidthInches" placeholder="8" min="0" max="11" class="wide-input" onchange="calculateFrameBuilder()">
                                    <span>in</span>
                                    <select id="frameWidthFraction" style="width: 120px;" onchange="calculateFrameBuilder()">
                                        <option value="0" selected>0</option>
                                        <option value="0.0625">1/16"</option>
                                        <option value="0.125">1/8"</option>
                                        <option value="0.1875">3/16"</option>
                                        <option value="0.25">1/4"</option>
                                        <option value="0.3125">5/16"</option>
                                        <option value="0.375">3/8"</option>
                                        <option value="0.4375">7/16"</option>
                                        <option value="0.5">1/2"</option>
                                        <option value="0.5625">9/16"</option>
                                        <option value="0.625">5/8"</option>
                                        <option value="0.6875">11/16"</option>
                                        <option value="0.75">3/4"</option>
                                        <option value="0.8125">13/16"</option>
                                        <option value="0.875">7/8"</option>
                                        <option value="0.9375">15/16"</option>
                                    </select>
                                </div>
                                <div class="input-row">
                                    <label id="frameHeightLabel">Inside Height:</label>
                                    <input type="number" id="frameHeightFeet" placeholder="0" min="0" class="wide-input" onchange="calculateFrameBuilder()">
                                    <span>ft</span>
                                    <input type="number" id="frameHeightInches" placeholder="10" min="0" max="11" class="wide-input" onchange="calculateFrameBuilder()">
                                    <span>in</span>
                                    <select id="frameHeightFraction" style="width: 120px;" onchange="calculateFrameBuilder()">
                                        <option value="0" selected>0</option>
                                        <option value="0.0625">1/16"</option>
                                        <option value="0.125">1/8"</option>
                                        <option value="0.1875">3/16"</option>
                                        <option value="0.25">1/4"</option>
                                        <option value="0.3125">5/16"</option>
                                        <option value="0.375">3/8"</option>
                                        <option value="0.4375">7/16"</option>
                                        <option value="0.5">1/2"</option>
                                        <option value="0.5625">9/16"</option>
                                        <option value="0.625">5/8"</option>
                                        <option value="0.6875">11/16"</option>
                                        <option value="0.75">3/4"</option>
                                        <option value="0.8125">13/16"</option>
                                        <option value="0.875">7/8"</option>
                                        <option value="0.9375">15/16"</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Regular Polygon Dimensions (for non-rectangles) -->
                            <div id="framePolygonDimensions" style="display: none;">
                                <div class="input-row">
                                    <label id="framePolygonLabel">Inside Side Length:</label>
                                    <input type="number" id="framePolygonFeet" placeholder="0" min="0" class="wide-input" onchange="calculateFrameBuilder()">
                                    <span>ft</span>
                                    <input type="number" id="framePolygonInches" placeholder="12" min="0" max="11" class="wide-input" onchange="calculateFrameBuilder()">
                                    <span>in</span>
                                    <select id="framePolygonFraction" style="width: 120px;" onchange="calculateFrameBuilder()">
                                        <option value="0" selected>0</option>
                                        <option value="0.0625">1/16"</option>
                                        <option value="0.125">1/8"</option>
                                        <option value="0.1875">3/16"</option>
                                        <option value="0.25">1/4"</option>
                                        <option value="0.3125">5/16"</option>
                                        <option value="0.375">3/8"</option>
                                        <option value="0.4375">7/16"</option>
                                        <option value="0.5">1/2"</option>
                                        <option value="0.5625">9/16"</option>
                                        <option value="0.625">5/8"</option>
                                        <option value="0.6875">11/16"</option>
                                        <option value="0.75">3/4"</option>
                                        <option value="0.8125">13/16"</option>
                                        <option value="0.875">7/8"</option>
                                        <option value="0.9375">15/16"</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="calc-result">
                        <div class="result-display" id="maResult">Miter angle: 45¬∞</div>
                        <button class="btn btn-success btn-sm" onclick="saveAngleToProject()">Save to Project</button>
                    </div>
                </div>
            </div>

            <!-- Screw & Pilot Hole Calculator -->
            <div class="calc-card" id="screwCard">
                <div class="calc-card-header" onclick="toggleCalcCard('screw')">
                    <span class="calc-icon">üî©</span>
                    <span class="calc-title">Screw & Pilot Hole Calculator</span>
                    <span class="calc-arrow">‚ñº</span>
                </div>
                <div class="calc-card-content" id="screwContent">
                    <div class="calc-description">Find the correct pilot hole, clearance hole, and countersink sizes for any screw</div>
                    
                    <!-- Screw Identification Section -->
                    <div class="screw-identification">
                        <h4>Step 1: Identify Your Screw</h4>
                        <div class="identification-tabs">
                            <button class="id-tab active" onclick="setScrewIdMode('visual')" id="visualIdTab">üìè Visual Size</button>
                            <button class="id-tab" onclick="setScrewIdMode('common')" id="commonIdTab">üîß Common Types</button>
                            <button class="id-tab" onclick="setScrewIdMode('measure')" id="measureIdTab">üìê Measure</button>
                        </div>

                        <!-- Visual Size Identification -->
                        <div id="visualIdContent" class="id-content">
                            <!-- Calibration Guide -->
                            <div class="zoom-calibration">
                                <p><strong>‚ö†Ô∏è Calibration Required:</strong> Adjust your browser zoom so this line measures exactly 1 inch:</p>
                                <div class="calibration-ruler">
                                    <div class="inch-line"></div>
                                    <span class="ruler-label">1 inch reference</span>
                                </div>
                                <p class="calibration-note">Use Ctrl/Cmd + Plus/Minus to adjust zoom until the line above measures 1" with a ruler</p>
                            </div>
                            
                            <p style="margin-bottom: 15px;">Once calibrated, hold your screw up to these circles to find the matching diameter:</p>
                            
                            <!-- Standard Wood Screws -->
                            <h5 style="margin: 15px 0 10px 0; color: var(--primary-color);">üìå Standard Wood Screws</h5>
                            <div class="screw-size-circles">
                                <div class="size-circle-container">
                                    <div class="size-circle" data-size="0.086" data-name="#2" style="width: 8.2px; height: 8.2px;"></div>
                                    <span class="size-label">#2<br>(0.086")</span>
                                </div>
                                <div class="size-circle-container">
                                    <div class="size-circle" data-size="0.099" data-name="#3" style="width: 9.5px; height: 9.5px;"></div>
                                    <span class="size-label">#3<br>(0.099")</span>
                                </div>
                                <div class="size-circle-container">
                                    <div class="size-circle" data-size="0.112" data-name="#4" style="width: 10.8px; height: 10.8px;"></div>
                                    <span class="size-label">#4<br>(0.112")</span>
                                </div>
                                <div class="size-circle-container">
                                    <div class="size-circle" data-size="0.125" data-name="#5" style="width: 12px; height: 12px;"></div>
                                    <span class="size-label">#5<br>(0.125")</span>
                                </div>
                                <div class="size-circle-container">
                                    <div class="size-circle" data-size="0.138" data-name="#6" style="width: 13.2px; height: 13.2px;"></div>
                                    <span class="size-label">#6<br>(0.138")</span>
                                </div>
                                <div class="size-circle-container">
                                    <div class="size-circle" data-size="0.151" data-name="#7" style="width: 14.5px; height: 14.5px;"></div>
                                    <span class="size-label">#7<br>(0.151")</span>
                                </div>
                                <div class="size-circle-container">
                                    <div class="size-circle" data-size="0.164" data-name="#8" style="width: 15.7px; height: 15.7px;"></div>
                                    <span class="size-label">#8<br>(0.164")</span>
                                </div>
                                <div class="size-circle-container">
                                    <div class="size-circle" data-size="0.177" data-name="#9" style="width: 17px; height: 17px;"></div>
                                    <span class="size-label">#9<br>(0.177")</span>
                                </div>
                            </div>
                            
                            <div class="screw-size-circles" style="margin-top: 10px;">
                                <div class="size-circle-container">
                                    <div class="size-circle" data-size="0.190" data-name="#10" style="width: 18.2px; height: 18.2px;"></div>
                                    <span class="size-label">#10<br>(0.190")</span>
                                </div>
                                <div class="size-circle-container">
                                    <div class="size-circle" data-size="0.203" data-name="#11" style="width: 19.5px; height: 19.5px;"></div>
                                    <span class="size-label">#11<br>(0.203")</span>
                                </div>
                                <div class="size-circle-container">
                                    <div class="size-circle" data-size="0.216" data-name="#12" style="width: 20.7px; height: 20.7px;"></div>
                                    <span class="size-label">#12<br>(0.216")</span>
                                </div>
                                <div class="size-circle-container">
                                    <div class="size-circle" data-size="0.242" data-name="#14" style="width: 23.2px; height: 23.2px;"></div>
                                    <span class="size-label">#14<br>(0.242")</span>
                                </div>
                                <div class="size-circle-container">
                                    <div class="size-circle" data-size="0.25" data-name="1/4" style="width: 24px; height: 24px;"></div>
                                    <span class="size-label">1/4"<br>(0.25")</span>
                                </div>
                                <div class="size-circle-container">
                                    <div class="size-circle" data-size="0.3125" data-name="5/16" style="width: 30px; height: 30px;"></div>
                                    <span class="size-label">5/16"<br>(0.313")</span>
                                </div>
                                <div class="size-circle-container">
                                    <div class="size-circle" data-size="0.375" data-name="3/8" style="width: 36px; height: 36px;"></div>
                                    <span class="size-label">3/8"<br>(0.375")</span>
                                </div>
                            </div>
                            
                            <!-- Lag Bolts/Screws -->
                            <h5 style="margin: 20px 0 10px 0; color: var(--primary-color);">‚ö° Lag Bolts/Heavy Duty Screws</h5>
                            <div class="screw-size-circles lag-bolts">
                                <div class="size-circle-container">
                                    <div class="size-circle lag-bolt" data-size="0.375" data-name="3/8 Lag" style="width: 36px; height: 36px;"></div>
                                    <span class="size-label">3/8" Lag<br>(0.375")</span>
                                </div>
                                <div class="size-circle-container">
                                    <div class="size-circle lag-bolt" data-size="0.4375" data-name="7/16 Lag" style="width: 42px; height: 42px;"></div>
                                    <span class="size-label">7/16" Lag<br>(0.438")</span>
                                </div>
                                <div class="size-circle-container">
                                    <div class="size-circle lag-bolt" data-size="0.5" data-name="1/2 Lag" style="width: 48px; height: 48px;"></div>
                                    <span class="size-label">1/2" Lag<br>(0.5")</span>
                                </div>
                                <div class="size-circle-container">
                                    <div class="size-circle lag-bolt" data-size="0.625" data-name="5/8 Lag" style="width: 60px; height: 60px;"></div>
                                    <span class="size-label">5/8" Lag<br>(0.625")</span>
                                </div>
                                <div class="size-circle-container">
                                    <div class="size-circle lag-bolt" data-size="0.75" data-name="3/4 Lag" style="width: 72px; height: 72px;"></div>
                                    <span class="size-label">3/4" Lag<br>(0.75")</span>
                                </div>
                            </div>
                        </div>

                        <!-- Common Types Identification -->
                        <div id="commonIdContent" class="id-content" style="display: none;">
                            <h5 style="margin: 10px 0; color: var(--primary-color);">üî© Standard Screws</h5>
                            <div class="common-screw-grid">
                                <button class="common-screw-btn" onclick="selectCommonScrew('#6', 'hinge')">
                                    <strong>Hinge Screw #6</strong><br>
                                    <small>Cabinet hardware, hinges</small>
                                </button>
                                <button class="common-screw-btn" onclick="selectCommonScrew('#8', 'wood')">
                                    <strong>Wood Screw #8</strong><br>
                                    <small>Most common cabinet/furniture</small>
                                </button>
                                <button class="common-screw-btn" onclick="selectCommonScrew('#8', 'drywall')">
                                    <strong>Drywall Screw #8</strong><br>
                                    <small>Fine thread, sharp point</small>
                                </button>
                                <button class="common-screw-btn" onclick="selectCommonScrew('#10', 'wood')">
                                    <strong>Wood Screw #10</strong><br>
                                    <small>Heavy furniture, 2x4 construction</small>
                                </button>
                                <button class="common-screw-btn" onclick="selectCommonScrew('#10', 'deck')">
                                    <strong>Deck Screw #10</strong><br>
                                    <small>Exterior construction</small>
                                </button>
                                <button class="common-screw-btn" onclick="selectCommonScrew('#12', 'structural')">
                                    <strong>Structural Screw #12</strong><br>
                                    <small>Heavy-duty construction</small>
                                </button>
                                <button class="common-screw-btn" onclick="selectCommonScrew('pocket', 'kreg')">
                                    <strong>Pocket Screw</strong><br>
                                    <small>Kreg jig screws (2-1/2")</small>
                                </button>
                                <button class="common-screw-btn" onclick="selectCommonScrew('1/4', 'machine')">
                                    <strong>1/4" Machine Screw</strong><br>
                                    <small>Threaded hardware</small>
                                </button>
                            </div>
                            
                            <h5 style="margin: 20px 0 10px 0; color: var(--primary-color);">‚ö° Lag Bolts & Heavy Duty</h5>
                            <div class="common-screw-grid">
                                <button class="common-screw-btn lag-btn" onclick="selectCommonScrew('3/8lag', 'lag')">
                                    <strong>3/8" Lag Bolt</strong><br>
                                    <small>Medium structural connections</small>
                                </button>
                                <button class="common-screw-btn lag-btn" onclick="selectCommonScrew('1/2lag', 'lag')">
                                    <strong>1/2" Lag Bolt</strong><br>
                                    <small>Heavy structural, deck posts</small>
                                </button>
                                <button class="common-screw-btn lag-btn" onclick="selectCommonScrew('5/8lag', 'lag')">
                                    <strong>5/8" Lag Bolt</strong><br>
                                    <small>Heavy timber framing</small>
                                </button>
                                <button class="common-screw-btn lag-btn" onclick="selectCommonScrew('3/4lag', 'lag')">
                                    <strong>3/4" Lag Bolt</strong><br>
                                    <small>Massive structural connections</small>
                                </button>
                            </div>
                        </div>

                        <!-- Manual Measurement -->
                        <div id="measureIdContent" class="id-content" style="display: none;">
                            <div class="measurement-units">
                                <label><input type="radio" name="unit" value="inches" checked onchange="toggleMeasurementUnit()"> Inches</label>
                                <label><input type="radio" name="unit" value="mm" onchange="toggleMeasurementUnit()"> Millimeters</label>
                            </div>
                            <div class="input-row">
                                <label>Screw Diameter:</label>
                                <input type="number" id="screwDiameter" step="0.01" min="0.05" max="0.5" placeholder="0.164">
                                <span id="unitLabel">inches</span>
                            </div>
                            <div class="measurement-help">
                                <small>üí° Measure across the threaded part with calipers or ruler</small>
                            </div>
                        </div>
                    </div>

                    <!-- Selected Screw Display -->
                    <div class="selected-screw" id="selectedScrewDisplay" style="display: none;">
                        <h4>Selected Screw: <span id="selectedScrewType"></span></h4>
                        <div class="screw-specs" id="screwSpecs"></div>
                    </div>

                    <!-- Wood Type Selection -->
                    <div class="wood-selection" id="woodSelection" style="display: none;">
                        <h4>Step 2: Select Wood Type</h4>
                        <div class="wood-type-buttons">
                            <button class="wood-btn" onclick="selectWoodType('softwood')" id="softwoodBtn">
                                üå≤ Softwood<br>
                                <small>Pine, Cedar, Fir</small>
                            </button>
                            <button class="wood-btn" onclick="selectWoodType('hardwood')" id="hardwoodBtn">
                                üå≥ Hardwood<br>
                                <small>Oak, Maple, Cherry</small>
                            </button>
                            <button class="wood-btn" onclick="selectWoodType('plywood')" id="plywoodBtn">
                                üìã Plywood/MDF<br>
                                <small>Composite Materials</small>
                            </button>
                        </div>
                    </div>

                    <!-- Results Display -->
                    <div class="calc-result" id="screwResults" style="display: none;">
                        <h4 style="font-size: 20px; margin-bottom: 20px;">Step 3: Pilot Hole Recommendations</h4>
                        <div class="result-display" id="screwResultDisplay">Select a screw and wood type</div>
                    </div>
                    
                    <!-- Quick Reference Button -->
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="toggleQuickReference()">
                            üìä Quick Reference Table
                        </button>
                    </div>
                    
                    <!-- Quick Reference Table -->
                    <div id="quickReferenceTable" style="display: none; margin-top: 20px;">
                        <div class="reference-table-container">
                            <h4 style="text-align: center; margin-bottom: 15px;">üî© Comprehensive Pilot Hole Reference</h4>
                            <table class="screw-reference-table">
                                <thead>
                                    <tr>
                                        <th rowspan="2">Screw Size</th>
                                        <th rowspan="2">Diameter</th>
                                        <th colspan="3">Pilot Hole Size</th>
                                    </tr>
                                    <tr>
                                        <th>Hardwood</th>
                                        <th>Softwood</th>
                                        <th>Plywood/MDF</th>
                                    </tr>
                                </thead>
                                <tbody id="referenceTableBody">
                                    <!-- Table rows will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Grade/Slope Calculator -->
            <div class="calc-card" id="gradeCard">
                <div class="calc-card-header" onclick="toggleCalcCard('grade')">
                    <span class="calc-icon">üìê</span>
                    <span class="calc-title">Grade/Slope Calculator</span>
                    <span class="calc-arrow">‚ñº</span>
                </div>
                <div class="calc-card-content" id="gradeContent">
                    <div class="calc-description">Calculate slopes for ramps, drainage, and construction projects</div>
                    
                    <!-- Visual Diagram -->
                    <div class="calc-visual">
                        <svg id="slopeDiagram" width="100%" height="200" viewBox="0 0 400 200" style="max-width: 400px; margin: 0 auto; display: block;">
                            <!-- Grid lines -->
                            <defs>
                                <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
                                    <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#e0e0e0" stroke-width="0.5"/>
                                </pattern>
                            </defs>
                            <rect width="400" height="200" fill="url(#grid)" />
                            
                            <!-- Ground line -->
                            <line x1="50" y1="170" x2="350" y2="170" stroke="#666" stroke-width="2"/>
                            
                            <!-- Slope triangle -->
                            <path id="slopeTriangle" d="M 50 170 L 300 170 L 300 100 Z" fill="rgba(139, 69, 19, 0.2)" stroke="var(--primary-color)" stroke-width="3"/>
                            
                            <!-- Rise line -->
                            <line x1="300" y1="170" x2="300" y2="100" stroke="#D2691E" stroke-width="3" stroke-dasharray="5,5"/>
                            
                            <!-- Run line -->
                            <line x1="50" y1="170" x2="300" y2="170" stroke="#228B22" stroke-width="3"/>
                            
                            <!-- Angle arc -->
                            <path id="angleArc" d="M 100 170 A 50 50 0 0 0 85.35 139.65" fill="none" stroke="#FF6347" stroke-width="2"/>
                            
                            <!-- Labels -->
                            <text x="175" y="190" text-anchor="middle" font-size="14" font-weight="bold" fill="#228B22">Run</text>
                            <text x="320" y="135" text-anchor="middle" font-size="14" font-weight="bold" fill="#D2691E">Rise</text>
                            <text x="120" y="160" text-anchor="middle" font-size="12" fill="#FF6347" id="angleLabel">Angle</text>
                            
                            <!-- Result display -->
                            <text x="200" y="30" text-anchor="middle" font-size="16" font-weight="bold" fill="#333" id="gradePercentLabel">Grade: --</text>
                            <text x="200" y="50" text-anchor="middle" font-size="14" fill="#666" id="ratioLabel">Ratio: --</text>
                        </svg>
                    </div>
                    
                    <!-- Calculation Mode -->
                    <div class="calc-mode-selector" style="margin: 20px 0;">
                        <button class="mode-btn active" onclick="setGradeMode('find-grade')" id="gradeModeGrade">Find Grade %</button>
                        <button class="mode-btn" onclick="setGradeMode('find-rise')" id="gradeModeRise">Find Rise</button>
                        <button class="mode-btn" onclick="setGradeMode('find-run')" id="gradeModeRun">Find Run</button>
                    </div>
                    
                    <!-- Input Fields -->
                    <div class="calc-inputs">
                        <!-- Rise Input -->
                        <div id="gradeRiseInput" class="input-row">
                            <label>Rise (Vertical):</label>
                            <input type="number" id="gradeRiseFeet" placeholder="0" min="0" class="wide-input" onchange="calculateGradeSlope()">
                            <span>ft</span>
                            <input type="number" id="gradeRiseInches" placeholder="0" min="0" max="11" class="wide-input" onchange="calculateGradeSlope()">
                            <span>in</span>
                            <select id="gradeRiseFraction" style="width: 120px;" onchange="calculateGradeSlope()">
                                <option value="0" selected>0</option>
                                <option value="0.0625">1/16"</option>
                                <option value="0.125">1/8"</option>
                                <option value="0.1875">3/16"</option>
                                <option value="0.25">1/4"</option>
                                <option value="0.3125">5/16"</option>
                                <option value="0.375">3/8"</option>
                                <option value="0.4375">7/16"</option>
                                <option value="0.5">1/2"</option>
                                <option value="0.5625">9/16"</option>
                                <option value="0.625">5/8"</option>
                                <option value="0.6875">11/16"</option>
                                <option value="0.75">3/4"</option>
                                <option value="0.8125">13/16"</option>
                                <option value="0.875">7/8"</option>
                                <option value="0.9375">15/16"</option>
                            </select>
                        </div>
                        
                        <!-- Run Input -->
                        <div id="gradeRunInput" class="input-row">
                            <label>Run (Horizontal):</label>
                            <input type="number" id="gradeRunFeet" placeholder="0" min="0" class="wide-input" onchange="calculateGradeSlope()">
                            <span>ft</span>
                            <input type="number" id="gradeRunInches" placeholder="0" min="0" max="11" class="wide-input" onchange="calculateGradeSlope()">
                            <span>in</span>
                            <select id="gradeRunFraction" style="width: 120px;" onchange="calculateGradeSlope()">
                                <option value="0" selected>0</option>
                                <option value="0.0625">1/16"</option>
                                <option value="0.125">1/8"</option>
                                <option value="0.1875">3/16"</option>
                                <option value="0.25">1/4"</option>
                                <option value="0.3125">5/16"</option>
                                <option value="0.375">3/8"</option>
                                <option value="0.4375">7/16"</option>
                                <option value="0.5">1/2"</option>
                                <option value="0.5625">9/16"</option>
                                <option value="0.625">5/8"</option>
                                <option value="0.6875">11/16"</option>
                                <option value="0.75">3/4"</option>
                                <option value="0.8125">13/16"</option>
                                <option value="0.875">7/8"</option>
                                <option value="0.9375">15/16"</option>
                            </select>
                        </div>
                        
                        <!-- Grade Input (for find rise/run modes) -->
                        <div id="gradePercentInput" class="input-row" style="display: none;">
                            <label>Grade Percentage:</label>
                            <input type="number" id="gradePercent" placeholder="8.33" step="0.01" min="0" onchange="calculateGradeSlope()">
                            <span>%</span>
                        </div>
                        
                        <!-- Common Use Presets -->
                        <div class="preset-section" style="margin-top: 20px;">
                            <h5 style="margin-bottom: 10px; color: var(--primary-color);">Common Applications:</h5>
                            <div class="preset-buttons" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                <button class="preset-btn" onclick="setGradePreset('ada-max', '1:12 ADA Max (8.33%)')">
                                    <strong>ADA Ramp Max</strong><br>
                                    <small>1:12 (8.33%)</small>
                                </button>
                                <button class="preset-btn" onclick="setGradePreset('ada-preferred', '1:20 ADA Preferred (5%)')">
                                    <strong>ADA Preferred</strong><br>
                                    <small>1:20 (5%)</small>
                                </button>
                                <button class="preset-btn" onclick="setGradePreset('drainage-min', 'Min Drainage (1%)')">
                                    <strong>Min Drainage</strong><br>
                                    <small>1:100 (1%)</small>
                                </button>
                                <button class="preset-btn" onclick="setGradePreset('drainage-ideal', 'Ideal Drainage (2%)')">
                                    <strong>Ideal Drainage</strong><br>
                                    <small>1:50 (2%)</small>
                                </button>
                                <button class="preset-btn" onclick="setGradePreset('driveway-max', 'Driveway Max (15%)')">
                                    <strong>Driveway Max</strong><br>
                                    <small>1:6.67 (15%)</small>
                                </button>
                                <button class="preset-btn" onclick="setGradePreset('shed-ramp', 'Shed Ramp (10%)')">
                                    <strong>Shed Ramp</strong><br>
                                    <small>1:10 (10%)</small>
                                </button>
                                <button class="preset-btn" onclick="setGradePreset('stairs-typical', 'Stairs Typical (70%)')">
                                    <strong>Stairs (35¬∞)</strong><br>
                                    <small>7:10 (70%)</small>
                                </button>
                                <button class="preset-btn" onclick="setGradePreset('roof-min', 'Roof Min 4:12 (33%)')">
                                    <strong>Roof Min</strong><br>
                                    <small>4:12 (33.3%)</small>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Results Display -->
                    <div class="calc-result" id="gradeResults" style="display: none;">
                        <h4>Slope Calculations:</h4>
                        <div class="result-display" id="gradeResultDisplay">
                            <!-- Results will be displayed here -->
                        </div>
                        <button class="btn btn-success btn-sm" onclick="saveGradeToProject()">Save to Project</button>
                    </div>
                </div>
            </div>

            <!-- Wood Species Database -->
            <div class="calc-card" id="woodSpeciesCard">
                <div class="calc-card-header" onclick="toggleCalcCard('woodSpecies')">
                    <span class="calc-icon">üå≥</span>
                    <span class="calc-title">Wood Species Database</span>
                    <span class="calc-arrow">‚ñº</span>
                </div>
                <div class="calc-card-content" id="woodSpeciesContent">
                    <div class="wood-species-container">
                        <!-- Search and Filter Controls -->
                        <div class="wood-controls">
                            <div class="search-row">
                                <input type="text" id="woodSearch" placeholder="Search wood species..." onkeyup="filterWoodSpecies()">
                                <select id="woodFilterUse" onchange="filterWoodSpecies()">
                                    <option value="">All Uses</option>
                                    <option value="furniture">Furniture</option>
                                    <option value="cutting-boards">Cutting Boards</option>
                                    <option value="outdoor">Outdoor Projects</option>
                                    <option value="turning">Turning & Bowls</option>
                                    <option value="carving">Carving</option>
                                    <option value="decorative">Decorative/Exotic</option>
                                    <option value="beginner">Beginner Friendly</option>
                                </select>
                                <select id="woodFilterCost" onchange="filterWoodSpecies()">
                                    <option value="">All Costs</option>
                                    <option value="budget">Budget</option>
                                    <option value="mid">Mid-range</option>
                                    <option value="premium">Premium</option>
                                </select>
                            </div>
                        </div>

                        <!-- Species Grid -->
                        <div class="wood-species-grid" id="woodSpeciesGrid">
                            <!-- Species cards will be generated here -->
                        </div>

                        <!-- Project Wizard -->
                        <div class="project-wizard" style="margin-top: 20px;">
                            <h4>üßô‚Äç‚ôÇÔ∏è Project Wizard</h4>
                            <p>What are you building?</p>
                            <div class="wizard-buttons">
                                <button class="btn btn-secondary" onclick="recommendForProject('dining-table')">üçΩÔ∏è Dining Table</button>
                                <button class="btn btn-secondary" onclick="recommendForProject('cutting-board')">üî™ Cutting Board</button>
                                <button class="btn btn-secondary" onclick="recommendForProject('outdoor-deck')">üè° Outdoor Deck</button>
                                <button class="btn btn-secondary" onclick="recommendForProject('bookshelf')">üìö Bookshelf</button>
                                <button class="btn btn-secondary" onclick="recommendForProject('workbench')">üî® Workbench</button>
                                <button class="btn btn-secondary" onclick="recommendForProject('turning-bowl')">üåÄ Turning/Bowls</button>
                            </div>
                            <div id="projectRecommendations" class="project-recommendations"></div>
                        </div>

                        <!-- Attribution Footer (shown when wood images are loaded) -->
                        <div id="woodImageAttribution" class="wood-attribution-footer" style="
                            display: none;
                            margin-top: 20px;
                            padding: 15px;
                            background: var(--surface-color);
                            border: 1px solid var(--border-color);
                            border-radius: 8px;
                            text-align: center;
                            font-size: 12px;
                            color: var(--text-secondary);
                        ">
                            <div style="margin-bottom: 8px;">
                                üì∏ <strong>Wood grain images courtesy of:</strong>
                            </div>
                            <a href="https://www.wood-database.com/" target="_blank" style="
                                color: var(--primary-color);
                                text-decoration: none;
                                font-weight: bold;
                            ">The Wood Database</a> by Eric Meier
                            <div style="margin-top: 8px; font-size: 11px; opacity: 0.8;">
                                Used with permission ‚Ä¢ Educational use ‚Ä¢ <a href="https://www.wood-database.com/" target="_blank" style="color: var(--primary-color);">Visit Wood Database</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Projects Tab -->
        <div id="projects" class="tab-content">
            <div class="project-timeline-header">
                <div class="project-title-section">
                    <h2 id="projectTimelineTitle">üìÅ Project Timeline</h2>
                    <div class="project-actions">
                        <button class="btn btn-secondary btn-sm" onclick="showProjectNotes()" id="projectNotesBtn" disabled>üìù Notes</button>
                        <button class="btn btn-secondary btn-sm" onclick="exportCurrentProject()" id="projectExportBtn" disabled>üì§ Export</button>
                        <button class="btn btn-secondary btn-sm" onclick="showAllProjects()">üìã All Projects</button>
                    </div>
                </div>
                
                <!-- Project Loader Section -->
                <div class="project-loader-section">
                    <label for="projectTimelineDropdown" class="project-loader-label">View Project:</label>
                    <select id="projectTimelineDropdown" class="project-loader-dropdown" onchange="viewProjectTimeline(this.value)">
                        <option value="">Select a project to view timeline...</option>
                    </select>
                </div>
                
                <!-- Project Info - Only shown when viewing a project -->
                <div class="project-info" id="projectInfo" style="display: none;">
                    <div class="project-dates">
                        <span class="project-date" id="projectCreated">üìÖ Created: --</span>
                        <span class="project-date" id="projectModified">üîÑ Modified: --</span>
                    </div>
                </div>
            </div>
            
            <!-- Project Timeline -->
            <div class="project-timeline-container" id="projectTimelineContainer">
                <div class="no-project-selected" id="noProjectSelected">
                    <div style="text-align: center; padding: 60px 20px; color: #666;">
                        <div style="font-size: 64px; margin-bottom: 20px;">üìä</div>
                        <h3>No Project Selected</h3>
                        <p>Select a project from the "Load Project" dropdown above to view your saved calculations timeline.</p>
                    </div>
                </div>
                
                <div class="project-timeline" id="projectTimeline" style="display: none;">
                    <div class="timeline-content" id="timelineContent">
                        <!-- Timeline items will be dynamically generated here -->
                    </div>
                    
                    <div class="empty-timeline" id="emptyTimeline" style="display: none;">
                        <div style="text-align: center; padding: 40px 20px; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 20px;">üìù</div>
                            <h3>No Saved Calculations Yet</h3>
                            <p>Start using the calculators and click "Save to Project" to build your project timeline!</p>
                            <div style="margin-top: 20px;">
                                <button class="btn btn-primary" onclick="switchTab('calculator')">Go to Calculator</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- All Projects Modal -->
        <div id="allProjectsModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeAllProjectsModal()">&times;</span>
                <h2>üìÅ All Projects</h2>
                <div class="projects-modal-content">
                    <div class="projects-grid-modal" id="projectsGridModal">
                        <!-- Project cards will be dynamically generated here -->
                    </div>
                    <div id="noProjectsModalMessage" class="no-projects" style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 20px;">üìÅ</div>
                        <h3>No Projects Yet</h3>
                        <p>Create your first project and start saving calculations!</p>
                        <button class="btn btn-primary" onclick="createNewProject(); closeAllProjectsModal();">Create Project</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Project Notes Modal -->
        <div id="notesModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeProjectNotes()">&times;</span>
                <h2>üìù Project Notes</h2>
                <div id="notesContent">
                    <p><strong>Project:</strong> <span id="notesProjectName">No project selected</span></p>
                    <textarea id="projectNotesText" placeholder="Add notes about your project - materials needed, measurements, design thoughts, etc." 
                              style="width: 100%; height: 200px; margin: 10px 0; padding: 10px; border: 2px solid var(--secondary-color); border-radius: 5px; font-family: Arial, sans-serif; resize: vertical;"></textarea>
                    <div style="text-align: right; margin-top: 10px;">
                        <button class="btn btn-secondary" onclick="closeProjectNotes()" style="margin-right: 10px;">Cancel</button>
                        <button class="btn btn-success" onclick="saveProjectNotes()">Save Notes</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Save to Project Modal -->
        <div id="saveToProjectModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeSaveToProjectModal()">&times;</span>
                <h2>üíæ Save to Project</h2>
                <div id="saveToProjectContent">
                    <div class="save-preview-section">
                        <h4>What you're saving:</h4>
                        <div id="savePreviewContent" class="save-preview">
                            <!-- Preview content will be populated here -->
                        </div>
                    </div>
                    
                    <div class="save-project-selection">
                        <label for="saveProjectDropdown"><strong>Save to Project:</strong></label>
                        <select id="saveProjectDropdown" style="width: 100%; padding: 8px; margin: 5px 0; border: 2px solid var(--secondary-color); border-radius: 5px;">
                            <option value="">Select a project...</option>
                        </select>
                        <button class="btn btn-primary btn-sm" onclick="createNewProjectFromSaveModal()" style="margin-top: 5px;">+ Create New Project</button>
                    </div>
                    
                    <div class="save-notes-section">
                        <label for="saveNotesText"><strong>Add Notes (optional):</strong></label>
                        <textarea id="saveNotesText" placeholder="Add context about this calculation - what you're building, why this measurement matters, etc." 
                                  style="width: 100%; height: 100px; margin: 5px 0; padding: 10px; border: 2px solid var(--secondary-color); border-radius: 5px; font-family: Arial, sans-serif; resize: vertical;"></textarea>
                    </div>
                    
                    <div style="text-align: right; margin-top: 15px;">
                        <button class="btn btn-secondary" onclick="closeSaveToProjectModal()" style="margin-right: 10px;">Cancel</button>
                        <button class="btn btn-success" onclick="executeSaveToProject()" id="saveToProjectBtn">Save to Project</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Dad Joke Modal -->
        <div id="jokeModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeJoke()">&times;</span>
                <h2>üôÑ Groan Zone - Dad Jokes</h2>
                
                <div id="jokeLoading" style="display: none;">
                    <p>Getting a fresh dad joke... üé£</p>
                </div>
                
                <div id="jokeText" style="display: none;">
                    <!-- Joke content will be inserted here -->
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="fetchDadJoke()" style="margin-right: 10px;">Another One üîÑ</button>
                    <button onclick="closeJoke()">That's Enough üòÖ</button>
                </div>
            </div>
        </div>

        <!-- Help Modal -->
        <div id="helpModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeHelp()">&times;</span>
                <h2>ü™µ WorkShop Pro Calculator Help</h2>
                
                <h3>Calculator Tab</h3>
                <p>Pure math calculations without kerf compensation. Perfect for:</p>
                <ul>
                    <li>Adding multiple board lengths</li>
                    <li>Calculating total project dimensions</li>
                    <li>General measurement conversions</li>
                </ul>
                <p><strong>Input modes:</strong> Toggle between fraction mode (feet/inches/fractions) and decimal mode (decimal inches).</p>
                
                <h3>Cut Calculator Tab</h3>
                <p>Cutting operations with automatic kerf compensation. Features:</p>
                <ul>
                    <li><strong>Quick Cuts:</strong> Cut boards in half, thirds, or fourths with automatic kerf compensation</li>
                    <li><strong>Cut Side of Mark:</strong> Choose if you cut on the left or right side of your pencil mark</li>
                    <li><strong>Kerf Settings:</strong> Select your blade width (1/16" to 3/16")</li>
                </ul>
                <p>The app calculates exactly where to mark your cuts so you get identical pieces after accounting for blade kerf.</p>
                
                <h3>Specialty Calculators Tab</h3>
                <p>Specialized woodworking tools for advanced calculations:</p>
                <ul>
                    <li><strong>Lumber Shopping Cart:</strong> Calculate board feet and lumber costs by species</li>
                    <li><strong>Golden Ratio Calculator:</strong> Find proportional dimensions using the golden ratio (1.618)</li>
                    <li><strong>Shelf & Division Calculator:</strong> Calculate shelf spacing and material divisions</li>
                    <li><strong>Miter Angle Calculator:</strong> Calculate miter angles for polygons, frames, and single cuts</li>
                    <li><strong>Grade/Slope Calculator:</strong> Calculate slopes for ramps, drainage, stairs, and roofing with ADA compliance indicators</li>
                </ul>
                
                <h3>Precision Settings</h3>
                <p>Set your measuring precision (1/32" to 1") - all inputs and outputs will match your tape measure markings.</p>
                
                <h3>Tips</h3>
                <ul>
                    <li>Results automatically convert to feet and inches when appropriate</li>
                    <li>History tracks all your calculations for reference</li>
                    <li>All tabs work offline once loaded</li>
                    <li>Designed for use with work gloves in dusty shop conditions</li>
                </ul>
            </div>
        </div>
        
        <!-- Edit Modal -->
        <div id="editModal" class="edit-modal">
            <div class="edit-modal-content">
                <h3 id="editTitle">Edit Item</h3>
                <div id="editInputs">
                    <!-- Dynamic content will be inserted here -->
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="saveEdit()">Save</button>
                    <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                    <button class="btn btn-secondary" onclick="deleteEdit()" style="background: #cd5c5c; color: white; float: right;">Delete</button>
                </div>
            </div>
        </div>
        
        <!-- Calculation Modal -->
        <div id="calcModal" class="calc-modal">
            <div class="calc-modal-content">
                <span class="close" onclick="closeCalcModal()">&times;</span>
                <h3 id="calcModalTitle">Calculation</h3>
                <div id="calcModalInputs">
                    <!-- Dynamic content will be inserted here -->
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="executeModalCalc()">Calculate</button>
                    <button class="btn btn-secondary" onclick="closeCalcModal()">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Notification element -->
        <div id="notification" class="notification"></div>
    </div>

    <script>
        // =====================================================
        // Theme Management Functions
        // =====================================================
        
        // Load saved theme on page load
        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('woodworking-calculator-theme') || 'wood';
            const themeSelect = document.getElementById('themeSelect');
            if (themeSelect) {
                themeSelect.value = savedTheme;
            }
            applyTheme(savedTheme);
        }
        
        // Apply theme to document body
        function applyTheme(themeName) {
            const body = document.body;
            // Remove all existing theme classes
            body.classList.remove('theme-wood', 'theme-steel', 'theme-dark', 'theme-festool', 'theme-dewalt', 'theme-milwaukee', 'theme-ridgid', 'theme-makita', 'theme-noob');
            
            // Add new theme class (except for default wood theme)
            if (themeName !== 'wood') {
                body.classList.add(`theme-${themeName}`);
            }
            
            // Save theme preference
            localStorage.setItem('woodworking-calculator-theme', themeName);
        }
        
        // Handle theme change from dropdown
        function changeTheme(themeName) {
            applyTheme(themeName);
            showNotification(`Theme changed to ${themeName.charAt(0).toUpperCase() + themeName.slice(1)}`, 'success');
        }
        
        // =====================================================
        // Calculator Variables
        // =====================================================
        
        let currentValueInches = 0;
        let cutValueInches = 0;
        let currentOperation = null;
        let operationValue = 0;
        let history = [];
        let cutHistory = [];
        let lastConversionSource = 'calculator'; // Track whether last action was 'calculator' or 'direct'
        let lastCalculatorUpdate = 0; // Timestamp of last calculator calculation
        let lastDirectInputUpdate = 0; // Timestamp of last direct input
        let boards = []; // Array of {length: number, quantity: number} objects
        let cuts = []; // Array of {length: number, id: unique_id}
        let inputMode = 'fraction';
        let editingItem = null; // Track what we're editing
        let cutIdCounter = 0; // For unique cut IDs
        let memoryValue = 0; // Calculator memory
        let value1 = 0; // First calculator value
        let value2 = 0; // Second calculator value
        let projects = []; // Array to store saved projects
        let currentProject = null; // Currently active project
        let lumberCart = []; // Array to store lumber shopping cart items
        let speciesPrices = {}; // Object to remember prices for each species
        let currentCutResults = []; // Array to store cut results for saving
        
        // Data persistence functions
        function saveToLocalStorage() {
            const data = {
                projects: projects,
                currentProject: currentProject,
                history: history,
                cutHistory: cutHistory,
                memoryValue: memoryValue,
                speciesPrices: speciesPrices,
                settings: {
                    precision: document.getElementById('precision')?.value || 16,
                    cutPrecision: document.getElementById('cutPrecision')?.value || 16,
                    optPrecision: document.getElementById('optPrecision')?.value || 16
                }
            };
            localStorage.setItem('woodworkingCalculator', JSON.stringify(data));
        }
        
        function loadFromLocalStorage() {
            try {
                const data = JSON.parse(localStorage.getItem('woodworkingCalculator'));
                if (data) {
                    projects = data.projects || [];
                    currentProject = data.currentProject || null;
                    // Ensure history arrays contain only strings
                    history = data.history ? data.history.filter(h => h && typeof h === 'string') : [];
                    cutHistory = data.cutHistory ? data.cutHistory.filter(h => h && typeof h === 'string') : [];
                    memoryValue = data.memoryValue || 0;
                    speciesPrices = data.speciesPrices || {};
                    
                    // Restore settings with 1/16" default
                    if (data.settings) {
                        if (document.getElementById('precision')) document.getElementById('precision').value = data.settings.precision || 16;
                        if (document.getElementById('cutPrecision')) document.getElementById('cutPrecision').value = data.settings.cutPrecision || 16;
                        if (document.getElementById('optPrecision')) document.getElementById('optPrecision').value = data.settings.optPrecision || 16;
                    } else {
                        // No saved settings - ensure 1/16" default
                        if (document.getElementById('precision')) document.getElementById('precision').value = 16;
                        if (document.getElementById('cutPrecision')) document.getElementById('cutPrecision').value = 16;
                        if (document.getElementById('optPrecision')) document.getElementById('optPrecision').value = 16;
                    }
                    
                    // Refresh precision settings after loading
                    updatePrecision('calculator');
                    updatePrecision('cut');
                    updatePrecision('optimizer');
                    updateWoodworkingFractions();
                    
                    updateDisplays();
                }
            } catch (error) {
                console.error('Error loading data:', error);
                // Silent error handling - no notification needed
            }
        }
        
        function updateDisplays() {
            updateHistory();
            updateCutHistory();
            updateMemoryIndicator();
            // Project loading notifications removed - silent loading
        }
        
        function updateCalculatorDisplay() {
            // Update calculator display with current values
            const calcResult = document.getElementById('calcResult');
            const calcEquation = document.getElementById('calcEquation');
            
            if (calcResult) {
                calcResult.textContent = inchesToDisplay(currentValueInches, 'calculator');
            }
            
            if (calcEquation && currentOperation) {
                const val1Display = inchesToDisplay(value1, 'calculator');
                calcEquation.textContent = `${val1Display} ${currentOperation}`;
            } else if (calcEquation) {
                calcEquation.innerHTML = '&nbsp;';
            }
            
            // Update input fields
            const feet1 = document.getElementById('feet1');
            const inches1 = document.getElementById('inches1');
            if (feet1 && inches1) {
                const { feet, inches, fraction } = inchesToFeetInches(currentValueInches);
                feet1.value = feet;
                inches1.value = inches;
                
                const fraction1 = document.getElementById('fraction1');
                if (fraction1) {
                    fraction1.value = fraction;
                }
            }
        }
        
        // Project management functions
        function createNewProject() {
            const name = prompt('Enter project name:');
            if (name && name.trim()) {
                const project = {
                    id: Date.now(),
                    name: name.trim(),
                    created: new Date().toISOString(),
                    boards: [...boards],
                    cuts: [...cuts],
                    history: [...history],
                    cutHistory: [...cutHistory],
                    projectLog: [], // New: stores manually saved calculation items
                    calculatorData: {
                        currentValueInches: currentValueInches,
                        cutValueInches: cutValueInches,
                        currentOperation: currentOperation,
                        operationValue: operationValue,
                        memoryValue: memoryValue,
                        value1: value1,
                        value2: value2,
                        inputMode: inputMode
                    },
                    notes: '',
                    tags: []
                };
                projects.push(project);
                currentProject = project;
                saveToLocalStorage();
                showNotification(`Project "${name}" created!`, 'success');
                updateProjectSelector();
                renderProjectsTab();
            }
        }
        
        function saveCurrentProject() {
            if (!currentProject) {
                createNewProject();
                return;
            }
            
            currentProject.boards = [...boards];
            currentProject.cuts = [...cuts];
            currentProject.history = [...history];
            currentProject.cutHistory = [...cutHistory];
            currentProject.calculatorData = {
                currentValueInches: currentValueInches,
                cutValueInches: cutValueInches,
                currentOperation: currentOperation,
                operationValue: operationValue,
                memoryValue: memoryValue,
                value1: value1,
                value2: value2,
                inputMode: inputMode
            };
            currentProject.lastModified = new Date().toISOString();
            
            // Update in projects array
            const index = projects.findIndex(p => p.id === currentProject.id);
            if (index !== -1) {
                projects[index] = currentProject;
            }
            
            saveToLocalStorage();
            renderProjectsTab();
        }
        
        function loadProject(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (project) {
                currentProject = project;
                boards = [...project.boards];
                cuts = [...project.cuts];
                // Ensure history arrays contain only strings
                history = project.history ? project.history.filter(h => h && typeof h === 'string') : [];
                cutHistory = project.cutHistory ? project.cutHistory.filter(h => h && typeof h === 'string') : [];
                
                // Initialize projectLog if it doesn't exist (for older projects)
                if (!project.projectLog) {
                    project.projectLog = [];
                }
                
                // Restore calculator data if available
                if (project.calculatorData) {
                    currentValueInches = project.calculatorData.currentValueInches || 0;
                    cutValueInches = project.calculatorData.cutValueInches || 0;
                    currentOperation = project.calculatorData.currentOperation || null;
                    operationValue = project.calculatorData.operationValue || 0;
                    memoryValue = project.calculatorData.memoryValue || 0;
                    value1 = project.calculatorData.value1 || 0;
                    value2 = project.calculatorData.value2 || 0;
                    inputMode = project.calculatorData.inputMode || 'fraction';
                }
                
                updateDisplays();
                updateBoardDisplay();
                updateCutDisplay();
                updateCalculatorDisplay();
                // Project loaded silently
            }
        }
        
        function deleteProject(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (project && confirm(`Delete project "${project.name}"?`)) {
                projects = projects.filter(p => p.id !== projectId);
                if (currentProject && currentProject.id === projectId) {
                    currentProject = null;
                }
                saveToLocalStorage();
                updateProjectSelector();
                renderProjectsTab();
                showNotification('Project deleted', 'success');
            }
        }
        
        function updateProjectSelector() {
            updateGlobalProjectSelector();
            renderProjectTimeline();
            updateProjectStatusBars();
        }
        
        function updateGlobalProjectSelector() {
            const globalDropdown = document.getElementById('globalProjectDropdown');
            const timelineDropdown = document.getElementById('projectTimelineDropdown');
            
            if (globalDropdown) {
                // Clear existing options
                globalDropdown.innerHTML = '<option value="">No Project Selected</option>';
                
                // Add each project as an option
                projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.name;
                    if (currentProject && currentProject.id === project.id) {
                        option.selected = true;
                    }
                    globalDropdown.appendChild(option);
                });
            }
            
            if (timelineDropdown) {
                // Clear existing options
                timelineDropdown.innerHTML = '<option value="">Select a project to view timeline...</option>';
                
                // Add each project as an option (don't auto-select based on currentProject)
                projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.name;
                    // Only select if this is the currently viewed project, not the active project
                    if (viewedProject && viewedProject.id === project.id) {
                        option.selected = true;
                    }
                    timelineDropdown.appendChild(option);
                });
            }
        }
        
        function switchToProject(projectId) {
            if (!projectId) {
                // No project selected
                currentProject = null;
                viewedProject = null; // Clear viewed project when clearing active project
                updateProjectSelector();
                showNotification('No project selected', 'info');
                return;
            }
            
            const projectIdNum = parseInt(projectId);
            loadProject(projectIdNum);
            
            // If we're switching to a different project, clear the viewed project
            // so the timeline shows the new active project
            if (viewedProject && viewedProject.id !== projectIdNum) {
                viewedProject = null;
                const timelineDropdown = document.getElementById('projectTimelineDropdown');
                if (timelineDropdown) {
                    timelineDropdown.value = '';
                }
            }
            
            // Ensure dropdown and display are synchronized
            setTimeout(() => {
                updateProjectSelector();
                // Force sync both dropdown selections
                const globalDropdown = document.getElementById('globalProjectDropdown');
                const timelineDropdown = document.getElementById('projectTimelineDropdown');
                if (currentProject) {
                    if (globalDropdown) {
                        globalDropdown.value = currentProject.id.toString();
                    }
                    if (timelineDropdown) {
                        timelineDropdown.value = currentProject.id.toString();
                    }
                }
            }, 10);
            
            showNotification(`Switched to project: ${currentProject.name}`, 'success');
        }
        
        function showProjectManager() {
            if (projects.length === 0) {
                showNotification('No projects to manage. Create a project first!', 'warning');
                return;
            }
            
            let projectList = 'Project Overview:\n';
            projectList += '='.repeat(50) + '\n\n';
            
            projects.forEach((project, index) => {
                const created = new Date(project.created).toLocaleDateString();
                const modified = project.lastModified ? new Date(project.lastModified).toLocaleDateString() : 'Never';
                const hasNotes = project.notes && project.notes.trim().length > 0;
                const notePreview = hasNotes ? project.notes.substring(0, 50) + (project.notes.length > 50 ? '...' : '') : 'No notes';
                
                projectList += `${index + 1}. ${project.name}\n`;
                projectList += `   üìÖ Created: ${created}\n`;
                projectList += `   üîÑ Modified: ${modified}\n`;
                projectList += `   üìè Data: ${project.boards.length} boards, ${project.cuts.length} cuts, ${project.history.length} calculations\n`;
                projectList += `   üìù Notes: ${notePreview}\n\n`;
            });
            
            projectList += 'Commands:\n';
            projectList += '‚Ä¢ Enter project number (1-' + projects.length + ') to load\n';
            projectList += '‚Ä¢ "delete X" to delete project X\n';
            projectList += '‚Ä¢ "export X" to export project X data\n';
            
            const action = prompt(projectList);
            
            if (action) {
                if (action.toLowerCase().startsWith('delete ')) {
                    const projectNum = parseInt(action.split(' ')[1]) - 1;
                    if (projectNum >= 0 && projectNum < projects.length) {
                        deleteProject(projects[projectNum].id);
                    }
                } else if (action.toLowerCase().startsWith('export ')) {
                    const projectNum = parseInt(action.split(' ')[1]) - 1;
                    if (projectNum >= 0 && projectNum < projects.length) {
                        exportProjectData(projects[projectNum]);
                    }
                } else {
                    const projectNum = parseInt(action) - 1;
                    if (projectNum >= 0 && projectNum < projects.length) {
                        loadProject(projects[projectNum].id);
                        updateProjectSelector();
                    }
                }
            }
        }
        
        function exportProjectData(project) {
            // Create both text and HTML exports
            createTextExport(project);
            createHTMLExport(project);
        }
        
        function createTextExport(project) {
            const date = new Date().toLocaleDateString();
            const time = new Date().toLocaleTimeString();
            
            let exportText = `üìÅ ${project.name} - Project Timeline\n`;
            exportText += `${'='.repeat(60)}\n`;
            exportText += `üìÖ Exported: ${date} at ${time}\n`;
            exportText += `üìÖ Created: ${new Date(project.created).toLocaleDateString()}\n`;
            exportText += `üîÑ Last Modified: ${project.lastModified ? new Date(project.lastModified).toLocaleDateString() : 'Never'}\n\n`;
            
            // Project Notes
            if (project.notes && project.notes.trim()) {
                exportText += 'üìù PROJECT NOTES:\n';
                exportText += '-'.repeat(40) + '\n';
                exportText += project.notes + '\n\n';
            }
            
            // Project Timeline - Main Focus
            if (project.projectLog && project.projectLog.length > 0) {
                exportText += `üìä SAVED CALCULATIONS (${project.projectLog.length}):\n`;
                exportText += '='.repeat(50) + '\n\n';
                
                // Sort by date (most recent first)
                const sortedLog = [...project.projectLog].sort((a, b) => 
                    new Date(b.timestamp) - new Date(a.timestamp)
                );
                
                sortedLog.forEach((logEntry, index) => {
                    const toolIcon = getToolIcon(logEntry.toolName);
                    const savedDate = new Date(logEntry.saved).toLocaleDateString();
                    const savedTime = new Date(logEntry.saved).toLocaleTimeString();
                    
                    exportText += `${index + 1}. ${toolIcon} ${logEntry.toolName}\n`;
                    exportText += `   üìÖ Saved: ${savedDate} at ${savedTime}\n`;
                    
                    if (logEntry.equation) {
                        exportText += `   üßÆ Calculation: ${logEntry.equation}\n`;
                    }
                    if (logEntry.result) {
                        exportText += `   ‚úÖ Result: ${logEntry.result}\n`;
                    }
                    if (logEntry.details) {
                        exportText += `   üìã Details:\n`;
                        const detailLines = logEntry.details.split('\n');
                        detailLines.forEach(line => {
                            if (line.trim()) exportText += `      ${line}\n`;
                        });
                    }
                    if (logEntry.userNotes) {
                        exportText += `   üí° Notes: ${logEntry.userNotes}\n`;
                    }
                    exportText += '\n';
                });
            } else {
                exportText += 'üìä SAVED CALCULATIONS:\n';
                exportText += '-'.repeat(40) + '\n';
                exportText += 'No calculations saved to this project yet.\n\n';
            }
            
            // Legacy data (if exists)
            let hasLegacyData = false;
            
            if (project.boards && project.boards.length > 0) {
                hasLegacyData = true;
                exportText += 'üìè AVAILABLE BOARDS:\n';
                exportText += '-'.repeat(30) + '\n';
                project.boards.forEach((board, index) => {
                    exportText += `${index + 1}. ${inchesToDisplay(board.length, 'opt')} √ó ${board.quantity}\n`;
                });
                exportText += '\n';
            }
            
            if (project.cuts && project.cuts.length > 0) {
                hasLegacyData = true;
                exportText += '‚úÇÔ∏è NEEDED CUTS:\n';
                exportText += '-'.repeat(30) + '\n';
                project.cuts.forEach((cut, index) => {
                    exportText += `${index + 1}. ${inchesToDisplay(cut.length, 'opt')}\n`;
                });
                exportText += '\n';
            }
            
            if (hasLegacyData) {
                exportText += '\n' + '-'.repeat(60) + '\n';
                exportText += 'Generated by WorkShop Pro Calculator\n';
                exportText += 'This project timeline shows your manually saved calculations.\n';
            }
            
            // Create downloadable file
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${project.name.replace(/[^a-zA-Z0-9]/g, '_')}_timeline.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        function createHTMLExport(project) {
            const date = new Date().toLocaleDateString();
            const time = new Date().toLocaleTimeString();
            
            let html = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${project.name} - Project Timeline</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; color: #333; }
        .header { background: linear-gradient(135deg, var(--primary-color), var(--primary-light)); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .header h1 { margin: 0; font-size: 24px; }
        .project-info { margin-top: 10px; font-size: 14px; opacity: 0.9; }
        .notes { background: #fff9c4; border: 1px solid #f0e68c; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .timeline { background: #f8f9fa; border-radius: 8px; padding: 20px; }
        .timeline-item { background: white; border-left: 4px solid var(--secondary-color); border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .tool-header { display: flex; align-items: center; margin-bottom: 15px; }
        .tool-icon { font-size: 20px; margin-right: 10px; }
        .tool-name { font-weight: bold; color: var(--primary-color); font-size: 16px; flex: 1; }
        .timestamp { font-size: 12px; color: #666; }
        .equation { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; padding: 10px; margin: 10px 0; font-family: monospace; }
        .result { font-weight: bold; color: #28a745; font-size: 16px; margin: 10px 0; }
        .details { color: #666; margin: 10px 0; line-height: 1.4; white-space: pre-line; }
        .user-notes { background: #fff9c4; border: 1px solid #f0e68c; border-radius: 4px; padding: 10px; margin: 10px 0; font-style: italic; }
        .footer { text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 14px; }
        .empty-state { text-align: center; color: #666; font-style: italic; }
        @media print { body { max-width: none; margin: 0; padding: 15px; } .header { background: var(--primary-color) !important; } }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìÅ ${project.name}</h1>
        <div class="project-info">
            üìÖ Exported: ${date} at ${time}<br>
            üìÖ Created: ${new Date(project.created).toLocaleDateString()}<br>
            üîÑ Last Modified: ${project.lastModified ? new Date(project.lastModified).toLocaleDateString() : 'Never'}
        </div>
    </div>`;
            
            // Project Notes
            if (project.notes && project.notes.trim()) {
                html += `<div class="notes">
                    <h3>üìù Project Notes</h3>
                    <p>${project.notes.replace(/\n/g, '<br>')}</p>
                </div>`;
            }
            
            html += '<div class="timeline">';
            html += `<h2>üìä Saved Calculations (${project.projectLog ? project.projectLog.length : 0})</h2>`;
            
            if (project.projectLog && project.projectLog.length > 0) {
                // Sort by date (most recent first)
                const sortedLog = [...project.projectLog].sort((a, b) => 
                    new Date(b.timestamp) - new Date(a.timestamp)
                );
                
                sortedLog.forEach(logEntry => {
                    const toolIcon = getToolIcon(logEntry.toolName);
                    const savedDate = new Date(logEntry.saved).toLocaleString();
                    
                    html += `<div class="timeline-item">
                        <div class="tool-header">
                            <span class="tool-icon">${toolIcon}</span>
                            <span class="tool-name">${logEntry.toolName}</span>
                            <span class="timestamp">Saved: ${savedDate}</span>
                        </div>`;
                    
                    if (logEntry.equation) {
                        html += `<div class="equation">${logEntry.equation}</div>`;
                    }
                    if (logEntry.result) {
                        html += `<div class="result">Result: ${logEntry.result}</div>`;
                    }
                    if (logEntry.details) {
                        html += `<div class="details">${logEntry.details}</div>`;
                    }
                    if (logEntry.userNotes) {
                        html += `<div class="user-notes">üí° ${logEntry.userNotes}</div>`;
                    }
                    
                    html += '</div>';
                });
            } else {
                html += '<div class="empty-state">No calculations saved to this project yet.</div>';
            }
            
            html += '</div>';
            
            html += `<div class="footer">
                Generated by WorkShop Pro Calculator<br>
                <small>This timeline shows your manually saved calculations for easy reference and printing.</small>
            </div>
        </body>
        </html>`;
            
            // Create downloadable HTML file
            const blob = new Blob([html], { type: 'text/html' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${project.name.replace(/[^a-zA-Z0-9]/g, '_')}_timeline.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification(`Project "${project.name}" exported as text and HTML files!`, 'success');
        }
        
        function showProjectNotes() {
            if (!currentProject) {
                showNotification('Please create or select a project first', 'warning');
                return;
            }
            
            const modal = document.getElementById('notesModal');
            const projectName = document.getElementById('notesProjectName');
            const notesText = document.getElementById('projectNotesText');
            
            if (modal && projectName && notesText) {
                projectName.textContent = currentProject.name;
                notesText.value = currentProject.notes || '';
                modal.style.display = 'block';
                notesText.focus();
            }
        }
        
        function closeProjectNotes() {
            const modal = document.getElementById('notesModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Save to Project Modal Functions
        let currentSaveData = null; // Store the data being saved
        
        function showSaveToProjectModal(toolNameOrData, data) {
            // Handle both old format (toolName, data) and new format (saveDataObject)
            if (typeof toolNameOrData === 'string') {
                // Old format: showSaveToProjectModal('Tool Name', data)
                currentSaveData = {
                    toolName: toolNameOrData,
                    timestamp: new Date().toISOString(),
                    ...data
                };
                
                const modal = document.getElementById('saveToProjectModal');
                const previewContent = document.getElementById('savePreviewContent');
                
                // Generate preview content
                let previewHtml = `<h5>${toolNameOrData}</h5>`;
                if (data.equation) {
                    previewHtml += `<strong>Calculation:</strong> ${data.equation}<br>`;
                }
                if (data.result) {
                    previewHtml += `<strong>Result:</strong> ${data.result}<br>`;
                }
                if (data.details) {
                    previewHtml += `<strong>Details:</strong><br>${data.details.replace(/\n/g, '<br>')}`;
                }
                
                previewContent.innerHTML = previewHtml;
            } else {
                // New format: showSaveToProjectModal(saveDataObject)
                const saveData = toolNameOrData;
                currentSaveData = {
                    toolName: saveData.toolName || saveData.tool || 'Calculator',
                    timestamp: new Date().toISOString(),
                    equation: saveData.equation,
                    result: saveData.result,
                    details: saveData.details
                };
                
                const modal = document.getElementById('saveToProjectModal');
                const previewContent = document.getElementById('savePreviewContent');
                
                // Use the custom preview if available, otherwise generate standard preview
                if (saveData.preview) {
                    previewContent.innerHTML = saveData.preview;
                } else {
                    let previewHtml = `<h5>${saveData.toolName || saveData.tool || 'Calculator'}</h5>`;
                    if (saveData.equation) {
                        previewHtml += `<strong>Calculation:</strong> ${saveData.equation}<br>`;
                    }
                    if (saveData.result) {
                        previewHtml += `<strong>Result:</strong> ${saveData.result}<br>`;
                    }
                    if (saveData.details) {
                        previewHtml += `<strong>Details:</strong><br>${saveData.details.replace(/\n/g, '<br>')}`;
                    }
                    previewContent.innerHTML = previewHtml;
                }
            }
            
            // Populate project dropdown
            populateSaveProjectDropdown();
            
            // Clear notes text
            document.getElementById('saveNotesText').value = '';
            
            // Show modal
            const modal = document.getElementById('saveToProjectModal');
            console.log('DEBUG: Modal element found:', !!modal);
            if (modal) {
                console.log('DEBUG: Setting modal display to block');
                modal.style.display = 'block';
                console.log('DEBUG: Modal display is now:', modal.style.display);
            } else {
                console.error('DEBUG: Modal element not found!');
            }
        }
        
        function closeSaveToProjectModal() {
            const modal = document.getElementById('saveToProjectModal');
            if (modal) {
                modal.style.display = 'none';
            }
            currentSaveData = null;
        }
        
        function populateSaveProjectDropdown() {
            const dropdown = document.getElementById('saveProjectDropdown');
            if (!dropdown) return;
            
            // Clear existing options
            dropdown.innerHTML = '<option value="">Select a project...</option>';
            
            // Add current project as default if one exists
            if (currentProject) {
                const option = document.createElement('option');
                option.value = currentProject.id;
                option.textContent = `${currentProject.name} (Current)`;
                option.selected = true;
                dropdown.appendChild(option);
            }
            
            // Add other projects
            projects.forEach(project => {
                if (!currentProject || project.id !== currentProject.id) {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.name;
                    dropdown.appendChild(option);
                }
            });
        }
        
        function createNewProjectFromSaveModal() {
            const name = prompt('Enter new project name:');
            if (name && name.trim()) {
                // Create the project (reuse existing function logic)
                const project = {
                    id: Date.now(),
                    name: name.trim(),
                    created: new Date().toISOString(),
                    boards: [],
                    cuts: [],
                    history: [],
                    cutHistory: [],
                    projectLog: [],
                    calculatorData: {
                        currentValueInches: 0,
                        cutValueInches: 0,
                        currentOperation: null,
                        operationValue: 0,
                        memoryValue: 0,
                        value1: 0,
                        value2: 0,
                        inputMode: 'fraction'
                    },
                    notes: '',
                    tags: []
                };
                
                projects.push(project);
                currentProject = project;
                saveToLocalStorage();
                updateProjectSelector();
                
                // Refresh the dropdown
                populateSaveProjectDropdown();
                
                showNotification(`Project "${name}" created!`, 'success');
            }
        }
        
        function executeSaveToProject() {
            const projectId = document.getElementById('saveProjectDropdown').value;
            const notes = document.getElementById('saveNotesText').value.trim();
            
            if (!projectId) {
                showNotification('Please select a project', 'warning');
                return;
            }
            
            if (!currentSaveData) {
                showNotification('No data to save', 'error');
                return;
            }
            
            // Find the target project
            const targetProject = projects.find(p => p.id == projectId);
            if (!targetProject) {
                showNotification('Project not found', 'error');
                return;
            }
            
            // Create the project log entry
            const logEntry = {
                id: Date.now(),
                timestamp: currentSaveData.timestamp,
                toolName: currentSaveData.toolName,
                equation: currentSaveData.equation || '',
                result: currentSaveData.result || '',
                details: currentSaveData.details || '',
                diagram: currentSaveData.diagram || null,
                userNotes: notes,
                saved: new Date().toISOString()
            };
            
            // Add to project log
            if (!targetProject.projectLog) {
                targetProject.projectLog = [];
            }
            targetProject.projectLog.unshift(logEntry); // Add to beginning (most recent first)
            
            // Update project modified time
            targetProject.lastModified = new Date().toISOString();
            
            // Save to localStorage
            saveToLocalStorage();
            
            // Close modal and show success
            closeSaveToProjectModal();
            showNotification(`Saved to project: ${targetProject.name}`, 'success');
            
            // Update displays
            updateProjectSelector();
        }
        
        function saveProjectNotes() {
            if (!currentProject) {
                showNotification('No active project to save notes to', 'error');
                return;
            }
            
            const notesText = document.getElementById('projectNotesText');
            if (notesText) {
                currentProject.notes = notesText.value;
                saveCurrentProject();
                closeProjectNotes();
                showNotification('Project notes saved!', 'success');
            }
        }
        
        
        // Projects Tab Functions
        function renderProjectTimeline() {
            const globalDropdown = document.getElementById('globalProjectDropdown');
            
            // Only sync with global dropdown for active project, not timeline viewing
            if (!currentProject && globalDropdown && globalDropdown.value) {
                const projectId = parseInt(globalDropdown.value);
                const project = projects.find(p => p.id === projectId);
                if (project) {
                    currentProject = project;
                }
            }
            
            // Sync global dropdown with current project
            if (currentProject && globalDropdown) {
                if (globalDropdown.value !== currentProject.id.toString()) {
                    globalDropdown.value = currentProject.id.toString();
                }
            }
            
            // If we have a viewed project, show that; otherwise check for active project
            if (viewedProject) {
                updateViewedProjectTimelineHeader();
                renderViewedTimelineContent();
            } else if (currentProject) {
                updateProjectTimelineHeader();
                renderTimelineContent();
            } else {
                showNoProjectSelected();
            }
        }
        
        // View-only timeline browsing (doesn't affect working project state)
        let viewedProject = null; // Separate from currentProject for timeline viewing
        
        function viewProjectTimeline(projectId) {
            if (!projectId) {
                viewedProject = null;
                showNoProjectSelected();
                return;
            }
            
            const projectIdNum = parseInt(projectId);
            const project = projects.find(p => p.id === projectIdNum);
            
            if (project) {
                // Only set the viewed project, don't overwrite working state
                viewedProject = project;
                
                // Initialize projectLog if it doesn't exist (for older projects)
                if (!project.projectLog) {
                    project.projectLog = [];
                }
                
                // Update only the timeline display, not working data
                updateViewedProjectTimelineHeader();
                renderViewedTimelineContent();
                
                // Update the timeline dropdown but NOT the global dropdown
                const timelineDropdown = document.getElementById('projectTimelineDropdown');
                if (timelineDropdown) {
                    timelineDropdown.value = project.id.toString();
                }
            }
        }
        
        function updateViewedProjectTimelineHeader() {
            const title = document.getElementById('projectTimelineTitle');
            const projectInfo = document.getElementById('projectInfo');
            const created = document.getElementById('projectCreated');
            const modified = document.getElementById('projectModified');
            const notesBtn = document.getElementById('projectNotesBtn');
            const exportBtn = document.getElementById('projectExportBtn');
            
            // Show that this is a viewed project, not the active working project
            const isActiveProject = currentProject && currentProject.id === viewedProject.id;
            const projectLabel = isActiveProject ? 'üìÅ Active:' : 'üëÅÔ∏è Viewing:';
            title.textContent = `${projectLabel} ${viewedProject.name}`;
            
            created.textContent = `üìÖ Created: ${new Date(viewedProject.created).toLocaleDateString()}`;
            modified.textContent = `üîÑ Modified: ${viewedProject.lastModified ? new Date(viewedProject.lastModified).toLocaleDateString() : 'Never'}`;
            
            projectInfo.style.display = 'block';
            
            // Only enable notes/export for active project, not viewed project
            notesBtn.disabled = !isActiveProject;
            exportBtn.disabled = false; // Export can work for any project
            
            document.getElementById('noProjectSelected').style.display = 'none';
            document.getElementById('projectTimeline').style.display = 'block';
        }
        
        function renderViewedTimelineContent() {
            const timelineContent = document.getElementById('timelineContent');
            const emptyTimeline = document.getElementById('emptyTimeline');
            
            if (!viewedProject.projectLog || viewedProject.projectLog.length === 0) {
                timelineContent.innerHTML = '';
                emptyTimeline.style.display = 'block';
                return;
            }
            
            emptyTimeline.style.display = 'none';
            
            // Sort by timestamp (most recent first)
            const sortedLog = [...viewedProject.projectLog].sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );
            
            let timelineHTML = '';
            sortedLog.forEach(logEntry => {
                timelineHTML += createTimelineItem(logEntry);
            });
            
            timelineContent.innerHTML = timelineHTML;
        }
        
        function showNoProjectSelected() {
            document.getElementById('projectTimelineTitle').textContent = 'üìÅ Select a Project';
            document.getElementById('projectInfo').style.display = 'none';
            document.getElementById('projectNotesBtn').disabled = true;
            document.getElementById('projectExportBtn').disabled = true;
            document.getElementById('noProjectSelected').style.display = 'block';
            document.getElementById('projectTimeline').style.display = 'none';
        }
        
        function updateProjectTimelineHeader() {
            const title = document.getElementById('projectTimelineTitle');
            const projectInfo = document.getElementById('projectInfo');
            const created = document.getElementById('projectCreated');
            const modified = document.getElementById('projectModified');
            const notesBtn = document.getElementById('projectNotesBtn');
            const exportBtn = document.getElementById('projectExportBtn');
            
            title.textContent = `üìÅ Active: ${currentProject.name}`;
            
            created.textContent = `üìÖ Created: ${new Date(currentProject.created).toLocaleDateString()}`;
            modified.textContent = `üîÑ Modified: ${currentProject.lastModified ? new Date(currentProject.lastModified).toLocaleDateString() : 'Never'}`;
            
            projectInfo.style.display = 'block';
            notesBtn.disabled = false;
            exportBtn.disabled = false;
            
            document.getElementById('noProjectSelected').style.display = 'none';
            document.getElementById('projectTimeline').style.display = 'block';
        }
        
        function renderTimelineContent() {
            const timelineContent = document.getElementById('timelineContent');
            const emptyTimeline = document.getElementById('emptyTimeline');
            
            if (!currentProject.projectLog || currentProject.projectLog.length === 0) {
                timelineContent.innerHTML = '';
                emptyTimeline.style.display = 'block';
                return;
            }
            
            emptyTimeline.style.display = 'none';
            
            // Sort by timestamp (most recent first)
            const sortedLog = [...currentProject.projectLog].sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );
            
            let timelineHTML = '';
            sortedLog.forEach(logEntry => {
                timelineHTML += createTimelineItem(logEntry);
            });
            
            timelineContent.innerHTML = timelineHTML;
        }
        
        function getTimelineDetailsDisplay(logEntry) {
            const details = logEntry.details;
            
            // Handle string format (old format)
            if (typeof details === 'string') {
                return details.replace(/\n/g, '<br>');
            }
            
            // Handle object format (new format)
            if (typeof details === 'object' && details) {
                // For spacing calculator with marks (center-marks mode)
                if (details.mode === 'center-marks' && details.marks && details.marks.length > 0) {
                    let html = `<strong>üìç Center Mark Positions:</strong><br>`;
                    details.marks.slice(0, 8).forEach(mark => {
                        html += `Shelf ${mark.shelf}: ${mark.display}<br>`;
                    });
                    if (details.marks.length > 8) {
                        html += `... and ${details.marks.length - 8} more<br>`;
                    }
                    return html;
                }
                
                // For spacing calculator in shelf-spacing mode
                if (details.mode === 'shelf-spacing') {
                    let html = `<strong>üìè Shelf Spacing Details:</strong><br>`;
                    if (details.totalLength) {
                        html += `Total Length: ${inchesToDisplay ? inchesToDisplay(details.totalLength) : details.totalLength + '"'}<br>`;
                    }
                    if (details.numShelves && details.thickness) {
                        const thicknessDisplay = inchesToDisplay ? inchesToDisplay(details.thickness) : details.thickness + '"';
                        const totalMaterial = details.numShelves * details.thickness;
                        const totalMaterialDisplay = inchesToDisplay ? inchesToDisplay(totalMaterial) : totalMaterial.toFixed(3) + '"';
                        const availableSpace = details.totalLength - totalMaterial;
                        const availableSpaceDisplay = inchesToDisplay ? inchesToDisplay(availableSpace) : availableSpace.toFixed(3) + '"';
                        
                        html += `Shelves: ${details.numShelves} √ó ${thicknessDisplay} thick<br>`;
                        html += `Total Material: ${totalMaterialDisplay}<br>`;
                        html += `Available Space: ${availableSpaceDisplay}<br>`;
                    }
                    if (details.spacing) {
                        const spacingDisplay = inchesToDisplay ? inchesToDisplay(details.spacing) : details.spacing.toFixed(3) + '"';
                        html += `Spacing: ${spacingDisplay} each<br>`;
                    }
                    
                    // Show shelf positions if available
                    if (details.shelfPositions && details.shelfPositions.length > 0) {
                        html += `<br><strong>Shelf Positions:</strong><br>`;
                        details.shelfPositions.slice(0, 6).forEach(pos => {
                            html += `Shelf ${pos.shelf}: ${pos.startDisplay} to ${pos.endDisplay}<br>`;
                        });
                        if (details.shelfPositions.length > 6) {
                            html += `... and ${details.shelfPositions.length - 6} more<br>`;
                        }
                    }
                    
                    return html;
                }
                
                // For cut calculator with cut marks
                if (details.cutMarks && Array.isArray(details.cutMarks)) {
                    let html = `<strong>‚úÇÔ∏è Cut Details:</strong><br>`;
                    if (details.originalLength) {
                        html += `Original Length: ${details.originalLength}<br>`;
                    }
                    if (details.pieces && details.pieceLength) {
                        html += `Pieces: ${details.pieces} @ ${details.pieceLength} each<br>`;
                    }
                    if (details.kerfNote) {
                        html += `Kerf: ${details.kerfNote}<br>`;
                    }
                    if (details.cutSideNote) {
                        html += `Cut Side: ${details.cutSideNote}<br>`;
                    }
                    
                    if (details.cutMarks.length > 0) {
                        html += `<br><strong>Cut Marks:</strong><br>`;
                        details.cutMarks.slice(0, 8).forEach((mark, i) => {
                            html += `Mark ${i + 1}: ${mark.display || mark}<br>`;
                        });
                        if (details.cutMarks.length > 8) {
                            html += `... and ${details.cutMarks.length - 8} more marks<br>`;
                        }
                    }
                    
                    return html;
                }
                
                // For lumber shopping cart with items
                if (details.items && Array.isArray(details.items)) {
                    let html = `<strong>üõí Lumber Cart Details:</strong><br>`;
                    if (details.totalBoardFeet && details.totalCost) {
                        html += `Total: ${details.totalBoardFeet} BF - $${details.totalCost}<br><br>`;
                    }
                    
                    if (details.items.length > 0) {
                        html += `<strong>Items:</strong><br>`;
                        details.items.slice(0, 8).forEach((item, i) => {
                            html += `${i + 1}. ${item.species || 'Unknown'} - `;
                            html += `${item.quantity}pc √ó ${item.thickness}" √ó ${item.width}" √ó ${item.length}" `;
                            html += `(${item.boardFeet?.toFixed(3) || '0'} BF @ $${item.pricePerBF?.toFixed(2) || '0'}/BF = $${item.lineTotal?.toFixed(2) || '0'})<br>`;
                        });
                        if (details.items.length > 8) {
                            html += `... and ${details.items.length - 8} more items<br>`;
                        }
                    }
                    
                    return html;
                }
                
                // For other calculators or fallback to fullDetails
                if (details.fullDetails) {
                    return details.fullDetails.replace(/\n/g, '<br>');
                }
                
                // Generic object display
                return JSON.stringify(details, null, 2).replace(/\n/g, '<br>');
            }
            
            return '';
        }
        
        function createTimelineItem(logEntry) {
            // Handle both toolName and type fields for backward compatibility
            const toolName = logEntry.toolName || logEntry.type || 'Unknown Tool';
            const toolType = getToolTypeFromName(toolName);
            const markerIcon = getToolIcon(toolName);
            const timestamp = new Date(logEntry.timestamp).toLocaleString();
            const savedTime = new Date(logEntry.saved).toLocaleString();
            
            return `
                <div class="timeline-item">
                    <div class="timeline-marker ${toolType}">${markerIcon}</div>
                    <div class="timeline-card">
                        <div class="timeline-card-header">
                            <div class="timeline-tool-info">
                                <div class="timeline-tool-name">${logEntry.toolName}</div>
                                <div class="timeline-timestamp">Saved: ${savedTime}</div>
                            </div>
                            <div class="timeline-actions">
                                <button class="btn btn-sm btn-secondary" onclick="deleteTimelineItem('${logEntry.id}')" title="Delete">üóëÔ∏è</button>
                            </div>
                        </div>
                        
                        ${logEntry.equation ? `<div class="timeline-equation">${logEntry.equation}</div>` : ''}
                        ${logEntry.result ? `<div class="timeline-result">Result: ${logEntry.result}</div>` : ''}
                        ${logEntry.details ? `<div class="timeline-details">${getTimelineDetailsDisplay(logEntry)}</div>` : ''}
                        ${logEntry.userNotes ? `<div class="timeline-notes">${logEntry.userNotes}</div>` : ''}
                    </div>
                </div>
            `;
        }
        
        function getToolTypeFromName(toolName) {
            // Handle undefined or null toolName
            if (!toolName || typeof toolName !== 'string') {
                return 'unknown';
            }
            
            if (toolName.includes('Calculator') && !toolName.includes('Golden') && !toolName.includes('Miter') && !toolName.includes('Shelf') && !toolName.includes('Screw')) {
                return 'calculator';
            } else if (toolName.includes('Golden Ratio')) {
                return 'golden';
            } else if (toolName.includes('Shelf') || toolName.includes('Division')) {
                return 'spacing';
            } else if (toolName.includes('Screw')) {
                return 'screw';
            } else if (toolName.includes('Miter') || toolName.includes('Angle')) {
                return 'miter';
            } else if (toolName.includes('Lumber') || toolName.includes('Board')) {
                return 'lumber';
            }
            return 'calculator';
        }
        
        function getToolIcon(toolName) {
            if (!toolName || typeof toolName !== 'string') {
                return 'üîß';
            }
            
            if (toolName.includes('Calculator') && !toolName.includes('Golden') && !toolName.includes('Miter') && !toolName.includes('Shelf') && !toolName.includes('Screw')) {
                return 'üßÆ';
            } else if (toolName.includes('Golden Ratio')) {
                return '‚ú®';
            } else if (toolName.includes('Shelf') || toolName.includes('Division')) {
                return 'üìê';
            } else if (toolName.includes('Screw')) {
                return 'üî©';
            } else if (toolName.includes('Miter') || toolName.includes('Angle')) {
                return 'üìê';
            } else if (toolName.includes('Lumber') || toolName.includes('Board')) {
                return 'üìè';
            }
            return 'üßÆ';
        }
        
        function deleteTimelineItem(itemId) {
            if (!currentProject || !currentProject.projectLog) return;
            
            if (confirm('Delete this saved calculation from your project?')) {
                currentProject.projectLog = currentProject.projectLog.filter(item => item.id != itemId);
                currentProject.lastModified = new Date().toISOString();
                saveToLocalStorage();
                renderProjectTimeline();
                updateProjectSelector();
                showNotification('Calculation removed from project', 'success');
            }
        }
        
        // All Projects Modal Functions
        function showAllProjects() {
            const modal = document.getElementById('allProjectsModal');
            renderAllProjectsModal();
            modal.style.display = 'block';
        }
        
        function closeAllProjectsModal() {
            const modal = document.getElementById('allProjectsModal');
            modal.style.display = 'none';
        }
        
        function renderAllProjectsModal() {
            const grid = document.getElementById('projectsGridModal');
            const noProjectsMsg = document.getElementById('noProjectsModalMessage');
            
            if (projects.length === 0) {
                grid.innerHTML = '';
                noProjectsMsg.style.display = 'block';
                return;
            }
            
            noProjectsMsg.style.display = 'none';
            
            grid.innerHTML = projects.map(project => {
                const logCount = project.projectLog ? project.projectLog.length : 0;
                const isActive = currentProject && currentProject.id === project.id;
                const created = new Date(project.created).toLocaleDateString();
                const modified = project.lastModified ? new Date(project.lastModified).toLocaleDateString() : 'Never';
                
                return `
                    <div class="project-card ${isActive ? 'current-project' : ''}" onclick="loadProjectFromModal(${project.id})">
                        <div class="project-card-content">
                            <div class="project-header">
                                <h4>${project.name} ${isActive ? '(Active)' : ''}</h4>
                                <div class="project-actions" onclick="event.stopPropagation()">
                                    <button class="btn btn-sm btn-secondary" onclick="duplicateProject(${project.id})" title="Duplicate">üìã</button>
                                    <button class="btn btn-sm btn-secondary" onclick="exportCurrentProject(${project.id})" title="Export">üì§</button>
                                    <button class="btn btn-sm btn-warning" onclick="deleteProject(${project.id})" title="Delete">üóëÔ∏è</button>
                                </div>
                            </div>
                            <div class="project-stats">
                                <span class="stat">üìä ${logCount} saved calculations</span>
                                <span class="stat">üìÖ ${created}</span>
                                <span class="stat">üîÑ ${modified}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function loadProjectFromModal(projectId) {
            loadProject(projectId);
            updateProjectSelector();
            closeAllProjectsModal();
            showNotification(`Switched to project: ${currentProject.name}`, 'success');
        }
        
        function exportCurrentProject(projectId = null) {
            // Export the viewed project if we're viewing one, otherwise the active project
            const projectToExport = projectId ? projects.find(p => p.id === projectId) : 
                                   viewedProject ? viewedProject : currentProject;
            if (!projectToExport) {
                showNotification('No project to export', 'warning');
                return;
            }
            
            // Use existing export functionality but update for new timeline structure
            exportProjectData(projectToExport);
        }
        
        // Legacy functions for backward compatibility
        function renderProjectsTab() {
            // Ensure the project state is synced before rendering
            updateProjectSelector();
        }
        
        
        
        function loadProjectFromCard(projectId) {
            loadProject(projectId);
            updateProjectSelector();
            renderProjectsTab();
            
            // Switch to a useful tab for continuing work
            if (currentProject && (currentProject.boards.length > 0 || currentProject.cuts.length > 0)) {
                switchTab('optimizer');
            } else {
                switchTab('calculator');
            }
        }
        
        function duplicateProject(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            const newName = prompt(`Duplicate "${project.name}":\nEnter new project name:`, `${project.name} (Copy)`);
            if (!newName || !newName.trim()) return;
            
            const newProject = {
                ...project,
                id: Date.now(),
                name: newName.trim(),
                created: new Date().toISOString(),
                lastModified: null,
                projectLog: [] // Reset project log for new duplicate
            };
            
            projects.push(newProject);
            saveToLocalStorage();
            renderProjectsTab();
            updateProjectSelector();
            
            showNotification(`Project "${newName}" created!`, 'success');
        }
        
        function exportAllProjects() {
            if (projects.length === 0) {
                showNotification('No projects to export', 'warning');
                return;
            }
            
            const exportData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                projects: projects
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `woodworking_projects_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification(`${projects.length} projects exported!`, 'success');
        }
        
        function importProjects() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importData = JSON.parse(e.target.result);
                        
                        if (!importData.projects || !Array.isArray(importData.projects)) {
                            showNotification('Invalid project file format', 'error');
                            return;
                        }
                        
                        let importedCount = 0;
                        importData.projects.forEach(project => {
                            // Assign new ID to avoid conflicts
                            project.id = Date.now() + importedCount;
                            project.name = `${project.name} (Imported)`;
                            projects.push(project);
                            importedCount++;
                        });
                        
                        saveToLocalStorage();
                        renderProjectsTab();
                        updateProjectSelector();
                        
                        showNotification(`${importedCount} projects imported!`, 'success');
                    } catch (error) {
                        showNotification('Error reading project file', 'error');
                        console.error('Import error:', error);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        // Update project status bars across all tabs
        function updateProjectStatusBars() {
            const statusBars = [
                { id: 'calcProjectStatus', name: 'Calculator' },
                { id: 'cutProjectStatus', name: 'Cut Calculator' }
            ];
            
            statusBars.forEach(bar => {
                const element = document.getElementById(bar.id);
                if (!element) return;
                
                const statusText = element.querySelector('.status-text');
                if (!statusText) return;
                
                if (currentProject) {
                    statusText.textContent = `üìÅ ${currentProject.name}`;
                    element.classList.add('active');
                } else {
                    statusText.textContent = `No active project`;
                    element.classList.remove('active');
                }
            });
        }
        
        // Essential data save (no longer auto-called, used for manual saves and app close)
        function saveEssentialData() {
            // Only save essential persistent data, not temporary calculator states
            saveToLocalStorage();
        }
        
        // Auto-save interval removed - now using manual "Save to Project" workflow
        
        // DEBUG: Test function to check modal functionality
        function testSaveModal() {
            console.log('=== DEBUG: Testing modal directly ===');
            const modal = document.getElementById('saveToProjectModal');
            console.log('Modal element:', modal);
            if (modal) {
                modal.style.display = 'block';
                console.log('Modal should now be visible');
            } else {
                console.error('Modal element not found!');
            }
        }
        
        // Save essential data when user closes the app
        window.addEventListener('beforeunload', function() {
            saveEssentialData();
        });
        
        // Notification system to replace alerts
        function showNotification(message, type = 'error') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification show';
            if (type === 'success') notification.classList.add('success');
            else if (type === 'warning') notification.classList.add('warning');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Initialize fraction selectors with proper fraction display
        function updatePrecision(tabName = null) {
            let precision = 16;
            let fractionSelects = [];
            
            if (tabName === 'calculator' || !tabName) {
                precision = parseInt(document.getElementById('precision')?.value || 16);
                fractionSelects = ['fraction1', 'fraction2', 'grFraction', 'singleBoardWidthFraction', 'singleInputLengthFraction', 'frameMaterialWidthFraction', 'frameWidthFraction', 'frameHeightFraction', 'framePolygonFraction', 'spTotalLengthFraction', 'spacingThicknessFraction'];
            } else if (tabName === 'cut') {
                precision = parseInt(document.getElementById('cutPrecision')?.value || 16);
                fractionSelects = ['cutFraction', 'boardFraction', 'optCutFraction'];
            } else if (tabName === 'optimizer') {
                precision = parseInt(document.getElementById('optPrecision')?.value || 16);
                fractionSelects = ['boardFraction', 'optCutFraction'];
            } else if (tabName === 'edit') {
                // Special case for edit modal - use optimizer precision
                precision = parseInt(document.getElementById('optPrecision')?.value || 16);
                fractionSelects = ['editFraction'];
            }
            
            fractionSelects.forEach(id => {
                const select = document.getElementById(id);
                if (!select) return;
                
                const currentValue = select.value; // Store current value
                select.innerHTML = '<option value="0">0</option>';
                
                for (let i = 1; i < precision; i++) {
                    const decimal = i / precision;
                    let displayText;
                    
                    const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
                    const divisor = gcd(i, precision);
                    const simplifiedNumerator = i / divisor;
                    const simplifiedDenominator = precision / divisor;
                    
                    if (simplifiedDenominator === precision) {
                        displayText = `${i}/${precision}`;
                    } else {
                        displayText = `${simplifiedNumerator}/${simplifiedDenominator} (${i}/${precision})`;
                    }
                    
                    select.innerHTML += `<option value="${decimal}">${displayText}</option>`;
                }
                
                // Restore value if it still exists
                if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
                    select.value = currentValue;
                }
            });
            
            // Update calculator second input if it exists
            if (tabName === 'calculator') {
                const fraction2 = document.getElementById('fraction2');
                if (fraction2) {
                    const currentValue = fraction2.value;
                    fraction2.innerHTML = '<option value="0">0</option>';
                    for (let i = 1; i < precision; i++) {
                        const decimal = i / precision;
                        const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
                        const divisor = gcd(i, precision);
                        const simplifiedNumerator = i / divisor;
                        const simplifiedDenominator = precision / divisor;
                        
                        let displayText;
                        if (simplifiedDenominator === precision) {
                            displayText = `${i}/${precision}`;
                        } else {
                            displayText = `${simplifiedNumerator}/${simplifiedDenominator} (${i}/${precision})`;
                        }
                        
                        fraction2.innerHTML += `<option value="${decimal}">${displayText}</option>`;
                    }
                    if (currentValue && Array.from(fraction2.options).some(opt => opt.value === currentValue)) {
                        fraction2.value = currentValue;
                    }
                }
            }
        }
        
        // Update woodworking calculator fraction dropdowns when main precision changes
        function updateWoodworkingFractions() {
            const precision = parseInt(document.getElementById('precision')?.value || 16);
            const woodworkingFractionSelects = [
                'grFraction', 'singleBoardWidthFraction', 'singleInputLengthFraction', 
                'frameMaterialWidthFraction', 'frameWidthFraction', 'frameHeightFraction', 'framePolygonFraction',
                'spTotalLengthFraction', 'spacingThicknessFraction'
            ];
            
            woodworkingFractionSelects.forEach(id => {
                const select = document.getElementById(id);
                if (!select) return;
                
                const currentValue = select.value; // Store current value
                select.innerHTML = '<option value="0">0</option>';
                
                for (let i = 1; i < precision; i++) {
                    const decimal = i / precision;
                    let displayText;
                    
                    const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
                    const divisor = gcd(i, precision);
                    const simplifiedNumerator = i / divisor;
                    const simplifiedDenominator = precision / divisor;
                    
                    if (simplifiedDenominator === precision) {
                        displayText = `${i}/${precision}"`;
                    } else {
                        displayText = `${simplifiedNumerator}/${simplifiedDenominator}"`;
                    }
                    
                    select.innerHTML += `<option value="${decimal}">${displayText}</option>`;
                }
                
                // Restore value if it still exists
                if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
                    select.value = currentValue;
                }
            });
        }
        
        // Convert inches to feet/inches/fraction display
        function inchesToDisplay(totalInches, useTab = 'calculator') {
            let precision = 16;
            if (useTab === 'cut') {
                precision = parseInt(document.getElementById('cutPrecision')?.value || 16);
            } else if (useTab === 'opt') {
                precision = parseInt(document.getElementById('optPrecision')?.value || 16);
            } else {
                precision = parseInt(document.getElementById('precision')?.value || 16);
            }
            
            const roundedInches = Math.round(totalInches * precision) / precision;
            const feet = Math.floor(roundedInches / 12);
            const remainingInches = roundedInches - (feet * 12);
            const wholeInches = Math.floor(remainingInches);
            const fractionDecimal = remainingInches - wholeInches;
            
            let display = '';
            if (feet > 0) {
                display += feet + "'";
                if (wholeInches > 0 || fractionDecimal > 0) {
                    display += ' ';
                } else {
                    // Clean foot measurement - add 0"
                    display += ' 0"';
                    return display;
                }
            }
            
            if (wholeInches > 0 || (feet === 0 && fractionDecimal === 0)) {
                display += wholeInches;
                if (fractionDecimal > 0) {
                    display += ' ';
                }
            }
            
            if (fractionDecimal > 0) {
                const numerator = Math.round(fractionDecimal * precision);
                const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
                const divisor = gcd(numerator, precision);
                display += (numerator / divisor) + '/' + (precision / divisor);
            }
            
            if (display === '') display = '0';
            display += '"';
            
            return display;
        }
        
        // Convert inches to feet, inches, and fraction parts
        function inchesToParts(totalInches) {
            const feet = Math.floor(totalInches / 12);
            const remainingInches = totalInches - (feet * 12);
            const wholeInches = Math.floor(remainingInches);
            const fractionDecimal = remainingInches - wholeInches;
            
            return {
                feet: feet,
                inches: wholeInches,
                fraction: fractionDecimal
            };
        }
        
        // Get total inches from inputs
        function getInputInches(feetId, inchesId, fractionId) {
            const feet = parseFloat(document.getElementById(feetId)?.value) || 0;
            const inches = parseFloat(document.getElementById(inchesId)?.value) || 0;
            const fraction = parseFloat(document.getElementById(fractionId)?.value) || 0;
            return (feet * 12) + inches + fraction;
        }
        
        function setCurrentValue() {
            currentValueInches = getInputInches('feet', 'inches', 'fraction');
            document.getElementById('currentValue').textContent = inchesToDisplay(currentValueInches);
        }
        
        // New calculator functions
        function setOperation(op) {
            currentOperation = op;
            
            // Hide both input groups first
            document.getElementById('input2GroupFeetInches').style.display = 'none';
            document.getElementById('input2GroupNumber').style.display = 'none';
            
            // Show appropriate input group based on operation
            if (op === '+' || op === '-') {
                // Addition and subtraction use feet/inches input
                document.getElementById('input2GroupFeetInches').style.display = 'flex';
            } else if (op === '*' || op === '/') {
                // Multiplication and division use simple number input
                document.getElementById('input2GroupNumber').style.display = 'flex';
                // Set default factor if empty
                const factorInput = document.getElementById('factor');
                if (!factorInput.value) {
                    factorInput.value = op === '*' ? '2' : '2';
                }
            }
            
            // Update button highlighting
            document.querySelectorAll('.calc-btn.operation').forEach(btn => btn.classList.remove('active'));
            const btnMap = {'+': 'addBtn', '-': 'subBtn', '*': 'mulBtn', '/': 'divBtn'};
            const activeBtn = document.getElementById(btnMap[op]);
            if (activeBtn) activeBtn.classList.add('active');
            
            updateCalculation();
        }
        
        function updateCalculation() {
            value1 = getInputInches('feet1', 'inches1', 'fraction1');
            
            // Get value2 based on operation type
            if (currentOperation === '+' || currentOperation === '-') {
                // For addition/subtraction, use feet/inches input
                value2 = getInputInches('feet2', 'inches2', 'fraction2');
            } else if (currentOperation === '*' || currentOperation === '/') {
                // For multiplication/division, use simple number factor
                const factorInput = document.getElementById('factor');
                value2 = parseFloat(factorInput.value) || 0;
            }
            
            const equation = document.getElementById('calcEquation');
            const result = document.getElementById('calcResult');
            
            if (value1 > 0) {
                let equationText = inchesToDisplay(value1);
                
                if (currentOperation) {
                    equationText += ` ${currentOperation} `;
                    if (value2 > 0) {
                        // Show appropriate format for equation
                        if (currentOperation === '+' || currentOperation === '-') {
                            equationText += inchesToDisplay(value2);
                        } else {
                            equationText += value2.toString();
                        }
                        
                        // Auto-calculate if we have both values
                        let calcResult = 0;
                        switch (currentOperation) {
                            case '+': calcResult = value1 + value2; break;
                            case '-': calcResult = value1 - value2; break;
                            case '*': calcResult = value1 * value2; break;
                            case '/': calcResult = value2 !== 0 ? value1 / value2 : 0; break;
                        }
                        
                        if (calcResult !== 0) {
                            result.textContent = inchesToDisplay(calcResult);
                            result.classList.add('has-value');
                            currentValueInches = calcResult; // Update current value
                            lastCalculatorUpdate = Date.now(); // Mark calculator as most recent
                            lastConversionSource = 'calculator';
                            updateConversionPreview(); // Update conversion preview
                        }
                    }
                }
                equation.textContent = equationText;
            } else {
                equation.innerHTML = '&nbsp;';
                result.textContent = '0"';
                result.classList.remove('has-value');
            }
            
            // Update conversion preview
            updateConversionPreview();
        }
        
        function calculateResult() {
            // No longer needed - replaced by saveToHistory
        }
        
        function saveToHistory() {
            // Keep original functionality for backward compatibility
            if (!currentOperation || value1 === 0) {
                if (value1 > 0) {
                    // Just save the current value
                    addToCalcHistory({
                        equation: inchesToDisplay(value1),
                        result: value1,
                        timestamp: new Date().toLocaleTimeString(),
                        type: 'value'
                    });
                }
                return;
            }
            
            let result = 0;
            switch (currentOperation) {
                case '+': result = value1 + value2; break;
                case '-': result = value1 - value2; break;
                case '*': result = value1 * value2; break;
                case '/': 
                    if (value2 === 0) {
                        showNotification('Cannot divide by zero');
                        return;
                    }
                    result = value1 / value2;
                    break;
            }
            
            const timestamp = new Date().toLocaleTimeString();
            const historyEntry = {
                equation: `${inchesToDisplay(value1)} ${currentOperation} ${inchesToDisplay(value2)} = ${inchesToDisplay(result)}`,
                result: result,
                timestamp: timestamp,
                type: 'calculation'
            };
            
            addToCalcHistory(historyEntry);
            
            // Set result as new value1 for chaining calculations
            const parts = inchesToParts(result);
            document.getElementById('feet1').value = parts.feet || '';
            document.getElementById('inches1').value = parts.inches || '';
            document.getElementById('fraction1').value = parts.fraction || 0;
            
            // Clear second input
            clearInput2();
            currentOperation = null;
            document.getElementById('input2Group').style.display = 'none';
            document.querySelectorAll('.calc-btn.operation').forEach(btn => btn.classList.remove('active'));
            
            updateCalculation();
        }
        
        // New Save to Project functions
        function saveCalculatorToProject() {
            if (!currentOperation || value1 === 0) {
                if (value1 > 0) {
                    // Save just the current value
                    const data = {
                        equation: inchesToDisplay(value1),
                        result: inchesToDisplay(value1),
                        details: `Current calculator value: ${inchesToDisplay(value1)}`
                    };
                    showSaveToProjectModal('Calculator', data);
                }
                return;
            }
            
            let result = 0;
            switch (currentOperation) {
                case '+': result = value1 + value2; break;
                case '-': result = value1 - value2; break;
                case '*': result = value1 * value2; break;
                case '/': 
                    if (value2 === 0) {
                        showNotification('Cannot divide by zero');
                        return;
                    }
                    result = value1 / value2;
                    break;
            }
            
            const equation = `${inchesToDisplay(value1)} ${currentOperation} ${inchesToDisplay(value2)} = ${inchesToDisplay(result)}`;
            const data = {
                equation: equation,
                result: inchesToDisplay(result),
                details: `Calculation: ${inchesToDisplay(value1)} ${currentOperation} ${inchesToDisplay(value2)}\nResult: ${inchesToDisplay(result)}`
            };
            
            showSaveToProjectModal('Calculator', data);
            
            // Still perform the calculation locally
            const parts = inchesToParts(result);
            document.getElementById('feet1').value = parts.feet || '';
            document.getElementById('inches1').value = parts.inches || '';
            document.getElementById('fraction1').value = parts.fraction || 0;
            
            clearInput2();
            currentOperation = null;
            document.getElementById('input2Group').style.display = 'none';
            document.querySelectorAll('.calc-btn.operation').forEach(btn => btn.classList.remove('active'));
            
            updateCalculation();
        }
        
        function clearCalculator() {
            document.getElementById('feet1').value = '';
            document.getElementById('inches1').value = '';
            document.getElementById('fraction1').value = '0';
            clearInput2();
            currentOperation = null;
            value1 = 0;
            value2 = 0;
            // Hide both input groups
            document.getElementById('input2GroupFeetInches').style.display = 'none';
            document.getElementById('input2GroupNumber').style.display = 'none';
            document.querySelectorAll('.calc-btn.operation').forEach(btn => btn.classList.remove('active'));
            updateCalculation();
            updateConversionPreview();
        }
        
        function clearInput2() {
            // Clear feet/inches inputs
            document.getElementById('feet2').value = '';
            document.getElementById('inches2').value = '';
            document.getElementById('fraction2').value = '0';
            // Clear factor input
            document.getElementById('factor').value = '';
        }
        
        function memoryOperation(op) {
            const currentResult = value1 || 0;
            
            switch(op) {
                case 'MC': // Memory Clear
                    memoryValue = 0;
                    break;
                case 'MR': // Memory Recall
                    if (memoryValue !== 0) {
                        const parts = inchesToParts(memoryValue);
                        document.getElementById('feet1').value = parts.feet || '';
                        document.getElementById('inches1').value = parts.inches || '';
                        document.getElementById('fraction1').value = parts.fraction || 0;
                        updateCalculation();
                    }
                    break;
                case 'M+': // Memory Add
                    memoryValue += currentResult;
                    break;
                case 'M-': // Memory Subtract
                    memoryValue -= currentResult;
                    break;
            }
            
            // Update memory indicator
            updateMemoryIndicator();
        }
        
        function addToCalcHistory(entry) {
            const historyDiv = document.getElementById('history');
            if (!historyDiv) return;
            
            const historyItem = document.createElement('div');
            
            // Style based on type
            if (entry.type === 'conversion') {
                historyItem.className = 'history-conversion history-clickable';
                historyItem.innerHTML = `
                    <div class="history-label">Conversion</div>
                    <div class="history-equation">${entry.equation}</div>
                    <span class="history-timestamp">${entry.timestamp}</span>
                `;
            } else if (entry.type === 'preset') {
                historyItem.className = 'history-preset';
                historyItem.innerHTML = `
                    <div class="history-label">${entry.label || 'Calculation'}</div>
                    <div class="history-equation">${entry.equation}</div>
                    <span class="history-timestamp">${entry.timestamp}</span>
                `;
            } else {
                historyItem.className = 'history-result history-clickable';
                historyItem.innerHTML = `
                    <div class="history-equation">${entry.equation}</div>
                    <span class="history-timestamp">${entry.timestamp}</span>
                `;
            }
            
            // Make clickable if it has a result
            if (entry.result !== undefined) {
                historyItem.onclick = () => {
                    const parts = inchesToParts(entry.result);
                    document.getElementById('feet1').value = parts.feet || '';
                    document.getElementById('inches1').value = parts.inches || '';
                    document.getElementById('fraction1').value = parts.fraction || 0;
                    updateCalculation();
                };
            }
            
            historyDiv.insertBefore(historyItem, historyDiv.firstChild);
            
            // Keep only last 15 entries
            while (historyDiv.children.length > 15) {
                historyDiv.removeChild(historyDiv.lastChild);
            }
        }
        
        // Conversion functions - now work on the current calculator result
        function convertToDecimal() {
            const inches = getCurrentCalculatorValue();
            if (inches === 0) {
                showNotification('No value to convert. Enter a decimal value or perform a calculation first.', 'warning');
                return;
            }
            const decimal = inches.toFixed(4);
            const source = (lastDirectInputUpdate > lastCalculatorUpdate && document.getElementById('directDecimalInput').value) ? 'direct input' : 'calculator';
            addToCalcHistory({
                equation: `${inchesToDisplay(inches)} ‚Üí ${decimal}"`,
                result: inches,
                timestamp: new Date().toLocaleTimeString(),
                type: 'conversion'
            });
        }
        
        function convertToFraction() {
            const inches = getCurrentCalculatorValue();
            if (inches === 0) {
                showNotification('No value to convert. Enter a decimal value or perform a calculation first.', 'warning');
                return;
            }
            const fraction = inchesToDisplay(inches);
            const source = (lastDirectInputUpdate > lastCalculatorUpdate && document.getElementById('directDecimalInput').value) ? 'direct input' : 'calculator';
            addToCalcHistory({
                equation: `${inches.toFixed(4)}" ‚Üí ${fraction}`,
                result: inches,
                timestamp: new Date().toLocaleTimeString(),
                type: 'conversion'
            });
        }
        
        function convertToFeet() {
            const inches = getCurrentCalculatorValue();
            if (inches === 0) {
                showNotification('No value to convert. Enter a decimal value or perform a calculation first.', 'warning');
                return;
            }
            const feet = (inches / 12).toFixed(4);
            const source = (lastDirectInputUpdate > lastCalculatorUpdate && document.getElementById('directDecimalInput').value) ? 'direct input' : 'calculator';
            addToCalcHistory({
                equation: `${inchesToDisplay(inches)} ‚Üí ${feet} ft`,
                result: inches,
                timestamp: new Date().toLocaleTimeString(),
                type: 'conversion'
            });
        }
        
        function convertToInches() {
            const inches = getCurrentCalculatorValue();
            if (inches === 0) {
                showNotification('No value to convert. Enter a decimal value or perform a calculation first.', 'warning');
                return;
            }
            const totalInches = inches.toFixed(4);
            const source = (lastDirectInputUpdate > lastCalculatorUpdate && document.getElementById('directDecimalInput').value) ? 'direct input' : 'calculator';
            addToCalcHistory({
                equation: `${inchesToDisplay(inches)} ‚Üí ${totalInches}"`,
                result: inches,
                timestamp: new Date().toLocaleTimeString(),
                type: 'conversion'
            });
        }
        
        // Direct decimal input conversion functions
        function handleDirectInput() {
            const directInput = document.getElementById('directDecimalInput');
            const conversionValueSpan = document.getElementById('conversionValue');
            
            if (directInput.value && !isNaN(directInput.value)) {
                const inches = parseFloat(directInput.value);
                conversionValueSpan.textContent = `${inches.toFixed(3)}" (from direct input)`;
                lastDirectInputUpdate = Date.now(); // Mark direct input as most recent
                lastConversionSource = 'direct';
            } else {
                updateConversionPreview(); // Fall back to calculator value
            }
        }
        
        function convertDirectInput() {
            const directInput = document.getElementById('directDecimalInput');
            const inches = parseFloat(directInput.value);
            
            if (!directInput.value || isNaN(inches)) {
                showNotification('Please enter a valid decimal value in inches', 'warning');
                return;
            }
            
            // Convert to feet/inches/fraction format at current precision
            const fraction = inchesToDisplay(inches);
            
            // Add to history
            addToCalcHistory({
                equation: `${inches}" ‚Üí ${fraction}`,
                result: inches,
                timestamp: new Date().toLocaleTimeString(),
                type: 'direct_conversion'
            });
            
            
            // Mark direct input as most recent action
            lastDirectInputUpdate = Date.now();
            lastConversionSource = 'direct';
            
            // Set this as the current calculator value for further conversions
            currentValueInches = inches;
            updateConversionPreview(); // Update conversion preview
        }
        
        // Helper function to get the current calculator value (result, input, or direct input)
        function getCurrentCalculatorValue() {
            const directInput = document.getElementById('directDecimalInput');
            const hasDirectInput = directInput && directInput.value && !isNaN(directInput.value);
            const hasCalculatorResult = currentValueInches > 0;
            
            // If both direct input and calculator result exist, use the most recent one
            if (hasDirectInput && hasCalculatorResult) {
                // Use timestamps to determine which was most recent
                if (lastDirectInputUpdate > lastCalculatorUpdate) {
                    return parseFloat(directInput.value);
                } else {
                    return currentValueInches;
                }
            }
            
            // If only direct input exists, use it
            if (hasDirectInput) {
                return parseFloat(directInput.value);
            }
            
            // If only calculator result exists, use it
            if (hasCalculatorResult) {
                return currentValueInches;
            }
            
            // Otherwise, use input 1 if it has a value
            if (value1 > 0) {
                return value1;
            }
            
            // No value available
            return 0;
        }
        
        // Update the conversion preview to show what value will be converted
        function updateConversionPreview() {
            const conversionValueSpan = document.getElementById('conversionValue');
            if (!conversionValueSpan) return;
            
            const inches = getCurrentCalculatorValue();
            if (inches > 0) {
                const directInput = document.getElementById('directDecimalInput');
                const isFromDirect = (lastDirectInputUpdate > lastCalculatorUpdate && directInput.value && !isNaN(directInput.value));
                const source = isFromDirect ? 'direct input' : 'calculator';
                
                conversionValueSpan.textContent = `${inchesToDisplay(inches)} (from ${source})`;
                conversionValueSpan.parentElement.style.opacity = '1';
            } else {
                conversionValueSpan.textContent = 'Enter a value or calculate';
                conversionValueSpan.parentElement.style.opacity = '0.7';
            }
        }
        
        // Preset calculations with modal
        let currentModalCalc = null;
        
        function showBoardFootCalc() {
            currentModalCalc = 'boardfoot';
            const modal = document.getElementById('calcModal');
            const title = document.getElementById('calcModalTitle');
            const inputs = document.getElementById('calcModalInputs');
            
            title.textContent = 'Lumber Shopping Cart';
            inputs.innerHTML = `
                <div class="input-group">
                    <label>Thickness (inches):</label>
                    <input type="number" id="modalThickness" step="0.25" class="wide-input" placeholder="1">
                </div>
                <div class="input-group">
                    <label>Width (inches):</label>
                    <input type="number" id="modalWidth" step="0.25" class="wide-input" placeholder="6">
                </div>
                <div class="input-group">
                    <label>Length (feet):</label>
                    <input type="number" id="modalLength" step="0.5" class="wide-input" placeholder="8">
                </div>
            `;
            
            modal.style.display = 'block';
        }
        
        function calculateGoldenRatio() {
            const inches = value1 || 0;
            if (inches === 0) {
                showNotification('Enter a value first');
                return;
            }
            
            const golden = 1.618033988749895;
            const result = inches * golden;
            
            
            // Set result as new value1
            const parts = inchesToParts(result);
            document.getElementById('feet1').value = parts.feet || '';
            document.getElementById('inches1').value = parts.inches || '';
            document.getElementById('fraction1').value = parts.fraction || 0;
            updateCalculation();
        }
        
        function showSpacingCalc() {
            const totalLength = value1 || 0;
            if (totalLength === 0) {
                showNotification('Enter total length first');
                return;
            }
            
            currentModalCalc = 'spacing';
            const modal = document.getElementById('calcModal');
            const title = document.getElementById('calcModalTitle');
            const inputs = document.getElementById('calcModalInputs');
            
            title.textContent = 'Shelf & Division Calculator';
            inputs.innerHTML = `
                <div style="margin-bottom: 10px;">Total length: <strong>${inchesToDisplay(totalLength)}</strong></div>
                <div class="input-group">
                    <label>Number of spaces:</label>
                    <input type="number" id="modalSpaces" min="2" class="wide-input" placeholder="4">
                </div>
            `;
            
            modal.style.display = 'block';
        }
        
        function showAngleCalc() {
            currentModalCalc = 'angle';
            const modal = document.getElementById('calcModal');
            const title = document.getElementById('calcModalTitle');
            const inputs = document.getElementById('calcModalInputs');
            
            title.textContent = 'Miter & Angle Calculator';
            inputs.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <label style="font-weight: bold;">Calculator Type:</label>
                    <div style="margin-top: 10px;">
                        <label style="display: block; margin-bottom: 8px;">
                            <input type="radio" name="calcType" value="polygon" checked onchange="updateAngleCalcType()">
                            Polygon (equal-sided shape)
                        </label>
                        <label style="display: block;">
                            <input type="radio" name="calcType" value="single" onchange="updateAngleCalcType()">
                            Single angle cut
                        </label>
                    </div>
                </div>
                
                <div id="polygonInputs">
                    <div class="input-group">
                        <label>Number of sides:</label>
                        <input type="number" id="modalSides" min="3" class="wide-input" placeholder="8">
                    </div>
                    <p style="font-size: 12px; color: #666;">Examples: 4 = square, 6 = hexagon, 8 = octagon</p>
                </div>
                
                <div id="singleAngleInputs" style="display: none;">
                    <div class="input-group">
                        <label>Miter angle (degrees):</label>
                        <input type="number" id="modalAngle" step="0.5" class="wide-input" placeholder="45">
                    </div>
                    <div class="input-group">
                        <label>Board width:</label>
                        <input type="number" id="modalBoardWidth" step="0.0625" class="wide-input" placeholder="3.5">
                        <span>inches</span>
                    </div>
                    <div class="input-group">
                        <label>Known side:</label>
                        <select id="modalKnownSide" onchange="updateAngleLabels()">
                            <option value="long">Long side (back)</option>
                            <option value="short">Short side (front)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label id="knownLengthLabel">Long side length:</label>
                        <input type="number" id="modalKnownLength" step="0.0625" class="wide-input" placeholder="12">
                        <span>inches</span>
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                        <svg width="250" height="120" viewBox="0 0 250 120">
                            <!-- Board outline -->
                            <rect x="30" y="30" width="180" height="50" fill="#D2691E" stroke="var(--primary-color)" stroke-width="2"/>
                            <!-- Miter cut line -->
                            <line x1="150" y1="30" x2="210" y2="80" stroke="#FFD700" stroke-width="3"/>
                            <line x1="152" y1="30" x2="212" y2="80" stroke="#000" stroke-width="1" stroke-dasharray="3,3"/>
                            <!-- Dimension lines -->
                            <line x1="30" y1="20" x2="150" y2="20" stroke="#333" stroke-width="1"/>
                            <line x1="30" y1="20" x2="30" y2="25" stroke="#333" stroke-width="1"/>
                            <line x1="150" y1="20" x2="150" y2="25" stroke="#333" stroke-width="1"/>
                            <line x1="30" y1="90" x2="210" y2="90" stroke="#333" stroke-width="1"/>
                            <line x1="30" y1="85" x2="30" y2="90" stroke="#333" stroke-width="1"/>
                            <line x1="210" y1="85" x2="210" y2="90" stroke="#333" stroke-width="1"/>
                            <!-- Width indicator -->
                            <line x1="220" y1="30" x2="220" y2="80" stroke="#666" stroke-width="1"/>
                            <line x1="215" y1="30" x2="220" y2="30" stroke="#666" stroke-width="1"/>
                            <line x1="215" y1="80" x2="220" y2="80" stroke="#666" stroke-width="1"/>
                            <!-- Labels -->
                            <text x="90" y="15" text-anchor="middle" font-size="11" fill="#333">Short (front)</text>
                            <text x="120" y="105" text-anchor="middle" font-size="11" fill="#333">Long (back)</text>
                            <text x="180" y="60" text-anchor="middle" font-size="10" fill="#000">Cut</text>
                            <text x="235" y="58" text-anchor="middle" font-size="9" fill="#666">Width</text>
                        </svg>
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
        }
        
        function updateAngleCalcType() {
            const calcType = document.querySelector('input[name="calcType"]:checked').value;
            document.getElementById('polygonInputs').style.display = calcType === 'polygon' ? 'block' : 'none';
            document.getElementById('singleAngleInputs').style.display = calcType === 'single' ? 'block' : 'none';
        }
        
        function updateAngleLabels() {
            const knownSide = document.getElementById('modalKnownSide').value;
            const label = document.getElementById('knownLengthLabel');
            label.textContent = knownSide === 'long' ? 'Long side length:' : 'Short side length:';
        }
        
        function closeCalcModal() {
            document.getElementById('calcModal').style.display = 'none';
            currentModalCalc = null;
        }
        
        function executeModalCalc() {
            if (currentModalCalc === 'boardfoot') {
                const thickness = parseFloat(document.getElementById('modalThickness')?.value) || 0;
                const width = parseFloat(document.getElementById('modalWidth')?.value) || 0;
                const length = parseFloat(document.getElementById('modalLength')?.value) || 0;
                
                if (thickness && width && length) {
                    const boardFeet = (thickness * width * length) / 12;
                    closeCalcModal();
                } else {
                    showNotification('Please fill in all fields');
                }
            } else if (currentModalCalc === 'spacing') {
                const spaces = parseInt(document.getElementById('modalSpaces')?.value) || 0;
                if (spaces > 0) {
                    const spacing = value1 / spaces;
                    closeCalcModal();
                } else {
                    showNotification('Please enter number of spaces');
                }
            } else if (currentModalCalc === 'angle') {
                const calcType = document.querySelector('input[name="calcType"]:checked').value;
                
                if (calcType === 'polygon') {
                    const sides = parseInt(document.getElementById('modalSides')?.value) || 0;
                    if (sides > 2) {
                        const miterAngle = 180 / sides;
                        const sawAngle = 90 - miterAngle;
                        closeCalcModal();
                    } else {
                        showNotification('Please enter valid number of sides');
                    }
                } else {
                    // Single angle calculation
                    const angle = parseFloat(document.getElementById('modalAngle')?.value) || 0;
                    const boardWidth = parseFloat(document.getElementById('modalBoardWidth')?.value) || 0;
                    const knownSide = document.getElementById('modalKnownSide').value;
                    const knownLength = parseFloat(document.getElementById('modalKnownLength')?.value) || 0;
                    
                    if (angle > 0 && angle < 90 && boardWidth > 0 && knownLength > 0) {
                        const angleRad = (angle * Math.PI) / 180;
                        let longSide, shortSide;
                        
                        // For a miter cut across a board:
                        // The difference between long and short sides = board width / tan(angle)
                        const difference = boardWidth / Math.tan(angleRad);
                        
                        if (knownSide === 'long') {
                            longSide = knownLength;
                            shortSide = longSide - difference;
                            
                            if (shortSide <= 0) {
                                showNotification('This cut would result in no material on the short side');
                                return;
                            }
                        } else {
                            shortSide = knownLength;
                            longSide = shortSide + difference;
                        }
                        
                        
                        // Set the calculated value as new input
                        const parts = inchesToParts(knownSide === 'long' ? shortSide : longSide);
                        document.getElementById('feet1').value = parts.feet || '';
                        document.getElementById('inches1').value = parts.inches || '';
                        document.getElementById('fraction1').value = parts.fraction || 0;
                        updateCalculation();
                        
                        closeCalcModal();
                    } else {
                        showNotification('Please enter valid angle (0-90¬∞), board width, and length');
                    }
                }
            }
        }
        
        function updateCutValue() {
            cutValueInches = getInputInches('cutFeet', 'cutInches', 'cutFraction');
            const display = cutValueInches > 0 ? inchesToDisplay(cutValueInches, 'cut') : 'Enter measurement above';
            document.getElementById('cutCurrentValue').textContent = display;
        }
        
        function performDivision() {
            const pieces = parseInt(document.getElementById('divisionSelect').value);
            if (pieces && cutValueInches > 0) {
                quickCut(pieces);
                document.getElementById('divisionSelect').value = ''; // Reset dropdown
            } else if (pieces && cutValueInches <= 0) {
                showNotification('Please enter a board length first');
            }
        }
        
        function performCustomDivision() {
            const pieces = parseInt(document.getElementById('customPieces').value);
            if (pieces && pieces >= 2 && pieces <= 20 && cutValueInches > 0) {
                quickCut(pieces);
            } else if (pieces && cutValueInches <= 0) {
                showNotification('Please enter a board length first');
            } else if (pieces && (pieces < 2 || pieces > 20)) {
                showNotification('Please enter a number between 2 and 20');
            }
        }
        
        function toggleInputMode() {
            inputMode = inputMode === 'fraction' ? 'decimal' : 'fraction';
            const fractionInputs = document.getElementById('fractionInputs');
            const decimalInputs = document.getElementById('decimalInputs');
            const toggleBtn = document.getElementById('modeToggle');
            
            if (inputMode === 'fraction') {
                fractionInputs.style.display = 'flex';
                decimalInputs.style.display = 'none';
                toggleBtn.textContent = 'Decimal Mode';
            } else {
                fractionInputs.style.display = 'none';
                decimalInputs.style.display = 'flex';
                toggleBtn.textContent = 'Fraction Mode';
            }
        }
        
        function getOperationValue() {
            if (inputMode === 'fraction') {
                return getInputInches('opFeet', 'opInches', 'opFraction');
            } else {
                return parseFloat(document.getElementById('operationValue')?.value) || 0;
            }
        }
        
        function quickCut(pieces) {
            if (cutValueInches <= 0) {
                showNotification('Please set a measurement first');
                return;
            }
            
            const kerfEnabled = document.getElementById('cutKerfEnabled')?.checked;
            const kerf = kerfEnabled ? parseFloat(document.getElementById('cutKerf')?.value || 0.125) : 0;
            const cutSide = document.getElementById('cutSide')?.value || 'left';
            const totalKerf = kerf * (pieces - 1);
            const pieceLength = (cutValueInches - totalKerf) / pieces;
            
            let results = [];
            let currentPos = 0;
            
            for (let i = 0; i < pieces - 1; i++) {
                // Calculate where each piece ends
                currentPos += pieceLength;
                
                // Adjust mark position based on cut side
                let markPosition = currentPos;
                if (kerfEnabled && cutSide === 'left') {
                    // If cutting on left side of mark, add kerf to mark position
                    markPosition += kerf;
                }
                // If cutting on right side, mark position stays at piece end
                
                results.push({
                    position: markPosition,
                    display: inchesToDisplay(markPosition, 'cut')
                });
            }
            
            // Create visual results
            const cutResults = document.createElement('div');
            cutResults.className = 'cut-results';
            
            const kerfNote = kerfEnabled ? ` (${inchesToDisplay(kerf, 'cut')} kerf)` : ' (no kerf)';
            const cutSideNote = kerfEnabled ? `, ${cutSide} side` : '';
            
            // Store cut result data globally for saving
            const cutResultData = {
                originalLength: inchesToDisplay(cutValueInches, 'cut'),
                pieces: pieces,
                pieceLength: inchesToDisplay(pieceLength, 'cut'),
                results: results,
                kerfNote: kerfNote,
                cutSideNote: cutSideNote
            };
            currentCutResults.unshift(cutResultData);
            
            // Keep only last 5 results
            if (currentCutResults.length > 5) {
                currentCutResults = currentCutResults.slice(0, 5);
            }
            
            // Generate visual board diagram
            const visualBoard = generateVisualBoard(cutValueInches, results, pieces, pieceLength);
            
            // Generate marking guide similar to Shelf & Division Calculator
            const markingGuide = generateMarkingGuide(results, pieces, pieceLength, cutValueInches);
            
            cutResults.innerHTML = `
                <h4>Cut ${inchesToDisplay(cutValueInches, 'cut')} into ${pieces} equal pieces${kerfNote}${cutSideNote}</h4>
                ${visualBoard}
                ${markingGuide}
                <div class="piece-info">
                    Result: ${pieces} pieces @ ${inchesToDisplay(pieceLength, 'cut')} each
                </div>
                <div class="cut-result-actions">
                    <button class="btn btn-success btn-sm" onclick="saveCutToProject(0)">Save to Project</button>
                </div>
            `;
            
            // Add to history
            const historyDiv = document.getElementById('cutHistory');
            if (historyDiv) {
                historyDiv.insertBefore(cutResults, historyDiv.firstChild);
                
                // Keep only last 5 results
                while (historyDiv.children.length > 5) {
                    historyDiv.removeChild(historyDiv.lastChild);
                }
            }
        }
        
        function generateVisualBoard(totalLength, cutMarks, pieces, pieceLength) {
            const kerfEnabled = document.getElementById('cutKerfEnabled')?.checked;
            const kerf = kerfEnabled ? parseFloat(document.getElementById('cutKerf')?.value || 0.125) : 0;
            const cutSide = document.getElementById('cutSide')?.value || 'left';
            
            // Generate cut marks and kerf cutouts positioned proportionally
            const cutElements = [];
            
            cutMarks.forEach((mark, i) => {
                const markPercent = (mark.position / totalLength) * 100;
                
                // Add the cut mark line
                cutElements.push(`<div class="cut-mark" style="left: ${markPercent}%" data-mark="Mark ${i + 1}: ${mark.display}"></div>`);
                
                // Add kerf cutout if enabled
                if (kerfEnabled && kerf > 0) {
                    const kerfWidthPercent = (kerf / totalLength) * 100;
                    let kerfLeft;
                    
                    if (cutSide === 'left') {
                        // Kerf is to the left of the mark
                        kerfLeft = markPercent - kerfWidthPercent;
                    } else {
                        // Kerf is to the right of the mark
                        kerfLeft = markPercent;
                    }
                    
                    cutElements.push(`
                        <div class="kerf-cutout ${cutSide}-side" 
                             style="left: ${kerfLeft}%; width: ${kerfWidthPercent}%">
                        </div>
                    `);
                }
            });
            
            // Generate piece labels
            const pieceLabels = [];
            for (let i = 0; i < pieces; i++) {
                const pieceStart = (i * (pieceLength + kerf) / totalLength) * 100;
                const pieceEnd = ((i + 1) * pieceLength + i * kerf) / totalLength * 100;
                const pieceCenter = (pieceStart + pieceEnd) / 2;
                
                pieceLabels.push(`
                    <div class="piece-label" style="left: ${pieceCenter}%; transform: translateX(-50%);">
                        Piece ${i + 1}<br>
                        <small>${inchesToDisplay(pieceLength, 'cut')}</small>
                    </div>
                `);
            }
            
            return `
                <div class="visual-board">
                    <div class="board-container">
                        <div class="board-ends left"></div>
                        <div class="board-ends right"></div>
                        ${cutElements.join('')}
                    </div>
                    <div class="board-dimension">Total Length: ${inchesToDisplay(totalLength, 'cut')}</div>
                    <div class="piece-labels">
                        ${pieceLabels.join('')}
                    </div>
                </div>
            `;
        }
        
        function generateMarkingGuide(cutMarks, pieces, pieceLength, totalLength) {
            if (!cutMarks || cutMarks.length === 0) {
                return '';
            }
            
            return `
                <div class="marking-guide">
                    <div class="marks-header">üìç Cut Mark Positions:</div>
                    <div class="marks-grid">
                        ${cutMarks.map((mark, i) => `
                            <div class="mark-item">
                                <span class="mark-number">Mark ${i + 1}:</span>
                                <span class="mark-value">${mark.display}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="marking-summary">
                        <div class="summary-item">
                            <strong>Total Length:</strong> ${inchesToDisplay(totalLength, 'cut')}
                        </div>
                        <div class="summary-item">
                            <strong>Pieces:</strong> ${pieces} √ó ${inchesToDisplay(pieceLength, 'cut')} each
                        </div>
                    </div>
                </div>
            `;
        }
        
        function customCut() {
            // This function is now handled by performCustomDivision()
            performCustomDivision();
        }
        
        function toggleKerfDisplay() {
            const cutKerfEnabled = document.getElementById('cutKerfEnabled')?.checked;
            const optKerfEnabled = document.getElementById('optKerfEnabled')?.checked;
            
            const cutKerfRow = document.getElementById('cutKerfRow');
            const optKerfRow = document.getElementById('optKerfRow');
            
            if (cutKerfRow) {
                cutKerfRow.style.display = cutKerfEnabled ? 'flex' : 'none';
            }
            if (optKerfRow) {
                optKerfRow.style.display = optKerfEnabled ? 'flex' : 'none';
            }
            
            updateKerfDiagram();
        }
        
        function updateKerfDiagram() {
            const kerfEnabled = document.getElementById('cutKerfEnabled')?.checked;
            const cutSide = document.getElementById('cutSide')?.value || 'right';
            const diagram = document.getElementById('kerfDiagram');
            const kerfArea = document.getElementById('kerfAreaSvg');
            const kerfLabel = document.getElementById('kerfLabelSvg');
            const kerfWidth = parseFloat(document.getElementById('cutKerfSize')?.value || 0.125);
            
            if (diagram) {
                diagram.style.display = kerfEnabled ? 'flex' : 'none';
                if (kerfArea && kerfLabel && kerfEnabled) {
                    // Exaggerate kerf width for visibility (multiply by 8 for visual clarity)
                    const svgKerfWidth = (kerfWidth / 12) * 300 * 8; // Convert inches to relative width, then exaggerate
                    
                    if (cutSide === 'left') {
                        kerfArea.setAttribute('x', 200 - svgKerfWidth);
                        kerfArea.setAttribute('width', svgKerfWidth);
                        kerfLabel.setAttribute('x', 200 - svgKerfWidth/2);
                    } else {
                        kerfArea.setAttribute('x', 200);
                        kerfArea.setAttribute('width', svgKerfWidth);
                        kerfLabel.setAttribute('x', 200 + svgKerfWidth/2);
                    }
                    kerfLabel.style.display = svgKerfWidth > 20 ? 'block' : 'none';
                }
            }
        }
        
        function operation(op) {
            // Clear previous operation highlighting
            document.querySelectorAll('.btn-operation').forEach(btn => btn.classList.remove('active'));
            
            currentOperation = op;
            
            // Highlight the selected operation
            event.target.classList.add('active');
            
            if (inputMode === 'decimal') {
                document.getElementById('operationValue')?.focus();
            }
        }
        
        function executeOperation() {
            if (currentValueInches <= 0) {
                showNotification('Please set a measurement first');
                return;
            }
            
            if (!currentOperation) {
                showNotification('Please select an operation first');
                return;
            }
            
            const value = getOperationValue();
            if (value <= 0 && currentOperation === '/') {
                showNotification('Cannot divide by zero or negative number');
                return;
            }
            
            const oldValue = currentValueInches;
            let newValue;
            
            switch (currentOperation) {
                case '+':
                    newValue = currentValueInches + value;
                    break;
                case '-':
                    newValue = currentValueInches - value;
                    break;
                case '*':
                    newValue = currentValueInches * value;
                    break;
                case '/':
                    newValue = currentValueInches / value;
                    break;
            }
            
            currentValueInches = newValue;
            document.getElementById('currentValue').textContent = inchesToDisplay(currentValueInches);
            
            const valueDisplay = inputMode === 'fraction' ? inchesToDisplay(value) : value + '"';
            addHistory(`${inchesToDisplay(oldValue)} ${currentOperation} ${valueDisplay} = ${inchesToDisplay(newValue)}`);
            
            // Clear operation selection and highlighting
            currentOperation = null;
            document.querySelectorAll('.btn-operation').forEach(btn => btn.classList.remove('active'));
            clearOperationInputs();
        }
        
        function clearOperationInputs() {
            if (document.getElementById('opFeet')) document.getElementById('opFeet').value = '';
            if (document.getElementById('opInches')) document.getElementById('opInches').value = '';
            if (document.getElementById('opFraction')) document.getElementById('opFraction').value = '0';
            if (document.getElementById('operationValue')) document.getElementById('operationValue').value = '';
        }
        
        function addHistory(item) {
            history.unshift(item);
            if (history.length > 20) history.pop();
            
            const historyDiv = document.getElementById('history');
            if (historyDiv) {
                historyDiv.innerHTML = history.map(h => `<div class="history-item">${h}</div>`).join('');
            }
        }
        
        function addCutHistory(item) {
            cutHistory.unshift(item);
            if (cutHistory.length > 20) cutHistory.pop();
            
            const historyDiv = document.getElementById('cutHistory');
            if (historyDiv) {
                historyDiv.innerHTML = cutHistory.map(h => `<div class="history-item">${h}</div>`).join('');
            }
        }
        
        function updateHistory() {
            const historyDiv = document.getElementById('history');
            if (historyDiv) {
                // Filter out any non-string items and convert objects to strings
                const validHistory = history.filter(h => h && typeof h === 'string');
                historyDiv.innerHTML = validHistory.map(h => `<div class="history-item">${h}</div>`).join('');
            }
        }
        
        function updateCutHistory() {
            const historyDiv = document.getElementById('cutHistory');
            if (historyDiv) {
                // Filter out any non-string items and convert objects to strings
                const validHistory = cutHistory.filter(h => h && typeof h === 'string');
                historyDiv.innerHTML = validHistory.map(h => `<div class="history-item">${h}</div>`).join('');
            }
        }
        
        function updateMemoryIndicator() {
            const indicator = document.getElementById('memoryIndicator');
            if (indicator) {
                if (memoryValue !== 0) {
                    indicator.textContent = `M: ${inchesToDisplay(memoryValue)}`;
                } else {
                    indicator.textContent = '';
                }
            }
        }
        
        function clearAll() {
            currentValueInches = 0;
            currentOperation = null;
            if (document.getElementById('currentValue')) document.getElementById('currentValue').textContent = 'Enter measurement above';
            if (document.getElementById('feet')) document.getElementById('feet').value = '';
            if (document.getElementById('inches')) document.getElementById('inches').value = '';
            if (document.getElementById('fraction')) document.getElementById('fraction').value = '0';
            clearOperationInputs();
        }
        
        function clearCut() {
            cutValueInches = 0;
            if (document.getElementById('cutCurrentValue')) document.getElementById('cutCurrentValue').textContent = 'Enter measurement above';
            if (document.getElementById('cutFeet')) document.getElementById('cutFeet').value = '';
            if (document.getElementById('cutInches')) document.getElementById('cutInches').value = '';
            if (document.getElementById('cutFraction')) document.getElementById('cutFraction').value = '0';
            if (document.getElementById('cutHistory')) document.getElementById('cutHistory').innerHTML = '';
        }
        
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (event && event.target) event.target.classList.add('active');
            const targetTab = document.getElementById(tab);
            if (targetTab) targetTab.classList.add('active');
            
            // When switching to projects tab, ensure timeline is rendered and synced
            if (tab === 'projects') {
                renderProjectTimeline();
            }
        }
        
        function switchCutMode(mode) {
            // Update mode buttons
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            
            if (mode === 'equal') {
                document.getElementById('equalDivisionMode').classList.add('active');
                document.getElementById('equalDivisionContent').style.display = 'block';
                document.getElementById('cutOptimizationContent').style.display = 'none';
            } else if (mode === 'optimization') {
                document.getElementById('cutOptimizationMode').classList.add('active');
                document.getElementById('equalDivisionContent').style.display = 'none';
                document.getElementById('cutOptimizationContent').style.display = 'block';
                
                // Synchronize precision settings
                const cutPrecision = document.getElementById('cutPrecision')?.value;
                const optPrecision = document.getElementById('optPrecision');
                if (cutPrecision && optPrecision) {
                    optPrecision.value = cutPrecision;
                }
                
                // Synchronize kerf settings
                const cutKerfEnabled = document.getElementById('cutKerfEnabled')?.checked;
                const optKerfEnabled = document.getElementById('optKerfEnabled');
                if (optKerfEnabled) {
                    optKerfEnabled.checked = cutKerfEnabled;
                }
                
                const cutKerf = document.getElementById('cutKerf')?.value;
                const optKerf = document.getElementById('optKerf');
                if (cutKerf && optKerf) {
                    optKerf.value = cutKerf;
                }
                
                // Update precision after synchronization
                updatePrecision('cut');
            }
        }
        
        // Dad Jokes Feature
        async function fetchDadJoke() {
            const modal = document.getElementById('jokeModal');
            const jokeText = document.getElementById('jokeText');
            const loadingText = document.getElementById('jokeLoading');
            
            // Show modal with loading state
            if (modal) {
                modal.style.display = 'block';
                jokeText.style.display = 'none';
                loadingText.style.display = 'block';
            }
            
            try {
                const response = await fetch('https://icanhazdadjoke.com/', {
                    headers: { 'Accept': 'application/json' }
                });
                
                if (!response.ok) throw new Error('Dad joke service unavailable');
                
                const data = await response.json();
                
                // Show the joke
                if (modal) {
                    loadingText.style.display = 'none';
                    jokeText.style.display = 'block';
                    jokeText.textContent = data.joke;
                }
                
            } catch (error) {
                console.error('Dad joke fetch failed:', error);
                if (modal) {
                    loadingText.style.display = 'none';
                    jokeText.style.display = 'block';
                    jokeText.textContent = "Dad joke service is taking a break! Here's a backup: Why don't scientists trust atoms? Because they make up everything! üòÖ";
                }
            }
        }
        
        function closeJoke() {
            const modal = document.getElementById('jokeModal');
            if (modal) modal.style.display = 'none';
        }

        function showHelp() {
            const modal = document.getElementById('helpModal');
            if (modal) modal.style.display = 'block';
        }
        
        function closeHelp() {
            const modal = document.getElementById('helpModal');
            if (modal) modal.style.display = 'none';
        }
        
        // Edit modal functions
        function showEditModal(type, data) {
            editingItem = { type: type, data: data };
            const modal = document.getElementById('editModal');
            const title = document.getElementById('editTitle');
            const inputs = document.getElementById('editInputs');
            
            if (type === 'board') {
                title.textContent = 'Edit Board';
                const parts = inchesToParts(data.length);
                inputs.innerHTML = `
                    <div class="input-group">
                        <label>Length:</label>
                        <input type="number" id="editFeet" placeholder="0" min="0" class="wide-input" value="${parts.feet}">
                        <span>ft</span>
                        <input type="number" id="editInches" placeholder="0" min="0" max="11" class="wide-input" value="${parts.inches}">
                        <span>in</span>
                        <select id="editFraction" style="width: 120px;">
                            <option value="0">0</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Quantity:</label>
                        <input type="number" id="editQuantity" placeholder="1" min="0" class="wide-input" value="${data.quantity}">
                    </div>
                `;
                updatePrecision('edit'); // Update fraction options for edit modal
                setTimeout(() => {
                    if (document.getElementById('editFraction')) {
                        document.getElementById('editFraction').value = parts.fraction;
                    }
                }, 10);
            } else if (type === 'cutGroup') {
                title.textContent = 'Edit Cut Group';
                const parts = inchesToParts(data.length);
                inputs.innerHTML = `
                    <div class="input-group">
                        <label>Length:</label>
                        <input type="number" id="editFeet" placeholder="0" min="0" class="wide-input" value="${parts.feet}">
                        <span>ft</span>
                        <input type="number" id="editInches" placeholder="0" min="0" max="11" class="wide-input" value="${parts.inches}">
                        <span>in</span>
                        <select id="editFraction" style="width: 120px;">
                            <option value="0">0</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Quantity:</label>
                        <input type="number" id="editQuantity" placeholder="1" min="0" class="wide-input" value="${data.count}">
                    </div>
                `;
                updatePrecision('edit'); // Update fraction options for edit modal
                document.getElementById('editFraction').value = parts.fraction;
            }
            
            modal.style.display = 'block';
        }
        
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            editingItem = null;
        }
        
        function saveEdit() {
            if (!editingItem) return;
            
            const newLength = getInputInches('editFeet', 'editInches', 'editFraction');
            const newQuantity = parseInt(document.getElementById('editQuantity')?.value) || 0;
            
            if (newLength <= 0) {
                showNotification('Please enter a valid length');
                return;
            }
            
            if (editingItem.type === 'board') {
                const index = editingItem.data.index;
                if (newQuantity > 0) {
                    boards[index] = { length: newLength, quantity: newQuantity };
                } else {
                    boards.splice(index, 1);
                }
                updateBoardsList();
            } else if (editingItem.type === 'cutGroup') {
                // Remove old cuts
                cuts = cuts.filter(cut => cut.id === undefined || !editingItem.data.ids.includes(cut.id));
                
                // Add new cuts
                for (let i = 0; i < newQuantity; i++) {
                    cuts.push({ length: newLength, id: cutIdCounter++ });
                }
                updateCutsList();
            }
            
            closeEditModal();
        }
        
        function deleteEdit() {
            if (!editingItem) return;
            
            if (confirm('Are you sure you want to delete this item?')) {
                if (editingItem.type === 'board') {
                    boards.splice(editingItem.data.index, 1);
                    updateBoardsList();
                } else if (editingItem.type === 'cutGroup') {
                    cuts = cuts.filter(cut => cut.id === undefined || !editingItem.data.ids.includes(cut.id));
                    updateCutsList();
                }
                closeEditModal();
            }
        }
        
        function editBoard(index) {
            showEditModal('board', { ...boards[index], index: index });
        }
        
        function editCutGroup(length, ids) {
            showEditModal('cutGroup', { length: length, count: ids.length, ids: ids });
        }
        
        function addBoard() {
            const inches = getInputInches('boardFeet', 'boardInches', 'boardFraction');
            const quantity = parseInt(document.getElementById('boardQuantity')?.value) || 1;
            if (inches <= 0) return;
            
            // Check if this board size already exists
            const existingBoard = boards.find(board => Math.abs(board.length - inches) < 0.01);
            if (existingBoard) {
                existingBoard.quantity += quantity;
            } else {
                boards.push({ length: inches, quantity: quantity });
            }
            
            updateBoardsList();
            
            if (document.getElementById('boardFeet')) document.getElementById('boardFeet').value = '';
            if (document.getElementById('boardInches')) document.getElementById('boardInches').value = '';
            if (document.getElementById('boardFraction')) document.getElementById('boardFraction').value = '0';
            if (document.getElementById('boardQuantity')) document.getElementById('boardQuantity').value = '1';
        }
        
        function addCut() {
            const inches = getInputInches('optCutFeet', 'optCutInches', 'optCutFraction');
            const quantity = parseInt(document.getElementById('cutQuantity')?.value) || 1;
            if (inches <= 0) return;
            
            for (let i = 0; i < quantity; i++) {
                cuts.push({ length: inches, id: cutIdCounter++ });
            }
            updateCutsList();
            
            if (document.getElementById('optCutFeet')) document.getElementById('optCutFeet').value = '';
            if (document.getElementById('optCutInches')) document.getElementById('optCutInches').value = '';
            if (document.getElementById('optCutFraction')) document.getElementById('optCutFraction').value = '0';
            if (document.getElementById('cutQuantity')) document.getElementById('cutQuantity').value = '1';
        }
        
        function updateBoardsList() {
            const div = document.getElementById('boardsList');
            if (!div) return;
            
            div.innerHTML = boards.map((board, i) => 
                `<div style="padding: 8px; background: #f0f0f0; margin: 4px; border-radius: 5px; display: flex; align-items: center; justify-content: space-between;">
                    <div style="flex: 1;">
                        <strong>${board.quantity}√ó ${inchesToDisplay(board.length, 'opt')} boards</strong>
                    </div>
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <button onclick="editBoard(${i})" style="background: var(--primary-color); color: white; border: none; border-radius: 3px; padding: 4px 8px; cursor: pointer; font-size: 12px;">Edit</button>
                        <button onclick="removeBoard(${i})" style="background: #cd5c5c; color: white; border: none; border-radius: 3px; padding: 4px 8px; cursor: pointer;">√ó</button>
                    </div>
                </div>`
            ).join('');
        }
        
        function updateCutsList() {
            const div = document.getElementById('cutsList');
            if (!div) return;
            
            const cutGroups = {};
            cuts.forEach(cut => {
                const lengthKey = cut.length.toFixed(6); // Use fixed precision for grouping
                if (!cutGroups[lengthKey]) {
                    cutGroups[lengthKey] = { length: cut.length, count: 0, ids: [] };
                }
                cutGroups[lengthKey].count++;
                cutGroups[lengthKey].ids.push(cut.id);
            });
            
            div.innerHTML = Object.values(cutGroups).map(group => 
                `<div style="padding: 8px; background: #f0f0f0; margin: 4px; border-radius: 5px; display: flex; align-items: center; justify-content: space-between;">
                    <div style="flex: 1;">
                        <strong>${group.count}√ó ${inchesToDisplay(group.length, 'opt')}</strong>
                    </div>
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <button onclick="editCutGroup(${group.length}, [${group.ids.join(',')}])" style="background: var(--primary-color); color: white; border: none; border-radius: 3px; padding: 4px 8px; cursor: pointer; font-size: 12px;">Edit</button>
                        <button onclick="removeCutGroup(${group.length})" style="background: #cd5c5c; color: white; border: none; border-radius: 3px; padding: 4px 8px; cursor: pointer;">√ó</button>
                    </div>
                </div>`
            ).join('');
        }
        
        function removeBoard(index) {
            boards.splice(index, 1);
            updateBoardsList();
        }
        
        function removeCutGroup(length) {
            // Remove all cuts that match this length (within small tolerance)
            cuts = cuts.filter(cut => Math.abs(cut.length - length) > 0.0001);
            updateCutsList();
        }
        
        function optimizeCuts() {
            if (boards.length === 0 || cuts.length === 0) {
                showNotification('Please add boards and cuts first');
                return;
            }
            
            const kerfEnabled = document.getElementById('optKerfEnabled')?.checked;
            const kerf = kerfEnabled ? parseFloat(document.getElementById('optKerf')?.value || 0.125) : 0;
            
            // Create expanded board list with individual boards
            let availableBoards = [];
            boards.forEach((boardType, typeIndex) => {
                for (let i = 0; i < boardType.quantity; i++) {
                    availableBoards.push({
                        length: boardType.length,
                        typeIndex: typeIndex,
                        boardNumber: i + 1
                    });
                }
            });
            
            const results = [];
            const remainingCuts = cuts.map(c => c.length).sort((a, b) => b - a); // Sort largest first
            availableBoards.sort((a, b) => b.length - a.length); // Sort by length desc
            
            let totalCutsCompleted = 0;
            
            for (let boardIndex = 0; boardIndex < availableBoards.length; boardIndex++) {
                let board = availableBoards[boardIndex];
                let boardLength = board.length;
                let cutsOnThisBoard = [];
                let usedLength = 0;
                
                for (let cutIndex = remainingCuts.length - 1; cutIndex >= 0; cutIndex--) {
                    const cutLength = remainingCuts[cutIndex];
                    const neededLength = usedLength === 0 ? cutLength : cutLength + kerf;
                    
                    if (usedLength + neededLength <= boardLength) {
                        cutsOnThisBoard.push(cutLength);
                        usedLength += neededLength;
                        remainingCuts.splice(cutIndex, 1);
                        totalCutsCompleted++;
                    }
                }
                
                if (cutsOnThisBoard.length > 0) {
                    const waste = boardLength - usedLength;
                    const boardSize = inchesToDisplay(board.length, 'opt');
                    results.push({
                        boardDisplay: `${boardSize} board #${board.boardNumber}`,
                        boardLength: board.length,
                        cuts: cutsOnThisBoard,
                        waste: waste
                    });
                }
                
                if (remainingCuts.length === 0) break;
            }
            
            displayOptimizationResults(results, remainingCuts, kerfEnabled, totalCutsCompleted, cuts.length);
        }
        
        function displayOptimizationResults(results, remainingCuts, kerfEnabled, completedCuts, totalCuts) {
            const div = document.getElementById('optimizationResults');
            if (!div) return;
            
            const kerfNote = kerfEnabled ? ` (with kerf)` : ' (no kerf)';
            let html = '<div class="results">';
            
            // Summary section
            html += '<h3>Summary:</h3>';
            html += `<p><strong>Cuts completed:</strong> ${completedCuts} of ${totalCuts}</p>`;
            
            if (remainingCuts.length > 0) {
                html += `<p style="color: #CD5C5C;"><strong>‚ö†Ô∏è Not enough boards!</strong> ${remainingCuts.length} cuts cannot be completed.</p>`;
            } else {
                html += `<p style="color: #4CAF50;"><strong>‚úÖ All cuts can be completed!</strong></p>`;
            }
            
            if (results.length > 0) {
                html += `<h3 style="margin-top: 20px;">Cutting Plan${kerfNote}:</h3>`;
                results.forEach((result, index) => {
                    html += `<div class="cut-plan">
                        <strong>${result.boardDisplay}:</strong><br>
                        Cuts: ${result.cuts.map(cut => inchesToDisplay(cut, 'opt')).join(', ')}<br>
                        Waste: ${inchesToDisplay(result.waste, 'opt')}
                    </div>`;
                });
                
                const totalWaste = results.reduce((sum, result) => sum + result.waste, 0);
                html += `<p><strong>Total Waste: ${inchesToDisplay(totalWaste, 'opt')}</strong></p>`;
            }
            
            if (remainingCuts.length > 0) {
                html += '<h3 style="color: red; margin-top: 20px;">Cuts that don\'t fit:</h3>';
                const cutGroups = {};
                remainingCuts.forEach(cut => {
                    const display = inchesToDisplay(cut, 'opt');
                    cutGroups[display] = (cutGroups[display] || 0) + 1;
                });
                
                html += '<div style="background: #ffe6e6; padding: 10px; border-radius: 5px; border-left: 4px solid #CD5C5C;">';
                html += Object.entries(cutGroups).map(([display, count]) => 
                    `${count}√ó ${display}`
                ).join(', ');
                html += '<br><br><strong>Suggestion:</strong> Add more boards or reduce the number of cuts needed.';
                html += '</div>';
            }
            
            html += '</div>';
            
            // Add save to project button
            if (results.length > 0) {
                html += '<div style="margin-top: 15px;">';
                html += '<button class="btn btn-success btn-sm" onclick="saveOptimizationToProject()">Save to Project</button>';
                html += '</div>';
            }
            
            div.innerHTML = html;
            
            // Store results globally for visualization
            window.currentOptimizationResults = results;
            window.currentKerfEnabled = kerfEnabled;
            
            // Automatically show visual layout if there are results
            if (results.length > 0) {
                showVisualLayout();
            }
        }
        
        function showVisualLayout() {
            const visualDiv = document.getElementById('visualLayout');
            const boardDiv = document.getElementById('boardVisualization');
            
            if (!window.currentOptimizationResults || !visualDiv || !boardDiv) {
                showNotification('No optimization results to visualize', 'error');
                return;
            }
            
            visualDiv.style.display = 'block';
            
            const results = window.currentOptimizationResults;
            const kerfEnabled = window.currentKerfEnabled;
            const kerf = kerfEnabled ? parseFloat(document.getElementById('optKerf')?.value || 0.125) : 0;
            
            let html = '';
            let totalWoodUsed = 0;
            let totalWaste = 0;
            
            // Calculate efficiency
            results.forEach(result => {
                const usedLength = result.boardLength - result.waste;
                totalWoodUsed += usedLength;
                totalWaste += result.waste;
            });
            
            const totalWood = totalWoodUsed + totalWaste;
            const efficiency = totalWood > 0 ? ((totalWoodUsed / totalWood) * 100) : 0;
            
            // Efficiency summary
            let efficiencyClass = 'efficiency-summary';
            if (efficiency >= 85) efficiencyClass += ' efficiency-good';
            else if (efficiency < 70) efficiencyClass += ' efficiency-poor';
            
            html += `<div class="${efficiencyClass}">
                <strong>Material Efficiency: ${efficiency.toFixed(1)}%</strong><br>
                Wood Used: ${inchesToDisplay(totalWoodUsed, 'opt')} | 
                Waste: ${inchesToDisplay(totalWaste, 'opt')} | 
                Total: ${inchesToDisplay(totalWood, 'opt')}
            </div>`;
            
            // Visualize each board
            results.forEach((result, boardIndex) => {
                const boardLength = result.boardLength;
                const maxDisplayWidth = 400; // Max width in pixels
                const scale = maxDisplayWidth / Math.max(boardLength, 48); // Scale based on largest board or 4 feet minimum
                
                html += `<div class="visual-board">
                    <div class="board-header">${result.boardDisplay} (${inchesToDisplay(boardLength, 'opt')})</div>
                    <div class="board-visual" style="width: ${boardLength * scale}px;">`;
                
                let currentPosition = 0;
                
                // Add cuts and kerf gaps
                result.cuts.forEach((cutLength, cutIndex) => {
                    // Add kerf before cut (except first cut)
                    if (cutIndex > 0 && kerfEnabled) {
                        html += `<div class="cut-segment kerf" style="left: ${currentPosition * scale}px; width: ${kerf * scale}px;" title="Kerf: ${inchesToDisplay(kerf, 'opt')}"></div>`;
                        currentPosition += kerf;
                    }
                    
                    // Add the cut
                    const cutWidth = cutLength * scale;
                    html += `<div class="cut-segment used" style="left: ${currentPosition * scale}px; width: ${cutWidth}px;" title="Cut: ${inchesToDisplay(cutLength, 'opt')}">${inchesToDisplay(cutLength, 'opt')}</div>`;
                    currentPosition += cutLength;
                });
                
                // Add waste if any
                if (result.waste > 0.01) { // Only show if waste is significant
                    const wasteWidth = result.waste * scale;
                    html += `<div class="cut-segment waste" style="left: ${currentPosition * scale}px; width: ${wasteWidth}px;" title="Waste: ${inchesToDisplay(result.waste, 'opt')}">Waste</div>`;
                }
                
                html += `</div>
                    <div class="board-stats">
                        Cuts: ${result.cuts.length} | 
                        Used: ${inchesToDisplay(boardLength - result.waste, 'opt')} | 
                        Waste: ${inchesToDisplay(result.waste, 'opt')} |
                        Efficiency: ${((boardLength - result.waste) / boardLength * 100).toFixed(1)}%
                    </div>
                </div>`;
            });
            
            boardDiv.innerHTML = html;
            
            // Scroll to visual layout
            visualDiv.scrollIntoView({ behavior: 'smooth' });
        }
        
        function exportEqualDivisionResult(index) {
            if (!currentCutResults || currentCutResults.length === 0 || index >= currentCutResults.length) {
                showNotification('No cut result to export', 'error');
                return;
            }
            
            const cutData = currentCutResults[index];
            const projectName = currentProject ? currentProject.name : 'Woodworking Project';
            const date = new Date().toLocaleDateString();
            
            let exportText = `${projectName} - Equal Division Cut List\n`;
            exportText += `Generated: ${date}\n\n`;
            
            exportText += 'CUT INSTRUCTIONS:\n';
            exportText += '='.repeat(50) + '\n';
            exportText += `Original Board Length: ${cutData.originalLength}\n`;
            exportText += `Number of Pieces: ${cutData.pieces}\n`;
            exportText += `Piece Length: ${cutData.pieceLength}\n`;
            exportText += `Kerf Settings: ${cutData.kerfNote}${cutData.cutSideNote}\n\n`;
            
            if (cutData.results && cutData.results.length > 0) {
                exportText += 'CUTTING MARKS:\n';
                exportText += '-'.repeat(30) + '\n';
                cutData.results.forEach((mark, i) => {
                    exportText += `Mark ${i + 1}: ${mark.display}\n`;
                });
                exportText += '\n';
            }
            
            exportText += 'CUTTING SEQUENCE:\n';
            exportText += '-'.repeat(30) + '\n';
            exportText += '1. Measure and mark all cut positions\n';
            exportText += '2. Double-check measurements before cutting\n';
            exportText += '3. Cut at each marked position\n';
            exportText += `4. Result: ${cutData.pieces} pieces @ ${cutData.pieceLength} each\n`;
            
            // Create downloadable file
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${projectName.replace(/[^a-zA-Z0-9]/g, '_')}_equal_division_cuts.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification('Cut list exported successfully!', 'success');
        }
        
        function toggleVisualLayout() {
            const visualDiv = document.getElementById('visualLayout');
            if (visualDiv) {
                visualDiv.style.display = visualDiv.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        function exportCutList() {
            if (!window.currentOptimizationResults) {
                showNotification('No optimization results to export', 'error');
                return;
            }
            
            const results = window.currentOptimizationResults;
            const projectName = currentProject ? currentProject.name : 'Woodworking Project';
            const date = new Date().toLocaleDateString();
            
            let exportText = `${projectName} - Cut List\n`;
            exportText += `Generated: ${date}\n`;
            exportText += `Kerf: ${window.currentKerfEnabled ? 'Enabled' : 'Disabled'}\n\n`;
            
            exportText += 'CUTTING PLAN:\n';
            exportText += '='.repeat(50) + '\n';
            
            results.forEach((result, index) => {
                exportText += `\n${result.boardDisplay}:\n`;
                exportText += `  Cuts: ${result.cuts.map(cut => inchesToDisplay(cut, 'opt')).join(', ')}\n`;
                exportText += `  Waste: ${inchesToDisplay(result.waste, 'opt')}\n`;
                exportText += `  Efficiency: ${((result.boardLength - result.waste) / result.boardLength * 100).toFixed(1)}%\n`;
            });
            
            const totalWaste = results.reduce((sum, result) => sum + result.waste, 0);
            const totalWood = results.reduce((sum, result) => sum + result.boardLength, 0);
            const efficiency = ((totalWood - totalWaste) / totalWood * 100).toFixed(1);
            
            exportText += `\nSUMMARY:\n`;
            exportText += `Total Boards Used: ${results.length}\n`;
            exportText += `Total Waste: ${inchesToDisplay(totalWaste, 'opt')}\n`;
            exportText += `Overall Efficiency: ${efficiency}%\n`;
            
            // Create downloadable file
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${projectName.replace(/[^a-zA-Z0-9]/g, '_')}_cut_list.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification('Cut list exported successfully!', 'success');
        }
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            const helpModal = document.getElementById('helpModal');
            const jokeModal = document.getElementById('jokeModal');
            const editModal = document.getElementById('editModal');
            const calcModal = document.getElementById('calcModal');
            const notesModal = document.getElementById('notesModal');
            const saveToProjectModal = document.getElementById('saveToProjectModal');
            const allProjectsModal = document.getElementById('allProjectsModal');
            
            if (event.target === helpModal) {
                helpModal.style.display = 'none';
            }
            if (event.target === jokeModal) {
                jokeModal.style.display = 'none';
            }
            if (event.target === editModal) {
                editModal.style.display = 'none';
                editingItem = null;
            }
            if (event.target === calcModal) {
                calcModal.style.display = 'none';
            }
            if (event.target === notesModal) {
                notesModal.style.display = 'none';
            }
            if (event.target === saveToProjectModal) {
                closeSaveToProjectModal();
            }
            if (event.target === allProjectsModal) {
                closeAllProjectsModal();
            }
        }
        
        // New Calculator Card Functions
        function toggleCalcCard(cardType) {
            const content = document.getElementById(cardType + 'Content');
            const arrow = document.querySelector(`#${cardType}Card .calc-arrow`);
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                arrow.textContent = '‚ñ≤';
            } else {
                content.style.display = 'none';
                arrow.textContent = '‚ñº';
            }
        }

        function calculateBoardFeet() {
            const species = document.getElementById('bfSpecies').value;
            const customSpecies = document.getElementById('bfCustomSpecies').value;
            const price = parseFloat(document.getElementById('bfPrice').value) || 0;
            const thickness = parseFloat(document.getElementById('bfThickness').value) || 0;
            const width = parseFloat(document.getElementById('bfWidth').value) || 0;
            const length = parseFloat(document.getElementById('bfLength').value) || 0;
            const quantity = parseFloat(document.getElementById('bfQuantity').value) || 1;
            const resultDiv = document.getElementById('boardFootResult');
            
            
            // Validate inputs - prevent negative numbers
            if (thickness < 0 || width < 0 || length < 0 || quantity < 0 || price < 0) {
                resultDiv.innerHTML = '<div class="result-placeholder">Please enter positive numbers only</div>';
                updateBoardDiagram(0, 0, 0, 0);
                return;
            }
            
            if (thickness === 0 || width === 0 || length === 0) {
                resultDiv.innerHTML = '<div class="result-placeholder">Enter dimensions above</div>';
                updateBoardDiagram(0, 0, 0, 0);
                return;
            }
            
            const boardFeet = (thickness * width * length * quantity) / 144;
            const totalCubicInches = thickness * width * length * quantity;
            const lineTotal = boardFeet * price;
            
            // Determine display species name
            const displaySpecies = species === 'Custom' ? customSpecies : species;
            const speciesDisplay = displaySpecies ? `${displaySpecies} - ` : '';
            
            resultDiv.innerHTML = `
                <div class="result-value">${speciesDisplay}${boardFeet.toFixed(3)} board feet</div>
                <div class="result-details">
                    ${quantity} piece${quantity !== 1 ? 's' : ''} √ó ${thickness}" √ó ${width}" √ó ${length}"<br>
                    ${price > 0 ? `Price: $${price.toFixed(2)}/BF √ó ${boardFeet.toFixed(3)} BF = <strong>$${lineTotal.toFixed(2)}</strong><br>` : ''}
                    Total volume: ${totalCubicInches.toLocaleString()} cubic inches
                </div>
            `;
            
            // Update visual diagram
            updateBoardDiagram(thickness, width, length, quantity);
        }

        function updateBoardDiagram(thickness, width, length, quantity) {
            const lengthLabel = document.getElementById('lengthLabel');
            const widthLabel = document.getElementById('widthLabel');
            const thicknessLabel = document.getElementById('thicknessLabel');
            const frontFace = document.getElementById('frontFace');
            const topFace = document.getElementById('topFace');
            const rightFace = document.getElementById('rightFace');
            const grainLines = document.getElementById('grainLines');
            
            if (!lengthLabel || !widthLabel || !thicknessLabel) return;
            
            // Update labels with actual dimensions
            if (length > 0) lengthLabel.textContent = `Length: ${length}"`;
            if (width > 0) widthLabel.textContent = `Width: ${width}"`;
            if (thickness > 0) thicknessLabel.textContent = `Thickness: ${thickness}"`;
            
            // Scale the lumber piece based on dimensions (if all are provided)
            if (thickness > 0 && width > 0 && length > 0) {
                // Calculate scale factors (normalize to reasonable display sizes)
                const maxLength = 150;  // max pixel width for length
                const maxWidth = 80;    // max pixel height for width
                const maxThickness = 50; // max pixel depth for thickness
                
                const lengthScale = Math.min(maxLength / length, 1) * Math.max(0.3, length / 96); // 96" = 8ft max
                const widthScale = Math.min(maxWidth / width, 1) * Math.max(0.3, width / 12);   // 12" max width
                const thicknessScale = Math.min(maxThickness / thickness, 1) * Math.max(0.3, thickness / 4); // 4" max thickness
                
                const scaledLength = Math.max(60, lengthScale * 150);
                const scaledWidth = Math.max(30, widthScale * 80);
                const scaledThickness = Math.max(20, thicknessScale * 50);
                
                // Update front face
                if (frontFace) {
                    frontFace.setAttribute('width', scaledLength);
                    frontFace.setAttribute('height', scaledWidth);
                }
                
                // Update top face
                if (topFace) {
                    const path = `M 100 60 L ${100 + scaledLength} 60 L ${100 + scaledLength + scaledThickness} ${60 - scaledThickness} L ${100 + scaledThickness} ${60 - scaledThickness} Z`;
                    topFace.setAttribute('d', path);
                }
                
                // Update right face
                if (rightFace) {
                    const path = `M ${100 + scaledLength} 60 L ${100 + scaledLength + scaledThickness} ${60 - scaledThickness} L ${100 + scaledLength + scaledThickness} ${60 - scaledThickness + scaledWidth} L ${100 + scaledLength} ${60 + scaledWidth} Z`;
                    rightFace.setAttribute('d', path);
                }
                
                // Update grain lines
                if (grainLines) {
                    const lines = grainLines.querySelectorAll('line');
                    const spacing = scaledWidth / 4;
                    lines.forEach((line, index) => {
                        const y = 60 + (index + 1) * spacing;
                        line.setAttribute('x1', '100');
                        line.setAttribute('x2', 100 + scaledLength);
                        line.setAttribute('y1', y);
                        line.setAttribute('y2', y);
                    });
                }
                
                // Update interactive arrows to match scaled lumber
                const lengthArrow = document.getElementById('lengthArrow');
                const widthArrow = document.getElementById('widthArrow');
                const thicknessArrow = document.getElementById('thicknessArrow');
                const lengthLabel = document.getElementById('lengthLabel');
                const widthLabel = document.getElementById('widthLabel');
                const thicknessLabel = document.getElementById('thicknessLabel');
                
                // Update length arrow (horizontal, below lumber)
                if (lengthArrow) {
                    const arrowY = 60 + scaledWidth + 10;
                    const path = `M 100 ${arrowY} L ${100 + scaledLength} ${arrowY} M 100 ${arrowY} L 105 ${arrowY - 3} M 100 ${arrowY} L 105 ${arrowY + 3} M ${100 + scaledLength} ${arrowY} L ${100 + scaledLength - 5} ${arrowY - 3} M ${100 + scaledLength} ${arrowY} L ${100 + scaledLength - 5} ${arrowY + 3}`;
                    lengthArrow.setAttribute('d', path);
                }
                
                // Update length label position
                if (lengthLabel) {
                    lengthLabel.setAttribute('x', 100 + scaledLength / 2);
                    lengthLabel.setAttribute('y', 60 + scaledWidth + 25);
                }
                
                // Update width arrow (diagonal, following 3D perspective)
                if (widthArrow) {
                    const startX = 100 + scaledLength;
                    const startY = 60 + scaledWidth + 5;
                    const endX = 100 + scaledLength + scaledThickness;
                    const endY = 60 + scaledWidth + 5 - scaledThickness;
                    const path = `M ${startX} ${startY} L ${endX} ${endY} M ${startX} ${startY} L ${startX + 5} ${startY - 2} M ${startX} ${startY} L ${startX + 2} ${startY - 5} M ${endX} ${endY} L ${endX - 5} ${endY + 2} M ${endX} ${endY} L ${endX - 2} ${endY + 5}`;
                    widthArrow.setAttribute('d', path);
                }
                
                // Update width label position
                if (widthLabel) {
                    const midX = 100 + scaledLength + scaledThickness / 2;
                    const midY = 60 + scaledWidth + 15;
                    widthLabel.setAttribute('x', midX);
                    widthLabel.setAttribute('y', midY);
                }
                
                // Update thickness arrow (vertical, on left side)
                if (thicknessArrow) {
                    const arrowX = 80;
                    const path = `M ${arrowX} 60 L ${arrowX} ${60 + scaledWidth} M ${arrowX} 60 L ${arrowX - 3} 65 M ${arrowX} 60 L ${arrowX + 3} 65 M ${arrowX} ${60 + scaledWidth} L ${arrowX - 3} ${60 + scaledWidth - 5} M ${arrowX} ${60 + scaledWidth} L ${arrowX + 3} ${60 + scaledWidth - 5}`;
                    thicknessArrow.setAttribute('d', path);
                }
                
                // Update thickness label position
                if (thicknessLabel) {
                    thicknessLabel.setAttribute('y', 60 + scaledWidth / 2);
                }
                
                // Add quantity indicator
                if (quantity > 1) {
                    let qtyLabel = document.getElementById('quantityLabel');
                    if (!qtyLabel) {
                        qtyLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                        qtyLabel.id = 'quantityLabel';
                        qtyLabel.setAttribute('text-anchor', 'end');
                        qtyLabel.setAttribute('font-size', '12');
                        qtyLabel.setAttribute('font-weight', 'bold');
                        qtyLabel.setAttribute('fill', '#333');
                        document.querySelector('#lumber3d').appendChild(qtyLabel);
                    }
                    qtyLabel.setAttribute('x', 100 + scaledLength + scaledThickness + 10);
                    qtyLabel.setAttribute('y', 70);
                    qtyLabel.textContent = `√ó${quantity}`;
                } else {
                    const qtyLabel = document.getElementById('quantityLabel');
                    if (qtyLabel) qtyLabel.remove();
                }
            }
        }

        let currentGoldenMode = 'short'; // Default mode: short to long
        
        function setGoldenMode(mode) {
            currentGoldenMode = mode;
            document.getElementById('goldenModeShort').classList.toggle('active', mode === 'short');
            document.getElementById('goldenModeLong').classList.toggle('active', mode === 'long');
            
            const label = document.getElementById('goldenInputLabel');
            label.textContent = mode === 'short' ? 'Short dimension:' : 'Long dimension:';
            
            calculateGoldenRatioNew(); // Recalculate with new mode
        }

        function calculateGoldenRatioNew() {
            const input = getInputInches('grFeet', 'grInches', 'grFraction');
            const resultDiv = document.getElementById('grResult');
            
            if (input === 0) {
                resultDiv.innerHTML = '<div class="result-placeholder">Enter a dimension above</div>';
                updateGoldenRectangle(0, 0);
                return;
            }
            
            const phi = 1.618033988749895;
            let result, description;
            
            if (currentGoldenMode === 'short') {
                result = input * phi;
                description = `If short side is ${inchesToDisplay(input)}, long side should be ${inchesToDisplay(result)}`;
                updateGoldenRectangle(input, result);
            } else {
                result = input / phi;
                description = `If long side is ${inchesToDisplay(input)}, short side should be ${inchesToDisplay(result)}`;
                updateGoldenRectangle(result, input);
            }
            
            resultDiv.innerHTML = `
                <div class="result-value">${inchesToDisplay(result)}</div>
                <div class="result-details">${description}<br>Ratio: 1:1.618 (œÜ)</div>
            `;
        }

        function updateGoldenRectangle(short, long) {
            // The SVG diagram is now static - we don't need to update it dynamically
            // The visual representation shows the conceptual 1:1.618 ratio
            return;
        }

        function calculateSpacing() {
            const totalLength = getInputInches('spTotalLengthFeet', 'spTotalLengthInches', 'spTotalLengthFraction');
            const numShelves = parseInt(document.getElementById('spNumShelves').value) || 0;
            const thickness = getInputInches('spacingThicknessFeet', 'spacingThicknessInches', 'spacingThicknessFraction');
            const resultDiv = document.getElementById('spResult');
            
            if (totalLength === 0 || numShelves === 0) {
                resultDiv.innerHTML = '<div class="result-placeholder">Enter values above</div>';
                updateSpacingDiagram(0, 0, 0, 0);
                return;
            }
            
            // Convert shelves to spaces: N shelves = N+1 spaces
            const numSpaces = numShelves + 1;
            let spacing, shelfInfo, description;
            
            if (thickness === 0) {
                // Simple shelf spacing without thickness
                spacing = totalLength / numSpaces;
                const centerMarks = Array.from({length: numShelves}, (_, i) => inchesToDisplay((i + 1) * spacing, 'calculator'));
                
                resultDiv.innerHTML = `
                    <div class="result-value">${inchesToDisplay(spacing, 'calculator')} per space</div>
                    <div class="result-summary">
                        <div class="summary-row">
                            <span class="summary-label">Total Length:</span>
                            <span class="summary-value">${inchesToDisplay(totalLength, 'calculator')}</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Shelves:</span>
                            <span class="summary-value">${numShelves} shelves (${numSpaces} spaces)</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Material:</span>
                            <span class="summary-value">No thickness (center marks)</span>
                        </div>
                    </div>
                    ${centerMarks.length > 0 ? `
                    <div class="divider-marks">
                        <div class="marks-header">üìê Shelf Center Marking Guide:</div>
                        ${centerMarks.map((mark, i) => `
                            <div class="divider-mark-row">
                                <span class="divider-label">Shelf ${i + 1}:</span>
                                <span class="mark-center">Center ${mark}</span>
                            </div>
                        `).join('')}
                    </div>` : ''}
                `;
            } else {
                // Account for material thickness
                const totalThickness = numShelves * thickness;
                const availableSpace = totalLength - totalThickness;
                
                if (availableSpace <= 0) {
                    resultDiv.innerHTML = '<div class="result-placeholder">Material too thick for this spacing</div>';
                    updateSpacingDiagram(0, 0, 0, 0);
                    return;
                }
                
                spacing = availableSpace / numSpaces;
                
                // Calculate shelf positions (left and right edges)
                shelfInfo = [];
                let currentPos = 0;
                
                for (let i = 0; i < numShelves; i++) {
                    currentPos += spacing; // Move to end of space
                    const leftEdge = currentPos;
                    const rightEdge = currentPos + thickness;
                    shelfInfo.push({
                        number: i + 1,
                        bottomEdge: inchesToDisplay(leftEdge, 'calculator'),
                        topEdge: inchesToDisplay(rightEdge, 'calculator')
                    });
                    currentPos += thickness; // Move past shelf
                }
                
                resultDiv.innerHTML = `
                    <div class="result-value">${inchesToDisplay(spacing, 'calculator')} per space</div>
                    <div class="result-summary">
                        <div class="summary-row">
                            <span class="summary-label">Total Length:</span>
                            <span class="summary-value">${inchesToDisplay(totalLength, 'calculator')}</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Shelves:</span>
                            <span class="summary-value">${numShelves} @ ${inchesToDisplay(thickness, 'calculator')} thick</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Spaces:</span>
                            <span class="summary-value">${numSpaces} @ ${inchesToDisplay(spacing, 'calculator')} each</span>
                        </div>
                    </div>
                    <div class="divider-marks">
                        <div class="marks-header">üìè Shelf Marking Guide:</div>
                        ${shelfInfo.map(shelf => `
                            <div class="divider-mark-row">
                                <span class="divider-label">Shelf ${shelf.number}:</span>
                                <span class="mark-left">Bottom ${shelf.bottomEdge}</span>
                                <span class="mark-right">Top ${shelf.topEdge}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Update visual spacing diagram
            updateSpacingDiagram(totalLength, numSpaces, spacing, thickness, numShelves);
        }

        function updateSpacingDiagram(total, spaces, spacing, thickness = 0, numShelves = 0) {
            const cabinetFrame = document.getElementById('cabinetFrame');
            const shelvesGroup = document.getElementById('shelvesGroup');
            const measurementsGroup = document.getElementById('measurementsGroup');
            
            if (!cabinetFrame || !shelvesGroup || !measurementsGroup) return;
            
            // Clear previous content
            shelvesGroup.innerHTML = '';
            
            if (total === 0 || spaces === 0) {
                // Show default state - larger dimensions for new viewBox
                cabinetFrame.innerHTML = `
                    <rect x="200" y="80" width="250" height="500" fill="url(#cabinetWood)" stroke="var(--primary-color)" stroke-width="4" rx="8"/>
                    <text x="325" y="340" text-anchor="middle" font-size="20" fill="#666">
                        Enter dimensions to see cabinet layout
                    </text>
                `;
                measurementsGroup.innerHTML = `
                    <text x="180" y="90" text-anchor="end" font-size="16" fill="var(--primary-color)" font-weight="bold">0"</text>
                    <text x="180" y="590" text-anchor="end" font-size="16" fill="var(--primary-color)" font-weight="bold">Total</text>
                `;
                return;
            }
            
            // Calculate cabinet dimensions - much larger for better visibility
            const cabinetHeight = 500;
            const cabinetWidth = 250;
            const cabinetX = 200;
            const cabinetY = 80;
            const scale = cabinetHeight / total;
            
            // Update cabinet frame
            cabinetFrame.innerHTML = `
                <rect x="${cabinetX}" y="${cabinetY}" width="${cabinetWidth}" height="${cabinetHeight}" 
                      fill="url(#cabinetWood)" stroke="var(--primary-color)" stroke-width="4" rx="8"/>
            `;
            
            // Update measurements with more reference lines
            let measurementLines = `
                <text x="180" y="90" text-anchor="end" font-size="16" fill="var(--primary-color)" font-weight="bold">0"</text>
                <text x="180" y="590" text-anchor="end" font-size="16" fill="var(--primary-color)" font-weight="bold">${inchesToDisplay(total)}</text>
                <line x1="185" y1="80" x2="195" y2="80" stroke="var(--primary-color)" stroke-width="3"/>
                <line x1="185" y1="580" x2="195" y2="580" stroke="var(--primary-color)" stroke-width="3"/>
            `;
            
            if (thickness === 0) {
                // Simple shelf spacing without thickness - show center marks with better detail
                for (let i = 1; i < spaces; i++) {
                    const position = cabinetY + (i * spacing * scale);
                    
                    // Shelf mark line with extension
                    shelvesGroup.innerHTML += `
                        <line x1="${cabinetX}" y1="${position}" x2="${cabinetX + cabinetWidth}" y2="${position}" 
                              stroke="#dc3545" stroke-width="4"/>
                        <line x1="${cabinetX + cabinetWidth}" y1="${position}" x2="${cabinetX + cabinetWidth + 40}" y2="${position}" 
                              stroke="#dc3545" stroke-width="3"/>
                        <text x="${cabinetX + cabinetWidth + 50}" y="${position + 7}" 
                              font-size="16" fill="#dc3545" font-weight="bold">
                              Shelf ${i}: ${inchesToDisplay(i * spacing)}
                        </text>
                    `;
                    
                    // Add measurement line
                    measurementLines += `
                        <line x1="185" y1="${position}" x2="195" y2="${position}" stroke="#dc3545" stroke-width="3"/>
                        <text x="175" y="${position + 7}" text-anchor="end" font-size="14" fill="#dc3545" font-weight="bold">${inchesToDisplay(i * spacing)}</text>
                    `;
                }
                
                // Add space labels with better styling
                for (let i = 0; i < spaces; i++) {
                    const centerPos = cabinetY + (i * spacing + spacing / 2) * scale;
                    shelvesGroup.innerHTML += `
                        <rect x="${cabinetX + cabinetWidth/2 - 35}" y="${centerPos - 16}" width="70" height="32" 
                              fill="rgba(40, 167, 69, 0.15)" stroke="#28a745" stroke-width="2" rx="8"/>
                        <text x="${cabinetX + cabinetWidth/2}" y="${centerPos + 4}" 
                              text-anchor="middle" font-size="16" font-weight="bold" fill="#28a745">
                              Space ${i + 1}
                        </text>
                        <text x="${cabinetX + cabinetWidth/2}" y="${centerPos - 22}" 
                              text-anchor="middle" font-size="13" fill="#28a745">
                              ${inchesToDisplay(spacing)}
                        </text>
                    `;
                }
            } else {
                // Show shelves with thickness and guaranteed non-overlapping labels
                let currentPos = 0;
                let shelves = [];
                
                // Calculate all shelf positions first
                for (let i = 0; i < numShelves; i++) {
                    currentPos += spacing;
                    const shelfTop = cabinetY + (currentPos * scale);
                    const shelfBottom = cabinetY + ((currentPos + thickness) * scale);
                    
                    shelves.push({
                        shelfNum: i + 1,
                        topPos: currentPos,
                        bottomPos: currentPos + thickness,
                        shelfTop: shelfTop,
                        shelfBottom: shelfBottom
                    });
                    
                    currentPos += thickness;
                }
                
                // Use simple sequential positioning with guaranteed spacing
                let nextAvailableLabelY = cabinetY + 40; // Start well below cabinet top
                const guaranteedSpacing = 50; // Guaranteed minimum space between labels
                
                for (let shelf of shelves) {
                    // Draw shelf
                    shelvesGroup.innerHTML += `
                        <rect x="${cabinetX}" y="${shelf.shelfTop}" width="${cabinetWidth}" height="${shelf.shelfBottom - shelf.shelfTop}" 
                              fill="#8B4513" stroke="#654321" stroke-width="3"/>
                        
                        <!-- Shelf thickness indicator -->
                        <text x="${cabinetX + cabinetWidth/2}" y="${shelf.shelfTop + (shelf.shelfBottom - shelf.shelfTop)/2 + 7}" 
                              text-anchor="middle" font-size="14" font-weight="bold" fill="white">
                              ${inchesToDisplay(thickness)} thick
                        </text>
                    `;
                    
                    // Calculate label positions - try to use actual shelf position, but ensure no overlap
                    let topLabelY = Math.max(shelf.shelfTop, nextAvailableLabelY);
                    let bottomLabelY = topLabelY + 22; // Bottom label 22px below top label
                    
                    // Top edge marking
                    shelvesGroup.innerHTML += `
                        <line x1="${cabinetX + cabinetWidth}" y1="${shelf.shelfTop}" x2="${cabinetX + cabinetWidth + 30}" y2="${shelf.shelfTop}" 
                              stroke="#654321" stroke-width="3"/>
                        <line x1="${cabinetX + cabinetWidth + 30}" y1="${shelf.shelfTop}" x2="${cabinetX + cabinetWidth + 40}" y2="${topLabelY}" 
                              stroke="#654321" stroke-width="2" stroke-dasharray="2,2"/>
                        <text x="${cabinetX + cabinetWidth + 50}" y="${topLabelY + 6}" 
                              font-size="15" fill="#654321" font-weight="bold">
                              Shelf ${shelf.shelfNum} Top: ${inchesToDisplay(shelf.topPos)}
                        </text>
                    `;
                    
                    // Bottom edge marking
                    shelvesGroup.innerHTML += `
                        <line x1="${cabinetX + cabinetWidth}" y1="${shelf.shelfBottom}" x2="${cabinetX + cabinetWidth + 60}" y2="${shelf.shelfBottom}" 
                              stroke="#654321" stroke-width="3"/>
                        <line x1="${cabinetX + cabinetWidth + 60}" y1="${shelf.shelfBottom}" x2="${cabinetX + cabinetWidth + 70}" y2="${bottomLabelY}" 
                              stroke="#654321" stroke-width="2" stroke-dasharray="2,2"/>
                        <text x="${cabinetX + cabinetWidth + 80}" y="${bottomLabelY + 6}" 
                              font-size="15" fill="#654321" font-weight="bold">
                              Shelf ${shelf.shelfNum} Bottom: ${inchesToDisplay(shelf.bottomPos)}
                        </text>
                    `;
                    
                    // Add measurement reference lines
                    measurementLines += `
                        <line x1="185" y1="${shelf.shelfTop}" x2="195" y2="${shelf.shelfTop}" stroke="#654321" stroke-width="3"/>
                        <line x1="185" y1="${shelf.shelfBottom}" x2="195" y2="${shelf.shelfBottom}" stroke="#654321" stroke-width="2"/>
                        <text x="175" y="${shelf.shelfTop + 6}" text-anchor="end" font-size="13" fill="#654321" font-weight="bold">${inchesToDisplay(shelf.topPos)}</text>
                    `;
                    
                    // Update next available position
                    nextAvailableLabelY = bottomLabelY + guaranteedSpacing;
                }
                
                // Add space labels between shelves with better detail
                currentPos = 0;
                for (let i = 0; i < spaces; i++) {
                    const spaceStart = cabinetY + (currentPos * scale);
                    currentPos += spacing;
                    const spaceEnd = cabinetY + (currentPos * scale);
                    const spaceCenterY = (spaceStart + spaceEnd) / 2;
                    
                    shelvesGroup.innerHTML += `
                        <rect x="${cabinetX + cabinetWidth/2 - 40}" y="${spaceCenterY - 20}" width="80" height="40" 
                              fill="rgba(40, 167, 69, 0.1)" stroke="#28a745" stroke-width="2" rx="8"/>
                        <text x="${cabinetX + cabinetWidth/2}" y="${spaceCenterY + 2}" 
                              text-anchor="middle" font-size="15" font-weight="bold" fill="#28a745">
                              Space ${i + 1}
                        </text>
                        <text x="${cabinetX + cabinetWidth/2}" y="${spaceCenterY + 18}" 
                              text-anchor="middle" font-size="13" fill="#28a745">
                              ${inchesToDisplay(spacing)} clear
                        </text>
                    `;
                    
                    if (i < numShelves) currentPos += thickness;
                }
            }
            
            measurementsGroup.innerHTML = measurementLines;
        }

        // Removed old updateSpacingDiagram function - replaced with SVG version above

        // Species Price Memory Functions
        function handleSpeciesChange() {
            const species = document.getElementById('bfSpecies').value;
            const customSpeciesRow = document.getElementById('customSpeciesRow');
            const priceInput = document.getElementById('bfPrice');
            
            // Handle custom species dropdown toggle
            if (species === 'Custom') {
                customSpeciesRow.style.display = 'block';
            } else {
                customSpeciesRow.style.display = 'none';
            }
            
            // Auto-fill remembered price for this specific species, or clear if no price saved
            if (species && species !== 'Custom') {
                if (speciesPrices[species]) {
                    priceInput.value = speciesPrices[species].toFixed(2);
                    showNotification(`Auto-filled price: $${speciesPrices[species].toFixed(2)}/BF`);
                } else {
                    priceInput.value = ''; // Clear price field for species with no saved price
                    priceInput.placeholder = 'Enter price/BF';
                }
            } else if (species === 'Custom') {
                priceInput.value = ''; // Always clear price for custom species
                priceInput.placeholder = 'Enter price/BF';
            }
            
            // Recalculate with new species/price
            calculateBoardFeet();
        }

        // Lumber Cart Management Functions
        function addToLumberCart() {
            const species = document.getElementById('bfSpecies').value;
            const customSpecies = document.getElementById('bfCustomSpecies').value;
            const price = parseFloat(document.getElementById('bfPrice').value) || 0;
            const thickness = parseFloat(document.getElementById('bfThickness').value) || 0;
            const width = parseFloat(document.getElementById('bfWidth').value) || 0;
            const length = parseFloat(document.getElementById('bfLength').value) || 0;
            const quantity = parseFloat(document.getElementById('bfQuantity').value) || 1;
            
            // Validate required fields
            if (!species || (species === 'Custom' && !customSpecies.trim())) {
                showNotification('Please select a wood species');
                return;
            }
            
            if (thickness <= 0 || width <= 0 || length <= 0 || quantity <= 0) {
                showNotification('Please enter valid dimensions and quantity');
                return;
            }
            
            if (price <= 0) {
                showNotification('Please enter a valid price per board foot');
                return;
            }
            
            // Calculate board feet and line total
            const boardFeet = (thickness * width * length * quantity) / 144;
            const lineTotal = boardFeet * price;
            const displaySpecies = species === 'Custom' ? customSpecies.trim() : species;
            
            // Create cart item
            const cartItem = {
                id: Date.now(), // Simple unique ID
                species: displaySpecies,
                thickness,
                width,
                length,
                quantity,
                pricePerBF: price,
                boardFeet,
                lineTotal
            };
            
            // Remember price for this species (for price memory feature)
            speciesPrices[displaySpecies] = price;
            
            // Add to cart
            lumberCart.push(cartItem);
            
            // Update cart display
            updateCartDisplay();
            
            // Clear form for next item
            clearBoardFootForm();
            
            showNotification(`Added ${displaySpecies} to cart`);
        }

        function removeFromLumberCart(itemId) {
            lumberCart = lumberCart.filter(item => item.id !== itemId);
            updateCartDisplay();
            showNotification('Item removed from cart');
        }

        function calculateMiterAngle() {
            const sides = parseInt(document.getElementById('maSides').value) || 0;
            const resultDiv = document.getElementById('maResult');
            
            if (sides < 3) {
                resultDiv.innerHTML = '<div class="result-placeholder">Enter number of sides (minimum 3)</div>';
                return;
            }
            
            const interiorAngle = ((sides - 2) * 180) / sides;
            const miterAngle = (180 - interiorAngle) / 2;
            const tableAngle = 90 - miterAngle;
            
            resultDiv.innerHTML = `
                <div class="result-value">${miterAngle.toFixed(2)}¬∞ miter cut</div>
                <div class="result-details">
                    Interior angle: ${interiorAngle.toFixed(1)}¬∞<br>
                    Table saw angle: ${tableAngle.toFixed(2)}¬∞<br>
                    Each piece needs ${miterAngle.toFixed(2)}¬∞ cut on both ends
                </div>
            `;
            
            // Update visual polygon
            updatePolygonDiagram(sides, miterAngle);
        }

        function updatePolygonDiagram(sides, miterAngle) {
            const polygon = document.getElementById('miterPolygon');
            const miterAnglesGroup = document.getElementById('miterAngles');
            const sidesLabel = document.getElementById('sidesLabel');
            const angleLabel = document.getElementById('angleLabel');
            
            if (!polygon || !miterAnglesGroup) return;
            
            const radius = 60;
            
            // Calculate polygon points
            let points = '';
            let vertices = [];
            for (let i = 0; i < sides; i++) {
                const angle = (i * 2 * Math.PI) / sides - Math.PI / 2;
                const x = radius * Math.cos(angle);
                const y = radius * Math.sin(angle);
                points += `${x},${y} `;
                vertices.push({x, y, angle});
            }
            
            // Update polygon
            polygon.setAttribute('points', points.trim());
            
            // Clear and regenerate miter angle indicators
            miterAnglesGroup.innerHTML = '';
            
            // Generate miter joint details for first few corners
            for (let i = 0; i < Math.min(sides, 4); i++) {
                const vertex = vertices[i];
                const nextVertex = vertices[(i + 1) % sides];
                
                // Draw miter cut indication at each corner
                const miterLength = 15;
                const angleToNext = Math.atan2(nextVertex.y - vertex.y, nextVertex.x - vertex.x);
                const angleToPrev = Math.atan2(vertices[(i - 1 + sides) % sides].y - vertex.y, vertices[(i - 1 + sides) % sides].x - vertex.x);
                
                const miterX1 = vertex.x + miterLength * Math.cos(angleToNext);
                const miterY1 = vertex.y + miterLength * Math.sin(angleToNext);
                const miterX2 = vertex.x + miterLength * Math.cos(angleToPrev);
                const miterY2 = vertex.y + miterLength * Math.sin(angleToPrev);
                
                miterAnglesGroup.innerHTML += `<line x1="${vertex.x}" y1="${vertex.y}" x2="${miterX1}" y2="${miterY1}" stroke="#dc3545" stroke-width="2" stroke-dasharray="3,2"/>`;
                miterAnglesGroup.innerHTML += `<line x1="${vertex.x}" y1="${vertex.y}" x2="${miterX2}" y2="${miterY2}" stroke="#dc3545" stroke-width="2" stroke-dasharray="3,2"/>`;
                
                // Add corner numbers
                const labelOffset = 25;
                const labelX = vertex.x + labelOffset * Math.cos(vertex.angle);
                const labelY = vertex.y + labelOffset * Math.sin(vertex.angle);
                miterAnglesGroup.innerHTML += `<circle cx="${labelX}" cy="${labelY}" r="10" fill="#007bff" opacity="0.8"/>`;
                miterAnglesGroup.innerHTML += `<text x="${labelX}" y="${labelY + 4}" text-anchor="middle" font-size="10" font-weight="bold" fill="white">${i + 1}</text>`;
            }
            
            // Update labels
            if (sidesLabel) sidesLabel.textContent = `${sides} Sides`;
            if (angleLabel) angleLabel.textContent = `Miter Angle: ${miterAngle.toFixed(1)}¬∞`;
        }

        // Removed old updatePolygonDiagramOLD function - replaced with SVG version above

        // Species Price Memory Functions
        function handleSpeciesChange() {
            const species = document.getElementById('bfSpecies').value;
            const customSpeciesRow = document.getElementById('customSpeciesRow');
            const priceInput = document.getElementById('bfPrice');
            
            // Handle custom species dropdown toggle
            if (species === 'Custom') {
                customSpeciesRow.style.display = 'block';
            } else {
                customSpeciesRow.style.display = 'none';
            }
            
            // Auto-fill remembered price for this specific species, or clear if no price saved
            if (species && species !== 'Custom') {
                if (speciesPrices[species]) {
                    priceInput.value = speciesPrices[species].toFixed(2);
                    showNotification(`Auto-filled price: $${speciesPrices[species].toFixed(2)}/BF`);
                } else {
                    priceInput.value = ''; // Clear price field for species with no saved price
                    priceInput.placeholder = 'Enter price/BF';
                }
            } else if (species === 'Custom') {
                priceInput.value = ''; // Always clear price for custom species
                priceInput.placeholder = 'Enter price/BF';
            }
            
            // Recalculate with new species/price
            calculateBoardFeet();
        }

        // Lumber Cart Management Functions
        function addToLumberCart() {
            const species = document.getElementById('bfSpecies').value;
            const customSpecies = document.getElementById('bfCustomSpecies').value;
            const price = parseFloat(document.getElementById('bfPrice').value) || 0;
            const thickness = parseFloat(document.getElementById('bfThickness').value) || 0;
            const width = parseFloat(document.getElementById('bfWidth').value) || 0;
            const length = parseFloat(document.getElementById('bfLength').value) || 0;
            const quantity = parseFloat(document.getElementById('bfQuantity').value) || 1;
            
            // Validate required fields
            if (!species || (species === 'Custom' && !customSpecies.trim())) {
                showNotification('Please select a wood species');
                return;
            }
            
            if (thickness <= 0 || width <= 0 || length <= 0 || quantity <= 0) {
                showNotification('Please enter valid dimensions and quantity');
                return;
            }
            
            if (price <= 0) {
                showNotification('Please enter a valid price per board foot');
                return;
            }
            
            // Calculate board feet and line total
            const boardFeet = (thickness * width * length * quantity) / 144;
            const lineTotal = boardFeet * price;
            const displaySpecies = species === 'Custom' ? customSpecies.trim() : species;
            
            // Create cart item
            const cartItem = {
                id: Date.now(), // Simple unique ID
                species: displaySpecies,
                thickness,
                width,
                length,
                quantity,
                pricePerBF: price,
                boardFeet,
                lineTotal
            };
            
            // Remember price for this species (for price memory feature)
            speciesPrices[displaySpecies] = price;
            
            // Add to cart
            lumberCart.push(cartItem);
            
            // Update cart display
            updateCartDisplay();
            
            // Clear form for next item
            clearBoardFootForm();
            
            showNotification(`Added ${displaySpecies} to cart`);
        }

        function removeFromLumberCart(itemId) {
            lumberCart = lumberCart.filter(item => item.id !== itemId);
            updateCartDisplay();
            showNotification('Item removed from cart');
        }

        function clearLumberCart() {
            if (lumberCart.length === 0) return;
            
            if (confirm('Clear all items from cart?')) {
                lumberCart = [];
                updateCartDisplay();
                showNotification('Cart cleared');
            }
        }

        function clearBoardFootForm() {
            document.getElementById('bfSpecies').value = '';
            document.getElementById('bfCustomSpecies').value = '';
            document.getElementById('bfPrice').value = '';
            document.getElementById('bfThickness').value = '';
            document.getElementById('bfWidth').value = '';
            document.getElementById('bfLength').value = '';
            document.getElementById('bfQuantity').value = '1';
            document.getElementById('customSpeciesRow').style.display = 'none';
            
            // Clear result display
            document.getElementById('boardFootResult').innerHTML = '<div class="result-placeholder">Enter item details above</div>';
        }

        function updateCartDisplay() {
            const cartContainer = document.getElementById('lumberCartDisplay');
            if (!cartContainer) return;
            
            if (lumberCart.length === 0) {
                cartContainer.innerHTML = '<div class="result-placeholder">No items in cart</div>';
                return;
            }
            
            let totalBoardFeet = 0;
            let totalCost = 0;
            
            let cartHTML = `
                <div class="cart-header">
                    <h4>Shopping Cart (${lumberCart.length} item${lumberCart.length !== 1 ? 's' : ''})</h4>
                    <button class="btn btn-secondary btn-sm" onclick="clearLumberCart()">Clear Cart</button>
                </div>
                <div class="cart-items">
            `;
            
            lumberCart.forEach(item => {
                totalBoardFeet += item.boardFeet;
                totalCost += item.lineTotal;
                
                cartHTML += `
                    <div class="cart-item">
                        <div class="cart-item-header">
                            <strong>${item.species}</strong>
                            <button class="btn-remove" onclick="removeFromLumberCart(${item.id})" title="Remove item">√ó</button>
                        </div>
                        <div class="cart-item-details">
                            ${item.quantity} pc${item.quantity !== 1 ? 's' : ''} √ó ${item.thickness}" √ó ${item.width}" √ó ${item.length}"
                        </div>
                        <div class="cart-item-pricing">
                            ${item.boardFeet.toFixed(3)} BF √ó $${item.pricePerBF.toFixed(2)}/BF = <strong>$${item.lineTotal.toFixed(2)}</strong>
                        </div>
                    </div>
                `;
            });
            
            cartHTML += `
                </div>
                <div class="cart-summary">
                    <div class="summary-row">
                        <span>Total Board Feet:</span>
                        <strong>${totalBoardFeet.toFixed(3)} BF</strong>
                    </div>
                    <div class="summary-row">
                        <span>Total Cost:</span>
                        <strong>$${totalCost.toFixed(2)}</strong>
                    </div>
                </div>
            `;
            
            cartContainer.innerHTML = cartHTML;
            
            // Enable/disable save cart button
            const saveBtn = document.getElementById('saveCartBtn');
            if (saveBtn) {
                saveBtn.disabled = lumberCart.length === 0;
            }
        }


        function saveLumberCartToProject() {
            if (lumberCart.length === 0) {
                showNotification('Cart is empty');
                return;
            }
            
            let totalBoardFeet = 0;
            let totalCost = 0;
            let cartSummary = '';
            
            lumberCart.forEach((item, index) => {
                totalBoardFeet += item.boardFeet;
                totalCost += item.lineTotal;
                
                cartSummary += `${index + 1}. ${item.species} - `;
                cartSummary += `${item.quantity} pc${item.quantity !== 1 ? 's' : ''} √ó ${item.thickness}" √ó ${item.width}" √ó ${item.length}" `;
                cartSummary += `(${item.boardFeet.toFixed(3)} BF √ó $${item.pricePerBF.toFixed(2)}/BF = $${item.lineTotal.toFixed(2)})\n`;
            });
            
            const previewContent = `
                <div class="save-preview-lumber">
                    <div class="preview-header">
                        <strong>üõí Lumber Shopping Cart</strong>
                    </div>
                    <div class="preview-summary">
                        <strong>Total: ${totalBoardFeet.toFixed(3)} BF - $${totalCost.toFixed(2)}</strong>
                    </div>
                    <div class="preview-details">
                        ${cartSummary.replace(/\n/g, '<br>')}
                    </div>
                </div>
            `;
            
            const saveData = {
                tool: 'lumber',
                equation: `Lumber Cart: ${lumberCart.length} items`,
                result: `${totalBoardFeet.toFixed(3)} BF - $${totalCost.toFixed(2)}`,
                details: {
                    items: [...lumberCart],
                    totalBoardFeet: totalBoardFeet.toFixed(3),
                    totalCost: totalCost.toFixed(2),
                    itemCount: lumberCart.length
                },
                preview: previewContent
            };
            
            showSaveToProjectModal(saveData);
        }

        function saveBoardFeetToHistory() {
            const thickness = parseFloat(document.getElementById('bfThickness').value) || 0;
            const width = parseFloat(document.getElementById('bfWidth').value) || 0;
            const length = parseFloat(document.getElementById('bfLength').value) || 0;
            const quantity = parseFloat(document.getElementById('bfQuantity').value) || 1;
            
            if (thickness === 0 || width === 0 || length === 0) {
                showNotification('Enter dimensions first');
                return;
            }
            
            const boardFeet = (thickness * width * length * quantity) / 144;
            
        }

        function saveGoldenRatioToHistory() {
            const input = getInputInches('grFeet', 'grInches', 'grFraction');
            
            if (input === 0) {
                showNotification('Enter a dimension first');
                return;
            }
            
            const phi = 1.618033988749895;
            let shortSide, longSide, equation;
            
            if (currentGoldenMode === 'short') {
                shortSide = input;
                longSide = input * phi;
                equation = `Golden Ratio: Short ${inchesToDisplay(shortSide)} ‚Üí Long ${inchesToDisplay(longSide)}`;
            } else {
                longSide = input;
                shortSide = input / phi;
                equation = `Golden Ratio: Long ${inchesToDisplay(longSide)} ‚Üí Short ${inchesToDisplay(shortSide)}`;
            }
            
        }
        
        function saveGoldenRatioToProject() {
            const input = getInputInches('grFeet', 'grInches', 'grFraction');
            
            if (input === 0) {
                showNotification('Enter a dimension first', 'warning');
                return;
            }
            
            const phi = 1.618033988749895;
            let shortSide, longSide, equation, details;
            
            if (currentGoldenMode === 'short') {
                shortSide = input;
                longSide = input * phi;
                equation = `Golden Ratio: Short ${inchesToDisplay(shortSide)} ‚Üí Long ${inchesToDisplay(longSide)}`;
                details = `Input (short side): ${inchesToDisplay(shortSide)}\nGolden ratio result (long side): ${inchesToDisplay(longSide)}\nRatio: 1:1.618 (œÜ = golden ratio)`;
            } else {
                longSide = input;
                shortSide = input / phi;
                equation = `Golden Ratio: Long ${inchesToDisplay(longSide)} ‚Üí Short ${inchesToDisplay(shortSide)}`;
                details = `Input (long side): ${inchesToDisplay(longSide)}\nGolden ratio result (short side): ${inchesToDisplay(shortSide)}\nRatio: 1.618:1 (œÜ = golden ratio)`;
            }
            
            const data = {
                equation: equation,
                result: `Long: ${inchesToDisplay(longSide)}, Short: ${inchesToDisplay(shortSide)}`,
                details: details
            };
            
            showSaveToProjectModal('Golden Ratio Calculator', data);
        }

        function setAngleSides(sides) {
            document.getElementById('maSides').value = sides;
            calculateMiterAngle();
        }

        let currentMiterMode = 'polygon'; // Default mode: polygon
        
        function setMiterMode(mode) {
            currentMiterMode = mode;
            document.getElementById('miterModePolygon').classList.toggle('active', mode === 'polygon');
            document.getElementById('miterModeFrame').classList.toggle('active', mode === 'frame');
            document.getElementById('miterModeSingle').classList.toggle('active', mode === 'single');
            
            const polygonInputs = document.getElementById('polygonMiterInputs');
            const frameInputs = document.getElementById('frameMiterInputs');
            const singleInputs = document.getElementById('singleMiterInputs');
            
            if (mode === 'polygon') {
                polygonInputs.style.display = 'block';
                frameInputs.style.display = 'none';
                singleInputs.style.display = 'none';
                calculateMiterAngle();
            } else if (mode === 'frame') {
                polygonInputs.style.display = 'none';
                frameInputs.style.display = 'block';
                singleInputs.style.display = 'none';
                updateFrameDimensionLabels();
                calculateFrameBuilder();
            } else {
                polygonInputs.style.display = 'none';
                frameInputs.style.display = 'none';
                singleInputs.style.display = 'block';
                calculateSingleMiter();
            }
        }

        function calculateSingleMiter() {
            const angle = parseFloat(document.getElementById('singleMiterAngle').value) || 0;
            const boardWidth = getInputInches('singleBoardWidthFeet', 'singleBoardWidthInches', 'singleBoardWidthFraction');
            const knownSide = document.getElementById('singleKnownSide').value;
            const cutType = document.getElementById('singleCutType').value;
            const inputLength = getInputInches('singleInputLengthFeet', 'singleInputLengthInches', 'singleInputLengthFraction');
            const resultDiv = document.getElementById('maResult');
            
            if (angle === 0 || boardWidth === 0 || inputLength === 0) {
                resultDiv.innerHTML = '<div class="result-placeholder">Enter all values above</div>';
                return;
            }
            
            const angleRad = (angle * Math.PI) / 180;
            const singleOffset = boardWidth * Math.tan(angleRad);
            const totalOffset = cutType === 'dual-sided' ? singleOffset * 2 : singleOffset;
            
            let shortSide, longSide;
            if (knownSide === 'long') {
                longSide = inputLength;
                shortSide = longSide - totalOffset;
            } else {
                shortSide = inputLength;
                longSide = shortSide + totalOffset;
            }
            
            const cutDescription = cutType === 'one-sided' ? 'Single Board Cut (One End)' : 'Single Board Cut (Both Ends)';
            const offsetDescription = cutType === 'one-sided' ? 
                `Offset: ${inchesToDisplay(singleOffset)} (one end)` : 
                `Total Offset: ${inchesToDisplay(totalOffset)} (${inchesToDisplay(singleOffset)} per end)`;
            
            resultDiv.innerHTML = `
                <div class="result-value">${angle}¬∞ ${cutDescription}</div>
                <div class="result-details">
                    Long side (back): ${inchesToDisplay(longSide, 'calculator')}<br>
                    Short side (front): ${inchesToDisplay(shortSide, 'calculator')}<br>
                    ${offsetDescription}
                </div>
            `;
            
            // Update label for the input
            const label = document.getElementById('singleInputLabel');
            label.textContent = knownSide === 'long' ? 'Long side length:' : 'Short side length:';
            
            // Update diagram to show single miter cut visualization
            updateSingleMiterDiagram(angle, boardWidth, shortSide, longSide, cutType);
        }

        function updateSingleMiterDiagram(angle, boardWidth, shortSide, longSide, cutType = 'one-sided') {
            const diagram = document.getElementById('angleDiagram');
            if (!diagram) return;
            
            // Create a detailed, large miter cut visualization
            const svgWidth = 260;
            const svgHeight = 180;
            const boardVisualWidth = 180;
            const boardVisualHeight = Math.max(30, Math.min(boardWidth * 20, 60)); // Scale board width visually
            const centerX = svgWidth / 2;
            const boardY = (svgHeight - boardVisualHeight) / 2 - 10;
            
            // Calculate miter cut coordinates
            const miterLength = 30; // Length of miter cut display
            const leftCutX1 = centerX - boardVisualWidth/2;
            const leftCutY1 = boardY;
            const leftCutX2 = leftCutX1 + miterLength;
            const leftCutY2 = boardY + boardVisualHeight;
            
            const rightCutX1 = centerX + boardVisualWidth/2;
            const rightCutY1 = boardY;
            const rightCutX2 = rightCutX1 - miterLength;
            const rightCutY2 = boardY + boardVisualHeight;
            
            diagram.innerHTML = `
                <div style="text-align: center; margin: 0; padding: 10px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%;">
                    <svg width="${svgWidth}" height="${svgHeight}" style="display: block; margin: 0 auto; border: 1px solid #ddd; border-radius: 8px; background: #fafafa;">
                        <!-- Board outline with wood grain effect -->
                        <rect x="${centerX - boardVisualWidth/2}" y="${boardY}" width="${boardVisualWidth}" height="${boardVisualHeight}" 
                              fill="url(#woodGrain)" stroke="var(--primary-color)" stroke-width="3" rx="2"/>
                        
                        <!-- Wood grain pattern definition -->
                        <defs>
                            <pattern id="woodGrain" patternUnits="userSpaceOnUse" width="20" height="8">
                                <rect width="20" height="8" fill="var(--accent-color)"/>
                                <line x1="0" y1="2" x2="20" y2="2" stroke="#CD853F" stroke-width="0.5"/>
                                <line x1="0" y1="5" x2="20" y2="5" stroke="#CD853F" stroke-width="0.3"/>
                            </pattern>
                        </defs>
                        
                        <!-- Miter cut lines with enhanced styling -->
                        ${cutType === 'dual-sided' ? `
                            <!-- Left cut (always shown for dual-sided) -->
                            <line x1="${leftCutX1}" y1="${leftCutY1}" x2="${leftCutX2}" y2="${leftCutY2}" 
                                  stroke="#dc3545" stroke-width="4" stroke-dasharray="2,2"/>
                            <path d="M ${leftCutX1 + 15} ${leftCutY1 + 5} A 10 10 0 0 1 ${leftCutX1 + 10} ${leftCutY1 + 15}" 
                                  stroke="#dc3545" stroke-width="2" fill="none"/>
                            <!-- Right cut -->
                            <line x1="${rightCutX1}" y1="${rightCutY1}" x2="${rightCutX2}" y2="${rightCutY2}" 
                                  stroke="#dc3545" stroke-width="4" stroke-dasharray="2,2"/>
                            <path d="M ${rightCutX1 - 15} ${rightCutY1 + 5} A 10 10 0 0 0 ${rightCutX1 - 10} ${rightCutY1 + 15}" 
                                  stroke="#dc3545" stroke-width="2" fill="none"/>
                        ` : `
                            <!-- Single-sided cut (left side only) -->
                            <line x1="${leftCutX1}" y1="${leftCutY1}" x2="${leftCutX2}" y2="${leftCutY2}" 
                                  stroke="#dc3545" stroke-width="4" stroke-dasharray="2,2"/>
                            <path d="M ${leftCutX1 + 15} ${leftCutY1 + 5} A 10 10 0 0 1 ${leftCutX1 + 10} ${leftCutY1 + 15}" 
                                  stroke="#dc3545" stroke-width="2" fill="none"/>
                            <!-- Show straight right edge for one-sided -->
                            <line x1="${rightCutX1}" y1="${rightCutY1}" x2="${rightCutX1}" y2="${rightCutY2}" 
                                  stroke="#28a745" stroke-width="3" opacity="0.7"/>
                            <text x="${rightCutX1 + 15}" y="${(rightCutY1 + rightCutY2)/2}" text-anchor="start" font-size="10" fill="#28a745" font-weight="bold">
                                Square Cut
                            </text>
                        `}
                        
                        <!-- Main angle label -->
                        <text x="${centerX}" y="${boardY - 15}" text-anchor="middle" font-size="16" font-weight="bold" fill="#dc3545">
                            ${angle}¬∞ ${cutType === 'one-sided' ? 'One-End' : 'Both-Ends'} Cut
                        </text>
                        
                        <!-- Dimension labels with leader lines -->
                        <text x="${centerX}" y="${boardY + boardVisualHeight + 25}" text-anchor="middle" font-size="14" font-weight="bold" fill="var(--primary-color)">
                            Long Side: ${inchesToDisplay(longSide, 'calculator')}
                        </text>
                        <text x="${centerX}" y="${boardY + boardVisualHeight + 40}" text-anchor="middle" font-size="14" font-weight="bold" fill="#654321">
                            Short Side: ${inchesToDisplay(shortSide, 'calculator')}
                        </text>
                        
                        <!-- Board width indicator -->
                        <text x="${centerX}" y="${boardY + boardVisualHeight/2 + 5}" text-anchor="middle" font-size="12" font-weight="bold" fill="white">
                            Board: ${inchesToDisplay(boardWidth, 'calculator')} wide
                        </text>
                        
                        <!-- Cut direction arrows -->
                        <path d="M ${leftCutX1 + 5} ${leftCutY1 + 10} L ${leftCutX1 + 15} ${leftCutY1 + 5} L ${leftCutX1 + 15} ${leftCutY1 + 15} Z" 
                              fill="#dc3545" opacity="0.7"/>
                        <path d="M ${rightCutX1 - 5} ${rightCutY1 + 10} L ${rightCutX1 - 15} ${rightCutY1 + 5} L ${rightCutX1 - 15} ${rightCutY1 + 15} Z" 
                              fill="#dc3545" opacity="0.7"/>
                    </svg>
                </div>
            `;
        }

        // Frame Builder Functions
        function updateFrameDimensionLabels() {
            const dimensionType = document.getElementById('frameDimensionType').value;
            const sides = parseInt(document.getElementById('frameShapeSides').value);
            
            // Update labels based on inside/outside selection
            if (sides === 4) {
                // Rectangle/Square
                document.getElementById('frameWidthLabel').textContent = 
                    dimensionType === 'inside' ? 'Inside Width:' : 'Outside Width:';
                document.getElementById('frameHeightLabel').textContent = 
                    dimensionType === 'inside' ? 'Inside Height:' : 'Outside Height:';
                document.getElementById('frameRectangleDimensions').style.display = 'block';
                document.getElementById('framePolygonDimensions').style.display = 'none';
            } else {
                // Regular polygon
                document.getElementById('framePolygonLabel').textContent = 
                    dimensionType === 'inside' ? 'Inside Side Length:' : 'Outside Side Length:';
                document.getElementById('frameRectangleDimensions').style.display = 'none';
                document.getElementById('framePolygonDimensions').style.display = 'block';
            }
        }

        function calculateFrameBuilder() {
            const sides = parseInt(document.getElementById('frameShapeSides').value);
            const materialWidth = getInputInches('frameMaterialWidthFeet', 'frameMaterialWidthInches', 'frameMaterialWidthFraction');
            const dimensionType = document.getElementById('frameDimensionType').value;
            const resultDiv = document.getElementById('maResult');
            
            if (materialWidth === 0) {
                resultDiv.innerHTML = '<div class="result-placeholder">Enter material width</div>';
                return;
            }
            
            // Calculate miter angle for this polygon
            const interiorAngle = ((sides - 2) * 180) / sides;
            const miterAngle = (180 - interiorAngle) / 2;
            const miterRadians = (miterAngle * Math.PI) / 180;
            
            let cutList = '';
            let totalLinearFeet = 0;
            let insideDimensions = '';
            let outsideDimensions = '';
            
            if (sides === 4) {
                // Rectangle/Square frame
                const inputWidth = getInputInches('frameWidthFeet', 'frameWidthInches', 'frameWidthFraction');
                const inputHeight = getInputInches('frameHeightFeet', 'frameHeightInches', 'frameHeightFraction');
                
                if (inputWidth === 0 || inputHeight === 0) {
                    resultDiv.innerHTML = '<div class="result-placeholder">Enter frame dimensions</div>';
                    return;
                }
                
                let insideWidth, insideHeight, outsideWidth, outsideHeight;
                
                // Calculate offset for miter joints
                const offset = materialWidth * Math.tan(miterRadians);
                
                if (dimensionType === 'inside') {
                    // User provided inside dimensions
                    insideWidth = inputWidth;
                    insideHeight = inputHeight;
                    outsideWidth = insideWidth + 2 * materialWidth;
                    outsideHeight = insideHeight + 2 * materialWidth;
                } else {
                    // User provided outside dimensions
                    outsideWidth = inputWidth;
                    outsideHeight = inputHeight;
                    insideWidth = outsideWidth - 2 * materialWidth;
                    insideHeight = outsideHeight - 2 * materialWidth;
                }
                
                // Calculate cut lengths (long side includes the offset on both ends)
                const horizontalCutLength = insideWidth + 2 * offset;
                const verticalCutLength = insideHeight + 2 * offset;
                
                // Create cut list with both inside and outside measurements for clarity
                cutList = `
                    <div class="cut-list">
                        <h4>Cut List:</h4>
                        <div class="cut-item">
                            <strong>2 horizontal pieces:</strong><br>
                            Cut Length: ${inchesToDisplay(horizontalCutLength)}<br>
                            <small>(Inside span: ${inchesToDisplay(insideWidth)}, Outside span: ${inchesToDisplay(outsideWidth)})</small>
                        </div>
                        <div class="cut-item">
                            <strong>2 vertical pieces:</strong><br>
                            Cut Length: ${inchesToDisplay(verticalCutLength)}<br>
                            <small>(Inside span: ${inchesToDisplay(insideHeight)}, Outside span: ${inchesToDisplay(outsideHeight)})</small>
                        </div>
                    </div>
                `;
                
                totalLinearFeet = ((horizontalCutLength * 2) + (verticalCutLength * 2)) / 12;
                insideDimensions = `${inchesToDisplay(insideWidth)} √ó ${inchesToDisplay(insideHeight)}`;
                outsideDimensions = `${inchesToDisplay(outsideWidth)} √ó ${inchesToDisplay(outsideHeight)}`;
                
            } else {
                // Regular polygon frame
                const inputSideLength = getInputInches('framePolygonFeet', 'framePolygonInches', 'framePolygonFraction');
                
                if (inputSideLength === 0) {
                    resultDiv.innerHTML = '<div class="result-placeholder">Enter polygon side length</div>';
                    return;
                }
                
                let insideSideLength, outsideSideLength;
                
                if (dimensionType === 'inside') {
                    insideSideLength = inputSideLength;
                    // For regular polygon, outside side length = inside + 2 * (material_width / tan((œÄ-interior_angle)/2))
                    // Simplified: outside = inside + 2 * material_width / tan(miter_angle)
                    const sideWidthAddition = 2 * materialWidth / Math.tan(miterRadians);
                    outsideSideLength = insideSideLength + sideWidthAddition;
                } else {
                    outsideSideLength = inputSideLength;
                    const sideWidthAddition = 2 * materialWidth / Math.tan(miterRadians);
                    insideSideLength = outsideSideLength - sideWidthAddition;
                }
                
                const offset = materialWidth * Math.tan(miterRadians);
                const cutLength = insideSideLength + 2 * offset;
                
                cutList = `
                    <div class="cut-list">
                        <h4>Cut List:</h4>
                        <div class="cut-item">
                            <strong>${sides} pieces:</strong><br>
                            Cut Length: ${inchesToDisplay(cutLength)}<br>
                            <small>(Inside side: ${inchesToDisplay(insideSideLength)}, Outside side: ${inchesToDisplay(outsideSideLength)})</small>
                        </div>
                    </div>
                `;
                
                totalLinearFeet = (cutLength * sides) / 12;
                insideDimensions = `${inchesToDisplay(insideSideLength)} per side`;
                outsideDimensions = `${inchesToDisplay(outsideSideLength)} per side`;
            }
            
            resultDiv.innerHTML = `
                <div class="result-value">${miterAngle.toFixed(1)}¬∞ miter cut</div>
                <div class="result-details">
                    <strong>Inside:</strong> ${insideDimensions}<br>
                    <strong>Outside:</strong> ${outsideDimensions}<br>
                    <strong>Material needed:</strong> ${totalLinearFeet.toFixed(1)} linear feet
                </div>
                ${cutList}
            `;
            
            // Update diagram to show the frame shape
            updatePolygonDiagram(sides, miterAngle);
        }

        function saveAngleToHistory() {
            if (currentMiterMode === 'polygon') {
                const sides = parseInt(document.getElementById('maSides').value) || 0;
                
                if (sides < 3) {
                    showNotification('Enter number of sides first');
                    return;
                }
                
                const interiorAngle = ((sides - 2) * 180) / sides;
                const miterAngle = (180 - interiorAngle) / 2;
                
            } else if (currentMiterMode === 'frame') {
                const sides = parseInt(document.getElementById('frameShapeSides').value);
                const materialWidth = getInputInches('frameMaterialWidthFeet', 'frameMaterialWidthInches', 'frameMaterialWidthFraction');
                
                if (materialWidth === 0) {
                    showNotification('Enter frame details first');
                    return;
                }
                
                const interiorAngle = ((sides - 2) * 180) / sides;
                const miterAngle = (180 - interiorAngle) / 2;
                
                let frameName = '';
                if (sides === 4) frameName = 'Rectangle/Square';
                else if (sides === 3) frameName = 'Triangle';
                else if (sides === 6) frameName = 'Hexagon';
                else if (sides === 8) frameName = 'Octagon';
                else frameName = `${sides}-sided`;
                
                // Get dimensions summary
                let dimensionsSummary = '';
                if (sides === 4) {
                    const width = getInputInches('frameWidthFeet', 'frameWidthInches', 'frameWidthFraction');
                    const height = getInputInches('frameHeightFeet', 'frameHeightInches', 'frameHeightFraction');
                    dimensionsSummary = `${inchesToDisplay(width)} √ó ${inchesToDisplay(height)}`;
                } else {
                    const sideLength = getInputInches('framePolygonFeet', 'framePolygonInches', 'framePolygonFraction');
                    dimensionsSummary = `${inchesToDisplay(sideLength)} side length`;
                }
                
            } else {
                const angle = parseFloat(document.getElementById('singleMiterAngle').value) || 0;
                const boardWidth = getInputInches('singleBoardWidthFeet', 'singleBoardWidthInches', 'singleBoardWidthFraction');
                const inputLength = getInputInches('singleInputLengthFeet', 'singleInputLengthInches', 'singleInputLengthFraction');
                const knownSide = document.getElementById('singleKnownSide').value;
                
                if (angle === 0 || boardWidth === 0 || inputLength === 0) {
                    showNotification('Enter all values first');
                    return;
                }
                
                const angleRad = (angle * Math.PI) / 180;
                const offset = boardWidth * Math.tan(angleRad);
                
                let shortSide, longSide;
                if (knownSide === 'long') {
                    longSide = inputLength;
                    shortSide = longSide - offset;
                } else {
                    shortSide = inputLength;
                    longSide = shortSide + offset;
                }
                
            }
        }
        
        function saveAngleToProject() {
            if (currentMiterMode === 'polygon') {
                const sides = parseInt(document.getElementById('maSides').value) || 0;
                
                if (sides < 3) {
                    showNotification('Enter number of sides first', 'warning');
                    return;
                }
                
                const interiorAngle = ((sides - 2) * 180) / sides;
                const miterAngle = (180 - interiorAngle) / 2;
                const tableAngle = 90 - miterAngle;
                
                const data = {
                    equation: `${sides}-sided polygon: ${miterAngle.toFixed(2)}¬∞ miter cuts`,
                    result: `${miterAngle.toFixed(2)}¬∞ miter, ${tableAngle.toFixed(2)}¬∞ table saw`,
                    details: `Polygon: ${sides} sides\nInterior angle: ${interiorAngle.toFixed(1)}¬∞\nMiter cut angle: ${miterAngle.toFixed(2)}¬∞\nTable saw angle: ${tableAngle.toFixed(2)}¬∞\nEach piece needs ${miterAngle.toFixed(2)}¬∞ cut on both ends`
                };
                
                showSaveToProjectModal('Miter Angle Calculator - Polygon', data);
                
            } else if (currentMiterMode === 'frame') {
                const sides = parseInt(document.getElementById('frameShapeSides').value);
                const materialWidth = getInputInches('frameMaterialWidthFeet', 'frameMaterialWidthInches', 'frameMaterialWidthFraction');
                
                if (materialWidth === 0) {
                    showNotification('Enter frame details first', 'warning');
                    return;
                }
                
                const interiorAngle = ((sides - 2) * 180) / sides;
                const miterAngle = (180 - interiorAngle) / 2;
                
                let frameName = sides === 4 ? 'Rectangle/Square' : `${sides}-sided Polygon`;
                let dimensionsSummary = '';
                
                if (sides === 4) {
                    const width = getInputInches('frameWidthFeet', 'frameWidthInches', 'frameWidthFraction');
                    const height = getInputInches('frameHeightFeet', 'frameHeightInches', 'frameHeightFraction');
                    dimensionsSummary = `${inchesToDisplay(width)} √ó ${inchesToDisplay(height)}`;
                } else {
                    const sideLength = getInputInches('framePolygonFeet', 'framePolygonInches', 'framePolygonFraction');
                    dimensionsSummary = `${inchesToDisplay(sideLength)} per side`;
                }
                
                const data = {
                    equation: `${frameName} Frame: ${dimensionsSummary}, ${inchesToDisplay(materialWidth)} material`,
                    result: `${miterAngle.toFixed(1)}¬∞ cuts`,
                    details: `Frame: ${frameName}\nDimensions: ${dimensionsSummary}\nMaterial width: ${inchesToDisplay(materialWidth)}\nMiter angle: ${miterAngle.toFixed(1)}¬∞\nCut angle for joining frame pieces`
                };
                
                showSaveToProjectModal('Miter Angle Calculator - Frame Builder', data);
                
            } else {
                // Single Board Cut mode
                const angle = parseFloat(document.getElementById('singleMiterAngle').value) || 0;
                const boardWidth = getInputInches('singleBoardWidthFeet', 'singleBoardWidthInches', 'singleBoardWidthFraction');
                const knownSide = document.getElementById('singleKnownSide').value;
                const cutType = document.getElementById('singleCutType').value;
                const inputLength = getInputInches('singleInputLengthFeet', 'singleInputLengthInches', 'singleInputLengthFraction');
                
                if (angle === 0 || boardWidth === 0 || inputLength === 0) {
                    showNotification('Enter all values first', 'warning');
                    return;
                }
                
                const angleRad = (angle * Math.PI) / 180;
                const singleOffset = boardWidth * Math.tan(angleRad);
                const totalOffset = cutType === 'dual-sided' ? singleOffset * 2 : singleOffset;
                
                let shortSide, longSide;
                if (knownSide === 'long') {
                    longSide = inputLength;
                    shortSide = longSide - totalOffset;
                } else {
                    shortSide = inputLength;
                    longSide = shortSide + totalOffset;
                }
                
                const cutDescription = cutType === 'one-sided' ? 'One End Cut' : 'Both Ends Cut';
                
                const data = {
                    equation: `${angle}¬∞ miter cut: ${inchesToDisplay(boardWidth)} board, ${knownSide} side ${inchesToDisplay(inputLength)}`,
                    result: `Long: ${inchesToDisplay(longSide)}, Short: ${inchesToDisplay(shortSide)}`,
                    details: `Cut Type: ${cutDescription}\nAngle: ${angle}¬∞\nBoard width: ${inchesToDisplay(boardWidth)}\nKnown side: ${knownSide} (${inchesToDisplay(inputLength)})\nLong side: ${inchesToDisplay(longSide)}\nShort side: ${inchesToDisplay(shortSide)}\nOffset: ${inchesToDisplay(totalOffset)}`
                };
                
                showSaveToProjectModal('Miter Angle Calculator - Single Board Cut', data);
            }
        }

        function saveSpacingToHistory() {
            const totalLength = getInputInches('spTotalLengthFeet', 'spTotalLengthInches', 'spTotalLengthFraction');
            const numShelves = parseInt(document.getElementById('spNumShelves').value) || 0;
            const thickness = getInputInches('spacingThicknessFeet', 'spacingThicknessInches', 'spacingThicknessFraction');
            
            if (totalLength === 0 || numShelves === 0) {
                showNotification('Enter dimensions first');
                return;
            }
            
            // Convert shelves to spaces: N shelves = N+1 spaces
            const numSpaces = numShelves + 1;
            let spacing, detailedEquation;
            
            if (thickness === 0) {
                // CENTER MARKS MODE - No material thickness
                spacing = totalLength / numSpaces;
                const centerMarks = Array.from({length: numShelves}, (_, i) => inchesToDisplay((i + 1) * spacing, 'calculator'));
                
                detailedEquation = `SHELF & DIVISION - Center Marks
Total Length: ${inchesToDisplay(totalLength, 'calculator')}
Shelves: ${numShelves} shelves (${numSpaces} spaces)
Space Size: ${inchesToDisplay(spacing, 'calculator')} each
Material: No thickness (center marks)

üìê Shelf Center Marking Guide:`;

                if (centerMarks.length <= 10) {
                    centerMarks.forEach((mark, i) => {
                        detailedEquation += `\nShelf ${i + 1}: Center ${mark}`;
                    });
                } else {
                    // Show first 5, middle indicator, last 5
                    for (let i = 0; i < 5; i++) {
                        detailedEquation += `\nShelf ${i + 1}: Center ${centerMarks[i]}`;
                    }
                    detailedEquation += `\n... ${centerMarks.length - 10} more shelves ...`;
                    for (let i = centerMarks.length - 5; i < centerMarks.length; i++) {
                        detailedEquation += `\nShelf ${i + 1}: Center ${centerMarks[i]}`;
                    }
                }
                
            } else {
                // SHELF MODE - With material thickness
                const totalThickness = numShelves * thickness;
                const availableSpace = totalLength - totalThickness;
                spacing = availableSpace / numSpaces;
                
                // Calculate shelf positions
                const shelfInfo = [];
                let currentPos = 0;
                for (let i = 0; i < numShelves; i++) {
                    currentPos += spacing;
                    const leftEdge = currentPos;
                    const rightEdge = currentPos + thickness;
                    shelfInfo.push({
                        number: i + 1,
                        bottom: inchesToDisplay(leftEdge, 'calculator'),
                        top: inchesToDisplay(rightEdge, 'calculator')
                    });
                    currentPos += thickness;
                }
                
                detailedEquation = `SHELF & DIVISION - With Shelves
Total Length: ${inchesToDisplay(totalLength, 'calculator')}
Shelves: ${numShelves} @ ${inchesToDisplay(thickness, 'calculator')} thick
Spaces: ${numSpaces} @ ${inchesToDisplay(spacing, 'calculator')} each

üìè Shelf Marking Guide:`;

                if (shelfInfo.length <= 8) {
                    shelfInfo.forEach(shelf => {
                        detailedEquation += `\nShelf ${shelf.number}: Bottom ${shelf.bottom} - Top ${shelf.top}`;
                    });
                } else {
                    // Show first 4, middle indicator, last 4
                    for (let i = 0; i < 4; i++) {
                        const shelf = shelfInfo[i];
                        detailedEquation += `\nShelf ${shelf.number}: Bottom ${shelf.bottom} - Top ${shelf.top}`;
                    }
                    detailedEquation += `\n... ${shelfInfo.length - 8} more shelves ...`;
                    for (let i = shelfInfo.length - 4; i < shelfInfo.length; i++) {
                        const shelf = shelfInfo[i];
                        detailedEquation += `\nShelf ${shelf.number}: Bottom ${shelf.bottom} - Top ${shelf.top}`;
                    }
                }
            }
            
        }
        
        function saveSpacingToProject() {
            const totalLength = getInputInches('spTotalLengthFeet', 'spTotalLengthInches', 'spTotalLengthFraction');
            const numShelves = parseInt(document.getElementById('spNumShelves').value) || 0;
            const thickness = getInputInches('spacingThicknessFeet', 'spacingThicknessInches', 'spacingThicknessFraction');
            
            if (totalLength === 0 || numShelves === 0) {
                showNotification('Enter dimensions first', 'warning');
                return;
            }
            
            // Convert shelves to spaces: N shelves = N+1 spaces
            const numSpaces = numShelves + 1;
            let spacing, equation, details;
            
            if (thickness === 0) {
                // CENTER MARKS MODE - No material thickness
                spacing = totalLength / numSpaces;
                const centerMarks = Array.from({length: numShelves}, (_, i) => inchesToDisplay((i + 1) * spacing, 'calculator'));
                
                equation = `${numShelves} shelves in ${inchesToDisplay(totalLength)} = ${inchesToDisplay(spacing)} spacing`;
                details = `Total Length: ${inchesToDisplay(totalLength)}\nShelves: ${numShelves} shelves (${numSpaces} spaces)\nSpace Size: ${inchesToDisplay(spacing)} each\nMode: Center marks (no material thickness)`;
                
                if (centerMarks.length <= 5) {
                    details += '\n\nShelf center marks:\n' + centerMarks.map((mark, i) => `Shelf ${i + 1}: ${mark}`).join('\n');
                }
                
            } else {
                // SHELF MODE - With material thickness
                const totalThickness = numShelves * thickness;
                const availableSpace = totalLength - totalThickness;
                spacing = availableSpace / numSpaces;
                
                equation = `${numShelves} shelves (${inchesToDisplay(thickness)} thick) in ${inchesToDisplay(totalLength)} = ${inchesToDisplay(spacing)} spacing`;
                details = `Total Length: ${inchesToDisplay(totalLength)}\nShelves: ${numShelves} √ó ${inchesToDisplay(thickness)} thick\nTotal Material: ${inchesToDisplay(totalThickness)}\nAvailable Space: ${inchesToDisplay(availableSpace)}\nSpacing: ${inchesToDisplay(spacing)} each`;
            }
            
            // Create enhanced preview for timeline display
            const previewContent = `
                <div class="save-preview-spacing">
                    <div class="preview-header">
                        <strong>üìê Shelf & Division Calculator</strong>
                    </div>
                    <div class="preview-equation">
                        ${equation}
                    </div>
                    <div class="preview-result">
                        <strong>${inchesToDisplay(spacing)} spacing between ${numShelves} shelves</strong>
                    </div>
                    ${thickness === 0 ? 
                        // Center marks mode - show the marks clearly
                        `<div class="preview-marks">
                            <div class="marks-header">üìç Center Mark Positions:</div>
                            ${Array.from({length: Math.min(numShelves, 8)}, (_, i) => 
                                `<div class="mark-item">Shelf ${i + 1}: ${inchesToDisplay((i + 1) * spacing, 'calculator')}</div>`
                            ).join('')}
                            ${numShelves > 8 ? '<div class="mark-item">... and more</div>' : ''}
                        </div>` :
                        // Shelf mode - show detailed spacing info
                        `<div class="preview-summary">
                            Total Material: ${inchesToDisplay(numShelves * thickness)} ‚Ä¢ Available Space: ${inchesToDisplay(totalLength - numShelves * thickness)}
                        </div>
                        <div class="preview-spacing-details">
                            <div class="spacing-header">üìè Spacing Details:</div>
                            <div class="spacing-item">Space Size: ${inchesToDisplay(spacing)} each</div>
                            <div class="spacing-item">Number of Spaces: ${numSpaces} (between and around ${numShelves} shelves)</div>
                            ${numShelves <= 6 ? 
                                `<div class="spacing-positions">
                                    <div class="positions-header">Shelf Positions:</div>
                                    ${Array.from({length: numShelves}, (_, i) => {
                                        const shelfPosition = spacing + (i * (spacing + thickness));
                                        return `<div class="position-item">Shelf ${i + 1}: ${inchesToDisplay(shelfPosition)} to ${inchesToDisplay(shelfPosition + thickness)}</div>`;
                                    }).join('')}
                                </div>` : 
                                `<div class="spacing-item">Shelf positions available for ${numShelves} shelves</div>`
                            }
                        </div>`
                    }
                </div>
            `;
            
            const saveData = {
                tool: 'spacing',
                toolName: 'Shelf & Division Calculator',
                equation: equation,
                result: `${inchesToDisplay(spacing)} spacing between ${numShelves} shelves`,
                details: {
                    totalLength: totalLength,
                    numShelves: numShelves,
                    thickness: thickness,
                    spacing: spacing,
                    mode: thickness === 0 ? 'center-marks' : 'shelf-spacing',
                    marks: thickness === 0 ? Array.from({length: numShelves}, (_, i) => ({
                        shelf: i + 1,
                        position: (i + 1) * spacing,
                        display: inchesToDisplay((i + 1) * spacing, 'calculator')
                    })) : null,
                    shelfPositions: thickness > 0 ? Array.from({length: numShelves}, (_, i) => {
                        const startPos = spacing + (i * (spacing + thickness));
                        const endPos = startPos + thickness;
                        return {
                            shelf: i + 1,
                            startPosition: startPos,
                            endPosition: endPos,
                            startDisplay: inchesToDisplay(startPos, 'calculator'),
                            endDisplay: inchesToDisplay(endPos, 'calculator')
                        };
                    }) : null,
                    fullDetails: details
                },
                preview: previewContent
            };
            
            showSaveToProjectModal(saveData);
        }

        function saveCutToProject(index) {
            if (!currentCutResults || currentCutResults.length === 0 || index >= currentCutResults.length) {
                showNotification('No cut result to save', 'warning');
                return;
            }
            
            const cutData = currentCutResults[index];
            const cutMarks = cutData.results;
            
            const equation = `Cut ${cutData.originalLength} into ${cutData.pieces} equal pieces${cutData.kerfNote}${cutData.cutSideNote}`;
            const result = `${cutData.pieces} pieces @ ${cutData.pieceLength} each`;
            
            let details = `Original Length: ${cutData.originalLength}\nPieces: ${cutData.pieces}\nPiece Length: ${cutData.pieceLength}${cutData.kerfNote}${cutData.cutSideNote}`;
            
            if (cutMarks.length > 0) {
                details += '\n\nCut marks:';
                cutMarks.forEach((mark, i) => {
                    details += `\nMark ${i + 1}: ${mark.display}`;
                });
            }
            
            const previewContent = `
                <div class="save-preview-cut">
                    <div class="preview-header">
                        <strong>‚úÇÔ∏è Cut Calculator</strong>
                    </div>
                    <div class="preview-equation">
                        ${equation}
                    </div>
                    <div class="preview-result">
                        <strong>${result}</strong>
                    </div>
                    <div class="preview-details">
                        ${details.replace(/\n/g, '<br>')}
                    </div>
                </div>
            `;
            
            const saveData = {
                tool: 'cut',
                equation: equation,
                result: result,
                details: {
                    originalLength: cutData.originalLength,
                    pieces: cutData.pieces,
                    pieceLength: cutData.pieceLength,
                    cutMarks: cutMarks,
                    kerfNote: cutData.kerfNote,
                    cutSideNote: cutData.cutSideNote
                },
                preview: previewContent
            };
            
            showSaveToProjectModal(saveData);
        }

        function saveOptimizationToProject() {
            if (!window.currentOptimizationResults || window.currentOptimizationResults.length === 0) {
                showNotification('No optimization results to save', 'warning');
                return;
            }
            
            const results = window.currentOptimizationResults;
            const kerfEnabled = window.currentKerfEnabled;
            const kerfNote = kerfEnabled ? ' (with kerf)' : ' (no kerf)';
            
            // Calculate summary data
            const totalBoards = results.length;
            const totalWaste = results.reduce((sum, result) => sum + result.waste, 0);
            const completedCuts = results.reduce((sum, result) => sum + result.cuts.length, 0);
            
            const equation = `Waste Optimization: ${totalBoards} boards used${kerfNote}`;
            const result = `${completedCuts} cuts completed, ${inchesToDisplay(totalWaste, 'optimizer')} total waste`;
            
            // Build detailed information
            let details = `Optimization Results${kerfNote}:\n`;
            details += `Boards Used: ${totalBoards}\n`;
            details += `Cuts Completed: ${completedCuts}\n`;
            details += `Total Waste: ${inchesToDisplay(totalWaste, 'optimizer')}\n\n`;
            details += `Cutting Plan:\n`;
            
            results.forEach((board, index) => {
                details += `${board.boardDisplay}:\n`;
                details += `  Cuts: ${board.cuts.map(cut => inchesToDisplay(cut, 'optimizer')).join(', ')}\n`;
                details += `  Waste: ${inchesToDisplay(board.waste, 'optimizer')}\n`;
            });
            
            // Create preview content
            const previewContent = `
                <div class="save-preview-optimization">
                    <div class="preview-header">
                        <strong>üîß Cut Optimization</strong>
                    </div>
                    <div class="preview-equation">
                        ${equation}
                    </div>
                    <div class="preview-result">
                        <strong>${result}</strong>
                    </div>
                    <div class="preview-summary">
                        ${totalBoards} boards used ‚Ä¢ ${completedCuts} cuts completed ‚Ä¢ ${inchesToDisplay(totalWaste, 'optimizer')} waste
                    </div>
                    <div class="preview-details">
                        ${details.replace(/\n/g, '<br>').substring(0, 300)}${details.length > 300 ? '...' : ''}
                    </div>
                </div>
            `;
            
            const saveData = {
                tool: 'optimizer',
                equation: equation,
                result: result,
                details: {
                    totalBoards: totalBoards,
                    completedCuts: completedCuts,
                    totalWaste: totalWaste,
                    kerfEnabled: kerfEnabled,
                    cuttingPlan: results,
                    fullDetails: details
                },
                preview: previewContent
            };
            
            showSaveToProjectModal(saveData);
        }

        // Initialize app - load saved data and set up project management
        // Screw Calculator Functions
        function initScrewCalculator() {
            console.log('Initializing Screw Calculator...');
            
            // Add event listeners for visual size circles
            const sizeCircles = document.querySelectorAll('.size-circle');
            console.log('Found', sizeCircles.length, 'size circles');
            
            sizeCircles.forEach(circle => {
                circle.addEventListener('click', function(e) {
                    console.log('Size circle clicked:', this.dataset.size, this.dataset.name);
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Clear other selections
                    document.querySelectorAll('.size-circle').forEach(c => c.classList.remove('selected'));
                    // Select this one
                    this.classList.add('selected');
                    
                    const size = parseFloat(this.dataset.size);
                    const name = this.dataset.name;
                    
                    console.log('Parsed values:', size, name);
                    showSelectedScrew(name, size);
                });
            });
            
            // Add event listener for manual measurement input
            const manualInput = document.getElementById('screwDiameter');
            if (manualInput) {
                manualInput.addEventListener('input', calculateFromMeasurement);
            }
        }
        
        // Screw calculator helper functions
        function setScrewIdMode(mode) {
            console.log('Setting screw ID mode to:', mode);
            // Update tab appearance
            document.querySelectorAll('.id-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(mode + 'IdTab').classList.add('active');
            
            // Show/hide content sections
            document.querySelectorAll('.id-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(mode + 'IdContent').style.display = 'block';
        }
        
        function selectCommonScrew(size, type) {
            console.log('Selecting common screw:', size, type);
            // Clear other selections
            document.querySelectorAll('.common-screw-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
            
            // Convert size to decimal
            const sizeMap = {
                '#2': 0.086,
                '#3': 0.099,
                '#4': 0.112,
                '#5': 0.125,
                '#6': 0.138,
                '#7': 0.151,
                '#8': 0.164,
                '#9': 0.177,
                '#10': 0.190,
                '#11': 0.203,
                '#12': 0.216,
                '#14': 0.242,
                '1/4': 0.25,
                '5/16': 0.3125,
                '3/8': 0.375,
                '3/8lag': 0.375,
                '7/16lag': 0.4375,
                '1/2lag': 0.5,
                '5/8lag': 0.625,
                '3/4lag': 0.75,
                'pocket': 0.15 // Typical pocket screw size
            };
            
            const decimalSize = sizeMap[size] || 0.15;
            const displayName = size.includes('lag') ? size.replace('lag', ' Lag Bolt') : size;
            showSelectedScrew(displayName, decimalSize);
        }
        
        function toggleMeasurementUnit() {
            const isMetric = document.querySelector('input[name="unit"]:checked').value === 'mm';
            const input = document.getElementById('screwDiameter');
            const label = document.getElementById('unitLabel');
            
            if (isMetric) {
                input.placeholder = '4.2';
                input.min = '1';
                input.max = '12';
                input.step = '0.1';
                label.textContent = 'mm';
            } else {
                input.placeholder = '0.164';
                input.min = '0.05';
                input.max = '0.5';
                input.step = '0.01';
                label.textContent = 'inches';
            }
            
            // Recalculate if there's a value
            if (input.value) {
                calculateFromMeasurement();
            }
        }
        
        function calculateFromMeasurement() {
            const input = document.getElementById('screwDiameter');
            let diameter = parseFloat(input.value);
            const unitRadio = document.querySelector('input[name="unit"]:checked');
            const isMetric = unitRadio ? unitRadio.value === 'mm' : false;
            
            console.log('Calculating from measurement:', diameter, isMetric ? 'mm' : 'inches');
            
            if (diameter && diameter > 0) {
                // Convert mm to inches if needed
                if (isMetric) {
                    diameter = diameter / 25.4;
                }
                
                const displayName = isMetric ? 
                    `${(diameter * 25.4).toFixed(1)}mm` : 
                    `${diameter} inch`;
                    
                showSelectedScrew(displayName, diameter);
            }
        }
        
        function showSelectedScrew(displayName, size) {
            console.log('Showing selected screw:', displayName, size);
            // Show selected screw info
            const display = document.getElementById('selectedScrewDisplay');
            const typeSpan = document.getElementById('selectedScrewType');
            const specs = document.getElementById('screwSpecs');
            
            if (display && typeSpan && specs) {
                typeSpan.textContent = displayName;
                specs.innerHTML = `Diameter: ${size}" | ${(size * 25.4).toFixed(1)}mm`;
                display.style.display = 'block';
                
                // Show wood selection
                const woodSelection = document.getElementById('woodSelection');
                if (woodSelection) {
                    woodSelection.style.display = 'block';
                }
                
                // Store current screw for calculation
                window.currentScrewSize = size;
                window.currentScrewType = displayName;
                console.log('DEBUG: Screw selected - Size:', size, 'Type:', displayName);
            }
        }
        
        function selectWoodType(woodType) {
            console.log('Selecting wood type:', woodType);
            console.log('Current screw size:', window.currentScrewSize);
            
            // Clear other selections
            document.querySelectorAll('.wood-btn').forEach(btn => btn.classList.remove('selected'));
            const selectedBtn = document.getElementById(woodType + 'Btn');
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
                console.log('Wood type button selected successfully');
            } else {
                console.error('Wood type button not found:', woodType + 'Btn');
                return;
            }
            
            // Store wood type selection
            window.currentWoodType = woodType;
            console.log('DEBUG: Wood type selected:', woodType);
            
            // Calculate pilot hole
            if (window.currentScrewSize) {
                console.log('Calling calculatePilotHole with:', window.currentScrewSize, woodType);
                calculatePilotHole(window.currentScrewSize, woodType);
            } else {
                console.error('No screw size selected - currentScrewSize is:', window.currentScrewSize);
            }
        }
        
        function saveScrewToProject() {
            if (!window.currentScrewType || !window.currentWoodType || !window.currentPilotHoleSize) {
                showNotification('Calculate pilot hole first', 'warning');
                return;
            }
            
            const equation = `${window.currentScrewType} screw in ${window.currentWoodType}`;
            const details = `Screw: ${window.currentScrewType}\nWood Type: ${window.currentWoodType}\nPilot Hole: ${window.currentPilotHoleSize}`;
            
            const previewContent = `
                <div class="preview-equation">
                    ${window.currentScrewType} ‚Üí ${window.currentPilotHoleSize} pilot hole
                </div>
                <div class="preview-result">
                    <strong>Pilot hole: ${window.currentPilotHoleSize} for ${window.currentWoodType}</strong>
                </div>
                <div class="preview-details">
                    Screw: ${window.currentScrewType} ‚Ä¢ Pilot Hole: ${window.currentPilotHoleSize}
                </div>
            `;
            
            showSaveToProjectModal('Screw & Pilot Hole Calculation', {
                tool: 'Screw & Pilot Hole Calculator',
                equation: equation,
                result: `${window.currentPilotHoleSize} pilot hole for ${window.currentScrewType} in ${window.currentWoodType}`,
                details: details,
                preview: previewContent
            });
        }

        // =====================================================
        // Grade/Slope Calculator Functions
        // =====================================================
        
        let gradeMode = 'find-grade'; // Current calculation mode
        
        function setGradeMode(mode) {
            gradeMode = mode;
            
            // Update button states
            document.querySelectorAll('#gradeCard .calc-mode-selector .mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('gradeMode' + mode.split('-')[1].charAt(0).toUpperCase() + mode.split('-')[1].slice(1)).classList.add('active');
            
            // Show/hide inputs based on mode
            const riseInput = document.getElementById('gradeRiseInput');
            const runInput = document.getElementById('gradeRunInput');
            const percentInput = document.getElementById('gradePercentInput');
            
            if (mode === 'find-grade') {
                riseInput.style.display = 'flex';
                runInput.style.display = 'flex';
                percentInput.style.display = 'none';
            } else if (mode === 'find-rise') {
                riseInput.style.display = 'none';
                runInput.style.display = 'flex';
                percentInput.style.display = 'flex';
            } else if (mode === 'find-run') {
                riseInput.style.display = 'flex';
                runInput.style.display = 'none';
                percentInput.style.display = 'flex';
            }
            
            calculateGradeSlope();
        }
        
        function calculateGradeSlope() {
            let rise = 0, run = 0, percent = 0;
            
            // Get Rise value (in inches)
            const riseFeet = parseFloat(document.getElementById('gradeRiseFeet').value) || 0;
            const riseInches = parseFloat(document.getElementById('gradeRiseInches').value) || 0;
            const riseFraction = parseFloat(document.getElementById('gradeRiseFraction').value) || 0;
            rise = (riseFeet * 12) + riseInches + riseFraction;
            
            // Get Run value (in inches)
            const runFeet = parseFloat(document.getElementById('gradeRunFeet').value) || 0;
            const runInches = parseFloat(document.getElementById('gradeRunInches').value) || 0;
            const runFraction = parseFloat(document.getElementById('gradeRunFraction').value) || 0;
            run = (runFeet * 12) + runInches + runFraction;
            
            // Get Percentage value
            percent = parseFloat(document.getElementById('gradePercent').value) || 0;
            
            let calculatedRise, calculatedRun, calculatedPercent, angle, ratio;
            
            if (gradeMode === 'find-grade') {
                if (rise > 0 && run > 0) {
                    calculatedPercent = (rise / run) * 100;
                    angle = Math.atan(rise / run) * (180 / Math.PI);
                    ratio = `1:${(run / rise).toFixed(2)}`;
                    displayGradeResults(rise, run, calculatedPercent, angle, ratio);
                    updateSlopeVisual(rise, run, calculatedPercent, angle);
                } else {
                    hideGradeResults();
                }
            } else if (gradeMode === 'find-rise') {
                if (run > 0 && percent > 0) {
                    calculatedRise = (run * percent) / 100;
                    angle = Math.atan(calculatedRise / run) * (180 / Math.PI);
                    ratio = `1:${(run / calculatedRise).toFixed(2)}`;
                    displayGradeResults(calculatedRise, run, percent, angle, ratio);
                    updateSlopeVisual(calculatedRise, run, percent, angle);
                } else {
                    hideGradeResults();
                }
            } else if (gradeMode === 'find-run') {
                if (rise > 0 && percent > 0) {
                    calculatedRun = (rise * 100) / percent;
                    angle = Math.atan(rise / calculatedRun) * (180 / Math.PI);
                    ratio = `1:${(calculatedRun / rise).toFixed(2)}`;
                    displayGradeResults(rise, calculatedRun, percent, angle, ratio);
                    updateSlopeVisual(rise, calculatedRun, percent, angle);
                } else {
                    hideGradeResults();
                }
            }
        }
        
        function displayGradeResults(rise, run, percent, angle, ratio) {
            const resultsDiv = document.getElementById('gradeResults');
            const resultDisplay = document.getElementById('gradeResultDisplay');
            
            // Convert values back to feet/inches for display
            const riseDisplay = inchesToDisplay(rise);
            const runDisplay = inchesToDisplay(run);
            
            // Determine compliance color coding
            let complianceColor = '#333';
            let complianceText = '';
            
            if (percent <= 5) {
                complianceColor = '#228B22';
                complianceText = '‚úÖ ADA Compliant (Preferred)';
            } else if (percent <= 8.33) {
                complianceColor = '#FFA500';
                complianceText = '‚ö†Ô∏è ADA Max Compliance';
            } else if (percent <= 15) {
                complianceColor = '#FF6347';
                complianceText = '‚ö° Steep (Check local codes)';
            } else {
                complianceColor = '#DC143C';
                complianceText = 'üö® Very Steep (May not be allowed)';
            }
            
            let html = `
                <div class="grade-result-summary" style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 10px;">
                        <div>
                            <strong>Grade:</strong> <span style="font-size: 18px; color: var(--primary-color);">${percent.toFixed(2)}%</span>
                        </div>
                        <div>
                            <strong>Angle:</strong> <span style="font-size: 18px; color: var(--primary-color);">${angle.toFixed(2)}¬∞</span>
                        </div>
                        <div>
                            <strong>Ratio:</strong> <span style="font-size: 16px; color: #666;">${ratio}</span>
                        </div>
                        <div>
                            <strong>Rise:Run:</strong> <span style="font-size: 16px; color: #666;">${(rise/12).toFixed(2)}:${(run/12).toFixed(2)}</span>
                        </div>
                    </div>
                    <div style="text-align: center; font-weight: bold; color: ${complianceColor};">
                        ${complianceText}
                    </div>
                </div>
                
                <div class="grade-detailed-results">
                    <h5 style="margin-bottom: 10px; color: var(--primary-color);">Detailed Measurements:</h5>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                        <div><strong>Rise (Vertical):</strong> ${riseDisplay}</div>
                        <div><strong>Run (Horizontal):</strong> ${runDisplay}</div>
                    </div>
                </div>
            `;
            
            if (gradeMode === 'find-rise') {
                html += `
                    <div class="calculated-value" style="margin-top: 15px; padding: 10px; background: #e8f5e8; border-radius: 5px;">
                        <strong>üìè Calculated Rise:</strong> ${riseDisplay}
                    </div>
                `;
            } else if (gradeMode === 'find-run') {
                html += `
                    <div class="calculated-value" style="margin-top: 15px; padding: 10px; background: #e8f5e8; border-radius: 5px;">
                        <strong>üìè Calculated Run:</strong> ${runDisplay}
                    </div>
                `;
            }
            
            // Save calculation data for project saving
            window.currentGradeCalculation = {
                mode: gradeMode,
                rise: rise,
                run: run,
                percent: percent,
                angle: angle,
                ratio: ratio,
                riseDisplay: riseDisplay,
                runDisplay: runDisplay,
                timestamp: new Date().toISOString()
            };
            
            resultDisplay.innerHTML = html;
            resultsDiv.style.display = 'block';
        }
        
        function hideGradeResults() {
            document.getElementById('gradeResults').style.display = 'none';
            
            // Reset visual display
            document.getElementById('gradePercentLabel').textContent = 'Grade: --';
            document.getElementById('ratioLabel').textContent = 'Ratio: --';
            document.getElementById('angleLabel').textContent = 'Angle';
        }
        
        function updateSlopeVisual(rise, run, percent, angle) {
            // Update the SVG visual representation
            const svg = document.getElementById('slopeDiagram');
            const triangle = document.getElementById('slopeTriangle');
            const angleArc = document.getElementById('angleArc');
            const gradeLabel = document.getElementById('gradePercentLabel');
            const ratioLabel = document.getElementById('ratioLabel');
            const angleLabel = document.getElementById('angleLabel');
            
            // Calculate proportional dimensions for visual (keeping within SVG bounds)
            const maxWidth = 250; // Available width for run
            const maxHeight = 100; // Available height for rise
            
            let visualRun = maxWidth;
            let visualRise = (rise / run) * maxWidth;
            
            // If rise is too tall, scale both proportionally
            if (visualRise > maxHeight) {
                const scale = maxHeight / visualRise;
                visualRise = maxHeight;
                visualRun = visualRun * scale;
            }
            
            // Update triangle path
            const startX = 50;
            const startY = 170;
            const endX = startX + visualRun;
            const topY = startY - visualRise;
            
            triangle.setAttribute('d', `M ${startX} ${startY} L ${endX} ${startY} L ${endX} ${topY} Z`);
            
            // Update rise line
            svg.querySelector('line[stroke="#D2691E"]').setAttribute('x1', endX);
            svg.querySelector('line[stroke="#D2691E"]').setAttribute('y1', startY);
            svg.querySelector('line[stroke="#D2691E"]').setAttribute('x2', endX);
            svg.querySelector('line[stroke="#D2691E"]').setAttribute('y2', topY);
            
            // Update run line
            svg.querySelector('line[stroke="#228B22"]').setAttribute('x1', startX);
            svg.querySelector('line[stroke="#228B22"]').setAttribute('x2', endX);
            
            // Update angle arc (simplified)
            const arcRadius = Math.min(50, visualRun / 3);
            const arcEndX = startX + arcRadius * Math.cos(angle * Math.PI / 180);
            const arcEndY = startY - arcRadius * Math.sin(angle * Math.PI / 180);
            angleArc.setAttribute('d', `M ${startX + arcRadius} ${startY} A ${arcRadius} ${arcRadius} 0 0 0 ${arcEndX} ${arcEndY}`);
            
            // Update labels
            gradeLabel.textContent = `Grade: ${percent.toFixed(2)}%`;
            ratioLabel.textContent = `Ratio: 1:${(run/rise).toFixed(2)}`;
            angleLabel.textContent = `${angle.toFixed(1)}¬∞`;
            
            // Position angle label
            const labelX = startX + (arcRadius * 1.5);
            const labelY = startY - (arcRadius * 0.3);
            angleLabel.setAttribute('x', labelX);
            angleLabel.setAttribute('y', labelY);
        }
        
        function setGradePreset(presetType, description) {
            // Clear existing values
            document.getElementById('gradeRiseFeet').value = '';
            document.getElementById('gradeRiseInches').value = '';
            document.getElementById('gradeRiseFraction').value = '0';
            document.getElementById('gradeRunFeet').value = '';
            document.getElementById('gradeRunInches').value = '';
            document.getElementById('gradeRunFraction').value = '0';
            document.getElementById('gradePercent').value = '';
            
            // Set to find-grade mode for most presets
            setGradeMode('find-grade');
            
            switch(presetType) {
                case 'ada-max':
                    // 1:12 ratio - 1 inch rise for every 12 inches run
                    document.getElementById('gradeRiseInches').value = '1';
                    document.getElementById('gradeRunFeet').value = '1';
                    break;
                case 'ada-preferred':
                    // 1:20 ratio - 1 inch rise for every 20 inches run
                    document.getElementById('gradeRiseInches').value = '1';
                    document.getElementById('gradeRunInches').value = '20';
                    break;
                case 'drainage-min':
                    // 1% grade - 1 inch rise per 100 inches run
                    document.getElementById('gradeRiseInches').value = '1';
                    document.getElementById('gradeRunFeet').value = '8';
                    document.getElementById('gradeRunInches').value = '4';
                    break;
                case 'drainage-ideal':
                    // 2% grade - 2 inches rise per 100 inches run
                    document.getElementById('gradeRiseInches').value = '2';
                    document.getElementById('gradeRunFeet').value = '8';
                    document.getElementById('gradeRunInches').value = '4';
                    break;
                case 'driveway-max':
                    // 15% grade - 15 inches rise per 100 inches run
                    document.getElementById('gradeRiseInches').value = '15';
                    document.getElementById('gradeRunFeet').value = '8';
                    document.getElementById('gradeRunInches').value = '4';
                    break;
                case 'shed-ramp':
                    // 10% grade - 10 inches rise per 100 inches run
                    document.getElementById('gradeRiseInches').value = '10';
                    document.getElementById('gradeRunFeet').value = '8';
                    document.getElementById('gradeRunInches').value = '4';
                    break;
                case 'stairs-typical':
                    // 35¬∞ angle, approximately 70% grade
                    document.getElementById('gradeRiseInches').value = '7';
                    document.getElementById('gradeRunInches').value = '10';
                    break;
                case 'roof-min':
                    // 4:12 roof pitch - 4 inches rise per 12 inches run
                    document.getElementById('gradeRiseInches').value = '4';
                    document.getElementById('gradeRunFeet').value = '1';
                    break;
            }
            
            calculateGradeSlope();
            showNotification(`Applied preset: ${description}`, 'success');
        }
        
        function saveGradeToProject() {
            if (!window.currentGradeCalculation) {
                showNotification('No calculation to save', 'error');
                return;
            }
            
            const calc = window.currentGradeCalculation;
            
            // Create preview content
            let previewContent = `
                <div class="save-preview-spacing">
                    <div class="preview-header">Grade/Slope Calculation</div>
                    <div class="preview-equation">Mode: ${calc.mode.replace('find-', 'Calculate ').replace('grade', 'Grade %').replace('rise', 'Rise').replace('run', 'Run')}</div>
                    <div class="preview-result">
                        Grade: ${calc.percent.toFixed(2)}% | Angle: ${calc.angle.toFixed(2)}¬∞ | Ratio: ${calc.ratio}
                    </div>
                    <div class="preview-summary">
                        Rise: ${calc.riseDisplay} | Run: ${calc.runDisplay}
                    </div>
                </div>
            `;
            
            // Determine equation based on mode
            let equation = '';
            if (calc.mode === 'find-grade') {
                equation = `${calc.riseDisplay} rise √∑ ${calc.runDisplay} run = ${calc.percent.toFixed(2)}%`;
            } else if (calc.mode === 'find-rise') {
                equation = `${calc.runDisplay} run √ó ${calc.percent.toFixed(2)}% = ${calc.riseDisplay} rise`;
            } else if (calc.mode === 'find-run') {
                equation = `${calc.riseDisplay} rise √∑ ${calc.percent.toFixed(2)}% = ${calc.runDisplay} run`;
            }
            
            // Determine compliance status
            let complianceText = '';
            if (calc.percent <= 5) {
                complianceText = 'ADA Compliant (Preferred)';
            } else if (calc.percent <= 8.33) {
                complianceText = 'ADA Max Compliance';
            } else if (calc.percent <= 15) {
                complianceText = 'Steep (Check local codes)';
            } else {
                complianceText = 'Very Steep (May not be allowed)';
            }
            
            const saveData = {
                toolName: 'Grade/Slope Calculator',
                type: 'Grade/Slope Calculator',
                summary: `${calc.percent.toFixed(2)}% grade (${calc.angle.toFixed(1)}¬∞) - ${complianceText}`,
                equation: equation,
                result: `${calc.percent.toFixed(2)}% grade, ${calc.angle.toFixed(2)}¬∞ angle, ${calc.ratio} ratio`,
                details: `Mode: ${calc.mode.replace('find-', 'Calculate ').replace('grade', 'Grade %').replace('rise', 'Rise').replace('run', 'Run')}\nRise: ${calc.riseDisplay}\nRun: ${calc.runDisplay}\nGrade: ${calc.percent.toFixed(2)}%\nAngle: ${calc.angle.toFixed(2)}¬∞\nRatio: ${calc.ratio}\nCompliance: ${complianceText}`,
                preview: previewContent
            };
            
            showSaveToProjectModal(saveData);
        }
        
        function toggleQuickReference() {
            const tableDiv = document.getElementById('quickReferenceTable');
            const isHidden = tableDiv.style.display === 'none';
            
            if (isHidden) {
                // Populate table if not already done
                populateReferenceTable();
                tableDiv.style.display = 'block';
            } else {
                tableDiv.style.display = 'none';
            }
        }
        
        function populateReferenceTable() {
            const tbody = document.getElementById('referenceTableBody');
            
            // Check if already populated
            if (tbody.children.length > 0) return;
            
            // Define all screw sizes and their pilot holes
            const screwData = [
                // Standard wood screws
                { size: '#2', diameter: '0.086"', hardwood: '1/16"', softwood: '3/64"', plywood: '3/64"' },
                { size: '#3', diameter: '0.099"', hardwood: '1/16"', softwood: '1/16"', plywood: '3/64"' },
                { size: '#4', diameter: '0.112"', hardwood: '5/64"', softwood: '1/16"', plywood: '1/16"' },
                { size: '#5', diameter: '0.125"', hardwood: '5/64"', softwood: '1/16"', plywood: '1/16"' },
                { size: '#6', diameter: '0.138"', hardwood: '3/32"', softwood: '5/64"', plywood: '5/64"' },
                { size: '#7', diameter: '0.151"', hardwood: '3/32"', softwood: '5/64"', plywood: '5/64"' },
                { size: '#8', diameter: '0.164"', hardwood: '7/64"', softwood: '3/32"', plywood: '3/32"' },
                { size: '#9', diameter: '0.177"', hardwood: '1/8"', softwood: '3/32"', plywood: '3/32"' },
                { size: '#10', diameter: '0.190"', hardwood: '1/8"', softwood: '7/64"', plywood: '7/64"' },
                { size: '#12', diameter: '0.216"', hardwood: '9/64"', softwood: '1/8"', plywood: '1/8"' },
                { size: '#14', diameter: '0.242"', hardwood: '5/32"', softwood: '9/64"', plywood: '9/64"' },
                { size: '#16', diameter: '0.268"', hardwood: '3/16"', softwood: '5/32"', plywood: '5/32"' },
                { size: '#18', diameter: '0.294"', hardwood: '13/64"', softwood: '3/16"', plywood: '3/16"' },
                { size: '#20', diameter: '0.320"', hardwood: '7/32"', softwood: '13/64"', plywood: '13/64"' },
                // Fractional sizes
                { size: '1/4"', diameter: '0.250"', hardwood: '11/64"', softwood: '5/32"', plywood: '5/32"' },
                { size: '5/16"', diameter: '0.313"', hardwood: '7/32"', softwood: '3/16"', plywood: '3/16"' },
                { size: '3/8"', diameter: '0.375"', hardwood: '1/4"', softwood: '7/32"', plywood: '7/32"' },
                { size: '7/16"', diameter: '0.438"', hardwood: '5/16"', softwood: '9/32"', plywood: '9/32"' },
                // Lag bolts
                { size: '1/4" Lag', diameter: '0.250"', hardwood: '3/16"', softwood: '5/32"', plywood: '5/32"', isLag: true },
                { size: '5/16" Lag', diameter: '0.313"', hardwood: '1/4"', softwood: '13/64"', plywood: '13/64"', isLag: true },
                { size: '3/8" Lag', diameter: '0.375"', hardwood: '5/16"', softwood: '1/4"', plywood: '1/4"', isLag: true },
                { size: '1/2" Lag', diameter: '0.500"', hardwood: '3/8"', softwood: '5/16"', plywood: '5/16"', isLag: true },
                { size: '5/8" Lag', diameter: '0.625"', hardwood: '1/2"', softwood: '7/16"', plywood: '7/16"', isLag: true },
                { size: '3/4" Lag', diameter: '0.750"', hardwood: '5/8"', softwood: '1/2"', plywood: '1/2"', isLag: true }
            ];
            
            // Create table rows
            let html = '';
            let lastCategory = '';
            
            screwData.forEach(screw => {
                // Add category row
                const currentCategory = screw.isLag ? 'lag' : 'standard';
                if (currentCategory !== lastCategory) {
                    html += `<tr class="screw-category">
                        <td colspan="5">${screw.isLag ? 'Lag Bolts' : 'Standard Wood Screws'}</td>
                    </tr>`;
                    lastCategory = currentCategory;
                }
                
                // Add data row
                html += `<tr class="${screw.isLag ? 'lag-bolt' : ''}">
                    <td><strong>${screw.size}</strong></td>
                    <td>${screw.diameter}</td>
                    <td>${screw.hardwood}</td>
                    <td>${screw.softwood}</td>
                    <td>${screw.plywood}</td>
                </tr>`;
            });
            
            tbody.innerHTML = html;
        }
        
        function calculatePilotHole(screwSize, woodType) {
            console.log('calculatePilotHole called with:', screwSize, woodType);
            
            // Convert to numeric if string
            const size = typeof screwSize === 'string' ? parseFloat(screwSize) : screwSize;
            console.log('Converted size to:', size);
            
            // Use provided wood type or get from selector (fallback for old calls)
            if (!woodType) {
                console.error('No wood type provided to calculatePilotHole');
                return;
            }
            
            // Pilot hole calculation based on wood type and screw size
            let pilotHoleSize;
            let drillBitSize = '';
            
            // Adjust pilot hole size based on screw type and wood
            if (size >= 0.375) { // Lag bolts and large screws
                if (woodType === 'softwood') {
                    pilotHoleSize = size * 0.65; // 65% for large screws in softwood
                } else if (woodType === 'hardwood') {
                    pilotHoleSize = size * 0.75; // 75% for large screws in hardwood
                } else if (woodType === 'plywood') {
                    pilotHoleSize = size * 0.7; // 70% for large screws in plywood
                } else {
                    pilotHoleSize = size * 0.7;
                }
            } else { // Standard wood screws
                if (woodType === 'softwood') {
                    pilotHoleSize = size * 0.7; // 70% of screw diameter for softwood
                } else if (woodType === 'hardwood') {
                    pilotHoleSize = size * 0.8; // 80% of screw diameter for hardwood
                } else if (woodType === 'plywood') {
                    pilotHoleSize = size * 0.75; // 75% of screw diameter for plywood
                } else {
                    pilotHoleSize = size * 0.75;
                }
            }
            
            // Find closest standard drill bit (expanded range for lag bolts)
            const drillBits = [
                { size: 1/16, display: '1/16"' },
                { size: 5/64, display: '5/64"' },
                { size: 3/32, display: '3/32"' },
                { size: 7/64, display: '7/64"' },
                { size: 1/8, display: '1/8"' },
                { size: 9/64, display: '9/64"' },
                { size: 5/32, display: '5/32"' },
                { size: 11/64, display: '11/64"' },
                { size: 3/16, display: '3/16"' },
                { size: 13/64, display: '13/64"' },
                { size: 7/32, display: '7/32"' },
                { size: 15/64, display: '15/64"' },
                { size: 1/4, display: '1/4"' },
                { size: 17/64, display: '17/64"' },
                { size: 9/32, display: '9/32"' },
                { size: 19/64, display: '19/64"' },
                { size: 5/16, display: '5/16"' },
                { size: 21/64, display: '21/64"' },
                { size: 11/32, display: '11/32"' },
                { size: 23/64, display: '23/64"' },
                { size: 3/8, display: '3/8"' },
                { size: 25/64, display: '25/64"' },
                { size: 13/32, display: '13/32"' },
                { size: 27/64, display: '27/64"' },
                { size: 7/16, display: '7/16"' },
                { size: 29/64, display: '29/64"' },
                { size: 15/32, display: '15/32"' },
                { size: 31/64, display: '31/64"' },
                { size: 1/2, display: '1/2"' },
                { size: 33/64, display: '33/64"' },
                { size: 17/32, display: '17/32"' },
                { size: 35/64, display: '35/64"' },
                { size: 9/16, display: '9/16"' },
                { size: 37/64, display: '37/64"' },
                { size: 19/32, display: '19/32"' },
                { size: 39/64, display: '39/64"' },
                { size: 5/8, display: '5/8"' }
            ];
            
            // Find closest drill bit size
            let closest = drillBits[0];
            let minDiff = Math.abs(pilotHoleSize - closest.size);
            
            for (let bit of drillBits) {
                const diff = Math.abs(pilotHoleSize - bit.size);
                if (diff < minDiff) {
                    minDiff = diff;
                    closest = bit;
                }
            }
            
            drillBitSize = closest.display;
            
            // Store the calculated result globally for saving
            window.currentPilotHoleSize = drillBitSize;
            
            // Display results
            const resultsDiv = document.getElementById('screwResults');
            const resultDisplay = document.getElementById('screwResultDisplay');
            
            if (resultsDiv && resultDisplay) {
                // Determine display format for screw size
                let screwDisplay;
                if (size === 0.086) screwDisplay = '#2';
                else if (size === 0.099) screwDisplay = '#3';
                else if (size === 0.112) screwDisplay = '#4';
                else if (size === 0.125) screwDisplay = '#5';
                else if (size === 0.138) screwDisplay = '#6';
                else if (size === 0.151) screwDisplay = '#7';
                else if (size === 0.164) screwDisplay = '#8';
                else if (size === 0.177) screwDisplay = '#9';
                else if (size === 0.190) screwDisplay = '#10';
                else if (size === 0.203) screwDisplay = '#11';
                else if (size === 0.216) screwDisplay = '#12';
                else if (size === 0.242) screwDisplay = '#14';
                else if (size === 0.25) screwDisplay = '1/4"';
                else if (size === 0.3125) screwDisplay = '5/16"';
                else if (size === 0.375) screwDisplay = '3/8"';
                else if (size === 0.4375) screwDisplay = '7/16" Lag';
                else if (size === 0.5) screwDisplay = '1/2" Lag';
                else if (size === 0.625) screwDisplay = '5/8" Lag';
                else if (size === 0.75) screwDisplay = '3/4" Lag';
                else screwDisplay = `${size.toFixed(3)}"`;
                
                resultDisplay.innerHTML = `
                    <div class="result-card">
                        <h4>üìè Screw: ${screwDisplay} diameter</h4>
                        <h4>ü™µ Wood Type: ${woodType.charAt(0).toUpperCase() + woodType.slice(1)}</h4>
                        <div class="pilot-hole-result">
                            <h3>üî© Recommended Pilot Hole:</h3>
                            <div class="drill-bit-size">${drillBitSize}</div>
                            <p class="calculation-note">
                                Calculated: ${(pilotHoleSize * 64).toFixed(1)}/64" ‚âà ${drillBitSize}
                            </p>
                        </div>
                        <div class="drilling-tips">
                            <h4>üí° Drilling Tips:</h4>
                            <ul>
                                <li>Use a drill bit slightly smaller than calculated if unsure</li>
                                <li>Test on scrap wood first</li>
                                <li>Pre-drill slowly to avoid splitting</li>
                                <li>For ${woodType}: ${woodType === 'hardwood' ? 'Go slow, use cutting oil if needed' : woodType === 'softwood' ? 'Standard drilling speed works well' : woodType === 'plywood' ? 'Medium speed, watch for tear-out' : 'Use appropriate speed for material'}</li>
                            </ul>
                        </div>
                        <div style="text-align: center; margin-top: 20px;">
                            <button class="btn btn-success btn-sm" onclick="saveScrewToProject()">üìÅ Save to Project</button>
                        </div>
                    </div>
                `;
                
                // Show the results section
                resultsDiv.style.display = 'block';
                
                console.log('Results displayed successfully');
                
                // Save to project log if we have an active project
                if (currentProject) {
                    const logEntry = {
                        timestamp: new Date().toISOString(),
                        toolName: 'Screw Calculator',
                        type: 'Screw Calculator', // Keep for backward compatibility
                        summary: `Pilot hole for ${screwDisplay} screw in ${woodType}`,
                        details: `Screw: ${screwDisplay} diameter\nWood: ${woodType}\nPilot Hole: ${drillBitSize}\nCalculated: ${(pilotHoleSize * 64).toFixed(1)}/64"`
                    };
                    
                    currentProject.projectLog = currentProject.projectLog || [];
                    currentProject.projectLog.push(logEntry);
                    saveCurrentProject();
                    updateProjectSelector();
                }
            }
        }
        
        // =====================================================
        // Wood Species Database Functions
        // =====================================================
        
        const woodSpeciesData = [
            {
                name: "Ash",
                janka: 1320,
                density: 42,
                workability: 4,
                cost: "mid",
                color: "Light brown with pronounced grain",
                description: "Strong, flexible hardwood. Traditional choice for tool handles and sports equipment.",
                bestFor: ["furniture", "tool-handles", "sports-equipment", "cabinets"],
                avoidFor: ["cutting-boards", "outdoor"],
                specialNotes: "Excellent strength-to-weight ratio, very shock resistant",
                beginner: false,
                sustainability: "good",
                grainPattern: "linear-gradient(45deg, #d4a574 0%, #c89660 25%, #d4a574 50%, #c89660 75%, #d4a574 100%)",
                finishRecommendations: {
                    natural: ["Danish Oil", "Tung Oil", "Shellac"],
                    stain: ["Medium Brown", "Dark Walnut", "Honey Oak"],
                    notes: "Takes stain well but beautiful natural. Oil finishes enhance grain."
                },
                alternatives: ["Hard Maple", "Beech", "Hickory"]
            },
            {
                name: "Basswood",
                janka: 410,
                density: 26,
                workability: 5,
                cost: "budget",
                color: "Pale white to light brown",
                description: "Very soft hardwood, perfect for carving and beginners. Takes paint excellently.",
                bestFor: ["carving", "beginner", "painted-furniture", "turning"],
                avoidFor: ["outdoor", "cutting-boards", "heavy-duty"],
                specialNotes: "The ultimate wood for hand carving and woodburning",
                beginner: true,
                sustainability: "excellent",
                grainPattern: "linear-gradient(0deg, #f5f2eb 0%, #ebe4d5 100%)",
                finishRecommendations: {
                    natural: ["Water-based Poly", "Shellac"],
                    stain: ["Any stain - excellent uptake", "Paint - preferred"],
                    notes: "Perfect for paint. Minimal natural figure, accepts all finishes."
                },
                alternatives: ["Eastern White Pine", "Poplar", "Aspen"]
            },
            {
                name: "Beech",
                janka: 1300,
                density: 44,
                workability: 4,
                cost: "budget",
                color: "Light brown with fine grain",
                description: "Dense, strong hardwood with excellent working properties. European favorite.",
                bestFor: ["furniture", "cutting-boards", "tool-handles", "flooring"],
                avoidFor: ["outdoor"],
                specialNotes: "Excellent all-around wood, very stable and machinable",
                beginner: true,
                sustainability: "excellent",
                grainPattern: "linear-gradient(5deg, #e8d5c4 0%, #d4b896 40%, #e8d5c4 80%, #d4b896 100%)",
                finishRecommendations: {
                    natural: ["Danish Oil", "Lacquer", "Shellac"],
                    stain: ["Light Oak", "Medium Brown", "Cherry"],
                    notes: "Excellent all-around wood. Takes stain evenly, great for cutting boards."
                },
                alternatives: ["Hard Maple", "Birch", "Ash"]
            },
            {
                name: "Birch",
                janka: 1260,
                density: 43,
                workability: 4,
                cost: "mid",
                color: "Light yellow to cream",
                description: "Strong, versatile hardwood with fine grain. Popular for plywood and furniture.",
                bestFor: ["furniture", "cabinets", "plywood", "turning"],
                avoidFor: ["outdoor"],
                specialNotes: "Excellent for staining, takes finishes beautifully",
                beginner: true,
                sustainability: "excellent",
                grainPattern: "linear-gradient(10deg, #f2ebdc 0%, #e8d5c4 30%, #f2ebdc 70%, #e8d5c4 100%)",
                finishRecommendations: {
                    natural: ["Lacquer", "Shellac", "Water-based Poly"],
                    stain: ["Cherry", "Golden Oak", "Dark Walnut"],
                    notes: "Excellent stain uptake, often used to mimic cherry."
                },
                alternatives: ["Hard Maple", "Beech", "Ash"]
            },
            {
                name: "Black Walnut",
                janka: 1010,
                density: 38,
                workability: 5,
                cost: "premium",
                color: "Rich chocolate brown",
                description: "Premium hardwood with excellent workability. Takes a beautiful natural finish.",
                bestFor: ["furniture", "cabinets", "cutting-boards", "decorative"],
                avoidFor: ["outdoor", "budget-projects"],
                specialNotes: "Considered the finest North American furniture wood",
                beginner: true,
                sustainability: "good",
                grainPattern: "linear-gradient(30deg, #4a3a2b 0%, #6b4e3d 20%, #4a3a2b 40%, #6b4e3d 60%, #4a3a2b 80%, #6b4e3d 100%)",
                grainImage: null, // Image was corrupted, removing for now
                finishRecommendations: {
                    natural: ["Tung Oil", "Danish Oil", "Paste Wax"],
                    stain: ["Natural - no stain needed", "Light Golden Oak (if desired)"],
                    notes: "Best left natural - staining hides beautiful chocolate color."
                },
                alternatives: ["Mahogany", "Cherry", "Cocoa (Rosewood substitute)"]
            },
            {
                name: "Bloodwood",
                janka: 2900,
                density: 65,
                workability: 1,
                cost: "premium",
                color: "Deep blood red",
                description: "Extremely hard South American wood with intense red color.",
                bestFor: ["turning", "accent-pieces", "decorative"],
                avoidFor: ["beginner", "large-projects", "cutting-boards"],
                specialNotes: "Color can fade to brown, extremely difficult to work",
                beginner: false,
                sustainability: "poor"
            },
            {
                name: "Burl Wood",
                janka: 1000,
                density: 45,
                workability: 1,
                cost: "premium",
                color: "Varies by species",
                description: "Abnormal tree growths with swirling, chaotic grain patterns. Each piece unique.",
                bestFor: ["decorative", "turning", "accent-pieces"],
                avoidFor: ["beginner", "structural", "cutting-boards"],
                specialNotes: "Extremely difficult to work, grain goes in all directions",
                beginner: false,
                sustainability: "good"
            },
            {
                name: "Cherry",
                janka: 995,
                density: 35,
                workability: 5,
                cost: "premium",
                color: "Reddish-brown, darkens with age",
                description: "Beautiful hardwood that ages gracefully. Easy to work with hand and power tools.",
                bestFor: ["furniture", "cabinets", "cutting-boards"],
                avoidFor: ["outdoor", "heavy-duty"],
                specialNotes: "Color deepens dramatically when exposed to light over time",
                beginner: true,
                sustainability: "good",
                grainPattern: "linear-gradient(25deg, #b5735a 0%, #d4956f 30%, #b5735a 60%, #d4956f 100%)",
                finishRecommendations: {
                    natural: ["Shellac", "Lacquer", "Danish Oil"],
                    stain: ["Natural (darkens naturally)", "Light Cherry", "Medium Cherry"],
                    notes: "Best natural - darkens beautifully over time. Avoid dark stains."
                },
                alternatives: ["Mahogany", "Black Walnut", "Sapele"]
            },
            {
                name: "Cocobolo",
                janka: 2960,
                density: 69,
                workability: 1,
                cost: "premium",
                color: "Orange to deep red with black streaks",
                description: "Incredibly hard Central American wood with oily finish. Extremely dense.",
                bestFor: ["turning", "small-decorative", "knife-handles"],
                avoidFor: ["beginner", "large-projects", "cutting-boards"],
                specialNotes: "Natural oils can cause allergic reactions, self-finishing",
                beginner: false,
                sustainability: "poor"
            },
            {
                name: "Douglas Fir",
                janka: 620,
                density: 33,
                workability: 3,
                cost: "budget",
                color: "Light brown with distinct grain",
                description: "Strong structural softwood. Common in construction and framing.",
                bestFor: ["construction", "structural", "outdoor-construction"],
                avoidFor: ["cutting-boards", "fine-furniture", "food-contact"],
                specialNotes: "Excellent strength for construction, can be resinous",
                beginner: false,
                sustainability: "excellent",
                grainPattern: "linear-gradient(20deg, #d4b896 0%, #a67c52 25%, #d4b896 50%, #a67c52 75%, #d4b896 100%)",
                finishRecommendations: {
                    natural: ["Exterior Stain", "Polyurethane", "No finish (structural)"],
                    stain: ["Cedar tone", "Medium Brown", "Redwood"],
                    notes: "Resinous - may need sealer. Primarily structural use."
                },
                alternatives: ["Yellow Pine", "Hem-Fir", "SPF Lumber"]
            },
            {
                name: "Eastern White Pine",
                janka: 380,
                density: 25,
                workability: 5,
                cost: "budget",
                color: "Pale yellow to white",
                description: "Soft, lightweight wood perfect for beginners and painted projects.",
                bestFor: ["beginner", "painted-furniture", "indoor-construction"],
                avoidFor: ["cutting-boards", "outdoor", "heavy-duty"],
                specialNotes: "Great for learning woodworking due to forgiving nature",
                beginner: true,
                sustainability: "excellent",
                grainPattern: "linear-gradient(0deg, #f9f6e8 0%, #ede3cc 50%, #f9f6e8 100%)",
                finishRecommendations: {
                    natural: ["Shellac", "Water-based Poly", "Danish Oil"],
                    stain: ["Pine stain", "Golden Oak", "Honey"],
                    notes: "Can blotch with stain - use pre-stain conditioner. Great painted."
                },
                alternatives: ["Basswood", "Poplar", "Cedar"]
            },
            {
                name: "Ebony",
                janka: 3220,
                density: 73,
                workability: 1,
                cost: "premium",
                color: "Jet black",
                description: "The classic black wood. Extremely dense and hard. Musical instrument favorite.",
                bestFor: ["turning", "decorative", "musical-instruments", "accent-pieces"],
                avoidFor: ["beginner", "large-projects", "cutting-boards"],
                specialNotes: "True black color, extremely expensive and rare",
                beginner: false,
                sustainability: "poor",
                grainPattern: "linear-gradient(0deg, #1a1a1a 0%, #0d0d0d 50%, #1a1a1a 100%)",
                finishRecommendations: {
                    natural: ["High-gloss Lacquer", "French Polish", "Wax"],
                    stain: ["Natural - perfect black"],
                    notes: "Polishes to mirror finish. Extremely expensive - use sparingly for accents."
                },
                alternatives: ["Wenge", "Blackwood", "Dyed woods"]
            },
            {
                name: "Elm",
                janka: 830,
                density: 35,
                workability: 2,
                cost: "mid",
                color: "Light brown with pronounced grain",
                description: "Strong, flexible hardwood with interlocked grain. Traditional wheel and chair wood.",
                bestFor: ["furniture", "steam-bending", "tool-handles"],
                avoidFor: ["cutting-boards", "beginner"],
                specialNotes: "Difficult to split due to interlocked grain, excellent for bending",
                beginner: false,
                sustainability: "good"
            },
            {
                name: "Hard Maple",
                janka: 1450,
                density: 44,
                workability: 4,
                cost: "mid",
                color: "Light cream to pale yellow",
                description: "Dense, smooth hardwood with excellent hardness. Natural antimicrobial properties.",
                bestFor: ["furniture", "cutting-boards", "flooring", "cabinets"],
                avoidFor: ["outdoor"],
                specialNotes: "Food-safe, antimicrobial properties make it perfect for kitchen items",
                beginner: true,
                sustainability: "excellent",
                grainPattern: "linear-gradient(0deg, #f7f4e8 0%, #ede5d1 40%, #f7f4e8 100%)",
                finishRecommendations: {
                    natural: ["Water-based Poly", "Shellac", "Lacquer"],
                    stain: ["Light Oak", "Honey", "Medium Brown"],
                    notes: "Excellent stain uptake. Food-safe finishes for cutting boards."
                },
                alternatives: ["Beech", "Birch", "Ash"]
            },
            {
                name: "Hickory",
                janka: 1820,
                density: 51,
                workability: 2,
                cost: "mid",
                color: "Light brown to tan",
                description: "Extremely hard and strong. Traditional choice for tool handles and heavy-duty applications.",
                bestFor: ["tool-handles", "heavy-duty", "flooring"],
                avoidFor: ["cutting-boards", "beginner", "delicate-work"],
                specialNotes: "Hardest common North American wood, very difficult to work",
                beginner: false,
                sustainability: "good",
                grainPattern: "linear-gradient(25deg, #d4b896 0%, #a67c52 30%, #d4b896 60%, #a67c52 100%)",
                finishRecommendations: {
                    natural: ["Tung Oil", "Danish Oil", "Polyurethane"],
                    stain: ["Light Oak", "Golden Oak", "Medium Brown"],
                    notes: "Extremely hard - requires sharp tools. Oil finishes enhance strength."
                },
                alternatives: ["Ash", "Hard Maple", "White Oak"]
            },
            {
                name: "Koa",
                janka: 1170,
                density: 41,
                workability: 3,
                cost: "premium",
                color: "Golden brown with curly figure",
                description: "Hawaiian hardwood with stunning curly grain. Prized for ukuleles and guitars.",
                bestFor: ["musical-instruments", "furniture", "decorative", "turning"],
                avoidFor: ["beginner", "cutting-boards"],
                specialNotes: "Exclusive to Hawaii, beautiful curly grain patterns",
                beginner: false,
                sustainability: "poor"
            },
            {
                name: "Lignum Vitae",
                janka: 4390,
                density: 78,
                workability: 1,
                cost: "premium",
                color: "Dark green to brown",
                description: "The hardest wood in the world. Self-lubricating properties. Historic maritime use.",
                bestFor: ["turning", "bearings", "specialty-applications"],
                avoidFor: ["beginner", "all-general-use"],
                specialNotes: "Hardest commercial wood, sinks in water, self-lubricating",
                beginner: false,
                sustainability: "poor"
            },
            {
                name: "Mahogany",
                janka: 900,
                density: 31,
                workability: 4,
                cost: "premium",
                color: "Reddish-brown, deepens with age",
                description: "Classic premium hardwood with excellent workability. Traditional boat and furniture wood.",
                bestFor: ["furniture", "boats", "cabinets", "trim"],
                avoidFor: ["cutting-boards", "heavy-duty"],
                specialNotes: "Traditional choice for fine furniture and boats",
                beginner: true,
                sustainability: "poor",
                grainPattern: "linear-gradient(20deg, #a0643c 0%, #d4956f 40%, #a0643c 80%, #d4956f 100%)",
                finishRecommendations: {
                    natural: ["Lacquer", "Varnish", "Shellac"],
                    stain: ["Natural (beautiful as-is)", "Light Cherry", "Medium Brown"],
                    notes: "Beautiful natural color deepens with age. Traditional lacquer finish."
                },
                alternatives: ["Cherry", "Black Walnut", "Sapele"]
            },
            {
                name: "Mesquite",
                janka: 2345,
                density: 53,
                workability: 2,
                cost: "premium",
                color: "Dark brown to black with yellow sapwood",
                description: "Southwestern treasure with incredible hardness and stunning color contrast. Desert ironwood character.",
                bestFor: ["furniture", "turning", "decorative", "accent-pieces", "cutting-boards"],
                avoidFor: ["beginner", "large-projects"],
                specialNotes: "Dramatic color contrast, often has beautiful natural defects and character. Burns sweet when worked.",
                beginner: false,
                sustainability: "excellent",
                grainPattern: "linear-gradient(45deg, #2d1810 0%, #8b6914 20%, #2d1810 40%, #b8941c 60%, #2d1810 80%, #8b6914 100%)",
                finishRecommendations: {
                    natural: ["Tung Oil", "Danish Oil", "Wax"],
                    stain: ["Natural only - don't hide character"],
                    notes: "Natural oils enhance dramatic color contrast. Sand to high grit."
                },
                alternatives: ["Osage Orange", "Cocobolo", "Ebony"]
            },
            {
                name: "Padauk",
                janka: 1725,
                density: 48,
                workability: 3,
                cost: "premium",
                color: "Bright orange-red, darkens with age",
                description: "Vibrant African hardwood with incredible orange color when fresh.",
                bestFor: ["decorative", "accent-pieces", "furniture", "turning"],
                avoidFor: ["beginner", "cutting-boards"],
                specialNotes: "Color changes from bright orange to deep red-brown over time",
                beginner: false,
                sustainability: "poor",
                grainPattern: "linear-gradient(45deg, #ff6b35 0%, #d4956f 30%, #ff6b35 60%, #d4956f 100%)",
                finishRecommendations: {
                    natural: ["Lacquer", "Danish Oil", "Shellac"],
                    stain: ["Natural only - beautiful color"],
                    notes: "Fresh-cut is bright orange, darkens to rich red-brown. Oil enhances color."
                },
                alternatives: ["Cherry", "Sapele", "Cocobolo"]
            },
            {
                name: "Poplar",
                janka: 540,
                density: 28,
                workability: 5,
                cost: "budget",
                color: "Greenish to purple heartwood, white sapwood",
                description: "Affordable hardwood that's easy to work. Popular for painted furniture and trim.",
                bestFor: ["painted-furniture", "trim", "beginner", "cabinets"],
                avoidFor: ["cutting-boards", "outdoor", "clear-finish"],
                specialNotes: "Color variation can be dramatic - best painted rather than stained",
                beginner: true,
                sustainability: "excellent",
                grainPattern: "linear-gradient(90deg, #f0e8d4 0%, #d4c5a9 30%, #a69c7a 60%, #f0e8d4 100%)",
                finishRecommendations: {
                    natural: ["Primer + Paint", "Shellac (if clear)"],
                    stain: ["Paint preferred", "Gel stain (if needed)"],
                    notes: "Best painted - color variation makes clear finishes challenging."
                },
                alternatives: ["Basswood", "Pine", "Aspen"]
            },
            {
                name: "Purple Heart",
                janka: 1860,
                density: 56,
                workability: 2,
                cost: "premium",
                color: "Vibrant purple, fades to brown",
                description: "Exotic hardwood with stunning purple color. Very hard and dense.",
                bestFor: ["decorative", "accent-pieces", "turning"],
                avoidFor: ["beginner", "large-projects", "cutting-boards"],
                specialNotes: "Color fades to brown with UV exposure, very hard to work",
                beginner: false,
                sustainability: "poor",
                grainPattern: "linear-gradient(30deg, #8b4a9c 0%, #a855c7 40%, #8b4a9c 70%, #a855c7 100%)",
                finishRecommendations: {
                    natural: ["Lacquer with UV protection", "Shellac", "Wax"],
                    stain: ["Natural only - don't hide purple"],
                    notes: "Use UV-protective finish to prevent color fade. Sand to high grit."
                },
                alternatives: ["Wenge", "Padauk", "Bloodwood"]
            },
            {
                name: "Red Oak",
                janka: 1290,
                density: 47,
                workability: 4,
                cost: "mid",
                color: "Light brown with prominent grain",
                description: "Strong, durable hardwood with distinctive grain pattern. Classic choice for furniture and flooring.",
                bestFor: ["furniture", "flooring", "cabinets"],
                avoidFor: ["cutting-boards", "outdoor"],
                specialNotes: "Large pores can harbor bacteria - not ideal for cutting boards",
                beginner: true,
                sustainability: "good",
                grainPattern: "linear-gradient(15deg, #c49b7a 0%, #a67c52 20%, #c49b7a 35%, #a67c52 50%, #c49b7a 65%, #a67c52 80%, #c49b7a 100%)",
                finishRecommendations: {
                    natural: ["Polyurethane", "Lacquer", "Danish Oil"],
                    stain: ["Golden Oak", "Dark Walnut", "Honey", "Ebony"],
                    notes: "Excellent stain uptake due to open grain. Fill grain for smooth finish."
                },
                alternatives: ["White Oak", "Ash", "Hickory"]
            },
            {
                name: "Redwood",
                janka: 420,
                density: 28,
                workability: 4,
                cost: "premium",
                color: "Rich reddish-brown",
                description: "Naturally rot resistant softwood. California's iconic outdoor wood.",
                bestFor: ["outdoor", "decking", "siding", "planters"],
                avoidFor: ["cutting-boards", "indoor-furniture"],
                specialNotes: "Naturally weather-resistant, can last decades outdoors",
                beginner: true,
                sustainability: "poor"
            },
            {
                name: "Rosewood",
                janka: 1780,
                density: 52,
                workability: 2,
                cost: "premium",
                color: "Dark brown with purple streaks",
                description: "Classic premium hardwood with rose-like scent. Prized for musical instruments.",
                bestFor: ["musical-instruments", "furniture", "turning", "decorative"],
                avoidFor: ["beginner", "cutting-boards"],
                specialNotes: "Natural rose fragrance, restricted by CITES regulations",
                beginner: false,
                sustainability: "poor"
            },
            {
                name: "Spalted Maple",
                janka: 1200,
                density: 40,
                workability: 3,
                cost: "premium",
                color: "Cream with dark fungal lines",
                description: "Maple that's been partially decayed by fungus, creating stunning black lines.",
                bestFor: ["decorative", "turning", "accent-pieces", "furniture"],
                avoidFor: ["cutting-boards", "structural"],
                specialNotes: "Unique patterns from controlled decay, can be soft in spots",
                beginner: false,
                sustainability: "good"
            },
            {
                name: "Sycamore",
                janka: 770,
                density: 34,
                workability: 4,
                cost: "mid",
                color: "Cream to light brown",
                description: "Large North American hardwood with fine, even grain. Great for turning.",
                bestFor: ["turning", "furniture", "cabinets", "musical-instruments"],
                avoidFor: ["outdoor"],
                specialNotes: "Large boards available, excellent for turning and carving",
                beginner: true,
                sustainability: "excellent"
            },
            {
                name: "Teak",
                janka: 1155,
                density: 41,
                workability: 3,
                cost: "premium",
                color: "Golden brown with dark streaks",
                description: "Premium tropical hardwood with natural oils. Marine and outdoor furniture favorite.",
                bestFor: ["outdoor", "marine", "premium-furniture"],
                avoidFor: ["budget-projects"],
                specialNotes: "Natural oils make it naturally weather-resistant, can dull tools",
                beginner: false,
                sustainability: "poor",
                grainPattern: "linear-gradient(35deg, #b8956f 0%, #8b6914 25%, #b8956f 50%, #6d5411 75%, #b8956f 100%)",
                finishRecommendations: {
                    natural: ["Teak Oil", "No finish (weathers naturally)", "Marine Varnish"],
                    stain: ["Natural only - oils resist stain"],
                    notes: "Natural oils provide protection. Let weather to silver-gray or maintain with teak oil."
                },
                alternatives: ["White Oak", "Mahogany", "Redwood"]
            },
            {
                name: "Wenge",
                janka: 1930,
                density: 54,
                workability: 2,
                cost: "premium",
                color: "Dark chocolate brown to black",
                description: "Ultra-dark African hardwood. Extremely hard with stunning dark color.",
                bestFor: ["decorative", "accent-pieces", "furniture"],
                avoidFor: ["beginner", "large-projects", "cutting-boards"],
                specialNotes: "One of the darkest woods available, very difficult to work",
                beginner: false,
                sustainability: "poor"
            },
            {
                name: "Western Red Cedar",
                janka: 350,
                density: 23,
                workability: 4,
                cost: "mid",
                color: "Reddish-brown, aromatic",
                description: "Naturally rot and insect resistant. Aromatic softwood perfect for outdoor use.",
                bestFor: ["outdoor", "decking", "siding", "planters"],
                avoidFor: ["cutting-boards", "food-contact", "indoor-furniture"],
                specialNotes: "Natural oils can cause skin irritation, not food-safe",
                beginner: true,
                sustainability: "excellent",
                grainPattern: "linear-gradient(10deg, #c4856b 0%, #a0643c 30%, #c4856b 70%, #a0643c 100%)",
                finishRecommendations: {
                    natural: ["No finish (weathers naturally)", "Cedar Oil", "Semi-transparent Stain"],
                    stain: ["Semi-transparent only", "Cedar tone", "Natural"],
                    notes: "Natural oils provide protection. Weathers to silver-gray beautifully."
                },
                alternatives: ["Redwood", "Cypress", "White Oak"]
            },
            {
                name: "White Oak",
                janka: 1360,
                density: 47,
                workability: 3,
                cost: "mid",
                color: "Light brown with tight grain",
                description: "Extremely durable with natural rot resistance. Historic boat-building wood.",
                bestFor: ["furniture", "outdoor", "flooring", "heavy-duty"],
                avoidFor: ["cutting-boards"],
                specialNotes: "Naturally water-resistant, used in barrel-making and boats",
                beginner: false,
                sustainability: "good",
                grainPattern: "linear-gradient(20deg, #b89d7c 0%, #9a7f5f 25%, #b89d7c 50%, #9a7f5f 75%, #b89d7c 100%)",
                finishRecommendations: {
                    natural: ["Spar Varnish", "Tung Oil", "Epoxy (marine)"],
                    stain: ["Golden Oak", "Weathered Gray", "Driftwood"],
                    notes: "Natural water resistance. Marine finishes for outdoor use."
                },
                alternatives: ["Red Oak", "Ash", "Teak (outdoor)"]
            },
            {
                name: "Yellow Pine",
                janka: 690,
                density: 37,
                workability: 3,
                cost: "budget",
                color: "Yellow to light brown",
                description: "Strong construction softwood. Common in framing and structural work.",
                bestFor: ["construction", "structural", "outdoor-construction"],
                avoidFor: ["cutting-boards", "fine-furniture"],
                specialNotes: "Higher strength than white pine, more resinous",
                beginner: false,
                sustainability: "excellent",
                grainPattern: "linear-gradient(15deg, #e8d5c4 0%, #c89660 30%, #e8d5c4 70%, #c89660 100%)",
                finishRecommendations: {
                    natural: ["Exterior Stain", "Pressure treatment", "No finish (framing)"],
                    stain: ["Pine stain", "Cedar tone", "Medium Brown"],
                    notes: "Resinous softwood - primarily for construction. Pre-stain conditioner recommended."
                },
                alternatives: ["Douglas Fir", "White Pine", "SPF Lumber"]
            },
            {
                name: "Zebra Wood",
                janka: 1575,
                density: 55,
                workability: 2,
                cost: "premium",
                color: "Light brown with dark stripes",
                description: "Stunning African hardwood with zebra-like stripes. Show-stopping appearance.",
                bestFor: ["decorative", "accent-pieces", "turning", "furniture"],
                avoidFor: ["beginner", "large-projects"],
                specialNotes: "Dramatic grain pattern, can cause tear-out when machining",
                beginner: false,
                sustainability: "poor",
                grainPattern: "repeating-linear-gradient(90deg, #d4b896 0%, #d4b896 8px, #3d2f1f 8px, #3d2f1f 12px)",
                finishRecommendations: {
                    natural: ["Lacquer", "Shellac", "Danish Oil"],
                    stain: ["Natural only - don't hide stripes"],
                    notes: "Sharp tools essential to prevent tear-out. Clear finish shows dramatic pattern."
                },
                alternatives: ["Wenge", "Bocote", "Tigerwood"]
            }
        ];
        
        // Wood Database URL mapping for image sources
        // Maps our species names to Wood Database URLs for systematic image collection
        const woodDatabaseMapping = {
            "Ash": "ash",
            "Basswood": "basswood",
            "Beech": "beech",
            "Birch": "birch",
            "Black Walnut": "black-walnut",
            "Bloodwood": "bloodwood",
            "Burl Wood": "burl-wood", // May need manual sourcing
            "Cherry": "cherry",
            "Cocobolo": "cocobolo",
            "Douglas Fir": "douglas-fir",
            "Eastern White Pine": "eastern-white-pine",
            "Ebony": "ebony",
            "Elm": "elm",
            "Hard Maple": "hard-maple",
            "Hickory": "hickory",
            "Koa": "koa",
            "Lignum Vitae": "lignum-vitae",
            "Mahogany": "mahogany",
            "Mesquite": "mesquite",
            "Padauk": "padauk",
            "Poplar": "poplar",
            "Purple Heart": "purple-heart",
            "Red Oak": "red-oak",
            "Redwood": "redwood",
            "Rosewood": "rosewood",
            "Spalted Maple": "spalted-maple",
            "Sycamore": "sycamore",
            "Teak": "teak",
            "Wenge": "wenge",
            "Western Red Cedar": "western-red-cedar",
            "White Oak": "white-oak",
            "Yellow Pine": "yellow-pine",
            "Zebra Wood": "zebra-wood"
        };
        
        // Generate Wood Database URL for a species
        function getWoodDatabaseUrl(speciesName) {
            const urlSlug = woodDatabaseMapping[speciesName];
            return urlSlug ? `https://www.wood-database.com/${urlSlug}/` : null;
        }
        
        // Image processing and optimization pipeline
        // ==========================================
        
        // Convert image to optimized Base64 (client-side processing)
        function processImageToBase64(imageFile, maxWidth = 250, maxHeight = 167, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // Calculate optimal dimensions maintaining aspect ratio
                    let { width, height } = calculateOptimalDimensions(img.width, img.height, maxWidth, maxHeight);
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Draw and compress image
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Convert to Base64 with optimization
                    const base64 = canvas.toDataURL('image/jpeg', quality);
                    
                    // Validate size (should be under 50KB for performance)
                    const sizeKB = Math.round((base64.length * 0.75) / 1024);
                    
                    resolve({
                        base64: base64,
                        sizeKB: sizeKB,
                        dimensions: { width, height },
                        original: { width: img.width, height: img.height }
                    });
                };
                
                img.onerror = () => reject(new Error('Failed to load image'));
                
                if (typeof imageFile === 'string') {
                    img.src = imageFile; // URL
                } else {
                    const reader = new FileReader();
                    reader.onload = e => img.src = e.target.result;
                    reader.readAsDataURL(imageFile); // File object
                }
            });
        }
        
        // Calculate optimal image dimensions maintaining aspect ratio
        function calculateOptimalDimensions(originalWidth, originalHeight, maxWidth, maxHeight) {
            const aspectRatio = originalWidth / originalHeight;
            
            let width = originalWidth;
            let height = originalHeight;
            
            // Scale down if too large
            if (width > maxWidth) {
                width = maxWidth;
                height = width / aspectRatio;
            }
            
            if (height > maxHeight) {
                height = maxHeight;
                width = height * aspectRatio;
            }
            
            return { width: Math.round(width), height: Math.round(height) };
        }
        
        // Batch process multiple wood species images (for when permission is obtained)
        async function batchProcessWoodImages(imageDataArray) {
            const results = [];
            const errors = [];
            
            for (let i = 0; i < imageDataArray.length; i++) {
                const { speciesName, imageUrl } = imageDataArray[i];
                
                try {
                    console.log(`Processing ${speciesName} (${i + 1}/${imageDataArray.length})...`);
                    
                    const processed = await processImageToBase64(imageUrl);
                    
                    results.push({
                        speciesName,
                        success: true,
                        data: processed,
                        code: `grainImage: "${processed.base64}",`
                    });
                    
                    // Add small delay to be respectful to Wood Database servers
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                } catch (error) {
                    errors.push({ speciesName, error: error.message });
                    results.push({
                        speciesName,
                        success: false,
                        error: error.message
                    });
                }
            }
            
            return { results, errors, summary: generateBatchSummary(results) };
        }
        
        // Generate summary of batch processing results
        function generateBatchSummary(results) {
            const successful = results.filter(r => r.success);
            const failed = results.filter(r => !r.success);
            const totalSize = successful.reduce((sum, r) => sum + (r.data?.sizeKB || 0), 0);
            
            return {
                total: results.length,
                successful: successful.length,
                failed: failed.length,
                totalSizeKB: totalSize,
                averageSizeKB: successful.length > 0 ? Math.round(totalSize / successful.length) : 0
            };
        }
        
        // Image validation and fallback systems
        // =====================================
        
        // Validate Base64 image data integrity
        function validateBase64Image(base64Data) {
            try {
                // Check if it's a valid data URL
                if (!base64Data.startsWith('data:image/')) {
                    return { valid: false, error: 'Invalid data URL format' };
                }
                
                // Extract the base64 portion
                const base64Part = base64Data.split(',')[1];
                if (!base64Part) {
                    return { valid: false, error: 'Missing base64 data' };
                }
                
                // Test if base64 decodes properly
                try {
                    atob(base64Part);
                } catch (e) {
                    return { valid: false, error: 'Invalid base64 encoding' };
                }
                
                // Check size constraints (under 100KB recommended)
                const sizeKB = Math.round((base64Data.length * 0.75) / 1024);
                if (sizeKB > 100) {
                    return { valid: false, error: `Image too large: ${sizeKB}KB (max: 100KB)` };
                }
                
                return { 
                    valid: true, 
                    sizeKB: sizeKB,
                    format: base64Data.substring(5, base64Data.indexOf(','))
                };
                
            } catch (error) {
                return { valid: false, error: error.message };
            }
        }
        
        // Test image loading with fallback
        function testImageWithFallback(species) {
            return new Promise((resolve) => {
                if (!species.grainImage) {
                    // No image data, use CSS pattern
                    resolve({
                        useImage: false,
                        fallbackToCss: true,
                        pattern: species.grainPattern
                    });
                    return;
                }
                
                // Test if image loads properly
                const testImg = new Image();
                
                testImg.onload = function() {
                    resolve({
                        useImage: true,
                        fallbackToCss: false,
                        imageData: species.grainImage,
                        dimensions: { width: this.width, height: this.height }
                    });
                };
                
                testImg.onerror = function() {
                    console.warn(`Failed to load image for ${species.name}, falling back to CSS pattern`);
                    resolve({
                        useImage: false,
                        fallbackToCss: true,
                        pattern: species.grainPattern,
                        error: 'Image failed to load'
                    });
                };
                
                // Set a timeout for slow-loading images
                setTimeout(() => {
                    if (!testImg.complete) {
                        console.warn(`Image loading timeout for ${species.name}, falling back to CSS pattern`);
                        resolve({
                            useImage: false,
                            fallbackToCss: true,
                            pattern: species.grainPattern,
                            error: 'Image loading timeout'
                        });
                    }
                }, 3000);
                
                testImg.src = species.grainImage;
            });
        }
        
        // Batch validate all wood species images
        async function validateAllWoodImages() {
            const results = {
                total: 0,
                withImages: 0,
                validImages: 0,
                invalidImages: 0,
                cssPatterns: 0,
                details: []
            };
            
            for (const species of woodSpeciesData) {
                results.total++;
                
                if (species.grainImage) {
                    results.withImages++;
                    const validation = validateBase64Image(species.grainImage);
                    
                    if (validation.valid) {
                        results.validImages++;
                    } else {
                        results.invalidImages++;
                        console.warn(`Invalid image for ${species.name}: ${validation.error}`);
                    }
                    
                    results.details.push({
                        species: species.name,
                        hasImage: true,
                        valid: validation.valid,
                        error: validation.error,
                        sizeKB: validation.sizeKB
                    });
                } else {
                    results.cssPatterns++;
                    results.details.push({
                        species: species.name,
                        hasImage: false,
                        hasCssPattern: !!species.grainPattern
                    });
                }
            }
            
            return results;
        }
        
        // Testing and development utilities
        // =================================
        
        // Test Base64 integration with sample 1x1 pixel image
        function testBase64Integration() {
            console.log('üß™ Testing Base64 integration...');
            
            // Create a tiny 1x1 red pixel as Base64 (for testing)
            const testImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChAGAWA0dpQAAAABJRU5ErkJggg==';
            
            // Test validation
            const validation = validateBase64Image(testImage);
            console.log('üìã Validation result:', validation);
            
            // Test species with sample image
            const testSpecies = {
                name: 'Test Wood',
                grainImage: testImage,
                grainPattern: 'linear-gradient(45deg, #8B4513, #D2B48C)'
            };
            
            // Test fallback system
            testImageWithFallback(testSpecies).then(result => {
                console.log('üéØ Fallback test result:', result);
            });
            
            // Test card creation
            const testCard = createWoodSpeciesCard(testSpecies);
            console.log('üÉè Card HTML length:', testCard.length, 'characters');
            
            return {
                validation,
                testImageSize: validation.sizeKB,
                systemReady: validation.valid
            };
        }
        
        // Generate console commands for Wood Database integration (for after permission)
        function generateWoodDatabaseCommands() {
            console.log('üìù Wood Database Integration Commands:');
            console.log('====================================');
            
            woodSpeciesData.forEach(species => {
                const url = getWoodDatabaseUrl(species.name);
                if (url) {
                    console.log(`// ${species.name}`);
                    console.log(`// URL: ${url}`);
                    console.log(`// grainImage: "[BASE64_DATA_HERE]",`);
                    console.log('');
                }
            });
            
            const mappedSpecies = Object.keys(woodDatabaseMapping);
            console.log(`‚úÖ Total mappings: ${mappedSpecies.length}/${woodSpeciesData.length} species`);
            
            return {
                totalSpecies: woodSpeciesData.length,
                mappedSpecies: mappedSpecies.length,
                unmappedSpecies: woodSpeciesData.filter(s => !woodDatabaseMapping[s.name]).map(s => s.name)
            };
        }
        
        // Development helper: Test all systems
        function runDevelopmentTests() {
            console.log('üöÄ Running development tests...');
            console.log('================================');
            
            // Test Base64 system
            const base64Test = testBase64Integration();
            
            // Test attribution system
            console.log('üì∏ Attribution system: Ready');
            
            // Test species mapping
            const mappingTest = generateWoodDatabaseCommands();
            
            // Test validation system
            validateAllWoodImages().then(results => {
                console.log('‚úÖ Validation results:', results);
            });
            
            return {
                base64Ready: base64Test.systemReady,
                attributionReady: true,
                mappingReady: mappingTest.mappedSpecies > 0,
                totalReadiness: base64Test.systemReady && mappingTest.mappedSpecies > 0
            };
        }
        
        // Project recommendations database
        const projectRecommendations = {
            'dining-table': {
                title: 'Dining Table',
                icon: 'üçΩÔ∏è',
                topChoices: ['Hard Maple', 'Red Oak', 'Cherry', 'Black Walnut'],
                avoid: ['Pine', 'Cedar', 'Poplar'],
                considerations: 'Needs to be durable, stable, and attractive. Hard maple is ideal for durability, while cherry and walnut offer premium appearance.'
            },
            'cutting-board': {
                title: 'Cutting Board',
                icon: 'üî™',
                topChoices: ['Hard Maple', 'Black Walnut', 'Cherry', 'Beech'],
                avoid: ['Oak', 'Pine', 'Cedar'],
                considerations: 'Must be food-safe with small pores. Maple is the gold standard due to antimicrobial properties.'
            },
            'outdoor-deck': {
                title: 'Outdoor Deck',
                icon: 'üè°',
                topChoices: ['Western Red Cedar', 'White Oak', 'Teak'],
                avoid: ['Maple', 'Cherry', 'Pine'],
                considerations: 'Requires natural rot resistance or treatment. Cedar is naturally weather-resistant and affordable.'
            },
            'bookshelf': {
                title: 'Bookshelf',
                icon: 'üìö',
                topChoices: ['Red Oak', 'Hard Maple', 'Ash', 'Poplar'],
                avoid: ['Cedar', 'Pine'],
                considerations: 'Needs strength to support weight without sagging. Oak and maple provide excellent strength.'
            },
            'workbench': {
                title: 'Workbench',
                icon: 'üî®',
                topChoices: ['Hard Maple', 'Beech', 'Ash', 'Hickory'],
                avoid: ['Pine', 'Cedar', 'Cherry'],
                considerations: 'Requires maximum durability and hardness to withstand abuse. Maple and beech are traditional choices.'
            },
            'turning-bowl': {
                title: 'Turning/Bowls',
                icon: 'üåÄ',
                topChoices: ['Spalted Maple', 'Birch', 'Cherry', 'Sycamore', 'Burl Wood'],
                avoid: ['Pine', 'Cedar', 'Oak'],
                considerations: 'Needs to turn cleanly without tear-out. Look for interesting grain patterns. Spalted woods and burls create stunning bowls.'
            }
        };
        
        let currentWoodFilter = {
            search: '',
            use: '',
            cost: ''
        };
        
        // Initialize wood species database
        function initWoodSpeciesDatabase() {
            renderWoodSpeciesGrid();
        }
        
        // Render the species grid
        function renderWoodSpeciesGrid(filteredData = null) {
            const grid = document.getElementById('woodSpeciesGrid');
            if (!grid) return;
            
            const data = filteredData || woodSpeciesData;
            
            if (data.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-secondary);"><h4>No species match your filters</h4><p>Try adjusting your search or filter criteria.</p></div>';
                updateWoodImageAttribution([]);
                return;
            }
            
            grid.innerHTML = data.map(species => createWoodSpeciesCard(species)).join('');
            
            // Check if any species has grain images and show attribution footer
            updateWoodImageAttribution(data);
        }
        
        // Show/hide attribution footer based on wood images present
        function updateWoodImageAttribution(data) {
            const attributionFooter = document.getElementById('woodImageAttribution');
            if (!attributionFooter) return;
            
            const hasWoodImages = data.some(species => species.grainImage);
            attributionFooter.style.display = hasWoodImages ? 'block' : 'none';
        }
        
        // Create individual species card
        function createWoodSpeciesCard(species) {
            const hardnessPercent = Math.min((species.janka / 2000) * 100, 100);
            const workabilityStars = '‚òÖ'.repeat(species.workability) + '‚òÜ'.repeat(5 - species.workability);
            
            const useTagsHtml = species.bestFor.map(use => 
                `<span class="use-tag">${formatUseTag(use)}</span>`
            ).join('');
            
            const grainPreview = species.grainImage || species.grainPattern ? `
                <div class="wood-grain-preview" style="
                    ${species.grainImage ? 
                        `background-image: url('${species.grainImage}'); background-size: cover; background-position: center;` : 
                        `background: ${species.grainPattern};`
                    } 
                    width: 100%; height: 40px; border-radius: 4px; margin-bottom: ${species.grainImage ? '4px' : '12px'}; border: 1px solid var(--border-color);
                "></div>
                ${species.grainImage ? `
                    <div class="image-attribution" style="
                        font-size: 10px; 
                        color: var(--text-secondary); 
                        text-align: center; 
                        margin-bottom: 12px;
                        opacity: 0.8;
                    ">
                        Image: <a href="https://www.wood-database.com/" target="_blank" style="color: var(--primary-color); text-decoration: none;">Wood Database</a>
                    </div>
                ` : ''}
            ` : '';
            
            const finishRecommendations = species.finishRecommendations ? `
                <div class="finish-recommendations">
                    <h5 style="margin: 8px 0 4px 0; font-size: 14px;">üé® Finish Options:</h5>
                    <div style="font-size: 12px; color: var(--text-secondary);">
                        <div><strong>Natural:</strong> ${species.finishRecommendations.natural.join(', ')}</div>
                        <div style="margin-top: 2px;"><strong>Stain:</strong> ${species.finishRecommendations.stain.join(', ')}</div>
                        ${species.finishRecommendations.notes ? `<div style="margin-top: 4px; font-style: italic;">üí° ${species.finishRecommendations.notes}</div>` : ''}
                    </div>
                </div>
            ` : '';
            
            const alternatives = species.alternatives ? `
                <div class="wood-alternatives">
                    <h5 style="margin: 8px 0 4px 0; font-size: 14px;">üîÑ Alternatives:</h5>
                    <div style="font-size: 12px; color: var(--text-secondary);">${species.alternatives.join(', ')}</div>
                </div>
            ` : '';

            return `
                <div class="wood-species-card" onclick="selectWoodSpecies('${species.name}')">
                    <div class="wood-species-header">
                        <div class="wood-species-name">${species.name}</div>
                        <div class="wood-cost-badge ${species.cost}">${species.cost}</div>
                    </div>
                    
                    ${grainPreview}
                    
                    <div class="wood-properties">
                        <div class="wood-property">
                            <span>üî® Hardness:</span>
                            <span>${species.janka} lbf</span>
                        </div>
                        <div class="wood-property">
                            <span>‚öñÔ∏è Density:</span>
                            <span>${species.density} lbs/ft¬≥</span>
                        </div>
                    </div>
                    
                    <div class="hardness-bar">
                        <span style="font-size: 12px;">Soft</span>
                        <div class="hardness-scale">
                            <div class="hardness-fill" style="width: ${hardnessPercent}%;"></div>
                        </div>
                        <span style="font-size: 12px;">Hard</span>
                    </div>
                    
                    <div class="workability-stars">
                        <span style="font-size: 14px;">üõ†Ô∏è Workability:</span>
                        <span>${workabilityStars}</span>
                        ${species.beginner ? '<span style="color: var(--primary-color); font-size: 12px; margin-left: 5px;">‚úÖ Beginner Friendly</span>' : ''}
                    </div>
                    
                    <div class="wood-uses">
                        <h5>Best For:</h5>
                        <div class="use-tags">${useTagsHtml}</div>
                    </div>
                    
                    <div class="wood-description">${species.description}</div>
                    
                    ${species.specialNotes ? `<div style="font-size: 12px; color: var(--text-secondary); font-style: italic; margin-top: 8px;">üí° ${species.specialNotes}</div>` : ''}
                    
                    ${finishRecommendations}
                    ${alternatives}
                </div>
            `;
        }
        
        // Format use tags for display
        function formatUseTag(use) {
            const tagMap = {
                'furniture': 'ü™ë Furniture',
                'cutting-boards': 'üî™ Cutting Boards',
                'outdoor': 'üè° Outdoor',
                'cabinets': 'üóÑÔ∏è Cabinets',
                'flooring': 'üè† Flooring',
                'beginner': 'üéØ Beginner',
                'painted-furniture': 'üé® Painted',
                'construction': 'üèóÔ∏è Construction',
                'tool-handles': 'üî® Tool Handles',
                'decorative': '‚ú® Decorative',
                'heavy-duty': 'üí™ Heavy Duty',
                'food-contact': 'üçΩÔ∏è Food Safe',
                'marine': '‚õµ Marine',
                'trim': 'üìê Trim',
                'turning': 'üåÄ Turning',
                'sports-equipment': '‚öæ Sports',
                'structural': 'üèóÔ∏è Structural',
                'indoor-construction': 'üè† Indoor Build',
                'outdoor-construction': 'üè° Outdoor Build',
                'siding': 'üè† Siding',
                'planters': 'üå± Planters',
                'decking': 'ü™µ Decking',
                'boats': '‚õµ Boats',
                'accent-pieces': '‚ú® Accents',
                'premium-furniture': 'üëë Premium',
                'carving': 'ü™ì Carving',
                'plywood': 'üìÑ Plywood',
                'musical-instruments': 'üéµ Instruments',
                'small-decorative': 'üéÅ Small Items',
                'knife-handles': 'üî™ Knife Handles',
                'bearings': '‚öôÔ∏è Bearings',
                'specialty-applications': 'üî¨ Specialty',
                'all-general-use': 'üö´ General Use',
                'steam-bending': 'üåä Steam Bend',
                'large-projects': 'üìè Large Projects'
            };
            return tagMap[use] || use;
        }
        
        // Filter wood species based on search and filters
        function filterWoodSpecies() {
            const searchTerm = document.getElementById('woodSearch').value.toLowerCase();
            const useFilter = document.getElementById('woodFilterUse').value;
            const costFilter = document.getElementById('woodFilterCost').value;
            
            currentWoodFilter = { search: searchTerm, use: useFilter, cost: costFilter };
            
            let filtered = woodSpeciesData.filter(species => {
                const matchesSearch = species.name.toLowerCase().includes(searchTerm) ||
                                    species.description.toLowerCase().includes(searchTerm);
                
                const matchesUse = !useFilter || 
                                 species.bestFor.includes(useFilter) ||
                                 (useFilter === 'beginner' && species.beginner);
                
                const matchesCost = !costFilter || species.cost === costFilter;
                
                return matchesSearch && matchesUse && matchesCost;
            });
            
            renderWoodSpeciesGrid(filtered);
        }
        
        // Project wizard recommendations
        function recommendForProject(projectType) {
            const project = projectRecommendations[projectType];
            if (!project) return;
            
            const recommendationsDiv = document.getElementById('projectRecommendations');
            
            // Clear any existing recommendations styling
            document.querySelectorAll('.wood-species-card').forEach(card => {
                card.classList.remove('recommended');
            });
            
            // Highlight recommended species
            project.topChoices.forEach(speciesName => {
                const cards = document.querySelectorAll('.wood-species-card');
                cards.forEach(card => {
                    if (card.textContent.includes(speciesName)) {
                        card.classList.add('recommended');
                    }
                });
            });
            
            // Show recommendations
            const topChoicesHtml = project.topChoices.map((choice, index) => 
                `<div class="recommendation-item ${index === 0 ? 'top-choice' : ''}">
                    ${index === 0 ? 'üèÜ ' : ''}${choice}${index === 0 ? ' (Top Choice)' : ''}
                </div>`
            ).join('');
            
            recommendationsDiv.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <h4>${project.icon} Best Woods for ${project.title}</h4>
                    <p style="color: var(--text-secondary); margin: 5px 0;">${project.considerations}</p>
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>Recommended Species:</strong>
                    ${topChoicesHtml}
                </div>
                ${project.avoid.length > 0 ? `
                    <div style="font-size: 14px; color: var(--text-secondary);">
                        <strong>Avoid:</strong> ${project.avoid.join(', ')}
                    </div>
                ` : ''}
            `;
            
            // Apply filters to show only relevant species
            const relevantSpecies = woodSpeciesData.filter(species => 
                project.topChoices.includes(species.name) || 
                species.bestFor.some(use => projectType.includes(use.replace('-', '')))
            );
            
            if (relevantSpecies.length > 0) {
                renderWoodSpeciesGrid(relevantSpecies);
            }
        }
        
        // Select and show details for a wood species
        function selectWoodSpecies(speciesName) {
            const species = woodSpeciesData.find(s => s.name === speciesName);
            if (!species) return;
            
            // Show detailed modal or save to project
            const details = `Wood Species: ${species.name}\nJanka Hardness: ${species.janka} lbf\nDensity: ${species.density} lbs/ft¬≥\nWorkability: ${species.workability}/5 stars\nCost Level: ${species.cost}\nBest For: ${species.bestFor.map(formatUseTag).join(', ')}\nDescription: ${species.description}`;
            
            showSaveToProjectModal('Wood Species Reference', {
                tool: 'Wood Species Database',
                equation: `${species.name} wood properties`,
                result: `${species.name} - ${species.cost} cost, ${species.janka} lbf hardness`,
                details: details,
                preview: `
                    <div class="preview-equation">
                        üå≥ ${species.name} ‚Üí ${species.cost} cost level
                    </div>
                    <div class="preview-result">
                        <strong>Hardness: ${species.janka} lbf ‚Ä¢ Density: ${species.density} lbs/ft¬≥</strong>
                    </div>
                    <div class="preview-details">
                        Workability: ${species.workability}/5 stars ‚Ä¢ ${species.beginner ? 'Beginner Friendly' : 'Advanced'}
                    </div>
                `
            });
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved theme
            loadSavedTheme();
            
            // Initialize screw calculator
            initScrewCalculator();
            
            // Ensure precision dropdowns default to 1/16" if not already set
            const precisionDropdown = document.getElementById('precision');
            const cutPrecisionDropdown = document.getElementById('cutPrecision');
            const optPrecisionDropdown = document.getElementById('optPrecision');
            
            if (precisionDropdown && !precisionDropdown.value) {
                precisionDropdown.value = '16'; // Default to 1/16"
            }
            if (cutPrecisionDropdown && !cutPrecisionDropdown.value) {
                cutPrecisionDropdown.value = '16'; // Default to 1/16"
            }
            if (optPrecisionDropdown && !optPrecisionDropdown.value) {
                optPrecisionDropdown.value = '16'; // Default to 1/16"
            }
            
            // Initialize all precisions after DOM is ready
            updatePrecision('calculator');
            updatePrecision('cut');
            updatePrecision('optimizer');
            updateWoodworkingFractions(); // Ensure woodworking fractions are initialized
            toggleKerfDisplay();
            
            loadFromLocalStorage();
            updateProjectSelector();
            updateProjectStatusBars();
            updateConversionPreview();
            
            // Initialize diagrams
            calculateMiterAngle(); // Initialize the miter angle diagram
            
            // Auto-save on input changes removed - now using manual "Save to Project" workflow
            
            // Initialize calculator cards with default values
            calculateBoardFeet();
            calculateGoldenRatioNew();
            calculateSpacing();
            calculateMiterAngle();
            calculateFrameBuilder(); // Initialize Frame Builder with default selections
            calculateSingleMiter(); // Initialize Single Board Cut with default selections
            calculateGradeSlope(); // Initialize Grade/Slope Calculator
            initWoodSpeciesDatabase(); // Initialize Wood Species Database
            
            console.log('WorkShop Pro Calculator with Visual Project Management loaded!');
        });
    </script>
</body>
</html>
